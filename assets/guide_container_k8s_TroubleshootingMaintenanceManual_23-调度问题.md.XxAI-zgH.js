import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const D=JSON.parse('{"title":"1. 调度不均问题","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/TroubleshootingMaintenanceManual/23-调度问题.md","filePath":"guide/container/k8s/TroubleshootingMaintenanceManual/23-调度问题.md","lastUpdated":1733304370000}'),p={name:"guide/container/k8s/TroubleshootingMaintenanceManual/23-调度问题.md"},o=l(`<h1 id="_1-调度不均问题" tabindex="-1">1. 调度不均问题 <a class="header-anchor" href="#_1-调度不均问题" aria-label="Permalink to &quot;1. 调度不均问题&quot;">​</a></h1><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"></span>
<span class="line"><span style="color:#6A737D;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#对实际使用内存大于75%的机器停止调度，对实际使用内存小于65%的 关闭调度</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 获取实际内存小于或等于65%的机器</span></span>
<span class="line"><span style="color:#E1E4E8;">memory_lt_65</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> top nodes </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">awk</span><span style="color:#9ECBFF;"> &#39;{if($5+0&lt;=65) print $1}&#39;\`</span></span>
<span class="line"><span style="color:#6A737D;"># 获取实际内存大于或等于75%的机器</span></span>
<span class="line"><span style="color:#E1E4E8;">memory_gt_75</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> top nodes </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">awk</span><span style="color:#9ECBFF;"> &#39;{if($5+0&gt;=75) print $1}&#39;\`</span></span>
<span class="line"><span style="color:#6A737D;">#获取已经关闭调度的机器</span></span>
<span class="line"><span style="color:#E1E4E8;">SchedulingDisabled</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get nodes </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">egrep</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-v</span><span style="color:#9ECBFF;"> &quot;control-plane|master&quot; </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> SchedulingDisabled </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">awk</span><span style="color:#9ECBFF;"> &#39;{print $1}&#39;\`</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 如果有关闭调度的机器，判断其内存小于或等于65%，则放开调度</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;">  [ </span><span style="color:#F97583;">-n</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$SchedulingDisabled</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> ];</span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> node </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> $SchedulingDisabled ;</span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[  $memory_lt_65 </span><span style="color:#F97583;">=~</span><span style="color:#E1E4E8;"> $node ]];</span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">uncordon</span><span style="color:#E1E4E8;"> $node</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">done</span></span>
<span class="line"><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#6A737D;">#如果有内存大于或等于75%的机器，判断其是否停止调度,如果没有,则停止调度</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;">  [ </span><span style="color:#F97583;">-n</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$memory_gt_75</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> ];</span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> node </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> $memory_gt_75 ;</span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ $SchedulingDisabled </span><span style="color:#F97583;">=~</span><span style="color:#E1E4E8;"> $node ]];</span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;">  $node </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">aleady</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cordorned</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">cordon</span><span style="color:#E1E4E8;"> $node</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">done</span></span>
<span class="line"><span style="color:#F97583;">fi</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"></span>
<span class="line"><span style="color:#6A737D;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#对实际使用内存大于75%的机器停止调度，对实际使用内存小于65%的 关闭调度</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 获取实际内存小于或等于65%的机器</span></span>
<span class="line"><span style="color:#24292E;">memory_lt_65</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">kubectl</span><span style="color:#032F62;"> top nodes </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">awk</span><span style="color:#032F62;"> &#39;{if($5+0&lt;=65) print $1}&#39;\`</span></span>
<span class="line"><span style="color:#6A737D;"># 获取实际内存大于或等于75%的机器</span></span>
<span class="line"><span style="color:#24292E;">memory_gt_75</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">kubectl</span><span style="color:#032F62;"> top nodes </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">awk</span><span style="color:#032F62;"> &#39;{if($5+0&gt;=75) print $1}&#39;\`</span></span>
<span class="line"><span style="color:#6A737D;">#获取已经关闭调度的机器</span></span>
<span class="line"><span style="color:#24292E;">SchedulingDisabled</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">kubectl</span><span style="color:#032F62;"> get nodes </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">egrep</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-v</span><span style="color:#032F62;"> &quot;control-plane|master&quot; </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> SchedulingDisabled </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">awk</span><span style="color:#032F62;"> &#39;{print $1}&#39;\`</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 如果有关闭调度的机器，判断其内存小于或等于65%，则放开调度</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;">  [ </span><span style="color:#D73A49;">-n</span><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$SchedulingDisabled</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> ];</span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> node </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> $SchedulingDisabled ;</span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[  $memory_lt_65 </span><span style="color:#D73A49;">=~</span><span style="color:#24292E;"> $node ]];</span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;">  </span><span style="color:#032F62;">uncordon</span><span style="color:#24292E;"> $node</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">done</span></span>
<span class="line"><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#6A737D;">#如果有内存大于或等于75%的机器，判断其是否停止调度,如果没有,则停止调度</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;">  [ </span><span style="color:#D73A49;">-n</span><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$memory_gt_75</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> ];</span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> node </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> $memory_gt_75 ;</span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ $SchedulingDisabled </span><span style="color:#D73A49;">=~</span><span style="color:#24292E;"> $node ]];</span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#005CC5;">echo</span><span style="color:#24292E;">  $node </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">aleady</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cordorned</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;">  </span><span style="color:#032F62;">cordon</span><span style="color:#24292E;"> $node</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">done</span></span>
<span class="line"><span style="color:#D73A49;">fi</span></span></code></pre></div><blockquote><p>5-10分钟执行一次</p></blockquote>`,3),e=[o];function c(t,r,y,E,i,F){return n(),a("div",null,e)}const u=s(p,[["render",c]]);export{D as __pageData,u as default};
