import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const F=JSON.parse('{"title":"1. Ansible Playbook","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Linux/Ansible/3-playbook.md","filePath":"guide/Linux/Ansible/3-playbook.md","lastUpdated":1739528109000}'),p={name:"guide/Linux/Ansible/3-playbook.md"},o=l(`<p>官当</p><p><a href="https://ansible-tran.readthedocs.io/en/latest/docs/playbooks.html" target="_blank" rel="noreferrer">https://ansible-tran.readthedocs.io/en/latest/docs/playbooks.html</a></p><p><a href="https://docs.ansible.com/ansible/latest/getting_started/get_started_playbook.html" target="_blank" rel="noreferrer">https://docs.ansible.com/ansible/latest/getting_started/get_started_playbook.html</a></p><p><a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse.html" target="_blank" rel="noreferrer">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse.html</a></p><ul><li><a href="https://github.com/ansible/ansible-examples" target="_blank" rel="noreferrer">官方提供的playbook的大量例子</a></li></ul><h1 id="_1-ansible-playbook" tabindex="-1">1. Ansible Playbook <a class="header-anchor" href="#_1-ansible-playbook" aria-label="Permalink to &quot;1. Ansible Playbook&quot;">​</a></h1><h2 id="_1-1-playbook简介" tabindex="-1">1.1 Playbook简介 <a class="header-anchor" href="#_1-1-playbook简介" aria-label="Permalink to &quot;1.1 Playbook简介&quot;">​</a></h2><p><code>Playbook</code>与<code>ad-hoc</code>相比,是一种完全不同的运用ansible的方式，类似与<code>saltstack</code>的<code>state</code>状态文件。<code>ad-hoc</code>无法持久使用，<code>playbook</code>可以持久使用。</p><p><code>playbook</code>是由一个或多个<code>play</code>组成的列表，<code>play</code>的主要功能在于将事先归并为一组的主机装扮成事先通过<code>ansible</code>中的<code>task</code>定义好的角色。从根本上来讲，所谓的<code>task</code>无非是调用<code>ansible</code>的一个<code>module</code>。将多个<code>play</code>组织在一个<code>playbook</code>中，即可以让它们联合起来按事先编排的机制完成某一任务</p><h2 id="_1-2-playbook核心元素" tabindex="-1">1.2 Playbook核心元素 <a class="header-anchor" href="#_1-2-playbook核心元素" aria-label="Permalink to &quot;1.2 Playbook核心元素&quot;">​</a></h2><ul><li>hosts 执行的远程主机列表</li><li>tasks 任务集</li><li>varniables 内置变量或自定义变量在playbook中调用</li><li>templates 模板，即使用模板语法的文件，比如配置文件等</li><li>handlers 和notity结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</li><li>tags 标签，指定某条任务执行，用于选择运行playbook中的部分代码。</li></ul><h2 id="_1-3-playbook语法" tabindex="-1">1.3 Playbook语法 <a class="header-anchor" href="#_1-3-playbook语法" aria-label="Permalink to &quot;1.3 Playbook语法&quot;">​</a></h2><p><code>playbook</code>使用<code>yaml</code>语法格式，后缀可以是<code>yaml</code>,也可以是<code>yml</code>。</p><ul><li>在单一一个<code>playbook</code>文件中，可以连续三个连子号(<code>---</code>)区分多个<code>play</code>。还有选择性的连续三个点好(<code>...</code>)用来表示<code>play</code>的结尾，也可省略。</li><li>次行开始正常写<code>playbook</code>的内容，一般都会写上描述该<code>playbook</code>的功能。</li><li>使用#号注释代码。</li><li>缩进必须统一，不能空格和<code>tab</code>混用。</li><li>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行实现的。</li><li><code>YAML</code>文件内容和<code>Linux</code>系统大小写判断方式保持一致，是区分大小写的，<code>k/v</code>的值均需大小写敏感</li><li><code>k/v</code>的值可同行写也可以换行写。同行使用:分隔。</li><li><code>v</code>可以是个字符串，也可以是一个列表</li><li>一个完整的代码块功能需要最少元素包括 <code>name: task</code></li></ul><p>案例</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 创建playbook文件</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@ansible </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">/ansible]$ cat playbook01.yml</span></span>
<span class="line"><span style="color:#B392F0;">---</span><span style="color:#E1E4E8;">                       </span><span style="color:#6A737D;">#固定格式</span></span>
<span class="line"><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">hosts:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node1</span><span style="color:#E1E4E8;">     </span><span style="color:#6A737D;">#定义需要执行主机</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">remote_user:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">#远程用户</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">vars:</span><span style="color:#E1E4E8;">                   </span><span style="color:#6A737D;">#定义变量</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">http_port:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8088</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">#变量</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">tasks:</span><span style="color:#E1E4E8;">                             </span><span style="color:#6A737D;">#定义一个任务的开始</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">file</span><span style="color:#E1E4E8;">          </span><span style="color:#6A737D;">#定义任务的名称</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">file:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name=/tmp/playtest.txt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">state=touch</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">#调用模块，具体要做的事情</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">user</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">user:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name=test02</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">system=yes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">shell=/sbin/nologin</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">package</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">yum:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name=httpd</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">httpd</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">template:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">src=./httpd.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dest=/etc/httpd/conf/httpd.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">notify:</span><span style="color:#E1E4E8;">                 </span><span style="color:#6A737D;">#定义执行一个动作(action)让handlers来引用执行，与handlers配合使用</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apache</span><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">#notify要执行的动作，这里必须与handlers中的name定义内容一致</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">copy</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">index.html</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">copy:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">src=/var/www/html/index.html</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dest=/var/www/html/index.html</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">httpd</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">service:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name=httpd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">state=started</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">handlers:</span><span style="color:#E1E4E8;">                                    </span><span style="color:#6A737D;">#处理器：更加tasks中notify定义的action触发执行相应的处理动作</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apache</span><span style="color:#E1E4E8;">                     </span><span style="color:#6A737D;">#要与notify定义的内容相同</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">service:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name=httpd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">state=restarted</span><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">#触发要执行的动作</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 创建playbook文件</span></span>
<span class="line"><span style="color:#24292E;">[root@ansible </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">/ansible]$ cat playbook01.yml</span></span>
<span class="line"><span style="color:#6F42C1;">---</span><span style="color:#24292E;">                       </span><span style="color:#6A737D;">#固定格式</span></span>
<span class="line"><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">hosts:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node1</span><span style="color:#24292E;">     </span><span style="color:#6A737D;">#定义需要执行主机</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">remote_user:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;">       </span><span style="color:#6A737D;">#远程用户</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">vars:</span><span style="color:#24292E;">                   </span><span style="color:#6A737D;">#定义变量</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">http_port:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8088</span><span style="color:#24292E;">       </span><span style="color:#6A737D;">#变量</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">tasks:</span><span style="color:#24292E;">                             </span><span style="color:#6A737D;">#定义一个任务的开始</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">new</span><span style="color:#24292E;"> </span><span style="color:#032F62;">file</span><span style="color:#24292E;">          </span><span style="color:#6A737D;">#定义任务的名称</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">file:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name=/tmp/playtest.txt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">state=touch</span><span style="color:#24292E;">   </span><span style="color:#6A737D;">#调用模块，具体要做的事情</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">new</span><span style="color:#24292E;"> </span><span style="color:#032F62;">user</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">user:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name=test02</span><span style="color:#24292E;"> </span><span style="color:#032F62;">system=yes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">shell=/sbin/nologin</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">package</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">yum:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name=httpd</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">httpd</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">template:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">src=./httpd.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dest=/etc/httpd/conf/httpd.conf</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">notify:</span><span style="color:#24292E;">                 </span><span style="color:#6A737D;">#定义执行一个动作(action)让handlers来引用执行，与handlers配合使用</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apache</span><span style="color:#24292E;">      </span><span style="color:#6A737D;">#notify要执行的动作，这里必须与handlers中的name定义内容一致</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">copy</span><span style="color:#24292E;"> </span><span style="color:#032F62;">index.html</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">copy:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">src=/var/www/html/index.html</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dest=/var/www/html/index.html</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">httpd</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">service:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name=httpd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">state=started</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">handlers:</span><span style="color:#24292E;">                                    </span><span style="color:#6A737D;">#处理器：更加tasks中notify定义的action触发执行相应的处理动作</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apache</span><span style="color:#24292E;">                     </span><span style="color:#6A737D;">#要与notify定义的内容相同</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">service:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name=httpd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">state=restarted</span><span style="color:#24292E;">      </span><span style="color:#6A737D;">#触发要执行的动作</span></span></code></pre></div><h2 id="_1-4-playbook运行方式" tabindex="-1">1.4 Playbook运行方式 <a class="header-anchor" href="#_1-4-playbook运行方式" aria-label="Permalink to &quot;1.4 Playbook运行方式&quot;">​</a></h2><p>通过<code>ansible-playbook</code>命令运行</p><p>格式：<code>ansible-playbook &lt;filename.yml&gt; ... [options]</code></p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@ansible </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">/ansible]$ ansible-playbook -h</span></span>
<span class="line"><span style="color:#6A737D;">#ansible-playbook常用选项：</span></span>
<span class="line"><span style="color:#B392F0;">--check</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">or</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-C</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">#只检测可能会发生的改变，但不真正执行操作</span></span>
<span class="line"><span style="color:#B392F0;">--list-hosts</span><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">#列出运行任务的主机</span></span>
<span class="line"><span style="color:#B392F0;">--list-tags</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">#列出playbook文件中定义所有的tags</span></span>
<span class="line"><span style="color:#B392F0;">--list-tasks</span><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">#列出playbook文件中定义的所以任务集</span></span>
<span class="line"><span style="color:#B392F0;">--limit</span><span style="color:#E1E4E8;">           </span><span style="color:#6A737D;">#主机列表 只针对主机列表中的某个主机或者某个组执行</span></span>
<span class="line"><span style="color:#B392F0;">-f</span><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">#指定并发数，默认为5个</span></span>
<span class="line"><span style="color:#B392F0;">-t</span><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">#指定tags运行，运行某一个或者多个tags。（前提playbook中有定义tags）</span></span>
<span class="line"><span style="color:#B392F0;">-v</span><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">#显示过程  -vv  -vvv更详细</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@ansible </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">/ansible]$ ansible-playbook -h</span></span>
<span class="line"><span style="color:#6A737D;">#ansible-playbook常用选项：</span></span>
<span class="line"><span style="color:#6F42C1;">--check</span><span style="color:#24292E;">  </span><span style="color:#032F62;">or</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-C</span><span style="color:#24292E;">    </span><span style="color:#6A737D;">#只检测可能会发生的改变，但不真正执行操作</span></span>
<span class="line"><span style="color:#6F42C1;">--list-hosts</span><span style="color:#24292E;">      </span><span style="color:#6A737D;">#列出运行任务的主机</span></span>
<span class="line"><span style="color:#6F42C1;">--list-tags</span><span style="color:#24292E;">       </span><span style="color:#6A737D;">#列出playbook文件中定义所有的tags</span></span>
<span class="line"><span style="color:#6F42C1;">--list-tasks</span><span style="color:#24292E;">      </span><span style="color:#6A737D;">#列出playbook文件中定义的所以任务集</span></span>
<span class="line"><span style="color:#6F42C1;">--limit</span><span style="color:#24292E;">           </span><span style="color:#6A737D;">#主机列表 只针对主机列表中的某个主机或者某个组执行</span></span>
<span class="line"><span style="color:#6F42C1;">-f</span><span style="color:#24292E;">                </span><span style="color:#6A737D;">#指定并发数，默认为5个</span></span>
<span class="line"><span style="color:#6F42C1;">-t</span><span style="color:#24292E;">                </span><span style="color:#6A737D;">#指定tags运行，运行某一个或者多个tags。（前提playbook中有定义tags）</span></span>
<span class="line"><span style="color:#6F42C1;">-v</span><span style="color:#24292E;">                </span><span style="color:#6A737D;">#显示过程  -vv  -vvv更详细</span></span></code></pre></div><h1 id="_2-定义模版" tabindex="-1">2. 定义模版 <a class="header-anchor" href="#_2-定义模版" aria-label="Permalink to &quot;2. 定义模版&quot;">​</a></h1><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/ansible/roles</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">hello</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">hello</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">templates</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">defaults</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">files</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">handlers</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">meta</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">tasks</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">vars</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/ansible/roles</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#032F62;">hello</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">hello</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#032F62;">templates</span><span style="color:#24292E;"> </span><span style="color:#032F62;">defaults</span><span style="color:#24292E;">  </span><span style="color:#032F62;">files</span><span style="color:#24292E;">  </span><span style="color:#032F62;">handlers</span><span style="color:#24292E;">  </span><span style="color:#032F62;">meta</span><span style="color:#24292E;">  </span><span style="color:#032F62;">tasks</span><span style="color:#24292E;">  </span><span style="color:#032F62;">vars</span></span></code></pre></div><h1 id="_3-模块" tabindex="-1">3.模块 <a class="header-anchor" href="#_3-模块" aria-label="Permalink to &quot;3.模块&quot;">​</a></h1><h3 id="_1-正则" tabindex="-1">1.正则 <a class="header-anchor" href="#_1-正则" aria-label="Permalink to &quot;1.正则&quot;">​</a></h3><h3 id="_2-lineinfile" tabindex="-1">2.lineinfile <a class="header-anchor" href="#_2-lineinfile" aria-label="Permalink to &quot;2.lineinfile&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">all</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">gather_facts</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">remote_user</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">root</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tasks</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;修改ssh配置文件的安全选项&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">lineinfile</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/ssh/sshd_config</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regexp</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;^#?UseDNS&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">line</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;UseDNS no&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">notify</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">restart sshd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">handlers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">restart sshd</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">sshd</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">state</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">restarted</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">: </span><span style="color:#032F62;">all</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">gather_facts</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">remote_user</span><span style="color:#24292E;">: </span><span style="color:#032F62;">root</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tasks</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;修改ssh配置文件的安全选项&quot;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">lineinfile</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/ssh/sshd_config</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regexp</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;^#?UseDNS&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">line</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;UseDNS no&#39;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">notify</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">restart sshd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">handlers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">restart sshd</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">sshd</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">state</span><span style="color:#24292E;">: </span><span style="color:#032F62;">restarted</span></span></code></pre></div><h1 id="_4-流程控制" tabindex="-1">4. 流程控制 <a class="header-anchor" href="#_4-流程控制" aria-label="Permalink to &quot;4. 流程控制&quot;">​</a></h1><h2 id="_4-1-handler" tabindex="-1">4.1 handler <a class="header-anchor" href="#_4-1-handler" aria-label="Permalink to &quot;4.1 handler&quot;">​</a></h2><p>在Ansible中，handler是一个特殊的任务，它不会在playbook的主执行流程中直接运行，而是根据某些条件被触发执行。这些条件通常是由其他任务（task）的状态变化触发的，比如当某个任务修改了目标系统的状态（例如文件、服务或配置等）。</p><p>handler的主要作用是允许您在playbook的末尾一次性地执行某些操作，而不是在每个任务之后都执行。这可以提高效率，并避免不必要的重复操作。</p><p>handler通常与notify关键字一起使用。当您在一个任务中定义了notify，并且该任务的状态发生了改变（例如从未改变变为已改变），那么与notify相关联的handler就会在playbook的末尾被触发。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">gather_facts</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tasks</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">copy ngx conf file</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">copy</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">src</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/tmp/backend.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">dest</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/nginx/conf.d/</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backup</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">yes</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">notify</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">ngx reload</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">handlers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ngx reload</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">systemd</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">state</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">reloaded</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">: </span><span style="color:#032F62;">web</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">gather_facts</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tasks</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">copy ngx conf file</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">copy</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">src</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/tmp/backend.conf</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">dest</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/nginx/conf.d/</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backup</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">yes</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">notify</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">ngx reload</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">handlers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ngx reload</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">systemd</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">state</span><span style="color:#24292E;">: </span><span style="color:#032F62;">reloaded</span></span></code></pre></div><h2 id="_4-2-when" tabindex="-1">4.2 when <a class="header-anchor" href="#_4-2-when" aria-label="Permalink to &quot;4.2 when&quot;">​</a></h2><p>在Ansible中，when关键字用于条件判断，根据特定的条件来决定是否执行某个任务（task）。当条件为真时，任务将会执行；当条件为假时，任务将被跳过。</p><p>when关键字的使用非常简单，只需在单个任务的后面添加when条件判断语句即可。在when语句中，变量不需要使用</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202412181353507.png" alt="image-20241218135347848">表达式来包裹。</p><p>在Ansible中，when语句用于条件判断，其判断语法关键字和表达式与Python的语法非常相似。Ansible的when语句可以支持多种条件表达式和逻辑运算符，以下是一些常用的判断语法关键字和表达式：</p><h3 id="_1-比较运算符" tabindex="-1">1.比较运算符 <a class="header-anchor" href="#_1-比较运算符" aria-label="Permalink to &quot;1.比较运算符&quot;">​</a></h3><table><thead><tr><th>符号</th><th>作用</th></tr></thead><tbody><tr><td>==</td><td>相等</td></tr><tr><td>!=</td><td>不等</td></tr><tr><td>&gt;</td><td>大于</td></tr><tr><td>&lt;</td><td>小于</td></tr><tr><td>&gt;=</td><td>大于等于</td></tr><tr><td>&lt;=</td><td>小于等于</td></tr></tbody></table><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">all</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tasks</span><span style="color:#E1E4E8;">:  </span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">debug</span><span style="color:#E1E4E8;">:  </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">msg</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;当前主机名 {{ ansible_hostname }} 可用内存大于 1000MB {{ ansible_memfree_mb }}&quot;</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">when</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ansible_memfree_mb &gt;= 1000</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">: </span><span style="color:#032F62;">all</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tasks</span><span style="color:#24292E;">:  </span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">debug</span><span style="color:#24292E;">:  </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">msg</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;当前主机名 {{ ansible_hostname }} 可用内存大于 1000MB {{ ansible_memfree_mb }}&quot;</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">when</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ansible_memfree_mb &gt;= 1000</span></span></code></pre></div><h3 id="_2-逻辑运算符" tabindex="-1">2.逻辑运算符 <a class="header-anchor" href="#_2-逻辑运算符" aria-label="Permalink to &quot;2.逻辑运算符&quot;">​</a></h3><table><thead><tr><th>符号</th><th>作用</th></tr></thead><tbody><tr><td>and</td><td>逻辑与</td></tr><tr><td>or</td><td>逻辑或</td></tr><tr><td>not</td><td>逻辑否</td></tr></tbody></table><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">all</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tasks</span><span style="color:#E1E4E8;">:  </span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">debug</span><span style="color:#E1E4E8;">:  </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">msg</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;当前主机名 {{ ansible_hostname }} 可用内存大于 200MB 小于1000MB {{ ansible_memfree_mb }}&quot;</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">when</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ansible_memfree_mb &lt;= 1000 and ansible_memfree_mb &gt;= 200</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">: </span><span style="color:#032F62;">all</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tasks</span><span style="color:#24292E;">:  </span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">debug</span><span style="color:#24292E;">:  </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">msg</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;当前主机名 {{ ansible_hostname }} 可用内存大于 200MB 小于1000MB {{ ansible_memfree_mb }}&quot;</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">when</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ansible_memfree_mb &lt;= 1000 and ansible_memfree_mb &gt;= 200</span></span></code></pre></div><h3 id="_3-组合条件" tabindex="-1">3.组合条件 <a class="header-anchor" href="#_3-组合条件" aria-label="Permalink to &quot;3.组合条件&quot;">​</a></h3><p>可以使用括号()来组合多个条件，以改变运算的优先级</p><h3 id="_4-is判断" tabindex="-1">4.is判断 <a class="header-anchor" href="#_4-is判断" aria-label="Permalink to &quot;4.is判断&quot;">​</a></h3><table><thead><tr><th>符号</th><th>作用</th></tr></thead><tbody><tr><td>is exists</td><td>文件、目录存在</td></tr><tr><td>is not exists</td><td>文件、目录不存在</td></tr><tr><td>is number</td><td>判断是否为数字</td></tr><tr><td>is string</td><td>判断是否为字符串</td></tr><tr><td>is defined</td><td>判断变量是否已定义，已定义则返回真</td></tr><tr><td>is undefined</td><td>判断变量是否未定义，未定义则返回真</td></tr><tr><td>is none</td><td>判断变量的值是否为空，如果变量已定义且值为空，则返回真</td></tr><tr><td>is match</td><td>判断正则是否匹配</td></tr><tr><td>is file</td><td>判断指定路径是否为一个文件，是则为真</td></tr><tr><td>is directory</td><td>判断指定路径是否为一个目录，是则为真</td></tr><tr><td>is link</td><td>判断指定路径是否为一个软链接，是则为真</td></tr><tr><td>is mount</td><td>判断指定路径是否为一个挂载点，是则为真</td></tr></tbody></table><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">all</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tasks</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">add ngx yum repo</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">yum_repository</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-stable</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">description</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot; nginx yum repo&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">baseurl</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;http://nginx.org/packages/centos/$releasever/$basearch/&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">enable</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">yes</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">gpgcheck</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">no</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">when</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">( ansible_hostname is match(&quot;web|lb&quot;) )</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">all</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tasks</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">add ngx yum repo</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">yum_repository</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-stable</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">description</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot; nginx yum repo&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">baseurl</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;http://nginx.org/packages/centos/$releasever/$basearch/&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">enable</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">yes</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">gpgcheck</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">no</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">when</span><span style="color:#24292E;">: </span><span style="color:#032F62;">( ansible_hostname is match(&quot;web|lb&quot;) )</span></span></code></pre></div><h3 id="_5-register" tabindex="-1">5. register <a class="header-anchor" href="#_5-register" aria-label="Permalink to &quot;5. register&quot;">​</a></h3><p>拿到执行命令结果</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Nginx Check</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">all</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tasks</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Check if Nginx is installed</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ls /sbin/nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">register</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ngx_exist</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">ignore_errors</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ngx status</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">debug</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">msg</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ ngx_exist }}&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Nginx service failure</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">debug</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">msg</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ngx is not installed</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">when</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ngx_exist is failure</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Nginx service success</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">debug</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">msg</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ngx is  installed</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">when</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ngx_exist is failure</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Nginx Check</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">: </span><span style="color:#032F62;">all</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tasks</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Check if Nginx is installed</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ls /sbin/nginx</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">register</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ngx_exist</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">ignore_errors</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ngx status</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">debug</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">msg</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;{{ ngx_exist }}&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Nginx service failure</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">debug</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">msg</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ngx is not installed</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">when</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ngx_exist is failure</span></span>
<span class="line"><span style="color:#24292E;">      </span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Nginx service success</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">debug</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">msg</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ngx is  installed</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">when</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ngx_exist is failure</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>要使用failure判断，就要开启ignore_errors。默认情况下ignore_errors为false，如果脚本tasks有错误，会忽略接下来的任务，也就会使playbook获取不到failed的结果。所以，要使用 is failure 一定要开启 ignore_errors</p></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Check if Tomcat Webapp Exists</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">stat</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/opt/tomcat/webapps/ROOT/WEB-INF/web.xml</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">register</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat_extracted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Download Apache Tomcat</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">get_url</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">url</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;https://downloads.apache.org/tomcat/tomcat-9/v{{ tomcat_version }}/bin/apache-tomcat-{{ tomcat_version }}.tar.gz&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">dest</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/tmp/apache-tomcat-{{ tomcat_version }}.tar.gz&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">when</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">not tomcat_extracted.stat.exists</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Extract Tomcat</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">unarchive</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">src</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/tmp/apache-tomcat-{{ tomcat_version }}.tar.gz&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">dest</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/opt/tomcat</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">remote_src</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">extra_opts</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;--strip-components=1&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">when</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">not tomcat_extracted.stat.exists</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Check if Tomcat Webapp Exists</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">stat</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/opt/tomcat/webapps/ROOT/WEB-INF/web.xml</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">register</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat_extracted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Download Apache Tomcat</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">get_url</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">url</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;https://downloads.apache.org/tomcat/tomcat-9/v{{ tomcat_version }}/bin/apache-tomcat-{{ tomcat_version }}.tar.gz&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">dest</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/tmp/apache-tomcat-{{ tomcat_version }}.tar.gz&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">when</span><span style="color:#24292E;">: </span><span style="color:#032F62;">not tomcat_extracted.stat.exists</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Extract Tomcat</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">unarchive</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">src</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/tmp/apache-tomcat-{{ tomcat_version }}.tar.gz&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">dest</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/opt/tomcat</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">remote_src</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">extra_opts</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;--strip-components=1&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">when</span><span style="color:#24292E;">: </span><span style="color:#032F62;">not tomcat_extracted.stat.exists</span></span></code></pre></div><h2 id="_4-3-with-items" tabindex="-1">4.3 with_items <a class="header-anchor" href="#_4-3-with-items" aria-label="Permalink to &quot;4.3 with_items&quot;">​</a></h2><p>在Ansible中，with_items 是一个循环迭代模块，用于在playbook的任务中处理一个列表或字典中的元素。他将遍历一个列表或字典，并对每个元素执行一次任务。</p><p>with_items 后面跟着的是要处理的列表或字典数据。任务会按照列表顺序依次执行，每次迭代时，列表中的一个元素会被传递给任务作为变量（通常使用 <img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202412181414624.png" alt="image-20241218141425016"> 来引用当前迭代的元素)。</p><h3 id="_1-迭代列表" tabindex="-1">1.迭代列表 <a class="header-anchor" href="#_1-迭代列表" aria-label="Permalink to &quot;1.迭代列表&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">- hosts: all</span></span>
<span class="line"><span style="color:#e1e4e8;">  tasks:</span></span>
<span class="line"><span style="color:#e1e4e8;">  - name: 创建多个目录</span></span>
<span class="line"><span style="color:#e1e4e8;">    file:</span></span>
<span class="line"><span style="color:#e1e4e8;">      path: &quot;{{ item }}&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">      state: directory</span></span>
<span class="line"><span style="color:#e1e4e8;">    with_items:</span></span>
<span class="line"><span style="color:#e1e4e8;">      - /tmp/dir1</span></span>
<span class="line"><span style="color:#e1e4e8;">      - /tmp/dir2</span></span>
<span class="line"><span style="color:#e1e4e8;">      - /tmp/dir3</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">- hosts: all</span></span>
<span class="line"><span style="color:#24292e;">  tasks:</span></span>
<span class="line"><span style="color:#24292e;">  - name: 创建多个目录</span></span>
<span class="line"><span style="color:#24292e;">    file:</span></span>
<span class="line"><span style="color:#24292e;">      path: &quot;{{ item }}&quot;</span></span>
<span class="line"><span style="color:#24292e;">      state: directory</span></span>
<span class="line"><span style="color:#24292e;">    with_items:</span></span>
<span class="line"><span style="color:#24292e;">      - /tmp/dir1</span></span>
<span class="line"><span style="color:#24292e;">      - /tmp/dir2</span></span>
<span class="line"><span style="color:#24292e;">      - /tmp/dir3</span></span></code></pre></div><h3 id="_2-迭代字典" tabindex="-1">2.迭代字典 <a class="header-anchor" href="#_2-迭代字典" aria-label="Permalink to &quot;2.迭代字典&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">- hosts: all</span></span>
<span class="line"><span style="color:#e1e4e8;">  tasks:</span></span>
<span class="line"><span style="color:#e1e4e8;">  - name: 创建多个目录</span></span>
<span class="line"><span style="color:#e1e4e8;">    file:</span></span>
<span class="line"><span style="color:#e1e4e8;">      path: &quot;{{ item.path }}/{{ item.name}}&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">      state: touch</span></span>
<span class="line"><span style="color:#e1e4e8;">    with_items:</span></span>
<span class="line"><span style="color:#e1e4e8;">      - {path: /tmp/dir1, name: gg}</span></span>
<span class="line"><span style="color:#e1e4e8;">      - {path: /tmp/dir2, name: uu}</span></span>
<span class="line"><span style="color:#e1e4e8;">      - {path: /tmp/dir3, name: oo}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">- hosts: all</span></span>
<span class="line"><span style="color:#24292e;">  tasks:</span></span>
<span class="line"><span style="color:#24292e;">  - name: 创建多个目录</span></span>
<span class="line"><span style="color:#24292e;">    file:</span></span>
<span class="line"><span style="color:#24292e;">      path: &quot;{{ item.path }}/{{ item.name}}&quot;</span></span>
<span class="line"><span style="color:#24292e;">      state: touch</span></span>
<span class="line"><span style="color:#24292e;">    with_items:</span></span>
<span class="line"><span style="color:#24292e;">      - {path: /tmp/dir1, name: gg}</span></span>
<span class="line"><span style="color:#24292e;">      - {path: /tmp/dir2, name: uu}</span></span>
<span class="line"><span style="color:#24292e;">      - {path: /tmp/dir3, name: oo}</span></span></code></pre></div><h2 id="_4-4-loop" tabindex="-1">4.4 loop <a class="header-anchor" href="#_4-4-loop" aria-label="Permalink to &quot;4.4 loop&quot;">​</a></h2><p>在Ansible Playbook中，<a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_loops.html" target="_blank" rel="noreferrer">loop</a>关键字用于迭代一个列表或字典，并对每个元素执行一次特定的任务</p><blockquote><p>通过ansible-doc -t lookup 查看文档</p></blockquote><h3 id="_1-迭代列表-1" tabindex="-1">1.迭代列表 <a class="header-anchor" href="#_1-迭代列表-1" aria-label="Permalink to &quot;1.迭代列表&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">- hosts: all  </span></span>
<span class="line"><span style="color:#e1e4e8;">  tasks:  </span></span>
<span class="line"><span style="color:#e1e4e8;">    - name: Install packages  </span></span>
<span class="line"><span style="color:#e1e4e8;">      yum:  </span></span>
<span class="line"><span style="color:#e1e4e8;">        name: &quot;{{ item }}&quot;  </span></span>
<span class="line"><span style="color:#e1e4e8;">        state: present  </span></span>
<span class="line"><span style="color:#e1e4e8;">      loop:  </span></span>
<span class="line"><span style="color:#e1e4e8;">        - httpd  </span></span>
<span class="line"><span style="color:#e1e4e8;">        - mysql-server  </span></span>
<span class="line"><span style="color:#e1e4e8;">        - php</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">- hosts: all  </span></span>
<span class="line"><span style="color:#24292e;">  tasks:  </span></span>
<span class="line"><span style="color:#24292e;">    - name: Install packages  </span></span>
<span class="line"><span style="color:#24292e;">      yum:  </span></span>
<span class="line"><span style="color:#24292e;">        name: &quot;{{ item }}&quot;  </span></span>
<span class="line"><span style="color:#24292e;">        state: present  </span></span>
<span class="line"><span style="color:#24292e;">      loop:  </span></span>
<span class="line"><span style="color:#24292e;">        - httpd  </span></span>
<span class="line"><span style="color:#24292e;">        - mysql-server  </span></span>
<span class="line"><span style="color:#24292e;">        - php</span></span></code></pre></div><h3 id="_2-迭代字典-1" tabindex="-1">2.迭代字典 <a class="header-anchor" href="#_2-迭代字典-1" aria-label="Permalink to &quot;2.迭代字典&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">- hosts: all  </span></span>
<span class="line"><span style="color:#e1e4e8;">  tasks:  </span></span>
<span class="line"><span style="color:#e1e4e8;">    - name: Create directories  </span></span>
<span class="line"><span style="color:#e1e4e8;">      file:  </span></span>
<span class="line"><span style="color:#e1e4e8;">      path: &quot;{{ item.path }}/{{ item.name}}&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">      state: touch </span></span>
<span class="line"><span style="color:#e1e4e8;">      loop:  </span></span>
<span class="line"><span style="color:#e1e4e8;">        - { path: &quot;/tmp/directory1&quot;, name: &quot;file1.txt&quot; }  </span></span>
<span class="line"><span style="color:#e1e4e8;">        - { path: &quot;/tmp/directory2&quot;, name: &quot;file2.txt&quot; }  </span></span>
<span class="line"><span style="color:#e1e4e8;">        - { path: &quot;/tmp/directory3&quot;, name: &quot;file3.txt&quot; }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">- hosts: all  </span></span>
<span class="line"><span style="color:#24292e;">  tasks:  </span></span>
<span class="line"><span style="color:#24292e;">    - name: Create directories  </span></span>
<span class="line"><span style="color:#24292e;">      file:  </span></span>
<span class="line"><span style="color:#24292e;">      path: &quot;{{ item.path }}/{{ item.name}}&quot;</span></span>
<span class="line"><span style="color:#24292e;">      state: touch </span></span>
<span class="line"><span style="color:#24292e;">      loop:  </span></span>
<span class="line"><span style="color:#24292e;">        - { path: &quot;/tmp/directory1&quot;, name: &quot;file1.txt&quot; }  </span></span>
<span class="line"><span style="color:#24292e;">        - { path: &quot;/tmp/directory2&quot;, name: &quot;file2.txt&quot; }  </span></span>
<span class="line"><span style="color:#24292e;">        - { path: &quot;/tmp/directory3&quot;, name: &quot;file3.txt&quot; }</span></span></code></pre></div><p>文档：</p><p><a href="https://docs.ansible.com/ansible/2.9/user_guide/playbooks_conditionals.html" target="_blank" rel="noreferrer">https://docs.ansible.com/ansible/2.9/user_guide/playbooks_conditionals.html</a></p>`,69),e=[o];function t(c,r,y,E,i,d){return a(),n("div",null,e)}const m=s(p,[["render",t]]);export{F as __pageData,m as default};
