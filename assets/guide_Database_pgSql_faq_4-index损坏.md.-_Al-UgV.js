import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const _=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/pgSql/faq/4-index损坏.md","filePath":"guide/Database/pgSql/faq/4-index损坏.md","lastUpdated":1712022000000}'),p={name:"guide/Database/pgSql/faq/4-index损坏.md"},o=l(`<h3 id="_1-现象" tabindex="-1">1.现象 <a class="header-anchor" href="#_1-现象" aria-label="Permalink to &quot;1.现象&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">han</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">max</span><span style="color:#E1E4E8;">(create_time) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">public</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tbl_index_table</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> create_time</span><span style="color:#F97583;">&gt;=</span><span style="color:#9ECBFF;">&#39;2010-10-08&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">han</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">max</span><span style="color:#24292E;">(create_time) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">public</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tbl_index_table</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> create_time</span><span style="color:#D73A49;">&gt;=</span><span style="color:#032F62;">&#39;2010-10-08&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><p>ERROR: could not read block 41381 of relation <code>16779/24769/24938</code>: read only 0 of 8192 bytes</p><p>看到这个错误信息，首先想到的是表 tbl_index_table 上有坏块，估计需要表重建下。</p><h3 id="_2-查看执行计划" tabindex="-1">2.查看执行计划 <a class="header-anchor" href="#_2-查看执行计划" aria-label="Permalink to &quot;2.查看执行计划&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--查看执行计划</span></span>
<span class="line"><span style="color:#E1E4E8;">han</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># \\d tbl_index_table;</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">Table</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;public.tbl_index_table&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">   Column   |      </span><span style="color:#F97583;">Type</span><span style="color:#E1E4E8;">       |    Modifiers    </span></span>
<span class="line"><span style="color:#6A737D;">----------------+-----------------------------+------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> total     | </span><span style="color:#F97583;">integer</span><span style="color:#E1E4E8;">           |</span></span>
<span class="line"><span style="color:#E1E4E8;"> logined    | </span><span style="color:#F97583;">integer</span><span style="color:#E1E4E8;">           |</span></span>
<span class="line"><span style="color:#E1E4E8;"> logining    | </span><span style="color:#F97583;">integer</span><span style="color:#E1E4E8;">           |</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">http</span><span style="color:#E1E4E8;">      | </span><span style="color:#F97583;">integer</span><span style="color:#E1E4E8;">           |</span></span>
<span class="line"><span style="color:#E1E4E8;"> rawtcp     | </span><span style="color:#F97583;">integer</span><span style="color:#E1E4E8;">           |</span></span>
<span class="line"><span style="color:#E1E4E8;"> create_time  | </span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">not null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;"> logincountdesc | </span><span style="color:#F97583;">character</span><span style="color:#E1E4E8;"> varying      |</span></span>
<span class="line"><span style="color:#E1E4E8;"> logincountaddr | </span><span style="color:#F97583;">character</span><span style="color:#E1E4E8;"> varying      | </span><span style="color:#F97583;">not null</span></span>
<span class="line"><span style="color:#E1E4E8;">Indexes:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&quot;tbl_index_table_pkey&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PRIMARY KEY</span><span style="color:#E1E4E8;">, btree (create_time, logincountaddr)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&quot;index_tbl_index_table_create_time&quot;</span><span style="color:#E1E4E8;"> btree (create_time)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--查看执行计划</span></span>
<span class="line"><span style="color:#24292E;">han</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># \\d tbl_index_table;</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">Table</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;public.tbl_index_table&quot;</span></span>
<span class="line"><span style="color:#24292E;">   Column   |      </span><span style="color:#D73A49;">Type</span><span style="color:#24292E;">       |    Modifiers    </span></span>
<span class="line"><span style="color:#6A737D;">----------------+-----------------------------+------------------------</span></span>
<span class="line"><span style="color:#24292E;"> total     | </span><span style="color:#D73A49;">integer</span><span style="color:#24292E;">           |</span></span>
<span class="line"><span style="color:#24292E;"> logined    | </span><span style="color:#D73A49;">integer</span><span style="color:#24292E;">           |</span></span>
<span class="line"><span style="color:#24292E;"> logining    | </span><span style="color:#D73A49;">integer</span><span style="color:#24292E;">           |</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">http</span><span style="color:#24292E;">      | </span><span style="color:#D73A49;">integer</span><span style="color:#24292E;">           |</span></span>
<span class="line"><span style="color:#24292E;"> rawtcp     | </span><span style="color:#D73A49;">integer</span><span style="color:#24292E;">           |</span></span>
<span class="line"><span style="color:#24292E;"> create_time  | </span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">not null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">default</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">now</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;"> logincountdesc | </span><span style="color:#D73A49;">character</span><span style="color:#24292E;"> varying      |</span></span>
<span class="line"><span style="color:#24292E;"> logincountaddr | </span><span style="color:#D73A49;">character</span><span style="color:#24292E;"> varying      | </span><span style="color:#D73A49;">not null</span></span>
<span class="line"><span style="color:#24292E;">Indexes:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;tbl_index_table_pkey&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PRIMARY KEY</span><span style="color:#24292E;">, btree (create_time, logincountaddr)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;index_tbl_index_table_create_time&quot;</span><span style="color:#24292E;"> btree (create_time)</span></span></code></pre></div><h3 id="_3-explain" tabindex="-1">3.explain <a class="header-anchor" href="#_3-explain" aria-label="Permalink to &quot;3.explain&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">han</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># explain  </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">max</span><span style="color:#E1E4E8;">(create_time) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">public</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tbl_index_table</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> create_time</span><span style="color:#F97583;">&gt;=</span><span style="color:#9ECBFF;">&#39;2010-10-08&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                                   QUERY PLAN                                                                  </span></span>
<span class="line"><span style="color:#6A737D;">------------------------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> Result  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">04</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">05</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   InitPlan</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">Limit</span><span style="color:#E1E4E8;">  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">04</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan Backward </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> index_tbl_index_table_create_time </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index_table  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">66</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">28</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1507</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                 </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Cond: (create_time </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2010-10-08 00:00:00&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                 </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: (create_time </span><span style="color:#F97583;">IS NOT NULL</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">-- 发现上面的查询走的索引 index_tbl_index_table_create_time,猜测索引可能有问题。</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">han</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># explain  </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">max</span><span style="color:#24292E;">(create_time) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">public</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tbl_index_table</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> create_time</span><span style="color:#D73A49;">&gt;=</span><span style="color:#032F62;">&#39;2010-10-08&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                                                                   QUERY PLAN                                                                  </span></span>
<span class="line"><span style="color:#6A737D;">------------------------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> Result  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">04</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">05</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   InitPlan</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">Limit</span><span style="color:#24292E;">  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">04</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan Backward </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> index_tbl_index_table_create_time </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index_table  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">66</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">28</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1507</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                 </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Cond: (create_time </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2010-10-08 00:00:00&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                 </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: (create_time </span><span style="color:#D73A49;">IS NOT NULL</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6A737D;">-- 发现上面的查询走的索引 index_tbl_index_table_create_time,猜测索引可能有问题。</span></span></code></pre></div><h3 id="_4-relation分析" tabindex="-1">4.relation分析 <a class="header-anchor" href="#_4-relation分析" aria-label="Permalink to &quot;4.relation分析&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--根据报错信息,从relation后面的数字分析</span></span>
<span class="line"><span style="color:#E1E4E8;">han</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">,relname </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_class </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">oid=</span><span style="color:#79B8FF;">24938</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">  |                 relname                </span></span>
<span class="line"><span style="color:#6A737D;">-------+-----------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">24938</span><span style="color:#E1E4E8;"> | index_tbl_index_table_create_time</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">596</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">han</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">,relname </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_class </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">oid=</span><span style="color:#79B8FF;">24769</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;"> | relname</span></span>
<span class="line"><span style="color:#6A737D;">-----+---------</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">369</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">han</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">,relname </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_class </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">oid=</span><span style="color:#79B8FF;">16779</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;"> | relname</span></span>
<span class="line"><span style="color:#6A737D;">-----+---------</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   发现 24938正好是表上的索引 index_tbl_index_table_create_time。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看索引状态</span></span>
<span class="line"><span style="color:#E1E4E8;">han</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> indexrelid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">24938</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;"> indexrelid | indrelid | indnatts | indisunique | indisprimary | indisclustered | indisvalid | indcheckxmin | indisready | indkey | indclass | indoption | indexprs | indpred</span></span>
<span class="line"><span style="color:#6A737D;">------------+----------+----------+-------------+--------------+----------------+------------+--------------+------------+--------+----------+-----------+----------+---------</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">24938</span><span style="color:#E1E4E8;"> |    </span><span style="color:#79B8FF;">24823</span><span style="color:#E1E4E8;"> |        </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> | f           | f            | f              | t          | f            | t          | </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">      | </span><span style="color:#79B8FF;">10053</span><span style="color:#E1E4E8;">    | </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         |          |</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">indisvalid</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">t 表示索引处于可用状态。</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--根据报错信息,从relation后面的数字分析</span></span>
<span class="line"><span style="color:#24292E;">han</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">,relname </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_class </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">oid=</span><span style="color:#005CC5;">24938</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">  |                 relname                </span></span>
<span class="line"><span style="color:#6A737D;">-------+-----------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">24938</span><span style="color:#24292E;"> | index_tbl_index_table_create_time</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">596</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">han</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">,relname </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_class </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">oid=</span><span style="color:#005CC5;">24769</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">oid</span><span style="color:#24292E;"> | relname</span></span>
<span class="line"><span style="color:#6A737D;">-----+---------</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">369</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">han</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">,relname </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_class </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">oid=</span><span style="color:#005CC5;">16779</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">oid</span><span style="color:#24292E;"> | relname</span></span>
<span class="line"><span style="color:#6A737D;">-----+---------</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   发现 24938正好是表上的索引 index_tbl_index_table_create_time。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看索引状态</span></span>
<span class="line"><span style="color:#24292E;">han</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> indexrelid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">24938</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;"> indexrelid | indrelid | indnatts | indisunique | indisprimary | indisclustered | indisvalid | indcheckxmin | indisready | indkey | indclass | indoption | indexprs | indpred</span></span>
<span class="line"><span style="color:#6A737D;">------------+----------+----------+-------------+--------------+----------------+------------+--------------+------------+--------+----------+-----------+----------+---------</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">24938</span><span style="color:#24292E;"> |    </span><span style="color:#005CC5;">24823</span><span style="color:#24292E;"> |        </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> | f           | f            | f              | t          | f            | t          | </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">      | </span><span style="color:#005CC5;">10053</span><span style="color:#24292E;">    | </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         |          |</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">indisvalid</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">t 表示索引处于可用状态。</span></span></code></pre></div><h3 id="_4-重新创建" tabindex="-1">4.重新创建 <a class="header-anchor" href="#_4-重新创建" aria-label="Permalink to &quot;4.重新创建&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--尝试下重建索引</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">han</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> query </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">han</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># \\timing</span></span>
<span class="line"><span style="color:#E1E4E8;">Timing </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">back</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># reindex </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> index_tbl_index_table_create_time;</span></span>
<span class="line"><span style="color:#E1E4E8;">REINDEX</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">107796</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">232</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--索引重建后，查询恢复正常</span></span>
<span class="line"><span style="color:#E1E4E8;">han</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">max</span><span style="color:#E1E4E8;">(create_time) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">public</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tbl_index_table</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> create_time</span><span style="color:#F97583;">&gt;=</span><span style="color:#9ECBFF;">&#39;2010-10-08&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;"> max</span></span>
<span class="line"><span style="color:#6A737D;">-----</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">73</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">600</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">han</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_size_pretty(pg_relation_size(</span><span style="color:#9ECBFF;">&#39;index_tbl_index_table_create_time&#39;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;"> pg_size_pretty</span></span>
<span class="line"><span style="color:#6A737D;">----------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">327</span><span style="color:#E1E4E8;"> MB</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--尝试下重建索引</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">han</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> query </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">han</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># \\timing</span></span>
<span class="line"><span style="color:#24292E;">Timing </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">on</span><span style="color:#24292E;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">back</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># reindex </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> index_tbl_index_table_create_time;</span></span>
<span class="line"><span style="color:#24292E;">REINDEX</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">107796</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">232</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--索引重建后，查询恢复正常</span></span>
<span class="line"><span style="color:#24292E;">han</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">max</span><span style="color:#24292E;">(create_time) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">public</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tbl_index_table</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> create_time</span><span style="color:#D73A49;">&gt;=</span><span style="color:#032F62;">&#39;2010-10-08&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;"> max</span></span>
<span class="line"><span style="color:#6A737D;">-----</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">73</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">600</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">han</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_size_pretty(pg_relation_size(</span><span style="color:#032F62;">&#39;index_tbl_index_table_create_time&#39;</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;"> pg_size_pretty</span></span>
<span class="line"><span style="color:#6A737D;">----------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">327</span><span style="color:#24292E;"> MB</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span></code></pre></div>`,12),e=[o];function t(c,r,E,y,i,d){return n(),a("div",null,e)}const A=s(p,[["render",t]]);export{_ as __pageData,A as default};
