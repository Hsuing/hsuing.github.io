import{_ as s,o as n,c as a,R as o}from"./chunks/framework.zUbWieqp.js";const i=JSON.parse('{"title":"1. Prometheus内部存储机制","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Linux/Monitor/Prometheus/3-storage.md","filePath":"guide/Linux/Monitor/Prometheus/3-storage.md","lastUpdated":1739873505000}'),l={name:"guide/Linux/Monitor/Prometheus/3-storage.md"},p=o(`<p>prometheus有着非常高效的时间序列数据存储方法，每个采样数据仅仅占用3.5byte的空间.</p><p>默认情况下，prometheus将采集到的数据存储在本地的TSDB数据库中，路径默认为prometheus安装目录的data目录下，数据写入过程先把数据写入内存,并存放在wal日志，然后2小时后将内存的数据保存至一个新的block块，同时再把新采集的数据写入内存并在2小时后保存至一个新的block块，以此类推。</p><h1 id="_1-prometheus内部存储机制" tabindex="-1">1. Prometheus内部存储机制 <a class="header-anchor" href="#_1-prometheus内部存储机制" aria-label="Permalink to &quot;1. Prometheus内部存储机制&quot;">​</a></h1><p>Prometheus内置了一个本地的时间序列数据库，通过该数据库进行样本数据的存储，这种设计方式较大地简化了产品部署与管理的复杂性。 从2.x版本开始，Prometheus采用了更加高效的存储机制。</p><p>系统采集的样本数据会按照两个小时为一个时间窗口，将期间产生的数据存储在一个块（Block）中，每个块目录包含该时间窗口内所有的样本数据（chunks），一个元数据文件（meta.json）和一个索引文件（index)。 当通过API删除时间序列指标时，删除记录会存储在单独的墓碑（tombstone ）文件中，而不会立即从文件中删除。</p><h2 id="_1-1-存储目录" tabindex="-1">1.1 存储目录 <a class="header-anchor" href="#_1-1-存储目录" aria-label="Permalink to &quot;1.1 存储目录&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">drwxr-xr-x</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">68</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:09</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">01</span><span style="color:#9ECBFF;">JHFBCBQH9004292MCHCCGFTH</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 块目录</span></span>
<span class="line"><span style="color:#B392F0;">drwxr-xr-x</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:32</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">chunks_head</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20001</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:43</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">queries.active</span></span>
<span class="line"><span style="color:#B392F0;">drwxr-xr-x</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">81</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:43</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wal</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">drwxr-xr-x</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">68</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:09</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">01</span><span style="color:#032F62;">JHFBCBQH9004292MCHCCGFTH</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 块目录</span></span>
<span class="line"><span style="color:#6F42C1;">drwxr-xr-x</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:32</span><span style="color:#24292E;"> </span><span style="color:#032F62;">chunks_head</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20001</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">15</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:43</span><span style="color:#24292E;"> </span><span style="color:#032F62;">queries.active</span></span>
<span class="line"><span style="color:#6F42C1;">drwxr-xr-x</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">81</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">15</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:43</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wal</span></span></code></pre></div><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>01JHFBCBQH9004292MCHCCGFTH</td><td>块目录，这个会随着量，而变多</td></tr><tr><td>queries.active</td><td></td></tr><tr><td>chunks_head</td><td></td></tr><tr><td>wal</td><td>预写日志</td></tr></tbody></table><ul><li>块目录-01JHFBCBQH9004292MCHCCGFTH</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">drwxr-xr-x</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:09</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">chunks</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">251082</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:09</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">index</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">277</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:09</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">meta.json</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">9</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:09</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tombstones</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">drwxr-xr-x</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:09</span><span style="color:#24292E;"> </span><span style="color:#032F62;">chunks</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">251082</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:09</span><span style="color:#24292E;"> </span><span style="color:#032F62;">index</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">277</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:09</span><span style="color:#24292E;"> </span><span style="color:#032F62;">meta.json</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">9</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:09</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tombstones</span></span></code></pre></div><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>chunks</td><td>样本数据，每个大小为512M，超过会被切分为多个</td></tr><tr><td>index</td><td>索引文件，记录存储数据的索引信息，通过文件内的几个表来查找时序数据</td></tr><tr><td>meta.json</td><td>元数据文件，包含了样本数、采集数据数据的起始时间、压缩历史</td></tr><tr><td>tombstones</td><td>逻辑数据，主要记载删除记录和标记要删除的数据，删除标记，可在查询时排除样本数据</td></tr></tbody></table><p>在当前时间窗口内正在收集的样本数据，则会被Prometheus保存到内存中。同时 ，为了确保系统在出现意外崩溃后数据依然能够恢复，Prometheus会通过预写日志（WAL)的方式进行临时保存，在重新启动后会从WAL目录进行加载，从而恢复数据。预写日志以128MB 的段存储在WAL目录中，这些文件包含尚未压缩的原始数据，因此你会看到它们将明显大于块文件。</p><ul><li>wal目录</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">360448</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18</span><span style="color:#9ECBFF;">:16</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">00000090</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:43</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">00000091</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">32768</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:43</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">00000092</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">226044</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:47</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">00000093</span></span>
<span class="line"><span style="color:#B392F0;">drwxr-xr-x</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:43</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">checkpoint.00000089</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">360448</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18</span><span style="color:#032F62;">:16</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">00000090</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">15</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:43</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">00000091</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">32768</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">15</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:43</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">00000092</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">226044</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">15</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:47</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">00000093</span></span>
<span class="line"><span style="color:#6F42C1;">drwxr-xr-x</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">22</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">15</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:43</span><span style="color:#24292E;"> </span><span style="color:#032F62;">checkpoint.00000089</span></span></code></pre></div><p>通过时间窗口的方式保存样本数据，可以较好地提升Prometheus的查询效率，当系统查询一段时间范围内所有的样本数据时，只需要简单的从落在该范围内的块中查询数据即可。同时，这种方式也可以简化历史数据的删除逻辑，当一个块的时间范围超过需要保留的范围后，直接清理该块即可。</p><h2 id="_1-2-block介绍" tabindex="-1">1.2 block介绍 <a class="header-anchor" href="#_1-2-block介绍" aria-label="Permalink to &quot;1.2 block介绍&quot;">​</a></h2><p>每个block为一个data目录中以01开头的存储目录，如下：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Rocky data]# tree -L 2</span></span>
<span class="line"><span style="color:#79B8FF;">.</span></span>
<span class="line"><span style="color:#B392F0;">├──</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">01</span><span style="color:#9ECBFF;">JKYMG69KP2AG3R905FZT65FN</span></span>
<span class="line"><span style="color:#B392F0;">│  </span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">├──</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">chunks</span></span>
<span class="line"><span style="color:#B392F0;">│  </span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">├──</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">index</span></span>
<span class="line"><span style="color:#B392F0;">│  </span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">├──</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">meta.json</span></span>
<span class="line"><span style="color:#B392F0;">│  </span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">└──</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tombstones</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Rocky data]# tree -L 2</span></span>
<span class="line"><span style="color:#005CC5;">.</span></span>
<span class="line"><span style="color:#6F42C1;">├──</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">01</span><span style="color:#032F62;">JKYMG69KP2AG3R905FZT65FN</span></span>
<span class="line"><span style="color:#6F42C1;">│  </span><span style="color:#24292E;"> </span><span style="color:#032F62;">├──</span><span style="color:#24292E;"> </span><span style="color:#032F62;">chunks</span></span>
<span class="line"><span style="color:#6F42C1;">│  </span><span style="color:#24292E;"> </span><span style="color:#032F62;">├──</span><span style="color:#24292E;"> </span><span style="color:#032F62;">index</span></span>
<span class="line"><span style="color:#6F42C1;">│  </span><span style="color:#24292E;"> </span><span style="color:#032F62;">├──</span><span style="color:#24292E;"> </span><span style="color:#032F62;">meta.json</span></span>
<span class="line"><span style="color:#6F42C1;">│  </span><span style="color:#24292E;"> </span><span style="color:#032F62;">└──</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tombstones</span></span></code></pre></div><h3 id="_1-block特点" tabindex="-1">1. block特点 <a class="header-anchor" href="#_1-block特点" aria-label="Permalink to &quot;1. block特点&quot;">​</a></h3><p>block块会压缩、合并历史数据块，以及删除过期的数据块，随着压缩、合并，block块数量会减少，在压缩过程中会发生三件事：定时执行压缩、合并小的block到大的block、清理过期的块</p><p><strong>每个块有4部分组成：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[root@Rocky data]# tree -L 2</span></span>
<span class="line"><span style="color:#e1e4e8;">.</span></span>
<span class="line"><span style="color:#e1e4e8;">├── 01JKYMG69KP2AG3R905FZT65FN</span></span>
<span class="line"><span style="color:#e1e4e8;">│   ├── chunks</span></span>
<span class="line"><span style="color:#e1e4e8;">│   ├── index</span></span>
<span class="line"><span style="color:#e1e4e8;">│   ├── meta.json</span></span>
<span class="line"><span style="color:#e1e4e8;">│   └── tombstones</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[root@Rocky data]# tree -L 2</span></span>
<span class="line"><span style="color:#24292e;">.</span></span>
<span class="line"><span style="color:#24292e;">├── 01JKYMG69KP2AG3R905FZT65FN</span></span>
<span class="line"><span style="color:#24292e;">│   ├── chunks</span></span>
<span class="line"><span style="color:#24292e;">│   ├── index</span></span>
<span class="line"><span style="color:#24292e;">│   ├── meta.json</span></span>
<span class="line"><span style="color:#24292e;">│   └── tombstones</span></span></code></pre></div><h1 id="_2-本地存储配置参数" tabindex="-1">2. 本地存储配置参数 <a class="header-anchor" href="#_2-本地存储配置参数" aria-label="Permalink to &quot;2. 本地存储配置参数&quot;">​</a></h1><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">--config.file</span><span style="color:#E1E4E8;">=</span><span style="color:#B392F0;">&quot;/path/prometheus.yml&quot;</span><span style="color:#E1E4E8;">          </span><span style="color:#6A737D;"># 指定配置文件</span></span>
<span class="line"><span style="color:#B392F0;">--web.listen-address</span><span style="color:#E1E4E8;">=</span><span style="color:#B392F0;">&quot;0.0.0.0:9090&quot;</span><span style="color:#E1E4E8;">          </span><span style="color:#6A737D;"># 指定监听地址</span></span>
<span class="line"><span style="color:#B392F0;">--storage.tsdb.path</span><span style="color:#E1E4E8;">=</span><span style="color:#B392F0;">&quot;/path/data&quot;</span><span style="color:#E1E4E8;">             </span><span style="color:#6A737D;"># 指定数据存储目录</span></span>
<span class="line"><span style="color:#B392F0;">--storage.tsdb.retention.size</span><span style="color:#E1E4E8;">=B,KB,MB,GB,TB,PB,EB      </span><span style="color:#6A737D;"># 指定chunk大小，默认512M</span></span>
<span class="line"><span style="color:#B392F0;">--storage.tsdb.retention.time</span><span style="color:#E1E4E8;">=       </span><span style="color:#6A737D;"># 数据保存时长，默认15天</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#B392F0;">--query.timeout</span><span style="color:#E1E4E8;">=2m                      </span><span style="color:#6A737D;"># 最大查询超时时间</span></span>
<span class="line"><span style="color:#B392F0;">--query.max-connections</span><span style="color:#E1E4E8;">=512          </span><span style="color:#6A737D;"># 最大查询并发数</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#B392F0;">--web.read-timeout</span><span style="color:#E1E4E8;">=5m                  </span><span style="color:#6A737D;"># 最大空闲超时时间</span></span>
<span class="line"><span style="color:#B392F0;">--web.max-connections</span><span style="color:#E1E4E8;">=512            </span><span style="color:#6A737D;"># 最大并发连接数</span></span>
<span class="line"><span style="color:#B392F0;">--web.enable-lifecycle</span><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;"># 启用api动态加载功能</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">--config.file</span><span style="color:#24292E;">=</span><span style="color:#6F42C1;">&quot;/path/prometheus.yml&quot;</span><span style="color:#24292E;">          </span><span style="color:#6A737D;"># 指定配置文件</span></span>
<span class="line"><span style="color:#6F42C1;">--web.listen-address</span><span style="color:#24292E;">=</span><span style="color:#6F42C1;">&quot;0.0.0.0:9090&quot;</span><span style="color:#24292E;">          </span><span style="color:#6A737D;"># 指定监听地址</span></span>
<span class="line"><span style="color:#6F42C1;">--storage.tsdb.path</span><span style="color:#24292E;">=</span><span style="color:#6F42C1;">&quot;/path/data&quot;</span><span style="color:#24292E;">             </span><span style="color:#6A737D;"># 指定数据存储目录</span></span>
<span class="line"><span style="color:#6F42C1;">--storage.tsdb.retention.size</span><span style="color:#24292E;">=B,KB,MB,GB,TB,PB,EB      </span><span style="color:#6A737D;"># 指定chunk大小，默认512M</span></span>
<span class="line"><span style="color:#6F42C1;">--storage.tsdb.retention.time</span><span style="color:#24292E;">=       </span><span style="color:#6A737D;"># 数据保存时长，默认15天</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">--query.timeout</span><span style="color:#24292E;">=2m                      </span><span style="color:#6A737D;"># 最大查询超时时间</span></span>
<span class="line"><span style="color:#6F42C1;">--query.max-connections</span><span style="color:#24292E;">=512          </span><span style="color:#6A737D;"># 最大查询并发数</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">--web.read-timeout</span><span style="color:#24292E;">=5m                  </span><span style="color:#6A737D;"># 最大空闲超时时间</span></span>
<span class="line"><span style="color:#6F42C1;">--web.max-connections</span><span style="color:#24292E;">=512            </span><span style="color:#6A737D;"># 最大并发连接数</span></span>
<span class="line"><span style="color:#6F42C1;">--web.enable-lifecycle</span><span style="color:#24292E;">                </span><span style="color:#6A737D;"># 启用api动态加载功能</span></span></code></pre></div>`,24),e=[p];function t(r,c,y,E,F,C){return n(),a("div",null,e)}const B=s(l,[["render",t]]);export{i as __pageData,B as default};
