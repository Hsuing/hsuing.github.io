import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const d=JSON.parse('{"title":"一、查询","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/SqlServer/2-cmd.md","filePath":"guide/Database/SqlServer/2-cmd.md","lastUpdated":1760364072000}'),p={name:"guide/Database/SqlServer/2-cmd.md"},o=l(`<p>官方文档，<a href="https://docs.microsoft.com/zh-cn/sql/t-sql/statements/statements?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/t-sql/statements/statements?view=sql-server-2017</a></p><h1 id="一、查询" tabindex="-1">一、查询 <a class="header-anchor" href="#一、查询" aria-label="Permalink to &quot;一、查询&quot;">​</a></h1><h2 id="_1-1-查看单表大小" tabindex="-1">1.1 查看单表大小 <a class="header-anchor" href="#_1-1-查看单表大小" aria-label="Permalink to &quot;1.1 查看单表大小&quot;">​</a></h2><ul><li>使用sp_spaceused 存储过程</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">统计单个表的使用空间</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">exec sp_spaceused &#39;dbo.t1&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">统计每个表的使用空间</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">exec sp_MSforeachtable &quot;exec sp_spaceused &#39;?&#39;&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">统计单个表的使用空间</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">exec sp_spaceused &#39;dbo.t1&#39;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">统计每个表的使用空间</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">exec sp_MSforeachtable &quot;exec sp_spaceused &#39;?&#39;&quot;</span></span></code></pre></div><h2 id="_1-2-列出每个表所占用空间大小" tabindex="-1">1.2 列出每个表所占用空间大小 <a class="header-anchor" href="#_1-2-列出每个表所占用空间大小" aria-label="Permalink to &quot;1.2 列出每个表所占用空间大小&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">SELECT </span></span>
<span class="line"><span style="color:#e1e4e8;">    t.NAME AS TableName,</span></span>
<span class="line"><span style="color:#e1e4e8;">    s.Name AS SchemaName,</span></span>
<span class="line"><span style="color:#e1e4e8;">    p.rows AS RowCounts,</span></span>
<span class="line"><span style="color:#e1e4e8;">    SUM(a.total_pages) * 8 AS TotalSpaceKB, </span></span>
<span class="line"><span style="color:#e1e4e8;">    CAST(ROUND(((SUM(a.total_pages) * 8) / 1024.00), 2) AS NUMERIC(36, 2)) AS TotalSpaceMB,</span></span>
<span class="line"><span style="color:#e1e4e8;">    SUM(a.used_pages) * 8 AS UsedSpaceKB, </span></span>
<span class="line"><span style="color:#e1e4e8;">    CAST(ROUND(((SUM(a.used_pages) * 8) / 1024.00), 2) AS NUMERIC(36, 2)) AS UsedSpaceMB, </span></span>
<span class="line"><span style="color:#e1e4e8;">    (SUM(a.total_pages) - SUM(a.used_pages)) * 8 AS UnusedSpaceKB,</span></span>
<span class="line"><span style="color:#e1e4e8;">    CAST(ROUND(((SUM(a.total_pages) - SUM(a.used_pages)) * 8) / 1024.00, 2) AS NUMERIC(36, 2)) AS UnusedSpaceMB</span></span>
<span class="line"><span style="color:#e1e4e8;">FROM </span></span>
<span class="line"><span style="color:#e1e4e8;">    sys.tables t</span></span>
<span class="line"><span style="color:#e1e4e8;">INNER JOIN      </span></span>
<span class="line"><span style="color:#e1e4e8;">    sys.indexes i ON t.OBJECT_ID = i.object_id</span></span>
<span class="line"><span style="color:#e1e4e8;">INNER JOIN </span></span>
<span class="line"><span style="color:#e1e4e8;">    sys.partitions p ON i.object_id = p.OBJECT_ID AND i.index_id = p.index_id</span></span>
<span class="line"><span style="color:#e1e4e8;">INNER JOIN </span></span>
<span class="line"><span style="color:#e1e4e8;">    sys.allocation_units a ON p.partition_id = a.container_id</span></span>
<span class="line"><span style="color:#e1e4e8;">LEFT OUTER JOIN </span></span>
<span class="line"><span style="color:#e1e4e8;">    sys.schemas s ON t.schema_id = s.schema_id</span></span>
<span class="line"><span style="color:#e1e4e8;">WHERE </span></span>
<span class="line"><span style="color:#e1e4e8;">    t.NAME NOT LIKE &#39;dt%&#39; </span></span>
<span class="line"><span style="color:#e1e4e8;">    AND t.is_ms_shipped = 0</span></span>
<span class="line"><span style="color:#e1e4e8;">    AND i.OBJECT_ID &gt; 255 </span></span>
<span class="line"><span style="color:#e1e4e8;">GROUP BY </span></span>
<span class="line"><span style="color:#e1e4e8;">    t.Name, s.Name, p.Rows</span></span>
<span class="line"><span style="color:#e1e4e8;">ORDER BY </span></span>
<span class="line"><span style="color:#e1e4e8;">    t.Name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">SELECT </span></span>
<span class="line"><span style="color:#24292e;">    t.NAME AS TableName,</span></span>
<span class="line"><span style="color:#24292e;">    s.Name AS SchemaName,</span></span>
<span class="line"><span style="color:#24292e;">    p.rows AS RowCounts,</span></span>
<span class="line"><span style="color:#24292e;">    SUM(a.total_pages) * 8 AS TotalSpaceKB, </span></span>
<span class="line"><span style="color:#24292e;">    CAST(ROUND(((SUM(a.total_pages) * 8) / 1024.00), 2) AS NUMERIC(36, 2)) AS TotalSpaceMB,</span></span>
<span class="line"><span style="color:#24292e;">    SUM(a.used_pages) * 8 AS UsedSpaceKB, </span></span>
<span class="line"><span style="color:#24292e;">    CAST(ROUND(((SUM(a.used_pages) * 8) / 1024.00), 2) AS NUMERIC(36, 2)) AS UsedSpaceMB, </span></span>
<span class="line"><span style="color:#24292e;">    (SUM(a.total_pages) - SUM(a.used_pages)) * 8 AS UnusedSpaceKB,</span></span>
<span class="line"><span style="color:#24292e;">    CAST(ROUND(((SUM(a.total_pages) - SUM(a.used_pages)) * 8) / 1024.00, 2) AS NUMERIC(36, 2)) AS UnusedSpaceMB</span></span>
<span class="line"><span style="color:#24292e;">FROM </span></span>
<span class="line"><span style="color:#24292e;">    sys.tables t</span></span>
<span class="line"><span style="color:#24292e;">INNER JOIN      </span></span>
<span class="line"><span style="color:#24292e;">    sys.indexes i ON t.OBJECT_ID = i.object_id</span></span>
<span class="line"><span style="color:#24292e;">INNER JOIN </span></span>
<span class="line"><span style="color:#24292e;">    sys.partitions p ON i.object_id = p.OBJECT_ID AND i.index_id = p.index_id</span></span>
<span class="line"><span style="color:#24292e;">INNER JOIN </span></span>
<span class="line"><span style="color:#24292e;">    sys.allocation_units a ON p.partition_id = a.container_id</span></span>
<span class="line"><span style="color:#24292e;">LEFT OUTER JOIN </span></span>
<span class="line"><span style="color:#24292e;">    sys.schemas s ON t.schema_id = s.schema_id</span></span>
<span class="line"><span style="color:#24292e;">WHERE </span></span>
<span class="line"><span style="color:#24292e;">    t.NAME NOT LIKE &#39;dt%&#39; </span></span>
<span class="line"><span style="color:#24292e;">    AND t.is_ms_shipped = 0</span></span>
<span class="line"><span style="color:#24292e;">    AND i.OBJECT_ID &gt; 255 </span></span>
<span class="line"><span style="color:#24292e;">GROUP BY </span></span>
<span class="line"><span style="color:#24292e;">    t.Name, s.Name, p.Rows</span></span>
<span class="line"><span style="color:#24292e;">ORDER BY </span></span>
<span class="line"><span style="color:#24292e;">    t.Name</span></span></code></pre></div><h2 id="_1-3-查询当前数据库的磁盘使用情况" tabindex="-1">1.3 查询当前数据库的磁盘使用情况 <a class="header-anchor" href="#_1-3-查询当前数据库的磁盘使用情况" aria-label="Permalink to &quot;1.3 查询当前数据库的磁盘使用情况&quot;">​</a></h2><p>Exec sp_spaceused</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141011121.jpg" alt=""></p><p><strong>查询数据库服务器各数据库日志文件的大小及利用率</strong></p><p>DBCC SQLPERF(LOGSPACE)</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141011345.jpg" alt=""></p><h2 id="_1-4-查看单个数据库大小" tabindex="-1">1.4 查看单个数据库大小 <a class="header-anchor" href="#_1-4-查看单个数据库大小" aria-label="Permalink to &quot;1.4 查看单个数据库大小&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">exec sp_helpdb db_name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">exec sp_helpdb db_name</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141011451.png" alt=""></p><p>但是注意：该命令显示的数据库大小**&quot;db_size&quot;并不是指现存有效数据的大小**，而是指:<strong>数据库物理文件 “数据文件大小 + 日志文件大小”的总和</strong></p><h3 id="查看所有数据库大小" tabindex="-1">查看所有数据库大小 <a class="header-anchor" href="#查看所有数据库大小" aria-label="Permalink to &quot;查看所有数据库大小&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark has-diff vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(database_id) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Database Name],</span></span>
<span class="line"><span style="color:#E1E4E8;">[Name] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Logical Name],</span></span>
<span class="line"><span style="color:#E1E4E8;">[Physical_Name] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Physical Name],</span></span>
<span class="line"><span style="color:#E1E4E8;">((</span><span style="color:#F97583;">size</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Size(MB)],</span></span>
<span class="line"><span style="color:#E1E4E8;">[differential_base_time] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Differential Base Time] </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">master_files</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">desc</span></span></code></pre><pre class="shiki github-light has-diff vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(database_id) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Database Name],</span></span>
<span class="line"><span style="color:#24292E;">[Name] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Logical Name],</span></span>
<span class="line"><span style="color:#24292E;">[Physical_Name] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Physical Name],</span></span>
<span class="line"><span style="color:#24292E;">((</span><span style="color:#D73A49;">size</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Size(MB)],</span></span>
<span class="line"><span style="color:#24292E;">[differential_base_time] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Differential Base Time] </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">master_files</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">desc</span></span></code></pre></div><p>或者</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">SELECT</span></span>
<span class="line"><span style="color:#B392F0;">    name AS DatabaseName,</span></span>
<span class="line"><span style="color:#B392F0;">    size * 8 / 1024 AS SizeMB,</span></span>
<span class="line"><span style="color:#B392F0;">    size * 8 / 1024 - CAST(FILEPROPERTY(name, </span><span style="color:#B392F0;">&#39;SpaceUsed&#39;</span><span style="color:#E1E4E8;">) AS INT) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> 8 / 1024 AS UnusedSpaceMB</span></span>
<span class="line"><span style="color:#B392F0;">FROM</span></span>
<span class="line"><span style="color:#B392F0;">    sys.master_files</span></span>
<span class="line"><span style="color:#B392F0;">WHERE type </span><span style="color:#E1E4E8;">= 0 -- 数据文件类型（不包括日志文件）</span></span>
<span class="line"><span style="color:#B392F0;">ORDER BY SizeMB DESC</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">SELECT</span></span>
<span class="line"><span style="color:#6F42C1;">    name AS DatabaseName,</span></span>
<span class="line"><span style="color:#6F42C1;">    size * 8 / 1024 AS SizeMB,</span></span>
<span class="line"><span style="color:#6F42C1;">    size * 8 / 1024 - CAST(FILEPROPERTY(name, </span><span style="color:#6F42C1;">&#39;SpaceUsed&#39;</span><span style="color:#24292E;">) AS INT) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> 8 / 1024 AS UnusedSpaceMB</span></span>
<span class="line"><span style="color:#6F42C1;">FROM</span></span>
<span class="line"><span style="color:#6F42C1;">    sys.master_files</span></span>
<span class="line"><span style="color:#6F42C1;">WHERE type </span><span style="color:#24292E;">= 0 -- 数据文件类型（不包括日志文件）</span></span>
<span class="line"><span style="color:#6F42C1;">ORDER BY SizeMB DESC</span><span style="color:#24292E;">;</span></span></code></pre></div><h2 id="_1-5查看所有表大小" tabindex="-1">1.5查看所有表大小 <a class="header-anchor" href="#_1-5查看所有表大小" aria-label="Permalink to &quot;1.5查看所有表大小&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> tempdb</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;tempdb..#db&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;U&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">DROP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> #db </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;tempdb..#tb&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;U&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">DROP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> #tb </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;tempdb..#dbtable&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;U&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">DROP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> #dbtable </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> #tb(</span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">),</span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;">,reserved </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">),</span><span style="color:#F97583;">data</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">),index_size </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">),unused </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">)); </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> #dbtable(db </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">),</span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">),</span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;">,reserved </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">),</span><span style="color:#F97583;">data</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">),index_size </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">),unused </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">)) </span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">, px </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ROW_NUMBER</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">OVER</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">INTO</span><span style="color:#E1E4E8;"> #db </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">databases</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NOLOCK</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> database_id </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">-- and name = &#39;hantest&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @sql </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(max) </span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @px </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @dbname </span><span style="color:#F97583;">sysname</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @tdbname </span><span style="color:#F97583;">sysname</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @px2 </span><span style="color:#F97583;">int</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @dbname </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">, @px </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> px </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> #db </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> px </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#F97583;">WHILE</span><span style="color:#E1E4E8;"> @@rowcount </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @sql </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;use &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(@dbname)</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;exec sp_msforeachtable &#39;&#39;</span></span>
<span class="line"><span style="color:#9ECBFF;">               insert into #tb execute sp_spaceused &#39;&#39;&#39;&#39;?&#39;&#39;&#39;&#39;;&#39;&#39;</span></span>
<span class="line"><span style="color:#9ECBFF;">               insert into #dbtable select &#39;&#39;&#39;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">@dbname</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;&#39;&#39;,* from #tb</span></span>
<span class="line"><span style="color:#9ECBFF;">               truncate table #tb&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">EXECUTE</span><span style="color:#E1E4E8;">(@sql) </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) @dbname </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">, @px </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> px </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> #db </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> px </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> @px; </span></span>
<span class="line"><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">   db </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [database_name] </span></span>
<span class="line"><span style="color:#E1E4E8;">  ,</span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [table_name] </span></span>
<span class="line"><span style="color:#E1E4E8;">  ,</span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">  ,</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NUMERIC</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NUMERIC</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(reserved,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">LEN</span><span style="color:#E1E4E8;">(reserved)</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> reserved_size_MB </span></span>
<span class="line"><span style="color:#E1E4E8;">  ,</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NUMERIC</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NUMERIC</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">data</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">LEN</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">data</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> data_size_MB </span></span>
<span class="line"><span style="color:#E1E4E8;">  ,</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NUMERIC</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NUMERIC</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(index_size,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">LEN</span><span style="color:#E1E4E8;">(index_size)</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> index_size_MB </span></span>
<span class="line"><span style="color:#E1E4E8;">  ,</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NUMERIC</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NUMERIC</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(unused,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">LEN</span><span style="color:#E1E4E8;">(unused)</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> unused_size_MB </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> #dbtable </span></span>
<span class="line"><span style="color:#6A737D;">--WHERE rows &lt;&gt; &#39;0&#39; </span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">BIGINT</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">LEFT</span><span style="color:#E1E4E8;">(reserved,</span><span style="color:#79B8FF;">LEN</span><span style="color:#E1E4E8;">(reserved)</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> tempdb</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;tempdb..#db&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;U&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">DROP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> #db </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;tempdb..#tb&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;U&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">DROP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> #tb </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;tempdb..#dbtable&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;U&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">DROP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> #dbtable </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> #tb(</span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">),</span><span style="color:#D73A49;">rows</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;">,reserved </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">),</span><span style="color:#D73A49;">data</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">),index_size </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">),unused </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">)); </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> #dbtable(db </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">),</span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">),</span><span style="color:#D73A49;">rows</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;">,reserved </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">),</span><span style="color:#D73A49;">data</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">),index_size </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">),unused </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">)) </span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">, px </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ROW_NUMBER</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">OVER</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">INTO</span><span style="color:#24292E;"> #db </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">databases</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NOLOCK</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">state</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> database_id </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">-- and name = &#39;hantest&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @sql </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(max) </span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @px </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @dbname </span><span style="color:#D73A49;">sysname</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @tdbname </span><span style="color:#D73A49;">sysname</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @px2 </span><span style="color:#D73A49;">int</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @dbname </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">, @px </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> px </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> #db </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> px </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#D73A49;">WHILE</span><span style="color:#24292E;"> @@rowcount </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @sql </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;use &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(@dbname)</span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;exec sp_msforeachtable &#39;&#39;</span></span>
<span class="line"><span style="color:#032F62;">               insert into #tb execute sp_spaceused &#39;&#39;&#39;&#39;?&#39;&#39;&#39;&#39;;&#39;&#39;</span></span>
<span class="line"><span style="color:#032F62;">               insert into #dbtable select &#39;&#39;&#39;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">@dbname</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;&#39;&#39;,* from #tb</span></span>
<span class="line"><span style="color:#032F62;">               truncate table #tb&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">EXECUTE</span><span style="color:#24292E;">(@sql) </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) @dbname </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">, @px </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> px </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> #db </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> px </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> @px; </span></span>
<span class="line"><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">   db </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [database_name] </span></span>
<span class="line"><span style="color:#24292E;">  ,</span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [table_name] </span></span>
<span class="line"><span style="color:#24292E;">  ,</span><span style="color:#D73A49;">rows</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">  ,</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NUMERIC</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">18</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NUMERIC</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">18</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(reserved,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">LEN</span><span style="color:#24292E;">(reserved)</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> reserved_size_MB </span></span>
<span class="line"><span style="color:#24292E;">  ,</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NUMERIC</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">18</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NUMERIC</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">18</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">data</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">LEN</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">data</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> data_size_MB </span></span>
<span class="line"><span style="color:#24292E;">  ,</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NUMERIC</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">18</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NUMERIC</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">18</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(index_size,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">LEN</span><span style="color:#24292E;">(index_size)</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> index_size_MB </span></span>
<span class="line"><span style="color:#24292E;">  ,</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NUMERIC</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">18</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NUMERIC</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">18</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(unused,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">LEN</span><span style="color:#24292E;">(unused)</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> unused_size_MB </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> #dbtable </span></span>
<span class="line"><span style="color:#6A737D;">--WHERE rows &lt;&gt; &#39;0&#39; </span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">BIGINT</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">LEFT</span><span style="color:#24292E;">(reserved,</span><span style="color:#005CC5;">LEN</span><span style="color:#24292E;">(reserved)</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141011810.jpg" alt=""></p><h2 id="_1-6查看特定库所有表" tabindex="-1">1.6查看特定库所有表 <a class="header-anchor" href="#_1-6查看特定库所有表" aria-label="Permalink to &quot;1.6查看特定库所有表&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> db_name</span></span>
<span class="line"><span style="color:#F97583;">go</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tables</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> db_name</span></span>
<span class="line"><span style="color:#D73A49;">go</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tables</span></span></code></pre></div><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">NAME</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> TableName,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> SchemaName,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">rows</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> RowCounts,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_pages</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> TotalSpaceKB,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">ROUND</span><span style="color:#E1E4E8;">(((</span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_pages</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NUMERIC</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">36</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> TotalSpaceMB,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">used_pages</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> UsedSpaceKB,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">ROUND</span><span style="color:#E1E4E8;">(((</span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">used_pages</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NUMERIC</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">36</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> UsedSpaceMB,</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_pages</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">used_pages</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> UnusedSpaceKB,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">ROUND</span><span style="color:#E1E4E8;">(((</span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_pages</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">used_pages</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NUMERIC</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">36</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> UnusedSpaceMB</span></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tables</span><span style="color:#E1E4E8;"> t</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">partitions</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">allocation_units</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">partition_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">container_id</span></span>
<span class="line"><span style="color:#F97583;">LEFT OUTER JOIN</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schemas</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schema_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schema_id</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">NAME</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LIKE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;dt%&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_ms_shipped</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">255</span></span>
<span class="line"><span style="color:#F97583;">GROUP BY</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Name</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Name</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Rows</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span></span>
<span class="line"><span style="color:#E1E4E8;">    UsedSpaceMB </span><span style="color:#F97583;">desc</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">NAME</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> TableName,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> SchemaName,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">rows</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> RowCounts,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_pages</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> TotalSpaceKB,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">ROUND</span><span style="color:#24292E;">(((</span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_pages</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NUMERIC</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">36</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> TotalSpaceMB,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">used_pages</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> UsedSpaceKB,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">ROUND</span><span style="color:#24292E;">(((</span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">used_pages</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NUMERIC</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">36</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> UsedSpaceMB,</span></span>
<span class="line"><span style="color:#24292E;">    (</span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_pages</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">used_pages</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> UnusedSpaceKB,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">ROUND</span><span style="color:#24292E;">(((</span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_pages</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">used_pages</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NUMERIC</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">36</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> UnusedSpaceMB</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tables</span><span style="color:#24292E;"> t</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;">      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">partitions</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">allocation_units</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">partition_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">container_id</span></span>
<span class="line"><span style="color:#D73A49;">LEFT OUTER JOIN</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schemas</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schema_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schema_id</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">NAME</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LIKE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;dt%&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_ms_shipped</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">255</span></span>
<span class="line"><span style="color:#D73A49;">GROUP BY</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Name</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Name</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Rows</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span></span>
<span class="line"><span style="color:#24292E;">    UsedSpaceMB </span><span style="color:#D73A49;">desc</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Name</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410120959154.png" alt="image-20241012095854446"></p><p>或者</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> TableName,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">rows</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> RowCounts,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_pages</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> TotalSpaceMB,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">used_pages</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> UsedSpaceMB,</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_pages</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">used_pages</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> UnusedSpaceMB</span></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tables</span><span style="color:#E1E4E8;"> t</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">partitions</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">allocation_units</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">partition_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">container_id</span></span>
<span class="line"><span style="color:#F97583;">GROUP BY</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">rows</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span></span>
<span class="line"><span style="color:#E1E4E8;">    TotalSpaceMB </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> TableName,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">rows</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> RowCounts,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_pages</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> TotalSpaceMB,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">used_pages</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> UsedSpaceMB,</span></span>
<span class="line"><span style="color:#24292E;">    (</span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_pages</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">used_pages</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> UnusedSpaceMB</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tables</span><span style="color:#24292E;"> t</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">partitions</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">allocation_units</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">partition_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">container_id</span></span>
<span class="line"><span style="color:#D73A49;">GROUP BY</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">rows</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span></span>
<span class="line"><span style="color:#24292E;">    TotalSpaceMB </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="查看当前库中有多少表" tabindex="-1">查看当前库中有多少表 <a class="header-anchor" href="#查看当前库中有多少表" aria-label="Permalink to &quot;查看当前库中有多少表&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#F97583;">CASE</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">WHEN</span></span>
<span class="line"><span style="color:#E1E4E8;">    xtype </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;U&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">&#39;表&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> xtype </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;P&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">&#39;存储过程&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> xtype </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;FN&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">&#39;标量值函数&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> xtype </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;IF&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">&#39;表值函数&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> xtype </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;V&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">&#39;视图&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> xtype </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;TR&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">&#39;触发器&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> xtype </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;SN&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">&#39;同义词&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> xtype,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">COUNT</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> ) cnt </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">    sysobjects </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">WHERE</span></span>
<span class="line"><span style="color:#E1E4E8;">    xtype </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> ( </span><span style="color:#9ECBFF;">&#39;P&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;FN&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;IF&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;TR&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;TR&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;U&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;V&#39;</span><span style="color:#E1E4E8;"> ) </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">uid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> category </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">GROUP BY</span></span>
<span class="line"><span style="color:#E1E4E8;">    xtype </span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span></span>
<span class="line"><span style="color:#E1E4E8;">  xtype;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#D73A49;">CASE</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">WHEN</span></span>
<span class="line"><span style="color:#24292E;">    xtype </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;U&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&#39;表&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> xtype </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;P&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&#39;存储过程&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> xtype </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;FN&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&#39;标量值函数&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> xtype </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;IF&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&#39;表值函数&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> xtype </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;V&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&#39;视图&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> xtype </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;TR&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&#39;触发器&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> xtype </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;SN&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">&#39;同义词&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> xtype,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">COUNT</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> ) cnt </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">    sysobjects </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">WHERE</span></span>
<span class="line"><span style="color:#24292E;">    xtype </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> ( </span><span style="color:#032F62;">&#39;P&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;FN&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;IF&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;TR&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;TR&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;U&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;V&#39;</span><span style="color:#24292E;"> ) </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">uid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> category </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">GROUP BY</span></span>
<span class="line"><span style="color:#24292E;">    xtype </span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span></span>
<span class="line"><span style="color:#24292E;">  xtype;</span></span></code></pre></div><h2 id="_1-7检查数据文件空间使用率" tabindex="-1">1.7检查数据文件空间使用率 <a class="header-anchor" href="#_1-7检查数据文件空间使用率" aria-label="Permalink to &quot;1.7检查数据文件空间使用率&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_NAME</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 检查数据库文件空间使用率</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> [文件名称] ,</span><span style="color:#79B8FF;">cast</span><span style="color:#E1E4E8;">(a.[size]</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">decimal</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [文件设置大小(MB)] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">( </span><span style="color:#79B8FF;">fileproperty</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;SpaceUsed&#39;</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">8</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DECIMAL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [文件所占空间(MB)] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">( (</span><span style="color:#79B8FF;">fileproperty</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;SpaceUsed&#39;</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">8</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">size</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">8</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DECIMAL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [所占空间率%] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">growth</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;文件大小固定，不会增长&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;文件将自动增长&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;"> [增长模式] ,</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">growth</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> is_percent_growth </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;增量为固定大小&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">growth</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> is_percent_growth </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;增量将用整数百分比表示&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;文件大小固定，不会增长&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [增量模式] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">growth</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> is_percent_growth </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">cast</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">cast</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">growth</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">128as </span><span style="color:#F97583;">decimal</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;MB&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">growth</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> is_percent_growth </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">cast</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">cast</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">growth</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">decimal</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;%&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;文件大小固定，不会增长&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [增长值(%或MB)] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">physical_name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [文件所在目录] ,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [文件类型] </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_files</span><span style="color:#E1E4E8;"> a </span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sysfiles</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> s  </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> a.[file_id]</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fileid</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_file_space_usage</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> a.[file_id]</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">b.[file_id] </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> a.[type]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_NAME</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 检查数据库文件空间使用率</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> [文件名称] ,</span><span style="color:#005CC5;">cast</span><span style="color:#24292E;">(a.[size]</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">128</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">decimal</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [文件设置大小(MB)] ,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">( </span><span style="color:#005CC5;">fileproperty</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;SpaceUsed&#39;</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">8</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DECIMAL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [文件所占空间(MB)] ,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">( (</span><span style="color:#005CC5;">fileproperty</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;SpaceUsed&#39;</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">8</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">size</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">8</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DECIMAL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [所占空间率%] ,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">growth</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;文件大小固定，不会增长&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;文件将自动增长&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end</span><span style="color:#24292E;"> [增长模式] ,</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">growth</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> is_percent_growth </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;增量为固定大小&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">growth</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> is_percent_growth </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;增量将用整数百分比表示&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;文件大小固定，不会增长&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [增量模式] ,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">growth</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> is_percent_growth </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">cast</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">cast</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">growth</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">128as </span><span style="color:#D73A49;">decimal</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;MB&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">growth</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> is_percent_growth </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">cast</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">cast</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">growth</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">decimal</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;%&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;文件大小固定，不会增长&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [增长值(%或MB)] ,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">physical_name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [文件所在目录] ,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [文件类型] </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_files</span><span style="color:#24292E;"> a </span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sysfiles</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> s  </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> a.[file_id]</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fileid</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_file_space_usage</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> a.[file_id]</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">b.[file_id] </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> a.[type]</span></span></code></pre></div><h2 id="_1-8kill用户连接数据库" tabindex="-1">1.8kill用户连接数据库 <a class="header-anchor" href="#_1-8kill用户连接数据库" aria-label="Permalink to &quot;1.8kill用户连接数据库&quot;">​</a></h2><h3 id="查询数据库id" tabindex="-1">查询数据库ID <a class="header-anchor" href="#查询数据库id" aria-label="Permalink to &quot;查询数据库ID&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">Select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span><span style="color:#E1E4E8;">..sysdatabases </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;db_name&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">Select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span><span style="color:#24292E;">..sysdatabases </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;db_name&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="获取该数据库的进程" tabindex="-1">获取该数据库的进程 <a class="header-anchor" href="#获取该数据库的进程" aria-label="Permalink to &quot;获取该数据库的进程&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">Select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sysprocesses</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">Select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sysprocesses</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="kill连接在上面的进程" tabindex="-1">kill连接在上面的进程 <a class="header-anchor" href="#kill连接在上面的进程" aria-label="Permalink to &quot;kill连接在上面的进程&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">kill</span><span style="color:#E1E4E8;"> spid;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">kill</span><span style="color:#24292E;"> spid;</span></span></code></pre></div><h1 id="二、查看物理信息" tabindex="-1">二、查看物理信息 <a class="header-anchor" href="#二、查看物理信息" aria-label="Permalink to &quot;二、查看物理信息&quot;">​</a></h1><h2 id="_2-1获取数据库文件物理地址" tabindex="-1">2.1获取数据库文件物理地址 <a class="header-anchor" href="#_2-1获取数据库文件物理地址" aria-label="Permalink to &quot;2.1获取数据库文件物理地址&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_files</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_files</span><span style="color:#24292E;">;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141011913.jpg" alt=""></p><h2 id="_2-2获取服务器磁盘可用信息" tabindex="-1">2.2获取服务器磁盘可用信息 <a class="header-anchor" href="#_2-2获取服务器磁盘可用信息" aria-label="Permalink to &quot;2.2获取服务器磁盘可用信息&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">exec master.sys.xp_fixeddrives;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">exec master.sys.xp_fixeddrives;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141011826.jpg" alt=""></p><h2 id="_2-2获取数据库版本信息" tabindex="-1">2.2获取数据库版本信息 <a class="header-anchor" href="#_2-2获取数据库版本信息" aria-label="Permalink to &quot;2.2获取数据库版本信息&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">master</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.xp_msver;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">master</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.xp_msver;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141011597.jpg" alt=""></p><h3 id="查看数据库版本信息" tabindex="-1">查看数据库版本信息 <a class="header-anchor" href="#查看数据库版本信息" aria-label="Permalink to &quot;查看数据库版本信息&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @@</span><span style="color:#F97583;">version</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SERVERPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">N&#39;edition&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Edition</span><span style="color:#E1E4E8;">     </span><span style="color:#6A737D;">--数据版本，如企业版、开发版等</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">SERVERPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">N&#39;collation&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> Collation   </span><span style="color:#6A737D;">--数据库字符集</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">SERVERPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">N&#39;servername&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> ServerName </span><span style="color:#6A737D;">--服务名</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,@@</span><span style="color:#F97583;">VERSION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Version</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">--数据库版本号</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,@@</span><span style="color:#F97583;">LANGUAGE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Language</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--数据库使用的语言，如us_english等</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @@</span><span style="color:#D73A49;">version</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SERVERPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#032F62;">N&#39;edition&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Edition</span><span style="color:#24292E;">     </span><span style="color:#6A737D;">--数据版本，如企业版、开发版等</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">SERVERPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#032F62;">N&#39;collation&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> Collation   </span><span style="color:#6A737D;">--数据库字符集</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">SERVERPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#032F62;">N&#39;servername&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> ServerName </span><span style="color:#6A737D;">--服务名</span></span>
<span class="line"><span style="color:#24292E;">    ,@@</span><span style="color:#D73A49;">VERSION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Version</span><span style="color:#24292E;">   </span><span style="color:#6A737D;">--数据库版本号</span></span>
<span class="line"><span style="color:#24292E;">    ,@@</span><span style="color:#D73A49;">LANGUAGE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Language</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">--数据库使用的语言，如us_english等</span></span></code></pre></div><h2 id="_2-3获取sqlserver启动时间" tabindex="-1">2.3获取sqlserver启动时间 <a class="header-anchor" href="#_2-3获取sqlserver启动时间" aria-label="Permalink to &quot;2.3获取sqlserver启动时间&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> sqlserver_start_time </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_sys_info</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> sqlserver_start_time </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_sys_info</span><span style="color:#24292E;">;</span></span></code></pre></div><h2 id="_2-4-服务器是否强制加密" tabindex="-1">2.4 服务器是否强制加密 <a class="header-anchor" href="#_2-4-服务器是否强制加密" aria-label="Permalink to &quot;2.4 服务器是否强制加密&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> net_transport, encrypt_option, auth_scheme</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_connections</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> session_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @@SPID;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> net_transport, encrypt_option, auth_scheme</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_connections</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> session_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @@SPID;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/20251013215916165.png" alt="image-20251013215905433"></p><ul><li>SQL Server 本身无法直接返回“强制加密”开关，但可以通过 DMV 确认<code>当前连接</code>是否加密</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">    session_id,</span></span>
<span class="line"><span style="color:#E1E4E8;">    encrypt_option</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_connections</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> session_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @@SPID;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">    session_id,</span></span>
<span class="line"><span style="color:#24292E;">    encrypt_option</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_connections</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> session_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @@SPID;</span></span></code></pre></div><h1 id="三、基本操作" tabindex="-1">三、基本操作 <a class="header-anchor" href="#三、基本操作" aria-label="Permalink to &quot;三、基本操作&quot;">​</a></h1><p>官方文档，<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/security/authentication-access/database-level-roles?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/relational-databases/security/authentication-access/database-level-roles?view=sql-server-2017</a></p><h2 id="_3-0查看所有数据库" tabindex="-1">3.0查看所有数据库 <a class="header-anchor" href="#_3-0查看所有数据库" aria-label="Permalink to &quot;3.0查看所有数据库&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">Select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Master</span><span style="color:#E1E4E8;">..SysDatabases </span><span style="color:#F97583;">orDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">Select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Master</span><span style="color:#24292E;">..SysDatabases </span><span style="color:#D73A49;">orDER BY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Name</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141011618.jpg" alt=""></p><h2 id="_3-1创建数据库" tabindex="-1">3.1创建数据库 <a class="header-anchor" href="#_3-1创建数据库" aria-label="Permalink to &quot;3.1创建数据库&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">#指定字符集,这个默认创建数据库类型为FULL</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TestData</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">COLLATE</span><span style="color:#E1E4E8;"> Chinese_PRC_CI_AS</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#默认创建</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TestData</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">#指定字符集,这个默认创建数据库类型为FULL</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TestData</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">COLLATE</span><span style="color:#24292E;"> Chinese_PRC_CI_AS</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#默认创建</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TestData</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><ul><li>指定数据库文件位置</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#F97583;">go</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">E_Market</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">primary</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">name=</span><span style="color:#9ECBFF;">&quot;E_Market_data&quot;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">filename=</span><span style="color:#9ECBFF;">&quot;/var/opt/mssql/data/E_Market_data.mdf&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">size=</span><span style="color:#E1E4E8;">5MB, </span></span>
<span class="line"><span style="color:#E1E4E8;">	maxsize</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">100MB, </span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">filegrowth=</span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;">%</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">log</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">on</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">name=</span><span style="color:#9ECBFF;">&quot;E_Market_log&quot;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">filename=</span><span style="color:#9ECBFF;">&quot;/var/opt/mssql/data/E_Market_log.ldf&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">size=</span><span style="color:#E1E4E8;">5MB, </span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">filegrowth=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">go</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#D73A49;">go</span><span style="color:#24292E;">  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">E_Market</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">primary</span></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">name=</span><span style="color:#032F62;">&quot;E_Market_data&quot;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">filename=</span><span style="color:#032F62;">&quot;/var/opt/mssql/data/E_Market_data.mdf&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">size=</span><span style="color:#24292E;">5MB, </span></span>
<span class="line"><span style="color:#24292E;">	maxsize</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">100MB, </span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">filegrowth=</span><span style="color:#005CC5;">15</span><span style="color:#24292E;">%</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">log</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">on</span></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">name=</span><span style="color:#032F62;">&quot;E_Market_log&quot;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">filename=</span><span style="color:#032F62;">&quot;/var/opt/mssql/data/E_Market_log.ldf&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">size=</span><span style="color:#24292E;">5MB, </span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">filegrowth=</span><span style="color:#005CC5;">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">go</span></span></code></pre></div><h3 id="数据库重命名" tabindex="-1">数据库重命名 <a class="header-anchor" href="#数据库重命名" aria-label="Permalink to &quot;数据库重命名&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_renamedb </span><span style="color:#9ECBFF;">N&#39;old_name&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">N&#39;new_name&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_renamedb </span><span style="color:#032F62;">N&#39;old_name&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">N&#39;new_name&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><blockquote><p>但是我们打开数据库默认存放路径，发现MDF和LDF的名称并没有改变,此时需要修改存储路径的名字</p></blockquote><h2 id="_3-2查询" tabindex="-1">3.2查询 <a class="header-anchor" href="#_3-2查询" aria-label="Permalink to &quot;3.2查询&quot;">​</a></h2><h3 id="查看字符集" tabindex="-1">查看字符集 <a class="header-anchor" href="#查看字符集" aria-label="Permalink to &quot;查看字符集&quot;">​</a></h3><p>正确设置 SQL Server 排序规则</p><p>正确的设置 SQL Server 排序规则 ，保持 Instances、Databases、Columns 中 3 处排序规则一致，默认字符集是 Chinese_PRC_CI_AS 。</p><p>尽可能使用 nvarchar 等 Unicode 类型，而非 varchar 类型</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">#查询当前SQL Server服务器的排序规则</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SERVERPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">N&#39;Collation&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#指定数据库名字,DataName</span><span style="color:#6A737D;">----》数据库名字</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">,collation_name </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">databases</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;DataName&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">#查询当前SQL Server服务器的排序规则</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SERVERPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#032F62;">N&#39;Collation&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#指定数据库名字,DataName</span><span style="color:#6A737D;">----》数据库名字</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">,collation_name </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">databases</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;DataName&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><p>#而表中的列（columns）默认情况是继承 Databases 的排序规则（除非在创建表时对列的排序规则进行指定），我们可通过目录视图 sys.columns 查询表中 columns 的排序规则信息</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">, collation_name </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">columns</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> collation_name </span><span style="color:#F97583;">is NOT NULL</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">, collation_name </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">columns</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> collation_name </span><span style="color:#D73A49;">is NOT NULL</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141011614.jpg" alt=""></p><ul><li>目录视图,查看字符集</li></ul><p>而表中的列（columns）默认情况是继承 Databases 的排序规则（除非在创建表时对列的排序规则进行指定），我们可通过目录视图 sys.columns 查询表中 columns 的排序规则信息</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">, collation_name </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">columns</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> collation_name </span><span style="color:#F97583;">is NOT NULL</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">, collation_name </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">columns</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> collation_name </span><span style="color:#D73A49;">is NOT NULL</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141011962.jpg" alt=""></p><h3 id="修改字符集" tabindex="-1">修改字符集 <a class="header-anchor" href="#修改字符集" aria-label="Permalink to &quot;修改字符集&quot;">​</a></h3><ul><li>方式1</li></ul><p>通过图形界面修改</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141011973.jpg" alt=""></p><ul><li>方式2</li></ul><p>查看下</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141011735.jpg" alt=""></p><p>在查询分析器中，输入如下命令：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> hantest </span><span style="color:#F97583;">COLLATE</span><span style="color:#E1E4E8;"> Chinese_PRC_CI_AS</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> hantest </span><span style="color:#D73A49;">COLLATE</span><span style="color:#24292E;"> Chinese_PRC_CI_AS</span></span></code></pre></div><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--通过目录视图 sys.databases 查询 Databases 的排序规则</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">,collation_name </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">databases</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;hantest&#39;</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">//</span><span style="color:#E1E4E8;">将hantest为数据库名</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--通过目录视图 sys.databases 查询 Databases 的排序规则</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">,collation_name </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">databases</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;hantest&#39;</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">//</span><span style="color:#24292E;">将hantest为数据库名</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141011472.jpg" alt=""></p><h2 id="_3-2-查看远程登陆人数" tabindex="-1">3.2 查看远程登陆人数 <a class="header-anchor" href="#_3-2-查看远程登陆人数" aria-label="Permalink to &quot;3.2 查看远程登陆人数&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 查看远程登陆人</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> login_name,</span><span style="color:#79B8FF;">Count</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) user_count</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> dr </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">nolock</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">RIGHT OUTER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sessions</span><span style="color:#E1E4E8;"> ds </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">nolock</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">dr</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ds</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"><span style="color:#F97583;">RIGHT OUTER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_connections</span><span style="color:#E1E4E8;"> dc </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">nolock</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ds</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">dc</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ds</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">50</span></span>
<span class="line"><span style="color:#F97583;">GROUP BY</span><span style="color:#E1E4E8;"> login_name</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> user_count </span><span style="color:#F97583;">DESC</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#或者</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> loginame,</span><span style="color:#79B8FF;">count</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> sysprocesses</span></span>
<span class="line"><span style="color:#F97583;">group by</span><span style="color:#E1E4E8;"> loginame</span></span>
<span class="line"><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">count</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">desc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 查看远程登陆人</span></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> login_name,</span><span style="color:#005CC5;">Count</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) user_count</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> dr </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">nolock</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">RIGHT OUTER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sessions</span><span style="color:#24292E;"> ds </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">nolock</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">dr</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ds</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"><span style="color:#D73A49;">RIGHT OUTER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_connections</span><span style="color:#24292E;"> dc </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">nolock</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ds</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">dc</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ds</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">50</span></span>
<span class="line"><span style="color:#D73A49;">GROUP BY</span><span style="color:#24292E;"> login_name</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> user_count </span><span style="color:#D73A49;">DESC</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#或者</span></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> loginame,</span><span style="color:#005CC5;">count</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> sysprocesses</span></span>
<span class="line"><span style="color:#D73A49;">group by</span><span style="color:#24292E;"> loginame</span></span>
<span class="line"><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">count</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">desc</span></span></code></pre></div><h3 id="查看远程连接用户主机名" tabindex="-1">查看远程连接用户主机名 <a class="header-anchor" href="#查看远程连接用户主机名" aria-label="Permalink to &quot;查看远程连接用户主机名&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> hostname,</span><span style="color:#79B8FF;">count</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> sysprocesses </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> loginame</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;sa&#39;</span></span>
<span class="line"><span style="color:#F97583;">group by</span><span style="color:#E1E4E8;"> hostname</span></span>
<span class="line"><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">count</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">desc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> hostname,</span><span style="color:#005CC5;">count</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> sysprocesses </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> loginame</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;sa&#39;</span></span>
<span class="line"><span style="color:#D73A49;">group by</span><span style="color:#24292E;"> hostname</span></span>
<span class="line"><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">count</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">desc</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141011619.jpg" alt=""></p><h2 id="_3-2-查看用户登陆日志" tabindex="-1">3.2 查看用户登陆日志 <a class="header-anchor" href="#_3-2-查看用户登陆日志" aria-label="Permalink to &quot;3.2 查看用户登陆日志&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">sd</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Name</span><span style="color:#E1E4E8;">)</span><span style="color:#9ECBFF;">&#39;数据库&#39;</span><span style="color:#E1E4E8;">,sp.</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">[Master].[dbo].[SYSPROCESSES] sp,[Master].[dbo].[SYSDATABASES] sd </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sd</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;DB_Name&#39;</span></span>
<span class="line"><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> login_time </span><span style="color:#F97583;">desc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">sd</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Name</span><span style="color:#24292E;">)</span><span style="color:#032F62;">&#39;数据库&#39;</span><span style="color:#24292E;">,sp.</span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">[Master].[dbo].[SYSPROCESSES] sp,[Master].[dbo].[SYSDATABASES] sd </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sd</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;DB_Name&#39;</span></span>
<span class="line"><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> login_time </span><span style="color:#D73A49;">desc</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141011131.jpg" alt=""></p><h2 id="_3-3查看死锁" tabindex="-1">3.3查看死锁 <a class="header-anchor" href="#_3-3查看死锁" aria-label="Permalink to &quot;3.3查看死锁&quot;">​</a></h2><ul><li>用扩展时间抓取过去的死锁信息</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @SessionName </span><span style="color:#F97583;">SysName</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @SessionName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;system_health&#39;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;tempdb..#Events&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">IS NOT NULL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">DROP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> #Events</span></span>
<span class="line"><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @Target_File </span><span style="color:#F97583;">NVarChar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    , @Target_Dir </span><span style="color:#F97583;">NVarChar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    , @Target_File_WildCard </span><span style="color:#F97583;">NVarChar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @Target_File </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">target_data</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;">).</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;EventFileTarget[1]/File[1]/@name&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;NVARCHAR(256)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_xe_session_targets</span><span style="color:#E1E4E8;"> t</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_xe_sessions</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">address</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">event_session_address</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @SessionName</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">target_name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;event_file&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @Target_Dir </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">LEFT</span><span style="color:#E1E4E8;">(@Target_File, </span><span style="color:#79B8FF;">Len</span><span style="color:#E1E4E8;">(@Target_File) </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CHARINDEX</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;\\&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">REVERSE</span><span style="color:#E1E4E8;">(@Target_File))) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @Target_File_WildCard </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @Target_Dir </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;\\&#39;</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @SessionName </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;_*.xel&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--Keep this as a separate table because it&#39;s called twice in the next query.  You don&#39;t want this running twice.</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> DeadlockGraph </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(event_data </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    , DeadlockID </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Row_Number</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">OVER</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> file_name, file_offset)</span></span>
<span class="line"><span style="color:#F97583;">INTO</span><span style="color:#E1E4E8;"> #Events</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fn_xe_file_target_read_file</span><span style="color:#E1E4E8;">(@Target_File_WildCard, </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> F</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> event_data </span><span style="color:#F97583;">like</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;event name=&quot;xml_deadlock_report%&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">;</span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> Victims </span><span style="color:#F97583;">AS</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> VictimID </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Victims</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@id&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(50)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockID</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> #Events e</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockGraph</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nodes</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/event/data/value/deadlock/victim-list/victimProcess&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> Deadlock(Victims)</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">, DeadlockObjects </span><span style="color:#F97583;">AS</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT DISTINCT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockID</span></span>
<span class="line"><span style="color:#E1E4E8;">        , ObjectName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Resources</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@objectname&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;nvarchar(256)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> #Events e</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockGraph</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nodes</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/event/data/value/deadlock/resource-list/*&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> Deadlock(Resources)</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockID</span></span>
<span class="line"><span style="color:#E1E4E8;">        , TransactionTime </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@lasttranstarted&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;datetime&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , DeadlockGraph</span></span>
<span class="line"><span style="color:#E1E4E8;">        , DeadlockObjects </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">substring</span><span style="color:#E1E4E8;">((</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;, &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">ObjectName</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> DeadlockObjects o</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockID</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">ObjectName</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PATH</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                            ), </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">4000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , Victim </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">v</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">VictimID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS NOT NULL</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#E1E4E8;">        , SPID </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@spid&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;int&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , ProcedureName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;executionStack[1]/frame[1]/@procname[1]&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(200)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , LockMode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@lockMode&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;char(1)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , Code </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;executionStack[1]/frame[1]&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(1000)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , ClientApp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">LEFT</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@clientapp&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(100)&#39;</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">29</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;SQLAgent - TSQL JobStep (Job &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;SQLAgent Job: &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> msdb..sysjobs sj </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">substring</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@clientapp&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(100)&#39;</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">substring</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fn_varbintohexstr</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sj</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">job_id</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">))) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; - &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@clientapp&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(100)&#39;</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">67</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@clientapp&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(100)&#39;</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">67</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@clientapp&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(100)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        , HostName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@hostname&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(20)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , LoginName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@loginname&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(20)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , InputBuffer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;inputbuf[1]&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(1000)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> #Events e</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockGraph</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nodes</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/event/data/value/deadlock/process-list/process&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> Deadlock(Process)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> Victims v </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">v</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">v</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">VictimID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@id&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(50)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">) X</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> DeadlockID </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @SessionName </span><span style="color:#D73A49;">SysName</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @SessionName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;system_health&#39;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;tempdb..#Events&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">IS NOT NULL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">DROP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> #Events</span></span>
<span class="line"><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @Target_File </span><span style="color:#D73A49;">NVarChar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    , @Target_Dir </span><span style="color:#D73A49;">NVarChar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    , @Target_File_WildCard </span><span style="color:#D73A49;">NVarChar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @Target_File </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">target_data</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;">).</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;EventFileTarget[1]/File[1]/@name&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;NVARCHAR(256)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_xe_session_targets</span><span style="color:#24292E;"> t</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_xe_sessions</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">address</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">event_session_address</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @SessionName</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">target_name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;event_file&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @Target_Dir </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">LEFT</span><span style="color:#24292E;">(@Target_File, </span><span style="color:#005CC5;">Len</span><span style="color:#24292E;">(@Target_File) </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CHARINDEX</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;\\&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">REVERSE</span><span style="color:#24292E;">(@Target_File))) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @Target_File_WildCard </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @Target_Dir </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;\\&#39;</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @SessionName </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;_*.xel&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--Keep this as a separate table because it&#39;s called twice in the next query.  You don&#39;t want this running twice.</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> DeadlockGraph </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(event_data </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    , DeadlockID </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Row_Number</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">OVER</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> file_name, file_offset)</span></span>
<span class="line"><span style="color:#D73A49;">INTO</span><span style="color:#24292E;"> #Events</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fn_xe_file_target_read_file</span><span style="color:#24292E;">(@Target_File_WildCard, </span><span style="color:#D73A49;">null</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">null</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">null</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> F</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> event_data </span><span style="color:#D73A49;">like</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;event name=&quot;xml_deadlock_report%&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">;</span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> Victims </span><span style="color:#D73A49;">AS</span></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> VictimID </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Victims</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@id&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(50)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockID</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> #Events e</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockGraph</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nodes</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;/event/data/value/deadlock/victim-list/victimProcess&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> Deadlock(Victims)</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">, DeadlockObjects </span><span style="color:#D73A49;">AS</span></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT DISTINCT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockID</span></span>
<span class="line"><span style="color:#24292E;">        , ObjectName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Resources</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@objectname&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;nvarchar(256)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> #Events e</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockGraph</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nodes</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;/event/data/value/deadlock/resource-list/*&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> Deadlock(Resources)</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockID</span></span>
<span class="line"><span style="color:#24292E;">        , TransactionTime </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@lasttranstarted&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;datetime&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , DeadlockGraph</span></span>
<span class="line"><span style="color:#24292E;">        , DeadlockObjects </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">substring</span><span style="color:#24292E;">((</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;, &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">ObjectName</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> DeadlockObjects o</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockID</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">ObjectName</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PATH</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                            ), </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">4000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , Victim </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">v</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">VictimID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS NOT NULL</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#24292E;">        , SPID </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@spid&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;int&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , ProcedureName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;executionStack[1]/frame[1]/@procname[1]&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(200)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , LockMode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@lockMode&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;char(1)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , Code </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;executionStack[1]/frame[1]&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(1000)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , ClientApp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">LEFT</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@clientapp&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(100)&#39;</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">29</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;SQLAgent - TSQL JobStep (Job &#39;</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;SQLAgent Job: &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> msdb..sysjobs sj </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">substring</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@clientapp&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(100)&#39;</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">32</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">32</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">substring</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fn_varbintohexstr</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sj</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">job_id</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">))) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; - &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@clientapp&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(100)&#39;</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">67</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">len</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@clientapp&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(100)&#39;</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">67</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@clientapp&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(100)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        , HostName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@hostname&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(20)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , LoginName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@loginname&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(20)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , InputBuffer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;inputbuf[1]&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(1000)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> #Events e</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockGraph</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nodes</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;/event/data/value/deadlock/process-list/process&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> Deadlock(Process)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> Victims v </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">v</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">v</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">VictimID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@id&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(50)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">) X</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> DeadlockID </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> request_session_id spid, </span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(resource_associated_entity_id) tableName </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_tran_locks</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> resource_type </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;OBJECT &#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> request_session_id spid, </span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(resource_associated_entity_id) tableName </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_tran_locks</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> resource_type </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;OBJECT &#39;</span></span></code></pre></div><ul><li>或者</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--查看被锁表：</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">request_session_id spid,</span></span>
<span class="line"><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">resource_associated_entity_id</span></span>
<span class="line"><span style="color:#E1E4E8;">) tableName</span></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_tran_locks</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span></span>
<span class="line"><span style="color:#E1E4E8;">resource_type </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;OBJECT&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> request_session_id </span><span style="color:#F97583;">ASC</span></span>
<span class="line"><span style="color:#6A737D;">--spid 锁表进程 </span></span>
<span class="line"><span style="color:#6A737D;">--tableName 被锁表名</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--根据锁表进程查询相应进程互锁的SQL语句</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC INPUTBUFFER (spid)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--查看被锁表：</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">request_session_id spid,</span></span>
<span class="line"><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">resource_associated_entity_id</span></span>
<span class="line"><span style="color:#24292E;">) tableName</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_tran_locks</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span></span>
<span class="line"><span style="color:#24292E;">resource_type </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;OBJECT&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> request_session_id </span><span style="color:#D73A49;">ASC</span></span>
<span class="line"><span style="color:#6A737D;">--spid 锁表进程 </span></span>
<span class="line"><span style="color:#6A737D;">--tableName 被锁表名</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--根据锁表进程查询相应进程互锁的SQL语句</span></span>
<span class="line"><span style="color:#24292E;">DBCC INPUTBUFFER (spid)</span></span></code></pre></div><ul><li>或者</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">master</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.sysprocesses </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">dbid=</span><span style="color:#79B8FF;">db_id</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;db_name&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- kill</span></span>
<span class="line"><span style="color:#F97583;">KILL</span><span style="color:#E1E4E8;"> spid</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">master</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.sysprocesses </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">dbid=</span><span style="color:#005CC5;">db_id</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;db_name&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- kill</span></span>
<span class="line"><span style="color:#D73A49;">KILL</span><span style="color:#24292E;"> spid</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202502101023713.png" alt="image-20250210102324631"></p><h3 id="解锁语句" tabindex="-1">解锁语句 <a class="header-anchor" href="#解锁语句" aria-label="Permalink to &quot;解锁语句&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 解锁：</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span></span>
<span class="line"><span style="color:#E1E4E8;">@spid </span><span style="color:#F97583;">INT</span></span>
<span class="line"><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @spid </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">52</span><span style="color:#6A737D;">--锁表进程</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span></span>
<span class="line"><span style="color:#E1E4E8;">@SQL </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;kill &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;"> (@spid </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> (@SQL)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 解锁：</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span></span>
<span class="line"><span style="color:#24292E;">@spid </span><span style="color:#D73A49;">INT</span></span>
<span class="line"><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @spid </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">52</span><span style="color:#6A737D;">--锁表进程</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span></span>
<span class="line"><span style="color:#24292E;">@SQL </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;kill &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;"> (@spid </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> (@SQL)</span></span></code></pre></div><h3 id="生成解锁sql语句" tabindex="-1"><strong>生成解锁SQL语句</strong> <a class="header-anchor" href="#生成解锁sql语句" aria-label="Permalink to &quot;**生成解锁SQL语句**&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--生成解锁SQL</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#F97583;">DISTINCT</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;DECLARE @spid INT SET @spid = &#39;</span><span style="color:#E1E4E8;">,request_session_id,</span><span style="color:#9ECBFF;">&#39; DECLARE @SQL VARCHAR (1000) SET @SQL = &#39;&#39;kill &#39;&#39; + CAST (@spid AS VARCHAR) EXEC (@SQL);&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> s</span></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_tran_locks</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span></span>
<span class="line"><span style="color:#E1E4E8;">resource_type </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;OBJECT&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--spid 锁表进程 </span></span>
<span class="line"><span style="color:#6A737D;">--tableName 被锁表名</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--生成解锁SQL</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#D73A49;">DISTINCT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;DECLARE @spid INT SET @spid = &#39;</span><span style="color:#24292E;">,request_session_id,</span><span style="color:#032F62;">&#39; DECLARE @SQL VARCHAR (1000) SET @SQL = &#39;&#39;kill &#39;&#39; + CAST (@spid AS VARCHAR) EXEC (@SQL);&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> s</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_tran_locks</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span></span>
<span class="line"><span style="color:#24292E;">resource_type </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;OBJECT&#39;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">--spid 锁表进程 </span></span>
<span class="line"><span style="color:#6A737D;">--tableName 被锁表名</span></span></code></pre></div><h3 id="死锁trace-log" tabindex="-1">死锁trace Log <a class="header-anchor" href="#死锁trace-log" aria-label="Permalink to &quot;死锁trace Log&quot;">​</a></h3><p>SQL Server 跟死锁相关的Trace Flag是 1204 和 1222，两个Trace Flag的Scope都是global only，两者记录的信息基本相同，都会把造成死锁的两个事务、抢占的资源、死锁类型和命令记录下来。前者是以文本格式记录，后者是以XML格式记录的，可以同时打开这两个追踪标志，记录的数据都存储在错误日志（Error Log）中</p><p>微软的官方文档对这两个Trace Falg的定义是：</p><ul><li>1204：Returns the resources and types of locks participating in a deadlock and also the current command affected.</li><li>1222：Returns the resources and types of locks that are participating in a deadlock and also the current command affected, in an XML format that does not comply with any XSD schema</li></ul><h4 id="跟踪标志" tabindex="-1">跟踪标志 <a class="header-anchor" href="#跟踪标志" aria-label="Permalink to &quot;跟踪标志&quot;">​</a></h4><table><thead><tr><th>标志</th><th>描述</th></tr></thead><tbody><tr><td>3604</td><td>直接返回信息到 当前客户端；而不是 打印信息 到 错误日志文件</td></tr><tr><td>2588</td><td>显示隐藏的DBCC命令、以及提供帮助信息</td></tr><tr><td>-1</td><td>用作 traceon的最后一个参数。表示服务器范围有效；否则仅仅当前会话有效</td></tr><tr><td>1204</td><td>返回参与死锁的锁的资源和类型，以及受影响的当前命令</td></tr><tr><td>1222</td><td>返回参与死锁的锁的资源和类型，以及使用了不符合任何XSD架构的XML格式的受影响的当前命令（比1204更进一步，2005及以上版本可以使用）</td></tr><tr><td>3605</td><td>将DBCC的结果输出到错误日志</td></tr></tbody></table><h4 id="打开追踪标志" tabindex="-1">打开追踪标志 <a class="header-anchor" href="#打开追踪标志" aria-label="Permalink to &quot;打开追踪标志&quot;">​</a></h4><p><a href="https://learn.microsoft.com/zh-cn/sql/t-sql/database-console-commands/dbcc-traceon-trace-flags-transact-sql?view=sql-server-2017" target="_blank" rel="noreferrer">https://learn.microsoft.com/zh-cn/sql/t-sql/database-console-commands/dbcc-traceon-trace-flags-transact-sql?view=sql-server-2017</a></p><p><a href="https://learn.microsoft.com/en-us/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide?view=sql-server-2017#deadlocks" target="_blank" rel="noreferrer">https://learn.microsoft.com/en-us/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide?view=sql-server-2017#deadlocks</a></p><ul><li>查看状态</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">DBCC TRACESTATUS(</span><span style="color:#79B8FF;">1204</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1222</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- Status为0，表示当前这两个Trace Flag都处于OFF状态</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> 代表全局开启</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">DBCC TRACESTATUS(</span><span style="color:#005CC5;">1204</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1222</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- Status为0，表示当前这两个Trace Flag都处于OFF状态</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> 代表全局开启</span></span></code></pre></div><ul><li>开启</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">DBCC TRACEON(</span><span style="color:#79B8FF;">1204</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1222</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- Status为1，表示当前这两个Trace Flag都处于ON状态</span></span>
<span class="line"><span style="color:#6A737D;">-- 一旦系统检测到死锁，就会把死锁发生时的消息都记录到错误日志中</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">DBCC TRACEON(</span><span style="color:#005CC5;">1204</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1222</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- Status为1，表示当前这两个Trace Flag都处于ON状态</span></span>
<span class="line"><span style="color:#6A737D;">-- 一旦系统检测到死锁，就会把死锁发生时的消息都记录到错误日志中</span></span></code></pre></div><ul><li>关闭</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">DBCC TRACEOFF(</span><span style="color:#79B8FF;">1204</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1222</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">DBCC TRACEOFF(</span><span style="color:#005CC5;">1204</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1222</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span></code></pre></div><h2 id="_3-4查看表行数" tabindex="-1">3.4查看表行数 <a class="header-anchor" href="#_3-4查看表行数" aria-label="Permalink to &quot;3.4查看表行数&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 查看表名及行数</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> invitefriend</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">rows</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> sysobjects </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> sysindexes </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;u&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">rows</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 查看表名及行数</span></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> invitefriend</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">rows</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> sysobjects </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> sysindexes </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;u&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">rows</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141012584.jpg" alt=""></p><h2 id="_3-5查看某库中所有表" tabindex="-1">3.5查看某库中所有表 <a class="header-anchor" href="#_3-5查看某库中所有表" aria-label="Permalink to &quot;3.5查看某库中所有表&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">Select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> db_payment..SysObjects </span><span style="color:#F97583;">Where</span><span style="color:#E1E4E8;"> XType</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;U&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">orDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">Select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> db_payment..SysObjects </span><span style="color:#D73A49;">Where</span><span style="color:#24292E;"> XType</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;U&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">orDER BY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Name</span></span></code></pre></div><p>XType=‘U’ :表示所有用户表; XType=‘S’ :表示所有系统表;</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141012588.jpg" alt=""></p><h3 id="获取数据所有类型" tabindex="-1">获取数据所有类型 <a class="header-anchor" href="#获取数据所有类型" aria-label="Permalink to &quot;获取数据所有类型&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> hantest</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> systypes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> hantest</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> systypes</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141012886.jpg" alt=""></p><h2 id="_3-6表操作" tabindex="-1">3.6表操作 <a class="header-anchor" href="#_3-6表操作" aria-label="Permalink to &quot;3.6表操作&quot;">​</a></h2><h3 id="创建表" tabindex="-1">创建表 <a class="header-anchor" href="#创建表" aria-label="Permalink to &quot;创建表&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> dataName</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">DEPT</span></span>
<span class="line"><span style="color:#E1E4E8;">       (DEPTNO </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">primary key</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        DNAME </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">        LOC </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;">) );</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> dataName</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DEPT</span></span>
<span class="line"><span style="color:#24292E;">       (DEPTNO </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">primary key</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        DNAME </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">        LOC </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">13</span><span style="color:#24292E;">) );</span></span></code></pre></div><h3 id="插入数据" tabindex="-1">插入数据 <a class="header-anchor" href="#插入数据" aria-label="Permalink to &quot;插入数据&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> dataName</span></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> DEPT </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">101</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;ACCOUNTING&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;NEW YORK&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> DEPT </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">201</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;RESEARCH&#39;</span><span style="color:#E1E4E8;">,   </span><span style="color:#9ECBFF;">&#39;DALLAS&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> DEPT </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">301</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;SALES&#39;</span><span style="color:#E1E4E8;">,      </span><span style="color:#9ECBFF;">&#39;CHICAGO&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> DEPT </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">401</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;OPERATIONS&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;BOSTON&#39;</span><span style="color:#E1E4E8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> dataName</span></span>
<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> DEPT </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">101</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;ACCOUNTING&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;NEW YORK&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> DEPT </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">201</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;RESEARCH&#39;</span><span style="color:#24292E;">,   </span><span style="color:#032F62;">&#39;DALLAS&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> DEPT </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">301</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;SALES&#39;</span><span style="color:#24292E;">,      </span><span style="color:#032F62;">&#39;CHICAGO&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> DEPT </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">401</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;OPERATIONS&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;BOSTON&#39;</span><span style="color:#24292E;">);</span></span></code></pre></div><ul><li>或者</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> hantest</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">SALES</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span></span>
<span class="line"><span style="color:#E1E4E8;">      CUSTOMER_ID </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT NULL</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      ITEM_ID </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT NULL</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      SALE_QUANTITY </span><span style="color:#F97583;">SMALLINT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT NULL</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      SALE_DATE </span><span style="color:#F97583;">DATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">    );</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- insert</span></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> SALES</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">RAND</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">( </span><span style="color:#79B8FF;">NEWID</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varbinary</span><span style="color:#E1E4E8;"> )) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">900</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> CUSTOMER_ID</span></span>
<span class="line"><span style="color:#E1E4E8;">    , </span><span style="color:#79B8FF;">RAND</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">( </span><span style="color:#79B8FF;">NEWID</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varbinary</span><span style="color:#E1E4E8;"> )) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">500</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> ITEM_ID</span></span>
<span class="line"><span style="color:#E1E4E8;">    , </span><span style="color:#79B8FF;">RAND</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">( </span><span style="color:#79B8FF;">NEWID</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varbinary</span><span style="color:#E1E4E8;"> )) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> SALE_QUANTITY</span></span>
<span class="line"><span style="color:#E1E4E8;">    , </span><span style="color:#79B8FF;">DATEADD</span><span style="color:#E1E4E8;">(D, </span><span style="color:#79B8FF;">RAND</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">( </span><span style="color:#79B8FF;">NEWID</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varbinary</span><span style="color:#E1E4E8;"> )) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;2000/1/1&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;">  SALE_DATE</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">columns</span></span>
<span class="line"><span style="color:#F97583;">go</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> hantest</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">SALES</span></span>
<span class="line"><span style="color:#24292E;">    (</span></span>
<span class="line"><span style="color:#24292E;">      CUSTOMER_ID </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT NULL</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      ITEM_ID </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT NULL</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      SALE_QUANTITY </span><span style="color:#D73A49;">SMALLINT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT NULL</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      SALE_DATE </span><span style="color:#D73A49;">DATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT NULL</span></span>
<span class="line"><span style="color:#24292E;">    );</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- insert</span></span>
<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> SALES</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">RAND</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">( </span><span style="color:#005CC5;">NEWID</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varbinary</span><span style="color:#24292E;"> )) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">900</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> CUSTOMER_ID</span></span>
<span class="line"><span style="color:#24292E;">    , </span><span style="color:#005CC5;">RAND</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">( </span><span style="color:#005CC5;">NEWID</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varbinary</span><span style="color:#24292E;"> )) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">500</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> ITEM_ID</span></span>
<span class="line"><span style="color:#24292E;">    , </span><span style="color:#005CC5;">RAND</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">( </span><span style="color:#005CC5;">NEWID</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varbinary</span><span style="color:#24292E;"> )) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> SALE_QUANTITY</span></span>
<span class="line"><span style="color:#24292E;">    , </span><span style="color:#005CC5;">DATEADD</span><span style="color:#24292E;">(D, </span><span style="color:#005CC5;">RAND</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">( </span><span style="color:#005CC5;">NEWID</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varbinary</span><span style="color:#24292E;"> )) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;2000/1/1&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;">  SALE_DATE</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">columns</span></span>
<span class="line"><span style="color:#D73A49;">go</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span></code></pre></div><h3 id="查询当前数据库下所有用户表" tabindex="-1">查询当前数据库下所有用户表 <a class="header-anchor" href="#查询当前数据库下所有用户表" aria-label="Permalink to &quot;查询当前数据库下所有用户表&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> sysobjects </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> xtype</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;u&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 或者</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tables</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> sysobjects </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> xtype</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;u&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 或者</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tables</span></span></code></pre></div><p><a href="https://www.xin3721.com/Articletsql/sql28477.html" target="_blank" rel="noreferrer">https://www.xin3721.com/Articletsql/sql28477.html</a></p><h3 id="查看表结构" tabindex="-1">查看表结构 <a class="header-anchor" href="#查看表结构" aria-label="Permalink to &quot;查看表结构&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> db_name</span></span>
<span class="line"><span style="color:#E1E4E8;">sp_help table_name;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看列</span></span>
<span class="line"><span style="color:#E1E4E8;">sp_columns table_name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> db_name</span></span>
<span class="line"><span style="color:#24292E;">sp_help table_name;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看列</span></span>
<span class="line"><span style="color:#24292E;">sp_columns table_name</span></span></code></pre></div><ul><li>或者</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  表名 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">colorder</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        字段说明 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ISNULL</span><span style="color:#E1E4E8;">(g.[value], </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        字段名 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        类型 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> ( </span><span style="color:#9ECBFF;">&#39;varchar&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;nvarchar&#39;</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;(&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                       </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">COLUMNPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;PRECISION&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">                       </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;)&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;decimal&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;(&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                       </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">COLUMNPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;PRECISION&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">                       </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;,&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                       </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">COLUMNPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;Scale&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">                       </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;)&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> syscolumns a    </span><span style="color:#6A737D;">-- 列名</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> systypes b </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xusertype</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xusertype</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- 类型</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> sysobjects d </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xtype</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;U&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;dtproperties&#39;</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--筛选用户对象</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--LEFT JOIN syscomments e ON a.cdefault = e.id    --默认值</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">extended_properties</span><span style="color:#E1E4E8;"> g </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">g</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">major_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">colid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">g</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">minor_id</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--扩展属性(字段说明)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--LEFT JOIN sys.extended_properties f ON d.id = f.major_id AND f.minor_id = 0        --扩展属性(表说明)</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;table_name&#39;</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--可修改表名</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;"> , </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">colorder</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  表名 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">colorder</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        字段说明 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ISNULL</span><span style="color:#24292E;">(g.[value], </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">        字段名 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        类型 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> ( </span><span style="color:#032F62;">&#39;varchar&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;nvarchar&#39;</span><span style="color:#24292E;"> )</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;(&#39;</span></span>
<span class="line"><span style="color:#24292E;">                       </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">COLUMNPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;PRECISION&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">                       </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;)&#39;</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;decimal&#39;</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;(&#39;</span></span>
<span class="line"><span style="color:#24292E;">                       </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">COLUMNPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;PRECISION&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">                       </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;,&#39;</span></span>
<span class="line"><span style="color:#24292E;">                       </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">COLUMNPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;Scale&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">                       </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;)&#39;</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> syscolumns a    </span><span style="color:#6A737D;">-- 列名</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> systypes b </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xusertype</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xusertype</span><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- 类型</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> sysobjects d </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xtype</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;U&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;dtproperties&#39;</span><span style="color:#24292E;">    </span><span style="color:#6A737D;">--筛选用户对象</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--LEFT JOIN syscomments e ON a.cdefault = e.id    --默认值</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">extended_properties</span><span style="color:#24292E;"> g </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">g</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">major_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">colid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">g</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">minor_id</span><span style="color:#24292E;">    </span><span style="color:#6A737D;">--扩展属性(字段说明)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--LEFT JOIN sys.extended_properties f ON d.id = f.major_id AND f.minor_id = 0        --扩展属性(表说明)</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;table_name&#39;</span><span style="color:#24292E;">    </span><span style="color:#6A737D;">--可修改表名</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;"> , </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">colorder</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141012612.jpg" alt=""></p><h3 id="复制表结构" tabindex="-1">复制表结构 <a class="header-anchor" href="#复制表结构" aria-label="Permalink to &quot;复制表结构&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> dbname</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">top</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Into</span><span style="color:#E1E4E8;"> newTable  </span><span style="color:#F97583;">From</span><span style="color:#E1E4E8;"> sourceTable</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> dbname</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">top</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Into</span><span style="color:#24292E;"> newTable  </span><span style="color:#D73A49;">From</span><span style="color:#24292E;"> sourceTable</span></span></code></pre></div><h3 id="查询数据插入到临时表" tabindex="-1">查询数据插入到临时表 <a class="header-anchor" href="#查询数据插入到临时表" aria-label="Permalink to &quot;查询数据插入到临时表&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 把 test_table 的 100 条数据放到临时表 tmp_table 里</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">top</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">into</span><span style="color:#E1E4E8;"> #tmp_table </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> test_table;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 把 test_table 的 100 条数据放到临时表 tmp_table 里</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">top</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">into</span><span style="color:#24292E;"> #tmp_table </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> test_table;</span></span></code></pre></div><h3 id="插入到一个不存在的表" tabindex="-1">插入到一个不存在的表 <a class="header-anchor" href="#插入到一个不存在的表" aria-label="Permalink to &quot;插入到一个不存在的表&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 把 表 test_table 的数据放到一个现创的 new_table 里</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">into</span><span style="color:#E1E4E8;"> new_table </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;">  test_table ;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 把 表 test_table 的数据放到一个现创的 new_table 里</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">into</span><span style="color:#24292E;"> new_table </span><span style="color:#D73A49;">from</span><span style="color:#24292E;">  test_table ;</span></span></code></pre></div><h3 id="插入到一个已经存在的数据表" tabindex="-1">插入到一个已经存在的数据表 <a class="header-anchor" href="#插入到一个已经存在的数据表" aria-label="Permalink to &quot;插入到一个已经存在的数据表&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 把 test_01 的数据都放到 test_02 表里</span></span>
<span class="line"><span style="color:#F97583;">insert into</span><span style="color:#E1E4E8;">  test_02  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;">  test_01 ;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 把 test_01 的数据都放到 test_02 表里</span></span>
<span class="line"><span style="color:#D73A49;">insert into</span><span style="color:#24292E;">  test_02  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;">  test_01 ;</span></span></code></pre></div><h3 id="修改表名字" tabindex="-1">修改表名字 <a class="header-anchor" href="#修改表名字" aria-label="Permalink to &quot;修改表名字&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--修改表名</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_rename  </span><span style="color:#9ECBFF;">&#39;旧表名&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;新表名&#39;</span></span>
<span class="line"><span style="color:#6A737D;">-- 修改列名</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_rename </span><span style="color:#9ECBFF;">&#39;表名.[旧列名]&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;新列名&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;COLUMN&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--修改表名</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_rename  </span><span style="color:#032F62;">&#39;旧表名&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;新表名&#39;</span></span>
<span class="line"><span style="color:#6A737D;">-- 修改列名</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_rename </span><span style="color:#032F62;">&#39;表名.[旧列名]&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;新列名&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;COLUMN&#39;</span></span></code></pre></div><h2 id="_3-7删除表" tabindex="-1">3.7删除表 <a class="header-anchor" href="#_3-7删除表" aria-label="Permalink to &quot;3.7删除表&quot;">​</a></h2><h3 id="批量删除" tabindex="-1">批量删除 <a class="header-anchor" href="#批量删除" aria-label="Permalink to &quot;批量删除&quot;">​</a></h3><p>1、delete操作会被完整记录到日志里，它需要大量空间和时间</p><p>2、如果删除中间发生中断，一切删除会回滚（在一个事务里）</p><p>3、同时删除多行，记录上的锁也许会被提升为排它表锁，从而阻碍操作完成之前有对这个表的操作（有时候会妨碍正常的业务）所以一般采取分批删除的方法</p><p>所以，通过分批次地删除数据可以大大提升删除效率，缩短删除时间：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @perCount </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @perCount </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6000</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#F97583;">begin</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">top</span><span style="color:#E1E4E8;">(@perCount) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> 表 </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> CrtDate </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2020-12-23&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;">(@@rowcount</span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">@perCount) </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @perCount </span><span style="color:#D73A49;">int</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @perCount </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6000</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#D73A49;">begin</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">delete</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">top</span><span style="color:#24292E;">(@perCount) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> 表 </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> CrtDate </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2020-12-23&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(@@rowcount</span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">@perCount) </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><h3 id="delete、truncate、drop区别" tabindex="-1">delete、truncate、drop区别 <a class="header-anchor" href="#delete、truncate、drop区别" aria-label="Permalink to &quot;delete、truncate、drop区别&quot;">​</a></h3><p><code>应用范围：truncate只能对table，delete可以是table和view</code></p><h4 id="drop" tabindex="-1">drop <a class="header-anchor" href="#drop" aria-label="Permalink to &quot;drop&quot;">​</a></h4><p>*删除内容和定义，释放空间。*简单来说就是把整个表去掉.以后要新增数据是不可能的,除非新增一个表,</p><p>​ 例如:一个班就是一个表,学生就是表中的数据,学生的职务就是定义</p><p>​ drop table class,就是把整个班移除.学生和职务都消失</p><h4 id="truncate" tabindex="-1">truncate <a class="header-anchor" href="#truncate" aria-label="Permalink to &quot;truncate&quot;">​</a></h4><p>绝招:<em>删除内容、释放空间但不删除定义</em>。与drop不同的是,他只是清空表数据而已,他比较温柔.并且能针对具有自动递增值的字段，做计数重置归零重新计算的作用</p><p>​ 同样也是一个班,他只去除所有的学生.班还在,职务还在,如果有新增的学生可以进去,也可以分配上职务</p><p>删除内容很容易理解,不删除定义也很容易理解,就是保留表的数据结构</p><p>==delete过行数据,所以会出现标识列不连续(体现了delete删除是不释放空间的)==</p><p>==truncate删除是释放空间==</p><blockquote><p>1、truncate 在各种表上无论是大的还是小的都非常快。如果有ROLLBACK命令Delete将被撤销，而 truncate 则不会被撤销。 2、truncate 是一个DDL语言，向其他所有的DDL语言一样，他将被隐式提交，不能对 truncate 使用ROLLBACK命令。 3、truncate 将重新设置高水平线和所有的索引。在对整个表和索引进行完全浏览时，经过 truncate 操作后的表比Delete操作后的表要快得多。 4、truncate 不能触发任何Delete触发器。 5、当表被清空后表和表的索引讲重新设置成初始大小，而delete则不能。 6、不能清空父表</p></blockquote><h4 id="delete" tabindex="-1">delete <a class="header-anchor" href="#delete" aria-label="Permalink to &quot;delete&quot;">​</a></h4><p><a href="https://learn.microsoft.com/zh-cn/sql/t-sql/statements/delete-transact-sql?view=sql-server-2017" target="_blank" rel="noreferrer">https://learn.microsoft.com/zh-cn/sql/t-sql/statements/delete-transact-sql?view=sql-server-2017</a></p><p><em>删除内容不删除定义</em></p><p>truncate 比 delete速度快，且使用的系统和事务日志资源少。</p><p>delete 语句每次删除一行，并在事务日志中为所删除的每行记录一项。所以可以对delete操作进行roll back</p><ul><li>语法</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- Syntax for SQL Server and Azure SQL Database  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">[ WITH &lt;common_table_expression&gt; [ ,...n ] ]  </span></span>
<span class="line"><span style="color:#F97583;">DELETE</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    [ TOP ( expression ) [ PERCENT ] ]   </span></span>
<span class="line"><span style="color:#E1E4E8;">    [ FROM ]   </span></span>
<span class="line"><span style="color:#E1E4E8;">    { { table_alias  </span></span>
<span class="line"><span style="color:#E1E4E8;">      | </span><span style="color:#F97583;">&lt;object&gt;</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">      | rowset_function_limited   </span></span>
<span class="line"><span style="color:#E1E4E8;">      [ WITH ( table_hint_limited [ ...n ] ) ] }   </span></span>
<span class="line"><span style="color:#E1E4E8;">      | @table_variable  </span></span>
<span class="line"><span style="color:#E1E4E8;">    }  </span></span>
<span class="line"><span style="color:#E1E4E8;">    [ &lt;OUTPUT Clause&gt; ]  </span></span>
<span class="line"><span style="color:#E1E4E8;">    [ FROM table_source [ ,...n ] ]   </span></span>
<span class="line"><span style="color:#E1E4E8;">    [ </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> { </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">search_condition</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">            | { [ CURRENT OF   </span></span>
<span class="line"><span style="color:#E1E4E8;">                   { { [ GLOBAL ] cursor_name }   </span></span>
<span class="line"><span style="color:#E1E4E8;">                       | cursor_variable_name   </span></span>
<span class="line"><span style="color:#E1E4E8;">                   }   </span></span>
<span class="line"><span style="color:#E1E4E8;">                ]  </span></span>
<span class="line"><span style="color:#E1E4E8;">              }  </span></span>
<span class="line"><span style="color:#E1E4E8;">            }   </span></span>
<span class="line"><span style="color:#E1E4E8;">    ]   </span></span>
<span class="line"><span style="color:#E1E4E8;">    [ OPTION ( &lt;Query Hint&gt; [ ,...n ] ) ]   </span></span>
<span class="line"><span style="color:#E1E4E8;">[; ]  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">&lt;object&gt;</span><span style="color:#E1E4E8;"> ::</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">{   </span></span>
<span class="line"><span style="color:#E1E4E8;">    [ </span><span style="color:#79B8FF;">server_name</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_name</span><span style="color:#E1E4E8;">.schema_name.   </span></span>
<span class="line"><span style="color:#E1E4E8;">      | </span><span style="color:#F97583;">database_name</span><span style="color:#E1E4E8;">. [ schema_name ] .   </span></span>
<span class="line"><span style="color:#E1E4E8;">      | schema_name.  </span></span>
<span class="line"><span style="color:#E1E4E8;">    ]  </span></span>
<span class="line"><span style="color:#E1E4E8;">    table_or_view_name   </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- Syntax for SQL Server and Azure SQL Database  </span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">[ WITH &lt;common_table_expression&gt; [ ,...n ] ]  </span></span>
<span class="line"><span style="color:#D73A49;">DELETE</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    [ TOP ( expression ) [ PERCENT ] ]   </span></span>
<span class="line"><span style="color:#24292E;">    [ FROM ]   </span></span>
<span class="line"><span style="color:#24292E;">    { { table_alias  </span></span>
<span class="line"><span style="color:#24292E;">      | </span><span style="color:#D73A49;">&lt;object&gt;</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">      | rowset_function_limited   </span></span>
<span class="line"><span style="color:#24292E;">      [ WITH ( table_hint_limited [ ...n ] ) ] }   </span></span>
<span class="line"><span style="color:#24292E;">      | @table_variable  </span></span>
<span class="line"><span style="color:#24292E;">    }  </span></span>
<span class="line"><span style="color:#24292E;">    [ &lt;OUTPUT Clause&gt; ]  </span></span>
<span class="line"><span style="color:#24292E;">    [ FROM table_source [ ,...n ] ]   </span></span>
<span class="line"><span style="color:#24292E;">    [ </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> { </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">search_condition</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">            | { [ CURRENT OF   </span></span>
<span class="line"><span style="color:#24292E;">                   { { [ GLOBAL ] cursor_name }   </span></span>
<span class="line"><span style="color:#24292E;">                       | cursor_variable_name   </span></span>
<span class="line"><span style="color:#24292E;">                   }   </span></span>
<span class="line"><span style="color:#24292E;">                ]  </span></span>
<span class="line"><span style="color:#24292E;">              }  </span></span>
<span class="line"><span style="color:#24292E;">            }   </span></span>
<span class="line"><span style="color:#24292E;">    ]   </span></span>
<span class="line"><span style="color:#24292E;">    [ OPTION ( &lt;Query Hint&gt; [ ,...n ] ) ]   </span></span>
<span class="line"><span style="color:#24292E;">[; ]  </span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">&lt;object&gt;</span><span style="color:#24292E;"> ::</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">{   </span></span>
<span class="line"><span style="color:#24292E;">    [ </span><span style="color:#005CC5;">server_name</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_name</span><span style="color:#24292E;">.schema_name.   </span></span>
<span class="line"><span style="color:#24292E;">      | </span><span style="color:#D73A49;">database_name</span><span style="color:#24292E;">. [ schema_name ] .   </span></span>
<span class="line"><span style="color:#24292E;">      | schema_name.  </span></span>
<span class="line"><span style="color:#24292E;">    ]  </span></span>
<span class="line"><span style="color:#24292E;">    table_or_view_name   </span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h5 id="删除表中所有数据" tabindex="-1">删除表中所有数据 <a class="header-anchor" href="#删除表中所有数据" aria-label="Permalink to &quot;删除表中所有数据&quot;">​</a></h5><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">语法：</span><span style="color:#F97583;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">数据库名</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.表名;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">示例：</span><span style="color:#F97583;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">testss</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.test1;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">语法：</span><span style="color:#D73A49;">delete</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">数据库名</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.表名;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">示例：</span><span style="color:#D73A49;">delete</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">testss</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.test1;</span></span></code></pre></div><h5 id="删除单表中重复数据" tabindex="-1">删除单表中重复数据 <a class="header-anchor" href="#删除单表中重复数据" aria-label="Permalink to &quot;删除单表中重复数据&quot;">​</a></h5><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">语法：delete a from 表 as a left join 表 as b on a.列=b.列 where a.列&gt;b.列;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">示例：delete a from test1 as a left join test1 as b on a.name=b.name where a.id&gt;b.id;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">语法：delete a from 表 as a left join 表 as b on a.列=b.列 where a.列&gt;b.列;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">示例：delete a from test1 as a left join test1 as b on a.name=b.name where a.id&gt;b.id;</span></span></code></pre></div><h5 id="删除单表多行数据" tabindex="-1">删除单表多行数据 <a class="header-anchor" href="#删除单表多行数据" aria-label="Permalink to &quot;删除单表多行数据&quot;">​</a></h5><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">语法：</span><span style="color:#F97583;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">数据库名</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.表名 </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> 条件或者delete </span><span style="color:#F97583;">top</span><span style="color:#E1E4E8;">(n) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">数据库名</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.表名 </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> 条件;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">示例：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">testss</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.test1 </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> id</span><span style="color:#F97583;">&gt;=</span><span style="color:#9ECBFF;">&#39;14&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> id</span><span style="color:#F97583;">&lt;=</span><span style="color:#9ECBFF;">&#39;15&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">testss</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.test1 </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> id </span><span style="color:#F97583;">between</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;16&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;17&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">testss</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.test1 </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> id </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;18&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;19&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">top</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">testss</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.test1 </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> id</span><span style="color:#F97583;">&gt;=</span><span style="color:#9ECBFF;">&#39;20&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">语法：</span><span style="color:#D73A49;">delete</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">数据库名</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.表名 </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> 条件或者delete </span><span style="color:#D73A49;">top</span><span style="color:#24292E;">(n) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">数据库名</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.表名 </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> 条件;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">示例：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">delete</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">testss</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.test1 </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> id</span><span style="color:#D73A49;">&gt;=</span><span style="color:#032F62;">&#39;14&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> id</span><span style="color:#D73A49;">&lt;=</span><span style="color:#032F62;">&#39;15&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">delete</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">testss</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.test1 </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> id </span><span style="color:#D73A49;">between</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;16&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;17&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">delete</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">testss</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.test1 </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> id </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;18&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;19&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">delete</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">top</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">testss</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.test1 </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> id</span><span style="color:#D73A49;">&gt;=</span><span style="color:#032F62;">&#39;20&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h5 id="删除单表单行数据" tabindex="-1">删除单表单行数据 <a class="header-anchor" href="#删除单表单行数据" aria-label="Permalink to &quot;删除单表单行数据&quot;">​</a></h5><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">语法：</span><span style="color:#F97583;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">数据库名</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.表名 </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> 条件;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">示例：</span><span style="color:#F97583;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">testss</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.test1 </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> id</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;12&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">语法：</span><span style="color:#D73A49;">delete</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">数据库名</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.表名 </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> 条件;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">示例：</span><span style="color:#D73A49;">delete</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">testss</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.test1 </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> id</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;12&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h5 id="表保留10天数据" tabindex="-1">表保留10天数据 <a class="header-anchor" href="#表保留10天数据" aria-label="Permalink to &quot;表保留10天数据&quot;">​</a></h5><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark has-diff vp-code-dark"><code><span class="line"><span style="color:#F97583;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> 表名 </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">datediff</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">day</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">cast</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">([TIME], </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">datetime</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">getdate</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span></code></pre><pre class="shiki github-light has-diff vp-code-light"><code><span class="line"><span style="color:#D73A49;">delete</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> 表名 </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">datediff</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">day</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">cast</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">([TIME], </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">datetime</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">getdate</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span></code></pre></div><h2 id="查看被删除的数据" tabindex="-1">查看被删除的数据 <a class="header-anchor" href="#查看被删除的数据" aria-label="Permalink to &quot;查看被删除的数据&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> ID,New_ID,(New_ID </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> ID </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;存在的间隔数量&#39;</span><span style="color:#E1E4E8;">,ID</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;被删除的行ID&#39;</span></span>
<span class="line"><span style="color:#F97583;">from</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> ID,New_ID</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">min</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">ID</span><span style="color:#E1E4E8;">) id</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> dept b</span></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> dept a</span></span>
<span class="line"><span style="color:#E1E4E8;">) c</span></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> ID</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> New_ID</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> ID,New_ID,(New_ID </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> ID </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;存在的间隔数量&#39;</span><span style="color:#24292E;">,ID</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;被删除的行ID&#39;</span></span>
<span class="line"><span style="color:#D73A49;">from</span></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> ID,New_ID</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">min</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">ID</span><span style="color:#24292E;">) id</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> dept b</span></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> dept a</span></span>
<span class="line"><span style="color:#24292E;">) c</span></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> ID</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> New_ID</span></span></code></pre></div><h2 id="_4-删除sqlserver系统日志" tabindex="-1">4.删除sqlserver系统日志 <a class="header-anchor" href="#_4-删除sqlserver系统日志" aria-label="Permalink to &quot;4.删除sqlserver系统日志&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">#不用重启实例</span></span>
<span class="line"><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_cycle_errorlog</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">#不用重启实例</span></span>
<span class="line"><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_cycle_errorlog</span></span></code></pre></div><p><a href="https://www.xin3721.com/Articletsql/list198.html" target="_blank" rel="noreferrer">https://www.xin3721.com/Articletsql/list198.html</a></p><h2 id="_5-索引" tabindex="-1">5.索引 <a class="header-anchor" href="#_5-索引" aria-label="Permalink to &quot;5.索引&quot;">​</a></h2><h3 id="_5-1查看索引" tabindex="-1">5.1查看索引 <a class="header-anchor" href="#_5-1查看索引" aria-label="Permalink to &quot;5.1查看索引&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> db_name</span></span>
<span class="line"><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_helpindex </span><span style="color:#9ECBFF;">&#39;table_name&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> db_name</span></span>
<span class="line"><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_helpindex </span><span style="color:#032F62;">&#39;table_name&#39;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141012251.jpg" alt=""></p><blockquote><p>​ index_name:指定索引名称.</p><p>index_description:包含索引的描述信息，例如唯一性索引，聚集索引等。</p><p>index_keys:包含了索引所在表中的列.</p></blockquote><ul><li>或者利用系统表</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">TableId</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">O.[object_id],</span></span>
<span class="line"><span style="color:#E1E4E8;">TableName</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">O</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Name</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">IndexId</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">ISNULL</span><span style="color:#E1E4E8;">(KC.[object_id],</span><span style="color:#79B8FF;">IDX</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">IndexName</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">IDX</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Name</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">IndexType</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">ISNULL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">KC</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type_desc</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;Index&#39;</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">Index_Column_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">IDXC</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_column_id</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">ColumnID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">C</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Column_id</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">ColumnName</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">C</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Name</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">Sort</span><span style="color:#F97583;">=CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">INDEXKEY_PROPERTY</span><span style="color:#E1E4E8;">(IDXC.[object_id],</span><span style="color:#79B8FF;">IDXC</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">IDXC</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_column_id</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;IsDescending&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;DESC&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ASC&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">PrimaryKey</span><span style="color:#F97583;">=CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">IDX</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_primary_key</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;√&#39;</span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[UQIQUE]</span><span style="color:#F97583;">=CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">IDX</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_unique</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;√&#39;</span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#F97583;">Ignore_dup_key=CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">IDX</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">ignore_dup_key</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;√&#39;</span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#F97583;">Disabled=CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">IDX</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_disabled</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;√&#39;</span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">Fill_factor</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">IDX</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fill_factor</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">Padded</span><span style="color:#F97583;">=CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">IDX</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_padded</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;√&#39;</span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> IDX </span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_columns</span><span style="color:#E1E4E8;"> IDXC</span></span>
<span class="line"><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> IDX.[object_id]</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">IDXC.[object_id]</span></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">IDX</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">IDXC</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">key_constraints</span><span style="color:#E1E4E8;"> KC</span></span>
<span class="line"><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> IDX.[object_id]</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">KC.[parent_object_id]</span></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">IDX</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">KC</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">unique_index_id</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objects</span><span style="color:#E1E4E8;"> O</span></span>
<span class="line"><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> O.[object_id]</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">IDX.[object_id]</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">columns</span><span style="color:#E1E4E8;"> C</span></span>
<span class="line"><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> O.[object_id]</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">C.[object_id]</span></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">O</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;U&#39;</span></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">O</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_ms_shipped</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">IDXC</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Column_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">C</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Column_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">O</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;FundAccountMoney&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--cz201是你要查询的表</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">TableId</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">O.[object_id],</span></span>
<span class="line"><span style="color:#24292E;">TableName</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">O</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Name</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">IndexId</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">ISNULL</span><span style="color:#24292E;">(KC.[object_id],</span><span style="color:#005CC5;">IDX</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">IndexName</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">IDX</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Name</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">IndexType</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">ISNULL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">KC</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type_desc</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;Index&#39;</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">Index_Column_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">IDXC</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_column_id</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">ColumnID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">C</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Column_id</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">ColumnName</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">C</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Name</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">Sort</span><span style="color:#D73A49;">=CASE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">INDEXKEY_PROPERTY</span><span style="color:#24292E;">(IDXC.[object_id],</span><span style="color:#005CC5;">IDXC</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">IDXC</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_column_id</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;IsDescending&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;DESC&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ASC&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">PrimaryKey</span><span style="color:#D73A49;">=CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">IDX</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_primary_key</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;√&#39;</span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[UQIQUE]</span><span style="color:#D73A49;">=CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">IDX</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_unique</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;√&#39;</span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#D73A49;">Ignore_dup_key=CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">IDX</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">ignore_dup_key</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;√&#39;</span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#D73A49;">Disabled=CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">IDX</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_disabled</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;√&#39;</span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">Fill_factor</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">IDX</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fill_factor</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">Padded</span><span style="color:#D73A49;">=CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">IDX</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_padded</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;√&#39;</span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> IDX </span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_columns</span><span style="color:#24292E;"> IDXC</span></span>
<span class="line"><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> IDX.[object_id]</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">IDXC.[object_id]</span></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">IDX</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">IDXC</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">key_constraints</span><span style="color:#24292E;"> KC</span></span>
<span class="line"><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> IDX.[object_id]</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">KC.[parent_object_id]</span></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">IDX</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">KC</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">unique_index_id</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objects</span><span style="color:#24292E;"> O</span></span>
<span class="line"><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> O.[object_id]</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">IDX.[object_id]</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">columns</span><span style="color:#24292E;"> C</span></span>
<span class="line"><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> O.[object_id]</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">C.[object_id]</span></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">O</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;U&#39;</span></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">O</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_ms_shipped</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">IDXC</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Column_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">C</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Column_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">O</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;FundAccountMoney&#39;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">--cz201是你要查询的表</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141012444.jpg" alt=""></p><ul><li>或者</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> t.[type] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;U&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">&#39;表&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> t.[type] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;V&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">&#39;视图&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;类型&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">SCHEMA_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schema_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> t.[name] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;(表/视图)名称&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">       i.[name] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> 索引名称,</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(column_names, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">LEN</span><span style="color:#E1E4E8;">(column_names) </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;列名&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">CASE</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> i.[type] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">&#39;聚集索引&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> i.[type] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">&#39;非聚集索引&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> i.[type] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">&#39;XML索引&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> i.[type] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">&#39;空间索引&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> i.[type] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">&#39;聚簇列存储索引&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> i.[type] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">&#39;非聚集列存储索引&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> i.[type] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">&#39;非聚集哈希索引&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;索引类型&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">CASE</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_unique</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">&#39;唯一&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">ELSE</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">&#39;不唯一&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;索引是否唯一&#39;</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objects</span><span style="color:#E1E4E8;"> t</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> i</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> col.[name] </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;, &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_columns</span><span style="color:#E1E4E8;"> ic</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">columns</span><span style="color:#E1E4E8;"> col</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ic</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">col</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ic</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">column_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">col</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">column_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ic</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ic</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">col</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">column_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PATH</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">) D(column_names)</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_ms_shipped</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> index_id </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;table_name&#39;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">-- 修改表名字</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> i.[name];</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> t.[type] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;U&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#032F62;">&#39;表&#39;</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> t.[type] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;V&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#032F62;">&#39;视图&#39;</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;类型&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#005CC5;">SCHEMA_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schema_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> t.[name] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;(表/视图)名称&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">       i.[name] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> 索引名称,</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(column_names, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">LEN</span><span style="color:#24292E;">(column_names) </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;列名&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">CASE</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> i.[type] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#032F62;">&#39;聚集索引&#39;</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> i.[type] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#032F62;">&#39;非聚集索引&#39;</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> i.[type] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#032F62;">&#39;XML索引&#39;</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> i.[type] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#032F62;">&#39;空间索引&#39;</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> i.[type] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#032F62;">&#39;聚簇列存储索引&#39;</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> i.[type] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#032F62;">&#39;非聚集列存储索引&#39;</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> i.[type] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#032F62;">&#39;非聚集哈希索引&#39;</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;索引类型&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">CASE</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_unique</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#032F62;">&#39;唯一&#39;</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">ELSE</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#032F62;">&#39;不唯一&#39;</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;索引是否唯一&#39;</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objects</span><span style="color:#24292E;"> t</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> i</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> col.[name] </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;, &#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_columns</span><span style="color:#24292E;"> ic</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">columns</span><span style="color:#24292E;"> col</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ic</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">col</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ic</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">column_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">col</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">column_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ic</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ic</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">col</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">column_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PATH</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">) D(column_names)</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_ms_shipped</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> index_id </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;table_name&#39;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">-- 修改表名字</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> i.[name];</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141012721.jpg" alt=""></p><ul><li>或者</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">OBJECT_SCHEMA_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">ind</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> SchemaName</span></span>
<span class="line"><span style="color:#E1E4E8;">      , </span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">ind</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> ObjectName</span></span>
<span class="line"><span style="color:#E1E4E8;">      , </span><span style="color:#79B8FF;">ind</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> IndexName</span></span>
<span class="line"><span style="color:#E1E4E8;">      , </span><span style="color:#79B8FF;">ind</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_primary_key</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> IsPrimaryKey</span></span>
<span class="line"><span style="color:#E1E4E8;">      , </span><span style="color:#79B8FF;">ind</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_unique</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> IsUniqueIndex</span></span>
<span class="line"><span style="color:#E1E4E8;">      , </span><span style="color:#79B8FF;">col</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> ColumnName</span></span>
<span class="line"><span style="color:#E1E4E8;">      , </span><span style="color:#79B8FF;">ic</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_included_column</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> IsIncludedColumn</span></span>
<span class="line"><span style="color:#E1E4E8;">      , </span><span style="color:#79B8FF;">ic</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">key_ordinal</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> ColumnOrder</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> ind</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_columns</span><span style="color:#E1E4E8;"> ic</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ind</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ic</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ind</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ic</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">columns</span><span style="color:#E1E4E8;"> col</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ic</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">col</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ic</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">column_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">col</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">column_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tables</span><span style="color:#E1E4E8;"> t</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ind</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_ms_shipped</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_SCHEMA_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">ind</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">--SchemaName</span></span>
<span class="line"><span style="color:#E1E4E8;">      , </span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">ind</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">--ObjectName</span></span>
<span class="line"><span style="color:#E1E4E8;">      , </span><span style="color:#79B8FF;">ind</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_primary_key</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DESC</span></span>
<span class="line"><span style="color:#E1E4E8;">      , </span><span style="color:#79B8FF;">ind</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_unique</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DESC</span></span>
<span class="line"><span style="color:#E1E4E8;">      , </span><span style="color:#79B8FF;">ind</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--IndexName</span></span>
<span class="line"><span style="color:#E1E4E8;">      , </span><span style="color:#79B8FF;">ic</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">key_ordinal</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">OBJECT_SCHEMA_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">ind</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> SchemaName</span></span>
<span class="line"><span style="color:#24292E;">      , </span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">ind</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> ObjectName</span></span>
<span class="line"><span style="color:#24292E;">      , </span><span style="color:#005CC5;">ind</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> IndexName</span></span>
<span class="line"><span style="color:#24292E;">      , </span><span style="color:#005CC5;">ind</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_primary_key</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> IsPrimaryKey</span></span>
<span class="line"><span style="color:#24292E;">      , </span><span style="color:#005CC5;">ind</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_unique</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> IsUniqueIndex</span></span>
<span class="line"><span style="color:#24292E;">      , </span><span style="color:#005CC5;">col</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> ColumnName</span></span>
<span class="line"><span style="color:#24292E;">      , </span><span style="color:#005CC5;">ic</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_included_column</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> IsIncludedColumn</span></span>
<span class="line"><span style="color:#24292E;">      , </span><span style="color:#005CC5;">ic</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">key_ordinal</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> ColumnOrder</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> ind</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_columns</span><span style="color:#24292E;"> ic</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ind</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ic</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ind</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ic</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">columns</span><span style="color:#24292E;"> col</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ic</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">col</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ic</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">column_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">col</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">column_id</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tables</span><span style="color:#24292E;"> t</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ind</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_ms_shipped</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_SCHEMA_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">ind</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">--SchemaName</span></span>
<span class="line"><span style="color:#24292E;">      , </span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">ind</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">--ObjectName</span></span>
<span class="line"><span style="color:#24292E;">      , </span><span style="color:#005CC5;">ind</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_primary_key</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DESC</span></span>
<span class="line"><span style="color:#24292E;">      , </span><span style="color:#005CC5;">ind</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_unique</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DESC</span></span>
<span class="line"><span style="color:#24292E;">      , </span><span style="color:#005CC5;">ind</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">--IndexName</span></span>
<span class="line"><span style="color:#24292E;">      , </span><span style="color:#005CC5;">ic</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">key_ordinal</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141012609.jpg" alt=""></p><h3 id="_5-2创建" tabindex="-1">5.2创建 <a class="header-anchor" href="#_5-2创建" aria-label="Permalink to &quot;5.2创建&quot;">​</a></h3><h3 id="_5-3修改" tabindex="-1">5.3修改 <a class="header-anchor" href="#_5-3修改" aria-label="Permalink to &quot;5.3修改&quot;">​</a></h3><h3 id="_5-4删除" tabindex="-1">5.4删除 <a class="header-anchor" href="#_5-4删除" aria-label="Permalink to &quot;5.4删除&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">drop</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> 索引名称 </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> 表名</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">drop</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> 索引名称 </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> 表名</span></span></code></pre></div><h3 id="_5-5优先级" tabindex="-1">5.5优先级 <a class="header-anchor" href="#_5-5优先级" aria-label="Permalink to &quot;5.5优先级&quot;">​</a></h3><p>SQL Server查询数据三种方式Table Scan/Index Seek/Index Scan</p><p>Table Scan：全表扫描，没有用到索引；</p><p>Index Seek：索引查找，有用到索引，根据聚集索引和非聚集索引分为Clustered Index Seek和NonClustered Index Seek；</p><p>Index Scan：索引扫描，有用到索引，效率比Table Scan高，但低于Index Seek。也分为Clustered Index Scan和</p><p>NonClustered Index Scan；</p><p>显然，Index Seek查询效率最高，我们应该在查询中尽量用Index Seek，那什么时候会用到Index Seek呢？我们再看两个查询的执行计划： ·索引全部字段包含在where子句中； ·复合索引部分字段包含在where子句中且是索引前几个字段</p><p><code>优先级</code><strong>Clustered Index Seek</strong>&gt;<strong>NonClustered Index Seek</strong>&gt;<strong>NonClustered Index Scan</strong>&gt;<strong>Clustered Index Scan&gt;Table Scan</strong></p><p>SqlServer中Index Seek的匹配规则（一） <a href="https://www.cnblogs.com/OpenCoder/p/5804794.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/OpenCoder/p/5804794.html</a><a href="https://www.cnblogs.com/OpenCoder/category/774800.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/OpenCoder/category/774800.html</a></p><h1 id="四、sql-执行计划" tabindex="-1">四、sql 执行计划 <a class="header-anchor" href="#四、sql-执行计划" aria-label="Permalink to &quot;四、sql 执行计划&quot;">​</a></h1><h2 id="_4-1-执行时间最长-sql" tabindex="-1">4.1 执行时间最长 sql <a class="header-anchor" href="#_4-1-执行时间最长-sql" aria-label="Permalink to &quot;4.1 执行时间最长 sql&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_plan</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">,total_worker_time   </span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_stats</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">sql_handle</span><span style="color:#E1E4E8;">) qt  </span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_plan</span><span style="color:#E1E4E8;">(plan_handle) qp  </span></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_plan</span><span style="color:#E1E4E8;">.exist(</span><span style="color:#9ECBFF;">&#39;declare namespace   </span></span>
<span class="line"><span style="color:#9ECBFF;">qplan=&quot;http://schemas.microsoft.com/sqlserver/2004/07/showplan&quot;;  </span></span>
<span class="line"><span style="color:#9ECBFF;">            //qplan:RelOp[@LogicalOp=&quot;Index Scan&quot;  </span></span>
<span class="line"><span style="color:#9ECBFF;">            or @LogicalOp=&quot;Clustered Index Scan&quot;  </span></span>
<span class="line"><span style="color:#9ECBFF;">            or @LogicalOp=&quot;Table Scan&quot;]&#39;</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> total_worker_time </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_plan</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">,total_worker_time   </span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_stats</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">sql_handle</span><span style="color:#24292E;">) qt  </span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_plan</span><span style="color:#24292E;">(plan_handle) qp  </span></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_plan</span><span style="color:#24292E;">.exist(</span><span style="color:#032F62;">&#39;declare namespace   </span></span>
<span class="line"><span style="color:#032F62;">qplan=&quot;http://schemas.microsoft.com/sqlserver/2004/07/showplan&quot;;  </span></span>
<span class="line"><span style="color:#032F62;">            //qplan:RelOp[@LogicalOp=&quot;Index Scan&quot;  </span></span>
<span class="line"><span style="color:#032F62;">            or @LogicalOp=&quot;Clustered Index Scan&quot;  </span></span>
<span class="line"><span style="color:#032F62;">            or @LogicalOp=&quot;Table Scan&quot;]&#39;</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> total_worker_time </span><span style="color:#D73A49;">DESC</span></span></code></pre></div>`,239),e=[o];function c(t,r,E,y,i,F){return a(),n("div",null,e)}const A=s(p,[["render",c]]);export{d as __pageData,A as default};
