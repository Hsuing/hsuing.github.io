import{_ as s,o as n,c as a,R as p}from"./chunks/framework.zUbWieqp.js";const d=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/pgSql/base/plugin/2-pg_cron.md","filePath":"guide/Database/pgSql/base/plugin/2-pg_cron.md","lastUpdated":1711535325000}'),l={name:"guide/Database/pgSql/base/plugin/2-pg_cron.md"},o=p(`<h2 id="_1-6-cron" tabindex="-1">1.6 cron <a class="header-anchor" href="#_1-6-cron" aria-label="Permalink to &quot;1.6 cron&quot;">​</a></h2><h3 id="_1-6-1-安装pg-cron" tabindex="-1">1.6.1.安装pg_cron <a class="header-anchor" href="#_1-6-1-安装pg-cron" aria-label="Permalink to &quot;1.6.1.安装pg_cron&quot;">​</a></h3><p>pg12.2</p><p>cron1.2.0</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/opt</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://github.com/citusdata/pg_cron/archive/v1.2.0.tar.gz</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tar</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">zxvf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1.2.0.tar.gz</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_cron-1.2.0/</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">make</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PG_CONFIG=/data/apps/pgsql/12/bin/pg_config</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">make</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PG_CONFIG=/data/apps/pgsql/12/bin/pg_config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">注意：</span></span>
<span class="line"><span style="color:#B392F0;">/data/apps/pgsql/12/bin/pg_config</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">------</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">安装在已有的上面，否则会出现权限拒绝的情况</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/opt</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wget</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://github.com/citusdata/pg_cron/archive/v1.2.0.tar.gz</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tar</span><span style="color:#24292E;"> </span><span style="color:#032F62;">zxvf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1.2.0.tar.gz</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_cron-1.2.0/</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">make</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PG_CONFIG=/data/apps/pgsql/12/bin/pg_config</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">make</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PG_CONFIG=/data/apps/pgsql/12/bin/pg_config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">注意：</span></span>
<span class="line"><span style="color:#6F42C1;">/data/apps/pgsql/12/bin/pg_config</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">------</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">安装在已有的上面，否则会出现权限拒绝的情况</span></span></code></pre></div><h3 id="_1-6-2-编辑postgresql-conf" tabindex="-1">1.6.2.编辑postgresql.conf <a class="header-anchor" href="#_1-6-2-编辑postgresql-conf" aria-label="Permalink to &quot;1.6.2.编辑postgresql.conf&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">vi</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgresql.conf</span></span>
<span class="line"><span style="color:#B392F0;">shared_preload_libraries</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;pg_cron&#39;</span></span>
<span class="line"><span style="color:#B392F0;">cron.database_name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;postgres&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--pg_cron元数据存放数据库</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">重启数据库</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">vi</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgresql.conf</span></span>
<span class="line"><span style="color:#6F42C1;">shared_preload_libraries</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;pg_cron&#39;</span></span>
<span class="line"><span style="color:#6F42C1;">cron.database_name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;postgres&#39;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--pg_cron元数据存放数据库</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">重启数据库</span></span></code></pre></div><blockquote><p>[!WARNING]</p><p>第二行的指定<code>cron</code>的元数据相关信息存放的数据库，是可以改成其他的。这里要明确一个概念，<code>cron</code>安装的数据库，和它要控制的数据库没有什么必然联系，并不因为说安装在了<code>postgres</code>库，就不能调度其他库了</p></blockquote><h3 id="_1-6-3创建扩展" tabindex="-1">1.6.3创建扩展 <a class="header-anchor" href="#_1-6-3创建扩展" aria-label="Permalink to &quot;1.6.3创建扩展&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">create</span><span style="color:#E1E4E8;"> extension pg_cron;</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> EXTENSION</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 删除扩展</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">drop</span><span style="color:#E1E4E8;"> extension pg_cron;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看扩展</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">\\dx</span></span>
<span class="line"><span style="color:#E1E4E8;">                 List of installed extensions</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">Name</span><span style="color:#E1E4E8;">   | </span><span style="color:#F97583;">Version</span><span style="color:#E1E4E8;"> |   </span><span style="color:#F97583;">Schema</span><span style="color:#E1E4E8;">   |         </span><span style="color:#F97583;">Description</span><span style="color:#E1E4E8;">          </span></span>
<span class="line"><span style="color:#6A737D;">---------+---------+------------+------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> pg_cron | </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">     | public     | Job scheduler </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> PostgreSQL</span></span>
<span class="line"><span style="color:#E1E4E8;"> plpgsql | </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">     | pg_catalog | PL</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">pgSQL procedural </span><span style="color:#F97583;">language</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 实际当中安装了pg_cron 扩展会在当前数据库生成一张cron.job表</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_tables </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> schemaname </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;cron&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;"> schemaname | tablename | tableowner | tablespace | hasindexes | hasrules | hastriggers | rowsecurity </span></span>
<span class="line"><span style="color:#6A737D;">------------+-----------+------------+------------+------------+----------+-------------+-------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> cron       | job       | postgres   |            | t          | f        | t           | t</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">create</span><span style="color:#24292E;"> extension pg_cron;</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> EXTENSION</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 删除扩展</span></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">drop</span><span style="color:#24292E;"> extension pg_cron;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看扩展</span></span>
<span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">\\dx</span></span>
<span class="line"><span style="color:#24292E;">                 List of installed extensions</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">Name</span><span style="color:#24292E;">   | </span><span style="color:#D73A49;">Version</span><span style="color:#24292E;"> |   </span><span style="color:#D73A49;">Schema</span><span style="color:#24292E;">   |         </span><span style="color:#D73A49;">Description</span><span style="color:#24292E;">          </span></span>
<span class="line"><span style="color:#6A737D;">---------+---------+------------+------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> pg_cron | </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">     | public     | Job scheduler </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> PostgreSQL</span></span>
<span class="line"><span style="color:#24292E;"> plpgsql | </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">     | pg_catalog | PL</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">pgSQL procedural </span><span style="color:#D73A49;">language</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 实际当中安装了pg_cron 扩展会在当前数据库生成一张cron.job表</span></span>
<span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_tables </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> schemaname </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;cron&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;"> schemaname | tablename | tableowner | tablespace | hasindexes | hasrules | hastriggers | rowsecurity </span></span>
<span class="line"><span style="color:#6A737D;">------------+-----------+------------+------------+------------+----------+-------------+-------------</span></span>
<span class="line"><span style="color:#24292E;"> cron       | job       | postgres   |            | t          | f        | t           | t</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span></code></pre></div><h3 id="_1-6-4赋予普通用户权限-可选" tabindex="-1">1.6.4赋予普通用户权限(可选) <a class="header-anchor" href="#_1-6-4赋予普通用户权限-可选" aria-label="Permalink to &quot;1.6.4赋予普通用户权限(可选)&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# GRANT USAGE ON SCHEMA cron TO username;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# GRANT USAGE ON SCHEMA cron TO username;</span></span></code></pre></div><h3 id="_1-6-5普通用户创建job" tabindex="-1">1.6.5普通用户创建job <a class="header-anchor" href="#_1-6-5普通用户创建job" aria-label="Permalink to &quot;1.6.5普通用户创建job&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">cron格式如下</span></span>
<span class="line"><span style="color:#E1E4E8;"> ┌───────────── </span><span style="color:#79B8FF;">min</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">59</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> │ ┌────────────── </span><span style="color:#F97583;">hour</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> │ │ ┌─────────────── </span><span style="color:#F97583;">day</span><span style="color:#E1E4E8;"> of </span><span style="color:#79B8FF;">month</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">31</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> │ │ │ ┌──────────────── </span><span style="color:#79B8FF;">month</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> │ │ │ │ ┌───────────────── </span><span style="color:#F97583;">day</span><span style="color:#E1E4E8;"> of </span><span style="color:#F97583;">week</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">) (</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> are Sunday </span><span style="color:#F97583;">to</span></span>
<span class="line"><span style="color:#E1E4E8;"> │ │ │ │ │                  Saturday, </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> names; </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> also Sunday)</span></span>
<span class="line"><span style="color:#E1E4E8;"> │ │ │ │ │</span></span>
<span class="line"><span style="color:#E1E4E8;"> │ │ │ │ │</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> $ </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">opt</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">pg12</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">bin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">psql </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">p5555 </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Utest postgres</span></span>
<span class="line"><span style="color:#E1E4E8;">psql (</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">Type</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;help&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> help.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--每分钟插入一条随机数据</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">cron</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schedule</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;* * * * *&#39;</span><span style="color:#E1E4E8;">,$$</span><span style="color:#F97583;">insert into</span><span style="color:#E1E4E8;"> emp1 </span><span style="color:#F97583;">values</span><span style="color:#E1E4E8;">((random()</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">),</span><span style="color:#9ECBFF;">&#39;hello&#39;</span><span style="color:#E1E4E8;">);$$);</span></span>
<span class="line"><span style="color:#E1E4E8;"> schedule </span></span>
<span class="line"><span style="color:#6A737D;">----------</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--每天上午10点执行清理(GMT)</span></span>
<span class="line"><span style="color:#6A737D;">-- 当GMT为早上7点，那么北京时间就应该为当日7+8=15时（下午3点）</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">cron</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schedule</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;0 10 * * *&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;VACUUM&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查询</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> jobid,command </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">cron</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">job</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;"> jobid |                     command                      </span></span>
<span class="line"><span style="color:#6A737D;">-------+--------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">insert into</span><span style="color:#E1E4E8;"> emp1 </span><span style="color:#F97583;">values</span><span style="color:#E1E4E8;">((random()</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">),</span><span style="color:#9ECBFF;">&#39;hello&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--删除这个任务</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">cron</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">unschedule</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">--cron.job.jobid</span></span>
<span class="line"><span style="color:#E1E4E8;"> unschedule </span></span>
<span class="line"><span style="color:#6A737D;">------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> t</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">cron格式如下</span></span>
<span class="line"><span style="color:#24292E;"> ┌───────────── </span><span style="color:#005CC5;">min</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">59</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> │ ┌────────────── </span><span style="color:#D73A49;">hour</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">23</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> │ │ ┌─────────────── </span><span style="color:#D73A49;">day</span><span style="color:#24292E;"> of </span><span style="color:#005CC5;">month</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">31</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> │ │ │ ┌──────────────── </span><span style="color:#005CC5;">month</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">12</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> │ │ │ │ ┌───────────────── </span><span style="color:#D73A49;">day</span><span style="color:#24292E;"> of </span><span style="color:#D73A49;">week</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">) (</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">to</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> are Sunday </span><span style="color:#D73A49;">to</span></span>
<span class="line"><span style="color:#24292E;"> │ │ │ │ │                  Saturday, </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">use</span><span style="color:#24292E;"> names; </span><span style="color:#005CC5;">7</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> also Sunday)</span></span>
<span class="line"><span style="color:#24292E;"> │ │ │ │ │</span></span>
<span class="line"><span style="color:#24292E;"> │ │ │ │ │</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> $ </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">opt</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">pg12</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">bin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">psql </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">p5555 </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Utest postgres</span></span>
<span class="line"><span style="color:#24292E;">psql (</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">Type</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;help&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> help.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--每分钟插入一条随机数据</span></span>
<span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">cron</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schedule</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;* * * * *&#39;</span><span style="color:#24292E;">,$$</span><span style="color:#D73A49;">insert into</span><span style="color:#24292E;"> emp1 </span><span style="color:#D73A49;">values</span><span style="color:#24292E;">((random()</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">),</span><span style="color:#032F62;">&#39;hello&#39;</span><span style="color:#24292E;">);$$);</span></span>
<span class="line"><span style="color:#24292E;"> schedule </span></span>
<span class="line"><span style="color:#6A737D;">----------</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--每天上午10点执行清理(GMT)</span></span>
<span class="line"><span style="color:#6A737D;">-- 当GMT为早上7点，那么北京时间就应该为当日7+8=15时（下午3点）</span></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">cron</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schedule</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;0 10 * * *&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;VACUUM&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查询</span></span>
<span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> jobid,command </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">cron</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">job</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;"> jobid |                     command                      </span></span>
<span class="line"><span style="color:#6A737D;">-------+--------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">insert into</span><span style="color:#24292E;"> emp1 </span><span style="color:#D73A49;">values</span><span style="color:#24292E;">((random()</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">),</span><span style="color:#032F62;">&#39;hello&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--删除这个任务</span></span>
<span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">cron</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">unschedule</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">--cron.job.jobid</span></span>
<span class="line"><span style="color:#24292E;"> unschedule </span></span>
<span class="line"><span style="color:#6A737D;">------------</span></span>
<span class="line"><span style="color:#24292E;"> t</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span></code></pre></div><blockquote><p>[!WARNING]</p><p>1.pg_cron不会在备库运行job，但当备库提升为主库时会自动开启job。</p><p>2.pg_cron时间为GMT</p></blockquote>`,15),e=[o];function c(t,r,E,y,i,F){return n(),a("div",null,e)}const C=s(l,[["render",c]]);export{d as __pageData,C as default};
