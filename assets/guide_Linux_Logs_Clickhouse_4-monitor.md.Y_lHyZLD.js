import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const d=JSON.parse('{"title":"1.metrics","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Linux/Logs/Clickhouse/4-monitor.md","filePath":"guide/Linux/Logs/Clickhouse/4-monitor.md","lastUpdated":1730801732000}'),e={name:"guide/Linux/Logs/Clickhouse/4-monitor.md"},p=l(`<h1 id="_1-metrics" tabindex="-1">1.metrics <a class="header-anchor" href="#_1-metrics" aria-label="Permalink to &quot;1.metrics&quot;">​</a></h1><p>ClickHouse 从 v20.1.2.4 开始，内置了对接 Prometheus 的功能，配置的方式也很简单,可以将其作为 Prometheus 的 Endpoint 服务，从而自动的将 metrics 、 events 和asynchronous_metrics 三张系统的表的数据发送给 Prometheus</p><h2 id="_1-1开启" tabindex="-1">1.1开启 <a class="header-anchor" href="#_1-1开启" aria-label="Permalink to &quot;1.1开启&quot;">​</a></h2><p>编辑，/etc/clickhouse-server/config.xml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&lt;prometheus&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&lt;endpoint&gt;/metrics&lt;/endpoint&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&lt;port&gt;9363&lt;/port&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&lt;metrics&gt;true&lt;/metrics&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&lt;events&gt;true&lt;/events&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&lt;asynchronous_metrics&gt;true&lt;/asynchronous_metrics&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&lt;status_info&gt;true&lt;/status_info&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&lt;/prometheus&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&lt;prometheus&gt;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&lt;endpoint&gt;/metrics&lt;/endpoint&gt;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&lt;port&gt;9363&lt;/port&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&lt;metrics&gt;true&lt;/metrics&gt;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&lt;events&gt;true&lt;/events&gt;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&lt;asynchronous_metrics&gt;true&lt;/asynchronous_metrics&gt;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&lt;status_info&gt;true&lt;/status_info&gt;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&lt;/prometheus&gt;</span></span></code></pre></div><ul><li>重启服务</li></ul><p>如果有多个 CH 节点，分发配置</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">systemctl restart clickhouse-server.service</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">systemctl restart clickhouse-server.service</span></span></code></pre></div><h2 id="_1-2访问" tabindex="-1">1.2访问 <a class="header-anchor" href="#_1-2访问" aria-label="Permalink to &quot;1.2访问&quot;">​</a></h2><p>浏览器打开: <a href="http://ip:9363/metrics" target="_blank" rel="noreferrer">http://ip:9363/metrics</a></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202411042239555.png" alt="image-20241104223926086"></p><h1 id="_2-prometheus添加" tabindex="-1">2. prometheus添加 <a class="header-anchor" href="#_2-prometheus添加" aria-label="Permalink to &quot;2. prometheus添加&quot;">​</a></h1><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">clickhouse</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">10.103.236.200:9363</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scrape_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">1m</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scrape_timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">30s</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scheme</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/metrics&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">clickhouse</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">10.103.236.200:9363</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scrape_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">1m</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scrape_timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">30s</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scheme</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/metrics&quot;</span></span></code></pre></div><ul><li>热更新</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-XPOST</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-XPOST</span><span style="color:#24292E;">  </span><span style="color:#032F62;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre></div><h1 id="_3-granfana添加" tabindex="-1">3. granfana添加 <a class="header-anchor" href="#_3-granfana添加" aria-label="Permalink to &quot;3. granfana添加&quot;">​</a></h1>`,16),t=[p];function o(c,r,i,E,y,h){return a(),n("div",null,t)}const g=s(e,[["render",o]]);export{d as __pageData,g as default};
