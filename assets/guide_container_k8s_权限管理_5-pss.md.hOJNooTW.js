import{_ as s,o as n,c as a,R as p}from"./chunks/framework.zUbWieqp.js";const u=JSON.parse('{"title":"1. PSS介绍","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/权限管理/5-pss.md","filePath":"guide/container/k8s/权限管理/5-pss.md","lastUpdated":1723628763000}'),e={name:"guide/container/k8s/权限管理/5-pss.md"},l=p(`<p>官当，<a href="https://kubernetes.io/zh-cn/docs/concepts/security/pod-security-standards/" target="_blank" rel="noreferrer">https://kubernetes.io/zh-cn/docs/concepts/security/pod-security-standards/</a></p><p><a href="https://kubernetes.io/docs/concepts/security/pod-security-admission/" target="_blank" rel="noreferrer">Pod 安全准入 (PSA)</a></p><h1 id="_1-pss介绍" tabindex="-1">1. PSS介绍 <a class="header-anchor" href="#_1-pss介绍" aria-label="Permalink to &quot;1. PSS介绍&quot;">​</a></h1><p>Pod Security Standards (PSS)<a href="https://kubernetes.io/docs/concepts/security/pod-security-standards/" target="_blank" rel="noreferrer">Pod 安全标准</a> 是 Kubernetes 1.22 引入的一种安全机制，用于替代 Pod Security Policies (PSP)。PSS 提供了三种级别的安全策略：<code>Privileged</code>、<code>Baseline</code> 和 <code>Restricted</code>，分别适用于不同的安全需求</p><h2 id="_1-1-策略介绍" tabindex="-1">1.1 策略介绍 <a class="header-anchor" href="#_1-1-策略介绍" aria-label="Permalink to &quot;1.1 策略介绍&quot;">​</a></h2><p><strong>Privileged</strong>: 最宽松的策略，允许所有操作，适用于需要完全控制的 Pods，例如执行复杂的系统操作。</p><p><strong>Baseline</strong>: 适度的限制，适用于大多数应用程序，允许常见的使用模式，但不允许特权操作。</p><p><strong>Restricted</strong>: 最严格的策略，适用于高安全性环境，限制了大多数可能引发安全问题的操作。</p><h1 id="_2-启用pod安全准入控制器" tabindex="-1">2. 启用Pod安全准入控制器 <a class="header-anchor" href="#_2-启用pod安全准入控制器" aria-label="Permalink to &quot;2. 启用Pod安全准入控制器&quot;">​</a></h1><p>首先，确保 Kubernetes 集群启用了 Pod 安全准入控制器。在 Kubernetes 1.25 及以后版本中，Pod 安全准入控制器是默认启用的。</p><p>在 Kubernetes API Server 的启动参数中配置 Pod 安全准入控制器：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">--enable-admission-plugins=...,PodSecurity,…</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">--enable-admission-plugins=...,PodSecurity,…</span></span></code></pre></div><h1 id="_3-pss案例" tabindex="-1">3. PSS案例 <a class="header-anchor" href="#_3-pss案例" aria-label="Permalink to &quot;3. PSS案例&quot;">​</a></h1><h2 id="_3-1-配置特权pod" tabindex="-1">3.1 配置特权Pod <a class="header-anchor" href="#_3-1-配置特权pod" aria-label="Permalink to &quot;3.1 配置特权Pod&quot;">​</a></h2><p>1.创建ns</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">namespace</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">privileged-namespace</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">namespace</span><span style="color:#24292E;"> </span><span style="color:#032F62;">privileged-namespace</span></span></code></pre></div><h2 id="_3-2-创建pss策略" tabindex="-1">3.2 创建PSS策略 <a class="header-anchor" href="#_3-2-创建pss策略" aria-label="Permalink to &quot;3.2 创建PSS策略&quot;">​</a></h2><p>1.privileged-namespace.yaml</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">apiVersion:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#B392F0;">kind:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Namespace</span></span>
<span class="line"><span style="color:#B392F0;">metadata:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">privileged-namespace</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">labels:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">pod-security.kubernetes.io/enforce:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">privileged</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">pod-security.kubernetes.io/audit:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">baseline</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">pod-security.kubernetes.io/warn:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restricted</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">apiVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#6F42C1;">kind:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Namespace</span></span>
<span class="line"><span style="color:#6F42C1;">metadata:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">privileged-namespace</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">labels:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">pod-security.kubernetes.io/enforce:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">privileged</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">pod-security.kubernetes.io/audit:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">baseline</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">pod-security.kubernetes.io/warn:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restricted</span></span></code></pre></div><p>参数介绍：</p><p><strong>enforce: privileged</strong>：强制执行 <code>Privileged</code> 策略，允许特权操作。</p><p><strong>audit: baseline</strong>：在审计日志中记录超出 <code>Baseline</code> 策略的行为。</p><p><strong>warn: restricted</strong>：发出警告，提示哪些操作违反了 <code>Restricted</code> 策略</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#9ECBFF;">apiVersion: v1</span></span>
<span class="line"><span style="color:#9ECBFF;">kind: Namespace</span></span>
<span class="line"><span style="color:#9ECBFF;">metadata:</span></span>
<span class="line"><span style="color:#9ECBFF;">  name: privileged-namespace</span></span>
<span class="line"><span style="color:#9ECBFF;">  labels:</span></span>
<span class="line"><span style="color:#9ECBFF;">    pod-security.kubernetes.io/enforce: privileged</span></span>
<span class="line"><span style="color:#9ECBFF;">    pod-security.kubernetes.io/audit: baseline</span></span>
<span class="line"><span style="color:#9ECBFF;">    pod-security.kubernetes.io/warn: restricted</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#032F62;">apiVersion: v1</span></span>
<span class="line"><span style="color:#032F62;">kind: Namespace</span></span>
<span class="line"><span style="color:#032F62;">metadata:</span></span>
<span class="line"><span style="color:#032F62;">  name: privileged-namespace</span></span>
<span class="line"><span style="color:#032F62;">  labels:</span></span>
<span class="line"><span style="color:#032F62;">    pod-security.kubernetes.io/enforce: privileged</span></span>
<span class="line"><span style="color:#032F62;">    pod-security.kubernetes.io/audit: baseline</span></span>
<span class="line"><span style="color:#032F62;">    pod-security.kubernetes.io/warn: restricted</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span></code></pre></div><h2 id="_3-3-部署pod" tabindex="-1">3.3 部署Pod <a class="header-anchor" href="#_3-3-部署pod" aria-label="Permalink to &quot;3.3 部署Pod&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">optimized-pod</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">privileged-namespace</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">initContainers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">init-sysctl</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">busybox</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">sh</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">&#39;-c&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">          echo 2048 &gt; /proc/sys/net/core/somaxconn;</span></span>
<span class="line"><span style="color:#9ECBFF;">          echo 262144 &gt; /proc/sys/net/core/netdev_max_backlog;</span></span>
<span class="line"><span style="color:#9ECBFF;">          echo 262144 &gt; /proc/sys/net/core/rmem_max;</span></span>
<span class="line"><span style="color:#9ECBFF;">          echo 262144 &gt; /proc/sys/net/core/wmem_max;</span></span>
<span class="line"><span style="color:#9ECBFF;">          echo 1048576 &gt; /proc/sys/fs/file-max;</span></span>
<span class="line"><span style="color:#9ECBFF;">          echo 1048576 &gt; /proc/sys/fs/nr_open;</span></span>
<span class="line"><span style="color:#9ECBFF;">          echo 10 &gt; /proc/sys/net/ipv4/tcp_fin_timeout;</span></span>
<span class="line"><span style="color:#9ECBFF;">          echo 1 &gt; /proc/sys/net/ipv4/tcp_tw_reuse;</span></span>
<span class="line"><span style="color:#9ECBFF;">          echo 1 &gt; /proc/sys/net/ipv4/tcp_tw_recycle;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">securityContext</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">privileged</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">main-container</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">optimized-pod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">privileged-namespace</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">initContainers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">init-sysctl</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">command</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">sh</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">&#39;-c&#39;</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">          echo 2048 &gt; /proc/sys/net/core/somaxconn;</span></span>
<span class="line"><span style="color:#032F62;">          echo 262144 &gt; /proc/sys/net/core/netdev_max_backlog;</span></span>
<span class="line"><span style="color:#032F62;">          echo 262144 &gt; /proc/sys/net/core/rmem_max;</span></span>
<span class="line"><span style="color:#032F62;">          echo 262144 &gt; /proc/sys/net/core/wmem_max;</span></span>
<span class="line"><span style="color:#032F62;">          echo 1048576 &gt; /proc/sys/fs/file-max;</span></span>
<span class="line"><span style="color:#032F62;">          echo 1048576 &gt; /proc/sys/fs/nr_open;</span></span>
<span class="line"><span style="color:#032F62;">          echo 10 &gt; /proc/sys/net/ipv4/tcp_fin_timeout;</span></span>
<span class="line"><span style="color:#032F62;">          echo 1 &gt; /proc/sys/net/ipv4/tcp_tw_reuse;</span></span>
<span class="line"><span style="color:#032F62;">          echo 1 &gt; /proc/sys/net/ipv4/tcp_tw_recycle;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">securityContext</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">privileged</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">main-container</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div>`,26),o=[l];function c(t,r,i,y,E,d){return n(),a("div",null,o)}const h=s(e,[["render",c]]);export{u as __pageData,h as default};
