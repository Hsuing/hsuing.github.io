import{_ as s,o as a,c as n,R as o}from"./chunks/framework.zUbWieqp.js";const u=JSON.parse('{"title":"EKS集群升级流程","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/cloud_k8s/aws/4-eks_update.md","filePath":"guide/container/k8s/cloud_k8s/aws/4-eks_update.md","lastUpdated":1755172914000}'),e={name:"guide/container/k8s/cloud_k8s/aws/4-eks_update.md"},l=o(`<h1 id="eks集群升级流程" tabindex="-1">EKS集群升级流程 <a class="header-anchor" href="#eks集群升级流程" aria-label="Permalink to &quot;EKS集群升级流程&quot;">​</a></h1><p>AWS 会对每个 EKS 版本提供14个月支持，同时 AWS 会强制更新太旧的 EKS 集群，因此可能导致生产服务中断。要升级 EKS 集群，首先要注意以下事项：</p><ul><li>验证与应用程序关联的容器映像版本是否可用，主要是排除应用异常导致的干扰。</li><li>检查集群所在子网有足够的可用 IP，可用IP不足也可能会导致 EKS 升级失败。</li><li>检查 node group 配置中的最大不可用性节点数量，这个数量表示每次更新期间节点组中可以替换的节点数。在大规模集群中，设置为百分比更有利于提高更新的速度。</li></ul><h1 id="一、升级eks的检查工作" tabindex="-1">一、升级EKS的检查工作 <a class="header-anchor" href="#一、升级eks的检查工作" aria-label="Permalink to &quot;一、升级EKS的检查工作&quot;">​</a></h1><p>EKS 不允许跨版本升级，在升级 EKS 集群之前需要做兼容性的检查：</p><h2 id="_1-1-与-kubernetes-相关的变更" tabindex="-1">1.1 与 Kubernetes 相关的变更 <a class="header-anchor" href="#_1-1-与-kubernetes-相关的变更" aria-label="Permalink to &quot;1.1 与 Kubernetes 相关的变更&quot;">​</a></h2><p>每一个版本的 EKS 都有一些 API 已被弃用。 因此需要检查特定版本更改的详细信息，需要参考 Kubernetes 的变更日志和 EKS 版本更新文档。</p><ul><li><a href="https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG" target="_blank" rel="noreferrer">https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG</a> 需要重点关注 Urgent Upgrade Notes 部分</li><li><a href="https://docs.amazonaws.cn/eks/latest/userguide/kubernetes-versions.html" target="_blank" rel="noreferrer">https://docs.amazonaws.cn/eks/latest/userguide/kubernetes-versions.html</a></li></ul><h2 id="_1-2-使用-kubent-检查-api-变更" tabindex="-1">1.2 使用 kubent 检查 API 变更 <a class="header-anchor" href="#_1-2-使用-kubent-检查-api-变更" aria-label="Permalink to &quot;1.2 使用 kubent 检查 API 变更&quot;">​</a></h2><p>国际版的 EKS web console 中提供了 Upgrade insights 工具，可以检查 API 变动。但是中国区没有这个工具，可以使用第三方工具 kube-no-trouble 进行检查。</p><ol><li><p>下载 <a href="https://github.com/doitintl/kube-no-trouble/releases" target="_blank" rel="noreferrer">https://github.com/doitintl/kube-no-trouble/releases</a> 并然后解压。</p></li><li><p>确保 kubectl 当前的 context 是要升级的 EKS 集群，使用下面的cmd来检查：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">current-context</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">current-context</span></span></code></pre></div></li><li><p>执行./kubent开始检查。 确保 &gt;&gt;&gt; Deprecated APIs removed in 1.XX &lt;&lt;&lt; 中没有任何内容。 注意：要保证 aws cli 的版本应大于2.0，尽量使用新版本的 aws cli 。</p></li></ol><p>如果API版本发生变化，需要参考 <a href="https://docs.amazonaws.cn/en_us/eks/latest/userguide/update-cluster.html" target="_blank" rel="noreferrer">https://docs.amazonaws.cn/en_us/eks/latest/userguide/update-cluster.html</a> 进行更新。</p><h2 id="_1-3-检查-addons-版本是否需要更新" tabindex="-1">1.3 检查 addons 版本是否需要更新 <a class="header-anchor" href="#_1-3-检查-addons-版本是否需要更新" aria-label="Permalink to &quot;1.3 检查 addons 版本是否需要更新&quot;">​</a></h2><p>所有的 addon 都在 kube-system namesapce中，首先需要确定所有 addon 需要升级的目标版本号，供后续更新使用。</p><h3 id="_1-3-1-检查兼容的版本" tabindex="-1">1.3.1 检查兼容的版本 <a class="header-anchor" href="#_1-3-1-检查兼容的版本" aria-label="Permalink to &quot;1.3.1 检查兼容的版本&quot;">​</a></h3><p>使用以下命令可以列出与 EKS 1.22 版本兼容的所有插件版本：</p><ol><li><p>查看 kube-proxy 全部兼容的版本</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">aws</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">eks</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">describe-addon-versions</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--kubernetes-version</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1.22</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--addon-name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-proxy</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">addonVersion</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">aws</span><span style="color:#24292E;"> </span><span style="color:#032F62;">eks</span><span style="color:#24292E;"> </span><span style="color:#032F62;">describe-addon-versions</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--kubernetes-version</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1.22</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--addon-name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-proxy</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">addonVersion</span></span></code></pre></div></li><li><p>查看 coredns 兼容的版本</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">aws</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">eks</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">describe-addon-versions</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--kubernetes-version</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1.22</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--addon-name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">coredns</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">addonVersion</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">aws</span><span style="color:#24292E;"> </span><span style="color:#032F62;">eks</span><span style="color:#24292E;"> </span><span style="color:#032F62;">describe-addon-versions</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--kubernetes-version</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1.22</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--addon-name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">coredns</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">addonVersion</span></span></code></pre></div></li><li><p>查看 vpc-cni 兼容的版本</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">aws</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">eks</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">describe-addon-versions</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--kubernetes-version</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1.22</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--addon-name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">vpc-cni</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">addonVersion</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">aws</span><span style="color:#24292E;"> </span><span style="color:#032F62;">eks</span><span style="color:#24292E;"> </span><span style="color:#032F62;">describe-addon-versions</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--kubernetes-version</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1.22</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--addon-name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">vpc-cni</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">addonVersion</span></span></code></pre></div><p>另外，建议结合 AWS 的文档确定最终要的 addon 版本：</p></li></ol><p><a href="https://docs.aws.amazon.com/eks/latest/userguide/managing-kube-proxy.html" target="_blank" rel="noreferrer">https://docs.aws.amazon.com/eks/latest/userguide/managing-kube-proxy.html</a></p><p><a href="https://docs.aws.amazon.com/eks/latest/userguide/managing-coredns.html" target="_blank" rel="noreferrer">https://docs.aws.amazon.com/eks/latest/userguide/managing-coredns.html</a></p><p><a href="https://docs.aws.amazon.com/eks/latest/userguide/managing-vpc-cni.html" target="_blank" rel="noreferrer">https://docs.aws.amazon.com/eks/latest/userguide/managing-vpc-cni.html</a></p><h3 id="_1-3-2-检查当前-addons-版本" tabindex="-1">1.3.2 检查当前 addons 版本 <a class="header-anchor" href="#_1-3-2-检查当前-addons-版本" aria-label="Permalink to &quot;1.3.2 检查当前 addons 版本&quot;">​</a></h3><p>您可以使用下面的 AWS CLI 命令来查询 addon的 image 版本：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#kube-proxy</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemonset</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-proxy</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">image</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># coredns</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deployment</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">coredns</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">image</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># vpc-cni</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemonset</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">aws-node</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">image</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#kube-proxy</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemonset</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-proxy</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yaml</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">image</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># coredns</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">coredns</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yaml</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">image</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># vpc-cni</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemonset</span><span style="color:#24292E;"> </span><span style="color:#032F62;">aws-node</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yaml</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">image</span></span></code></pre></div><p>对比一下当前的 addon 版本是否则在兼容列表中，如果不在就需要升级 addon 版本。如果使用了其他插件，也需要查看相关文档以确定兼容性。</p><h1 id="二、更新-eks-版本" tabindex="-1">二、更新 EKS 版本 <a class="header-anchor" href="#二、更新-eks-版本" aria-label="Permalink to &quot;二、更新 EKS 版本&quot;">​</a></h1><p>EKS 不允许跨版本升级，所以在升级过程中，需要先升级到1.22版本，然后升级到1.23，最后升级到1.24，以此类推。 按照 EKS Control Plane -&gt; EKS addons -&gt; EKS node group 的顺序进行升级。</p><h2 id="_2-1-升级-eks-control-plane" tabindex="-1">2.1 升级 EKS Control Plane <a class="header-anchor" href="#_2-1-升级-eks-control-plane" aria-label="Permalink to &quot;2.1 升级 EKS Control Plane&quot;">​</a></h2><h3 id="web界面" tabindex="-1">web界面 <a class="header-anchor" href="#web界面" aria-label="Permalink to &quot;web界面&quot;">​</a></h3><p>升级的第一步是先升级 EKS Control Plane，这一步很简单，只需要在 eks web console 中点击 “update now” 更新即可。一旦升级成功就无法降级到以前的版本，单独升级 EKS Control Plane 不会重新调度集群中的 Pod，只有升级 node group 时 Pod 才会被重新调度。</p><h3 id="命令行方式" tabindex="-1">命令行方式 <a class="header-anchor" href="#命令行方式" aria-label="Permalink to &quot;命令行方式&quot;">​</a></h3><ul><li>检查当前的 EKS 集群版本：</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">aws</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">eks</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">describe-cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">your-cluster-name</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--query</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster.version</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">aws</span><span style="color:#24292E;"> </span><span style="color:#032F62;">eks</span><span style="color:#24292E;"> </span><span style="color:#032F62;">describe-cluster</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">your-cluster-name</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--query</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster.version</span></span></code></pre></div><ul><li>升级</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">aws</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">eks</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">update-cluster-version</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">your-cluster-name</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--kubernetes-version</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">.XX</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">aws</span><span style="color:#24292E;"> </span><span style="color:#032F62;">eks</span><span style="color:#24292E;"> </span><span style="color:#032F62;">update-cluster-version</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">your-cluster-name</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--kubernetes-version</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">.XX</span></span></code></pre></div><blockquote><p>其中，1.XX 是你想升级到的 Kubernetes 版本</p></blockquote><ul><li><h3 id="升级进度" tabindex="-1">升级进度 <a class="header-anchor" href="#升级进度" aria-label="Permalink to &quot;升级进度&quot;">​</a></h3></li></ul><p>升级过程可能需要 20-30 分钟。你可以使用以下命令监控升级状态：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">aws</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">eks</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">describe-update</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">your-cluster-name</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--update-id</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">your-update-id</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">aws</span><span style="color:#24292E;"> </span><span style="color:#032F62;">eks</span><span style="color:#24292E;"> </span><span style="color:#032F62;">describe-update</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">your-cluster-name</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--update-id</span><span style="color:#24292E;"> </span><span style="color:#032F62;">your-update-id</span></span></code></pre></div><blockquote><p>update-id 是在启动升级时返回的 ID。</p></blockquote><ul><li><h3 id="验证控制平面升级" tabindex="-1">验证控制平面升级 <a class="header-anchor" href="#验证控制平面升级" aria-label="Permalink to &quot;验证控制平面升级&quot;">​</a></h3></li></ul><p>升级完成后，再次检查集群版本以确认升级成功：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">aws</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">eks</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">describe-cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">your-cluster-name</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--query</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster.version</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">aws</span><span style="color:#24292E;"> </span><span style="color:#032F62;">eks</span><span style="color:#24292E;"> </span><span style="color:#032F62;">describe-cluster</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">your-cluster-name</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--query</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster.version</span></span></code></pre></div><h2 id="_2-2-更新插件到兼容的版本" tabindex="-1">2.2 更新插件到兼容的版本 <a class="header-anchor" href="#_2-2-更新插件到兼容的版本" aria-label="Permalink to &quot;2.2 更新插件到兼容的版本&quot;">​</a></h2><p>通常需要更新包括 kube-proxy、coredns、vpc-cni 等 addon 。如果 addon 是通过 eks web console 安装的，也可以在 web console 中直接进行升级。</p><p>如果插件是 self-managed 的，那么必须找到正确的版本，然后使用 <code>kubectl set image </code>进行更新。</p><h3 id="_2-2-1-更新-kube-proxy" tabindex="-1">2.2.1 更新 kube-proxy <a class="header-anchor" href="#_2-2-1-更新-kube-proxy" aria-label="Permalink to &quot;2.2.1 更新 kube-proxy&quot;">​</a></h3><p>以中国区为例，首先打开 <a href="https://docs.amazonaws.cn/eks/latest/userguide/managing-kube-proxy.html" target="_blank" rel="noreferrer">https://docs.amazonaws.cn/eks/latest/userguide/managing-kube-proxy.html</a> ， 需要在文档中找到 kube-proxy 在 ecr 中的镜像地址和 tag 。例如中国北京区的地址是：918309763551.dkr.ecr.cn-north-1.amazonaws.com.cn/eks/kube-proxy tag 是： v1.25.16-minimal-eksbuild.1</p><p>查看当前使用的 kube-proxy image ：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemonset</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-proxy</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--namespace</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o=jsonpath=</span><span style="color:#9ECBFF;">&#39;{$.spec.template.spec.containers[:1].image}&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemonset</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-proxy</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--namespace</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o=jsonpath=</span><span style="color:#032F62;">&#39;{$.spec.template.spec.containers[:1].image}&#39;</span></span></code></pre></div><p>更新 image ：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">image</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemonset.apps/kube-proxy</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-proxy=</span><span style="color:#79B8FF;">918309763551</span><span style="color:#9ECBFF;">.dkr.ecr.cn-north-1.amazonaws.com.cn/eks/kube-proxy:v1.25.16-minimal-eksbuild.1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">image</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemonset.apps/kube-proxy</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-proxy=</span><span style="color:#005CC5;">918309763551</span><span style="color:#032F62;">.dkr.ecr.cn-north-1.amazonaws.com.cn/eks/kube-proxy:v1.25.16-minimal-eksbuild.1</span></span></code></pre></div><p>命令执行后 kube-proxy 的 pod 就会使用新 image 重建，需要检查 pods 是否成功重建。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pods</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pods</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system</span></span></code></pre></div><h3 id="_2-2-2-更新-coredns" tabindex="-1">2.2.2 更新 coredns <a class="header-anchor" href="#_2-2-2-更新-coredns" aria-label="Permalink to &quot;2.2.2 更新 coredns&quot;">​</a></h3><p>同 kube-proxy 类似，访问 <a href="https://docs.amazonaws.cn/eks/latest/userguide/managing-coredns.html" target="_blank" rel="noreferrer">https://docs.amazonaws.cn/eks/latest/userguide/managing-coredns.html</a> 找到 ecr 中coredns 的地址和 tag 。</p><p>查看当前的 image ：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deployment</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">coredns</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--namespace</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o=jsonpath=</span><span style="color:#9ECBFF;">&#39;{$.spec.template.spec.containers[:1].image}&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">coredns</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--namespace</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o=jsonpath=</span><span style="color:#032F62;">&#39;{$.spec.template.spec.containers[:1].image}&#39;</span></span></code></pre></div><p>更新 coredns image：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">image</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--namespace</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deployment.apps/coredns</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">coredns=</span><span style="color:#79B8FF;">918309763551</span><span style="color:#9ECBFF;">.dkr.ecr.region-code.amazonaws.com.cn/eks/coredns:v1.8.7-eksbuild.3</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">image</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--namespace</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployment.apps/coredns</span><span style="color:#24292E;"> </span><span style="color:#032F62;">coredns=</span><span style="color:#005CC5;">918309763551</span><span style="color:#032F62;">.dkr.ecr.region-code.amazonaws.com.cn/eks/coredns:v1.8.7-eksbuild.3</span></span></code></pre></div><h3 id="_2-2-3-更新-vpc-cni" tabindex="-1">2.2.3 更新 vpc-cni <a class="header-anchor" href="#_2-2-3-更新-vpc-cni" aria-label="Permalink to &quot;2.2.3 更新 vpc-cni&quot;">​</a></h3><p>vpc-cni的更新不能使用上面的方式，首先访问 <a href="https://github.com/aws/amazon-vpc-cni-k8s/releases" target="_blank" rel="noreferrer">https://github.com/aws/amazon-vpc-cni-k8s/releases</a> ，找到要升级的版本，下载对应的 yaml 文件，以v1.16.3 为例： aws 中国区：<a href="https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/v1.16.3/config/master/aws-k8s-cni-cn.yaml" target="_blank" rel="noreferrer">https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/v1.16.3/config/master/aws-k8s-cni-cn.yaml</a></p><p>aws 国际区：<a href="https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/v1.16.3/config/master/aws-k8s-cni.yaml" target="_blank" rel="noreferrer">https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/v1.16.3/config/master/aws-k8s-cni.yaml</a></p><p>需要确认 yaml 文件中： image 链接的 account numbmer/region code/release tag是否正确，如果下载了对应区域的 yaml 文件通常不需要修改。如果需要修改为防止出错，建议使用 sed 命令全部一次性修改：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">sed</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-i.bak</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;s|cn-northwest-1|cn-north-1|&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">aws-k8s-cni-cn.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">sed</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-i.bak</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;s|cn-northwest-1|cn-north-1|&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">aws-k8s-cni-cn.yaml</span></span></code></pre></div><p>更新 vpc-cni 插件：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">aws-k8s-cni-cn.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">aws-k8s-cni-cn.yaml</span></span></code></pre></div><h2 id="_2-3-更新节点组" tabindex="-1">2.3 更新节点组 <a class="header-anchor" href="#_2-3-更新节点组" aria-label="Permalink to &quot;2.3 更新节点组&quot;">​</a></h2><p>通常使用的是 aws managed 的 node group ，在升级完 Control Plane 后，在 node group 设置页直接点击 “Update now” 即可。可以选择 rolling update 或者 force update ，rolling update 会先调度 pods 到新节点，因此不会中断业务，但是会更耗时。对 self-managed node group 需要创建新节点组，将应用程序/Pod 迁移到新节点组，然后删除旧节点组。</p><h1 id="_3-eks-升级后的检查" tabindex="-1">3. EKS 升级后的检查 <a class="header-anchor" href="#_3-eks-升级后的检查" aria-label="Permalink to &quot;3. EKS 升级后的检查&quot;">​</a></h1><p>需要检查：</p><ol><li>验证Control Plane 和节点组版本是否已更新。</li><li>检查插件的状态。</li><li>检查节点状态和版本。</li><li>检查应用是否正常。</li></ol><p>至此 AWS EKS 的版本升级就结束</p>`,72),p=[l];function t(c,r,y,E,i,d){return a(),n("div",null,p)}const h=s(e,[["render",t]]);export{u as __pageData,h as default};
