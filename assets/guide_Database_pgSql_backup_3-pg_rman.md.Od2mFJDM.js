import{_ as s,o as a,c as n,R as p}from"./chunks/framework.zUbWieqp.js";const B=JSON.parse('{"title":"1.pg_rman介绍","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/pgSql/backup/3-pg_rman.md","filePath":"guide/Database/pgSql/backup/3-pg_rman.md","lastUpdated":1711102301000}'),l={name:"guide/Database/pgSql/backup/3-pg_rman.md"},o=p(`<h1 id="_1-pg-rman介绍" tabindex="-1">1.pg_rman介绍 <a class="header-anchor" href="#_1-pg-rman介绍" aria-label="Permalink to &quot;1.pg_rman介绍&quot;">​</a></h1><p>​ <code>pg_rman（物理备份）</code>类似于oracle的rman备份策略，实现了全量、增量、归档的层级的备份，可以很灵活的管理PostgreSQL数据库的备份，pg_rman是一款开源的pg的备份恢复插件支持在线和基于PITR的备份恢复方式。</p><ul><li>特点</li></ul><p>○ 使用简单，一个命令即可完成备份和恢复.</p><p>○ 支持在线全备,增量备份，归档备份.</p><p>○ 支持备份压缩，通过gzip工具实现页内压缩.</p><p>○ 自动备份维护，自动删除过期的WAL备份文件.</p><p>○ 支持备份验证.</p><p>○ 恢复期间无事务丢失，支持基于PITR的配置文件生成器</p><ul><li>注意事项</li></ul><p>○ pg_rman 基于 pg_start_backup</p><p>○ pg_rman 基于需要在本地安装，跑的不是流复制协议，而是文件拷贝，所以pg_rman必须和数据库节点跑一起，不能远程备份</p><p>○ pg_rman 注意跟数据库版本配套</p><p>○ <code>随便指定一个存在的库，备份的是所有的物理文件</code></p><p>○ <code>时区一定保持一致，否则指定时间点恢复失败</code></p><p>○ <code>如果恢复一次数据库，之后必须在全备一次，否则不能进行增量备份</code></p><h1 id="_2-安装" tabindex="-1">2.安装 <a class="header-anchor" href="#_2-安装" aria-label="Permalink to &quot;2.安装&quot;">​</a></h1><ul><li>文档</li></ul><p>下载地址： <a href="https://github.com/ossc-db/pg_rman/" target="_blank" rel="noreferrer">https://github.com/ossc-db/pg_rman/</a></p><p>PostgreSQL Rpm相关依赖、插件包下载地址： <a href="https://yum.postgresql.org/10/redhat/rhel-6.7-x86_64/" target="_blank" rel="noreferrer">https://yum.postgresql.org/10/redhat/rhel-6.7-x86_64/</a></p><p>手册地址： <a href="http://ossc-db.github.io/pg_rman/index.html" target="_blank" rel="noreferrer">http://ossc-db.github.io/pg_rman/index.html</a></p><h2 id="_2-1配置环境变量" tabindex="-1">2.1配置环境变量 <a class="header-anchor" href="#_2-1配置环境变量" aria-label="Permalink to &quot;2.1配置环境变量&quot;">​</a></h2><blockquote><p>基于16实验</p></blockquote><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[ptgres@other </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]$vim .bashrc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> PGPORT</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">5532</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> PG_HOME</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/data/apps/pgsql/16</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> PATH</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">$PG_HOME</span><span style="color:#9ECBFF;">/bin:</span><span style="color:#E1E4E8;">$PATH</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> PGDATA</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/data/pgdata/data</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> LD_LIBRARY_PATH</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">$PG_HOME</span><span style="color:#9ECBFF;">/lib</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> LANG</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">en_US.utf8</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> BACKUP_PATH</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/home/ptgres/pg_rman_backups</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> SRVLOG_PATH</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/data/pgdata/data/log</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> ARCLOG_PATH</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/data/pgdata/archivedir</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[ptgres@other </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]$vim .bashrc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> PGPORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">5532</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> PG_HOME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/data/apps/pgsql/16</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> PATH</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">$PG_HOME</span><span style="color:#032F62;">/bin:</span><span style="color:#24292E;">$PATH</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> PGDATA</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/data/pgdata/data</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> LD_LIBRARY_PATH</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">$PG_HOME</span><span style="color:#032F62;">/lib</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> LANG</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">en_US.utf8</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> BACKUP_PATH</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/home/ptgres/pg_rman_backups</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> SRVLOG_PATH</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/data/pgdata/data/log</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> ARCLOG_PATH</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/data/pgdata/archivedir</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>环境一定的配置正确，否则，init的时候会出现报错</p><p>[ptgres@other ~]$ pg_rman init</p><p>pg_rman: logging.c:226: pg_log_generic_v: Assertion \`progname&#39; failed. Aborted (core dumped)</p></div><h2 id="_2-2下载" tabindex="-1">2.2下载 <a class="header-anchor" href="#_2-2下载" aria-label="Permalink to &quot;2.2下载&quot;">​</a></h2><p>wget <a href="https://github.com/ossc-db/pg_rman/releases/download/V1.3.16/pg_rman-1.3.16-pg16.tar.gz" target="_blank" rel="noreferrer">https://github.com/ossc-db/pg_rman/releases/download/V1.3.16/pg_rman-1.3.16-pg16.tar.gz</a></p><h2 id="_2-3安装" tabindex="-1">2.3安装 <a class="header-anchor" href="#_2-3安装" aria-label="Permalink to &quot;2.3安装&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#安装依赖</span></span>
<span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">zlib-devel</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#解压</span></span>
<span class="line"><span style="color:#B392F0;">tar</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">zxvf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_rman-1.3.16-pg16.tar.gz</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_rman-1.3.16-pg16</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#编译和安装，默认安装在pg下bin目录下</span></span>
<span class="line"><span style="color:#B392F0;">make</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">make</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#安装依赖</span></span>
<span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">zlib-devel</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#解压</span></span>
<span class="line"><span style="color:#6F42C1;">tar</span><span style="color:#24292E;"> </span><span style="color:#032F62;">zxvf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_rman-1.3.16-pg16.tar.gz</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_rman-1.3.16-pg16</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#编译和安装，默认安装在pg下bin目录下</span></span>
<span class="line"><span style="color:#6F42C1;">make</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">make</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span></span></code></pre></div><h2 id="_2-4初始化" tabindex="-1">2.4初始化 <a class="header-anchor" href="#_2-4初始化" aria-label="Permalink to &quot;2.4初始化&quot;">​</a></h2><ul><li>前提</li></ul><p>必须开启归档，否则失败</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">archive_mode = on		# enables archiving; off, on, or always</span></span>
<span class="line"><span style="color:#e1e4e8;">archive_command = &#39;test ! -f /postgresql/pgsql/archive_log/%f &amp;&amp; cp %p /postgresql/pgsql/archive_log/%f&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">archive_mode = on		# enables archiving; off, on, or always</span></span>
<span class="line"><span style="color:#24292e;">archive_command = &#39;test ! -f /postgresql/pgsql/archive_log/%f &amp;&amp; cp %p /postgresql/pgsql/archive_log/%f&#39;</span></span></code></pre></div><ul><li>初始化</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[ptgres@other </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]$ pg_rman init</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ARCLOG_PATH</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;/data/pgdata/archivedir&#39;</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">SRVLOG_PATH</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;/data/pgdata/data/log&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[ptgres@other </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]$ pg_rman init</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ARCLOG_PATH</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;/data/pgdata/archivedir&#39;</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">SRVLOG_PATH</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;/data/pgdata/data/log&#39;</span></span></code></pre></div><h1 id="_3-目录结构" tabindex="-1">3.目录结构 <a class="header-anchor" href="#_3-目录结构" aria-label="Permalink to &quot;3.目录结构&quot;">​</a></h1><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[ptgres@other pg_rman_backups]$ ll</span></span>
<span class="line"><span style="color:#e1e4e8;">total 8</span></span>
<span class="line"><span style="color:#e1e4e8;">drwx------ 4 ptgres ptgres 34 Mar 20 14:30 backup</span></span>
<span class="line"><span style="color:#e1e4e8;">-rw-rw-r-- 1 ptgres ptgres 75 Mar 20 14:30 pg_rman.ini</span></span>
<span class="line"><span style="color:#e1e4e8;">-rw-rw-r-- 1 ptgres ptgres 40 Mar 20 14:30 system_identifier</span></span>
<span class="line"><span style="color:#e1e4e8;">drwx------ 2 ptgres ptgres  6 Mar 20 14:30 timeline_history</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[ptgres@other pg_rman_backups]$ ll</span></span>
<span class="line"><span style="color:#24292e;">total 8</span></span>
<span class="line"><span style="color:#24292e;">drwx------ 4 ptgres ptgres 34 Mar 20 14:30 backup</span></span>
<span class="line"><span style="color:#24292e;">-rw-rw-r-- 1 ptgres ptgres 75 Mar 20 14:30 pg_rman.ini</span></span>
<span class="line"><span style="color:#24292e;">-rw-rw-r-- 1 ptgres ptgres 40 Mar 20 14:30 system_identifier</span></span>
<span class="line"><span style="color:#24292e;">drwx------ 2 ptgres ptgres  6 Mar 20 14:30 timeline_history</span></span></code></pre></div><h2 id="_3-1备份策略" tabindex="-1">3.1备份策略 <a class="header-anchor" href="#_3-1备份策略" aria-label="Permalink to &quot;3.1备份策略&quot;">​</a></h2><p>pg_rman.ini</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[ptgres@other pg_rman_backups]$ cat pg_rman.ini</span></span>
<span class="line"><span style="color:#6A737D;">#默认只有这两个</span></span>
<span class="line"><span style="color:#E1E4E8;">ARCLOG_PATH</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;/data/pgdata/archivedir&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">SRVLOG_PATH</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;/data/pgdata/data/log&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#14天的数据，每周进行一次全备，每周一和周三的2:00做一次增量备份，每天进行一次归档备份</span></span>
<span class="line"><span style="color:#B392F0;">COMPRESS_DATA</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">YES</span></span>
<span class="line"><span style="color:#E1E4E8;">KEEP_DATA_GENERATIONS</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">KEEP_DATA_DAYS</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">14</span></span>
<span class="line"><span style="color:#E1E4E8;">KEEP_ARCLOG_FILES</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">30</span></span>
<span class="line"><span style="color:#E1E4E8;">KEEP_ARCLOG_DAYS</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">20</span></span>
<span class="line"><span style="color:#E1E4E8;">KEEP_SRVLOG_FILES</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">           </span><span style="color:#6A737D;"># 保留最近10个日志文件(pg_log)  </span></span>
<span class="line"><span style="color:#E1E4E8;">KEEP_SRVLOG_DAYS</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">20</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[ptgres@other pg_rman_backups]$ cat pg_rman.ini</span></span>
<span class="line"><span style="color:#6A737D;">#默认只有这两个</span></span>
<span class="line"><span style="color:#24292E;">ARCLOG_PATH</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;/data/pgdata/archivedir&#39;</span></span>
<span class="line"><span style="color:#24292E;">SRVLOG_PATH</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;/data/pgdata/data/log&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#14天的数据，每周进行一次全备，每周一和周三的2:00做一次增量备份，每天进行一次归档备份</span></span>
<span class="line"><span style="color:#6F42C1;">COMPRESS_DATA</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">YES</span></span>
<span class="line"><span style="color:#24292E;">KEEP_DATA_GENERATIONS</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">KEEP_DATA_DAYS</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">14</span></span>
<span class="line"><span style="color:#24292E;">KEEP_ARCLOG_FILES</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">30</span></span>
<span class="line"><span style="color:#24292E;">KEEP_ARCLOG_DAYS</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">20</span></span>
<span class="line"><span style="color:#24292E;">KEEP_SRVLOG_FILES</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">           </span><span style="color:#6A737D;"># 保留最近10个日志文件(pg_log)  </span></span>
<span class="line"><span style="color:#24292E;">KEEP_SRVLOG_DAYS</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">20</span></span></code></pre></div><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>KEEP_DATA_GENERATIONS</td><td>需要全备份数</td></tr><tr><td>KEEP_DATA_DAYS</td><td>保留天数</td></tr><tr><td>KEEP_ARCLOG_DAYS</td><td>wal日志保留时长，比KEEP_DATA_DAYS多一天即可</td></tr><tr><td>KEEP_SRVLOG_DAYS</td><td>日志保留天数，单位天</td></tr></tbody></table><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202403201818186.png" alt="image-20240320181741623"></p><h2 id="_3-2backup-ini" tabindex="-1">3.2backup.ini <a class="header-anchor" href="#_3-2backup-ini" aria-label="Permalink to &quot;3.2backup.ini&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[ptgres@other </span><span style="color:#79B8FF;">181558</span><span style="color:#E1E4E8;">]$ cat backup.ini</span></span>
<span class="line"><span style="color:#6A737D;"># configuration</span></span>
<span class="line"><span style="color:#E1E4E8;">BACKUP_MODE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">FULL</span></span>
<span class="line"><span style="color:#E1E4E8;">FULL_BACKUP_ON_ERROR</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">WITH_SERVERLOG</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">COMPRESS_DATA</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#6A737D;"># result</span></span>
<span class="line"><span style="color:#E1E4E8;">TIMELINEID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">4</span></span>
<span class="line"><span style="color:#E1E4E8;">START_LSN</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/21000028</span></span>
<span class="line"><span style="color:#E1E4E8;">STOP_LSN</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/21000138</span></span>
<span class="line"><span style="color:#E1E4E8;">START_TIME</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;2024-03-20 18:15:58&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">END_TIME</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;2024-03-20 18:16:00&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">RECOVERY_XID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">762</span></span>
<span class="line"><span style="color:#E1E4E8;">RECOVERY_TIME</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;2024-03-20 18:16:00&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">TOTAL_DATA_BYTES</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">39632069</span></span>
<span class="line"><span style="color:#E1E4E8;">READ_DATA_BYTES</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">39631835</span></span>
<span class="line"><span style="color:#E1E4E8;">READ_ARCLOG_BYTES</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">201328288</span></span>
<span class="line"><span style="color:#E1E4E8;">WRITE_BYTES</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">226860821</span></span>
<span class="line"><span style="color:#E1E4E8;">BLOCK_SIZE</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">8192</span></span>
<span class="line"><span style="color:#E1E4E8;">XLOG_BLOCK_SIZE</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">8192</span></span>
<span class="line"><span style="color:#E1E4E8;">STATUS</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">DELETED</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[ptgres@other </span><span style="color:#005CC5;">181558</span><span style="color:#24292E;">]$ cat backup.ini</span></span>
<span class="line"><span style="color:#6A737D;"># configuration</span></span>
<span class="line"><span style="color:#24292E;">BACKUP_MODE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">FULL</span></span>
<span class="line"><span style="color:#24292E;">FULL_BACKUP_ON_ERROR</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">WITH_SERVERLOG</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">COMPRESS_DATA</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#6A737D;"># result</span></span>
<span class="line"><span style="color:#24292E;">TIMELINEID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">4</span></span>
<span class="line"><span style="color:#24292E;">START_LSN</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/21000028</span></span>
<span class="line"><span style="color:#24292E;">STOP_LSN</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/21000138</span></span>
<span class="line"><span style="color:#24292E;">START_TIME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;2024-03-20 18:15:58&#39;</span></span>
<span class="line"><span style="color:#24292E;">END_TIME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;2024-03-20 18:16:00&#39;</span></span>
<span class="line"><span style="color:#24292E;">RECOVERY_XID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">762</span></span>
<span class="line"><span style="color:#24292E;">RECOVERY_TIME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;2024-03-20 18:16:00&#39;</span></span>
<span class="line"><span style="color:#24292E;">TOTAL_DATA_BYTES</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">39632069</span></span>
<span class="line"><span style="color:#24292E;">READ_DATA_BYTES</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">39631835</span></span>
<span class="line"><span style="color:#24292E;">READ_ARCLOG_BYTES</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">201328288</span></span>
<span class="line"><span style="color:#24292E;">WRITE_BYTES</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">226860821</span></span>
<span class="line"><span style="color:#24292E;">BLOCK_SIZE</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8192</span></span>
<span class="line"><span style="color:#24292E;">XLOG_BLOCK_SIZE</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8192</span></span>
<span class="line"><span style="color:#24292E;">STATUS</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">DELETED</span></span></code></pre></div><p>LSN将用于比对增量备份时对比数据块的LSN是否发生了变化，是否需要备份</p><h1 id="_4-备份" tabindex="-1">4.备份 <a class="header-anchor" href="#_4-备份" aria-label="Permalink to &quot;4.备份&quot;">​</a></h1><h2 id="_4-1全备" tabindex="-1">4.1全备 <a class="header-anchor" href="#_4-1全备" aria-label="Permalink to &quot;4.1全备&quot;">​</a></h2><ul><li>随便指定一个存在的库，备份的是所有的物理文件，并且备份一次，<code>必须验证validate</code>，否则再次备份失败</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[ptgres@other </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]$ pg_rman backup -bf -C -Z -P -h 127.0.0.1 -p 5532 -U postgres -d testdb</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[ptgres@other </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]$ pg_rman backup -bf -C -Z -P -h 127.0.0.1 -p 5532 -U postgres -d testdb</span></span></code></pre></div><p>-b ---&gt;full(f) ,incremental(i), archive(a)</p><p>-C ----&gt;checkpoint</p><p>-Z ----&gt;压缩数据</p><p>-P ----&gt; 显示进度</p><ul><li>或者 都以参数形式</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">pg_rman</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\ </span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#B392F0;">-b</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">full</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\ </span><span style="color:#E1E4E8;">                         </span><span style="color:#6A737D;"># 全量备份   </span></span>
<span class="line"><span style="color:#B392F0;">-B</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data05/back/pgstdbak</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\ </span><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># 备份目录  </span></span>
<span class="line"><span style="color:#B392F0;">-D</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data04/back/pg_root_1922</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\ </span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 备库的$PGDATA  </span></span>
<span class="line"><span style="color:#B392F0;">-s</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\ </span><span style="color:#E1E4E8;">                              </span><span style="color:#6A737D;"># 备份pg_log  </span></span>
<span class="line"><span style="color:#B392F0;">-Z</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\ </span><span style="color:#E1E4E8;">                              </span><span style="color:#6A737D;"># 压缩  </span></span>
<span class="line"><span style="color:#E1E4E8;">--keep-data-generations</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">\\</span><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># 保留3个全量备份，删除不需要的全量备份  </span></span>
<span class="line"><span style="color:#E1E4E8;">--keep-data-days</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">\\</span><span style="color:#E1E4E8;">              </span><span style="color:#6A737D;"># 保证能恢复到10天内的任意时间点，删除不需要的  </span></span>
<span class="line"><span style="color:#E1E4E8;">--keep-arclog-files</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">\\</span><span style="color:#E1E4E8;">           </span><span style="color:#6A737D;"># 保留最近30个归档文件  </span></span>
<span class="line"><span style="color:#E1E4E8;">--keep-arclog-days</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">\\</span><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;"># 保留20天内的归档文件  </span></span>
<span class="line"><span style="color:#E1E4E8;">--keep-srvlog-files</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">\\</span><span style="color:#E1E4E8;">           </span><span style="color:#6A737D;"># 保留最近10个日志文件(pg_log)  </span></span>
<span class="line"><span style="color:#E1E4E8;">--keep-srvlog-days</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">\\</span><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;"># 保留20天内的日志文件(pg_log)  </span></span>
<span class="line"><span style="color:#E1E4E8;">--standby-host</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">\\</span><span style="color:#E1E4E8;">         </span><span style="color:#6A737D;"># 如何连接standby  </span></span>
<span class="line"><span style="color:#E1E4E8;">--standby-port</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1922</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">\\</span><span style="color:#E1E4E8;">              </span><span style="color:#6A737D;"># 如何连接standby  </span></span>
<span class="line"><span style="color:#B392F0;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\ </span><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;"># 如何连接primary  </span></span>
<span class="line"><span style="color:#B392F0;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1921</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\ </span><span style="color:#E1E4E8;">                         </span><span style="color:#6A737D;"># 如何连接primary  </span></span>
<span class="line"><span style="color:#B392F0;">-U</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\ </span><span style="color:#E1E4E8;">                     </span><span style="color:#6A737D;"># 如何连接primary, standby(超级用户)  </span></span>
<span class="line"><span style="color:#B392F0;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span><span style="color:#E1E4E8;">                        </span><span style="color:#6A737D;"># 如何连接primary, standby(database name)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">pg_rman</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\ </span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#6F42C1;">-b</span><span style="color:#24292E;"> </span><span style="color:#032F62;">full</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\ </span><span style="color:#24292E;">                         </span><span style="color:#6A737D;"># 全量备份   </span></span>
<span class="line"><span style="color:#6F42C1;">-B</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data05/back/pgstdbak</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\ </span><span style="color:#24292E;">      </span><span style="color:#6A737D;"># 备份目录  </span></span>
<span class="line"><span style="color:#6F42C1;">-D</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data04/back/pg_root_1922</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\ </span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 备库的$PGDATA  </span></span>
<span class="line"><span style="color:#6F42C1;">-s</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\ </span><span style="color:#24292E;">                              </span><span style="color:#6A737D;"># 备份pg_log  </span></span>
<span class="line"><span style="color:#6F42C1;">-Z</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\ </span><span style="color:#24292E;">                              </span><span style="color:#6A737D;"># 压缩  </span></span>
<span class="line"><span style="color:#24292E;">--keep-data-generations</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">\\</span><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 保留3个全量备份，删除不需要的全量备份  </span></span>
<span class="line"><span style="color:#24292E;">--keep-data-days</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">\\</span><span style="color:#24292E;">              </span><span style="color:#6A737D;"># 保证能恢复到10天内的任意时间点，删除不需要的  </span></span>
<span class="line"><span style="color:#24292E;">--keep-arclog-files</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">\\</span><span style="color:#24292E;">           </span><span style="color:#6A737D;"># 保留最近30个归档文件  </span></span>
<span class="line"><span style="color:#24292E;">--keep-arclog-days</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">\\</span><span style="color:#24292E;">            </span><span style="color:#6A737D;"># 保留20天内的归档文件  </span></span>
<span class="line"><span style="color:#24292E;">--keep-srvlog-files</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">\\</span><span style="color:#24292E;">           </span><span style="color:#6A737D;"># 保留最近10个日志文件(pg_log)  </span></span>
<span class="line"><span style="color:#24292E;">--keep-srvlog-days</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">\\</span><span style="color:#24292E;">            </span><span style="color:#6A737D;"># 保留20天内的日志文件(pg_log)  </span></span>
<span class="line"><span style="color:#24292E;">--standby-host</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">\\</span><span style="color:#24292E;">         </span><span style="color:#6A737D;"># 如何连接standby  </span></span>
<span class="line"><span style="color:#24292E;">--standby-port</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1922</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">\\</span><span style="color:#24292E;">              </span><span style="color:#6A737D;"># 如何连接standby  </span></span>
<span class="line"><span style="color:#6F42C1;">-h</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\ </span><span style="color:#24292E;">                    </span><span style="color:#6A737D;"># 如何连接primary  </span></span>
<span class="line"><span style="color:#6F42C1;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1921</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\ </span><span style="color:#24292E;">                         </span><span style="color:#6A737D;"># 如何连接primary  </span></span>
<span class="line"><span style="color:#6F42C1;">-U</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\ </span><span style="color:#24292E;">                     </span><span style="color:#6A737D;"># 如何连接primary, standby(超级用户)  </span></span>
<span class="line"><span style="color:#6F42C1;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span><span style="color:#24292E;">                        </span><span style="color:#6A737D;"># 如何连接primary, standby(database name)</span></span></code></pre></div><h2 id="_4-2增量备" tabindex="-1">4.2增量备 <a class="header-anchor" href="#_4-2增量备" aria-label="Permalink to &quot;4.2增量备&quot;">​</a></h2><p><strong>pg_rman最大的亮点就是实现了增量备份，注意不是基于WAL日志的增量备份，是基于上次全量备份之后发生的变化数据块的增量备份</strong></p><p>增量备份是基于文件系统的update time时间线，增量备份必须有个对应的全库备份</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[ptgres@other </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]$pg_rman backup -bi -C -Z -P -h 127.0.0.1 -p 5532 -U postgres -d testdb</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[ptgres@other </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]$pg_rman backup -bi -C -Z -P -h 127.0.0.1 -p 5532 -U postgres -d testdb</span></span></code></pre></div><h2 id="_4-3删除备份" tabindex="-1">4.3删除备份 <a class="header-anchor" href="#_4-3删除备份" aria-label="Permalink to &quot;4.3删除备份&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[ptgres@other </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]$ pg_rman show</span></span>
<span class="line"><span style="color:#E1E4E8;">=====================================================================</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">StartTime</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">EndTime</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">Mode</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Size</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">TLI</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Status</span></span>
<span class="line"><span style="color:#E1E4E8;">=====================================================================</span></span>
<span class="line"><span style="color:#B392F0;">2024-03-20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18</span><span style="color:#9ECBFF;">:15:58</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">2024</span><span style="color:#9ECBFF;">-03-20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18</span><span style="color:#9ECBFF;">:16:00</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">FULL</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">226</span><span style="color:#9ECBFF;">MB</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">OK</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#删除，虽然把备份删除掉了，但是一些备份信息仍然遗留在元数据中</span></span>
<span class="line"><span style="color:#E1E4E8;">[ptgres@other </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]$ pg_rman delete </span><span style="color:#9ECBFF;">&quot;2024-03-20 18:15:58&quot;</span><span style="color:#E1E4E8;"> -f</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看结果</span></span>
<span class="line"><span style="color:#E1E4E8;">[ptgres@other </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]$ pg_rman show</span></span>
<span class="line"><span style="color:#E1E4E8;">=====================================================================</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">StartTime</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">EndTime</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">Mode</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Size</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">TLI</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Status</span></span>
<span class="line"><span style="color:#E1E4E8;">=====================================================================</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看还没有删除的元数据</span></span>
<span class="line"><span style="color:#E1E4E8;">[ptgres@other </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]$ pg_rman show  -a</span></span>
<span class="line"><span style="color:#E1E4E8;">=====================================================================</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">StartTime</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">EndTime</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">Mode</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Size</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">TLI</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Status</span></span>
<span class="line"><span style="color:#E1E4E8;">=====================================================================</span></span>
<span class="line"><span style="color:#B392F0;">2024-03-20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18</span><span style="color:#9ECBFF;">:15:58</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">2024</span><span style="color:#9ECBFF;">-03-20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18</span><span style="color:#9ECBFF;">:16:00</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">FULL</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">226</span><span style="color:#9ECBFF;">MB</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">DELETED</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[ptgres@other </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]$ pg_rman show</span></span>
<span class="line"><span style="color:#24292E;">=====================================================================</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">StartTime</span><span style="color:#24292E;">           </span><span style="color:#032F62;">EndTime</span><span style="color:#24292E;">              </span><span style="color:#032F62;">Mode</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Size</span><span style="color:#24292E;">   </span><span style="color:#032F62;">TLI</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Status</span></span>
<span class="line"><span style="color:#24292E;">=====================================================================</span></span>
<span class="line"><span style="color:#6F42C1;">2024-03-20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18</span><span style="color:#032F62;">:15:58</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">2024</span><span style="color:#032F62;">-03-20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18</span><span style="color:#032F62;">:16:00</span><span style="color:#24292E;">  </span><span style="color:#032F62;">FULL</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">226</span><span style="color:#032F62;">MB</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">  </span><span style="color:#032F62;">OK</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#删除，虽然把备份删除掉了，但是一些备份信息仍然遗留在元数据中</span></span>
<span class="line"><span style="color:#24292E;">[ptgres@other </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]$ pg_rman delete </span><span style="color:#032F62;">&quot;2024-03-20 18:15:58&quot;</span><span style="color:#24292E;"> -f</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看结果</span></span>
<span class="line"><span style="color:#24292E;">[ptgres@other </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]$ pg_rman show</span></span>
<span class="line"><span style="color:#24292E;">=====================================================================</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">StartTime</span><span style="color:#24292E;">           </span><span style="color:#032F62;">EndTime</span><span style="color:#24292E;">              </span><span style="color:#032F62;">Mode</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Size</span><span style="color:#24292E;">   </span><span style="color:#032F62;">TLI</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Status</span></span>
<span class="line"><span style="color:#24292E;">=====================================================================</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看还没有删除的元数据</span></span>
<span class="line"><span style="color:#24292E;">[ptgres@other </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]$ pg_rman show  -a</span></span>
<span class="line"><span style="color:#24292E;">=====================================================================</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">StartTime</span><span style="color:#24292E;">           </span><span style="color:#032F62;">EndTime</span><span style="color:#24292E;">              </span><span style="color:#032F62;">Mode</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Size</span><span style="color:#24292E;">   </span><span style="color:#032F62;">TLI</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Status</span></span>
<span class="line"><span style="color:#24292E;">=====================================================================</span></span>
<span class="line"><span style="color:#6F42C1;">2024-03-20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18</span><span style="color:#032F62;">:15:58</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">2024</span><span style="color:#032F62;">-03-20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18</span><span style="color:#032F62;">:16:00</span><span style="color:#24292E;">  </span><span style="color:#032F62;">FULL</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">226</span><span style="color:#032F62;">MB</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">  </span><span style="color:#032F62;">DELETED</span></span></code></pre></div><p>各列含义解释：</p><p>Start : start time of backup</p><p>Time : total time of backup</p><p>Total : size of whole database cluster</p><p>Data : size of read data files</p><p>WAL : size of read WAL archive files</p><p>Log : size of read serverlog files</p><p>Backup: size of backup (= written size)</p><p>Status: status of backup. Possible values are:</p><p>OK : backup is done and validated.</p><p>DONE : backup is done, but not validated yet.</p><p>RUNNING : backup is running now.</p><p>DELETING : backup is being deleted now.</p><p>DELETED : backup has been deleted.</p><p>ERROR : backup is unavailable because some errors occur during backup.</p><p>CORRUPT : backup is unavailable because it is broken.</p><h1 id="_5-恢复" tabindex="-1">5.恢复 <a class="header-anchor" href="#_5-恢复" aria-label="Permalink to &quot;5.恢复&quot;">​</a></h1><h2 id="_5-1增量恢复" tabindex="-1">5.1增量恢复 <a class="header-anchor" href="#_5-1增量恢复" aria-label="Permalink to &quot;5.1增量恢复&quot;">​</a></h2><ul><li>--recovery-target-timeline TIMELINE <ul><li>指定恢复的时间线，如果没有指定，则用$PGDATA/global/pg_control)中的时间线。</li></ul></li><li>--recovery-target-time TIMESTAMP <ul><li>指定恢复到哪个时间。如果没有指定，则一直恢复到最后的时间。</li></ul></li><li>--recovery-target-xid XID <ul><li>指定恢复到哪个事务ID(XID)，如果没有指定，则一直恢复到最后的XID。</li></ul></li><li>--recovery-target-inclusive <ul><li>前面指定的恢复点(recovery-target-time、recovery-target-xid)，恢复时是刚好超过这个点，还是刚好在这个点之前停掉，默认是超过这个点（即设置为true的情况）</li></ul></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#恢复数据之前，需要停止数据库</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stop</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgresql</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看备份信息</span></span>
<span class="line"><span style="color:#E1E4E8;">[ptgres@other </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]$ pg_rman show</span></span>
<span class="line"><span style="color:#E1E4E8;">=====================================================================</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">StartTime</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">EndTime</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">Mode</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Size</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">TLI</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Status</span></span>
<span class="line"><span style="color:#E1E4E8;">=====================================================================</span></span>
<span class="line"><span style="color:#B392F0;">2024-03-20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">15</span><span style="color:#9ECBFF;">:18:02</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">2024</span><span style="color:#9ECBFF;">-03-20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">15</span><span style="color:#9ECBFF;">:18:04</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">INCR</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">50</span><span style="color:#9ECBFF;">MB</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">OK</span></span>
<span class="line"><span style="color:#B392F0;">2024-03-20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">15</span><span style="color:#9ECBFF;">:14:49</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">2024</span><span style="color:#9ECBFF;">-03-20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">15</span><span style="color:#9ECBFF;">:14:51</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">FULL</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">272</span><span style="color:#9ECBFF;">MB</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">OK</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#根据时间，开始恢复</span></span>
<span class="line"><span style="color:#E1E4E8;">[ptgres@other </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]$ pg_rman restore --recovery-target-time=</span><span style="color:#9ECBFF;">&#39;2024-03-20 15:18:02&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">recovery</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">target</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">timeline</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ID</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">given</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">timeline</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ID</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">of</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">current</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">recovery</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">target:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">calculating</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">timeline</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">branches</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">used</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">recovery</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">target</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">point</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">searching</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">latest</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">full</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">which</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">can</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">used</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restore</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">point</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">found</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">full</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">can</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">used</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">base</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">recovery:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;2024-03-20 15:14:49&quot;</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">copying</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">online</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">WAL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">files</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">files</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clearing</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restore</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">destination</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">validate:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;2024-03-20 15:14:49&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">archive</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">files</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">by</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">SIZE</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;2024-03-20 15:14:49&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">valid</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restoring</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">files</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">full</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mode</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;2024-03-20 15:14:49&quot;</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">searching</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">incremental</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restored</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">searching</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">which</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">contained</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">archived</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">WAL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">files</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restored</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;2024-03-20 15:14:49&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">valid</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restoring</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">WAL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">files</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;2024-03-20 15:14:49&quot;</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;2024-03-20 15:18:02&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">valid</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restoring</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">WAL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">files</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;2024-03-20 15:18:02&quot;</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restoring</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">online</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">WAL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">files</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">files</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_rman_recovery.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">recovery-related</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">parameters.</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">remove</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">an</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;include&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">directive</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">added</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">by</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_rman</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgresql.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exists</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">append</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">an</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;include&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">directive</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgresql.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_rman_recovery.conf</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">generating</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">recovery.signal</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">removing</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby.signal</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exists</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restore</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">primary</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restore</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">complete</span></span>
<span class="line"><span style="color:#B392F0;">HINT:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Recovery</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">will</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">automatically</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PostgreSQL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">started.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">After</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">recovery</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">done,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">we</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">recommend</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">remove</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">recovery-related</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">parameters</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">configured</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">by</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_rman.</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#--hard-copy 但经测试该参数无效，结果均为实际拷贝，所以加不加无所谓</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#启动数据库</span></span>
<span class="line"><span style="color:#E1E4E8;">[ptgres@other </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]$ pg_ctl start</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#登录数据库，此时的数据库状态是recovery，不能创建数据</span></span>
<span class="line"><span style="color:#E1E4E8;">[ptgres@other </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]$ psql -h 127.0.0.1 -U postgres -p 5532</span></span>
<span class="line"><span style="color:#B392F0;">psql</span><span style="color:#E1E4E8;"> (16.0)</span></span>
<span class="line"><span style="color:#B392F0;">Type</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;help&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">help.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">#</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看状态，数据库处于 read-only状态,或者 启动数据库实例前在postgresql.conf中添加recovery_target_action=&#39;promote&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">#</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg_is_in_recovery</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg_is_in_recovery</span></span>
<span class="line"><span style="color:#B392F0;">-------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">f</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">row</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#解除状态</span></span>
<span class="line"><span style="color:#6A737D;">#查找函数</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">#</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">\\df</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">*</span><span style="color:#9ECBFF;">resume</span><span style="color:#79B8FF;">*</span></span>
<span class="line"><span style="color:#E1E4E8;">                                 </span><span style="color:#B392F0;">List</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">of</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">functions</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">Schema</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">         </span><span style="color:#B392F0;">Name</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Result</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">data</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Argument</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">data</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">types</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Type</span></span>
<span class="line"><span style="color:#B392F0;">------------+----------------------+------------------+---------------------+------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg_catalog</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg_wal_replay_resume</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">void</span><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">                     </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">func</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">row</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">#</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg_wal_replay_resume</span><span style="color:#E1E4E8;">() ;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#再次查看状态,f-----&gt;t 可用</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres=# select pg_is_in_recovery();</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg_is_in_recovery</span></span>
<span class="line"><span style="color:#B392F0;">-------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">t</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">row</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#恢复数据之前，需要停止数据库</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgresql</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看备份信息</span></span>
<span class="line"><span style="color:#24292E;">[ptgres@other </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]$ pg_rman show</span></span>
<span class="line"><span style="color:#24292E;">=====================================================================</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">StartTime</span><span style="color:#24292E;">           </span><span style="color:#032F62;">EndTime</span><span style="color:#24292E;">              </span><span style="color:#032F62;">Mode</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Size</span><span style="color:#24292E;">   </span><span style="color:#032F62;">TLI</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Status</span></span>
<span class="line"><span style="color:#24292E;">=====================================================================</span></span>
<span class="line"><span style="color:#6F42C1;">2024-03-20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">15</span><span style="color:#032F62;">:18:02</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">2024</span><span style="color:#032F62;">-03-20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">15</span><span style="color:#032F62;">:18:04</span><span style="color:#24292E;">  </span><span style="color:#032F62;">INCR</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">50</span><span style="color:#032F62;">MB</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">  </span><span style="color:#032F62;">OK</span></span>
<span class="line"><span style="color:#6F42C1;">2024-03-20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">15</span><span style="color:#032F62;">:14:49</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">2024</span><span style="color:#032F62;">-03-20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">15</span><span style="color:#032F62;">:14:51</span><span style="color:#24292E;">  </span><span style="color:#032F62;">FULL</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">272</span><span style="color:#032F62;">MB</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">  </span><span style="color:#032F62;">OK</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#根据时间，开始恢复</span></span>
<span class="line"><span style="color:#24292E;">[ptgres@other </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]$ pg_rman restore --recovery-target-time=</span><span style="color:#032F62;">&#39;2024-03-20 15:18:02&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">recovery</span><span style="color:#24292E;"> </span><span style="color:#032F62;">target</span><span style="color:#24292E;"> </span><span style="color:#032F62;">timeline</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ID</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">not</span><span style="color:#24292E;"> </span><span style="color:#032F62;">given</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">use</span><span style="color:#24292E;"> </span><span style="color:#032F62;">timeline</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ID</span><span style="color:#24292E;"> </span><span style="color:#032F62;">of</span><span style="color:#24292E;"> </span><span style="color:#032F62;">current</span><span style="color:#24292E;"> </span><span style="color:#032F62;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster</span><span style="color:#24292E;"> </span><span style="color:#032F62;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">recovery</span><span style="color:#24292E;"> </span><span style="color:#032F62;">target:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">calculating</span><span style="color:#24292E;"> </span><span style="color:#032F62;">timeline</span><span style="color:#24292E;"> </span><span style="color:#032F62;">branches</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">used</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">recovery</span><span style="color:#24292E;"> </span><span style="color:#032F62;">target</span><span style="color:#24292E;"> </span><span style="color:#032F62;">point</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">searching</span><span style="color:#24292E;"> </span><span style="color:#032F62;">latest</span><span style="color:#24292E;"> </span><span style="color:#032F62;">full</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">which</span><span style="color:#24292E;"> </span><span style="color:#032F62;">can</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">used</span><span style="color:#24292E;"> </span><span style="color:#032F62;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restore</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">point</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">found</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">full</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">can</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">used</span><span style="color:#24292E;"> </span><span style="color:#032F62;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">base</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">recovery:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;2024-03-20 15:14:49&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">copying</span><span style="color:#24292E;"> </span><span style="color:#032F62;">online</span><span style="color:#24292E;"> </span><span style="color:#032F62;">WAL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">files</span><span style="color:#24292E;"> </span><span style="color:#032F62;">and</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">log</span><span style="color:#24292E;"> </span><span style="color:#032F62;">files</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clearing</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restore</span><span style="color:#24292E;"> </span><span style="color:#032F62;">destination</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">validate:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;2024-03-20 15:14:49&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">and</span><span style="color:#24292E;"> </span><span style="color:#032F62;">archive</span><span style="color:#24292E;"> </span><span style="color:#032F62;">log</span><span style="color:#24292E;"> </span><span style="color:#032F62;">files</span><span style="color:#24292E;"> </span><span style="color:#032F62;">by</span><span style="color:#24292E;"> </span><span style="color:#032F62;">SIZE</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;2024-03-20 15:14:49&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">valid</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restoring</span><span style="color:#24292E;"> </span><span style="color:#032F62;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">files</span><span style="color:#24292E;"> </span><span style="color:#032F62;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">full</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mode</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;2024-03-20 15:14:49&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">searching</span><span style="color:#24292E;"> </span><span style="color:#032F62;">incremental</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restored</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">searching</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">which</span><span style="color:#24292E;"> </span><span style="color:#032F62;">contained</span><span style="color:#24292E;"> </span><span style="color:#032F62;">archived</span><span style="color:#24292E;"> </span><span style="color:#032F62;">WAL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">files</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restored</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;2024-03-20 15:14:49&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">valid</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restoring</span><span style="color:#24292E;"> </span><span style="color:#032F62;">WAL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">files</span><span style="color:#24292E;"> </span><span style="color:#032F62;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;2024-03-20 15:14:49&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;2024-03-20 15:18:02&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">valid</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restoring</span><span style="color:#24292E;"> </span><span style="color:#032F62;">WAL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">files</span><span style="color:#24292E;"> </span><span style="color:#032F62;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;2024-03-20 15:18:02&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restoring</span><span style="color:#24292E;"> </span><span style="color:#032F62;">online</span><span style="color:#24292E;"> </span><span style="color:#032F62;">WAL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">files</span><span style="color:#24292E;"> </span><span style="color:#032F62;">and</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">log</span><span style="color:#24292E;"> </span><span style="color:#032F62;">files</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_rman_recovery.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">recovery-related</span><span style="color:#24292E;"> </span><span style="color:#032F62;">parameters.</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">remove</span><span style="color:#24292E;"> </span><span style="color:#032F62;">an</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;include&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">directive</span><span style="color:#24292E;"> </span><span style="color:#032F62;">added</span><span style="color:#24292E;"> </span><span style="color:#032F62;">by</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_rman</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgresql.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">if</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exists</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">append</span><span style="color:#24292E;"> </span><span style="color:#032F62;">an</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;include&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">directive</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgresql.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_rman_recovery.conf</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">generating</span><span style="color:#24292E;"> </span><span style="color:#032F62;">recovery.signal</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">removing</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby.signal</span><span style="color:#24292E;"> </span><span style="color:#032F62;">if</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exists</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restore</span><span style="color:#24292E;"> </span><span style="color:#032F62;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">primary</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restore</span><span style="color:#24292E;"> </span><span style="color:#032F62;">complete</span></span>
<span class="line"><span style="color:#6F42C1;">HINT:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Recovery</span><span style="color:#24292E;"> </span><span style="color:#032F62;">will</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">automatically</span><span style="color:#24292E;"> </span><span style="color:#032F62;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PostgreSQL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">started.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">After</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">recovery</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">done,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">we</span><span style="color:#24292E;"> </span><span style="color:#032F62;">recommend</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">remove</span><span style="color:#24292E;"> </span><span style="color:#032F62;">recovery-related</span><span style="color:#24292E;"> </span><span style="color:#032F62;">parameters</span><span style="color:#24292E;"> </span><span style="color:#032F62;">configured</span><span style="color:#24292E;"> </span><span style="color:#032F62;">by</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_rman.</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#--hard-copy 但经测试该参数无效，结果均为实际拷贝，所以加不加无所谓</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#启动数据库</span></span>
<span class="line"><span style="color:#24292E;">[ptgres@other </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]$ pg_ctl start</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#登录数据库，此时的数据库状态是recovery，不能创建数据</span></span>
<span class="line"><span style="color:#24292E;">[ptgres@other </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]$ psql -h 127.0.0.1 -U postgres -p 5532</span></span>
<span class="line"><span style="color:#6F42C1;">psql</span><span style="color:#24292E;"> (16.0)</span></span>
<span class="line"><span style="color:#6F42C1;">Type</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;help&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">help.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">#</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看状态，数据库处于 read-only状态,或者 启动数据库实例前在postgresql.conf中添加recovery_target_action=&#39;promote&#39;</span></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">#</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg_is_in_recovery</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg_is_in_recovery</span></span>
<span class="line"><span style="color:#6F42C1;">-------------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">f</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">row</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#解除状态</span></span>
<span class="line"><span style="color:#6A737D;">#查找函数</span></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">#</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">\\df</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">*</span><span style="color:#032F62;">resume</span><span style="color:#005CC5;">*</span></span>
<span class="line"><span style="color:#24292E;">                                 </span><span style="color:#6F42C1;">List</span><span style="color:#24292E;"> </span><span style="color:#032F62;">of</span><span style="color:#24292E;"> </span><span style="color:#032F62;">functions</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">Schema</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">         </span><span style="color:#6F42C1;">Name</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Result</span><span style="color:#24292E;"> </span><span style="color:#032F62;">data</span><span style="color:#24292E;"> </span><span style="color:#032F62;">type</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Argument</span><span style="color:#24292E;"> </span><span style="color:#032F62;">data</span><span style="color:#24292E;"> </span><span style="color:#032F62;">types</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Type</span></span>
<span class="line"><span style="color:#6F42C1;">------------+----------------------+------------------+---------------------+------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg_catalog</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg_wal_replay_resume</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">void</span><span style="color:#24292E;">             </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">                     </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">func</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">row</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">#</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg_wal_replay_resume</span><span style="color:#24292E;">() ;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#再次查看状态,f-----&gt;t 可用</span></span>
<span class="line"><span style="color:#24292E;">postgres=# select pg_is_in_recovery();</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg_is_in_recovery</span></span>
<span class="line"><span style="color:#6F42C1;">-------------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">t</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">row</span><span style="color:#24292E;">)</span></span></code></pre></div><h1 id="_6-备库中备份" tabindex="-1">6.备库中备份 <a class="header-anchor" href="#_6-备库中备份" aria-label="Permalink to &quot;6.备库中备份&quot;">​</a></h1><p>pg_rman支持在备库的节点做备份，这样可以减少对主库的IO压力。pg_rman在备库上做备份，也需要连接主库中，执行一些操作。另需要在备库中打开归档，即在postgresql.conf文件中做如下配置：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">archive_mode = always</span></span>
<span class="line"><span style="color:#e1e4e8;">archive_command = &#39;test ! -f /home/postgres/pgarch/%f &amp;&amp; cp %p /home/postgres/pgarch/%f&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">archive_mode = always</span></span>
<span class="line"><span style="color:#24292e;">archive_command = &#39;test ! -f /home/postgres/pgarch/%f &amp;&amp; cp %p /home/postgres/pgarch/%f&#39;</span></span></code></pre></div><p>注意在备库中打开归档需要<code>archive_mode = always</code>，而不是<code>archive_mode = on</code>，因为<code>archive_mode=on</code>只在主库上生效，在备库上不生效。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_rman.ini</span></span>
<span class="line"><span style="color:#6A737D;">#添加从库信息</span></span>
<span class="line"><span style="color:#E1E4E8;">STANDBY_HOST</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.6.16</span></span>
<span class="line"><span style="color:#E1E4E8;">STANDBY_PORT</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">5432</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#如果提示需要输入密码，可以把密码设置到环境变量中</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> PGPASSWORD</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">*******</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">pg_rman</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-bf</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--host=192.168.6.15</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_rman.ini</span></span>
<span class="line"><span style="color:#6A737D;">#添加从库信息</span></span>
<span class="line"><span style="color:#24292E;">STANDBY_HOST</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.6.16</span></span>
<span class="line"><span style="color:#24292E;">STANDBY_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">5432</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#如果提示需要输入密码，可以把密码设置到环境变量中</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> PGPASSWORD</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">*******</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">pg_rman</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-bf</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--host=192.168.6.15</span></span></code></pre></div><h1 id="_7-案例" tabindex="-1">7.案例 <a class="header-anchor" href="#_7-案例" aria-label="Permalink to &quot;7.案例&quot;">​</a></h1><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#创建表</span></span>
<span class="line"><span style="color:#B392F0;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">table</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">test16</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">id</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">int,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">info</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">text</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#插入数据</span></span>
<span class="line"><span style="color:#B392F0;">insert</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">into</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">test16</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">n,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">n</span><span style="color:#F97583;">||</span><span style="color:#B392F0;">&#39;info&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">generate_series</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">1,10</span><span style="color:#E1E4E8;">) </span><span style="color:#9ECBFF;">n</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#切下point</span></span>
<span class="line"><span style="color:#B392F0;">checkpoint</span><span style="color:#E1E4E8;"> ;</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_switch_wal();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#rman 初始化</span></span>
<span class="line"><span style="color:#B392F0;">pg_rman</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">init</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#rman 开始全备</span></span>
<span class="line"><span style="color:#B392F0;">pg_rman</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-bf</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-C</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-P</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5532</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-U</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">testdb</span></span>
<span class="line"><span style="color:#B392F0;">pg_rman</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">validate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#再次创建表数据</span></span>
<span class="line"><span style="color:#B392F0;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">table</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">test17</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">id</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">int,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">info</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">text</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#B392F0;">insert</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">into</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">test17</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">n,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">n</span><span style="color:#F97583;">||</span><span style="color:#B392F0;">&#39;info&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">generate_series</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">1,10</span><span style="color:#E1E4E8;">) </span><span style="color:#9ECBFF;">n</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#B392F0;">checkpoint</span><span style="color:#E1E4E8;"> ;</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_switch_wal();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#rman 开始增量</span></span>
<span class="line"><span style="color:#B392F0;">pg_rman</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-bi</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-C</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-P</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5532</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-U</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">testdb</span></span>
<span class="line"><span style="color:#B392F0;">pg_rman</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">validate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#模拟数据丢失</span></span>
<span class="line"><span style="color:#6A737D;">#删除表</span></span>
<span class="line"><span style="color:#B392F0;">drop</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">table</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">test17</span><span style="color:#E1E4E8;"> ; </span></span>
<span class="line"><span style="color:#B392F0;">\\q</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#开始恢复</span></span>
<span class="line"><span style="color:#B392F0;">看标题5</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#创建表</span></span>
<span class="line"><span style="color:#6F42C1;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">table</span><span style="color:#24292E;"> </span><span style="color:#032F62;">test16</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">id</span><span style="color:#24292E;"> </span><span style="color:#032F62;">int,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">info</span><span style="color:#24292E;"> </span><span style="color:#032F62;">text</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#插入数据</span></span>
<span class="line"><span style="color:#6F42C1;">insert</span><span style="color:#24292E;"> </span><span style="color:#032F62;">into</span><span style="color:#24292E;"> </span><span style="color:#032F62;">test16</span><span style="color:#24292E;"> </span><span style="color:#032F62;">select</span><span style="color:#24292E;"> </span><span style="color:#032F62;">n,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">n</span><span style="color:#D73A49;">||</span><span style="color:#6F42C1;">&#39;info&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">generate_series</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">1,10</span><span style="color:#24292E;">) </span><span style="color:#032F62;">n</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#切下point</span></span>
<span class="line"><span style="color:#6F42C1;">checkpoint</span><span style="color:#24292E;"> ;</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_switch_wal();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#rman 初始化</span></span>
<span class="line"><span style="color:#6F42C1;">pg_rman</span><span style="color:#24292E;"> </span><span style="color:#032F62;">init</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#rman 开始全备</span></span>
<span class="line"><span style="color:#6F42C1;">pg_rman</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-bf</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-C</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-P</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5532</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-U</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">testdb</span></span>
<span class="line"><span style="color:#6F42C1;">pg_rman</span><span style="color:#24292E;"> </span><span style="color:#032F62;">validate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#再次创建表数据</span></span>
<span class="line"><span style="color:#6F42C1;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">table</span><span style="color:#24292E;"> </span><span style="color:#032F62;">test17</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">id</span><span style="color:#24292E;"> </span><span style="color:#032F62;">int,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">info</span><span style="color:#24292E;"> </span><span style="color:#032F62;">text</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6F42C1;">insert</span><span style="color:#24292E;"> </span><span style="color:#032F62;">into</span><span style="color:#24292E;"> </span><span style="color:#032F62;">test17</span><span style="color:#24292E;"> </span><span style="color:#032F62;">select</span><span style="color:#24292E;"> </span><span style="color:#032F62;">n,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">n</span><span style="color:#D73A49;">||</span><span style="color:#6F42C1;">&#39;info&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">generate_series</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">1,10</span><span style="color:#24292E;">) </span><span style="color:#032F62;">n</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#6F42C1;">checkpoint</span><span style="color:#24292E;"> ;</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_switch_wal();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#rman 开始增量</span></span>
<span class="line"><span style="color:#6F42C1;">pg_rman</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-bi</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-C</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-P</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5532</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-U</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">testdb</span></span>
<span class="line"><span style="color:#6F42C1;">pg_rman</span><span style="color:#24292E;"> </span><span style="color:#032F62;">validate</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#模拟数据丢失</span></span>
<span class="line"><span style="color:#6A737D;">#删除表</span></span>
<span class="line"><span style="color:#6F42C1;">drop</span><span style="color:#24292E;"> </span><span style="color:#032F62;">table</span><span style="color:#24292E;"> </span><span style="color:#032F62;">test17</span><span style="color:#24292E;"> ; </span></span>
<span class="line"><span style="color:#6F42C1;">\\q</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#开始恢复</span></span>
<span class="line"><span style="color:#6F42C1;">看标题5</span></span></code></pre></div>`,88),e=[o];function t(c,r,E,y,F,i){return a(),n("div",null,e)}const d=s(l,[["render",t]]);export{B as __pageData,d as default};
