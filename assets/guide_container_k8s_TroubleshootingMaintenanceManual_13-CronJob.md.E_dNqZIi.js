import{_ as s,o as n,c as a,R as p}from"./chunks/framework.zUbWieqp.js";const d=JSON.parse('{"title":"1.etcd备份","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/TroubleshootingMaintenanceManual/13-CronJob.md","filePath":"guide/container/k8s/TroubleshootingMaintenanceManual/13-CronJob.md","lastUpdated":1727076307000}'),l={name:"guide/container/k8s/TroubleshootingMaintenanceManual/13-CronJob.md"},o=p(`<h1 id="_1-etcd备份" tabindex="-1">1.etcd备份 <a class="header-anchor" href="#_1-etcd备份" aria-label="Permalink to &quot;1.etcd备份&quot;">​</a></h1><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd-backup-cronjob.yaml</span></span>
<span class="line"><span style="color:#B392F0;">apiVersion:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">batch/v1</span></span>
<span class="line"><span style="color:#B392F0;">kind:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CronJob</span></span>
<span class="line"><span style="color:#B392F0;">metadata:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd-backup-cronjob</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">namespace:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">default</span></span>
<span class="line"><span style="color:#B392F0;">spec:</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">schedule:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;* * * * *&quot;</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 为了测试改为每分钟执行备份</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">jobTemplate:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">spec:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">template:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">metadata:</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#B392F0;">labels:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">app:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd-backup-cronjob</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">spec:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">containers:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">image:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker.io/bitnami/etcd:3.5.4-debian-10-r25</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">command</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sh</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-c</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;etcdctl --endpoints </span><span style="color:#E1E4E8;">$ENDPOINT</span><span style="color:#9ECBFF;"> --user </span><span style="color:#E1E4E8;">$USER</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;">$PASSWORD</span><span style="color:#9ECBFF;"> snapshot save /snapshot/$(</span><span style="color:#B392F0;">date</span><span style="color:#9ECBFF;"> +%Y%m%d_%H%M%S)_snapshot.db&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">env:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">USER</span><span style="color:#E1E4E8;">     </span><span style="color:#6A737D;"># etcd 用户</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">value:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PASSWORD</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># etcd 用户密码</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">value:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">qYKH9wUBch</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ENDPOINT</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">value:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;192.168.1.12:32379&quot;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># ETCD的客户端地址</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">volumeMounts:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mountPath:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/snapshot&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#B392F0;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">snapshot</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#B392F0;">subPath:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">data/etcd-snapshot</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">restartPolicy:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">OnFailure</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">volumes:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">snapshot</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">persistentVolumeClaim:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#B392F0;">claimName:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd-backup-pvc</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 指定创建好的PVC</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">hostNetwork:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd-backup-cronjob.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">apiVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">batch/v1</span></span>
<span class="line"><span style="color:#6F42C1;">kind:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CronJob</span></span>
<span class="line"><span style="color:#6F42C1;">metadata:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd-backup-cronjob</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">namespace:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">default</span></span>
<span class="line"><span style="color:#6F42C1;">spec:</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">schedule:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;* * * * *&quot;</span><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 为了测试改为每分钟执行备份</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">jobTemplate:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">spec:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">template:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">metadata:</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#6F42C1;">labels:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">app:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd-backup-cronjob</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">spec:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">containers:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">image:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker.io/bitnami/etcd:3.5.4-debian-10-r25</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#005CC5;">command</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sh</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-c</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;etcdctl --endpoints </span><span style="color:#24292E;">$ENDPOINT</span><span style="color:#032F62;"> --user </span><span style="color:#24292E;">$USER</span><span style="color:#032F62;">:</span><span style="color:#24292E;">$PASSWORD</span><span style="color:#032F62;"> snapshot save /snapshot/$(</span><span style="color:#6F42C1;">date</span><span style="color:#032F62;"> +%Y%m%d_%H%M%S)_snapshot.db&quot;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">env:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">USER</span><span style="color:#24292E;">     </span><span style="color:#6A737D;"># etcd 用户</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">value:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PASSWORD</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># etcd 用户密码</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">value:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">qYKH9wUBch</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ENDPOINT</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">value:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;192.168.1.12:32379&quot;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># ETCD的客户端地址</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">volumeMounts:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mountPath:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/snapshot&quot;</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#6F42C1;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">snapshot</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#6F42C1;">subPath:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">data/etcd-snapshot</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">restartPolicy:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">OnFailure</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">volumes:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">snapshot</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">persistentVolumeClaim:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#6F42C1;">claimName:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd-backup-pvc</span><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 指定创建好的PVC</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">hostNetwork:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span></span></code></pre></div>`,2),e=[o];function c(t,r,E,y,F,i){return n(),a("div",null,e)}const B=s(l,[["render",c]]);export{d as __pageData,B as default};
