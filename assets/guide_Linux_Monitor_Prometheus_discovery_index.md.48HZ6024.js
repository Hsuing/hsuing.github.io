import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const _=JSON.parse('{"title":"1. 服务发现","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Linux/Monitor/Prometheus/discovery/index.md","filePath":"guide/Linux/Monitor/Prometheus/discovery/index.md","lastUpdated":1736935968000}'),p={name:"guide/Linux/Monitor/Prometheus/discovery/index.md"},o=l(`<h1 id="_1-服务发现" tabindex="-1">1. 服务发现 <a class="header-anchor" href="#_1-服务发现" aria-label="Permalink to &quot;1. 服务发现&quot;">​</a></h1><h2 id="_1-1-静态方式" tabindex="-1">1.1 静态方式 <a class="header-anchor" href="#_1-1-静态方式" aria-label="Permalink to &quot;1.1 静态方式&quot;">​</a></h2><p>直接手动添加，机器量少还能接受，机器量大，此方法不可取</p><h2 id="_1-2-动态方式" tabindex="-1">1.2 动态方式 <a class="header-anchor" href="#_1-2-动态方式" aria-label="Permalink to &quot;1.2 动态方式&quot;">​</a></h2><p><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#file_sd_config" target="_blank" rel="noreferrer">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#file_sd_config</a></p><h3 id="_1-文件服务发现" tabindex="-1">1.文件服务发现 <a class="header-anchor" href="#_1-文件服务发现" aria-label="Permalink to &quot;1.文件服务发现&quot;">​</a></h3><p>添加的配置可以是json或者yaml格式的,<code>推荐使用yaml格式的</code></p><ul><li>默认配置文件</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># Patterns for files from which target groups are extracted.</span></span>
<span class="line"><span style="color:#85E89D;">files</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  [ - </span><span style="color:#9ECBFF;">&lt;filename_pattern&gt; ...</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Refresh interval to re-read the files.</span></span>
<span class="line"><span style="color:#E1E4E8;">[ </span><span style="color:#85E89D;">refresh_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&lt;duration&gt; | default = 5m</span><span style="color:#E1E4E8;"> ]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># Patterns for files from which target groups are extracted.</span></span>
<span class="line"><span style="color:#22863A;">files</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  [ - </span><span style="color:#032F62;">&lt;filename_pattern&gt; ...</span><span style="color:#24292E;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Refresh interval to re-read the files.</span></span>
<span class="line"><span style="color:#24292E;">[ </span><span style="color:#22863A;">refresh_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&lt;duration&gt; | default = 5m</span><span style="color:#24292E;"> ]</span></span></code></pre></div><ul><li>创建targets目录</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/apps/prometheus/targets/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/apps/prometheus/targets/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span></span></code></pre></div><ul><li>创建black_export.yml</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#79B8FF;">192.168.5.254</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#005CC5;">192.168.5.254</span></span></code></pre></div><ul><li>完整配置</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">global</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">scrape_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">15s</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">scrape_timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10s</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">evaluation_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">15s</span></span>
<span class="line"><span style="color:#85E89D;">scrape_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;black_export&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">file_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">refresh_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">files</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">targets/black_export.yml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">global</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">scrape_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">15s</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">scrape_timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10s</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">evaluation_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">15s</span></span>
<span class="line"><span style="color:#22863A;">scrape_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;black_export&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">file_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">refresh_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">files</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">targets/black_export.yml</span></span></code></pre></div><h4 id="node-exporter" tabindex="-1">node_exporter <a class="header-anchor" href="#node-exporter" aria-label="Permalink to &quot;node_exporter&quot;">​</a></h4><ul><li>创建targets文件targets.yml</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#9ECBFF;">targets:[&#39;node_exporter:9100&#39;]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">instance：Prometheus服务器</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">job:node-exporter</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#032F62;">targets:[&#39;node_exporter:9100&#39;]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">instance：Prometheus服务器</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">job:node-exporter</span></span></code></pre></div><p>依次往下添加即可</p><ul><li>完整配置</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">global</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">scrape_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">15s</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">scrape_timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10s</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">evaluation_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">15s</span></span>
<span class="line"><span style="color:#85E89D;">scrape_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;"> : </span><span style="color:#9ECBFF;">&#39;file_sd_targets&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">file_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">refresh_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">files</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">targets/targets.yml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">global</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">scrape_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">15s</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">scrape_timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10s</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">evaluation_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">15s</span></span>
<span class="line"><span style="color:#22863A;">scrape_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;"> : </span><span style="color:#032F62;">&#39;file_sd_targets&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">file_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">refresh_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">files</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">targets/targets.yml</span></span></code></pre></div><h4 id="blackbox" tabindex="-1">blackbox <a class="header-anchor" href="#blackbox" aria-label="Permalink to &quot;blackbox&quot;">​</a></h4><h5 id="icmp" tabindex="-1">icmp <a class="header-anchor" href="#icmp" aria-label="Permalink to &quot;icmp&quot;">​</a></h5><ul><li>配置prometheus</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;blackbox-icmp&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/probe</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">params</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">module</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">icmp_ipv4</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#79B8FF;">192.168.0.1</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#79B8FF;">192.168.0.3</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__address__</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__param_target</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__param_target</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">instance</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">127.0.0.1:9115</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;blackbox-icmp&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/probe</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">params</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">module</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">icmp_ipv4</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#005CC5;">192.168.0.1</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#005CC5;">192.168.0.3</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__address__</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__param_target</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__param_target</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">instance</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">127.0.0.1:9115</span></span></code></pre></div><ul><li>配置blackbox</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">## ----------- ICMP 检测配置 -----------</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">icmp</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">prober</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">icmp</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">5s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">icmp</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">preferred_ip_protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;ip4&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 默认是 ip6</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">## ----------- ICMP 检测配置 -----------</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">icmp</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">prober</span><span style="color:#24292E;">: </span><span style="color:#032F62;">icmp</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">5s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">icmp</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">preferred_ip_protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;ip4&quot;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 默认是 ip6</span></span></code></pre></div><h5 id="tcp" tabindex="-1">tcp <a class="header-anchor" href="#tcp" aria-label="Permalink to &quot;tcp&quot;">​</a></h5><ul><li>配置prometheus</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;blackbox-tcp&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">scrape_timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">15s</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">scrape_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">15s</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/probe</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">params</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">module</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">tcp_connect</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">   - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">&lt;my_tcp_server&gt;:&lt;my_tcp_server_port&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">   - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__address__</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__param_target</span></span>
<span class="line"><span style="color:#E1E4E8;">   - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__param_target</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">instance</span></span>
<span class="line"><span style="color:#E1E4E8;">   - </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">prometheus-blackbox-exporter:9115</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;blackbox-tcp&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">scrape_timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">15s</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">scrape_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">15s</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/probe</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">params</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">module</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">tcp_connect</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">   - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">&lt;my_tcp_server&gt;:&lt;my_tcp_server_port&gt;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">   - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__address__</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__param_target</span></span>
<span class="line"><span style="color:#24292E;">   - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__param_target</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">instance</span></span>
<span class="line"><span style="color:#24292E;">   - </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">prometheus-blackbox-exporter:9115</span></span></code></pre></div><ul><li>配置blackbox</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">## ----------- TCP 检测模块配置 -----------</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tcp_connect</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">prober</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">tcp</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">ip_protocol_fallback</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">preferred_ip_protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ip4</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">5s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">## ----------- TCP 检测模块配置 -----------</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tcp_connect</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">prober</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tcp</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">tcp</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">ip_protocol_fallback</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">preferred_ip_protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ip4</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">5s</span></span></code></pre></div><h5 id="https" tabindex="-1">https <a class="header-anchor" href="#https" aria-label="Permalink to &quot;https&quot;">​</a></h5><ul><li>配置prometheus</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;blackbox-https&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">scrape_timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">15s</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">scrape_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">15s</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/probe</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">params</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">module</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">http_2xx</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">   - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">https://example.com</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">   - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__address__</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__param_target</span></span>
<span class="line"><span style="color:#E1E4E8;">   - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__param_target</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">instance</span></span>
<span class="line"><span style="color:#E1E4E8;">   - </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">prometheus-blackbox-exporter:9115</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;blackbox-https&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">scrape_timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">15s</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">scrape_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">15s</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/probe</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">params</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">module</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">http_2xx</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">   - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">https://example.com</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">   - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__address__</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__param_target</span></span>
<span class="line"><span style="color:#24292E;">   - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__param_target</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">instance</span></span>
<span class="line"><span style="color:#24292E;">   - </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">prometheus-blackbox-exporter:9115</span></span></code></pre></div><ul><li>配置blackbox</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">modules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">## ----------- HTTP GET 2xx 检测模块配置 -----------</span></span>
<span class="line"><span style="color:#85E89D;">modules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">## ----------- HTTP GET 2xx 检测模块配置 -----------</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">http_get_2xx</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">prober</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">method</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">GET</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">fail_if_ssl</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">tls_config</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">insecure_skip_verify</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">ip_protocol_fallback</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">no_follow_redirects</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">preferred_ip_protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ip4</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">valid_http_versions</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">HTTP/1.1</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">HTTP/2.0</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">valid_status_codes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#79B8FF;">200</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#79B8FF;">204</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">modules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">## ----------- HTTP GET 2xx 检测模块配置 -----------</span></span>
<span class="line"><span style="color:#22863A;">modules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">## ----------- HTTP GET 2xx 检测模块配置 -----------</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">http_get_2xx</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">prober</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">method</span><span style="color:#24292E;">: </span><span style="color:#032F62;">GET</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">fail_if_ssl</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">tls_config</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">insecure_skip_verify</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">ip_protocol_fallback</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">no_follow_redirects</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">preferred_ip_protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ip4</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">valid_http_versions</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">HTTP/1.1</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">HTTP/2.0</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">valid_status_codes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#005CC5;">200</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#005CC5;">204</span></span></code></pre></div><h3 id="_2-consul服务发现-推荐" tabindex="-1">2.consul服务<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#consul_sd_config" target="_blank" rel="noreferrer">发现</a>(推荐) <a class="header-anchor" href="#_2-consul服务发现-推荐" aria-label="Permalink to &quot;2.consul服务[发现](https://prometheus.io/docs/prometheus/latest/configuration/configuration/#consul_sd_config)(推荐)&quot;">​</a></h3><p>Consul 是基于 GO 语言开发的开源工具，主要面向分布式，服务化的系统提供服务注册、服务发现和配置管理的功能。Consul 提供服务注册/发现、健康检查、Key/Value存储、多数据中心和分布式一致性保证等功能。通过 Prometheus 实现监控，当新增一个 Target 时，需要变更服务器上的配置文件，即使使用 file_sd_configs 配置，也需要登录服务器修改对应 Json 文件，会非常麻烦。不过 Prometheus 官方支持多种自动服务发现的类型，其中就支持 Consul。</p><h4 id="部署" tabindex="-1">部署 <a class="header-anchor" href="#部署" aria-label="Permalink to &quot;部署&quot;">​</a></h4><p>看consul章节</p><h4 id="配置prometheus" tabindex="-1">配置prometheus <a class="header-anchor" href="#配置prometheus" aria-label="Permalink to &quot;配置prometheus&quot;">​</a></h4><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">cat &gt; /data/monitor/prometheus/config &lt;&lt;EOF</span></span>
<span class="line"><span style="color:#85E89D;">global</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">scrape_interval</span><span style="color:#E1E4E8;">:     </span><span style="color:#9ECBFF;">15s</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 每15s采集一次数据</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">scrape_timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10s</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;"># 超时时间</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">evaluation_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">15s</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 每15s做一次告警检测</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">############ 告警配置 ###################</span></span>
<span class="line"><span style="color:#85E89D;">alerting</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">alertmanagers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">: []</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">scheme</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">scrape_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 配置prometheus服务本身</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">prometheus</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">honor_timestamps</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/prometheus/metrics/</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">scheme</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;10.103.236.199:19090&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">instance</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">prometheus</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">############ consul ###################</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;consul-node-exporter&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">consul_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">server</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;10.103.236.199:8500&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#ip根据自己环境进行修改</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">services</span><span style="color:#E1E4E8;">: []</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_consul_tags</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">.*node-exporter.*</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;__meta_consul_service&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;job&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;$1&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;__meta_consul_service_address&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;instance&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;$1&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;__meta_consul_service_metadata_project&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;project&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;$1&#39;</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">cat &gt; /data/monitor/prometheus/config &lt;&lt;EOF</span></span>
<span class="line"><span style="color:#22863A;">global</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">scrape_interval</span><span style="color:#24292E;">:     </span><span style="color:#032F62;">15s</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 每15s采集一次数据</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">scrape_timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10s</span><span style="color:#24292E;">   </span><span style="color:#6A737D;"># 超时时间</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">evaluation_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">15s</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 每15s做一次告警检测</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">############ 告警配置 ###################</span></span>
<span class="line"><span style="color:#22863A;">alerting</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">alertmanagers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">: []</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">scheme</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">scrape_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 配置prometheus服务本身</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">prometheus</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">honor_timestamps</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/prometheus/metrics/</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">scheme</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;10.103.236.199:19090&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">instance</span><span style="color:#24292E;">: </span><span style="color:#032F62;">prometheus</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">############ consul ###################</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;consul-node-exporter&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">consul_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;10.103.236.199:8500&#39;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#ip根据自己环境进行修改</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">services</span><span style="color:#24292E;">: []</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_consul_tags</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">.*node-exporter.*</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;__meta_consul_service&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;job&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;$1&#39;</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;__meta_consul_service_address&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;instance&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;$1&#39;</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;__meta_consul_service_metadata_project&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;project&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;$1&#39;</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span></code></pre></div><ul><li>热更新服务</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看语法</span></span>
<span class="line"><span style="color:#B392F0;">/usr/local/prometheus/promtool</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">check</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/monitor/prometheus/prometheus.yml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看语法</span></span>
<span class="line"><span style="color:#6F42C1;">/usr/local/prometheus/promtool</span><span style="color:#24292E;">   </span><span style="color:#032F62;">check</span><span style="color:#24292E;"> </span><span style="color:#032F62;">config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/monitor/prometheus/prometheus.yml</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-v</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--request</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">POST</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;http://10.103.236.199:19090/prometheus/-/reload&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-v</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--request</span><span style="color:#24292E;">  </span><span style="color:#032F62;">POST</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;http://10.103.236.199:19090/prometheus/-/reload&#39;</span></span></code></pre></div><blockquote><p>prometheus 多个这个的原因，我要用同一个域名代理多个后端，默认是没有prometheus</p></blockquote><h4 id="注册服务" tabindex="-1">注册服务 <a class="header-anchor" href="#注册服务" aria-label="Permalink to &quot;注册服务&quot;">​</a></h4><h5 id="node-export" tabindex="-1">node-export <a class="header-anchor" href="#node-export" aria-label="Permalink to &quot;node-export&quot;">​</a></h5><ul><li>配置prometheus</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;consul_node_exporter&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">consul_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">server</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;10.103.236.199:8500&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">services</span><span style="color:#E1E4E8;">: []  </span><span style="color:#6A737D;">#代表所有服务</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_consul_tags</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">.*node-exporter.*</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;__meta_consul_service&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;job&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;$1&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;__meta_consul_service_address&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;instance&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;$1&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;__meta_consul_service_metadata_project&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;project&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;$1&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;consul_node_exporter&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">consul_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;10.103.236.199:8500&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">services</span><span style="color:#24292E;">: []  </span><span style="color:#6A737D;">#代表所有服务</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_consul_tags</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">.*node-exporter.*</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;__meta_consul_service&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;job&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;$1&#39;</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;__meta_consul_service_address&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;instance&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;$1&#39;</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;__meta_consul_service_metadata_project&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;project&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;$1&#39;</span></span></code></pre></div><ul><li>注入consul服务</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-X</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PUT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;{&quot;id&quot;: &quot;node-exporter&quot;,&quot;name&quot;: &quot;node-exporter-10.103.236.199&quot;,&quot;address&quot;: &quot;10.103.236.199&quot;,&quot;port&quot;: 9100,&quot;tags&quot;: [&quot;node-exporter&quot;],&quot;Meta&quot;:{&quot;app&quot;: &quot;linux-node&quot;,&quot;project&quot;: &quot;yewu&quot;},&quot;checks&quot;: [{&quot;http&quot;: &quot;http://10.103.236.199:9100/metrics&quot;, &quot;interval&quot;: &quot;5s&quot;}]}&#39;</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">http://10.103.236.199:8500/v1/agent/service/register</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PUT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;{&quot;id&quot;: &quot;node-exporter&quot;,&quot;name&quot;: &quot;node-exporter-10.103.236.199&quot;,&quot;address&quot;: &quot;10.103.236.199&quot;,&quot;port&quot;: 9100,&quot;tags&quot;: [&quot;node-exporter&quot;],&quot;Meta&quot;:{&quot;app&quot;: &quot;linux-node&quot;,&quot;project&quot;: &quot;yewu&quot;},&quot;checks&quot;: [{&quot;http&quot;: &quot;http://10.103.236.199:9100/metrics&quot;, &quot;interval&quot;: &quot;5s&quot;}]}&#39;</span><span style="color:#24292E;">  </span><span style="color:#032F62;">http://10.103.236.199:8500/v1/agent/service/register</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><ul><li>ID 指定实例的唯一ID名称；</li><li>Name 指定服务名，可以多个实例共用服务名；（相当于在prometheus展示job）</li><li>Tags 指定服务的标签列表，这些标签可用于过滤服务，并通过API进行公开；</li><li>Address 指定服务的实例地址；（相当于instance）</li><li>Port 指定实例的端口号；</li><li>Meta 指定服务的元数据，格式为key:value，此处用于保存我们的标签信息；</li><li>EnableTagOverride 此处禁用服务标签的反熵功能；</li><li>Check 服务的检查列表，Consul会根据配置信息定时发起检查，确定服务是否正常；</li></ul></div><ul><li>效果</li></ul><p>consul中</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202412191545472.png" alt="image-20241219154503027"></p><p>prometheus中</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202412191545454.png" alt="image-20241219154528231"></p><h5 id="blackbox-export" tabindex="-1">blackbox_export <a class="header-anchor" href="#blackbox-export" aria-label="Permalink to &quot;blackbox_export&quot;">​</a></h5><ul><li>配置prometheus</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">############ consul blackbox_exporter ###################</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">job_name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;blackbox-exporter&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">consul_sd_configs:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;10.103.236.199:8500&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">services:</span><span style="color:#E1E4E8;"> []</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">relabel_configs:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">source_labels:</span><span style="color:#E1E4E8;"> [__meta_consul_tags]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">regex:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.</span><span style="color:#79B8FF;">*</span><span style="color:#9ECBFF;">blackbox-exporter.</span><span style="color:#79B8FF;">*</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">action:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">source_labels:</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&#39;__meta_consul_service&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">regex:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">target_label:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;job&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">replacement:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;$1&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">source_labels:</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&#39;__meta_consul_service_address&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">regex:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">target_label:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;instance&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">replacement:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;$1&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">############ consul blackbox_exporter ###################</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">job_name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;blackbox-exporter&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">consul_sd_configs:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;10.103.236.199:8500&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">services:</span><span style="color:#24292E;"> []</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">relabel_configs:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">source_labels:</span><span style="color:#24292E;"> [__meta_consul_tags]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">regex:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.</span><span style="color:#005CC5;">*</span><span style="color:#032F62;">blackbox-exporter.</span><span style="color:#005CC5;">*</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">action:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">source_labels:</span><span style="color:#24292E;"> [</span><span style="color:#032F62;">&#39;__meta_consul_service&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">regex:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">target_label:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;job&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">replacement:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;$1&#39;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">source_labels:</span><span style="color:#24292E;"> [</span><span style="color:#032F62;">&#39;__meta_consul_service_address&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">regex:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">target_label:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;instance&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">replacement:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;$1&#39;</span></span></code></pre></div><ul><li>注入服务</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-X</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PUT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;{&quot;id&quot;: &quot;blackbox-exporter&quot;,&quot;name&quot;: &quot;blackbox-exporter-10.103.236.199&quot;,&quot;address&quot;: &quot;10.103.236.199&quot;,&quot;port&quot;: 9100,&quot;tags&quot;: [&quot;blackbox-exporter&quot;],&quot;Meta&quot;:{&quot;app&quot;: &quot;linux-node&quot;},&quot;checks&quot;: [{&quot;http&quot;: &quot;http://10.103.236.199:9100/metrics&quot;, &quot;interval&quot;: &quot;5s&quot;}]}&#39;</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">http://10.103.236.199:8500/v1/agent/service/register</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PUT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;{&quot;id&quot;: &quot;blackbox-exporter&quot;,&quot;name&quot;: &quot;blackbox-exporter-10.103.236.199&quot;,&quot;address&quot;: &quot;10.103.236.199&quot;,&quot;port&quot;: 9100,&quot;tags&quot;: [&quot;blackbox-exporter&quot;],&quot;Meta&quot;:{&quot;app&quot;: &quot;linux-node&quot;},&quot;checks&quot;: [{&quot;http&quot;: &quot;http://10.103.236.199:9100/metrics&quot;, &quot;interval&quot;: &quot;5s&quot;}]}&#39;</span><span style="color:#24292E;">  </span><span style="color:#032F62;">http://10.103.236.199:8500/v1/agent/service/register</span></span></code></pre></div><h5 id="backbox-http-200" tabindex="-1">backbox_http_200 <a class="header-anchor" href="#backbox-http-200" aria-label="Permalink to &quot;backbox_http_200&quot;">​</a></h5><ul><li>配置prometheus</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">############ consul domain ###################</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;consul_blackbox_domain&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">scrape_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">scrape_timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">5s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/probe</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">consul_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">server</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;10.103.236.199:8500&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">services</span><span style="color:#E1E4E8;">: []</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">params</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">module</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">http_get_2xx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_consul_tags</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">.*blackbox_domain.*</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__meta_consul_service_metadata_(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">labelmap</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_consul_service_address</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__param_target</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10.103.236.199:19115</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">############ consul domain ###################</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;consul_blackbox_domain&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">scrape_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">scrape_timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">5s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/probe</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">consul_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;10.103.236.199:8500&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">services</span><span style="color:#24292E;">: []</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">params</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">module</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">http_get_2xx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_consul_tags</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">.*blackbox_domain.*</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__meta_consul_service_metadata_(.+)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">labelmap</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_consul_service_address</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__param_target</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10.103.236.199:19115</span></span></code></pre></div><p>或者</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">############ consul http_get_2xx ###################</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;consul-blackbox-http_get_2xx&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">scrape_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">30s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">scrape_timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">15s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">scheme</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/probe</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">params</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">module</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">http_get_2xx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">consul_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">server</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;10.103.236.199:8500&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">tag_separator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;,&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">services</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">http_get_2xx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;__meta_consul_service_address&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__param_target</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;__meta_consul_service_address&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">instance</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10.103.236.199:19115</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;__meta_consul_service_metadata_project&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;project&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;$1&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">############ consul http_get_2xx ###################</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;consul-blackbox-http_get_2xx&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">scrape_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">30s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">scrape_timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">15s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">scheme</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/probe</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">params</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">module</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">http_get_2xx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">consul_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;10.103.236.199:8500&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">tag_separator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;,&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">services</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">http_get_2xx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;__meta_consul_service_address&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__param_target</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;__meta_consul_service_address&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">instance</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10.103.236.199:19115</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;__meta_consul_service_metadata_project&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;(.*)&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;project&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;$1&#39;</span></span></code></pre></div><ul><li>注入服务</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-X</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PUT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;{&quot;id&quot;: &quot;blackbox-http&quot;,&quot;name&quot;: &quot;http_get_2xx&quot;,&quot;address&quot;: &quot;https://www.baidu.com&quot;,&quot;port&quot;: 443,&quot;tags&quot;: [&quot;blackbox-http&quot;],&quot;Meta&quot;:{&quot;app&quot;: &quot;linux-node&quot;,&quot;project&quot;: &quot;web&quot;},&quot;checks&quot;: [{&quot;http&quot;: &quot;http://10.103.236.199:19115&quot;, &quot;interval&quot;: &quot;5s&quot;}]}&#39;</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">http://10.103.236.199:8500/v1/agent/service/register</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PUT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;{&quot;id&quot;: &quot;blackbox-http&quot;,&quot;name&quot;: &quot;http_get_2xx&quot;,&quot;address&quot;: &quot;https://www.baidu.com&quot;,&quot;port&quot;: 443,&quot;tags&quot;: [&quot;blackbox-http&quot;],&quot;Meta&quot;:{&quot;app&quot;: &quot;linux-node&quot;,&quot;project&quot;: &quot;web&quot;},&quot;checks&quot;: [{&quot;http&quot;: &quot;http://10.103.236.199:19115&quot;, &quot;interval&quot;: &quot;5s&quot;}]}&#39;</span><span style="color:#24292E;">  </span><span style="color:#032F62;">http://10.103.236.199:8500/v1/agent/service/register</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202412191807512.png" alt="image-20241219180753764"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202412191808900.png" alt="image-20241219180817571"></p><h5 id="blackbox-icmp" tabindex="-1">blackbox_icmp <a class="header-anchor" href="#blackbox-icmp" aria-label="Permalink to &quot;blackbox_icmp&quot;">​</a></h5><ul><li>配置prometheus</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul_blackbox_icmp</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">params</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">module</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">icmp</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">scrape_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">2s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">scrape_timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">2s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/probe</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">consul_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># consul 服务地址</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">server</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;10.103.236.199:8500&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">tag_separator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;,&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">services</span><span style="color:#E1E4E8;">: [] </span><span style="color:#6A737D;"># 代表所有服务</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_consul_tags</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">.*blackbox_icmp.*</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__meta_consul_service_metadata_(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">labelmap</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;__meta_consul_service_address&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__param_target</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__param_target</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">instance</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10.103.236.199:19115</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul_blackbox_icmp</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">params</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">module</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">icmp</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">scrape_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">2s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">scrape_timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">2s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/probe</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">consul_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># consul 服务地址</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;10.103.236.199:8500&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">tag_separator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;,&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">services</span><span style="color:#24292E;">: [] </span><span style="color:#6A737D;"># 代表所有服务</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_consul_tags</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">.*blackbox_icmp.*</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__meta_consul_service_metadata_(.+)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">labelmap</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;__meta_consul_service_address&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__param_target</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__param_target</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">instance</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10.103.236.199:19115</span></span></code></pre></div><ul><li>注入服务</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-X</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PUT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;{&quot;id&quot;: &quot;blackbox-icmp&quot;,&quot;name&quot;: &quot;blackbox_icmp&quot;,&quot;address&quot;: &quot;10.103.236.199&quot;,&quot;port&quot;: 19115,&quot;tags&quot;: [&quot;blackbox-icmp&quot;],&quot;Meta&quot;:{&quot;app&quot;: &quot;linux-node&quot;,&quot;project&quot;: &quot;yewu&quot;},&quot;checks&quot;: [{&quot;http&quot;: &quot;http://10.103.236.199:19115&quot;, &quot;interval&quot;: &quot;5s&quot;}]}&#39;</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">http://10.103.236.199:8500/v1/agent/service/register</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PUT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;{&quot;id&quot;: &quot;blackbox-icmp&quot;,&quot;name&quot;: &quot;blackbox_icmp&quot;,&quot;address&quot;: &quot;10.103.236.199&quot;,&quot;port&quot;: 19115,&quot;tags&quot;: [&quot;blackbox-icmp&quot;],&quot;Meta&quot;:{&quot;app&quot;: &quot;linux-node&quot;,&quot;project&quot;: &quot;yewu&quot;},&quot;checks&quot;: [{&quot;http&quot;: &quot;http://10.103.236.199:19115&quot;, &quot;interval&quot;: &quot;5s&quot;}]}&#39;</span><span style="color:#24292E;">  </span><span style="color:#032F62;">http://10.103.236.199:8500/v1/agent/service/register</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202412201735390.png" alt="image-20241220173515444"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202412201734546.png" alt="image-20241220173445708"></p><h5 id="blackbox-tcp" tabindex="-1">blackbox_tcp <a class="header-anchor" href="#blackbox-tcp" aria-label="Permalink to &quot;blackbox_tcp&quot;">​</a></h5><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">############ consul tcp_connect ###################</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;consul_blackbox_tcp_connect&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">scrape_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">scrape_timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">5s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">scheme</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">params</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">module</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">tcp_connect</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">consul_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">server</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;10.103.236.199:8500&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">tag_separator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;,&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">services</span><span style="color:#E1E4E8;">: []</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_consul_tags</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">.*blackbox-tcp.*</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__meta_consul_service_metadata_(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">labelmap</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_consul_service_address</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__param_target</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__param_target</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">instance</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10.103.236.199:19115</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#根据环境进行修改</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">############ consul tcp_connect ###################</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;consul_blackbox_tcp_connect&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">scrape_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">scrape_timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">5s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">scheme</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">params</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">module</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">tcp_connect</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">consul_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;10.103.236.199:8500&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">tag_separator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;,&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">services</span><span style="color:#24292E;">: []</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_consul_tags</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">.*blackbox-tcp.*</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__meta_consul_service_metadata_(.+)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">labelmap</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_consul_service_address</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__param_target</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__param_target</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">instance</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10.103.236.199:19115</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#根据环境进行修改</span></span></code></pre></div><ul><li>添加ssh服务</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-X</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PUT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;{&quot;id&quot;: &quot;blackbox-tcp&quot;,&quot;name&quot;: &quot;blackbox-tcp&quot;,&quot;address&quot;: &quot;10.103.236.199&quot;,&quot;port&quot;: 22,&quot;tags&quot;: [&quot;blackbox-tcp&quot;],&quot;Meta&quot;:{&quot;app&quot;: &quot;linux-node&quot;,&quot;project&quot;: &quot;ssh&quot;},&quot;checks&quot;: [{&quot;http&quot;: &quot;http://10.103.236.199:19115&quot;, &quot;interval&quot;: &quot;5s&quot;}]}&#39;</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">http://10.103.236.199:8500/v1/agent/service/register</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PUT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;{&quot;id&quot;: &quot;blackbox-tcp&quot;,&quot;name&quot;: &quot;blackbox-tcp&quot;,&quot;address&quot;: &quot;10.103.236.199&quot;,&quot;port&quot;: 22,&quot;tags&quot;: [&quot;blackbox-tcp&quot;],&quot;Meta&quot;:{&quot;app&quot;: &quot;linux-node&quot;,&quot;project&quot;: &quot;ssh&quot;},&quot;checks&quot;: [{&quot;http&quot;: &quot;http://10.103.236.199:19115&quot;, &quot;interval&quot;: &quot;5s&quot;}]}&#39;</span><span style="color:#24292E;">  </span><span style="color:#032F62;">http://10.103.236.199:8500/v1/agent/service/register</span></span></code></pre></div><h5 id="json方式" tabindex="-1">json方式 <a class="header-anchor" href="#json方式" aria-label="Permalink to &quot;json方式&quot;">​</a></h5><p>将自动发现的服务进行分类</p><ul><li>配置prometheus</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;consul_node_exporter&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">consul_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">server</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;192.168.75.41:8500&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">services</span><span style="color:#E1E4E8;">: []</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_consul_tags</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">.*node-exporter.*</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__meta_consul_service_metadata_(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">labelmap</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;cadvisor-exporter&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">consul_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">server</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;192.168.75.41:8500&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">services</span><span style="color:#E1E4E8;">: []</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_consul_tags</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">.*cadvisor-exporter.*</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__meta_consul_service_metadata_(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">labelmap</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;consul_node_exporter&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">consul_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;192.168.75.41:8500&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">services</span><span style="color:#24292E;">: []</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_consul_tags</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">.*node-exporter.*</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__meta_consul_service_metadata_(.+)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">labelmap</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;cadvisor-exporter&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">consul_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;192.168.75.41:8500&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">services</span><span style="color:#24292E;">: []</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_consul_tags</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">.*cadvisor-exporter.*</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__meta_consul_service_metadata_(.+)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">labelmap</span></span></code></pre></div><ul><li>注入consul服务</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">consul-0.json</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;ID&quot;: &quot;node-exporter&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;Name&quot;: &quot;node-exporter-192.168.75.41&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;Tags&quot;: [</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;node-exporter&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">  ],</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;Address&quot;: &quot;192.168.75.41&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;Port&quot;: 9100,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;Meta&quot;: {</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;app&quot;: &quot;spring-boot&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;team&quot;: &quot;appgroup&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;project&quot;: &quot;bigdata&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">  },</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;EnableTagOverride&quot;: false,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;Check&quot;: {</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;HTTP&quot;: &quot;http://192.168.75.41:9100/metrics&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;Interval&quot;: &quot;10s&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">  },</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;Weights&quot;: {</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;Passing&quot;: 10,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;Warning&quot;: 1</span></span>
<span class="line"><span style="color:#9ECBFF;">  }</span></span>
<span class="line"><span style="color:#9ECBFF;">}</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#更新注册服务</span></span>
<span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--request</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PUT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--data</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">@consul-0.json</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://192.168.75.41:8500/v1/agent/service/register?replace-existing-checks=</span><span style="color:#79B8FF;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#容器方式</span></span>
<span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">docker_json_consul.json</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;ID&quot;: &quot;cadvisor-exporter-test&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;Name&quot;: &quot;cadvisor-exporter-192.168.75.42&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;Tags&quot;: [</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;cadvisor-exporter&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">  ],</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;Address&quot;: &quot;192.168.75.42&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;Port&quot;: 8080,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;Meta&quot;: {</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;app&quot;: &quot;docker&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;team&quot;: &quot;cloudgroup&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;project&quot;: &quot;docker-service&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">  },</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;EnableTagOverride&quot;: false,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;Check&quot;: {</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;HTTP&quot;: &quot;http://192.168.75.42:8080/metrics&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;Interval&quot;: &quot;10s&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">  },</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;Weights&quot;: {</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;Passing&quot;: 10,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;Warning&quot;: 1</span></span>
<span class="line"><span style="color:#9ECBFF;">  }</span></span>
<span class="line"><span style="color:#9ECBFF;">}</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--request</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PUT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--data</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">@consul2.json</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://192.168.75.41:8500/v1/agent/service/register?replace-existing-checks=</span><span style="color:#79B8FF;">1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">consul-0.json</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#032F62;">  &quot;ID&quot;: &quot;node-exporter&quot;,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;Name&quot;: &quot;node-exporter-192.168.75.41&quot;,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;Tags&quot;: [</span></span>
<span class="line"><span style="color:#032F62;">    &quot;node-exporter&quot;</span></span>
<span class="line"><span style="color:#032F62;">  ],</span></span>
<span class="line"><span style="color:#032F62;">  &quot;Address&quot;: &quot;192.168.75.41&quot;,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;Port&quot;: 9100,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;Meta&quot;: {</span></span>
<span class="line"><span style="color:#032F62;">    &quot;app&quot;: &quot;spring-boot&quot;,</span></span>
<span class="line"><span style="color:#032F62;">    &quot;team&quot;: &quot;appgroup&quot;,</span></span>
<span class="line"><span style="color:#032F62;">    &quot;project&quot;: &quot;bigdata&quot;</span></span>
<span class="line"><span style="color:#032F62;">  },</span></span>
<span class="line"><span style="color:#032F62;">  &quot;EnableTagOverride&quot;: false,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;Check&quot;: {</span></span>
<span class="line"><span style="color:#032F62;">    &quot;HTTP&quot;: &quot;http://192.168.75.41:9100/metrics&quot;,</span></span>
<span class="line"><span style="color:#032F62;">    &quot;Interval&quot;: &quot;10s&quot;</span></span>
<span class="line"><span style="color:#032F62;">  },</span></span>
<span class="line"><span style="color:#032F62;">  &quot;Weights&quot;: {</span></span>
<span class="line"><span style="color:#032F62;">    &quot;Passing&quot;: 10,</span></span>
<span class="line"><span style="color:#032F62;">    &quot;Warning&quot;: 1</span></span>
<span class="line"><span style="color:#032F62;">  }</span></span>
<span class="line"><span style="color:#032F62;">}</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#更新注册服务</span></span>
<span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--request</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PUT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--data</span><span style="color:#24292E;"> </span><span style="color:#032F62;">@consul-0.json</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://192.168.75.41:8500/v1/agent/service/register?replace-existing-checks=</span><span style="color:#005CC5;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#容器方式</span></span>
<span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">docker_json_consul.json</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#032F62;">  &quot;ID&quot;: &quot;cadvisor-exporter-test&quot;,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;Name&quot;: &quot;cadvisor-exporter-192.168.75.42&quot;,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;Tags&quot;: [</span></span>
<span class="line"><span style="color:#032F62;">    &quot;cadvisor-exporter&quot;</span></span>
<span class="line"><span style="color:#032F62;">  ],</span></span>
<span class="line"><span style="color:#032F62;">  &quot;Address&quot;: &quot;192.168.75.42&quot;,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;Port&quot;: 8080,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;Meta&quot;: {</span></span>
<span class="line"><span style="color:#032F62;">    &quot;app&quot;: &quot;docker&quot;,</span></span>
<span class="line"><span style="color:#032F62;">    &quot;team&quot;: &quot;cloudgroup&quot;,</span></span>
<span class="line"><span style="color:#032F62;">    &quot;project&quot;: &quot;docker-service&quot;</span></span>
<span class="line"><span style="color:#032F62;">  },</span></span>
<span class="line"><span style="color:#032F62;">  &quot;EnableTagOverride&quot;: false,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;Check&quot;: {</span></span>
<span class="line"><span style="color:#032F62;">    &quot;HTTP&quot;: &quot;http://192.168.75.42:8080/metrics&quot;,</span></span>
<span class="line"><span style="color:#032F62;">    &quot;Interval&quot;: &quot;10s&quot;</span></span>
<span class="line"><span style="color:#032F62;">  },</span></span>
<span class="line"><span style="color:#032F62;">  &quot;Weights&quot;: {</span></span>
<span class="line"><span style="color:#032F62;">    &quot;Passing&quot;: 10,</span></span>
<span class="line"><span style="color:#032F62;">    &quot;Warning&quot;: 1</span></span>
<span class="line"><span style="color:#032F62;">  }</span></span>
<span class="line"><span style="color:#032F62;">}</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--request</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PUT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--data</span><span style="color:#24292E;"> </span><span style="color:#032F62;">@consul2.json</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://192.168.75.41:8500/v1/agent/service/register?replace-existing-checks=</span><span style="color:#005CC5;">1</span></span></code></pre></div><h4 id="注销服务" tabindex="-1">注销服务 <a class="header-anchor" href="#注销服务" aria-label="Permalink to &quot;注销服务&quot;">​</a></h4><p>Consul API 注销&quot;id=node-exporter&quot; 服务</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-X</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PUT</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://10.103.236.199:8500/v1/agent/service/deregister/id_name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PUT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://10.103.236.199:8500/v1/agent/service/deregister/id_name</span></span></code></pre></div>`,93),e=[o];function t(c,r,E,y,i,u){return a(),n("div",null,e)}const d=s(p,[["render",t]]);export{_ as __pageData,d as default};
