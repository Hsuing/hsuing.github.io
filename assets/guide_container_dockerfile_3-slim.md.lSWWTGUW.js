import{_ as s,o as a,c as n,R as p}from"./chunks/framework.zUbWieqp.js";const d=JSON.parse('{"title":"1.Docker 镜像的大小减少","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/dockerfile/3-slim.md","filePath":"guide/container/dockerfile/3-slim.md","lastUpdated":1760705628000}'),l={name:"guide/container/dockerfile/3-slim.md"},o=p(`<h1 id="_1-docker-镜像的大小减少" tabindex="-1">1.Docker 镜像的大小减少 <a class="header-anchor" href="#_1-docker-镜像的大小减少" aria-label="Permalink to &quot;1.Docker 镜像的大小减少&quot;">​</a></h1><h2 id="_1-1基本dockerfile" tabindex="-1">1.1基本dockerfile <a class="header-anchor" href="#_1-1基本dockerfile" aria-label="Permalink to &quot;1.1基本dockerfile&quot;">​</a></h2><p>276MB</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">golang:1.23.1-alpine</span></span>
<span class="line"><span style="color:#B392F0;">WORKDIR</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/app</span></span>
<span class="line"><span style="color:#B392F0;">COPY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">go.</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">./</span></span>
<span class="line"><span style="color:#B392F0;">RUN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">go</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">download</span></span>
<span class="line"><span style="color:#B392F0;">COPY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.</span></span>
<span class="line"><span style="color:#B392F0;">RUN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">go</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">build</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">main</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.</span></span>
<span class="line"><span style="color:#B392F0;">CMD</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&quot;./main&quot;</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">FROM</span><span style="color:#24292E;"> </span><span style="color:#032F62;">golang:1.23.1-alpine</span></span>
<span class="line"><span style="color:#6F42C1;">WORKDIR</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/app</span></span>
<span class="line"><span style="color:#6F42C1;">COPY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">go.</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">./</span></span>
<span class="line"><span style="color:#6F42C1;">RUN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">go</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">download</span></span>
<span class="line"><span style="color:#6F42C1;">COPY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.</span></span>
<span class="line"><span style="color:#6F42C1;">RUN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">go</span><span style="color:#24292E;"> </span><span style="color:#032F62;">build</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">main</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.</span></span>
<span class="line"><span style="color:#6F42C1;">CMD</span><span style="color:#24292E;"> [</span><span style="color:#032F62;">&quot;./main&quot;</span><span style="color:#24292E;">]</span></span></code></pre></div><h2 id="_1-2-多阶段镜像" tabindex="-1">1.2 多阶段镜像 <a class="header-anchor" href="#_1-2-多阶段镜像" aria-label="Permalink to &quot;1.2 多阶段镜像&quot;">​</a></h2><p>通过使用多阶段映像，我们可以分离编译和执行阶段，这有助于从最终映像中排除不必要的文件（如 Go 构建工具）</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">golang:1.23.1-alpine</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">builder</span></span>
<span class="line"><span style="color:#B392F0;">WORKDIR</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/app</span></span>
<span class="line"><span style="color:#B392F0;">COPY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">go.</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">./</span></span>
<span class="line"><span style="color:#B392F0;">RUN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">go</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">download</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">go</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">verify</span></span>
<span class="line"><span style="color:#B392F0;">COPY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.</span></span>
<span class="line"><span style="color:#6A737D;"># 优化构建</span></span>
<span class="line"><span style="color:#B392F0;">RUN CGO_ENABLED</span><span style="color:#E1E4E8;">=0 </span><span style="color:#9ECBFF;">GOOS=linux</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">go</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">build</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-a</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-installsuffix</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cgo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-ldflags=</span><span style="color:#9ECBFF;">&quot;-w -s&quot;</span><span style="color:#79B8FF;"> -o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">app</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 最终镜像阶段：极简 Alpine 基础镜像</span></span>
<span class="line"><span style="color:#B392F0;">FROM alpine:3.18</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">RUN apk</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--no-cache</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">add</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ca-certificates</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 创建非 root 用户</span></span>
<span class="line"><span style="color:#B392F0;">RUN addgroup</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-S</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">appgroup</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">adduser</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-S</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">appuser</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-G</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">appgroup</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">WORKDIR /app</span></span>
<span class="line"><span style="color:#B392F0;">COPY --from</span><span style="color:#E1E4E8;">=builder </span><span style="color:#9ECBFF;">/app/app</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">USER appuser</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">EXPOSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#B392F0;">CMD [</span><span style="color:#B392F0;">&quot;./app&quot;</span><span style="color:#B392F0;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">FROM</span><span style="color:#24292E;"> </span><span style="color:#032F62;">golang:1.23.1-alpine</span><span style="color:#24292E;"> </span><span style="color:#032F62;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">builder</span></span>
<span class="line"><span style="color:#6F42C1;">WORKDIR</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/app</span></span>
<span class="line"><span style="color:#6F42C1;">COPY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">go.</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">./</span></span>
<span class="line"><span style="color:#6F42C1;">RUN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">go</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">download</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">go</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">verify</span></span>
<span class="line"><span style="color:#6F42C1;">COPY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.</span></span>
<span class="line"><span style="color:#6A737D;"># 优化构建</span></span>
<span class="line"><span style="color:#6F42C1;">RUN CGO_ENABLED</span><span style="color:#24292E;">=0 </span><span style="color:#032F62;">GOOS=linux</span><span style="color:#24292E;"> </span><span style="color:#032F62;">go</span><span style="color:#24292E;"> </span><span style="color:#032F62;">build</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-a</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-installsuffix</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cgo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-ldflags=</span><span style="color:#032F62;">&quot;-w -s&quot;</span><span style="color:#005CC5;"> -o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">app</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 最终镜像阶段：极简 Alpine 基础镜像</span></span>
<span class="line"><span style="color:#6F42C1;">FROM alpine:3.18</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">RUN apk</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--no-cache</span><span style="color:#24292E;"> </span><span style="color:#032F62;">add</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ca-certificates</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 创建非 root 用户</span></span>
<span class="line"><span style="color:#6F42C1;">RUN addgroup</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-S</span><span style="color:#24292E;"> </span><span style="color:#032F62;">appgroup</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">adduser</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-S</span><span style="color:#24292E;"> </span><span style="color:#032F62;">appuser</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-G</span><span style="color:#24292E;"> </span><span style="color:#032F62;">appgroup</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">WORKDIR /app</span></span>
<span class="line"><span style="color:#6F42C1;">COPY --from</span><span style="color:#24292E;">=builder </span><span style="color:#032F62;">/app/app</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">USER appuser</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">EXPOSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#6F42C1;">CMD [</span><span style="color:#6F42C1;">&quot;./app&quot;</span><span style="color:#6F42C1;">]</span></span></code></pre></div><h3 id="优化" tabindex="-1">优化 <a class="header-anchor" href="#优化" aria-label="Permalink to &quot;优化&quot;">​</a></h3><p>我们优化构建阶段以生成更轻量的二进制文件</p><p>CGO_ENABLED=0：禁用对 C 库的依赖，允许我们创建静态二进制文件。</p><p>GOARCH=amd64 和 GOOS=linux：指定我们正在为 Linux amd64 架构构建。</p><p>scratch：使用临时映像，即一个不包含任何内容（没有操作系统，没有库）的空镜像，这可以通过静态二进制文件实现。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">golang:1.23.1-alpine</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">builder</span></span>
<span class="line"><span style="color:#B392F0;">WORKDIR</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/app</span></span>
<span class="line"><span style="color:#B392F0;">COPY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">go.</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">./</span></span>
<span class="line"><span style="color:#B392F0;">RUN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">go</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">download</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">go</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">verify</span></span>
<span class="line"><span style="color:#B392F0;">COPY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.</span></span>
<span class="line"><span style="color:#B392F0;">RUN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CGO_ENABLED=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GOARCH=amd64</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GOOS=linux</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">go</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">build</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">main</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-a</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--trimpath</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--ldflags=</span><span style="color:#9ECBFF;">&quot;-s -w&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--installsuffix</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cgo</span></span>
<span class="line"><span style="color:#B392F0;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">scratch</span></span>
<span class="line"><span style="color:#B392F0;">COPY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--from=builder</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/app</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/</span></span>
<span class="line"><span style="color:#B392F0;">CMD</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&quot;./main&quot;</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">FROM</span><span style="color:#24292E;"> </span><span style="color:#032F62;">golang:1.23.1-alpine</span><span style="color:#24292E;"> </span><span style="color:#032F62;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">builder</span></span>
<span class="line"><span style="color:#6F42C1;">WORKDIR</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/app</span></span>
<span class="line"><span style="color:#6F42C1;">COPY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">go.</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">./</span></span>
<span class="line"><span style="color:#6F42C1;">RUN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">go</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">download</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">go</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">verify</span></span>
<span class="line"><span style="color:#6F42C1;">COPY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.</span></span>
<span class="line"><span style="color:#6F42C1;">RUN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CGO_ENABLED=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GOARCH=amd64</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GOOS=linux</span><span style="color:#24292E;"> </span><span style="color:#032F62;">go</span><span style="color:#24292E;"> </span><span style="color:#032F62;">build</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">main</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-a</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--trimpath</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--ldflags=</span><span style="color:#032F62;">&quot;-s -w&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--installsuffix</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cgo</span></span>
<span class="line"><span style="color:#6F42C1;">FROM</span><span style="color:#24292E;"> </span><span style="color:#032F62;">scratch</span></span>
<span class="line"><span style="color:#6F42C1;">COPY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--from=builder</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/app</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/</span></span>
<span class="line"><span style="color:#6F42C1;">CMD</span><span style="color:#24292E;"> [</span><span style="color:#032F62;">&quot;./main&quot;</span><span style="color:#24292E;">]</span></span></code></pre></div><h2 id="_1-3-用upx进行二进制压缩" tabindex="-1">1.3 用UPX进行二进制压缩 <a class="header-anchor" href="#_1-3-用upx进行二进制压缩" aria-label="Permalink to &quot;1.3 用UPX进行二进制压缩&quot;">​</a></h2><p>对二进制进行压缩</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">golang:1.23.1-alpine</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">builder</span></span>
<span class="line"><span style="color:#B392F0;">RUN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apk</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">add</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--no-cache</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">upx</span></span>
<span class="line"><span style="color:#B392F0;">WORKDIR</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/app</span></span>
<span class="line"><span style="color:#B392F0;">COPY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">go.</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">./</span></span>
<span class="line"><span style="color:#B392F0;">RUN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">go</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">download</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">go</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">verify</span></span>
<span class="line"><span style="color:#B392F0;">COPY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.</span></span>
<span class="line"><span style="color:#B392F0;">RUN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CGO_ENABLED=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GOARCH=amd64</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GOOS=linux</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">go</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">build</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">main</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-a</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--trimpath</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--ldflags=</span><span style="color:#9ECBFF;">&quot;-s -w&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--installsuffix</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cgo</span></span>
<span class="line"><span style="color:#B392F0;">RUN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">upx</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--ultra-brute</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-qq</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">main</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">upx</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">main</span></span>
<span class="line"><span style="color:#B392F0;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">scratch</span></span>
<span class="line"><span style="color:#B392F0;">COPY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--from=builder</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/app</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/</span></span>
<span class="line"><span style="color:#B392F0;">CMD</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&quot;./main&quot;</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">FROM</span><span style="color:#24292E;"> </span><span style="color:#032F62;">golang:1.23.1-alpine</span><span style="color:#24292E;"> </span><span style="color:#032F62;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">builder</span></span>
<span class="line"><span style="color:#6F42C1;">RUN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apk</span><span style="color:#24292E;"> </span><span style="color:#032F62;">add</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--no-cache</span><span style="color:#24292E;"> </span><span style="color:#032F62;">upx</span></span>
<span class="line"><span style="color:#6F42C1;">WORKDIR</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/app</span></span>
<span class="line"><span style="color:#6F42C1;">COPY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">go.</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">./</span></span>
<span class="line"><span style="color:#6F42C1;">RUN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">go</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">download</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">go</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">verify</span></span>
<span class="line"><span style="color:#6F42C1;">COPY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.</span></span>
<span class="line"><span style="color:#6F42C1;">RUN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CGO_ENABLED=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GOARCH=amd64</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GOOS=linux</span><span style="color:#24292E;"> </span><span style="color:#032F62;">go</span><span style="color:#24292E;"> </span><span style="color:#032F62;">build</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">main</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-a</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--trimpath</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--ldflags=</span><span style="color:#032F62;">&quot;-s -w&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--installsuffix</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cgo</span></span>
<span class="line"><span style="color:#6F42C1;">RUN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">upx</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--ultra-brute</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-qq</span><span style="color:#24292E;"> </span><span style="color:#032F62;">main</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">upx</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">main</span></span>
<span class="line"><span style="color:#6F42C1;">FROM</span><span style="color:#24292E;"> </span><span style="color:#032F62;">scratch</span></span>
<span class="line"><span style="color:#6F42C1;">COPY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--from=builder</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/app</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/</span></span>
<span class="line"><span style="color:#6F42C1;">CMD</span><span style="color:#24292E;"> [</span><span style="color:#032F62;">&quot;./main&quot;</span><span style="color:#24292E;">]</span></span></code></pre></div><h1 id="_2-distroless" tabindex="-1">2. distroless <a class="header-anchor" href="#_2-distroless" aria-label="Permalink to &quot;2. distroless&quot;">​</a></h1><p>distroless 镜像，它仅包含您的应用程序及其运行时依赖项。它们不包含您希望在标准 Linux 发行版中找到的包管理器、shell或任何其他程序。 由于Distroless是原始操作系统的精简版本，不包含额外的程序。容器里并没有Shell！如果黑客入侵了我们的应用程序并获取了容器的访问权限，他也无法造成太大的损害。也就是说，程序越少则尺寸越小也越安全。不过，代价是调试更麻烦。</p><p>推荐 Google 的 Distroless 镜像</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 构建阶段</span></span>
<span class="line"><span style="color:#9ECBFF;">FROM golang:1.21-alpine AS builder</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">WORKDIR /app</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">COPY go.mod go.sum ./</span></span>
<span class="line"><span style="color:#9ECBFF;">RUN go mod download</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">COPY . .</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -ldflags=&quot;-w -s&quot; -o app .</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Distroless 最终镜像</span></span>
<span class="line"><span style="color:#9ECBFF;">FROM gcr.io/distroless/static-debian11</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">WORKDIR /app</span></span>
<span class="line"><span style="color:#9ECBFF;">COPY --from=builder /app/app .</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">EXPOSE 8080</span></span>
<span class="line"><span style="color:#9ECBFF;">CMD [&quot;/app/app&quot;]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 构建阶段</span></span>
<span class="line"><span style="color:#032F62;">FROM golang:1.21-alpine AS builder</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">WORKDIR /app</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">COPY go.mod go.sum ./</span></span>
<span class="line"><span style="color:#032F62;">RUN go mod download</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">COPY . .</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -ldflags=&quot;-w -s&quot; -o app .</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Distroless 最终镜像</span></span>
<span class="line"><span style="color:#032F62;">FROM gcr.io/distroless/static-debian11</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">WORKDIR /app</span></span>
<span class="line"><span style="color:#032F62;">COPY --from=builder /app/app .</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">EXPOSE 8080</span></span>
<span class="line"><span style="color:#032F62;">CMD [&quot;/app/app&quot;]</span></span></code></pre></div><p><a href="https://cloud.tencent.com/developer/article/2242361" target="_blank" rel="noreferrer">https://cloud.tencent.com/developer/article/2242361</a></p><p><a href="https://cloud.tencent.com/developer/article/2242354" target="_blank" rel="noreferrer">https://cloud.tencent.com/developer/article/2242354</a></p>`,22),e=[o];function c(t,r,y,E,F,i){return a(),n("div",null,e)}const B=s(l,[["render",c]]);export{d as __pageData,B as default};
