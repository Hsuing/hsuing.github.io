import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const d=JSON.parse('{"title":"1. Ingress Yaml安装","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/Ingress/ingress_nginx/1-install.md","filePath":"guide/container/k8s/Ingress/ingress_nginx/1-install.md","lastUpdated":1729246382000}'),p={name:"guide/container/k8s/Ingress/ingress_nginx/1-install.md"},o=l(`<ul><li>环境基于centos7.9</li><li>k8s-1.22.x</li><li>ingress-1.4.0</li></ul><h1 id="_1-ingress-yaml安装" tabindex="-1">1. Ingress Yaml安装 <a class="header-anchor" href="#_1-ingress-yaml安装" aria-label="Permalink to &quot;1. Ingress Yaml安装&quot;">​</a></h1><blockquote><p>There are multiple ways to install the Ingress-Nginx Controller:</p><ul><li>with <a href="https://helm.sh/" target="_blank" rel="noreferrer">Helm</a>, using the project repository chart;</li><li>with <code>kubectl apply</code>, using YAML manifests;</li><li>with specific addons (e.g. for <a href="https://kubernetes.github.io/ingress-nginx/deploy/#minikube" target="_blank" rel="noreferrer">minikube</a> or <a href="https://kubernetes.github.io/ingress-nginx/deploy/#microk8s" target="_blank" rel="noreferrer">MicroK8s</a>).</li></ul></blockquote><ul><li><p>安装Ingress-nginx控制器；</p></li><li><p>使⽤daemonSet⽅式部署，但需要通过nodeSelect来选择⼏个节点安装，并⾮所有节点都需要；</p></li><li><p>将Pod的端⼝与节点共享⽹络名称空间；设定为HostNetwork；</p></li></ul><h2 id="_1-1-下载ingress文件" tabindex="-1">1.1 下载ingress文件 <a class="header-anchor" href="#_1-1-下载ingress文件" aria-label="Permalink to &quot;1.1 下载ingress文件&quot;">​</a></h2><ul><li>部署地址：<a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noreferrer">https://github.com/kubernetes/ingress-nginx</a></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#云</span></span>
<span class="line"><span style="color:#B392F0;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.4.0/deploy/static/provider/cloud/deploy.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 非云环境</span></span>
<span class="line"><span style="color:#B392F0;">https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.4.0/deploy/static/provider/baremetal/deploy.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#云</span></span>
<span class="line"><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.4.0/deploy/static/provider/cloud/deploy.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 非云环境</span></span>
<span class="line"><span style="color:#6F42C1;">https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.4.0/deploy/static/provider/baremetal/deploy.yaml</span></span></code></pre></div><h2 id="_1-2-修改配置" tabindex="-1">1.2 修改配置 <a class="header-anchor" href="#_1-2-修改配置" aria-label="Permalink to &quot;1.2 修改配置&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Daemonset</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#⽤DaemonSet确保每个节点都部署Ingress</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NodePort</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#9ECBFF;">registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.4.0</span></span>
<span class="line"><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/kube-webhook-certgen:v20220916-gd32f8c343</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">去掉digtest 验证</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">dnsPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterFirstWithHostNet</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 优先使⽤集群内的DNS解析服务</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">hostNetwork</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 使⽤主机网络</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">nodeSelector</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;">## 节点选择器（选择哪些节点部署Ingress，默认所有）</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">node-role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">## 如果节点有node-role=ingress 并且os=linux的标签，则在节点上运⾏Ingress Pod</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Daemonset</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#⽤DaemonSet确保每个节点都部署Ingress</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NodePort</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">image</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#032F62;">registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.4.0</span></span>
<span class="line"><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/kube-webhook-certgen:v20220916-gd32f8c343</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">去掉digtest 验证</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">dnsPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterFirstWithHostNet</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 优先使⽤集群内的DNS解析服务</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">hostNetwork</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 使⽤主机网络</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">nodeSelector</span><span style="color:#24292E;">: </span><span style="color:#6A737D;">## 节点选择器（选择哪些节点部署Ingress，默认所有）</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">node-role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">## 如果节点有node-role=ingress 并且os=linux的标签，则在节点上运⾏Ingress Pod</span></span></code></pre></div><h2 id="_1-3-为节点打标签" tabindex="-1">1.3 为节点打标签 <a class="header-anchor" href="#_1-3-为节点打标签" aria-label="Permalink to &quot;1.3 为节点打标签&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看node</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress-nginx]# kubectl get node</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">ROLES</span><span style="color:#E1E4E8;">                  </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">VERSION</span></span>
<span class="line"><span style="color:#B392F0;">k8s-master01</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">control-plane,master</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">40</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">kube-node01</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">38</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">kube-node02</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">39</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">kube-node03</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">39</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.17</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#为节点打上对应标签，否则Ingress⽆法正常调度到指定的节点运⾏</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress-nginx]# kubectl label nodes kube-node01 node-role=ingress</span></span>
<span class="line"><span style="color:#B392F0;">node/kube-node01</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">labeled</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress-nginx]# kubectl label nodes kube-node02 node-role=ingress</span></span>
<span class="line"><span style="color:#B392F0;">node/kube-node02</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">labeled</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看node</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master ingress-nginx]# kubectl get node</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">           </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ROLES</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">VERSION</span></span>
<span class="line"><span style="color:#6F42C1;">k8s-master01</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#032F62;">control-plane,master</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">40</span><span style="color:#032F62;">d</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">kube-node01</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">38</span><span style="color:#032F62;">d</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">kube-node02</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">39</span><span style="color:#032F62;">d</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">kube-node03</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">39</span><span style="color:#032F62;">d</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.17</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#为节点打上对应标签，否则Ingress⽆法正常调度到指定的节点运⾏</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master ingress-nginx]# kubectl label nodes kube-node01 node-role=ingress</span></span>
<span class="line"><span style="color:#6F42C1;">node/kube-node01</span><span style="color:#24292E;"> </span><span style="color:#032F62;">labeled</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master ingress-nginx]# kubectl label nodes kube-node02 node-role=ingress</span></span>
<span class="line"><span style="color:#6F42C1;">node/kube-node02</span><span style="color:#24292E;"> </span><span style="color:#032F62;">labeled</span></span></code></pre></div><h2 id="_1-4-创建ingress" tabindex="-1">1.4 创建ingress <a class="header-anchor" href="#_1-4-创建ingress" aria-label="Permalink to &quot;1.4 创建ingress&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress-nginx]# kubectl apply  -f deploy-1.4.0.yaml</span></span>
<span class="line"><span style="color:#B392F0;">namespace/ingress-nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unchanged</span></span>
<span class="line"><span style="color:#B392F0;">serviceaccount/ingress-nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unchanged</span></span>
<span class="line"><span style="color:#B392F0;">serviceaccount/ingress-nginx-admission</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unchanged</span></span>
<span class="line"><span style="color:#B392F0;">role.rbac.authorization.k8s.io/ingress-nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unchanged</span></span>
<span class="line"><span style="color:#B392F0;">role.rbac.authorization.k8s.io/ingress-nginx-admission</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unchanged</span></span>
<span class="line"><span style="color:#B392F0;">clusterrole.rbac.authorization.k8s.io/ingress-nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unchanged</span></span>
<span class="line"><span style="color:#B392F0;">clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unchanged</span></span>
<span class="line"><span style="color:#B392F0;">rolebinding.rbac.authorization.k8s.io/ingress-nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unchanged</span></span>
<span class="line"><span style="color:#B392F0;">rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unchanged</span></span>
<span class="line"><span style="color:#B392F0;">clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unchanged</span></span>
<span class="line"><span style="color:#B392F0;">clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unchanged</span></span>
<span class="line"><span style="color:#B392F0;">configmap/ingress-nginx-controller</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unchanged</span></span>
<span class="line"><span style="color:#B392F0;">service/ingress-nginx-controller</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">service/ingress-nginx-controller-admission</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unchanged</span></span>
<span class="line"><span style="color:#B392F0;">daemonset.apps/ingress-nginx-controller</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">configured</span></span>
<span class="line"><span style="color:#B392F0;">job.batch/ingress-nginx-admission-create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unchanged</span></span>
<span class="line"><span style="color:#B392F0;">job.batch/ingress-nginx-admission-patch</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unchanged</span></span>
<span class="line"><span style="color:#B392F0;">ingressclass.networking.k8s.io/nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unchanged</span></span>
<span class="line"><span style="color:#B392F0;">validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">configured</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress-nginx]# kubectl apply  -f deploy-1.4.0.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">namespace/ingress-nginx</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unchanged</span></span>
<span class="line"><span style="color:#6F42C1;">serviceaccount/ingress-nginx</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unchanged</span></span>
<span class="line"><span style="color:#6F42C1;">serviceaccount/ingress-nginx-admission</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unchanged</span></span>
<span class="line"><span style="color:#6F42C1;">role.rbac.authorization.k8s.io/ingress-nginx</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unchanged</span></span>
<span class="line"><span style="color:#6F42C1;">role.rbac.authorization.k8s.io/ingress-nginx-admission</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unchanged</span></span>
<span class="line"><span style="color:#6F42C1;">clusterrole.rbac.authorization.k8s.io/ingress-nginx</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unchanged</span></span>
<span class="line"><span style="color:#6F42C1;">clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unchanged</span></span>
<span class="line"><span style="color:#6F42C1;">rolebinding.rbac.authorization.k8s.io/ingress-nginx</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unchanged</span></span>
<span class="line"><span style="color:#6F42C1;">rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unchanged</span></span>
<span class="line"><span style="color:#6F42C1;">clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unchanged</span></span>
<span class="line"><span style="color:#6F42C1;">clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unchanged</span></span>
<span class="line"><span style="color:#6F42C1;">configmap/ingress-nginx-controller</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unchanged</span></span>
<span class="line"><span style="color:#6F42C1;">service/ingress-nginx-controller</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">service/ingress-nginx-controller-admission</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unchanged</span></span>
<span class="line"><span style="color:#6F42C1;">daemonset.apps/ingress-nginx-controller</span><span style="color:#24292E;"> </span><span style="color:#032F62;">configured</span></span>
<span class="line"><span style="color:#6F42C1;">job.batch/ingress-nginx-admission-create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unchanged</span></span>
<span class="line"><span style="color:#6F42C1;">job.batch/ingress-nginx-admission-patch</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unchanged</span></span>
<span class="line"><span style="color:#6F42C1;">ingressclass.networking.k8s.io/nginx</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unchanged</span></span>
<span class="line"><span style="color:#6F42C1;">validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission</span><span style="color:#24292E;"> </span><span style="color:#032F62;">configured</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>报错，The Service &quot;ingress-nginx-controller&quot; is invalid: spec.externalTrafficPolicy: Invalid value: &quot;Local&quot;: ExternalTrafficPolicy can onlybe set on NodePort and LoadBalancer service</p><p>To resolve this issue, you need to make sure that the <code>externalTrafficPolicy</code> field is only set for <code>NodePort</code> or <code>LoadBalancer</code></p></div><ul><li>查看</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get pod,svc,ds -n ingress-nginx</span></span>
<span class="line"><span style="color:#B392F0;">pod/ingress-nginx-admission-create-c799q</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Completed</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">d1h</span></span>
<span class="line"><span style="color:#B392F0;">pod/ingress-nginx-admission-patch-wzm82</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Completed</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">d1h</span></span>
<span class="line"><span style="color:#B392F0;">pod/ingress-nginx-controller-gcv4v</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">h39m</span></span>
<span class="line"><span style="color:#B392F0;">pod/ingress-nginx-controller-hs58n</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">h39m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                         </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">CLUSTER-IP</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">EXTERNAL-IP</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">PORT</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">S</span><span style="color:#E1E4E8;">)                      </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">service/ingress-nginx-controller</span><span style="color:#E1E4E8;">             </span><span style="color:#9ECBFF;">NodePort</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.104.132</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">:31592/TCP,443:31125/TCP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">d</span></span>
<span class="line"><span style="color:#B392F0;">service/ingress-nginx-controller-admission</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">ClusterIP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.53.76</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">443</span><span style="color:#9ECBFF;">/TCP</span><span style="color:#E1E4E8;">                      </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">d1h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                      </span><span style="color:#9ECBFF;">DESIRED</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">CURRENT</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">UP-TO-DATE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AVAILABLE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">SELECTOR</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">daemonset.apps/ingress-nginx-controller</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">kubernetes.io/os=linux,node-role=ingress</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">d1h</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get pod,svc,ds -n ingress-nginx</span></span>
<span class="line"><span style="color:#6F42C1;">pod/ingress-nginx-admission-create-c799q</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">d1h</span></span>
<span class="line"><span style="color:#6F42C1;">pod/ingress-nginx-admission-patch-wzm82</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">d1h</span></span>
<span class="line"><span style="color:#6F42C1;">pod/ingress-nginx-controller-gcv4v</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">h39m</span></span>
<span class="line"><span style="color:#6F42C1;">pod/ingress-nginx-controller-hs58n</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">h39m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                         </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">        </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">        </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)                      </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">service/ingress-nginx-controller</span><span style="color:#24292E;">             </span><span style="color:#032F62;">NodePort</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.104.132</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">:31592/TCP,443:31125/TCP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">d</span></span>
<span class="line"><span style="color:#6F42C1;">service/ingress-nginx-controller-admission</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.53.76</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">443</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">                      </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">d1h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                      </span><span style="color:#032F62;">DESIRED</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CURRENT</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">UP-TO-DATE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AVAILABLE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">SELECTOR</span><span style="color:#24292E;">    </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">daemonset.apps/ingress-nginx-controller</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">           </span><span style="color:#032F62;">kubernetes.io/os=linux,node-role=ingress</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">d1h</span></span></code></pre></div><ul><li>pod介绍</li></ul><p><strong>ingress-nginx-controllerService</strong>：这个Service负责将请求转发到ingress-nginx-controller Pods。它通常会将流量分发到ingress-nginx-controller的多个副本中，并确保副本集的负载平衡。这个Service可以被配置为使用NodePort、LoadBalancer或ClusterlP类型，根据需要进行暴露。</p><p><strong>ingress-nginx-controller-admissionService</strong>：用于检查和验证Ingress中定义的规则和设置是否正确。它可以确保在创建、更新或删除Ingress资源时，所有必需的配置项都已正确设置，并防止不正确的配置影响到您的应用程序的运行。此服务还可以执行一些自动化的操作，例如生成TLs证书并将其与相应的Ingress资源关联，以确保通过Ingress的所有流量都以加密的方式传输。该Service也可以被配置为使用NodePort、LoadBalancer或ClusterlP类型，根据需要进行暴露。</p><h1 id="_2-ingress-controller的暴露方式" tabindex="-1">2. Ingress Controller的暴露方式 <a class="header-anchor" href="#_2-ingress-controller的暴露方式" aria-label="Permalink to &quot;2. Ingress Controller的暴露方式&quot;">​</a></h1><p>当使用k8s中的Ingress资源对象来暴露应用时，用户访问应用的入口是IngressController 的地址。</p><p>Ingress Controller会根据Ingress 规则将请求路由到相应的服务，并将服务的响应返回给客户端。</p><p>要把Ingress Controller暴露出去暴露方式有以下几种：</p><ul><li><p>NodePort：使用 NodePort 服务类型来暴露Ingress Controller，这种方式可以将Ingress Controller 暴露到长uibernetes 集群的所有节点上，通过节点的IP地址和NodePort 可以访问到Ipgress Controller。</p><ul><li>优点：比较简单，易于配置和管理</li><li>缺点：需要暴露每个节点的端口，容易造成端口泛滥，不易于后续管理，或者在安全方面存在一些隐患。</li></ul></li><li><p>LoadBalancer（推荐）：使用LoadBalancer服务类型来暴露IngressController，这种方式可以将IngressController暴露到云服务提供商的负载均衡器上，从而可以通过负载均衡器的IP地址来访问IngressController。可以实现更好的负载均衡和高可用性。</p><ul><li>优点：可以自动创建负载均衡器，可以动态地分配IP地址，易于管理和扩展</li><li>缺点：需要依赖云尺商提供的负载均衡器服务，对于一些不支持负载均衡器服务的云平台或者本地环境不太适用</li></ul></li></ul><h2 id="案例" tabindex="-1">案例 <a class="header-anchor" href="#案例" aria-label="Permalink to &quot;案例&quot;">​</a></h2><h3 id="创建deployment-yaml文件" tabindex="-1">创建deployment yaml文件 <a class="header-anchor" href="#创建deployment-yaml文件" aria-label="Permalink to &quot;创建deployment yaml文件&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat dp.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-dm</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">imagePullPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-svc</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NodePort</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat dp.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-dm</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">imagePullPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-svc</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NodePort</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span></code></pre></div><ul><li>创建</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl apply  -f dp.yaml</span></span>
<span class="line"><span style="color:#B392F0;">deployment.apps/nginx-dm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl apply  -f dp.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/nginx-dm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get svc</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">CLUSTER-IP</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">EXTERNAL-IP</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">PORT</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">S</span><span style="color:#E1E4E8;">)          </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">nginx-svc</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">NodePort</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.26.95</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">/TCP</span><span style="color:#E1E4E8;">           </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get svc</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">           </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">        </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">       </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)          </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-svc</span><span style="color:#24292E;">      </span><span style="color:#032F62;">NodePort</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.26.95</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">s</span></span></code></pre></div><h3 id="创建ingres文件" tabindex="-1">创建ingres文件 <a class="header-anchor" href="#创建ingres文件" aria-label="Permalink to &quot;创建ingres文件&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">my-ingress</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;nginx&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">my.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-svc</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">my-ingress</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;nginx&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">my.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-svc</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><ul><li>创建</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl apply -f ingres-nginx.yaml</span></span>
<span class="line"><span style="color:#B392F0;">ingress.networking.k8s.io/my-ingress</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl apply -f ingres-nginx.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">ingress.networking.k8s.io/my-ingress</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get ingress</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">CLASS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">HOSTS</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">ADDRESS</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">PORTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">my-ingress</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">nginx</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">my.host.com</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.104.132</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">105</span><span style="color:#9ECBFF;">s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get ingress</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">         </span><span style="color:#032F62;">CLASS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">HOSTS</span><span style="color:#24292E;">         </span><span style="color:#032F62;">ADDRESS</span><span style="color:#24292E;">           </span><span style="color:#032F62;">PORTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">my-ingress</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">   </span><span style="color:#032F62;">my.host.com</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.104.132</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">105</span><span style="color:#032F62;">s</span></span></code></pre></div><ul><li>客户端测试</li></ul><p>配置windows，C:\\Windows\\System32\\drivers\\etc，<code>将域名解析安装了Ingress节点的地址</code>，然后测试访问</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405201826571.png" alt="image-20240520182555578"></p><ul><li>查看效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405201828340.png" alt="image-20240520182808279"></p><p>视频</p><p><a href="https://www.taohui.tech/2021/05/17/k8s/%E5%9C%A8%E7%BA%BF%E8%AF%BE%E7%A8%8B%EF%BC%9AK8S-Ingress-Controller%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82%E6%8E%A2%E8%AE%A8/" target="_blank" rel="noreferrer">https://www.taohui.tech/2021/05/17/k8s/在线课程：K8S-Ingress-Controller技术细节探讨/</a></p><p><a href="https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/advanced-nginx-ingress-configurations" target="_blank" rel="noreferrer">https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/advanced-nginx-ingress-configurations</a></p><p><a href="https://www.nginx-cn.net/blog/performance-testing-nginx-ingress-controllers-dynamic-kubernetes-cloud-environment/" target="_blank" rel="noreferrer">https://www.nginx-cn.net/blog/performance-testing-nginx-ingress-controllers-dynamic-kubernetes-cloud-environment/</a></p>`,46),e=[o];function r(c,t,E,y,i,F){return n(),a("div",null,e)}const u=s(p,[["render",r]]);export{d as __pageData,u as default};
