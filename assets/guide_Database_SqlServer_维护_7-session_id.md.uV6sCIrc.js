import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const _=JSON.parse('{"title":"1.查看阻塞","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/SqlServer/维护/7-session_id.md","filePath":"guide/Database/SqlServer/维护/7-session_id.md","lastUpdated":1739268373000}'),o={name:"guide/Database/SqlServer/维护/7-session_id.md"},p=l(`<p>在应用系统反应慢或者卡死，无非下面两种情况。</p><ol><li>应用系统自身的问题。</li><li>SQL查询读写互相阻塞。</li></ol><p>第一种问题的排查方法很简单，即查看SQLServer数据库是否CPU 100%，是否有长时间被阻塞的查询进程，如果没有多半是应用程序的问题，或者网络问题。</p><p>第二种问题又分当前正在发生的阻塞，或者曾经发生过阻塞但是当前已工作正常</p><h1 id="_1-查看阻塞" tabindex="-1">1.查看阻塞 <a class="header-anchor" href="#_1-查看阻塞" aria-label="Permalink to &quot;1.查看阻塞&quot;">​</a></h1><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> cteBL (session_id, blocking_these) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;">, blocking_these </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">x</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_these</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sessions</span><span style="color:#E1E4E8;"> s</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;">    (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">isnull</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">convert</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;">),</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;, &#39;</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> er</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">isnull</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> ,</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PATH</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">) ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> x (blocking_these)</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;">, blocked_by </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">bl</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_these</span></span>
<span class="line"><span style="color:#E1E4E8;">, batch_text </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">, input_buffer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ib</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">event_info</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sessions</span><span style="color:#E1E4E8;"> s</span></span>
<span class="line"><span style="color:#F97583;">LEFT OUTER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> r </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> cteBL </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> bl </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">bl</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"><span style="color:#F97583;">OUTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">) t</span></span>
<span class="line"><span style="color:#F97583;">OUTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_input_buffer</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> ib</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> blocking_these </span><span style="color:#F97583;">is not null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">bl</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_these</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">desc</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">desc</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> cteBL (session_id, blocking_these) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;">, blocking_these </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">x</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_these</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sessions</span><span style="color:#24292E;"> s</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;">    (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">isnull</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">convert</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">6</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;">),</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;, &#39;</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> er</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">isnull</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> ,</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PATH</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">) ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> x (blocking_these)</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;">, blocked_by </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">bl</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_these</span></span>
<span class="line"><span style="color:#24292E;">, batch_text </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">, input_buffer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ib</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">event_info</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sessions</span><span style="color:#24292E;"> s</span></span>
<span class="line"><span style="color:#D73A49;">LEFT OUTER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> r </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> cteBL </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> bl </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">bl</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"><span style="color:#D73A49;">OUTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">) t</span></span>
<span class="line"><span style="color:#D73A49;">OUTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_input_buffer</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> ib</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> blocking_these </span><span style="color:#D73A49;">is not null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">len</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">bl</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_these</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">desc</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">desc</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;">;</span></span></code></pre></div><h1 id="_2-排查" tabindex="-1">2.排查 <a class="header-anchor" href="#_2-排查" aria-label="Permalink to &quot;2.排查&quot;">​</a></h1><p>排查是否是阻塞导致的问题，首先要排查下面的问题：</p><ol><li>是否是服务器CPU高导致</li><li>在服务器上执行一个SQL是否缓慢。</li><li>网络正常。</li></ol><p><a href="https://mp.weixin.qq.com/s/qZepNFWhqTy0Obqf56u5NQ" target="_blank" rel="noreferrer">https://mp.weixin.qq.com/s/qZepNFWhqTy0Obqf56u5NQ</a></p><p><a href="https://www.dbaup.com/mssqlshiyongchaxuncunchulaijianshixingneng.html" target="_blank" rel="noreferrer">https://www.dbaup.com/mssqlshiyongchaxuncunchulaijianshixingneng.html</a></p>`,11),e=[p];function c(t,r,E,y,i,F){return n(),a("div",null,e)}const d=s(o,[["render",c]]);export{_ as __pageData,d as default};
