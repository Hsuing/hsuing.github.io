import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const d=JSON.parse('{"title":"1. Kubernetes认证、授权与准入控制","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/权限管理/index.md","filePath":"guide/container/k8s/权限管理/index.md","lastUpdated":1734344767000}'),p={name:"guide/container/k8s/权限管理/index.md"},o=l(`<p>RBAC（基于角色的访问控制）</p><p>role/roleBingding</p><p>ClusterRole/ClusterRoleBingding</p><p>ServiceAccount</p><h1 id="_1-kubernetes认证、授权与准入控制" tabindex="-1">1. Kubernetes认证、授权与准入控制 <a class="header-anchor" href="#_1-kubernetes认证、授权与准入控制" aria-label="Permalink to &quot;1. Kubernetes认证、授权与准入控制&quot;">​</a></h1><h2 id="_1-1-认证基本概念" tabindex="-1">1.1 认证基本概念 <a class="header-anchor" href="#_1-1-认证基本概念" aria-label="Permalink to &quot;1.1 认证基本概念&quot;">​</a></h2><h3 id="_1-1-1-为什么需要验证" tabindex="-1">1.1.1 为什么需要验证 <a class="header-anchor" href="#_1-1-1-为什么需要验证" aria-label="Permalink to &quot;1.1.1 为什么需要验证&quot;">​</a></h3><p>对于Kubernetes系统来说，，<code>APIServer</code>肯定不是任何人都能轻易访问的，如果任何人都能轻易的访问，意味着可以通过<code>kubectl</code>命令访问APIServer，进而操作Kubernetes。也就意味着它能够在我们的系统上随便部署应用程序，甚至还会删除我们正在运行的应用程序，这是非常危险的。所以我们需要对用户进行<code>身份认证</code>，确保身份是合法.</p><h3 id="_1-1-2-认证流程" tabindex="-1">1.1.2 认证流程 <a class="header-anchor" href="#_1-1-2-认证流程" aria-label="Permalink to &quot;1.1.2 认证流程&quot;">​</a></h3><p>任何客户端用户试图通过 <code>APIServer</code>操作资源对象时，它们必须经历多个阶段的访问控制，才会被接受处理，其中包含认证、授权以及准入控制</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406161842880.png" alt="image-20240616184222954"></p><p>1.认证：任何客户端访问，经过API操作之前，需要先完成认证操作，也就是进行<code>身份认证</code>;</p><p>2.授权：认证通过后仅代表它是一个合法的系统用户，但它是否拥有删除对应资源权限，需要进行<code>授权检查</code></p><p>3.准入控制：虽然我们有了权限，也可以创建Pod等各种资源，但创建Pod是否能成功呢，假设ops名称空间限制最多创建2个Pod，目前已经有2个Pod了，那么这次的创建就会失败。</p><h3 id="_1-1-3-认证方式" tabindex="-1">1.1.3 认证方式 <a class="header-anchor" href="#_1-1-3-认证方式" aria-label="Permalink to &quot;1.1.3 认证方式&quot;">​</a></h3><h4 id="useraccount" tabindex="-1">UserAccount <a class="header-anchor" href="#useraccount" aria-label="Permalink to &quot;UserAccount&quot;">​</a></h4><p>使用kubectl创建资源，首先要进行客户端身份认证，所以客户端每次在请求APIServer时都会携带上数字证书，用于认证API-Server，当认证通过后，证书中的<code>Subject</code>将被识别为用户标识，其中的CN字段的值为用户名，字段O的值就是用户所属的组，例如：<code>Subject：0=ops，CN=k8</code>用户名为k8，用户的组为ops。</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406161850349.png" alt="image-20240616185036588"></p><h4 id="serviceaccount" tabindex="-1">ServiceAccount <a class="header-anchor" href="#serviceaccount" aria-label="Permalink to &quot;ServiceAccount&quot;">​</a></h4><p>有些情况下，我们希望在pod内部能够访问API-Server，获取集群的信息，甚至对集群进行改动。针对这种情况，kubernetes提供了一种特殊的认证方式：ServiceAccount。</p><p>默认情况下，创建的Pod如果没有指定ServiceAccount则系统会默认提供一个ServiceAccount，而后通过mount方式挂载到Pod的文件系统中(/var/run/secretes/kubernetes.io/serviceaccount/token)，该ServiceAccount能通过DownWardAPI获取该Pod相关的一些元数据信息。当然也可以自行创建ServiceAccount来完成API-Server的身份认证，至于能否对集群进行改变，则需要看该ServiceAccount是否拥有权限。</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406161854449.png" alt="image-20240616185404426"></p><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><ul><li>同一个命名空间下的多个pod可以使用同一个ServiceAccount</li><li>pod只能使用同一个命名空间下的ServiceAccount</li><li>如果在pod的manifest文件中没有显示的指定ServiceAccount名称.则默认使用default ServiceAccount</li></ul></div><h2 id="_1-2-rbac授权" tabindex="-1">1.2 RBAC授权 <a class="header-anchor" href="#_1-2-rbac授权" aria-label="Permalink to &quot;1.2 RBAC授权&quot;">​</a></h2><p><a href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/" target="_blank" rel="noreferrer">官当</a></p><h3 id="特点" tabindex="-1">特点： <a class="header-anchor" href="#特点" aria-label="Permalink to &quot;特点：&quot;">​</a></h3><ol><li><strong>细粒度授权</strong>： <ul><li>RBAC提供了一种基于角色的灵活授权模式，可以根据角色定义不同级别的API访问权限，包括读取、写入、更新和删除等操作。</li></ul></li><li><strong>最小权限原则</strong>： <ul><li>鼓励遵循最小权限原则，即每个用户或服务账户仅被赋予完成其工作所需的最低权限，从而降低潜在的安全风险。</li></ul></li><li><strong>职责分离</strong>： <ul><li>支持明确的职责划分，不同的角色可以对应不同的运维任务，例如，开发团队可以拥有只对自己命名空间内应用进行管理的权限，而集群管理员则负责整个集群的维护。</li></ul></li><li><strong>角色与绑定</strong>： <ul><li>Kubernetes通过Role和ClusterRole来定义权限集合，并通过RoleBinding和ClusterRoleBinding将这些权限绑定到特定的用户、组或服务账户上。</li></ul></li><li><strong>层次化权限结构</strong>： <ul><li>提供了层级化的权限结构，其中ClusterRole适用于整个集群范围内的资源，而Role则针对特定的Namespace。</li></ul></li><li><strong>动态管理</strong>： <ul><li>权限可以通过API动态创建、修改或删除，使得权限管理更加便捷和实时。</li></ul></li><li><strong>符合安全标准和法规要求</strong>： <ul><li>通过实施严格的权限管理策略，有助于满足各类行业安全标准和法规对权限控制的要求。</li></ul></li></ol><h3 id="_1-2-0-如何开启rbac" tabindex="-1">1.2.0 如何开启RBAC <a class="header-anchor" href="#_1-2-0-如何开启rbac" aria-label="Permalink to &quot;1.2.0 如何开启RBAC&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-C3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;authorization-mode&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/manifests/kube-apiserver.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#- --feature-gates=RemoveSelfLink=false</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--advertise-address=10.103.236.201</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--allow-privileged=true</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--authorization-mode=Node,RBAC</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--client-ca-file=/etc/kubernetes/pki/ca.crt</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--enable-admission-plugins=NodeRestriction</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--enable-bootstrap-token-auth=true</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-C3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;authorization-mode&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/manifests/kube-apiserver.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">#- --feature-gates=RemoveSelfLink=false</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--advertise-address=10.103.236.201</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--allow-privileged=true</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--authorization-mode=Node,RBAC</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--client-ca-file=/etc/kubernetes/pki/ca.crt</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--enable-admission-plugins=NodeRestriction</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--enable-bootstrap-token-auth=true</span></span></code></pre></div><p>API Server目前支持以下几种授权策略：</p><ul><li><strong>AlwaysDeny</strong>：表示拒绝所有请求，一般用于测试。</li><li><strong>AlwaysAllow</strong>：允许接收所有请求。 如果集群不需要授权流程，则可以采用该策略，这也是Kubernetes的默认配置。</li><li><strong>ABAC</strong>（Attribute-Based Access Control）：基于属性的访问控制。 表示使用用户配置的授权规则对用户请求进行匹配和控制。</li><li>Webhook：通过调用外部REST服务对用户进行授权。</li><li><strong>RBAC</strong>：Role-Based Access Control，基于角色的访问控制</li><li><strong>Node</strong>：是一种专用模式，用于对kubelet发出的请求进行访问控制。</li></ul><h3 id="_1-2-1-什么是rbac" tabindex="-1">1.2.1 什么是RBAC <a class="header-anchor" href="#_1-2-1-什么是rbac" aria-label="Permalink to &quot;1.2.1 什么是RBAC&quot;">​</a></h3><p><code>RBAC（RoleBasedAccessControl）</code>基于角色的访问控制；其实就是将资源的操作权限授予给指定的角色，而后将用户加入该角色，那么该用户则拥有了对应角色的权限;</p><p>授权过程:</p><ol><li>定义角色(Role and ClusterRole)：在定义角色时会指定此角色对于资源访问控制的一系列规则；</li></ol><ol start="2"><li>定义主体(&quot;User&quot;, &quot;Group&quot; or &quot;ServiceAccount&quot;): 客户端标识；</li><li>绑定角色RoleBinding and ClusterRoleBinding：将主体与角色进行绑定，对用户进行访问授权。</li></ol><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202407121548390.png" alt="image-20240712154756886"></p><p>简单来说:</p><ul><li><strong>RBAC（Role-Based Access Control，基于角色的访问控制）</strong>，允许通过Kubernetes API动态配置策略。</li><li><strong>角色</strong><ul><li>Role：授权<strong>特定命名空间</strong>的访问权限</li><li>ClusterRole：授权<strong>所有命名空间</strong>的访问权限</li></ul></li><li><strong>角色绑定</strong><ul><li>RoleBinding：将角色绑定到主体（即subject）</li><li>ClusterRoleBinding：将集群角色绑定到主体</li></ul></li><li><strong>主体（subject）</strong><ul><li>User：用户</li><li>Group：用户组</li><li>ServiceAccount：服务账号</li></ul></li></ul><h3 id="_1-2-2-rbac角色与集群角色" tabindex="-1">1.2.2 RBAC角色与集群角色 <a class="header-anchor" href="#_1-2-2-rbac角色与集群角色" aria-label="Permalink to &quot;1.2.2 RBAC角色与集群角色&quot;">​</a></h3><p>Kubernetes系统的RBAC授权插件将角色分为了RoLe和CLusterRoLe两类：</p><ul><li>RoLe：仅作用于名称空间级别，用于承载名称空间级别内的资源权限集合。</li><li>ClusterRole：作用于集群范围，能够同时承载名称空间和集群级别的资源权限集合。</li></ul><p>Kubernetes利用<code>Role</code>和<code>CLusterRoLe</code>两类角色来赋予对应的权限，同时也需要用到另外两类资源<code>RoLebinding</code>和<code>CLusterRoLebinding</code>来完成用户与角色之间的绑定关系；</p><h3 id="_1-2-3-role" tabindex="-1">1.2.3 Role <a class="header-anchor" href="#_1-2-3-role" aria-label="Permalink to &quot;1.2.3 Role&quot;">​</a></h3><p>Role是一系列的权限的集合，在命名空间内定义的权限集合。它只能在指定的命名空间内生效。</p><p>例如一个Role可以包含读取 Pod 的权限和列出 Pod 的权限,Role只能授予单个 namespace 中资源的访问权限,比如：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Role</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">default</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod-reader</span></span>
<span class="line"><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;"># &quot;&quot; indicates the core API group</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;pods&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#resourceNames: [&quot;my-pod&quot;]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;get&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;watch&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Role</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">default</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod-reader</span></span>
<span class="line"><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">] </span><span style="color:#6A737D;"># &quot;&quot; indicates the core API group</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;pods&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">#resourceNames: [&quot;my-pod&quot;]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;get&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">]</span></span></code></pre></div><p>参数解释:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"># 首先，Role对象指定了它能产生作用的Namespace(mynamespace)。# Namespace是kubernetes项目中的一个逻辑管理单位。不同Namespace的API对象，</span></span>
<span class="line"><span style="color:#e1e4e8;"># 在通过kubectl命令进行操作的时候，是互相隔离的</span></span>
<span class="line"><span style="color:#e1e4e8;"># namespace并不会提供任何实际的隔离或者多租户能力，如果没有设置namespace默认则是default</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># apiGroups: 支持的API组列表,例如&quot;“apiVersion: batch/v1”“apiVersion: extensions:v1”“apiVersion: apps/v1”等”</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># resources: 支持的资源对象列表,例如Pods,deployments,jobs等</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># verbs: 对资源对象的操作方法列表,例如get,watch,list,delete,replace,patch等</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># rules字段定义它的是权限规则,这条规则的含义就是允许&quot;被作用者&quot; ,对namespace下面Pod(resources中定义)有哪些权限;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># 用户的权限对应的API资源对象已经创建了,但是还没有绑定,也就是只有一个规则没有规定哪些用户有这个权限</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"># 首先，Role对象指定了它能产生作用的Namespace(mynamespace)。# Namespace是kubernetes项目中的一个逻辑管理单位。不同Namespace的API对象，</span></span>
<span class="line"><span style="color:#24292e;"># 在通过kubectl命令进行操作的时候，是互相隔离的</span></span>
<span class="line"><span style="color:#24292e;"># namespace并不会提供任何实际的隔离或者多租户能力，如果没有设置namespace默认则是default</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># apiGroups: 支持的API组列表,例如&quot;“apiVersion: batch/v1”“apiVersion: extensions:v1”“apiVersion: apps/v1”等”</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># resources: 支持的资源对象列表,例如Pods,deployments,jobs等</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># verbs: 对资源对象的操作方法列表,例如get,watch,list,delete,replace,patch等</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># rules字段定义它的是权限规则,这条规则的含义就是允许&quot;被作用者&quot; ,对namespace下面Pod(resources中定义)有哪些权限;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># 用户的权限对应的API资源对象已经创建了,但是还没有绑定,也就是只有一个规则没有规定哪些用户有这个权限</span></span></code></pre></div><h3 id="_1-2-4-clusterrole" tabindex="-1">1.2.4 ClusterRole <a class="header-anchor" href="#_1-2-4-clusterrole" aria-label="Permalink to &quot;1.2.4 ClusterRole&quot;">​</a></h3><p>ClusterRole授权 &gt;= Role授予（与Role类似），但ClusterRole属于集群级别对象，可以在整个集群范围内生效。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRole</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># &quot;namespace&quot; omitted since ClusterRoles are not namespaced</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">secret-reader</span></span>
<span class="line"><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;secrets&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;get&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;watch&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRole</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># &quot;namespace&quot; omitted since ClusterRoles are not namespaced</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">secret-reader</span></span>
<span class="line"><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;secrets&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;get&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">]</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#默认 获取 ClusterRole</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clusterroles</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--namespace=kube-system</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#默认 获取 ClusterRole</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clusterroles</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--namespace=kube-system</span></span></code></pre></div><ul><li></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master manifests]#  kubectl describe clusterrole cluster-admin -n kube-system</span></span>
<span class="line"><span style="color:#B392F0;">Name:</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">cluster-admin</span></span>
<span class="line"><span style="color:#B392F0;">Labels:</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">kubernetes.io/bootstrapping=rbac-defaults</span></span>
<span class="line"><span style="color:#B392F0;">Annotations:</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">rbac.authorization.kubernetes.io/autoupdate:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#B392F0;">PolicyRule:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Resources</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Non-Resource</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">URLs</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Resource</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Names</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Verbs</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">---------</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-----------------</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--------------</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-----</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">*.*</span><span style="color:#E1E4E8;">        []                 []              [</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">             [</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">]                []              [</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master manifests]#  kubectl describe clusterrole cluster-admin -n kube-system</span></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">         </span><span style="color:#032F62;">cluster-admin</span></span>
<span class="line"><span style="color:#6F42C1;">Labels:</span><span style="color:#24292E;">       </span><span style="color:#032F62;">kubernetes.io/bootstrapping=rbac-defaults</span></span>
<span class="line"><span style="color:#6F42C1;">Annotations:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">rbac.authorization.kubernetes.io/autoupdate:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#6F42C1;">PolicyRule:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Resources</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Non-Resource</span><span style="color:#24292E;"> </span><span style="color:#032F62;">URLs</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Resource</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Names</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Verbs</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">---------</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">-----------------</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">--------------</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">-----</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">*.*</span><span style="color:#24292E;">        []                 []              [</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">             [</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">]                []              [</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">]</span></span></code></pre></div><h3 id="_1-2-5-rolebinding" tabindex="-1">1.2.5 RoleBinding <a class="header-anchor" href="#_1-2-5-rolebinding" aria-label="Permalink to &quot;1.2.5 RoleBinding&quot;">​</a></h3><p>将 Role 与一个或多个用户、组或服务账户绑定，赋予在特定命名空间内的权限。</p><p>比如以下 RoleBinding 是将 default 命名空间的 pod-reader Role 授予 bmw 用户，此后 bmw 用户在 default 命名空间中将具有 pod-reader 的权限</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># This role binding allows &quot;bmw&quot; to read pods in the &quot;default&quot; namespace.</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">RoleBinding</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">read-pods</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">default</span></span>
<span class="line"><span style="color:#85E89D;">subjects</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">User</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># May be &quot;User&quot;, &quot;Group&quot; or &quot;ServiceAccount&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">bmw</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">apiGroup</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#85E89D;">roleRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Role</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod-reader</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">apiGroup</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># This role binding allows &quot;bmw&quot; to read pods in the &quot;default&quot; namespace.</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RoleBinding</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">read-pods</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">default</span></span>
<span class="line"><span style="color:#22863A;">subjects</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">User</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># May be &quot;User&quot;, &quot;Group&quot; or &quot;ServiceAccount&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">bmw</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#22863A;">roleRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Role</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod-reader</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span></code></pre></div><ul><li>kubectl</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rolebinding</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">read-pods</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--role=pod-reader</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--user=bmw</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--namespace=default</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rolebindings.rbac.authorization.k8s.io</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wide</span></span>
<span class="line"><span style="color:#B392F0;">其它类似</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">subjects:</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rolebinding</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">read-pods-svc</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--role=pod-reader</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--serviceaccount=default:bmw-svc</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--namespace=default</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rolebinding</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">read-pods-group</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--role=pod-reader</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--group=bmw-group</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--namespace=default</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rolebinding</span><span style="color:#24292E;"> </span><span style="color:#032F62;">read-pods</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--role=pod-reader</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--user=bmw</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--namespace=default</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;">  </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rolebindings.rbac.authorization.k8s.io</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wide</span></span>
<span class="line"><span style="color:#6F42C1;">其它类似</span><span style="color:#24292E;"> </span><span style="color:#032F62;">subjects:</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rolebinding</span><span style="color:#24292E;"> </span><span style="color:#032F62;">read-pods-svc</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--role=pod-reader</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--serviceaccount=default:bmw-svc</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--namespace=default</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rolebinding</span><span style="color:#24292E;"> </span><span style="color:#032F62;">read-pods-group</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--role=pod-reader</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--group=bmw-group</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--namespace=default</span></span></code></pre></div><h3 id="_1-2-6-clusterrolebinding" tabindex="-1">1.2.6 ClusterRoleBinding <a class="header-anchor" href="#_1-2-6-clusterrolebinding" aria-label="Permalink to &quot;1.2.6 ClusterRoleBinding&quot;">​</a></h3><p>ClusterRoleBinding 适用于集群范围内的授权，也就是说可以跨namespace</p><p>比如以下 ClusterRoleBinding 是将 bmw 用户在任意namespace中都具有 pod-reader 的权限：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRoleBinding</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">read-pods-global</span></span>
<span class="line"><span style="color:#85E89D;">subjects</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">User</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">bmw</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">apiGroup</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#85E89D;">roleRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRole</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cluster-pod-reader</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">apiGroup</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRoleBinding</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">read-pods-global</span></span>
<span class="line"><span style="color:#22863A;">subjects</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">User</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">bmw</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#22863A;">roleRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRole</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cluster-pod-reader</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span></code></pre></div><ul><li>kubectl</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clusterrolebinding</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">read-pods-global</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--clusterrole=cluster-pod-reader</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--user=bmw</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clusterrolebindings.rbac.authorization.k8s.io</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wide</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clusterrolebinding</span><span style="color:#24292E;"> </span><span style="color:#032F62;">read-pods-global</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--clusterrole=cluster-pod-reader</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--user=bmw</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;">  </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clusterrolebindings.rbac.authorization.k8s.io</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wide</span></span></code></pre></div><h3 id="_1-2-7-serviceaccount" tabindex="-1">1.2.7 ServiceAccount <a class="header-anchor" href="#_1-2-7-serviceaccount" aria-label="Permalink to &quot;1.2.7 ServiceAccount&quot;">​</a></h3><p>一种特殊的 Kubernetes 账户，通常用于容器或应用程序访问 Kubernetes API。</p><h2 id="_1-3-rbac权限定义" tabindex="-1">1.3 RBAC权限定义 <a class="header-anchor" href="#_1-3-rbac权限定义" aria-label="Permalink to &quot;1.3 RBAC权限定义&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">1.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apiGroups:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">指定哪个</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">API</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">组下的权限,比如：apps，可以使用该命令获取apiGroups，如果为空字符串，代表就是core下的api:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">api-resources</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wide</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">2.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">resources:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">该apiGroups组下具体资源，比如</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod,service,secret</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">等</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">3.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">verbs:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">指对该资源具体执行哪些动作,如</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete,list</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">等</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">1.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apiGroups:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">指定哪个</span><span style="color:#24292E;"> </span><span style="color:#032F62;">API</span><span style="color:#24292E;"> </span><span style="color:#032F62;">组下的权限,比如：apps，可以使用该命令获取apiGroups，如果为空字符串，代表就是core下的api:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">api-resources</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wide</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">2.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">resources:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">该apiGroups组下具体资源，比如</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod,service,secret</span><span style="color:#24292E;"> </span><span style="color:#032F62;">等</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">3.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">verbs:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">指对该资源具体执行哪些动作,如</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete,list</span><span style="color:#24292E;"> </span><span style="color:#032F62;">等</span></span></code></pre></div><h3 id="_1-3-1-系统预定义角色" tabindex="-1">1.3.1 系统预定义角色 <a class="header-anchor" href="#_1-3-1-系统预定义角色" aria-label="Permalink to &quot;1.3.1 系统预定义角色&quot;">​</a></h3><p>Kubernetes有一个很基本的特性就是它的所有资源都是模型化的API对象，允许执行CRUD(Create、Read、Update、Delete)操作。资源如下</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"># Pods</span></span>
<span class="line"><span style="color:#e1e4e8;"># ConfigMaps</span></span>
<span class="line"><span style="color:#e1e4e8;"># Deployments</span></span>
<span class="line"><span style="color:#e1e4e8;"># Nodes</span></span>
<span class="line"><span style="color:#e1e4e8;"># Secrets</span></span>
<span class="line"><span style="color:#e1e4e8;"># Namespaces</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># 资源对象可能存在的操作有如下</span></span>
<span class="line"><span style="color:#e1e4e8;"># create</span></span>
<span class="line"><span style="color:#e1e4e8;"># get</span></span>
<span class="line"><span style="color:#e1e4e8;"># delete</span></span>
<span class="line"><span style="color:#e1e4e8;"># list</span></span>
<span class="line"><span style="color:#e1e4e8;"># update</span></span>
<span class="line"><span style="color:#e1e4e8;"># edit</span></span>
<span class="line"><span style="color:#e1e4e8;"># watch</span></span>
<span class="line"><span style="color:#e1e4e8;"># exec</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"># Pods</span></span>
<span class="line"><span style="color:#24292e;"># ConfigMaps</span></span>
<span class="line"><span style="color:#24292e;"># Deployments</span></span>
<span class="line"><span style="color:#24292e;"># Nodes</span></span>
<span class="line"><span style="color:#24292e;"># Secrets</span></span>
<span class="line"><span style="color:#24292e;"># Namespaces</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># 资源对象可能存在的操作有如下</span></span>
<span class="line"><span style="color:#24292e;"># create</span></span>
<span class="line"><span style="color:#24292e;"># get</span></span>
<span class="line"><span style="color:#24292e;"># delete</span></span>
<span class="line"><span style="color:#24292e;"># list</span></span>
<span class="line"><span style="color:#24292e;"># update</span></span>
<span class="line"><span style="color:#24292e;"># edit</span></span>
<span class="line"><span style="color:#24292e;"># watch</span></span>
<span class="line"><span style="color:#24292e;"># exec</span></span></code></pre></div><ul><li>通过命令查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">role</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clusterrole</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rolebinding</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clusterrolebinding</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clusterrole</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">view</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">role</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clusterrole</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rolebinding</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clusterrolebinding</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clusterrole</span><span style="color:#24292E;"> </span><span style="color:#032F62;">view</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yaml</span></span></code></pre></div><h2 id="_1-4-涉及命令" tabindex="-1">1.4 涉及命令 <a class="header-anchor" href="#_1-4-涉及命令" aria-label="Permalink to &quot;1.4 涉及命令&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看上下文</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master manifests]# kubectl config get-contexts</span></span>
<span class="line"><span style="color:#B392F0;">CURRENT</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">NAME</span><span style="color:#E1E4E8;">                          </span><span style="color:#9ECBFF;">CLUSTER</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">AUTHINFO</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">NAMESPACE</span></span>
<span class="line"><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#切换</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">use-context</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#返回生成 kubeconfig 条目所针对的所有集群的列表</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">view</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#1.创建role</span></span>
<span class="line"><span style="color:#B392F0;">kubectl create role pod-reader --verb</span><span style="color:#E1E4E8;">=get,list --resource=pods --namespace=development</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#2.创建ClusterRole：创建集群范围内的角色</span></span>
<span class="line"><span style="color:#B392F0;">kubectl create clusterrole pod-admin --verb</span><span style="color:#E1E4E8;">=get,list,create,delete --resource=pods</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#3.创建RoleBinding：将Role绑定给特定用户或服务账户</span></span>
<span class="line"><span style="color:#B392F0;">kubectl create rolebinding read-pods --role</span><span style="color:#E1E4E8;">=pod-reader --user=johndoe --namespace=development</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#4.创建ClusterRoleBinding：将ClusterRole绑定到用户，授予其集群范围的权限</span></span>
<span class="line"><span style="color:#B392F0;">kubectl create clusterrolebinding cluster-admin-binding --clusterrole</span><span style="color:#E1E4E8;">=cluster-admin --user=admin-user</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看</span></span>
<span class="line"><span style="color:#6A737D;">#查看Role：列出命名空间中的所有角色</span></span>
<span class="line"><span style="color:#B392F0;">kubectl get roles --namespace</span><span style="color:#E1E4E8;">=development</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看RoleBinding：查看所有角色绑定</span></span>
<span class="line"><span style="color:#B392F0;">kubectl get rolebindings --namespace</span><span style="color:#E1E4E8;">=development</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看ClusterRole和ClusterRoleBinding：查看集群范围的角色和角色绑定</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clusterroles</span></span>
<span class="line"><span style="color:#B392F0;">kubectl get clusterrolebindings</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#生成yaml文件</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">role</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">han</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--namespace</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">monitor</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--verb=get,list,watch</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--resource=pods</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看上下文</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master manifests]# kubectl config get-contexts</span></span>
<span class="line"><span style="color:#6F42C1;">CURRENT</span><span style="color:#24292E;">   </span><span style="color:#032F62;">NAME</span><span style="color:#24292E;">                          </span><span style="color:#032F62;">CLUSTER</span><span style="color:#24292E;">      </span><span style="color:#032F62;">AUTHINFO</span><span style="color:#24292E;">           </span><span style="color:#032F62;">NAMESPACE</span></span>
<span class="line"><span style="color:#D73A49;">*</span><span style="color:#24292E;">         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#切换</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;">  </span><span style="color:#032F62;">config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">use-context</span><span style="color:#24292E;">  </span><span style="color:#032F62;">name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#返回生成 kubeconfig 条目所针对的所有集群的列表</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">view</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#1.创建role</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl create role pod-reader --verb</span><span style="color:#24292E;">=get,list --resource=pods --namespace=development</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#2.创建ClusterRole：创建集群范围内的角色</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl create clusterrole pod-admin --verb</span><span style="color:#24292E;">=get,list,create,delete --resource=pods</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#3.创建RoleBinding：将Role绑定给特定用户或服务账户</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl create rolebinding read-pods --role</span><span style="color:#24292E;">=pod-reader --user=johndoe --namespace=development</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#4.创建ClusterRoleBinding：将ClusterRole绑定到用户，授予其集群范围的权限</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl create clusterrolebinding cluster-admin-binding --clusterrole</span><span style="color:#24292E;">=cluster-admin --user=admin-user</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看</span></span>
<span class="line"><span style="color:#6A737D;">#查看Role：列出命名空间中的所有角色</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl get roles --namespace</span><span style="color:#24292E;">=development</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看RoleBinding：查看所有角色绑定</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl get rolebindings --namespace</span><span style="color:#24292E;">=development</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看ClusterRole和ClusterRoleBinding：查看集群范围的角色和角色绑定</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clusterroles</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl get clusterrolebindings</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#生成yaml文件</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">role</span><span style="color:#24292E;"> </span><span style="color:#032F62;">han</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--namespace</span><span style="color:#24292E;"> </span><span style="color:#032F62;">monitor</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--verb=get,list,watch</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--resource=pods</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yaml</span></span></code></pre></div><h2 id="_1-5-实践" tabindex="-1">1.5 实践 <a class="header-anchor" href="#_1-5-实践" aria-label="Permalink to &quot;1.5 实践&quot;">​</a></h2><p>假如我们想给用户 bmw 开通一个只可以查看集群中default namespace中的 pods,services 权限，该如何实现呢？一般分如下几个步骤</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">1.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">定义个角色</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">Role/ClusterRole</span><span style="color:#E1E4E8;">)</span><span style="color:#9ECBFF;">，角色包含资源</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">resources</span><span style="color:#E1E4E8;">)</span><span style="color:#9ECBFF;">和动作</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">verbs</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#B392F0;">2.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">分别以</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">User,Group,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ServiceAccount</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">模式定义一个主体</span></span>
<span class="line"><span style="color:#B392F0;">3.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">定义一个</span><span style="color:#E1E4E8;"> (RoleBinding/ClusterRoleBinding), 把 subjects 与 Role/ClusterRole 进行关联</span></span>
<span class="line"><span style="color:#B392F0;">4.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">配置</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubeconfig,使用</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">验证</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">1.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">定义个角色</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">Role/ClusterRole</span><span style="color:#24292E;">)</span><span style="color:#032F62;">，角色包含资源</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">resources</span><span style="color:#24292E;">)</span><span style="color:#032F62;">和动作</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">verbs</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6F42C1;">2.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">分别以</span><span style="color:#24292E;"> </span><span style="color:#032F62;">User,Group,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ServiceAccount</span><span style="color:#24292E;"> </span><span style="color:#032F62;">模式定义一个主体</span></span>
<span class="line"><span style="color:#6F42C1;">3.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">定义一个</span><span style="color:#24292E;"> (RoleBinding/ClusterRoleBinding), 把 subjects 与 Role/ClusterRole 进行关联</span></span>
<span class="line"><span style="color:#6F42C1;">4.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">配置</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubeconfig,使用</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">验证</span></span></code></pre></div><p>1.创建role</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># bmw-svc-role.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Role</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod-reader</span></span>
<span class="line"><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">&quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">pods</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">pods/status</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">pods/log</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">services</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">services/status</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">endpoints</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">endpoints/status</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">get</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">list</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">watch</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># bmw-svc-role.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Role</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod-reader</span></span>
<span class="line"><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">pods</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">pods/status</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">pods/log</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">services</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">services/status</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">endpoints</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">endpoints/status</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">get</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">list</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">watch</span></span></code></pre></div><p>2.serviceAccount</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">$ kubectl create serviceaccount bmw-svc</span></span>
<span class="line"><span style="color:#e1e4e8;">$ kubectl  get sa bmw-svc -o yaml</span></span>
<span class="line"><span style="color:#e1e4e8;">$ kubectl  get secrets bmw-svc-token-8f9js -o yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">$ kubectl create serviceaccount bmw-svc</span></span>
<span class="line"><span style="color:#24292e;">$ kubectl  get sa bmw-svc -o yaml</span></span>
<span class="line"><span style="color:#24292e;">$ kubectl  get secrets bmw-svc-token-8f9js -o yaml</span></span></code></pre></div><p>3.创建角色绑定</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># bmw-svc-rolebinding.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">RoleBinding</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">bmw-svc-role</span></span>
<span class="line"><span style="color:#85E89D;">roleRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">apiGroup</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Role</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">bmw-svc-role</span></span>
<span class="line"><span style="color:#85E89D;">subjects</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ServiceAccount</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">bmw-svc</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">default</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># bmw-svc-rolebinding.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RoleBinding</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">bmw-svc-role</span></span>
<span class="line"><span style="color:#22863A;">roleRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Role</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">bmw-svc-role</span></span>
<span class="line"><span style="color:#22863A;">subjects</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ServiceAccount</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">bmw-svc</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">default</span></span></code></pre></div><p>4.修改config view</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#kubectl config view</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">context:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">cluster:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubernetes</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">user:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bmw-svc</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bmw-svc</span></span>
<span class="line"><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">context:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">cluster:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubernetes</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">user:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">admin</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubernetes</span></span>
<span class="line"><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#B392F0;">users:</span></span>
<span class="line"><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">admin</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">user:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">client-certificate-data:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">REDACTED</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">client-key-data:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">REDACTED</span></span>
<span class="line"><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bmw-svc</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">user:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">token:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">xxxx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#kubectl config view</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">context:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">cluster:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubernetes</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">user:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bmw-svc</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bmw-svc</span></span>
<span class="line"><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">context:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">cluster:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubernetes</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">user:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">admin</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubernetes</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#6F42C1;">users:</span></span>
<span class="line"><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">admin</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">user:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">client-certificate-data:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">REDACTED</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">client-key-data:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">REDACTED</span></span>
<span class="line"><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bmw-svc</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">user:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">token:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">xxxx</span></span></code></pre></div><ol start="5"><li>查看上下文</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master manifests]# kubectl config get-contexts</span></span>
<span class="line"><span style="color:#B392F0;">CURRENT</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">NAME</span><span style="color:#E1E4E8;">                          </span><span style="color:#9ECBFF;">CLUSTER</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">AUTHINFO</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">NAMESPACE</span></span>
<span class="line"><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master manifests]# kubectl config get-users</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span></span>
<span class="line"><span style="color:#B392F0;">kubernetes-admin</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master manifests]# kubectl config get-clusters</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span></span>
<span class="line"><span style="color:#B392F0;">kubernetes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#切换context:</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">use-context</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bmw-svc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master manifests]# kubectl config get-contexts</span></span>
<span class="line"><span style="color:#6F42C1;">CURRENT</span><span style="color:#24292E;">   </span><span style="color:#032F62;">NAME</span><span style="color:#24292E;">                          </span><span style="color:#032F62;">CLUSTER</span><span style="color:#24292E;">      </span><span style="color:#032F62;">AUTHINFO</span><span style="color:#24292E;">           </span><span style="color:#032F62;">NAMESPACE</span></span>
<span class="line"><span style="color:#D73A49;">*</span><span style="color:#24292E;">         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master manifests]# kubectl config get-users</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span></span>
<span class="line"><span style="color:#6F42C1;">kubernetes-admin</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master manifests]# kubectl config get-clusters</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span></span>
<span class="line"><span style="color:#6F42C1;">kubernetes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#切换context:</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;">  </span><span style="color:#032F62;">config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">use-context</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bmw-svc</span></span></code></pre></div><h3 id="role实践2" tabindex="-1">role实践2 <a class="header-anchor" href="#role实践2" aria-label="Permalink to &quot;role实践2&quot;">​</a></h3><ol><li>创建命名空间</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl create namespace test-namespace</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl create namespace test-namespace</span></span></code></pre></div><ol start="2"><li>创建 Role</li></ol><p>创建一个 Role，允许在 test-namespace 命名空间中查看 Pods 和 Services</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Role</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">test-namespace</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">viewer-role</span></span>
<span class="line"><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;pods&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;services&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;get&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Role</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">test-namespace</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">viewer-role</span></span>
<span class="line"><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;pods&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;services&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;get&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">]</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl apply -f viewer-role.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl apply -f viewer-role.yaml</span></span></code></pre></div><ol start="3"><li>创建 ServiceAccount</li></ol><p>创建一个 ServiceAccount，命名为 viewer-sa，用于测试授权效果</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl -n test-namespace create serviceaccount viewer-sa</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl -n test-namespace create serviceaccount viewer-sa</span></span></code></pre></div><ol start="4"><li>创建 RoleBinding</li></ol><p>将 Role viewer-role 绑定到 ServiceAccount viewer-sa</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">RoleBinding</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">viewer-rolebinding</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">test-namespace</span></span>
<span class="line"><span style="color:#85E89D;">roleRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">apiGroup</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Role</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">viewer-role</span></span>
<span class="line"><span style="color:#85E89D;">subjects</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ServiceAccount</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">viewer-sa</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">test-namespace</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RoleBinding</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">viewer-rolebinding</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">test-namespace</span></span>
<span class="line"><span style="color:#22863A;">roleRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Role</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">viewer-role</span></span>
<span class="line"><span style="color:#22863A;">subjects</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ServiceAccount</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">viewer-sa</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">test-namespace</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl apply -f viewer-rolebinding.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl apply -f viewer-rolebinding.yaml</span></span></code></pre></div><ol start="5"><li>验证权限</li></ol><p>使用 kubectl auth can-i 命令验证 viewer-sa 是否可以查看 Pods 和 Services</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">test-namespace</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">auth</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">can-i</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pods</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--as=system:serviceaccount:test-namespace:viewer-sa</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">kubectl -n test-namespace auth can-i list services --as</span><span style="color:#E1E4E8;">=system:serviceaccount:</span><span style="color:#79B8FF;">test</span><span style="color:#E1E4E8;">-namespace:viewer-sa</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">test-namespace</span><span style="color:#24292E;"> </span><span style="color:#032F62;">auth</span><span style="color:#24292E;"> </span><span style="color:#032F62;">can-i</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pods</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--as=system:serviceaccount:test-namespace:viewer-sa</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">kubectl -n test-namespace auth can-i list services --as</span><span style="color:#24292E;">=system:serviceaccount:</span><span style="color:#005CC5;">test</span><span style="color:#24292E;">-namespace:viewer-sa</span></span></code></pre></div><h3 id="cluster实践3" tabindex="-1">cluster实践3 <a class="header-anchor" href="#cluster实践3" aria-label="Permalink to &quot;cluster实践3&quot;">​</a></h3><ol><li>创建 ClusterRole</li></ol><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRole</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">viewer-clusterrole</span></span>
<span class="line"><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;pods&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;services&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;get&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRole</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">viewer-clusterrole</span></span>
<span class="line"><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;pods&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;services&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;get&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">]</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl apply -f viewer-clusterrole.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl apply -f viewer-clusterrole.yaml</span></span></code></pre></div><ol start="2"><li>创建 ClusterRoleBinding</li></ol><p>将 ClusterRole viewer-clusterrole 绑定到 viewer-sa</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRoleBinding</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">viewer-clusterrolebinding</span></span>
<span class="line"><span style="color:#85E89D;">roleRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">apiGroup</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRole</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">viewer-clusterrole</span></span>
<span class="line"><span style="color:#85E89D;">subjects</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ServiceAccount</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">viewer-sa</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">test-namespace</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRoleBinding</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">viewer-clusterrolebinding</span></span>
<span class="line"><span style="color:#22863A;">roleRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRole</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">viewer-clusterrole</span></span>
<span class="line"><span style="color:#22863A;">subjects</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ServiceAccount</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">viewer-sa</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">test-namespace</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl apply -f viewer-clusterrolebinding.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl apply -f viewer-clusterrolebinding.yaml</span></span></code></pre></div><h1 id="_2-推荐配置" tabindex="-1">2. 推荐配置 <a class="header-anchor" href="#_2-推荐配置" aria-label="Permalink to &quot;2. 推荐配置&quot;">​</a></h1><table><thead><tr><th style="text-align:left;">访问资源</th><th style="text-align:left;">角色类型</th><th style="text-align:left;">绑定类型</th></tr></thead><tbody><tr><td style="text-align:left;">集群级别的资源(Nodes,PersistentVolumes,……)</td><td style="text-align:left;">ClusterRole</td><td style="text-align:left;">ClusterRoleBinding</td></tr><tr><td style="text-align:left;">非资源URL(/api,/healthz……)</td><td style="text-align:left;">ClusterRole</td><td style="text-align:left;">ClusterRoleBinding</td></tr><tr><td style="text-align:left;">在任何名称空间中的资源(跨所有名称空间的资源)</td><td style="text-align:left;">ClusterRole</td><td style="text-align:left;">ClusterRoleBinding</td></tr><tr><td style="text-align:left;">具体名称空间中的资源(在多个名称空间中重用这个相同的ClusterRole</td><td style="text-align:left;">ClusterRole</td><td style="text-align:left;">RoleBinding</td></tr><tr><td style="text-align:left;">在具体名称空间中的资源(Role必须在每个名称空间中定义)</td><td style="text-align:left;">Role</td><td style="text-align:left;">RoleBinding</td></tr></tbody></table><h2 id="_2-1-总结" tabindex="-1">2.1 总结 <a class="header-anchor" href="#_2-1-总结" aria-label="Permalink to &quot;2.1 总结&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#创建ServiceAccount</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">serviceaccount</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">服务账号名</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#将ServiceAccount分配给pod</span></span>
<span class="line"><span style="color:#B392F0;">在pod的manifest配置文件中指定ServiceAccount名:</span></span>
<span class="line"><span style="color:#B392F0;">serviceAccountName:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">服务账号名</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#RBAC4种角色资源</span></span>
<span class="line"><span style="color:#B392F0;">Role:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">常规角色.定义了对某个资源具有某种访问权限</span></span>
<span class="line"><span style="color:#B392F0;">RoleBinding:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">常规角色绑定.定义了该角色绑定到哪个主体</span></span>
<span class="line"><span style="color:#B392F0;">ClusterRole:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">集群角色.同上</span></span>
<span class="line"><span style="color:#B392F0;">ClusterRoleBinding:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">集群角色绑定.同上</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">区别在于:</span></span>
<span class="line"><span style="color:#B392F0;">常规角色和集群角色绑定作用于某个名称空间下.</span></span>
<span class="line"><span style="color:#B392F0;">集群角色和集群角色绑定作用于整个集群,不受限于任何名称空间</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#创建ServiceAccount</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">serviceaccount</span><span style="color:#24292E;"> </span><span style="color:#032F62;">服务账号名</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#将ServiceAccount分配给pod</span></span>
<span class="line"><span style="color:#6F42C1;">在pod的manifest配置文件中指定ServiceAccount名:</span></span>
<span class="line"><span style="color:#6F42C1;">serviceAccountName:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">服务账号名</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#RBAC4种角色资源</span></span>
<span class="line"><span style="color:#6F42C1;">Role:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">常规角色.定义了对某个资源具有某种访问权限</span></span>
<span class="line"><span style="color:#6F42C1;">RoleBinding:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">常规角色绑定.定义了该角色绑定到哪个主体</span></span>
<span class="line"><span style="color:#6F42C1;">ClusterRole:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">集群角色.同上</span></span>
<span class="line"><span style="color:#6F42C1;">ClusterRoleBinding:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">集群角色绑定.同上</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">区别在于:</span></span>
<span class="line"><span style="color:#6F42C1;">常规角色和集群角色绑定作用于某个名称空间下.</span></span>
<span class="line"><span style="color:#6F42C1;">集群角色和集群角色绑定作用于整个集群,不受限于任何名称空间</span></span></code></pre></div><h1 id="_3-rbac案例" tabindex="-1">3.RBAC案例 <a class="header-anchor" href="#_3-rbac案例" aria-label="Permalink to &quot;3.RBAC案例&quot;">​</a></h1><p><strong>角色</strong>（权限的集合）</p><ul><li>Role：授权特定命名空间的访问权限</li><li>ClusterRole：授权所有命名空间的访问权限（集群角色）</li></ul><p><strong>角色绑定</strong></p><ul><li>RoleBinding：将角色（Role）绑定到主体（即subject）</li><li>ClusterRoleBinding：将集群角色（ClusterRole）绑定到主体</li></ul><p><strong>主体（subject）</strong></p><ul><li>User：用户</li><li>Group：用户组</li><li>ServiceAccount：服务账号</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Role</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">---</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">RoleBinding</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">---</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">User/Group/ServiceAccount</span></span>
<span class="line"><span style="color:#B392F0;">ClusterRole</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">---</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ClusterRoleBinding</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">---</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">User/Group/ServiceAccount</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#将准备要设置赋予的权限，放到角色(Role/ClusterRole)里，</span></span>
<span class="line"><span style="color:#6A737D;">#通过角色绑定（RoleBinding/ClusterRoleBinding)</span></span>
<span class="line"><span style="color:#6A737D;">#将权限放在绑定到主体（User/Group/ServiceAccount）上</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Role</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">---</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">RoleBinding</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">---</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">User/Group/ServiceAccount</span></span>
<span class="line"><span style="color:#6F42C1;">ClusterRole</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">---</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ClusterRoleBinding</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">---</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">User/Group/ServiceAccount</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#将准备要设置赋予的权限，放到角色(Role/ClusterRole)里，</span></span>
<span class="line"><span style="color:#6A737D;">#通过角色绑定（RoleBinding/ClusterRoleBinding)</span></span>
<span class="line"><span style="color:#6A737D;">#将权限放在绑定到主体（User/Group/ServiceAccount）上</span></span></code></pre></div><h2 id="_3-1-部署cfssl" tabindex="-1">3.1 部署cfssl <a class="header-anchor" href="#_3-1-部署cfssl" aria-label="Permalink to &quot;3.1 部署cfssl&quot;">​</a></h2><p>为 Han用户授权 nginx 命名空间的 Pod 读取权限</p><h3 id="_1-创建ca证书签名请求文件" tabindex="-1">1.创建CA证书签名请求文件 <a class="header-anchor" href="#_1-创建ca证书签名请求文件" aria-label="Permalink to &quot;1.创建CA证书签名请求文件&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">han-ca-csr.json</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;CN&quot;: &quot;han&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;hosts&quot;: [],</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;key&quot;: { </span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;algo&quot;: &quot;rsa&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">    &quot;size&quot;: 2048</span></span>
<span class="line"><span style="color:#9ECBFF;">  },</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;names&quot;: [</span></span>
<span class="line"><span style="color:#9ECBFF;">    {</span></span>
<span class="line"><span style="color:#9ECBFF;">      &quot;C&quot;: &quot;CN&quot;,    </span></span>
<span class="line"><span style="color:#9ECBFF;">      &quot;ST&quot;: &quot;BeiJing&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">      &quot;L&quot;: &quot;BeiJing&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">      &quot;O&quot;: &quot;k8s&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">      &quot;OU&quot;: &quot;System&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">    }</span></span>
<span class="line"><span style="color:#9ECBFF;">  ]</span></span>
<span class="line"><span style="color:#9ECBFF;">}</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#6A737D;"># &quot;CN: feiyi&quot;: Common Name，feiyi作为之后要授权的用户</span></span>
<span class="line"><span style="color:#6A737D;"># C: 国家 ST: 州/省 L: 地区/城市 </span></span>
<span class="line"><span style="color:#6A737D;"># O: Organization，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)，也就是feiyi用户所属的组，之后也可给该组授权</span></span>
<span class="line"><span style="color:#6A737D;"># OU: 组织单位名称，公司部门</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">han-ca-csr.json</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#032F62;">  &quot;CN&quot;: &quot;han&quot;,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;hosts&quot;: [],</span></span>
<span class="line"><span style="color:#032F62;">  &quot;key&quot;: { </span></span>
<span class="line"><span style="color:#032F62;">    &quot;algo&quot;: &quot;rsa&quot;,</span></span>
<span class="line"><span style="color:#032F62;">    &quot;size&quot;: 2048</span></span>
<span class="line"><span style="color:#032F62;">  },</span></span>
<span class="line"><span style="color:#032F62;">  &quot;names&quot;: [</span></span>
<span class="line"><span style="color:#032F62;">    {</span></span>
<span class="line"><span style="color:#032F62;">      &quot;C&quot;: &quot;CN&quot;,    </span></span>
<span class="line"><span style="color:#032F62;">      &quot;ST&quot;: &quot;BeiJing&quot;,</span></span>
<span class="line"><span style="color:#032F62;">      &quot;L&quot;: &quot;BeiJing&quot;,</span></span>
<span class="line"><span style="color:#032F62;">      &quot;O&quot;: &quot;k8s&quot;,</span></span>
<span class="line"><span style="color:#032F62;">      &quot;OU&quot;: &quot;System&quot;</span></span>
<span class="line"><span style="color:#032F62;">    }</span></span>
<span class="line"><span style="color:#032F62;">  ]</span></span>
<span class="line"><span style="color:#032F62;">}</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#6A737D;"># &quot;CN: feiyi&quot;: Common Name，feiyi作为之后要授权的用户</span></span>
<span class="line"><span style="color:#6A737D;"># C: 国家 ST: 州/省 L: 地区/城市 </span></span>
<span class="line"><span style="color:#6A737D;"># O: Organization，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)，也就是feiyi用户所属的组，之后也可给该组授权</span></span>
<span class="line"><span style="color:#6A737D;"># OU: 组织单位名称，公司部门</span></span></code></pre></div><h3 id="_2-部署k8s使用当时生成ca-签发证书" tabindex="-1">2. 部署k8s使用当时生成CA 签发证书 <a class="header-anchor" href="#_2-部署k8s使用当时生成ca-签发证书" aria-label="Permalink to &quot;2. 部署k8s使用当时生成CA 签发证书&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cfssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gencert</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">-ca=/etc/kubernetes/pki/ca.crt </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">-ca-key=/etc/kubernetes/pki/ca.key </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">-config=ca-config.json </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">-profile=kubernetes </span><span style="color:#9ECBFF;">han-ca-csr.json</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cfssljson</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-bare</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">han</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># -ca: 指定k8s的ca文件所在位置</span></span>
<span class="line"><span style="color:#6A737D;"># -ca-key: 指定k8s的ca密钥文件所在位置</span></span>
<span class="line"><span style="color:#6A737D;"># -config: 指定刚刚创建好的CA-config.json文件</span></span>
<span class="line"><span style="color:#6A737D;"># -profile: 指定ca-config.json中的profile---kubernetes</span></span>
<span class="line"><span style="color:#6A737D;"># cfssljson -bare han：将以上信息解析，生成以han为前缀的证书文件</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cfssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gencert</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">-ca=/etc/kubernetes/pki/ca.crt </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">-ca-key=/etc/kubernetes/pki/ca.key </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">-config=ca-config.json </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">-profile=kubernetes </span><span style="color:#032F62;">han-ca-csr.json</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cfssljson</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-bare</span><span style="color:#24292E;"> </span><span style="color:#032F62;">han</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># -ca: 指定k8s的ca文件所在位置</span></span>
<span class="line"><span style="color:#6A737D;"># -ca-key: 指定k8s的ca密钥文件所在位置</span></span>
<span class="line"><span style="color:#6A737D;"># -config: 指定刚刚创建好的CA-config.json文件</span></span>
<span class="line"><span style="color:#6A737D;"># -profile: 指定ca-config.json中的profile---kubernetes</span></span>
<span class="line"><span style="color:#6A737D;"># cfssljson -bare han：将以上信息解析，生成以han为前缀的证书文件</span></span></code></pre></div><p>新增三个文件</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">han-key.pem</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># ca的私钥</span></span>
<span class="line"><span style="color:#B392F0;">han.pem</span><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># ca证书</span></span>
<span class="line"><span style="color:#B392F0;">han.csr</span><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># 签署请求</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">han-key.pem</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># ca的私钥</span></span>
<span class="line"><span style="color:#6F42C1;">han.pem</span><span style="color:#24292E;">      </span><span style="color:#6A737D;"># ca证书</span></span>
<span class="line"><span style="color:#6F42C1;">han.csr</span><span style="color:#24292E;">      </span><span style="color:#6A737D;"># 签署请求</span></span></code></pre></div><h2 id="_3-2-创建kubeconfig-授权文件" tabindex="-1">3.2 创建kubeconfig 授权文件 <a class="header-anchor" href="#_3-2-创建kubeconfig-授权文件" aria-label="Permalink to &quot;3.2 创建kubeconfig 授权文件&quot;">​</a></h2><p>在创建完集群后，会让你执行如下命令</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> $HOME</span><span style="color:#9ECBFF;">/.kube</span></span>
<span class="line"><span style="color:#B392F0;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-i</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/admin.conf</span><span style="color:#E1E4E8;"> $HOME</span><span style="color:#9ECBFF;">/.kube/config</span></span>
<span class="line"><span style="color:#B392F0;">chown</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">id</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-u</span><span style="color:#9ECBFF;">):$(</span><span style="color:#B392F0;">id</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-g</span><span style="color:#9ECBFF;">)</span><span style="color:#E1E4E8;"> $HOME</span><span style="color:#9ECBFF;">/.kube/config</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> $HOME</span><span style="color:#032F62;">/.kube</span></span>
<span class="line"><span style="color:#6F42C1;">cp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-i</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/admin.conf</span><span style="color:#24292E;"> $HOME</span><span style="color:#032F62;">/.kube/config</span></span>
<span class="line"><span style="color:#6F42C1;">chown</span><span style="color:#24292E;"> </span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">id</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-u</span><span style="color:#032F62;">):$(</span><span style="color:#6F42C1;">id</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-g</span><span style="color:#032F62;">)</span><span style="color:#24292E;"> $HOME</span><span style="color:#032F62;">/.kube/config</span></span></code></pre></div><ul><li>把集群信息写入kubeconfig文件</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 因为创建的kubeconfig也将作用于K8S集群，所以需要指定K8S的API信息</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set-cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubernetes</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--certificate-authority=/etc/kubernetes/pki/ca.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--embed-certs=true</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--server=https://192.168.1.11:6443</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--kubeconfig=han.kubeconfig</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;"># --certificate-authority：ca证书</span></span>
<span class="line"><span style="color:#6A737D;"># --server：apiserver地址</span></span>
<span class="line"><span style="color:#6A737D;"># --kubeconfig：根据给定的信息生成的kubeconfig名字</span></span>
<span class="line"><span style="color:#6A737D;"># --embed-certs：为true时，将证书信息写入kubeconfig文件；为false时，在kubeconfig文件中引用证书所在路径  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">################################################################</span></span>
<span class="line"><span style="color:#6A737D;"># 这一步主要生成了以下信息</span></span>
<span class="line"><span style="color:#B392F0;">apiVersion:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#B392F0;">clusters:</span></span>
<span class="line"><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">certificate-authority-data:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0t</span></span>
<span class="line"><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">ejhKYld1OHY3WmI4TVR2MG9GVQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">server:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://192.168.1.11:6443</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubernetes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 因为创建的kubeconfig也将作用于K8S集群，所以需要指定K8S的API信息</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set-cluster</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubernetes</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--certificate-authority=/etc/kubernetes/pki/ca.crt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--embed-certs=true</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--server=https://192.168.1.11:6443</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--kubeconfig=han.kubeconfig</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#6A737D;"># --certificate-authority：ca证书</span></span>
<span class="line"><span style="color:#6A737D;"># --server：apiserver地址</span></span>
<span class="line"><span style="color:#6A737D;"># --kubeconfig：根据给定的信息生成的kubeconfig名字</span></span>
<span class="line"><span style="color:#6A737D;"># --embed-certs：为true时，将证书信息写入kubeconfig文件；为false时，在kubeconfig文件中引用证书所在路径  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">################################################################</span></span>
<span class="line"><span style="color:#6A737D;"># 这一步主要生成了以下信息</span></span>
<span class="line"><span style="color:#6F42C1;">apiVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#6F42C1;">clusters:</span></span>
<span class="line"><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">certificate-authority-data:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0t</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">ejhKYld1OHY3WmI4TVR2MG9GVQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">=</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">server:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://192.168.1.11:6443</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubernetes</span></span></code></pre></div><ul><li><h4 id="客户端信息写入-kubeconfig" tabindex="-1">客户端信息写入 kubeconfig <a class="header-anchor" href="#客户端信息写入-kubeconfig" aria-label="Permalink to &quot;客户端信息写入 kubeconfig&quot;">​</a></h4></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set-credentials</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">han</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--client-key=han-key.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--client-certificate=han.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--embed-certs=true</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--kubeconfig=han.kubeconfig</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;"># set-credentials: 在 kubeconfig 中设置用户条目</span></span>
<span class="line"><span style="color:#6A737D;"># --client-key: 指定刚才生成私钥</span></span>
<span class="line"><span style="color:#6A737D;"># --client-certificate=han.pem: 指定生成的数字证书</span></span>
<span class="line"><span style="color:#6A737D;"># --kubeconfig: 将客户端信息加入刚才生成的kubeconfig文件中</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">################################################################</span></span>
<span class="line"><span style="color:#6A737D;"># 这一步主要生成了以下信息</span></span>
<span class="line"><span style="color:#B392F0;">users:</span></span>
<span class="line"><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">han</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">user:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">client-certificate-data:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0</span></span>
<span class="line"><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#B392F0;">Si8rbHRhdXM4UWFRVmhCOHlndz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">client-key-data:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">LS0tLS1CRUdJTi</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">BSU0EgUFJJVkFURSBLRVktLS0tLQp</span></span>
<span class="line"><span style="color:#79B8FF;">...</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">ck9xK0pFdDJDNGpidmh0Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">=</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set-credentials</span><span style="color:#24292E;"> </span><span style="color:#032F62;">han</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--client-key=han-key.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--client-certificate=han.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--embed-certs=true</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--kubeconfig=han.kubeconfig</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#6A737D;"># set-credentials: 在 kubeconfig 中设置用户条目</span></span>
<span class="line"><span style="color:#6A737D;"># --client-key: 指定刚才生成私钥</span></span>
<span class="line"><span style="color:#6A737D;"># --client-certificate=han.pem: 指定生成的数字证书</span></span>
<span class="line"><span style="color:#6A737D;"># --kubeconfig: 将客户端信息加入刚才生成的kubeconfig文件中</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">################################################################</span></span>
<span class="line"><span style="color:#6A737D;"># 这一步主要生成了以下信息</span></span>
<span class="line"><span style="color:#6F42C1;">users:</span></span>
<span class="line"><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">han</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">user:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">client-certificate-data:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#6F42C1;">Si8rbHRhdXM4UWFRVmhCOHlndz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">client-key-data:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">LS0tLS1CRUdJTi</span><span style="color:#24292E;"> </span><span style="color:#032F62;">BSU0EgUFJJVkFURSBLRVktLS0tLQp</span></span>
<span class="line"><span style="color:#005CC5;">...</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">ck9xK0pFdDJDNGpidmh0Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">=</span></span></code></pre></div><ul><li><h4 id="上下文信息写入-kubeconfig" tabindex="-1">上下文信息写入 kubeconfig <a class="header-anchor" href="#上下文信息写入-kubeconfig" aria-label="Permalink to &quot;上下文信息写入 kubeconfig&quot;">​</a></h4></li></ul><p>设置默认上下文加入 kubeconfig：如果存在多套集群，通过设置上下文可以在多套集群间切换</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl config set-context kubernetes \\</span></span>
<span class="line"><span style="color:#e1e4e8;">  --cluster=kubernetes \\</span></span>
<span class="line"><span style="color:#e1e4e8;">  --user=han \\</span></span>
<span class="line"><span style="color:#e1e4e8;">  --kubeconfig=han.kubeconfig </span></span>
<span class="line"><span style="color:#e1e4e8;">  </span></span>
<span class="line"><span style="color:#e1e4e8;"># set-context: 设置上下文，默认在名为kubernetes的集群</span></span>
<span class="line"><span style="color:#e1e4e8;"># --user=han: 使用客户端用户为han</span></span>
<span class="line"><span style="color:#e1e4e8;"># --cluster=kubernetes: 用户作用到名为kubernetes的集群</span></span>
<span class="line"><span style="color:#e1e4e8;"># --kubeconfig：将上下文信息加入刚才生成的kubeconfig文件中</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">################################################################</span></span>
<span class="line"><span style="color:#e1e4e8;"># 这一步主要生成了以下信息，表示使用feiyi用户访问集群kubernetes</span></span>
<span class="line"><span style="color:#e1e4e8;">contexts:</span></span>
<span class="line"><span style="color:#e1e4e8;">- context:</span></span>
<span class="line"><span style="color:#e1e4e8;">    cluster: kubernetes</span></span>
<span class="line"><span style="color:#e1e4e8;">    user: han</span></span>
<span class="line"><span style="color:#e1e4e8;">  name: kubernetes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl config set-context kubernetes \\</span></span>
<span class="line"><span style="color:#24292e;">  --cluster=kubernetes \\</span></span>
<span class="line"><span style="color:#24292e;">  --user=han \\</span></span>
<span class="line"><span style="color:#24292e;">  --kubeconfig=han.kubeconfig </span></span>
<span class="line"><span style="color:#24292e;">  </span></span>
<span class="line"><span style="color:#24292e;"># set-context: 设置上下文，默认在名为kubernetes的集群</span></span>
<span class="line"><span style="color:#24292e;"># --user=han: 使用客户端用户为han</span></span>
<span class="line"><span style="color:#24292e;"># --cluster=kubernetes: 用户作用到名为kubernetes的集群</span></span>
<span class="line"><span style="color:#24292e;"># --kubeconfig：将上下文信息加入刚才生成的kubeconfig文件中</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">################################################################</span></span>
<span class="line"><span style="color:#24292e;"># 这一步主要生成了以下信息，表示使用feiyi用户访问集群kubernetes</span></span>
<span class="line"><span style="color:#24292e;">contexts:</span></span>
<span class="line"><span style="color:#24292e;">- context:</span></span>
<span class="line"><span style="color:#24292e;">    cluster: kubernetes</span></span>
<span class="line"><span style="color:#24292e;">    user: han</span></span>
<span class="line"><span style="color:#24292e;">  name: kubernetes</span></span></code></pre></div><h2 id="_3-3-验证" tabindex="-1">3.3 验证 <a class="header-anchor" href="#_3-3-验证" aria-label="Permalink to &quot;3.3 验证&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--kubeconfig=han.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Error</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;"> (Forbidden): pods is forbidden: User </span><span style="color:#9ECBFF;">&quot;han&quot;</span><span style="color:#E1E4E8;"> cannot list resource </span><span style="color:#9ECBFF;">&quot;pods&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> API group </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> the namespace </span><span style="color:#9ECBFF;">&quot;nginx&quot;</span></span>
<span class="line"><span style="color:#6A737D;">#这是因为现在生成的 kubeconfig 还没有任何权限，所以任何资源还无法访问</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--kubeconfig=han.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Error</span><span style="color:#24292E;"> </span><span style="color:#032F62;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> (Forbidden): pods is forbidden: User </span><span style="color:#032F62;">&quot;han&quot;</span><span style="color:#24292E;"> cannot list resource </span><span style="color:#032F62;">&quot;pods&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> API group </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> the namespace </span><span style="color:#032F62;">&quot;nginx&quot;</span></span>
<span class="line"><span style="color:#6A737D;">#这是因为现在生成的 kubeconfig 还没有任何权限，所以任何资源还无法访问</span></span></code></pre></div><h2 id="_3-4-创建-rbac-权限策略" tabindex="-1">3.4 创建 RBAC 权限策略 <a class="header-anchor" href="#_3-4-创建-rbac-权限策略" aria-label="Permalink to &quot;3.4 创建 RBAC 权限策略&quot;">​</a></h2><p>仅给予查看 default命名空间的 pod 资源</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">han-rbac.yaml</span></span>
<span class="line"><span style="color:#B392F0;">apiVersion:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#B392F0;">kind:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Role</span></span>
<span class="line"><span style="color:#B392F0;">metadata:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">namespace:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">default</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 将权限给到nginx命名空间</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rbac-test</span></span>
<span class="line"><span style="color:#B392F0;">rules:</span></span>
<span class="line"><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apiGroups:</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;"># 如果为空，则代表核心组（一般不指定），可以指定多个</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">resources:</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&quot;pods&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;"># 仅允许该role对pod操作，可以指定多个</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">verbs:</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&quot;get&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;watch&quot;,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;list&quot;]</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 对pod 所作的操作</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#6A737D;"># 将role绑定到user</span></span>
<span class="line"><span style="color:#B392F0;">apiVersion:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#B392F0;">kind:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">RoleBinding</span></span>
<span class="line"><span style="color:#B392F0;">metadata:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">namespace:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">default</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rbac-test-binding</span></span>
<span class="line"><span style="color:#B392F0;">subjects:</span></span>
<span class="line"><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kind:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">User</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">han</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 该名为生成证书时的CN名字</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">apiGroup:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#B392F0;">roleRef:</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 指定上面创建的Role与han绑定</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">kind:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Role</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rbac-test</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">apiGroup:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">han-rbac.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">apiVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#6F42C1;">kind:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Role</span></span>
<span class="line"><span style="color:#6F42C1;">metadata:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">namespace:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">default</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 将权限给到nginx命名空间</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rbac-test</span></span>
<span class="line"><span style="color:#6F42C1;">rules:</span></span>
<span class="line"><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apiGroups:</span><span style="color:#24292E;"> [</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">] </span><span style="color:#6A737D;"># 如果为空，则代表核心组（一般不指定），可以指定多个</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">resources:</span><span style="color:#24292E;"> [</span><span style="color:#032F62;">&quot;pods&quot;</span><span style="color:#24292E;">] </span><span style="color:#6A737D;"># 仅允许该role对pod操作，可以指定多个</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">verbs:</span><span style="color:#24292E;"> [</span><span style="color:#032F62;">&quot;get&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;list&quot;]</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 对pod 所作的操作</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#6A737D;"># 将role绑定到user</span></span>
<span class="line"><span style="color:#6F42C1;">apiVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#6F42C1;">kind:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">RoleBinding</span></span>
<span class="line"><span style="color:#6F42C1;">metadata:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">namespace:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">default</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rbac-test-binding</span></span>
<span class="line"><span style="color:#6F42C1;">subjects:</span></span>
<span class="line"><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kind:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">User</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">han</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 该名为生成证书时的CN名字</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">apiGroup:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#6F42C1;">roleRef:</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 指定上面创建的Role与han绑定</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">kind:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Role</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rbac-test</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">apiGroup:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span></code></pre></div><ul><li>执行</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">han-rbac.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">han-rbac.yaml</span></span></code></pre></div><p>文档参考</p><p><a href="https://learnk8s.io/rbac-kubernetes#rbac-in-kubernetes" target="_blank" rel="noreferrer">https://learnk8s.io/rbac-kubernetes#rbac-in-kubernetes</a></p><p><a href="http://docs.kubernetes.org.cn/148.html" target="_blank" rel="noreferrer">http://docs.kubernetes.org.cn/148.html</a></p><ul><li>创建证书：<a href="https://kubernetes.io/zh/docs/tasks/administer-cluster/certificates/" target="_blank" rel="noreferrer">https://kubernetes.io/zh/docs/tasks/administer-cluster/certificates/</a></li><li>rbac文档：<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/" target="_blank" rel="noreferrer">https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/</a></li><li>api文档：<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/" target="_blank" rel="noreferrer">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/</a></li></ul>`,157),e=[o];function c(t,r,y,i,E,u){return n(),a("div",null,e)}const C=s(p,[["render",c]]);export{d as __pageData,C as default};
