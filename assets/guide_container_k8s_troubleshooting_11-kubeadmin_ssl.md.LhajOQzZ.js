import{_ as s,o as a,c as n,R as e}from"./chunks/framework.zUbWieqp.js";const k=JSON.parse('{"title":"1.更新证书","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/troubleshooting/11-kubeadmin_ssl.md","filePath":"guide/container/k8s/troubleshooting/11-kubeadmin_ssl.md","lastUpdated":1714030813000}'),l={name:"guide/container/k8s/troubleshooting/11-kubeadmin_ssl.md"},p=e(`<p>文档，<a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/#manual-certificate-renewal" target="_blank" rel="noreferrer">https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/#manual-certificate-renewal</a></p><p>基于kubeadm部署的 Kubernetes 集群，默认证书有效期是一年，如果不及时更新证书，就会导致一系列问题和影响，包括：</p><ol><li><strong>节点通信受阻</strong>：证书到期后，节点之间的安全通信可能会受到影响，这可能导致节点无法相互通信或者无法加入集群。</li><li><strong>API服务器访问受限</strong>：API服务器使用证书进行身份验证和安全通信。如果证书过期，可能会导致客户端无法连接到API服务器，从而影响管理和监控集群的能力。</li><li><strong>TLS连接问题</strong>：集群中的各种服务和组件可能会使用TLS证书进行加密通信。证书过期可能导致服务之间的通信出现问题，从而影响应用程序的正常运行。</li><li><strong>自动扩展和自动修复受影响</strong>：某些自动化功能，如水平扩展和自动修复，可能依赖于与Kubernetes API服务器的通信。证书过期可能会影响这些功能的正常运行。</li><li><strong>安全风险增加</strong>：证书过期可能会增加安全风险，因为过期的证书可能会被恶意利用，攻击者可以使用它们来尝试入侵集群或窃取数据</li></ol><h1 id="_1-更新证书" tabindex="-1">1.更新证书 <a class="header-anchor" href="#_1-更新证书" aria-label="Permalink to &quot;1.更新证书&quot;">​</a></h1><p>当前环境是基于etcd集群部署在k8s集群内的操作方法。如果是部署的外置etcd集群，则建议使用<strong>手动更新</strong>方式。</p><h2 id="_1-1查看证书到期时间" tabindex="-1">1.1查看证书到期时间 <a class="header-anchor" href="#_1-1查看证书到期时间" aria-label="Permalink to &quot;1.1查看证书到期时间&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">certs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">check-expiration</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">certs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">check-expiration</span></span></code></pre></div><h3 id="_1-2方法一-脚本自动更新" tabindex="-1">1.2方法一：脚本自动更新 <a class="header-anchor" href="#_1-2方法一-脚本自动更新" aria-label="Permalink to &quot;1.2方法一：脚本自动更新&quot;">​</a></h3><p>k8s集群1.15版本以上支持此脚本自动化更新。（此证书更新后有效期10年）</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">同时更新etcd证书和master证书（每个master节点都需要执行一次）</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#在每台master上执行以下命令</span></span>
<span class="line"><span style="color:#B392F0;">./update-kubeadm-cert.sh</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">all</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">同时更新etcd证书和master证书（每个master节点都需要执行一次）</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#在每台master上执行以下命令</span></span>
<span class="line"><span style="color:#6F42C1;">./update-kubeadm-cert.sh</span><span style="color:#24292E;"> </span><span style="color:#032F62;">all</span></span></code></pre></div><h3 id="_1-3方法二-手动更新" tabindex="-1">1.3方法二：手动更新 <a class="header-anchor" href="#_1-3方法二-手动更新" aria-label="Permalink to &quot;1.3方法二：手动更新&quot;">​</a></h3><p>1.备份老的证书及配置</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-r</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">/etc/kubernetes_back</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-r</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes</span><span style="color:#24292E;">  </span><span style="color:#032F62;">/etc/kubernetes_back</span></span></code></pre></div><p>2.生成集群配置文件</p><p>集群安装时的初始化生成的部署配置文件：kubeadmin.yaml</p><p>3.续期证书</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">certs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">renew</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">all</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--config=/root/kubeadmin.yaml</span></span>
<span class="line"><span style="color:#6A737D;">#执行上面命令后，需要重启对应pod才能生效kube-apiserver, kube-controller-manager, kube-scheduler and etcd</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">certs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">renew</span><span style="color:#24292E;"> </span><span style="color:#032F62;">all</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--config=/root/kubeadmin.yaml</span></span>
<span class="line"><span style="color:#6A737D;">#执行上面命令后，需要重启对应pod才能生效kube-apiserver, kube-controller-manager, kube-scheduler and etcd</span></span></code></pre></div><p><strong>注意：需要拷贝新证书到其他master节点</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">rsync</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-avP</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-master-03:/etc/kubernetes/pki/</span></span>
<span class="line"><span style="color:#B392F0;">rsync</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-avP</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-master-02:/etc/kubernetes/pki/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">rsync</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-avP</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-master-03:/etc/kubernetes/pki/</span></span>
<span class="line"><span style="color:#6F42C1;">rsync</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-avP</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-master-02:/etc/kubernetes/pki/</span></span></code></pre></div><p><strong>4.重新生成配置文件</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># cd /etc/kubernetes</span></span>
<span class="line"><span style="color:#6A737D;"># ls *conf</span></span>
<span class="line"><span style="color:#6A737D;"># rm -rf *conf</span></span>
<span class="line"><span style="color:#6A737D;"># kubeadm init phase kubeconfig all --config=/root/kubeadmin.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># cd /etc/kubernetes</span></span>
<span class="line"><span style="color:#6A737D;"># ls *conf</span></span>
<span class="line"><span style="color:#6A737D;"># rm -rf *conf</span></span>
<span class="line"><span style="color:#6A737D;"># kubeadm init phase kubeconfig all --config=/root/kubeadmin.yaml</span></span></code></pre></div><p><strong>5.复制新的认证文件（在所有master上执行，使证书生效）</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># rm -rf ~/.kube</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># mkdir -p $HOME/.kube</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># rm -rf ~/.kube</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># mkdir -p $HOME/.kube</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span></span></code></pre></div><p><strong>6.重启kubelet、apiserver、controller-manager、scheduler、etcd（在所有master上执行，使证书生效）</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># kubectl delete pod -nkube-system kube-apiserver-k8s-master-01 kube-apiserver-k8s-master-02 kube-apiserver-k8s-master-03</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-nkube-system</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-controller-manager-k8s-master-01</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-controller-manager-k8s-master-02</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-controller-manager-k8s-master-03</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-nkube-system</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-scheduler-k8s-master-01</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-scheduler-k8s-master-02</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-scheduler-k8s-master-03</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#删除etcd对应的pod</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-nkube-system</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcdxxx</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">xxx</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">xxx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># kubectl delete pod -nkube-system kube-apiserver-k8s-master-01 kube-apiserver-k8s-master-02 kube-apiserver-k8s-master-03</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-nkube-system</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-controller-manager-k8s-master-01</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-controller-manager-k8s-master-02</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-controller-manager-k8s-master-03</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-nkube-system</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-scheduler-k8s-master-01</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-scheduler-k8s-master-02</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-scheduler-k8s-master-03</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#删除etcd对应的pod</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-nkube-system</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcdxxx</span><span style="color:#24292E;"> </span><span style="color:#032F62;">xxx</span><span style="color:#24292E;"> </span><span style="color:#032F62;">xxx</span></span></code></pre></div><p><strong>7.检查每个master的证书有效期</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">find</span><span style="color:#9ECBFF;"> /etc/kubernetes/pki </span><span style="color:#79B8FF;">-name</span><span style="color:#9ECBFF;"> &quot;*.crt&quot;\`</span><span style="color:#E1E4E8;">;</span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> openssl x509 -in $i -text -noout</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Not</span><span style="color:#E1E4E8;">;</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> $i;</span><span style="color:#F97583;">done</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">find</span><span style="color:#032F62;"> /etc/kubernetes/pki </span><span style="color:#005CC5;">-name</span><span style="color:#032F62;"> &quot;*.crt&quot;\`</span><span style="color:#24292E;">;</span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> openssl x509 -in $i -text -noout</span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Not</span><span style="color:#24292E;">;</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> $i;</span><span style="color:#D73A49;">done</span></span></code></pre></div>`,27),o=[p];function t(c,r,i,y,d,E){return a(),n("div",null,o)}const b=s(l,[["render",t]]);export{k as __pageData,b as default};
