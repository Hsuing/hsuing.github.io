import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const m=JSON.parse('{"title":"1.Deployment","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/资源对象/5-deployment定义.md","filePath":"guide/container/k8s/资源对象/5-deployment定义.md","lastUpdated":1730196597000}'),p={name:"guide/container/k8s/资源对象/5-deployment定义.md"},o=l(`<h1 id="_1-deployment" tabindex="-1">1.Deployment <a class="header-anchor" href="#_1-deployment" aria-label="Permalink to &quot;1.Deployment&quot;">​</a></h1><p><a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/#selector" target="_blank" rel="noreferrer">文档</a></p><h2 id="_1-0-deployment资源定义规范" tabindex="-1">1.0 Deployment资源定义规范 <a class="header-anchor" href="#_1-0-deployment资源定义规范" aria-label="Permalink to &quot;1.0 Deployment资源定义规范&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># API群组及版本</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 资源类型特有标识</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">name &lt;string&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 资源名称，在作用域中要唯一</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">namespace &lt;string&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 名称空间；Deployment隶属名称空间级别</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">minReadySeconds &lt;integer&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># Pod就绪后多少秒内任一容器无crash方可视为“就绪”</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">replicas &lt;integer&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 期望的Pod副本数，默认为1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">selector &lt;object&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 标签选择器，必须匹配template字段中Pod模板中的标签</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">template &lt;object&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># Pod模板对象</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">revisionHistoryLimit &lt;integer&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 滚动更新历史记录数量，默认为10</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">strategy &lt;Object&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 滚动更新策略</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">type &lt;string&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 滚动更新类型，可用值有Recreate和RollingUpdate；</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">rollingUpdate &lt;Object&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 滚动更新参数，专用于RollingUpdate类型</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">maxSurge &lt;string&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 更新期间可比期望的Pod数量多出的数量或比例；</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">maxUnavailable &lt;string&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 更新期间可比期望的Pod数量缺少的数量或比例，10， </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">progressDeadlineSeconds &lt;integer&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 滚动更新故障超时时长，默认为600秒</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">paused &lt;boolean&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 是否暂停部署过程</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># API群组及版本</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 资源类型特有标识</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">name &lt;string&gt;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 资源名称，在作用域中要唯一</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">namespace &lt;string&gt;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 名称空间；Deployment隶属名称空间级别</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">minReadySeconds &lt;integer&gt;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># Pod就绪后多少秒内任一容器无crash方可视为“就绪”</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">replicas &lt;integer&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 期望的Pod副本数，默认为1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">selector &lt;object&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 标签选择器，必须匹配template字段中Pod模板中的标签</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">template &lt;object&gt;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># Pod模板对象</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">revisionHistoryLimit &lt;integer&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 滚动更新历史记录数量，默认为10</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">strategy &lt;Object&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 滚动更新策略</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">type &lt;string&gt;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 滚动更新类型，可用值有Recreate和RollingUpdate；</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">rollingUpdate &lt;Object&gt;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 滚动更新参数，专用于RollingUpdate类型</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">maxSurge &lt;string&gt;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 更新期间可比期望的Pod数量多出的数量或比例；</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">maxUnavailable &lt;string&gt;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 更新期间可比期望的Pod数量缺少的数量或比例，10， </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">progressDeadlineSeconds &lt;integer&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 滚动更新故障超时时长，默认为600秒</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">paused &lt;boolean&gt;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 是否暂停部署过程</span></span></code></pre></div><h2 id="_1-1-什么是deployment" tabindex="-1">1.1 什么是deployment <a class="header-anchor" href="#_1-1-什么是deployment" aria-label="Permalink to &quot;1.1 什么是deployment&quot;">​</a></h2><p>DepLoyment（简称为depLoy）是Kubernetes控制器的一种高级别实现，他构建于RepLicaSet控制器之上。</p><p>我们只需要描述DepLoyment中的目标Pod期望状态，而DepLoyment控制器以受控速率更改<code>实际状态</code>，使其变为<code>期望状态</code>，也就是说，后期我们部署应用不直接使用Pod和RepLicaSet，而是使用DepLoyment控制器来调用RepLicaSet来实现，DepLoyment控制器在RepLicaSet原有基础上，添加了部分特性。</p><ul><li>事件和状态查看：可以通过特定的命令查看Deployment对象的更新进度和状态</li><li>版本记录：将Deployment对象的更新操作都进行保存，以便后续执行回滚操作使用</li><li>多种更新方案：Recreate重建，可以实现单批次更新所有Pod。RoLLingUpdate可以实现多批次逐步替换Pod</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202404301432692.png" alt="image-20240430143254099"></p><h2 id="_1-2-deployment组成部分" tabindex="-1">1.2 deployment组成部分 <a class="header-anchor" href="#_1-2-deployment组成部分" aria-label="Permalink to &quot;1.2 deployment组成部分&quot;">​</a></h2><p>Deployment 资源对象的格式和 ReplicaSet ⼏乎⼀致，<code>Deployment</code> 控制器也包含了3个基本的组成部分</p><ul><li>selector 标签选择器：匹配并关联Pod对象，并对授其管控的Pod对象计数；</li><li>replicas期望的副本数：期望在集群中所运⾏的Pod对象数量</li><li>template Pod模板：实际上就是定义的 Pod 内容，相当于把⼀个Pod 的描述以模板的形式嵌⼊到了 ReplicaSet</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202404301435494.png" alt="image-20240430143537448"></p><h3 id="示例" tabindex="-1">示例 <a class="header-anchor" href="#示例" aria-label="Permalink to &quot;示例&quot;">​</a></h3><ol><li>编写资源配置清单， deployment-demo.yaml</li></ol><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">mall-deploy</span><span style="color:#E1E4E8;">           </span><span style="color:#6A737D;"># 定义deploy资源名称</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">                 </span><span style="color:#6A737D;"># 定义deploy控制Pod的副本数</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">minReadySeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">         </span><span style="color:#6A737D;"># 定义Pod启动后，至少需要等待10秒钟，才能被认为是可用的</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:              </span><span style="color:#6A737D;"># 定义Pod选择器</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">mall</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:                  </span><span style="color:#6A737D;"># Pod 模板，申明Pod名称、使用镜像</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:                </span><span style="color:#6A737D;"># 定义Pod标签</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">mall</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">mall</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">mall-deploy</span><span style="color:#24292E;">           </span><span style="color:#6A737D;"># 定义deploy资源名称</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">                 </span><span style="color:#6A737D;"># 定义deploy控制Pod的副本数</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">minReadySeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">         </span><span style="color:#6A737D;"># 定义Pod启动后，至少需要等待10秒钟，才能被认为是可用的</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:              </span><span style="color:#6A737D;"># 定义Pod选择器</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">mall</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:                  </span><span style="color:#6A737D;"># Pod 模板，申明Pod名称、使用镜像</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:                </span><span style="color:#6A737D;"># 定义Pod标签</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">mall</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">mall</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span></code></pre></div><p>2.应用配置清单</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">VERSION</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">v1</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">envsubst</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deployment-demo.yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">VERSION</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">v1</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">envsubst</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployment-demo.yaml</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看deployment信息</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl get deployments.apps</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                  </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">UP-TO-DATE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AVAILABLE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">deployment-demo</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">/4</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">           </span><span style="color:#79B8FF;">24</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看dp</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl get pods -l </span><span style="color:#9ECBFF;">&#39;app=demoapp,release=stable&#39;</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                               </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">deployment-demo-54c55c8847-7qw8x</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">116</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">deployment-demo-54c55c8847-ch7hp</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">116</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">deployment-demo-54c55c8847-vq9l5</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">115</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">deployment-demo-54c55c8847-x99k6</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">116</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#6A737D;"># 可以看到第一段为deployment名字，最后一段为随机值，中间的fb544c5d8为replicaset中Pod模板的哈希值，也就是template字段的哈希值</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看replicaset信息</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl get rs</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                             </span><span style="color:#9ECBFF;">DESIRED</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">CURRENT</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">deployment-demo-54c55c8847</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">5</span><span style="color:#9ECBFF;">m40s</span></span>
<span class="line"><span style="color:#6A737D;"># 一旦pod模板发生变更，会导致ReplicaSet的哈希值发生变化，然后出发deployment更新的</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看deployment信息</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl get deployments.apps</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">UP-TO-DATE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AVAILABLE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">deployment-demo</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">/4</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">24</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看dp</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl get pods -l </span><span style="color:#032F62;">&#39;app=demoapp,release=stable&#39;</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                               </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">deployment-demo-54c55c8847-7qw8x</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">116</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">deployment-demo-54c55c8847-ch7hp</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">116</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">deployment-demo-54c55c8847-vq9l5</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">115</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">deployment-demo-54c55c8847-x99k6</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">116</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6A737D;"># 可以看到第一段为deployment名字，最后一段为随机值，中间的fb544c5d8为replicaset中Pod模板的哈希值，也就是template字段的哈希值</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看replicaset信息</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl get rs</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                             </span><span style="color:#032F62;">DESIRED</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CURRENT</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">deployment-demo-54c55c8847</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">m40s</span></span>
<span class="line"><span style="color:#6A737D;"># 一旦pod模板发生变更，会导致ReplicaSet的哈希值发生变化，然后出发deployment更新的</span></span></code></pre></div><p>3.对<code>deployment</code>实行滚动更新</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">VERSION</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">v2</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">envsubst</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deployment-demo.yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#使用rollout查看滚动更新的状态</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl rollout status deployment deployment-demo</span></span>
<span class="line"><span style="color:#B392F0;">deployment</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;deployment-demo&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">successfully</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rolled</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">out</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看pod是否更新为v1.2版本</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# curl 172.30.0.181</span></span>
<span class="line"><span style="color:#B392F0;">hsuing</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demoapp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1.2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">!!</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ClientIP:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.25</span><span style="color:#9ECBFF;">.244.192,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PodName:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deployment-demo-74b48bd6db-kd2j2,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PodIP:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.30</span><span style="color:#9ECBFF;">.0.181!</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">VERSION</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">v2</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">envsubst</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployment-demo.yaml</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#使用rollout查看滚动更新的状态</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl rollout status deployment deployment-demo</span></span>
<span class="line"><span style="color:#6F42C1;">deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;deployment-demo&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">successfully</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rolled</span><span style="color:#24292E;"> </span><span style="color:#032F62;">out</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看pod是否更新为v1.2版本</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master yaml]# curl 172.30.0.181</span></span>
<span class="line"><span style="color:#6F42C1;">hsuing</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demoapp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1.2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">!!</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ClientIP:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.25</span><span style="color:#032F62;">.244.192,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PodName:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployment-demo-74b48bd6db-kd2j2,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PodIP:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.30</span><span style="color:#032F62;">.0.181!</span></span></code></pre></div><p>4.<strong>回滚</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看deployment的更新历史信息</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl rollout history deployment deployment-demo</span></span>
<span class="line"><span style="color:#B392F0;">deployment.apps/deployment-demo</span></span>
<span class="line"><span style="color:#B392F0;">REVISION</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">CHANGE-CAUSE</span></span>
<span class="line"><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">2</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># 此为当前版本信息</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#将其回滚到上一个版本</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl rollout undo deployment deployment-demo</span></span>
<span class="line"><span style="color:#B392F0;">deployment.apps/deployment-demo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rolled</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">back</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看replicaset信息</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl get rs</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                             </span><span style="color:#9ECBFF;">DESIRED</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">CURRENT</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">deployment-demo-54c55c8847</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">13</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">deployment-demo-74b48bd6db</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">6</span><span style="color:#9ECBFF;">m15s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#再次查看更新历史</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]#  kubectl rollout history deployment deployment-demo</span></span>
<span class="line"><span style="color:#B392F0;">deployment.apps/deployment-demo</span></span>
<span class="line"><span style="color:#B392F0;">REVISION</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">CHANGE-CAUSE</span></span>
<span class="line"><span style="color:#B392F0;">2</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">3</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#6A737D;"># 可以看到原本的1没有了新增了3，3表示当前的</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看deployment的更新历史信息</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl rollout history deployment deployment-demo</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/deployment-demo</span></span>
<span class="line"><span style="color:#6F42C1;">REVISION</span><span style="color:#24292E;">  </span><span style="color:#032F62;">CHANGE-CAUSE</span></span>
<span class="line"><span style="color:#6F42C1;">1</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">2</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">	</span><span style="color:#6A737D;"># 此为当前版本信息</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#将其回滚到上一个版本</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl rollout undo deployment deployment-demo</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/deployment-demo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rolled</span><span style="color:#24292E;"> </span><span style="color:#032F62;">back</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看replicaset信息</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl get rs</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                             </span><span style="color:#032F62;">DESIRED</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CURRENT</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">deployment-demo-54c55c8847</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">13</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">deployment-demo-74b48bd6db</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">m15s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#再次查看更新历史</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master yaml]#  kubectl rollout history deployment deployment-demo</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/deployment-demo</span></span>
<span class="line"><span style="color:#6F42C1;">REVISION</span><span style="color:#24292E;">  </span><span style="color:#032F62;">CHANGE-CAUSE</span></span>
<span class="line"><span style="color:#6F42C1;">2</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">3</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6A737D;"># 可以看到原本的1没有了新增了3，3表示当前的</span></span></code></pre></div><h1 id="_2-deployment重建策略" tabindex="-1">2.Deployment重建策略 <a class="header-anchor" href="#_2-deployment重建策略" aria-label="Permalink to &quot;2.Deployment重建策略&quot;">​</a></h1><h2 id="_2-1-什么是recreate" tabindex="-1">2.1 什么是Recreate <a class="header-anchor" href="#_2-1-什么是recreate" aria-label="Permalink to &quot;2.1 什么是Recreate&quot;">​</a></h2><p>重建（Recreate）当更新策略设定为Recreate，在更新镜像时，它会先杀死正在运行的Pod，等彻底杀死后，重新创建新的RS，然后启动对应的Pod，那么在这个更新过程中，会造成服务一段时间无法提供服务；</p><p>第一步：同时杀死所有旧版本的Pod，此时Pod无法正常对外提供服务；）</p><p>第二步：创建新的RS，启动新的Pod;</p><p>第三步：等待Pod就绪，对外提供服务；</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405081657671.png" alt="image-20240508165708411"></p><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>通常只有当应用的新旧版本不兼容（例如依赖的后端数据的格式不同且无法兼容）时才会使用Recreate重建策略。</p></div><h2 id="_2-2-recreate实践" tabindex="-1">2.2 Recreate实践 <a class="header-anchor" href="#_2-2-recreate实践" aria-label="Permalink to &quot;2.2 Recreate实践&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-deployment</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">strategy</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Recreate</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">container-recreate</span><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">#定义名字不能有下划线</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v2</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-deployment</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">strategy</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Recreate</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">container-recreate</span><span style="color:#24292E;">	</span><span style="color:#6A737D;">#定义名字不能有下划线</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v2</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><ul><li>观察现象</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl apply  -f demoapp_recreate.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl get pod</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                              </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-bf8f88dbc-4d298</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Terminating</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> (7h45m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)    10d</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-bf8f88dbc-b5dmc</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Terminating</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> (7h45m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)    10d</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-bf8f88dbc-tfl2g</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Terminating</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> (7h45m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)    10d</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-bf8f88dbc-xrjfm</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Terminating</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> (7h45m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)    9d</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl get pod</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                               </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-5684f48684-7zx87</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">87</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-5684f48684-nlwhp</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">87</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-5684f48684-zz6kc</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">87</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl get rs</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                         </span><span style="color:#9ECBFF;">DESIRED</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">CURRENT</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-5684f48684</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">108</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">demo-deployment-bf8f88dbc</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">d</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl apply  -f demoapp_recreate.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl get pod</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                              </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">         </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-bf8f88dbc-4d298</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Terminating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> (7h45m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)    10d</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-bf8f88dbc-b5dmc</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Terminating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> (7h45m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)    10d</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-bf8f88dbc-tfl2g</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Terminating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> (7h45m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)    10d</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-bf8f88dbc-xrjfm</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Terminating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> (7h45m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)    9d</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl get pod</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                               </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">         </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-5684f48684-7zx87</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">                </span><span style="color:#005CC5;">87</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-5684f48684-nlwhp</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">                </span><span style="color:#005CC5;">87</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-5684f48684-zz6kc</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">                </span><span style="color:#005CC5;">87</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl get rs</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                         </span><span style="color:#032F62;">DESIRED</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CURRENT</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-5684f48684</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">108</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">demo-deployment-bf8f88dbc</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">d</span></span></code></pre></div><h1 id="_3-deployment滚动更新" tabindex="-1">3.Deployment滚动更新 <a class="header-anchor" href="#_3-deployment滚动更新" aria-label="Permalink to &quot;3.Deployment滚动更新&quot;">​</a></h1><p><a href="https://kubernetes.io/zh-cn/docs/tutorials/kubernetes-basics/update/update-intro/" target="_blank" rel="noreferrer">https://kubernetes.io/zh-cn/docs/tutorials/kubernetes-basics/update/update-intro/</a></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">explain</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deploy.spec.strategy</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">explain</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deploy.spec.strategy</span></span></code></pre></div><h2 id="_3-1-什么是滚动更新" tabindex="-1">3.1 什么是滚动更新 <a class="header-anchor" href="#_3-1-什么是滚动更新" aria-label="Permalink to &quot;3.1 什么是滚动更新&quot;">​</a></h2><p>滚动更新（RoLLingUpdate），一次仅更新一批Pod，当更新的Pod就绪后，在更新另一批，直到全部更新完成为止；该策略实现了不间断服务的目标，在更新过程中可能会出现不同的应用版本并存且，同时提供服务的情况。</p><ul><li>第一步：创建新的RepLicaSet，然后根据新的镜像运行新的Pod;</li><li>第二步：删除l旧的Pod，启动新的Pod，新Pod就绪后，继续删除旧Pod，启动新Pod;</li><li>第三步：持续第二步过程，一直到所有Pod都被更新成功。</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405111619936.png" alt="image-20240511161739157"></p><h2 id="_3-2-实践" tabindex="-1">3.2 实践 <a class="header-anchor" href="#_3-2-实践" aria-label="Permalink to &quot;3.2 实践&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-deployment</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">strategy</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">RollingUpdate</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">container-recreate</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v2</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-deployment</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">strategy</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RollingUpdate</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">container-recreate</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v2</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><ul><li>应用</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl apply  -f demoapp_RollingUpdate.yaml</span></span>
<span class="line"><span style="color:#B392F0;">deployment.apps/demo-deployment</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">configured</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl apply  -f demoapp_RollingUpdate.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/demo-deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">configured</span></span></code></pre></div><ul><li>观察</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl describe deployments.apps demo-deployment</span></span>
<span class="line"><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#B392F0;">Events:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Type</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Reason</span><span style="color:#E1E4E8;">             </span><span style="color:#9ECBFF;">Age</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">From</span><span style="color:#E1E4E8;">                   </span><span style="color:#9ECBFF;">Message</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">----</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">------</span><span style="color:#E1E4E8;">             </span><span style="color:#79B8FF;">----</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">----</span><span style="color:#E1E4E8;">                   </span><span style="color:#79B8FF;">-------</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Normal</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">ScalingReplicaSet</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">5</span><span style="color:#9ECBFF;">m33s</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">deployment-controller</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Scaled</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">down</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replica</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-deployment-5684f48684</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Normal</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">ScalingReplicaSet</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">m59s</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">deployment-controller</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Scaled</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">up</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replica</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-deployment-645bbb7877</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Normal</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">ScalingReplicaSet</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">63</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">deployment-controller</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Scaled</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">up</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replica</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-deployment-5684f48684</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Normal</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">ScalingReplicaSet</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">60</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">deployment-controller</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Scaled</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">down</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replica</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-deployment-645bbb7877</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Normal</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">ScalingReplicaSet</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">60</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">deployment-controller</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Scaled</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">up</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replica</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-deployment-5684f48684</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Normal</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">ScalingReplicaSet</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">58</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">deployment-controller</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Scaled</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">down</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replica</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-deployment-645bbb7877</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Normal</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">ScalingReplicaSet</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">58</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">deployment-controller</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Scaled</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">up</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replica</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-deployment-5684f48684</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Normal</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">ScalingReplicaSet</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">56</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">deployment-controller</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Scaled</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">down</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replica</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-deployment-645bbb7877</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl describe deployments.apps demo-deployment</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#6F42C1;">Events:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Type</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Reason</span><span style="color:#24292E;">             </span><span style="color:#032F62;">Age</span><span style="color:#24292E;">    </span><span style="color:#032F62;">From</span><span style="color:#24292E;">                   </span><span style="color:#032F62;">Message</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">----</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">------</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">----</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">----</span><span style="color:#24292E;">                   </span><span style="color:#005CC5;">-------</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Normal</span><span style="color:#24292E;">  </span><span style="color:#032F62;">ScalingReplicaSet</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">m33s</span><span style="color:#24292E;">  </span><span style="color:#032F62;">deployment-controller</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Scaled</span><span style="color:#24292E;"> </span><span style="color:#032F62;">down</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replica</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-deployment-5684f48684</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Normal</span><span style="color:#24292E;">  </span><span style="color:#032F62;">ScalingReplicaSet</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">m59s</span><span style="color:#24292E;">  </span><span style="color:#032F62;">deployment-controller</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Scaled</span><span style="color:#24292E;"> </span><span style="color:#032F62;">up</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replica</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-deployment-645bbb7877</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Normal</span><span style="color:#24292E;">  </span><span style="color:#032F62;">ScalingReplicaSet</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">63</span><span style="color:#032F62;">s</span><span style="color:#24292E;">    </span><span style="color:#032F62;">deployment-controller</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Scaled</span><span style="color:#24292E;"> </span><span style="color:#032F62;">up</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replica</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-deployment-5684f48684</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Normal</span><span style="color:#24292E;">  </span><span style="color:#032F62;">ScalingReplicaSet</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">60</span><span style="color:#032F62;">s</span><span style="color:#24292E;">    </span><span style="color:#032F62;">deployment-controller</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Scaled</span><span style="color:#24292E;"> </span><span style="color:#032F62;">down</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replica</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-deployment-645bbb7877</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Normal</span><span style="color:#24292E;">  </span><span style="color:#032F62;">ScalingReplicaSet</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">60</span><span style="color:#032F62;">s</span><span style="color:#24292E;">    </span><span style="color:#032F62;">deployment-controller</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Scaled</span><span style="color:#24292E;"> </span><span style="color:#032F62;">up</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replica</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-deployment-5684f48684</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Normal</span><span style="color:#24292E;">  </span><span style="color:#032F62;">ScalingReplicaSet</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">58</span><span style="color:#032F62;">s</span><span style="color:#24292E;">    </span><span style="color:#032F62;">deployment-controller</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Scaled</span><span style="color:#24292E;"> </span><span style="color:#032F62;">down</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replica</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-deployment-645bbb7877</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Normal</span><span style="color:#24292E;">  </span><span style="color:#032F62;">ScalingReplicaSet</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">58</span><span style="color:#032F62;">s</span><span style="color:#24292E;">    </span><span style="color:#032F62;">deployment-controller</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Scaled</span><span style="color:#24292E;"> </span><span style="color:#032F62;">up</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replica</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-deployment-5684f48684</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Normal</span><span style="color:#24292E;">  </span><span style="color:#032F62;">ScalingReplicaSet</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">56</span><span style="color:#032F62;">s</span><span style="color:#24292E;">    </span><span style="color:#032F62;">deployment-controller</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Scaled</span><span style="color:#24292E;"> </span><span style="color:#032F62;">down</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replica</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-deployment-645bbb7877</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>会发现新老版本存在交替，但并不会出现服务不可用状态；</p></div><h2 id="_3-3-应用回退实践" tabindex="-1">3.3 应⽤回退实践 <a class="header-anchor" href="#_3-3-应用回退实践" aria-label="Permalink to &quot;3.3 应⽤回退实践&quot;">​</a></h2><p>有时候，你可能想要回滚 DepLoyment；例如，当DepLoyment 不稳定进入反复崩溃状态。默认情况下，DepLoyment的所有上线记录都保留在系统中，以便可以随时回滚。（你可以通过修改revisionHistoryLimit调整保留的数量，默认10条)</p><h3 id="检查-deployment-上线的历史版本" tabindex="-1">检查 Deployment 上线的历史版本 <a class="header-anchor" href="#检查-deployment-上线的历史版本" aria-label="Permalink to &quot;检查 Deployment 上线的历史版本&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl rollout history deployment </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">deployment_name</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">deployment.apps/demo-deployment</span></span>
<span class="line"><span style="color:#B392F0;">REVISION</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">CHANGE-CAUSE</span></span>
<span class="line"><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">3</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">4</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl rollout history deployment </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">deployment_name</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/demo-deployment</span></span>
<span class="line"><span style="color:#6F42C1;">REVISION</span><span style="color:#24292E;">  </span><span style="color:#032F62;">CHANGE-CAUSE</span></span>
<span class="line"><span style="color:#6F42C1;">1</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">3</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">4</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><h3 id="查看revision对应版本" tabindex="-1">查看revision对应版本 <a class="header-anchor" href="#查看revision对应版本" aria-label="Permalink to &quot;查看revision对应版本&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl rollout history deployment demo-deployment --revision=4</span></span>
<span class="line"><span style="color:#B392F0;">deployment.apps/demo-deployment</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">revision</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#4</span></span>
<span class="line"><span style="color:#B392F0;">Pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Template:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Labels:</span><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">app=demo</span></span>
<span class="line"><span style="color:#E1E4E8;">	pod-template-hash</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">645</span><span style="color:#9ECBFF;">bbb7877</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Containers:</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">container-recreate:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Image:</span><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Port:</span><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">/TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Host</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Port:</span><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Environment:</span><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Mounts:</span><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Volumes:</span><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl rollout history deployment demo-deployment --revision=4</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/demo-deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">with</span><span style="color:#24292E;"> </span><span style="color:#032F62;">revision</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#4</span></span>
<span class="line"><span style="color:#6F42C1;">Pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Template:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Labels:</span><span style="color:#24292E;">	</span><span style="color:#032F62;">app=demo</span></span>
<span class="line"><span style="color:#24292E;">	pod-template-hash</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">645</span><span style="color:#032F62;">bbb7877</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Containers:</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">container-recreate:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Image:</span><span style="color:#24292E;">	</span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Port:</span><span style="color:#24292E;">	</span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Host</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Port:</span><span style="color:#24292E;">	</span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Environment:</span><span style="color:#24292E;">	</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Mounts:</span><span style="color:#24292E;">	</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Volumes:</span><span style="color:#24292E;">	</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><h3 id="开始回退" tabindex="-1">开始回退 <a class="header-anchor" href="#开始回退" aria-label="Permalink to &quot;开始回退&quot;">​</a></h3><blockquote><p>通过--to-revision参数回退</p></blockquote><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl rollout undo deployment demo-deployment --to-revision=4</span></span>
<span class="line"><span style="color:#B392F0;">deployment.apps/demo-deployment</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rolled</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">back</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl rollout undo deployment demo-deployment --to-revision=4</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/demo-deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rolled</span><span style="color:#24292E;"> </span><span style="color:#032F62;">back</span></span></code></pre></div><h1 id="_4-deployment更新策略" tabindex="-1">4.Deployment更新策略 <a class="header-anchor" href="#_4-deployment更新策略" aria-label="Permalink to &quot;4.Deployment更新策略&quot;">​</a></h1><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">explain</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deploy.spec.strategy</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">explain</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deploy.spec.strategy</span></span></code></pre></div><p>Deployment 会在 <code>.spec.strategy.type=RollingUpdate</code>时，采取滚动更新的方式更新 Pods。可以指定<code>maxUnavailable</code>和<code>maxSurgeS</code>来控制滚动更新过程</p><ul><li><p>maxSurge最大可用Pod</p><ul><li>用来指定可以创建超出期望Pod个数的Pod数量。可以是数字，也可以是百分比（例如10%）此字段的默认值为25%</li><li>例如，当此值为20%时，启动滚动更新后，会立即对新的ReplicaSet扩容，同时保证新l旧 Pod 的总数不超过所需Pod 总数的 120%。一旦l旧 Pods 被杀死，新的ReplicaSet 可以进一步扩容，同时确保更新期间的任何时候运行中的 Pods 总数最多为所需 Pods 总数的 120%。计算公式：<code>10+（10x20%）=12</code></li></ul></li><li><p>maxUnavailable最大不可用Pod</p><ul><li>用来指定更新过程中不可用的 Pod 的个数上限。可以是数字,也可以是百分比 (例如10%)此字段的默认值为25%</li><li>例如，当此值设置为20%时，滚动更新开始时会立即将旧RepLicaSet 缩容到期望 Pod 个数的7θ%。新Pod 准备就绪后，继续缩容l旧有的 ReplicaSet，然后对新的ReplicaSet 扩容，确保在更新期间可用的 Pods总数在任何时候都是所需的 Pod 个数的 70%。计算公式：<code>10-(10x20%)=8</code></li></ul><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>maxSurge和maxUnavaiLable两个属性协同工作，可组合定义出3中不同的策略完成多批次的应用更新。</p><p>1-先增新，后减旧：将maxSurge设置为30%，将maxUnavailable的值设为θ;</p><p>2-先减旧，后增新：将maxUnavaiLabLe设置为30%，将maxSurge的值设为θ;</p><p>3-同时增减，将maxSurge和maxUnavaiLabLe分别设定为20%;期望是12Pod，至少就绪8个Pod</p></div></li></ul><h2 id="_4-1-maxsurge" tabindex="-1">4.1 maxSurge <a class="header-anchor" href="#_4-1-maxsurge" aria-label="Permalink to &quot;4.1 maxSurge&quot;">​</a></h2><p>指定升级期间存在的总Pod对象数量最多可超出期望值的个数，可以是0，也可以是整数，也可以是⼀个百分⽐</p><p>例如：期望的的值为10，maxSurge属性为2，则表示Pod对象总数不能超过12个。计算公式：10+（10x20%）=12</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405111806790.png" alt="image-20240511180622207"></p><h3 id="实践" tabindex="-1">实践 <a class="header-anchor" href="#实践" aria-label="Permalink to &quot;实践&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# cat demoapp_RollingUpdate_max.yaml</span></span>
<span class="line"><span style="color:#B392F0;">apiVersion:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#B392F0;">kind:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#B392F0;">metadata:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-deployment</span></span>
<span class="line"><span style="color:#B392F0;">spec:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">replicas:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">strategy:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">rollingUpdate:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">maxSurge:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#9ECBFF;">%</span><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;"># 最⼤可⽤20%</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">maxUnavailable:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># 不可⽤状态设定为0</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">selector:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">matchLabels:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">app:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">template:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">metadata:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">labels:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">app:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">spec:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">containers:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">container-recreate</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">image:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v2</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">ports:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">containerPort:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master yaml]# cat demoapp_RollingUpdate_max.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">apiVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#6F42C1;">kind:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#6F42C1;">metadata:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-deployment</span></span>
<span class="line"><span style="color:#6F42C1;">spec:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">replicas:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">strategy:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">rollingUpdate:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">maxSurge:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#032F62;">%</span><span style="color:#24292E;">		</span><span style="color:#6A737D;"># 最⼤可⽤20%</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">maxUnavailable:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">	</span><span style="color:#6A737D;"># 不可⽤状态设定为0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">selector:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">matchLabels:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">app:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">template:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">metadata:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">labels:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">app:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">spec:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">containers:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">container-recreate</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">image:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v2</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">ports:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">containerPort:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">watch</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">describe</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deployments.apps</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo-deployment</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">watch</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">describe</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployments.apps</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo-deployment</span></span></code></pre></div><h2 id="_4-2-maxunavailable" tabindex="-1">4.2 maxUnavailable <a class="header-anchor" href="#_4-2-maxunavailable" aria-label="Permalink to &quot;4.2 maxUnavailable&quot;">​</a></h2><p>升级期间不可⽤的Pod副本数（包括新版本），最多不能低于期望的个数，默认为1</p><p>如：期望的值为1θ，maxunavaiabLe属性为2，则表示Pod处于正常状态至少有8个。计算公式：: <code>10-（10x20%)=8</code></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405131556549.png" alt="image-20240513155123431"></p><h3 id="实践-1" tabindex="-1">实践 <a class="header-anchor" href="#实践-1" aria-label="Permalink to &quot;实践&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master yaml</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat demoapp_RollingUpdate_max.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-deployment</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">strategy</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">rollingUpdate</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">maxSurge</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">			</span><span style="color:#6A737D;"># 最⼤可⽤0</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">maxUnavailable</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">20%</span><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># 不可⽤Pod副本最低20%</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">container-recreate</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v2</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master yaml</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat demoapp_RollingUpdate_max.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-deployment</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">strategy</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">rollingUpdate</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">maxSurge</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">			</span><span style="color:#6A737D;"># 最⼤可⽤0</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">maxUnavailable</span><span style="color:#24292E;">: </span><span style="color:#032F62;">20%</span><span style="color:#24292E;">	</span><span style="color:#6A737D;"># 不可⽤Pod副本最低20%</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">container-recreate</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v2</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><ul><li>观察</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">watch</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rs</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">watch</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rs</span></span></code></pre></div><h2 id="_4-3-maxsurge-maxunavailable" tabindex="-1">4.3 maxSurge &amp; MaxUnavailable <a class="header-anchor" href="#_4-3-maxsurge-maxunavailable" aria-label="Permalink to &quot;4.3 maxSurge &amp; MaxUnavailable&quot;">​</a></h2><p>同时设定maxSurge 以及 MaxUnavailable</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-deployment</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">strategy</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">rollingUpdate</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">maxSurge</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">20%</span><span style="color:#E1E4E8;">			</span><span style="color:#6A737D;"># 最⼤可⽤0</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">maxUnavailable</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">20%</span><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># 不可⽤Pod副本最低20%</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">container-recreate</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v2</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-deployment</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">strategy</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">rollingUpdate</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">maxSurge</span><span style="color:#24292E;">: </span><span style="color:#032F62;">20%</span><span style="color:#24292E;">			</span><span style="color:#6A737D;"># 最⼤可⽤0</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">maxUnavailable</span><span style="color:#24292E;">: </span><span style="color:#032F62;">20%</span><span style="color:#24292E;">	</span><span style="color:#6A737D;"># 不可⽤Pod副本最低20%</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">container-recreate</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v2</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><h2 id="_4-4-minreadyseconds" tabindex="-1">4.4 minReadySeconds <a class="header-anchor" href="#_4-4-minreadyseconds" aria-label="Permalink to &quot;4.4 minReadySeconds&quot;">​</a></h2><p>Deployment支持使用<code>spec.minReadySeconds</code>字段来控制滚动更新的速度，默认值为θ，表示新建的Pod对象一旦“就绪&quot;将立即被视作可用，随后即可开始下一轮更新过程。如果设定了<code>spec.minReadySeconds：3</code>及表示新建的Pod对象至少要成功运行多久才会被视作可用，即就绪之后还要等待指定的3s才能开始下一批次的更新。在一个批次内新建的所有Pod就绪后在转为可用状态前，更新操作会被阻塞，并且任何一个Pod就绪探测失败，都会导致滚动更新被终止。</p><p>因此，为<code>minReadySeconds</code>设定一个合理的值，不仅能够减缓更新的速度，还能够让DepLoyment提前发现一部分程序因为Bug导致的升级故障。</p><h2 id="_4-5-revisionhistorylimit" tabindex="-1">4.5 revisionHistoryLimit <a class="header-anchor" href="#_4-5-revisionhistorylimit" aria-label="Permalink to &quot;4.5 revisionHistoryLimit&quot;">​</a></h2><p>Deployment保留一部分<code>更新历史中旧版本的ReplicaSet</code>对象，当我们执行回滚操作的时候，就直接使用旧版本的ReplicaSet，在Deployment资源保存历史版本数量有<code>spec.revisionHistoryLimit</code> 属性进行定义</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405131627023.png" alt="image-20240513162737133"></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master yaml]# kubectl rollout history deployment</span></span>
<span class="line"><span style="color:#B392F0;">deployment.apps/demo-deployment</span></span>
<span class="line"><span style="color:#B392F0;">REVISION</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">CHANGE-CAUSE</span></span>
<span class="line"><span style="color:#B392F0;">2</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">3</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">deployment.apps/nginx</span></span>
<span class="line"><span style="color:#B392F0;">REVISION</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">CHANGE-CAUSE</span></span>
<span class="line"><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master yaml]# kubectl rollout history deployment</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/demo-deployment</span></span>
<span class="line"><span style="color:#6F42C1;">REVISION</span><span style="color:#24292E;">  </span><span style="color:#032F62;">CHANGE-CAUSE</span></span>
<span class="line"><span style="color:#6F42C1;">2</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">3</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/nginx</span></span>
<span class="line"><span style="color:#6F42C1;">REVISION</span><span style="color:#24292E;">  </span><span style="color:#032F62;">CHANGE-CAUSE</span></span>
<span class="line"><span style="color:#6F42C1;">1</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><h2 id="_4-6-progressdeadlineseconds" tabindex="-1">4.6 progressDeadlineSeconds <a class="header-anchor" href="#_4-6-progressdeadlineseconds" aria-label="Permalink to &quot;4.6 progressDeadlineSeconds&quot;">​</a></h2><p>滚动更新故障超时时长，默认为600秒，k8s在升级过程中有可能由于各种原因升级卡住（这个时候还没有明确的升级失败），比如在拉取被墙的镜像，权限不够等错误。如果配置progressDeadlineSeconds，当达到了时间如果还卡着，则会上报这个异常情况，这个时候这个Deployment状态就被标记为False，并且注明原因。但是它并不会阻止Deployment继续进行卡住后面的升级操作.</p><h2 id="_4-7-红绿发布" tabindex="-1">4.7 红绿发布 <a class="header-anchor" href="#_4-7-红绿发布" aria-label="Permalink to &quot;4.7 红绿发布&quot;">​</a></h2><h3 id="_1-0" tabindex="-1">1.0 <a class="header-anchor" href="#_1-0" aria-label="Permalink to &quot;1.0&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master yaml</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat hong_lu1.0.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demoapp-version-10-prod</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demoapp</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">version</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1.0</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demoapp</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">version</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1.0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demoapp</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1.0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demoapp-version-service</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demoapp</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master yaml</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat hong_lu1.0.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demoapp-version-10-prod</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demoapp</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">version</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1.0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demoapp</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">version</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1.0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demoapp</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1.0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demoapp-version-service</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demoapp</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><h3 id="_1-1" tabindex="-1">1.1 <a class="header-anchor" href="#_1-1" aria-label="Permalink to &quot;1.1&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demoapp-version-11-prod</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demoapp</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">version</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1.1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demoapp</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">version</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1.1</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demoapp</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1.1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demoapp-version-11-prod</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demoapp</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">version</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1.1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demoapp</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">version</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1.1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demoapp</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1.1</span></span></code></pre></div><ul><li>访问clusterIP</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">svc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clusterIp/version</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">svc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clusterIp/version</span></span></code></pre></div>`,97),e=[o];function t(c,r,y,E,i,F){return n(),a("div",null,e)}const C=s(p,[["render",t]]);export{m as __pageData,C as default};
