import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const F=JSON.parse('{"title":"1.CRUD(v3)","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/etcd/5-cmd.md","filePath":"guide/Database/etcd/5-cmd.md","lastUpdated":1703141608000}'),e={name:"guide/Database/etcd/5-cmd.md"},p=l(`<h1 id="_1-crud-v3" tabindex="-1">1.CRUD(v3) <a class="header-anchor" href="#_1-crud-v3" aria-label="Permalink to &quot;1.CRUD(v3)&quot;">​</a></h1><p>etcd 版本为 3.4，可以ETCDCTL_API=3，或ETCDCTL_API=2，默认情况下用的就是v3了，可以不用声明ETCDCTL_API</p><p>数据库操作围绕对键值和目录的 CRUD （符合 REST 风格的一套操作：Create）完整生命周期的管理。</p><p>etcd 在键的组织上采用了层次化的空间结构（类似于文件系统中目录的概念），用户指定的键可以为单独的名字，如 myname，此时实际上放在根目录 / 下面，也可以为指定目录结构，如 cluster1/node2/testkey，则将创建相应的目录结构</p><p><strong>提示：CRUD 即 Create, Read, Update, Delete，是符合 REST 风格的一套 API 操作</strong></p><h2 id="_1-查看版本" tabindex="-1">1.查看版本 <a class="header-anchor" href="#_1-查看版本" aria-label="Permalink to &quot;1.查看版本&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[root@localhost etcd_data]# etcdctl version </span></span>
<span class="line"><span style="color:#e1e4e8;">etcdctl version: 3.4.16</span></span>
<span class="line"><span style="color:#e1e4e8;">API version: 3.4</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[root@localhost etcd_data]# etcdctl version </span></span>
<span class="line"><span style="color:#24292e;">etcdctl version: 3.4.16</span></span>
<span class="line"><span style="color:#24292e;">API version: 3.4</span></span></code></pre></div><h2 id="_2-查看成员" tabindex="-1">2.查看成员 <a class="header-anchor" href="#_2-查看成员" aria-label="Permalink to &quot;2.查看成员&quot;">​</a></h2><p>[root@localhost etcd_data]# etcdctl member list --write-out=table</p><h2 id="_3-插入数据" tabindex="-1">3.插入数据 <a class="header-anchor" href="#_3-插入数据" aria-label="Permalink to &quot;3.插入数据&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#etcdctl put key value</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@localhost etcd_data]# etcdctl put foo bar</span></span>
<span class="line"><span style="color:#B392F0;">OK</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#或者</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@localhost etcd_data]# etcdctl put demo 101 -w json</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">&quot;header&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#E1E4E8;">{&quot;</span><span style="color:#B392F0;">cluster_id</span><span style="color:#B392F0;">&quot;:14841639068965178418,&quot;</span><span style="color:#B392F0;">member_id</span><span style="color:#B392F0;">&quot;:10276657743932975437,&quot;</span><span style="color:#B392F0;">revision</span><span style="color:#B392F0;">&quot;:5,&quot;</span><span style="color:#B392F0;">raft_term</span><span style="color:#B392F0;">&quot;:3}}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#etcdctl put key value</span></span>
<span class="line"><span style="color:#24292E;">[root@localhost etcd_data]# etcdctl put foo bar</span></span>
<span class="line"><span style="color:#6F42C1;">OK</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#或者</span></span>
<span class="line"><span style="color:#24292E;">[root@localhost etcd_data]# etcdctl put demo 101 -w json</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#6F42C1;">&quot;header&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;">{&quot;</span><span style="color:#6F42C1;">cluster_id</span><span style="color:#6F42C1;">&quot;:14841639068965178418,&quot;</span><span style="color:#6F42C1;">member_id</span><span style="color:#6F42C1;">&quot;:10276657743932975437,&quot;</span><span style="color:#6F42C1;">revision</span><span style="color:#6F42C1;">&quot;:5,&quot;</span><span style="color:#6F42C1;">raft_term</span><span style="color:#6F42C1;">&quot;:3}}</span></span></code></pre></div><h2 id="_4-查询" tabindex="-1">4.查询 <a class="header-anchor" href="#_4-查询" aria-label="Permalink to &quot;4.查询&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@localhost etcd_data]# etcdctl get foo</span></span>
<span class="line"><span style="color:#B392F0;">foo</span></span>
<span class="line"><span style="color:#B392F0;">bar</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#更新</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@localhost etcd_data]#etcdctl put app demo2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@localhost etcd_data]# etcdctl get foo</span></span>
<span class="line"><span style="color:#6F42C1;">foo</span></span>
<span class="line"><span style="color:#6F42C1;">bar</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#更新</span></span>
<span class="line"><span style="color:#24292E;">[root@localhost etcd_data]#etcdctl put app demo2</span></span></code></pre></div><h2 id="_5-删除数据" tabindex="-1">5.删除数据 <a class="header-anchor" href="#_5-删除数据" aria-label="Permalink to &quot;5.删除数据&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[root@localhost etcd_data]# etcdctl del foo</span></span>
<span class="line"><span style="color:#e1e4e8;">1</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#删除所有</span></span>
<span class="line"><span style="color:#e1e4e8;">etcdctl del &quot;&quot; --prefix</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">ETCDCTL_API=3 etcdctl get &quot;/registry/deployment&quot; --prefix --keys-only | sed &#39;/^\\s$/d&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[root@localhost etcd_data]# etcdctl del foo</span></span>
<span class="line"><span style="color:#24292e;">1</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#删除所有</span></span>
<span class="line"><span style="color:#24292e;">etcdctl del &quot;&quot; --prefix</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">ETCDCTL_API=3 etcdctl get &quot;/registry/deployment&quot; --prefix --keys-only | sed &#39;/^\\s$/d&#39;</span></span></code></pre></div><h3 id="删除指定前缀的key" tabindex="-1">删除指定前缀的key <a class="header-anchor" href="#删除指定前缀的key" aria-label="Permalink to &quot;删除指定前缀的key&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[root@localhost etcd_data]# etcdctl del --prev-kv --prefix name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[root@localhost etcd_data]# etcdctl del --prev-kv --prefix name</span></span></code></pre></div><h3 id="删除key" tabindex="-1">删除key <a class="header-anchor" href="#删除key" aria-label="Permalink to &quot;删除key&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[root@localhost etcd_data]# etcdctl del key_name11</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[root@localhost etcd_data]# etcdctl del key_name11</span></span></code></pre></div><h2 id="_6-查看所有key" tabindex="-1">6.查看所有key <a class="header-anchor" href="#_6-查看所有key" aria-label="Permalink to &quot;6.查看所有key&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[root@localhost etcd_data]# etcdctl --prefix --keys-only=true get &quot;&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">foo</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[root@localhost etcd_data]# etcdctl --prefix --keys-only=true get &quot;&quot;</span></span>
<span class="line"><span style="color:#24292e;">foo</span></span></code></pre></div><h3 id="按key查询" tabindex="-1">按key查询 <a class="header-anchor" href="#按key查询" aria-label="Permalink to &quot;按key查询&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[root@localhost etcd_data]#  etcdctl get key_name1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[root@localhost etcd_data]#  etcdctl get key_name1</span></span></code></pre></div><ul><li>不显示key只限制values</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[root@localhost etcd_data]#  etcdctl get --print-value-only key_name1</span></span>
<span class="line"><span style="color:#e1e4e8;">james</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[root@localhost etcd_data]#  etcdctl get --print-value-only key_name1</span></span>
<span class="line"><span style="color:#24292e;">james</span></span></code></pre></div><h3 id="按key前缀查找" tabindex="-1">按key前缀查找 <a class="header-anchor" href="#按key前缀查找" aria-label="Permalink to &quot;按key前缀查找&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[root@localhost etcd_data]# etcdctl get --prefix key_name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[root@localhost etcd_data]# etcdctl get --prefix key_name</span></span></code></pre></div><h2 id="更新key" tabindex="-1">更新key <a class="header-anchor" href="#更新key" aria-label="Permalink to &quot;更新key&quot;">​</a></h2><p>put</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"># etcdctl get --prefix &quot;&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">avg_age</span></span>
<span class="line"><span style="color:#e1e4e8;">25</span></span>
<span class="line"><span style="color:#e1e4e8;"># etcdctl put avg_age 30</span></span>
<span class="line"><span style="color:#e1e4e8;">OK</span></span>
<span class="line"><span style="color:#e1e4e8;"># etcdctl get --prefix &quot;&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">avg_age</span></span>
<span class="line"><span style="color:#e1e4e8;">30</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"># etcdctl get --prefix &quot;&quot;</span></span>
<span class="line"><span style="color:#24292e;">avg_age</span></span>
<span class="line"><span style="color:#24292e;">25</span></span>
<span class="line"><span style="color:#24292e;"># etcdctl put avg_age 30</span></span>
<span class="line"><span style="color:#24292e;">OK</span></span>
<span class="line"><span style="color:#24292e;"># etcdctl get --prefix &quot;&quot;</span></span>
<span class="line"><span style="color:#24292e;">avg_age</span></span>
<span class="line"><span style="color:#24292e;">30</span></span></code></pre></div><h2 id="_7-警告" tabindex="-1">7.警告 <a class="header-anchor" href="#_7-警告" aria-label="Permalink to &quot;7.警告&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看警告，如存储满时会切换为只读，产生 alarm</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@localhost etcd_data]#etcdctl alarm list</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#清除所有警告</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@localhost etcd_data]#alarm disarm</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看警告，如存储满时会切换为只读，产生 alarm</span></span>
<span class="line"><span style="color:#24292E;">[root@localhost etcd_data]#etcdctl alarm list</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#清除所有警告</span></span>
<span class="line"><span style="color:#24292E;">[root@localhost etcd_data]#alarm disarm</span></span></code></pre></div><h1 id="_2-restapi" tabindex="-1">2.<strong>restAPI</strong> <a class="header-anchor" href="#_2-restapi" aria-label="Permalink to &quot;2.**restAPI**&quot;">​</a></h1><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">查看版本get：http://127.0.0.1:2379/version</span></span>
<span class="line"><span style="color:#e1e4e8;"># curl -s http://127.0.0.1:2379/version </span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">插入一个键值对put: http://10.110.30.183:2379/v2/keys/foo?value=bar</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">查询一个键get: http://10.110.30.179:2379/v2/keys/foo</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">查看集群的状态get：http://10.110.30.183:2379/v2/stats/store</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">查看全部键值get：http://10.110.30.183:2379/v2/keys</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#查看etcd暴露出来的prometheus指标；在prometheus对其监控时使用</span></span>
<span class="line"><span style="color:#e1e4e8;">curl -L http://127.0.0.1:2379/metrics</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">查看版本get：http://127.0.0.1:2379/version</span></span>
<span class="line"><span style="color:#24292e;"># curl -s http://127.0.0.1:2379/version </span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">插入一个键值对put: http://10.110.30.183:2379/v2/keys/foo?value=bar</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">查询一个键get: http://10.110.30.179:2379/v2/keys/foo</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">查看集群的状态get：http://10.110.30.183:2379/v2/stats/store</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">查看全部键值get：http://10.110.30.183:2379/v2/keys</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#查看etcd暴露出来的prometheus指标；在prometheus对其监控时使用</span></span>
<span class="line"><span style="color:#24292e;">curl -L http://127.0.0.1:2379/metrics</span></span></code></pre></div><h1 id="_3-成员管理" tabindex="-1">3.成员管理 <a class="header-anchor" href="#_3-成员管理" aria-label="Permalink to &quot;3.成员管理&quot;">​</a></h1><h2 id="_1-查看成员" tabindex="-1">1.查看成员 <a class="header-anchor" href="#_1-查看成员" aria-label="Permalink to &quot;1.查看成员&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">#查看默认端口</span></span>
<span class="line"><span style="color:#e1e4e8;">etcdctl member list --write-out=table</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#查看非默认端口</span></span>
<span class="line"><span style="color:#e1e4e8;">etcdctl --endpoints=http://127.0.0.1:2379 member list --write-out=table</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">#查看默认端口</span></span>
<span class="line"><span style="color:#24292e;">etcdctl member list --write-out=table</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#查看非默认端口</span></span>
<span class="line"><span style="color:#24292e;">etcdctl --endpoints=http://127.0.0.1:2379 member list --write-out=table</span></span></code></pre></div><h2 id="_2-添加成员" tabindex="-1">2.添加成员 <a class="header-anchor" href="#_2-添加成员" aria-label="Permalink to &quot;2.添加成员&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@localhost etcd_data]# etcdctl member add node2 --peer-urls=http://172.24.8.101:2380</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Member</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">13</span><span style="color:#9ECBFF;">e169ac57ee13d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">added</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cdf818194e3a8c32</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">ETCD_NAME</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;node2&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">ETCD_INITIAL_CLUSTER</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;node2=http://172.24.8.101:2380,default=http://localhost:2380&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;http://172.24.8.101:2380&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">ETCD_INITIAL_CLUSTER_STATE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;existing&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@localhost etcd_data]# etcdctl member add node2 --peer-urls=http://172.24.8.101:2380</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Member</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">13</span><span style="color:#032F62;">e169ac57ee13d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">added</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cdf818194e3a8c32</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">ETCD_NAME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;node2&quot;</span></span>
<span class="line"><span style="color:#24292E;">ETCD_INITIAL_CLUSTER</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;node2=http://172.24.8.101:2380,default=http://localhost:2380&quot;</span></span>
<span class="line"><span style="color:#24292E;">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;http://172.24.8.101:2380&quot;</span></span>
<span class="line"><span style="color:#24292E;">ETCD_INITIAL_CLUSTER_STATE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;existing&quot;</span></span></code></pre></div><h2 id="_3-删除成员" tabindex="-1">3.删除成员 <a class="header-anchor" href="#_3-删除成员" aria-label="Permalink to &quot;3.删除成员&quot;">​</a></h2><p>etcdctl member list</p><p>etcdctl member remove id_name</p><h2 id="_4-更新成员peerurls" tabindex="-1">4.更新成员peerURLS <a class="header-anchor" href="#_4-更新成员peerurls" aria-label="Permalink to &quot;4.更新成员peerURLS&quot;">​</a></h2><p>etcdctl member update node2 --peer-urls=<a href="http://172.24.8.102:2380" target="_blank" rel="noreferrer">http://172.24.8.102:2380</a></p><h1 id="_4-v2" tabindex="-1">4.v2 <a class="header-anchor" href="#_4-v2" aria-label="Permalink to &quot;4.v2&quot;">​</a></h1><h1 id="_5-存储空间配额优化" tabindex="-1">5.存储空间配额优化 <a class="header-anchor" href="#_5-存储空间配额优化" aria-label="Permalink to &quot;5.存储空间配额优化&quot;">​</a></h1><p><a href="https://etcd.io/docs/v3.4/op-guide/maintenance/" target="_blank" rel="noreferrer">https://etcd.io/docs/v3.4/op-guide/maintenance/</a></p><h2 id="历史记录压缩" tabindex="-1">历史记录压缩 <a class="header-anchor" href="#历史记录压缩" aria-label="Permalink to &quot;历史记录压缩&quot;">​</a></h2><p>如果将etcd用作服务发现，每次服务注册和更新都可以看做一条新数据，日积月累，这些数据的量会导致etcd占用内存越来越大，直到etcd到达空间配额限制的时候，etcd的写入将会被静止，影响线上服务，定期删除历史记录就是避免这种情况</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"># 只保留一个小时的历史数据</span></span>
<span class="line"><span style="color:#e1e4e8;">$ etcd --auto-compaction-retention=1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"># 只保留一个小时的历史数据</span></span>
<span class="line"><span style="color:#24292e;">$ etcd --auto-compaction-retention=1</span></span></code></pre></div><h2 id="磁盘去碎片化" tabindex="-1">磁盘去碎片化 <a class="header-anchor" href="#磁盘去碎片化" aria-label="Permalink to &quot;磁盘去碎片化&quot;">​</a></h2><p><a href="https://coreos.com/etcd/docs/latest/op-guide/maintenance.html#defragmentation" target="_blank" rel="noreferrer">etcd官方</a>是说在进行compaction操作之后，旧的revision被压缩，会产生内部的碎片，内部碎片是指空闲状态的，能被后端使用但是仍然消耗存储空间的磁盘空间。去碎片化实际上是将存储空间还给文件系统</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">$ etcdctl defrag</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">$ etcdctl defrag</span></span></code></pre></div><h2 id="存储空间配额" tabindex="-1">存储空间配额 <a class="header-anchor" href="#存储空间配额" aria-label="Permalink to &quot;存储空间配额&quot;">​</a></h2><p>--quota-backend-bytes</p><p>存储空间配额可以理解为 ETCD 数据库大小，默认限制 2G（推荐最大 8G）。当数据写入耗尽存储空间时，ETCD 会引发整个集群范围的警告，该警告将会导致集群切换为维护模式，<strong>维护模式</strong> 仅接受键值读取和删除，不支持写入。</p><p>所以，在创建集群时候建议修改配额大小。但是这个配额值不宜过设置大，建议在主机内存的 <code>60% - 70%</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"># 显式配置配额为16MB</span></span>
<span class="line"><span style="color:#e1e4e8;">$ etcd --quota-backend-bytes=$((16*1024*1024))</span></span>
<span class="line"><span style="color:#e1e4e8;">$ ETCDCTL_API=3 etcdctl --write-out=table endpoint status</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"># 显式配置配额为16MB</span></span>
<span class="line"><span style="color:#24292e;">$ etcd --quota-backend-bytes=$((16*1024*1024))</span></span>
<span class="line"><span style="color:#24292e;">$ ETCDCTL_API=3 etcdctl --write-out=table endpoint status</span></span></code></pre></div><h3 id="_1-手动释放配额空间" tabindex="-1">1.手动释放配额空间 <a class="header-anchor" href="#_1-手动释放配额空间" aria-label="Permalink to &quot;1.手动释放配额空间&quot;">​</a></h3><ul><li>执行以下命令查看配额空间具体使用信息</li></ul><p>ETCDCTL_API=3 etcdctl --write-out=table endpoint status</p><h3 id="_2-获取当前的修订版本" tabindex="-1">2.获取当前的修订版本 <a class="header-anchor" href="#_2-获取当前的修订版本" aria-label="Permalink to &quot;2.获取当前的修订版本&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># rev=$(ETCDCTL_API=3 etcdctl --endpoints=:2379 endpoint status --write-out=&quot;json&quot; | egrep -o &#39;&quot;revision&quot;:[0-9]*&#39; | egrep -o &#39;[0-9].*&#39;)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 压缩所有旧的修订</span></span>
<span class="line"><span style="color:#E1E4E8;">ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">compact</span><span style="color:#E1E4E8;"> $rev</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 碎片整理，释放空间</span></span>
<span class="line"><span style="color:#E1E4E8;">ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">defrag</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#集群释放</span></span>
<span class="line"><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">defrag</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--cluster</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 解除警报（每个 ETCD 实例都要执行）</span></span>
<span class="line"><span style="color:#6A737D;">#通过执行etcdctl alarm list可以查看 etcd 的告警情况，如果存在告警，即使释放了 etcd 空间，etcd 也处于只读状态</span></span>
<span class="line"><span style="color:#E1E4E8;">ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">alarm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">disarm</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># rev=$(ETCDCTL_API=3 etcdctl --endpoints=:2379 endpoint status --write-out=&quot;json&quot; | egrep -o &#39;&quot;revision&quot;:[0-9]*&#39; | egrep -o &#39;[0-9].*&#39;)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 压缩所有旧的修订</span></span>
<span class="line"><span style="color:#24292E;">ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">compact</span><span style="color:#24292E;"> $rev</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 碎片整理，释放空间</span></span>
<span class="line"><span style="color:#24292E;">ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">defrag</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#集群释放</span></span>
<span class="line"><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">defrag</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--cluster</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 解除警报（每个 ETCD 实例都要执行）</span></span>
<span class="line"><span style="color:#6A737D;">#通过执行etcdctl alarm list可以查看 etcd 的告警情况，如果存在告警，即使释放了 etcd 空间，etcd 也处于只读状态</span></span>
<span class="line"><span style="color:#24292E;">ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">alarm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">disarm</span></span></code></pre></div><h3 id="_3-历史版本清理-v3" tabindex="-1">3.历史版本清理(v3) <a class="header-anchor" href="#_3-历史版本清理-v3" aria-label="Permalink to &quot;3.历史版本清理(v3)&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">--auto-compaction-mode</span></span>
<span class="line"><span style="color:#e1e4e8;">--auto-compaction-retention</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">--auto-compaction-mode</span></span>
<span class="line"><span style="color:#24292e;">--auto-compaction-retention</span></span></code></pre></div><p>ETCD 会存储多版本数据，随着写入的主键增加，历史版本将会越来越多，并且 ETCD 默认不会自动清理历史数据。数据达到 <code>--quota-backend-bytes</code> 设置的配额值时就无法写入数据，必须要压缩并清理历史数据才能继续写入</p><p>所以，为了避免配额空间耗尽的问题，在创建集群时候建议默认开启 <strong>历史版本清理</strong> 功能。</p><ul><li><p>3.3.0 之前的版本</p><p>3.3.0 之前的版本，只能按周期 <code>periodic</code> 来压缩。比如设置 <code>--auto-compaction-retention=72h</code>，那么就会每 72 小时进行一次数据压缩。</p></li><li><p>3.3.0 之后的版本</p><p>比如在 v3.3.0， v3.3.1 和 v3.3.2 中，可以通过 <code>--auto-compaction-mode</code> 设置压缩模式，可以选择 <code>revision</code> 或者 <code>periodic</code> 来压缩数据，默认为 <code>periodic</code></p></li></ul><h2 id="raft-日志保留" tabindex="-1">Raft 日志保留 <a class="header-anchor" href="#raft-日志保留" aria-label="Permalink to &quot;Raft 日志保留&quot;">​</a></h2><p><code>--snapshot-count</code> 指定有多少条事务（transaction）被提交时，触发快照保存到磁盘。在存盘之前，Raft 条目将一直保存在内存中。从 v3.2 版本开始，<code>--snapshot-count</code> 条数从 <code>10000</code> 改为 <code>100000</code>，因此这将占用很大一部分内存资源。</p><p>如果节点总内存资源不多，或者是单 etcd 实例运行，则可以把 <code>--snapshot-count</code> 适当的缩减，比如设置为 <code>--snapshot-count=50000</code></p><h2 id="客户端必须向-etcd-leader-发送请求吗" tabindex="-1">客户端必须向 etcd leader 发送请求吗? <a class="header-anchor" href="#客户端必须向-etcd-leader-发送请求吗" aria-label="Permalink to &quot;客户端必须向 etcd leader 发送请求吗?&quot;">​</a></h2><p>Raft is leader-based， leader 处理所有需要一致性的客户机请求。但客户端不需要知道哪个节点是 leader，所有发送给跟随者的一致性请求都会自动转发给 leader。不需要协商一致的请求(例如，序列化读取)可以由任何集群成员处理</p><h2 id="案例" tabindex="-1">案例： <a class="header-anchor" href="#案例" aria-label="Permalink to &quot;案例：&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#设置下启动大小</span></span>
<span class="line"><span style="color:#6A737D;"># set a very small 16MB quota</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--quota-backend-bytes=</span><span style="color:#9ECBFF;">$((</span><span style="color:#79B8FF;">16</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">1024</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">1024</span><span style="color:#9ECBFF;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#批量put</span></span>
<span class="line"><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> [ </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> ]; </span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">dd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">if=/dev/urandom</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bs=</span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">count=</span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">put</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">key</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">1048576</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bytes</span><span style="color:#E1E4E8;"> (1.0 </span><span style="color:#9ECBFF;">MB,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MiB</span><span style="color:#E1E4E8;">) copied, 0.0429034 s, 24.4 MB/s</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">&quot;level&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;warn&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;ts&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;2021-06-17T22:54:59.718-0400&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;caller&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;clientv3/retry_interceptor.go:62&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;msg&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;retrying of unary invoker failed&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;target&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;endpoint://client-7f280317-0920-4194-ac3f-bbdc9aa05467/127.0.0.1:2379&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;attempt&quot;</span><span style="color:#B392F0;">:0,</span><span style="color:#B392F0;">&quot;error&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;rpc error: code = ResourceExhausted desc = etcdserver: mvcc: database space exceeded&quot;</span><span style="color:#B392F0;">}</span></span>
<span class="line"><span style="color:#B392F0;">Error:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcdserver:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mvcc:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">space</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exceeded</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@localhost etcd_data]#  etcdctl --write-out=table endpoint status</span></span>
<span class="line"><span style="color:#B392F0;">+----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------------------------------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">ENDPOINT</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">ID</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">VERSION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">DB</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">SIZE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">LEADER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">LEARNER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">RAFT</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">TERM</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">RAFT</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">INDEX</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">RAFT</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">APPLIED</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">INDEX</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">             </span><span style="color:#B392F0;">ERRORS</span><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------------------------------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">127.0.0.1:2379</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">8e9e05c52164694d</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">3.4.16</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">2.1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GB</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">         </span><span style="color:#B392F0;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">       </span><span style="color:#B392F0;">1766</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">               </span><span style="color:#B392F0;">1766</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">memberID:10276657743932975437</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">                  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">                 </span><span style="color:#B392F0;">alarm:NOSPACE</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------------------------------+</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看报警</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@localhost etcd_data]# etcdctl alarm list</span></span>
<span class="line"><span style="color:#B392F0;">memberID:10276657743932975437</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">alarm:NOSPACE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#获取历史版本信息</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@localhost etcd_data]# etcdctl --endpoints=:2379 endpoint status --write-out=</span><span style="color:#9ECBFF;">&quot;json&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">egrep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&quot;revision&quot;:[0-9]*&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">egrep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;[0-9].*&#39;</span></span>
<span class="line"><span style="color:#B392F0;">1760</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#压缩</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@localhost etcd_data]# etcdctl compact 1760</span></span>
<span class="line"><span style="color:#B392F0;">compacted</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">revision</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1760</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#清理碎片</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@localhost etcd_data]# etcdctl defrag</span></span>
<span class="line"><span style="color:#B392F0;">Finished</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">defragmenting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">member[</span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1:2379]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#关闭报警，之后才能正常写入</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@localhost etcd_data]#etcdctl alarm disarm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#测试通过</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ETCDCTL_API=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">put</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">newkey</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">123</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#设置下启动大小</span></span>
<span class="line"><span style="color:#6A737D;"># set a very small 16MB quota</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--quota-backend-bytes=</span><span style="color:#032F62;">$((</span><span style="color:#005CC5;">16</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">1024</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">1024</span><span style="color:#032F62;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#批量put</span></span>
<span class="line"><span style="color:#D73A49;">while</span><span style="color:#24292E;"> [ </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> ]; </span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">dd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">if=/dev/urandom</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bs=</span><span style="color:#005CC5;">1024</span><span style="color:#24292E;"> </span><span style="color:#032F62;">count=</span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">put</span><span style="color:#24292E;"> </span><span style="color:#032F62;">key</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">1048576</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bytes</span><span style="color:#24292E;"> (1.0 </span><span style="color:#032F62;">MB,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1.0</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MiB</span><span style="color:#24292E;">) copied, 0.0429034 s, 24.4 MB/s</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#6F42C1;">&quot;level&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;warn&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;ts&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;2021-06-17T22:54:59.718-0400&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;caller&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;clientv3/retry_interceptor.go:62&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;msg&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;retrying of unary invoker failed&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;target&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;endpoint://client-7f280317-0920-4194-ac3f-bbdc9aa05467/127.0.0.1:2379&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;attempt&quot;</span><span style="color:#6F42C1;">:0,</span><span style="color:#6F42C1;">&quot;error&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;rpc error: code = ResourceExhausted desc = etcdserver: mvcc: database space exceeded&quot;</span><span style="color:#6F42C1;">}</span></span>
<span class="line"><span style="color:#6F42C1;">Error:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcdserver:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mvcc:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">space</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exceeded</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@localhost etcd_data]#  etcdctl --write-out=table endpoint status</span></span>
<span class="line"><span style="color:#6F42C1;">+----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------------------------------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#6F42C1;">ENDPOINT</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">        </span><span style="color:#6F42C1;">ID</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">VERSION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DB</span><span style="color:#24292E;"> </span><span style="color:#032F62;">SIZE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">LEADER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">LEARNER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RAFT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">TERM</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RAFT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">INDEX</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RAFT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">APPLIED</span><span style="color:#24292E;"> </span><span style="color:#032F62;">INDEX</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">             </span><span style="color:#6F42C1;">ERRORS</span><span style="color:#24292E;">             </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------------------------------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">127.0.0.1:2379</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">8e9e05c52164694d</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">3.4.16</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">2.1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GB</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">true</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">false</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">         </span><span style="color:#6F42C1;">3</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">       </span><span style="color:#6F42C1;">1766</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">               </span><span style="color:#6F42C1;">1766</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">memberID:10276657743932975437</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;">                </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">                  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">                    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">                 </span><span style="color:#6F42C1;">alarm:NOSPACE</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------------------------------+</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看报警</span></span>
<span class="line"><span style="color:#24292E;">[root@localhost etcd_data]# etcdctl alarm list</span></span>
<span class="line"><span style="color:#6F42C1;">memberID:10276657743932975437</span><span style="color:#24292E;"> </span><span style="color:#032F62;">alarm:NOSPACE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#获取历史版本信息</span></span>
<span class="line"><span style="color:#24292E;">[root@localhost etcd_data]# etcdctl --endpoints=:2379 endpoint status --write-out=</span><span style="color:#032F62;">&quot;json&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">egrep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&quot;revision&quot;:[0-9]*&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">egrep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;[0-9].*&#39;</span></span>
<span class="line"><span style="color:#6F42C1;">1760</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#压缩</span></span>
<span class="line"><span style="color:#24292E;">[root@localhost etcd_data]# etcdctl compact 1760</span></span>
<span class="line"><span style="color:#6F42C1;">compacted</span><span style="color:#24292E;"> </span><span style="color:#032F62;">revision</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1760</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#清理碎片</span></span>
<span class="line"><span style="color:#24292E;">[root@localhost etcd_data]# etcdctl defrag</span></span>
<span class="line"><span style="color:#6F42C1;">Finished</span><span style="color:#24292E;"> </span><span style="color:#032F62;">defragmenting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">member[</span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1:2379]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#关闭报警，之后才能正常写入</span></span>
<span class="line"><span style="color:#24292E;">[root@localhost etcd_data]#etcdctl alarm disarm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#测试通过</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ETCDCTL_API=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">put</span><span style="color:#24292E;"> </span><span style="color:#032F62;">newkey</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">123</span></span></code></pre></div><h1 id="_6-调优" tabindex="-1">6.调优 <a class="header-anchor" href="#_6-调优" aria-label="Permalink to &quot;6.调优&quot;">​</a></h1><h2 id="网络" tabindex="-1">网络 <a class="header-anchor" href="#网络" aria-label="Permalink to &quot;网络&quot;">​</a></h2><p>跨数据中心时，需要调整心跳间隔和选举超时时间 默认的心跳时间是100ms，建议为round trip时间 默认选举超时是1000ms</p><p>--heartbeat-interval 心跳间隔，即 leader 通知member 并保证自己 leader 地位的心跳，默认是 100ms，这个应该设置为节点间的 RTT 时间</p><p>--election-timeout 选举超时时间，即 member 多久没有收到 leader 的回应，就开始自己竞选 leader，默认超时时间为 1s</p><h2 id="磁盘-io" tabindex="-1">磁盘 IO <a class="header-anchor" href="#磁盘-io" aria-label="Permalink to &quot;磁盘 IO&quot;">​</a></h2><p>磁盘 IO 也严重影响 etcd 的稳定性， etcd需要持久化数据，对磁盘速度很敏感，强烈建议对 ETCD 的数据挂 SSD。</p><p>另外，要确认机器上没有其他高 IO 操作，否则会影响 etcd 的 fsync，导致 etcd 丢失心跳，leader更换等。一般磁盘有问题时，报错的关键字类似于：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">took too long (1.483848046s) to execute</span></span>
<span class="line"><span style="color:#e1e4e8;"> etcdserver: failed to send out heartbeat on time</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">took too long (1.483848046s) to execute</span></span>
<span class="line"><span style="color:#24292e;"> etcdserver: failed to send out heartbeat on time</span></span></code></pre></div><h2 id="快照" tabindex="-1">快照 <a class="header-anchor" href="#快照" aria-label="Permalink to &quot;快照&quot;">​</a></h2><p>etcd的存储分为内存存储和持久化（硬盘）存储两部分，内存中的存储除了顺序化的记录下所有用户对节点数据变更的记录外，还会对用户数据进行索引、建堆等方便查询的操作。而持久化则使用预写式日志（WAL：Write Ahead Log）进行记录存储。</p><p>在WAL的体系中，所有的数据在提交之前都会进行日志记录。在etcd的持久化存储目录中，有两个子目录。一个是WAL，存储着所有事务的变化记录；另一个则是snapshot，用于存储某一个时刻etcd所有目录的数据。通过WAL和snapshot相结合的方式，etcd可以有效的进行数据存储和节点故障恢复等操作。</p><p>既然有了WAL实时存储了所有的变更，为什么还需要snapshot呢？随着使用量的增加，WAL存储的数据会暴增，为了防止磁盘很快就爆满，etcd默认每10000条记录做一次snapshot，经过snapshot以后的WAL文件就可以删除。而通过API可以查询的历史etcd操作默认为1000条</p><h2 id="客户端优化" tabindex="-1">客户端优化 <a class="header-anchor" href="#客户端优化" aria-label="Permalink to &quot;客户端优化&quot;">​</a></h2><p>etcd 的客户端应该避免一些频繁操作或者大对象操作，如：</p><ul><li>put 时避免大 value，精简再精简（例如 k8s 中 crd 使用）</li><li>避免创建频繁变化的 kv（例如 k8s 中 node 信息汇报），如 node-lease</li><li>避免创建大量 lease，尽量选择复用（例如 k8s 中 event 数据管理）</li><li>合理利用 apiserver 中的缓存，避免大量请求打到 etcd上，如集群异常恢复后大量 pod同步</li></ul><h1 id="_7-leader" tabindex="-1">7.leader <a class="header-anchor" href="#_7-leader" aria-label="Permalink to &quot;7.leader&quot;">​</a></h1><p>learner 是 etcd 3.4 版本中增加的新角色，类似于 zookeeper 的 observer, 不参与 raft 投票选举。通过这个新角色的引入，降低了加入新节点时给老集群的额外压力，增强了集群的稳定性。除此之外还可以使用它作为集群的热备或服务一些读请求。</p><p>举例，如果 etcd集群需要加入一个新节点，新加入的 etcd 成员因为没有任何数据，因此需要从 leader 那里同步数据，直到赶上领导者的日志为止。这样就会导致 leader 的网络过载，导致 leader 和 member 之间的心跳可能阻塞。然后就开始了新的leader选举，也就是说，具有新成员的集群更容易受到领导人选举的影响。领导者的选举以及随后向新成员的更新都容易导致一段时间的群集不可用，这种是不符合预期，风险也是很大的。</p><p>因此为了解决这个问题，raft 4.2.1 论文中介绍了一种新的节点角色：Learner。加入集群的节点不参与投票选举，只接收 leader 的 replication message，直到与 leader 保持同步为止。</p><p>learner 在网络分区等场景下的处理，可以详细参考：<a href="https://etcd.io/docs/v3.3.12/learning/learner/" target="_blank" rel="noreferrer">https://etcd.io/docs/v3.3.12/learning/learner/</a></p><h1 id="_7-扩容集群" tabindex="-1">7.扩容集群 <a class="header-anchor" href="#_7-扩容集群" aria-label="Permalink to &quot;7.扩容集群&quot;">​</a></h1><p>如果该节点曾属于集群成员，那么删除etcd data目录，重启即可。可以通过以下方式查看是否是集群成员</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">ETCDCTL_API=2 etcdctl member list</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">ETCDCTL_API=2 etcdctl member list</span></span></code></pre></div><p>如果该节点是一个新的节点，那么启动etcd时，</p><ol><li>先在集群节点上执行 <code>etcdctl member add new_node --peer-urls=xxx</code></li><li>设置环境变量<code>ETCD_INITIAL_CLUSTER</code>和<code>ETCD_INITIAL_CLUSTER_STATE</code>：分别指明了etcd的集群地址和集群状态。</li><li>启动这个new node</li></ol><h1 id="_8-常见问题" tabindex="-1">8.常见问题 <a class="header-anchor" href="#_8-常见问题" aria-label="Permalink to &quot;8.常见问题&quot;">​</a></h1><h3 id="如何选择etcd集群的节点数目" tabindex="-1">如何选择etcd集群的节点数目？ <a class="header-anchor" href="#如何选择etcd集群的节点数目" aria-label="Permalink to &quot;如何选择etcd集群的节点数目？&quot;">​</a></h3><p>首先要理解为什么需要增加节点数目？原因大致为：</p><ol><li><strong>提高etcd集群的可用性</strong>：3个节点能最大容忍一个节点不可用，5个节点则可以最大容忍2个节点不可用，节点数增加从概率角度上确实能提高集群的可用性。</li><li><strong>提高读的吞吐</strong>：集群任何一个节点都能提供读的服务，增加节点类似于横向扩展了。</li></ol><p><strong>注意节点数并不是越多越好</strong>，因为etcd的一致性机制，每次写操作都需要同步到每个节点，节点数越多会降低写操作的吞吐。</p><p>在读写均存在的场景下，建议etcd集群有3个节点，如果读远大于写的场景下，可以考虑增加到5个节点</p><h3 id="etcd内存、snapshot大小异常" tabindex="-1">etcd内存、snapshot大小异常 <a class="header-anchor" href="#etcd内存、snapshot大小异常" aria-label="Permalink to &quot;etcd内存、snapshot大小异常&quot;">​</a></h3><p>大致原因有以下几点：</p><ol><li>etcd的key/value具有版本功能，频繁更新key/value会使得版本增加过快。</li><li>raft log的太多了</li><li>golang gc问题</li></ol><p>解决办法有：</p><ol><li>开启自动compact：启动参数增加<code>--auto-compaction-retention=168</code></li><li>设置存储quota上限: 启动参数增加<code>--quota-backend-bytes=8589934592</code></li><li>限制raft log：调小<code>--snapshot-count=50000</code></li></ol><p>3.4开始raft log默认是10w</p><h3 id="etcd节点挂掉时间太长-重启失败咋办" tabindex="-1">etcd节点挂掉时间太长，重启失败咋办 <a class="header-anchor" href="#etcd节点挂掉时间太长-重启失败咋办" aria-label="Permalink to &quot;etcd节点挂掉时间太长，重启失败咋办&quot;">​</a></h3><p>集群没挂掉的情况下，直接删除data目录，重新加入集群处理</p><h3 id="mvcc-database-space-exceeded-报错如何处理" tabindex="-1">mvcc: database space exceeded 报错如何处理 <a class="header-anchor" href="#mvcc-database-space-exceeded-报错如何处理" aria-label="Permalink to &quot;mvcc: database space exceeded 报错如何处理&quot;">​</a></h3><p>etcd会保存key的历史版本，如果没有定期compact的话，就会耗尽etcd的存储空间。如果etcd的剩余空间很小的时候，就会报警、报错：<code>mvcc: database space exceeded.</code> 解决办法：</p><ol><li>compact etcd历史</li><li>清理每个etcd endpoint</li><li>消除报警</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">recv</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">\`</span><span style="color:#E1E4E8;">ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">etcdctl</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">--endpoints=http://</span><span style="color:#E1E4E8;">$addr</span><span style="color:#9ECBFF;"> endpoint status </span><span style="color:#79B8FF;">--write-out=</span><span style="color:#9ECBFF;">&quot;json&quot; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">egrep</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#9ECBFF;"> &#39;&quot;revision&quot;:[0-9]*&#39; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">egrep</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#9ECBFF;"> &#39;[0-9].*&#39;\`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--endpoints=http://</span><span style="color:#E1E4E8;">$addr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">compact</span><span style="color:#E1E4E8;"> $recv</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--endpoints=http://</span><span style="color:#E1E4E8;">$addr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">defrag</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">alarm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">disarm</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">recv</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">\`</span><span style="color:#24292E;">ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">etcdctl</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">--endpoints=http://</span><span style="color:#24292E;">$addr</span><span style="color:#032F62;"> endpoint status </span><span style="color:#005CC5;">--write-out=</span><span style="color:#032F62;">&quot;json&quot; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">egrep</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-o</span><span style="color:#032F62;"> &#39;&quot;revision&quot;:[0-9]*&#39; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">egrep</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-o</span><span style="color:#032F62;"> &#39;[0-9].*&#39;\`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--endpoints=http://</span><span style="color:#24292E;">$addr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">compact</span><span style="color:#24292E;"> $recv</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--endpoints=http://</span><span style="color:#24292E;">$addr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">defrag</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">alarm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">disarm</span></span></code></pre></div><p><a href="https://hiddenpps.blog.csdn.net/article/details/113153693" target="_blank" rel="noreferrer">https://hiddenpps.blog.csdn.net/article/details/113153693</a></p>`,120),o=[p];function t(c,r,y,i,d,E){return a(),n("div",null,o)}const u=s(e,[["render",t]]);export{F as __pageData,u as default};
