import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const C=JSON.parse('{"title":"1.","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/monitor/prometheus/6-基于consul服务发现.md","filePath":"guide/container/k8s/monitor/prometheus/6-基于consul服务发现.md","lastUpdated":1720533756000}'),p={name:"guide/container/k8s/monitor/prometheus/6-基于consul服务发现.md"},o=l(`<img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406302148734.png" alt="image-20240630214729095" style="zoom:80%;"><p><a href="https://developer.hashicorp.com/consul/tutorials/get-started-kubernetes/kubernetes-gs-deploy?variants=consul-deploy%3Aself-managed" target="_blank" rel="noreferrer">官当</a></p><h1 id="_1" tabindex="-1">1. <a class="header-anchor" href="#_1" aria-label="Permalink to &quot;1.&quot;">​</a></h1><h2 id="工作原理" tabindex="-1">工作原理 <a class="header-anchor" href="#工作原理" aria-label="Permalink to &quot;工作原理&quot;">​</a></h2><p>1、Prometheus通过Consul APl查询Consul的KV存储中保存的配置信息，然后从中获取关于服务的元数据；</p><p>2、Prometheus使用这些信息来构造目标服务的URL，并将其添加到服务发现的目标列表中。</p><p>3、当服务被注销或不可用时，PrometheQs将自动从其目标列表中删除该服务。</p><h1 id="_2-安装" tabindex="-1">2. 安装 <a class="header-anchor" href="#_2-安装" aria-label="Permalink to &quot;2. 安装&quot;">​</a></h1><h2 id="_2-1-单节点" tabindex="-1">2.1 单节点 <a class="header-anchor" href="#_2-1-单节点" aria-label="Permalink to &quot;2.1 单节点&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-id</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-expose=[8300,8301,8302,8500,8600]</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">always-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18300</span><span style="color:#9ECBFF;">:8300</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18301</span><span style="color:#9ECBFF;">:8301</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18302</span><span style="color:#9ECBFF;">:8302</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18500</span><span style="color:#9ECBFF;">:8500</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p18600:8600</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Server1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;cONSUL_LOCAL_CONFIG={&quot;skip_leave_on_interrupt&quot;: true}&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/consul:v1.15.4</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">agent</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-server</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-bootstrap-expect=l</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-node=serverl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-bind=0.0.0.0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-client=0.0.0.0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-ui</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-datacenterdc1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-id</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-expose=[8300,8301,8302,8500,8600]</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">--restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">always-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18300</span><span style="color:#032F62;">:8300</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18301</span><span style="color:#032F62;">:8301</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18302</span><span style="color:#032F62;">:8302</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18500</span><span style="color:#032F62;">:8500</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p18600:8600</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Server1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;cONSUL_LOCAL_CONFIG={&quot;skip_leave_on_interrupt&quot;: true}&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/consul:v1.15.4</span><span style="color:#24292E;"> </span><span style="color:#032F62;">agent</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-server</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-bootstrap-expect=l</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-node=serverl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-bind=0.0.0.0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-client=0.0.0.0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-ui</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-datacenterdc1</span></span></code></pre></div><p>参数说明:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">-expose：暴露出出来的端口，即consul启动所需的端口：8300,8301,8302,8500,8600</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">--restart：always表示容器挂了就自动重启</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">-p：建立宿主机与容器的端口映射</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">--name：容器名称</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">-e：环境变量，这里用于对consul进行配置</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">agent：容器中执行的命令，各参数含义：</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">-server：表示节点是server类型</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">-bootstrap-expect：表示集群中有几个server节点后开始选举leader，既然是单节点集群，那自然就是1了</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">-node：节点名称</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">-bind：集群内部通信地址，默认是0.0.0.0</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">-client：客户端地址，默认是127.0.0.1</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">-ui：启用consul的web页面管理</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">-datacenter：数据中心</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">-expose：暴露出出来的端口，即consul启动所需的端口：8300,8301,8302,8500,8600</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">--restart：always表示容器挂了就自动重启</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">-p：建立宿主机与容器的端口映射</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">--name：容器名称</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">-e：环境变量，这里用于对consul进行配置</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">agent：容器中执行的命令，各参数含义：</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">-server：表示节点是server类型</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">-bootstrap-expect：表示集群中有几个server节点后开始选举leader，既然是单节点集群，那自然就是1了</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">-node：节点名称</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">-bind：集群内部通信地址，默认是0.0.0.0</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">-client：客户端地址，默认是127.0.0.1</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">-ui：启用consul的web页面管理</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">-datacenter：数据中心</span></span></code></pre></div><h2 id="_2-2-基于k8s集群安装" tabindex="-1">2.2 基于k8s集群安装 <a class="header-anchor" href="#_2-2-基于k8s集群安装" aria-label="Permalink to &quot;2.2 基于k8s集群安装&quot;">​</a></h2><h3 id="_2-2-1-创建rabc" tabindex="-1">2.2.1 创建rabc <a class="header-anchor" href="#_2-2-1-创建rabc" aria-label="Permalink to &quot;2.2.1 创建rabc&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master consul</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat 1.consul-rabc.yaml</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ServiceAccount</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul-server</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRole</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">pods</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">get</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">list</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRoleBinding</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#85E89D;">roleRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">apiGroup</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRole</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#85E89D;">subjects</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ServiceAccount</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul-server</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master consul</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat 1.consul-rabc.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ServiceAccount</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul-server</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRole</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">pods</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">get</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">list</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRoleBinding</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#22863A;">roleRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRole</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#22863A;">subjects</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ServiceAccount</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul-server</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span></code></pre></div><h3 id="_2-2-2-创建存储" tabindex="-1">2.2.2 创建存储 <a class="header-anchor" href="#_2-2-2-创建存储" aria-label="Permalink to &quot;2.2.2 创建存储&quot;">​</a></h3><p>采用nfs动态存储</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master consul</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat 2.consul-storage.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul-data-pvc</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">accessModes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">ReadWriteMany</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">storageClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;nfs-provisioner-storage&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">requests</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">storage</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">5Gi</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master consul</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat 2.consul-storage.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul-data-pvc</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">accessModes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">ReadWriteMany</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">storageClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;nfs-provisioner-storage&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">storage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">5Gi</span></span></code></pre></div><h3 id="_2-2-3-创建sts服务" tabindex="-1">2.2.3 创建sts服务 <a class="header-anchor" href="#_2-2-3-创建sts服务" aria-label="Permalink to &quot;2.2.3 创建sts服务&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master consul</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat 3.consul-sts.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">StatefulSet</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">serviceName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">affinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">podAntiAffinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">labelSelector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                  - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">k8s-app</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                      - </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">topologyKey</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes.io/hostname</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">terminationGracePeriodSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">#serviceAccountName: consul-server</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">#hostNetwork: true</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">securityContext</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">fsGroup</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1000</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/consul:v1.15.4</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">imagePullPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8500</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ui-port</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8400</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">alt-port</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">53</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">udp-port</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8443</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">https-port</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http-port</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8301</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">serflan</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8302</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">serfwan</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8600</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consuldns</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8300</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">server</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">env</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">PODIP</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">valueFrom</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">fieldRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">fieldPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">status.podIP</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NAMESPACE</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">valueFrom</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">fieldRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">fieldPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metadata.namespace</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">PODNAME</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">valueFrom</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">fieldRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">fieldPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metadata.name</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">args</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">&quot;agent&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">&quot;-server&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">&quot;-bootstrap-expect=3&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">&quot;-ui&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">&quot;-config-file=/consul/config&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">&quot;-data-dir=/consul/data&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">&quot;-log-file=/consul/log&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">&quot;-bind=0.0.0.0&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">&quot;-client=0.0.0.0&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">&quot;-advertise=$(PODIP)&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">&quot;-retry-join=consul-0.consul.$(NAMESPACE).svc.cluster.local&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">&quot;-retry-join=consul-1.consul.$(NAMESPACE).svc.cluster.local&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">&quot;-retry-join=consul-2.consul.$(NAMESPACE).svc.cluster.local&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">&quot;-domain=cluster.local&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">&quot;-disable-host-node-id&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">limits</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;200m&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;512Mi&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">requests</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;100m&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;128Mi&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">lifecycle</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">preStop</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">exec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              - </span><span style="color:#9ECBFF;">/bin/sh</span></span>
<span class="line"><span style="color:#E1E4E8;">              - </span><span style="color:#9ECBFF;">-c</span></span>
<span class="line"><span style="color:#E1E4E8;">              - </span><span style="color:#9ECBFF;">consul leave</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">readinessProbe</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">exec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              - </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#E1E4E8;">              - </span><span style="color:#9ECBFF;">members</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">failureThreshold</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">initialDelaySeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">periodSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">successThreshold</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">timeoutSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul-data</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/consul/data</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">subPathExpr</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">data/$(PODNAME)</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul-data</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/consul/config</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">subPathExpr</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">config/$(PODNAME)</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul-data</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">persistentVolumeClaim</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">claimName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul-data-pvc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master consul</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat 3.consul-sts.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">StatefulSet</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">serviceName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">affinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">podAntiAffinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">labelSelector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                  - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">k8s-app</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                      - </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">topologyKey</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes.io/hostname</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">terminationGracePeriodSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">#serviceAccountName: consul-server</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">#hostNetwork: true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">securityContext</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">fsGroup</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1000</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/consul:v1.15.4</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">imagePullPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8500</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ui-port</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8400</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">alt-port</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">53</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">udp-port</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8443</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">https-port</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http-port</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8301</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">serflan</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8302</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">serfwan</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8600</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consuldns</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8300</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">server</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">env</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">PODIP</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">valueFrom</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">fieldRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">fieldPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">status.podIP</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NAMESPACE</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">valueFrom</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">fieldRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">fieldPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metadata.namespace</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">PODNAME</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">valueFrom</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">fieldRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">fieldPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metadata.name</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">args</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">&quot;agent&quot;</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">&quot;-server&quot;</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">&quot;-bootstrap-expect=3&quot;</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">&quot;-ui&quot;</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">&quot;-config-file=/consul/config&quot;</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">&quot;-data-dir=/consul/data&quot;</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">&quot;-log-file=/consul/log&quot;</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">&quot;-bind=0.0.0.0&quot;</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">&quot;-client=0.0.0.0&quot;</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">&quot;-advertise=$(PODIP)&quot;</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">&quot;-retry-join=consul-0.consul.$(NAMESPACE).svc.cluster.local&quot;</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">&quot;-retry-join=consul-1.consul.$(NAMESPACE).svc.cluster.local&quot;</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">&quot;-retry-join=consul-2.consul.$(NAMESPACE).svc.cluster.local&quot;</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">&quot;-domain=cluster.local&quot;</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">&quot;-disable-host-node-id&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">limits</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;200m&quot;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;512Mi&quot;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;100m&quot;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;128Mi&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">lifecycle</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">preStop</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">exec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">command</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              - </span><span style="color:#032F62;">/bin/sh</span></span>
<span class="line"><span style="color:#24292E;">              - </span><span style="color:#032F62;">-c</span></span>
<span class="line"><span style="color:#24292E;">              - </span><span style="color:#032F62;">consul leave</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">readinessProbe</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">exec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">command</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              - </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#24292E;">              - </span><span style="color:#032F62;">members</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">failureThreshold</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">initialDelaySeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">periodSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">successThreshold</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">timeoutSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul-data</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/consul/data</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">subPathExpr</span><span style="color:#24292E;">: </span><span style="color:#032F62;">data/$(PODNAME)</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul-data</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/consul/config</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">subPathExpr</span><span style="color:#24292E;">: </span><span style="color:#032F62;">config/$(PODNAME)</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul-data</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">persistentVolumeClaim</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">claimName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul-data-pvc</span></span></code></pre></div><h3 id="_2-2-4-创建svc" tabindex="-1">2.2.4 创建svc <a class="header-anchor" href="#_2-2-4-创建svc" aria-label="Permalink to &quot;2.2.4 创建svc&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master consul</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat 4.consul-svc.yaml</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8500</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8500</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">https</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8443</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8443</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rpc</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8400</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8400</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">serflan-tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8301</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8301</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">serflan-udp</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">UDP</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8301</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8301</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">serfwan-tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8302</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8302</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">serfwan-udp</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">UDP</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8302</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8302</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">server</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8300</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8300</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consuldns</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8600</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8600</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">clusterIP</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul-dns</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dns-tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">53</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dns-tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dns-udp</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">UDP</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">53</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dns-udp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul-ui</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8500</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master consul</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat 4.consul-svc.yaml</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8500</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8500</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">https</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8443</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8443</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rpc</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8400</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8400</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">serflan-tcp</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8301</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8301</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">serflan-udp</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">UDP</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8301</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8301</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">serfwan-tcp</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8302</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8302</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">serfwan-udp</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">UDP</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8302</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8302</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">server</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8300</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8300</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consuldns</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8600</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8600</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">clusterIP</span><span style="color:#24292E;">: </span><span style="color:#032F62;">None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul-dns</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dns-tcp</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">53</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dns-tcp</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dns-udp</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">UDP</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">53</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dns-udp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul-ui</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8500</span></span></code></pre></div><h3 id="_2-2-4-创建ingress" tabindex="-1">2.2.4 创建ingress <a class="header-anchor" href="#_2-2-4-创建ingress" aria-label="Permalink to &quot;2.2.4 创建ingress&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master consul</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat 5.consul-ingress.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul-ingress</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul.ikubernetes.net</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8500</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master consul</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat 5.consul-ingress.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul-ingress</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul.ikubernetes.net</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8500</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/</span></span></code></pre></div><ul><li>查看consul成员</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master prometheus]# kubectl exec -n monitor consul-0 -- consul members</span></span>
<span class="line"><span style="color:#B392F0;">Node</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">Address</span><span style="color:#E1E4E8;">             </span><span style="color:#9ECBFF;">Status</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Type</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Build</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Protocol</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">DC</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Partition</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Segment</span></span>
<span class="line"><span style="color:#B392F0;">consul-0</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">172.30</span><span style="color:#9ECBFF;">.0.179:8301</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">alive</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">1.15</span><span style="color:#9ECBFF;">.4</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">dc1</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">default</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">al</span><span style="color:#E1E4E8;">l</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">consul-1</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">172.23</span><span style="color:#9ECBFF;">.127.73:8301</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">alive</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">1.15</span><span style="color:#9ECBFF;">.4</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">dc1</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">default</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">al</span><span style="color:#E1E4E8;">l</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">consul-2</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">172.17</span><span style="color:#9ECBFF;">.74.93:8301</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">alive</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">1.15</span><span style="color:#9ECBFF;">.4</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">dc1</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">default</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">al</span><span style="color:#E1E4E8;">l</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master prometheus]# kubectl exec -n monitor consul-0 -- consul members</span></span>
<span class="line"><span style="color:#6F42C1;">Node</span><span style="color:#24292E;">      </span><span style="color:#032F62;">Address</span><span style="color:#24292E;">             </span><span style="color:#032F62;">Status</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Type</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Build</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Protocol</span><span style="color:#24292E;">  </span><span style="color:#032F62;">DC</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Partition</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Segment</span></span>
<span class="line"><span style="color:#6F42C1;">consul-0</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">172.30</span><span style="color:#032F62;">.0.179:8301</span><span style="color:#24292E;">   </span><span style="color:#032F62;">alive</span><span style="color:#24292E;">   </span><span style="color:#032F62;">server</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">1.15</span><span style="color:#032F62;">.4</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">         </span><span style="color:#032F62;">dc1</span><span style="color:#24292E;">  </span><span style="color:#032F62;">default</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">al</span><span style="color:#24292E;">l</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">consul-1</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">172.23</span><span style="color:#032F62;">.127.73:8301</span><span style="color:#24292E;">  </span><span style="color:#032F62;">alive</span><span style="color:#24292E;">   </span><span style="color:#032F62;">server</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">1.15</span><span style="color:#032F62;">.4</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">         </span><span style="color:#032F62;">dc1</span><span style="color:#24292E;">  </span><span style="color:#032F62;">default</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">al</span><span style="color:#24292E;">l</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">consul-2</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">172.17</span><span style="color:#032F62;">.74.93:8301</span><span style="color:#24292E;">   </span><span style="color:#032F62;">alive</span><span style="color:#24292E;">   </span><span style="color:#032F62;">server</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">1.15</span><span style="color:#032F62;">.4</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">         </span><span style="color:#032F62;">dc1</span><span style="color:#24292E;">  </span><span style="color:#032F62;">default</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">al</span><span style="color:#24292E;">l</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><ul><li>验证</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> kubectl apply -f -</span></span>
<span class="line"><span style="color:#9ECBFF;">apiVersion: v1</span></span>
<span class="line"><span style="color:#9ECBFF;">kind: Pod</span></span>
<span class="line"><span style="color:#9ECBFF;">metadata:</span></span>
<span class="line"><span style="color:#9ECBFF;">  name: busybox</span></span>
<span class="line"><span style="color:#9ECBFF;">  namespace: default</span></span>
<span class="line"><span style="color:#9ECBFF;">spec:</span></span>
<span class="line"><span style="color:#9ECBFF;">  containers:</span></span>
<span class="line"><span style="color:#9ECBFF;">  - name: busybox</span></span>
<span class="line"><span style="color:#9ECBFF;">    image: busybox:1.28.3</span></span>
<span class="line"><span style="color:#9ECBFF;">    command:</span></span>
<span class="line"><span style="color:#9ECBFF;">      - sleep</span></span>
<span class="line"><span style="color:#9ECBFF;">      - &quot;3600&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">    imagePullPolicy: IfNotPresent</span></span>
<span class="line"><span style="color:#9ECBFF;">  restartPolicy: Always</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master consul]# kubectl exec -ti busybox -- nslookup consul.monitor.svc.cluster.local</span></span>
<span class="line"><span style="color:#B392F0;">Server:</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.0.10</span></span>
<span class="line"><span style="color:#B392F0;">Address</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.0.10</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Name:</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">consul.monitor.svc.cluster.local</span></span>
<span class="line"><span style="color:#B392F0;">Address</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.17</span><span style="color:#9ECBFF;">.74.87</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">consul-2.consul.monitor.svc.cluster.local</span></span>
<span class="line"><span style="color:#B392F0;">Address</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.30</span><span style="color:#9ECBFF;">.0.147</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172</span><span style="color:#9ECBFF;">-30-0-147.consul-dns.monitor.svc.cluster.local</span></span>
<span class="line"><span style="color:#B392F0;">Address</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.23</span><span style="color:#9ECBFF;">.127.73</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">consul-1.consul.monitor.svc.cluster.local</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> kubectl apply -f -</span></span>
<span class="line"><span style="color:#032F62;">apiVersion: v1</span></span>
<span class="line"><span style="color:#032F62;">kind: Pod</span></span>
<span class="line"><span style="color:#032F62;">metadata:</span></span>
<span class="line"><span style="color:#032F62;">  name: busybox</span></span>
<span class="line"><span style="color:#032F62;">  namespace: default</span></span>
<span class="line"><span style="color:#032F62;">spec:</span></span>
<span class="line"><span style="color:#032F62;">  containers:</span></span>
<span class="line"><span style="color:#032F62;">  - name: busybox</span></span>
<span class="line"><span style="color:#032F62;">    image: busybox:1.28.3</span></span>
<span class="line"><span style="color:#032F62;">    command:</span></span>
<span class="line"><span style="color:#032F62;">      - sleep</span></span>
<span class="line"><span style="color:#032F62;">      - &quot;3600&quot;</span></span>
<span class="line"><span style="color:#032F62;">    imagePullPolicy: IfNotPresent</span></span>
<span class="line"><span style="color:#032F62;">  restartPolicy: Always</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master consul]# kubectl exec -ti busybox -- nslookup consul.monitor.svc.cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">Server:</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.0.10</span></span>
<span class="line"><span style="color:#6F42C1;">Address</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.0.10</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">      </span><span style="color:#032F62;">consul.monitor.svc.cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">Address</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.17</span><span style="color:#032F62;">.74.87</span><span style="color:#24292E;"> </span><span style="color:#032F62;">consul-2.consul.monitor.svc.cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">Address</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.30</span><span style="color:#032F62;">.0.147</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172</span><span style="color:#032F62;">-30-0-147.consul-dns.monitor.svc.cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">Address</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.23</span><span style="color:#032F62;">.127.73</span><span style="color:#24292E;"> </span><span style="color:#032F62;">consul-1.consul.monitor.svc.cluster.local</span></span></code></pre></div><ul><li>效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202407011138061.png" alt="image-20240701113758054"></p><h3 id="_2-2-5-配置采集器" tabindex="-1">2.2.5 配置采集器 <a class="header-anchor" href="#_2-2-5-配置采集器" aria-label="Permalink to &quot;2.2.5 配置采集器&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">service_discovery_consul</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">honor_labels</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scheme</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">consul_sd_configs</span><span style="color:#E1E4E8;">:    </span><span style="color:#6A737D;">#基于consul服务发现的配置</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">server</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul.monitor.svc.cluster.local:8500</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">#consul的监听地址</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">services</span><span style="color:#E1E4E8;">: []                 </span><span style="color:#6A737D;">#匹配consul中所有的service</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:             </span><span style="color:#6A737D;">#relabel_configs下面都是重写标签相关配置</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;__meta_consul_tags&#39;</span><span style="color:#E1E4E8;">]    </span><span style="color:#6A737D;">#将__meta_consul_tags标签的至赋值给product</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;servername&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;__meta_consul_dc&#39;</span><span style="color:#E1E4E8;">]   </span><span style="color:#6A737D;">#将__meta_consul_dc的值赋值给idc</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;idc&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;__meta_consul_service&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;consul&quot;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#匹配为&quot;consul&quot;的service</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">drop</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">#执行的动作为删除</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">service_discovery_consul</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">honor_labels</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/metrics</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scheme</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">consul_sd_configs</span><span style="color:#24292E;">:    </span><span style="color:#6A737D;">#基于consul服务发现的配置</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul.monitor.svc.cluster.local:8500</span><span style="color:#24292E;">    </span><span style="color:#6A737D;">#consul的监听地址</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">services</span><span style="color:#24292E;">: []                 </span><span style="color:#6A737D;">#匹配consul中所有的service</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:             </span><span style="color:#6A737D;">#relabel_configs下面都是重写标签相关配置</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;__meta_consul_tags&#39;</span><span style="color:#24292E;">]    </span><span style="color:#6A737D;">#将__meta_consul_tags标签的至赋值给product</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;servername&#39;</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;__meta_consul_dc&#39;</span><span style="color:#24292E;">]   </span><span style="color:#6A737D;">#将__meta_consul_dc的值赋值给idc</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;idc&#39;</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;__meta_consul_service&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;consul&quot;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">#匹配为&quot;consul&quot;的service</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">drop</span><span style="color:#24292E;">       </span><span style="color:#6A737D;">#执行的动作为删除</span></span></code></pre></div><ul><li>热更新</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-XPOST</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-XPOST</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre></div><h1 id="_3-注册节点" tabindex="-1">3. 注册节点 <a class="header-anchor" href="#_3-注册节点" aria-label="Permalink to &quot;3. 注册节点&quot;">​</a></h1><p>由于consul是在k8s中安装,要想采集k8s之外的数据,的把consul的服务暴露出去</p><h2 id="_3-1-创建svc" tabindex="-1">3.1 创建svc <a class="header-anchor" href="#_3-1-创建svc" aria-label="Permalink to &quot;3.1 创建svc&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master consul</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat node_service.yaml</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul-ui-ip</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NodePort</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">sessionAffinity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">None</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">consul-ui-ip</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8500</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8500</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">nodePort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">30007</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master consul</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat node_service.yaml</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul-ui-ip</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NodePort</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">sessionAffinity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">None</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">consul-ui-ip</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8500</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8500</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">nodePort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">30007</span></span></code></pre></div><ul><li>apply</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node_service.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master consul]# kubectl get svc consul-ui-ip -nmonitor</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">CLUSTER-IP</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">EXTERNAL-IP</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">PORT</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">S</span><span style="color:#E1E4E8;">)          </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">consul-ui-ip</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">NodePort</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.131.12</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">8500</span><span style="color:#9ECBFF;">:30007/TCP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">19</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#验证,随便一个k8s中的节点即可</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master consul]# curl 10.103.236.201:30007</span></span>
<span class="line"><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">a href=</span><span style="color:#9ECBFF;">&quot;/ui/&quot;</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">Moved Permanently</span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">/a</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node_service.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master consul]# kubectl get svc consul-ui-ip -nmonitor</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">           </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">       </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">       </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)          </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">consul-ui-ip</span><span style="color:#24292E;">   </span><span style="color:#032F62;">NodePort</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.131.12</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">8500</span><span style="color:#032F62;">:30007/TCP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">19</span><span style="color:#032F62;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#验证,随便一个k8s中的节点即可</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master consul]# curl 10.103.236.201:30007</span></span>
<span class="line"><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">a href=</span><span style="color:#032F62;">&quot;/ui/&quot;</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">Moved Permanently</span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">/a</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">.</span></span></code></pre></div><h2 id="_3-2-创建node-export" tabindex="-1">3.2 创建node-export <a class="header-anchor" href="#_3-2-创建node-export" aria-label="Permalink to &quot;3.2 创建node-export&quot;">​</a></h2><p>node-export为例</p><ul><li>创建</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">9100</span><span style="color:#9ECBFF;">:9100</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">-v </span><span style="color:#9ECBFF;">&quot;/proc:/host/proc&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">-v </span><span style="color:#9ECBFF;">&quot;/sys:/host/sys&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">-v </span><span style="color:#9ECBFF;">&quot;/:/rootfs&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">-v </span><span style="color:#9ECBFF;">&quot;/etc/localtime:/etc/localtime&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--net=host </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/node-exporter:latest </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--path.procfs </span><span style="color:#9ECBFF;">/host/proc</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--path.sysfs </span><span style="color:#9ECBFF;">/host/sys</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--collector.filesystem.ignored-mount-points </span><span style="color:#9ECBFF;">&quot;^/(sys|proc|dev|host|etc)($|/)&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9100</span><span style="color:#032F62;">:9100</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">-v </span><span style="color:#032F62;">&quot;/proc:/host/proc&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">-v </span><span style="color:#032F62;">&quot;/sys:/host/sys&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">-v </span><span style="color:#032F62;">&quot;/:/rootfs&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">-v </span><span style="color:#032F62;">&quot;/etc/localtime:/etc/localtime&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--net=host </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/node-exporter:latest </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--path.procfs </span><span style="color:#032F62;">/host/proc</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--path.sysfs </span><span style="color:#032F62;">/host/sys</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--collector.filesystem.ignored-mount-points </span><span style="color:#032F62;">&quot;^/(sys|proc|dev|host|etc)($|/)&quot;</span></span></code></pre></div><ul><li>注入consul</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-X</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PUT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;{&quot;id&quot;: &quot;middler2&quot;,&quot;name&quot;: &quot;nodeexporter&quot;,&quot;address&quot;: &quot;10.103.236.199&quot;,&quot;port&quot;:9100,&quot;tags&quot;:[&quot;middleware&quot;],&quot;checks&quot;: [{&quot;http&quot;:&quot;http://10.103.236.199:9100/metrics&quot;,&quot;interval&quot;: &quot;3s&quot;}]}&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://10.103.236.201:30007/v1/agent/service/register</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PUT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;{&quot;id&quot;: &quot;middler2&quot;,&quot;name&quot;: &quot;nodeexporter&quot;,&quot;address&quot;: &quot;10.103.236.199&quot;,&quot;port&quot;:9100,&quot;tags&quot;:[&quot;middleware&quot;],&quot;checks&quot;: [{&quot;http&quot;:&quot;http://10.103.236.199:9100/metrics&quot;,&quot;interval&quot;: &quot;3s&quot;}]}&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://10.103.236.201:30007/v1/agent/service/register</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#参数说明</span></span>
<span class="line"><span style="color:#85E89D;">id</span><span style="color:#E1E4E8;"> : </span><span style="color:#9ECBFF;">注册ID 在consul中为唯一标识</span></span>
<span class="line"><span style="color:#9ECBFF;">name ：Service名称</span></span>
<span class="line"><span style="color:#9ECBFF;">address：自动注册绑定ip</span></span>
<span class="line"><span style="color:#9ECBFF;">port：自动注册绑定端口</span></span>
<span class="line"><span style="color:#9ECBFF;">tags：注册标签，可多个</span></span>
<span class="line"><span style="color:#85E89D;">checks</span><span style="color:#E1E4E8;"> : </span><span style="color:#9ECBFF;">健康检查</span></span>
<span class="line"><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:   </span><span style="color:#9ECBFF;">检查数据来源</span></span>
<span class="line"><span style="color:#85E89D;">interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">检查时间间隔</span></span>
<span class="line"><span style="color:#9ECBFF;">http://10.103.236.201:30007/v1/agent/service/register  consul注册接口</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#参数说明</span></span>
<span class="line"><span style="color:#22863A;">id</span><span style="color:#24292E;"> : </span><span style="color:#032F62;">注册ID 在consul中为唯一标识</span></span>
<span class="line"><span style="color:#032F62;">name ：Service名称</span></span>
<span class="line"><span style="color:#032F62;">address：自动注册绑定ip</span></span>
<span class="line"><span style="color:#032F62;">port：自动注册绑定端口</span></span>
<span class="line"><span style="color:#032F62;">tags：注册标签，可多个</span></span>
<span class="line"><span style="color:#22863A;">checks</span><span style="color:#24292E;"> : </span><span style="color:#032F62;">健康检查</span></span>
<span class="line"><span style="color:#22863A;">http</span><span style="color:#24292E;">:   </span><span style="color:#032F62;">检查数据来源</span></span>
<span class="line"><span style="color:#22863A;">interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">检查时间间隔</span></span>
<span class="line"><span style="color:#032F62;">http://10.103.236.201:30007/v1/agent/service/register  consul注册接口</span></span></code></pre></div><ul><li>效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202407011518539.png" alt="image-20240701151805983"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202407011518404.png" alt="image-20240701151846523"></p><h2 id="_3-3-删除注入" tabindex="-1">3.3 删除注入 <a class="header-anchor" href="#_3-3-删除注入" aria-label="Permalink to &quot;3.3 删除注入&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#如果要注销掉某个服务，可以通过如下API命令操作</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#格式</span></span>
<span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-X</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PUT</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://10.103.236.201:30007/v1/agent/service/deregister/id</span></span>
<span class="line"><span style="color:#6A737D;">#注释</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">id</span><span style="color:#E1E4E8;"> -</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">先前创建时指定的名字</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#如</span></span>
<span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-X</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PUT</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://10.103.236.201:30007/v1/agent/service/deregister/middler2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#如果要注销掉某个服务，可以通过如下API命令操作</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#格式</span></span>
<span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PUT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://10.103.236.201:30007/v1/agent/service/deregister/id</span></span>
<span class="line"><span style="color:#6A737D;">#注释</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">id</span><span style="color:#24292E;"> -</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">先前创建时指定的名字</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#如</span></span>
<span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PUT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://10.103.236.201:30007/v1/agent/service/deregister/middler2</span></span></code></pre></div><p>nginx 代理consul</p><p><a href="https://blog.csdn.net/kaikai0720/article/details/128615517" target="_blank" rel="noreferrer">https://blog.csdn.net/kaikai0720/article/details/128615517</a></p><p><a href="https://www.yuandangsheng.top/?p=3148" target="_blank" rel="noreferrer">https://www.yuandangsheng.top/?p=3148</a></p><p><a href="https://www.cnblogs.com/k-free-bolg/p/13181957.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/k-free-bolg/p/13181957.html</a></p>`,56),e=[o];function c(t,r,E,y,i,F){return n(),a("div",null,e)}const d=s(p,[["render",c]]);export{C as __pageData,d as default};
