import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const h=JSON.parse('{"title":"1.介绍","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Linux/Logs/Clickhouse/10-maintenance_log_clean.md","filePath":"guide/Linux/Logs/Clickhouse/10-maintenance_log_clean.md","lastUpdated":1730975389000}'),e={name:"guide/Linux/Logs/Clickhouse/10-maintenance_log_clean.md"},p=l(`<h1 id="_1-介绍" tabindex="-1">1.介绍 <a class="header-anchor" href="#_1-介绍" aria-label="Permalink to &quot;1.介绍&quot;">​</a></h1><p>clickhouse会将<code>查询日志</code>，<code>度量日志</code>和<code>堆栈采集日志</code>记录下来，存储到自身数据库的system库中， 分别是query_log,trace_log,metric_log等5个表，如果长时间不清查，该表数据会一直累积</p><h2 id="_1-1删除方案" tabindex="-1">1.1删除方案 <a class="header-anchor" href="#_1-1删除方案" aria-label="Permalink to &quot;1.1删除方案&quot;">​</a></h2><h3 id="_1-配置文件" tabindex="-1">1.配置文件 <a class="header-anchor" href="#_1-配置文件" aria-label="Permalink to &quot;1.配置文件&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">vim config.xml</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">trace_log</span></span>
<span class="line"><span style="color:#e1e4e8;">query_log</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">vim config.xml</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">trace_log</span></span>
<span class="line"><span style="color:#24292e;">query_log</span></span></code></pre></div><h3 id="_2-手动删除" tabindex="-1">2.手动删除 <a class="header-anchor" href="#_2-手动删除" aria-label="Permalink to &quot;2.手动删除&quot;">​</a></h3><ul><li>查询</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">count</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">system</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">trace_log</span><span style="color:#E1E4E8;"> prewhere event_date </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2020-01-01&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">count</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">system</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">trace_log</span><span style="color:#24292E;"> prewhere event_date </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2020-01-01&#39;</span></span></code></pre></div><ul><li>删除</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">#根据统计，只有几十万或者几百万的话，可以执行删除</span></span>
<span class="line"><span style="color:#F97583;">alter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">system</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">trace_log</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">delete</span><span style="color:#E1E4E8;"> prewhere event_date </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2020-01-01&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;">  event_date </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2020-12-31&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">#根据统计，只有几十万或者几百万的话，可以执行删除</span></span>
<span class="line"><span style="color:#D73A49;">alter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">system</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">trace_log</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">delete</span><span style="color:#24292E;"> prewhere event_date </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2020-01-01&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;">  event_date </span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2020-12-31&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><ul><li>如果不指定时间</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">system</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">trace_log</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DELETE</span><span style="color:#E1E4E8;"> prewhere event_date </span><span style="color:#F97583;">is not null</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">system</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">trace_log</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DELETE</span><span style="color:#24292E;"> prewhere event_date </span><span style="color:#D73A49;">is not null</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="_3-设置ttl" tabindex="-1">3.设置ttl <a class="header-anchor" href="#_3-设置ttl" aria-label="Permalink to &quot;3.设置ttl&quot;">​</a></h3><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">&lt;!--</span></span>
<span class="line"><span style="color:#6A737D;">            Table TTL specification: https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/#mergetree-table-ttl</span></span>
<span class="line"><span style="color:#6A737D;">            Example:</span></span>
<span class="line"><span style="color:#6A737D;">                event_date + INTERVAL 1 WEEK</span></span>
<span class="line"><span style="color:#6A737D;">                event_date + INTERVAL 7 DAY DELETE</span></span>
<span class="line"><span style="color:#6A737D;">                event_date + INTERVAL 2 WEEK TO DISK &#39;bbb&#39;</span></span>
<span class="line"><span style="color:#6A737D;">--&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">        &lt;</span><span style="color:#85E89D;">ttl</span><span style="color:#E1E4E8;">&gt;event_date + INTERVAL 7 DAY DELETE&lt;/</span><span style="color:#85E89D;">ttl</span><span style="color:#E1E4E8;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">&lt;!--</span></span>
<span class="line"><span style="color:#6A737D;">            Table TTL specification: https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/#mergetree-table-ttl</span></span>
<span class="line"><span style="color:#6A737D;">            Example:</span></span>
<span class="line"><span style="color:#6A737D;">                event_date + INTERVAL 1 WEEK</span></span>
<span class="line"><span style="color:#6A737D;">                event_date + INTERVAL 7 DAY DELETE</span></span>
<span class="line"><span style="color:#6A737D;">                event_date + INTERVAL 2 WEEK TO DISK &#39;bbb&#39;</span></span>
<span class="line"><span style="color:#6A737D;">--&gt;</span></span>
<span class="line"><span style="color:#24292E;">        &lt;</span><span style="color:#22863A;">ttl</span><span style="color:#24292E;">&gt;event_date + INTERVAL 7 DAY DELETE&lt;/</span><span style="color:#22863A;">ttl</span><span style="color:#24292E;">&gt;</span></span></code></pre></div><ul><li>设置</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">#系统表，保留30天</span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">system</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">trace_log</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">MODIFY</span><span style="color:#E1E4E8;"> TTL event_date </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> toIntervalDay(</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#业务表</span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">your_dbname</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">table_name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">MODIFY</span><span style="color:#E1E4E8;"> TTL time_stamp </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> toIntervalYear(</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">#系统表，保留30天</span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">system</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">trace_log</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">MODIFY</span><span style="color:#24292E;"> TTL event_date </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> toIntervalDay(</span><span style="color:#005CC5;">30</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#业务表</span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">your_dbname</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">table_name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">MODIFY</span><span style="color:#24292E;"> TTL time_stamp </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> toIntervalYear(</span><span style="color:#005CC5;">30</span><span style="color:#24292E;">);</span></span></code></pre></div>`,16),o=[p];function t(c,r,E,y,i,d){return a(),n("div",null,o)}const _=s(e,[["render",t]]);export{h as __pageData,_ as default};
