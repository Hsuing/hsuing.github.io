import{_ as s,o as e,c as a,R as n}from"./chunks/framework.zUbWieqp.js";const _=JSON.parse('{"title":"PostgreSQL Lock 一例","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/pgSql/6.pg_lock_anli.md","filePath":"guide/Database/pgSql/6.pg_lock_anli.md","lastUpdated":1703063387000}'),l={name:"guide/Database/pgSql/6.pg_lock_anli.md"},p=n(`<h1 id="postgresql-lock-一例" tabindex="-1">PostgreSQL Lock 一例 <a class="header-anchor" href="#postgresql-lock-一例" aria-label="Permalink to &quot;PostgreSQL Lock 一例&quot;">​</a></h1><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">ALTER TABLE table_test ADD COLUMN column_a integer NOT NULL DEFAULT 0;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">ALTER TABLE table_test ADD COLUMN column_a integer NOT NULL DEFAULT 0;</span></span></code></pre></div><ul><li>表结构</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres@127.0.0.1 ~=# \\d pg_class;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres@127.0.0.1 ~=# \\d pg_class;</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres@127.0.0.1 ~=# \\d pg_locks;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres@127.0.0.1 ~=# \\d pg_locks;</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres@127.0.0.1 ~=# \\d pg_stat_activity;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres@127.0.0.1 ~=# \\d pg_stat_activity;</span></span></code></pre></div><ul><li>先查出表 的oid</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">#select oid,relname from pg_class where relname=&#39;adg4&#39;;</span></span>
<span class="line"><span style="color:#e1e4e8;">  oid  | relname </span></span>
<span class="line"><span style="color:#e1e4e8;">-------+---------</span></span>
<span class="line"><span style="color:#e1e4e8;"> 16415 | adg4</span></span>
<span class="line"><span style="color:#e1e4e8;">(1 row)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">#select oid,relname from pg_class where relname=&#39;adg4&#39;;</span></span>
<span class="line"><span style="color:#24292e;">  oid  | relname </span></span>
<span class="line"><span style="color:#24292e;">-------+---------</span></span>
<span class="line"><span style="color:#24292e;"> 16415 | adg4</span></span>
<span class="line"><span style="color:#24292e;">(1 row)</span></span></code></pre></div><ul><li>查询表table上持有的锁</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"># select locktype,database,pid,relation ,mode from pg_locks where relation=16415; </span></span>
<span class="line"><span style="color:#e1e4e8;">relation | 16400 | 9128 | 16678 | AccessShareLock  </span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#select locktype,database,pid,relation ,mode from pg_locks where relation=16678;</span></span>
<span class="line"><span style="color:#e1e4e8;">locktype | database | pid | relation | mode  </span></span>
<span class="line"><span style="color:#e1e4e8;">----------+----------+-------+----------+-----------------  </span></span>
<span class="line"><span style="color:#e1e4e8;">relation | 16400 | 29393 | 16678 | AccessShareLock</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">备注：此时表 table_test 只有一个会话(pid=29393)持有 AccessShareLock 锁，这应该是个Select查询;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"># select locktype,database,pid,relation ,mode from pg_locks where relation=16415; </span></span>
<span class="line"><span style="color:#24292e;">relation | 16400 | 9128 | 16678 | AccessShareLock  </span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#select locktype,database,pid,relation ,mode from pg_locks where relation=16678;</span></span>
<span class="line"><span style="color:#24292e;">locktype | database | pid | relation | mode  </span></span>
<span class="line"><span style="color:#24292e;">----------+----------+-------+----------+-----------------  </span></span>
<span class="line"><span style="color:#24292e;">relation | 16400 | 29393 | 16678 | AccessShareLock</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">备注：此时表 table_test 只有一个会话(pid=29393)持有 AccessShareLock 锁，这应该是个Select查询;</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">select usename,current_query ,xact_start,procpid from pg_stat_activity where procpid=29393;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">select usename,current_query ,xact_start,procpid from pg_stat_activity where procpid=29393;</span></span></code></pre></div><ul><li>kill 会话</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"># select pg_terminate_backend(29393);  </span></span>
<span class="line"><span style="color:#e1e4e8;">pg_terminate_backend  </span></span>
<span class="line"><span style="color:#e1e4e8;">----------------------  </span></span>
<span class="line"><span style="color:#e1e4e8;">t  </span></span>
<span class="line"><span style="color:#e1e4e8;">(1 row)</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># 查看会话</span></span>
<span class="line"><span style="color:#e1e4e8;">select usename,current_query ,xact_start,procpid from pg_stat_activity where procpid=29393;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"># select pg_terminate_backend(29393);  </span></span>
<span class="line"><span style="color:#24292e;">pg_terminate_backend  </span></span>
<span class="line"><span style="color:#24292e;">----------------------  </span></span>
<span class="line"><span style="color:#24292e;">t  </span></span>
<span class="line"><span style="color:#24292e;">(1 row)</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># 查看会话</span></span>
<span class="line"><span style="color:#24292e;">select usename,current_query ,xact_start,procpid from pg_stat_activity where procpid=29393;</span></span></code></pre></div><p>原因分析: 在生产库执行类似ALTER TABLE 的DDL时应该非常小心，因为此时加的是 Table 级的 ACCESS EXCLUSIVE 锁 ,ACCESS EXCLUSIVE和其它所有类型所有锁都冲突，包括SELECT，所以当执行Select这张表的事务还没有结束时，执行 Alter Table时，表table_test会因获取不到 ACCESS EXCLUSIVE 而发生等侍</p><p>建议方法：当执行ALTER TABLE类似操作时，正确的方法是先查看 pg_locks 是否有这张表所持有的锁，如果有，等系统空闲的时候 再做这种操作</p><p>扩展：当在生产库执行DDL时，应该首先查看执行DDL对象当前所持有锁的情况，如果和执行DDL请求的锁冲突，应该等系统空闲的时候再执行DDL操作</p>`,16),c=[p];function o(t,i,r,d,g,y){return e(),a("div",null,c)}const u=s(l,[["render",o]]);export{_ as __pageData,u as default};
