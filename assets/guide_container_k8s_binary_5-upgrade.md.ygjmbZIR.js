import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const F=JSON.parse('{"title":"1.升级说明","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/binary/5-upgrade.md","filePath":"guide/container/k8s/binary/5-upgrade.md","lastUpdated":1733304370000}'),p={name:"guide/container/k8s/binary/5-upgrade.md"},e=l(`<h1 id="_1-升级说明" tabindex="-1">1.升级说明 <a class="header-anchor" href="#_1-升级说明" aria-label="Permalink to &quot;1.升级说明&quot;">​</a></h1><p>Kubernetes集群<code>小版本升级</code>基本上是只需要更新二进制文件即可。如果<code>大版本升级</code>需要注意kubelet参数的变化，以及其他组件升级之后的变化。 由于Kubernete版本更新过快许多依赖并没有解决完善，并不建议生产环境使用较新版本。建议使用,比如1.29.<code>10</code>,要10这个位置的数字大于5</p><p>升级集群版本建议逐步升级，k8s版本以 x.y.z 表示，其中 x 是主要版本， y 是次要版本，z 是补丁版本,尽量不能跳过次要版本升级，比如1.28.0-&gt;1.30.0可能遭遇失败，补丁版本可以跳跃更新，比如1.28.2-&gt;1.28.10</p><p>尽量将kubelet和kubeadm版本保持一致，可以偏差一个版本</p><p>升级后，因为容器spec的哈希值已更改，所有容器都会被重新启动</p><blockquote><p>建议：多master环境的话，先其中一个master升级好所有服务。然后创建一个测试应用跑在该master节点，观察应用是否正常。没有问题再逐台升级</p></blockquote><p><a href="https://v1-29.docs.kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/" target="_blank" rel="noreferrer">https://v1-29.docs.kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/</a></p><h2 id="_1-1-升级顺序" tabindex="-1">1.1 升级顺序 <a class="header-anchor" href="#_1-1-升级顺序" aria-label="Permalink to &quot;1.1 升级顺序&quot;">​</a></h2><p>升级控制节点（master）</p><p>升级其他控制平面节点（高可用集群）</p><p>升级工作节点（worker）</p><h1 id="_2-kubeadm升级" tabindex="-1">2.kubeadm升级 <a class="header-anchor" href="#_2-kubeadm升级" aria-label="Permalink to &quot;2.kubeadm升级&quot;">​</a></h1><h2 id="_2-1-备份数据" tabindex="-1">2.1 备份数据 <a class="header-anchor" href="#_2-1-备份数据" aria-label="Permalink to &quot;2.1 备份数据&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 备份目录</span></span>
<span class="line"><span style="color:#B392F0;">cp -a /etc/kubernetes/  /etc/kubernetes.bak</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">cp -a /var/lib/etcd   /var/lib/etcd.bak</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 备份etcd数据</span></span>
<span class="line"><span style="color:#E1E4E8;">ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;"> etcdctl snapshot save /data/etcd/etcd_bak.db </span><span style="color:#E1E4E8;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--endpoints</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">https://127.0.0.1:2379 </span><span style="color:#E1E4E8;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--cacert</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/ca.crt </span><span style="color:#E1E4E8;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--cert</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/server.crt </span><span style="color:#E1E4E8;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--key</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/server.key </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 如果没有etcdctl工具需要安装一下</span></span>
<span class="line"><span style="color:#B392F0;">yum install -y etcd</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 备份目录</span></span>
<span class="line"><span style="color:#6F42C1;">cp -a /etc/kubernetes/  /etc/kubernetes.bak</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">cp -a /var/lib/etcd   /var/lib/etcd.bak</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 备份etcd数据</span></span>
<span class="line"><span style="color:#24292E;">ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#032F62;"> etcdctl snapshot save /data/etcd/etcd_bak.db </span><span style="color:#24292E;">\\</span></span>
<span class="line"><span style="color:#24292E;">--endpoints</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">https://127.0.0.1:2379 </span><span style="color:#24292E;">\\</span></span>
<span class="line"><span style="color:#24292E;">--cacert</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/ca.crt </span><span style="color:#24292E;">\\</span></span>
<span class="line"><span style="color:#24292E;">--cert</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/server.crt </span><span style="color:#24292E;">\\</span></span>
<span class="line"><span style="color:#24292E;">--key</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/server.key </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 如果没有etcdctl工具需要安装一下</span></span>
<span class="line"><span style="color:#6F42C1;">yum install -y etcd</span></span></code></pre></div><h2 id="_2-2-配置源" tabindex="-1">2.2 配置源 <a class="header-anchor" href="#_2-2-配置源" aria-label="Permalink to &quot;2.2 配置源&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cat &lt;&lt;EOF </span><span style="color:#F97583;">|</span><span style="color:#B392F0;"> tee /etc/yum.repos.d/kubernetes.repo</span></span>
<span class="line"><span style="color:#E1E4E8;">[kubernetes]</span></span>
<span class="line"><span style="color:#E1E4E8;">name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">Kubernetes</span></span>
<span class="line"><span style="color:#E1E4E8;">baseurl</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/</span></span>
<span class="line"><span style="color:#E1E4E8;">enabled</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">gpgcheck</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">gpgkey</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/repodata/repomd.xml.key</span></span>
<span class="line"><span style="color:#B392F0;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cat &lt;&lt;EOF </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;"> tee /etc/yum.repos.d/kubernetes.repo</span></span>
<span class="line"><span style="color:#24292E;">[kubernetes]</span></span>
<span class="line"><span style="color:#24292E;">name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">Kubernetes</span></span>
<span class="line"><span style="color:#24292E;">baseurl</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/</span></span>
<span class="line"><span style="color:#24292E;">enabled</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">gpgcheck</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">gpgkey</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/repodata/repomd.xml.key</span></span>
<span class="line"><span style="color:#6F42C1;">EOF</span></span></code></pre></div><h2 id="_2-3-master节点" tabindex="-1">2.3 master节点 <a class="header-anchor" href="#_2-3-master节点" aria-label="Permalink to &quot;2.3 master节点&quot;">​</a></h2><ul><li>查看版本</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">list</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--showduplicates</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--disableexcludes=kubernetes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">list</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--showduplicates</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--disableexcludes=kubernetes</span></span></code></pre></div><ul><li>设置master节点为不可调度</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#禁止调度</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cordon</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">nod</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#驱逐</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">drain</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">node-to-drai</span><span style="color:#E1E4E8;">n</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--ignore-daemonsets</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#禁止调度</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cordon</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">nod</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#驱逐</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">drain</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">node-to-drai</span><span style="color:#24292E;">n</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--ignore-daemonsets</span></span></code></pre></div><h3 id="_1-升级kubeadm" tabindex="-1">1.升级kubeadm <a class="header-anchor" href="#_1-升级kubeadm" aria-label="Permalink to &quot;1.升级kubeadm&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">yum install -y kubeadm-</span><span style="color:#B392F0;">&#39;1.29.10-*&#39;</span><span style="color:#B392F0;"> --disableexcludes</span><span style="color:#E1E4E8;">=kubernetes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">yum install -y kubeadm-</span><span style="color:#6F42C1;">&#39;1.29.10-*&#39;</span><span style="color:#6F42C1;"> --disableexcludes</span><span style="color:#24292E;">=kubernetes</span></span></code></pre></div><ul><li>查看版本升级后版本</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">version</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">version</span></span></code></pre></div><ul><li>验证</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">upgrade</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">plan</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">upgrade</span><span style="color:#24292E;"> </span><span style="color:#032F62;">plan</span></span></code></pre></div><ul><li>升级</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 将 x 替换为你为此次升级所选择的补丁版本号</span></span>
<span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">upgrade</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1.29.x</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 将 x 替换为你为此次升级所选择的补丁版本号</span></span>
<span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">upgrade</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1.29.x</span></span></code></pre></div><h3 id="_2-升级-kubelet-和-kubectl" tabindex="-1">2.升级 kubelet 和 kubectl <a class="header-anchor" href="#_2-升级-kubelet-和-kubectl" aria-label="Permalink to &quot;2.升级 kubelet 和 kubectl&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">yum install -y kubelet-</span><span style="color:#B392F0;">&#39;1.29.10-*&#39;</span><span style="color:#B392F0;"> kubectl-</span><span style="color:#B392F0;">&#39;1.29.10-*&#39;</span><span style="color:#B392F0;"> --disableexcludes</span><span style="color:#E1E4E8;">=kubernetes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">yum install -y kubelet-</span><span style="color:#6F42C1;">&#39;1.29.10-*&#39;</span><span style="color:#6F42C1;"> kubectl-</span><span style="color:#6F42C1;">&#39;1.29.10-*&#39;</span><span style="color:#6F42C1;"> --disableexcludes</span><span style="color:#24292E;">=kubernetes</span></span></code></pre></div><ul><li>重启服务</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">sudo systemctl daemon-reload</span></span>
<span class="line"><span style="color:#e1e4e8;">sudo systemctl restart kubelet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">sudo systemctl daemon-reload</span></span>
<span class="line"><span style="color:#24292e;">sudo systemctl restart kubelet</span></span></code></pre></div><ul><li>解除调度</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 将 &lt;node-to-uncordon&gt; 替换为你的节点名称</span></span>
<span class="line"><span style="color:#B392F0;">kubectl uncordon &lt;node-to-uncordon&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 将 &lt;node-to-uncordon&gt; 替换为你的节点名称</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl uncordon &lt;node-to-uncordon&gt;</span></span></code></pre></div><h2 id="_2-4-work节点" tabindex="-1">2.4 work节点 <a class="header-anchor" href="#_2-4-work节点" aria-label="Permalink to &quot;2.4 work节点&quot;">​</a></h2><h3 id="_1-升级-kubeadm" tabindex="-1">1.升级 kubeadm <a class="header-anchor" href="#_1-升级-kubeadm" aria-label="Permalink to &quot;1.升级 kubeadm&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 将 1.29.x-* 中的 x 替换为最新的补丁版本</span></span>
<span class="line"><span style="color:#B392F0;">sudo yum install -y kubeadm-</span><span style="color:#B392F0;">&#39;1.29.x-*&#39;</span><span style="color:#B392F0;"> --disableexcludes</span><span style="color:#E1E4E8;">=kubernetes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">yum install -y kubeadm-</span><span style="color:#B392F0;">&#39;1.29.10-*&#39;</span><span style="color:#B392F0;"> --disableexcludes</span><span style="color:#E1E4E8;">=kubernetes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 将 1.29.x-* 中的 x 替换为最新的补丁版本</span></span>
<span class="line"><span style="color:#6F42C1;">sudo yum install -y kubeadm-</span><span style="color:#6F42C1;">&#39;1.29.x-*&#39;</span><span style="color:#6F42C1;"> --disableexcludes</span><span style="color:#24292E;">=kubernetes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">yum install -y kubeadm-</span><span style="color:#6F42C1;">&#39;1.29.10-*&#39;</span><span style="color:#6F42C1;"> --disableexcludes</span><span style="color:#24292E;">=kubernetes</span></span></code></pre></div><ul><li>升级</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubeadm upgrade node</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubeadm upgrade node</span></span></code></pre></div><h3 id="_2-升级-kubelet-和-kubectl-1" tabindex="-1">2.升级 kubelet 和 kubectl <a class="header-anchor" href="#_2-升级-kubelet-和-kubectl-1" aria-label="Permalink to &quot;2.升级 kubelet 和 kubectl&quot;">​</a></h3><ul><li>禁止调度</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl cordon &lt;node-to-uncordon&gt;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#驱逐</span></span>
<span class="line"><span style="color:#e1e4e8;">kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl cordon &lt;node-to-uncordon&gt;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#驱逐</span></span>
<span class="line"><span style="color:#24292e;">kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets</span></span></code></pre></div><ul><li>升级</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">yum install -y kubelet-</span><span style="color:#B392F0;">&#39;1.29.10-*&#39;</span><span style="color:#B392F0;"> kubectl-</span><span style="color:#B392F0;">&#39;1.29.10-*&#39;</span><span style="color:#B392F0;"> --disableexcludes</span><span style="color:#E1E4E8;">=kubernetes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">yum install -y kubelet-</span><span style="color:#6F42C1;">&#39;1.29.10-*&#39;</span><span style="color:#6F42C1;"> kubectl-</span><span style="color:#6F42C1;">&#39;1.29.10-*&#39;</span><span style="color:#6F42C1;"> --disableexcludes</span><span style="color:#24292E;">=kubernetes</span></span></code></pre></div><ul><li>重启服务</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">sudo systemctl daemon-reload</span></span>
<span class="line"><span style="color:#e1e4e8;">sudo systemctl restart kubelet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">sudo systemctl daemon-reload</span></span>
<span class="line"><span style="color:#24292e;">sudo systemctl restart kubelet</span></span></code></pre></div><ul><li>解除调度</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl uncordon &lt;node-to-uncordon&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl uncordon &lt;node-to-uncordon&gt;</span></span></code></pre></div><h2 id="_2-5-验证" tabindex="-1">2.5 验证 <a class="header-anchor" href="#_2-5-验证" aria-label="Permalink to &quot;2.5 验证&quot;">​</a></h2><p>访问服务，和创建pod能否成功</p><h1 id="_3-二进制升级" tabindex="-1">3.二进制升级 <a class="header-anchor" href="#_3-二进制升级" aria-label="Permalink to &quot;3.二进制升级&quot;">​</a></h1><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 检查弃用的API使用情况</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pods</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--all-namespaces</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name,PHASE:.status.phase,API:.apiVersion</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 检查容器运行时</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wide</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 检查弃用的API使用情况</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pods</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--all-namespaces</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name,PHASE:.status.phase,API:.apiVersion</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 检查容器运行时</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wide</span></span></code></pre></div><h1 id="_4-集群升级版本检查" tabindex="-1">4.集群升级版本检查 <a class="header-anchor" href="#_4-集群升级版本检查" aria-label="Permalink to &quot;4.集群升级版本检查&quot;">​</a></h1><p>通过<a href="https://kubepug.xyz/database/" target="_blank" rel="noreferrer">kubepug</a>来检查</p><h2 id="_2-1介绍" tabindex="-1">2.1介绍 <a class="header-anchor" href="#_2-1介绍" aria-label="Permalink to &quot;2.1介绍&quot;">​</a></h2><p><code>Kubepug</code> 即是这样一个工具，一个升级前检查器，可帮助在迁移到新的主要版本之前在 Kubernetes 资源中找到已弃用和已删除的 API</p><h2 id="_2-2原理" tabindex="-1">2.2原理 <a class="header-anchor" href="#_2-2原理" aria-label="Permalink to &quot;2.2原理&quot;">​</a></h2><ul><li><p>下载生成的 data.json文件，其中包含指定Kubernetes 版本的APl弃用信息</p></li><li><p>扫描正在运行的Kubernetes集群，以确定是否有任何对象会受到剥夺的影响</p></li><li><p>向用户显示受影响的对象</p></li></ul><h2 id="_2-3部署" tabindex="-1">2.3部署 <a class="header-anchor" href="#_2-3部署" aria-label="Permalink to &quot;2.3部署&quot;">​</a></h2><h3 id="_1-在线部署" tabindex="-1">1.在线部署 <a class="header-anchor" href="#_1-在线部署" aria-label="Permalink to &quot;1.在线部署&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"> kubectl krew install deprecations</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"> kubectl krew install deprecations</span></span></code></pre></div><h3 id="_2-离线部署" tabindex="-1">2.离线部署 <a class="header-anchor" href="#_2-离线部署" aria-label="Permalink to &quot;2.离线部署&quot;">​</a></h3><ul><li>安装</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">wget https://github.com/kubepug/kubepug/releases/download/v1.7.1/kubepug_linux_amd64.tar.gz</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#解压</span></span>
<span class="line"><span style="color:#e1e4e8;">tar -zxvf kubepug_linux_amd64.tar.gz</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">mv ./kubepug  /usr/local/bin/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">wget https://github.com/kubepug/kubepug/releases/download/v1.7.1/kubepug_linux_amd64.tar.gz</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#解压</span></span>
<span class="line"><span style="color:#24292e;">tar -zxvf kubepug_linux_amd64.tar.gz</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">mv ./kubepug  /usr/local/bin/</span></span></code></pre></div><ul><li>查看版本</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master-01 init_pack]# kubepug version</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">__</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">___</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">__</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">__</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">.______</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">_______</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.______</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">__</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">__</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">_______</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">/</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">_</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">\\ </span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">____</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">_</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">\\ </span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">/</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">_____</span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">&#39;  /  |  |  |  | |  |_)  | |  |__   |  |_)  | |  |  |  | |  |  __</span></span>
<span class="line"><span style="color:#B392F0;">|    &lt;   |  |  |  | |   _  &lt;  |   __|  |   ___/  |  |  |  | |  | |_ |</span></span>
<span class="line"><span style="color:#B392F0;">|  .  \\  |  \`--&#39;</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">_</span><span style="color:#E1E4E8;">)  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">____</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">--&#39;  | |  |__| |</span></span>
<span class="line"><span style="color:#B392F0;">|__|\\__\\  \\______/  |______/  |_______|| _|       \\______/   \\______|</span></span>
<span class="line"><span style="color:#B392F0;">kubepug: Shows all the deprecated objects in a Kubernetes cluster allowing the operator to verify them before upgrading the cluster.</span></span>
<span class="line"><span style="color:#B392F0;">It uses the Kubernetes API source code markers to define deprecated and deleted versions.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">GitVersion:    v1.7.1</span></span>
<span class="line"><span style="color:#B392F0;">GitCommit:     unknown</span></span>
<span class="line"><span style="color:#B392F0;">GitTreeState:  unknown</span></span>
<span class="line"><span style="color:#B392F0;">BuildDate:     unknown</span></span>
<span class="line"><span style="color:#B392F0;">GoVersion:     go1.21.3</span></span>
<span class="line"><span style="color:#B392F0;">Compiler:      gc</span></span>
<span class="line"><span style="color:#B392F0;">Platform:      linux/amd64</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master-01 init_pack]# kubepug version</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">__</span><span style="color:#24292E;">  </span><span style="color:#032F62;">___</span><span style="color:#24292E;">  </span><span style="color:#032F62;">__</span><span style="color:#24292E;">    </span><span style="color:#032F62;">__</span><span style="color:#24292E;">  </span><span style="color:#032F62;">.______</span><span style="color:#24292E;">    </span><span style="color:#032F62;">_______</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.______</span><span style="color:#24292E;">    </span><span style="color:#032F62;">__</span><span style="color:#24292E;">    </span><span style="color:#032F62;">__</span><span style="color:#24292E;">    </span><span style="color:#032F62;">_______</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">/</span><span style="color:#24292E;">  </span><span style="color:#032F62;">/</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">_</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">\\ </span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">____</span><span style="color:#D73A49;">||</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">_</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">\\ </span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">/</span><span style="color:#24292E;">  </span><span style="color:#032F62;">_____</span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">&#39;  /  |  |  |  | |  |_)  | |  |__   |  |_)  | |  |  |  | |  |  __</span></span>
<span class="line"><span style="color:#6F42C1;">|    &lt;   |  |  |  | |   _  &lt;  |   __|  |   ___/  |  |  |  | |  | |_ |</span></span>
<span class="line"><span style="color:#6F42C1;">|  .  \\  |  \`--&#39;</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">_</span><span style="color:#24292E;">)  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">____</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">      </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">--&#39;  | |  |__| |</span></span>
<span class="line"><span style="color:#6F42C1;">|__|\\__\\  \\______/  |______/  |_______|| _|       \\______/   \\______|</span></span>
<span class="line"><span style="color:#6F42C1;">kubepug: Shows all the deprecated objects in a Kubernetes cluster allowing the operator to verify them before upgrading the cluster.</span></span>
<span class="line"><span style="color:#6F42C1;">It uses the Kubernetes API source code markers to define deprecated and deleted versions.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">GitVersion:    v1.7.1</span></span>
<span class="line"><span style="color:#6F42C1;">GitCommit:     unknown</span></span>
<span class="line"><span style="color:#6F42C1;">GitTreeState:  unknown</span></span>
<span class="line"><span style="color:#6F42C1;">BuildDate:     unknown</span></span>
<span class="line"><span style="color:#6F42C1;">GoVersion:     go1.21.3</span></span>
<span class="line"><span style="color:#6F42C1;">Compiler:      gc</span></span>
<span class="line"><span style="color:#6F42C1;">Platform:      linux/amd64</span></span></code></pre></div><ul><li>验证</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master-01 init_pack]# kubepug</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">No</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deprecated</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">or</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deleted</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">APIs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">found</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Kubepug</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">validates</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">APIs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">using</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Kubernetes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">markers.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">To</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">know</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">what</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">are</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deprecated</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deleted</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">APIS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">it</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">checks,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">please</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">go</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://kubepug.xyz/status/</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">？？有问题</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master-01 init_pack]# kubepug</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">No</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deprecated</span><span style="color:#24292E;"> </span><span style="color:#032F62;">or</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deleted</span><span style="color:#24292E;"> </span><span style="color:#032F62;">APIs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">found</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Kubepug</span><span style="color:#24292E;"> </span><span style="color:#032F62;">validates</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">APIs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">using</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Kubernetes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">markers.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">To</span><span style="color:#24292E;"> </span><span style="color:#032F62;">know</span><span style="color:#24292E;"> </span><span style="color:#032F62;">what</span><span style="color:#24292E;"> </span><span style="color:#032F62;">are</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deprecated</span><span style="color:#24292E;"> </span><span style="color:#032F62;">and</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deleted</span><span style="color:#24292E;"> </span><span style="color:#032F62;">APIS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">it</span><span style="color:#24292E;"> </span><span style="color:#032F62;">checks,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">please</span><span style="color:#24292E;"> </span><span style="color:#032F62;">go</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://kubepug.xyz/status/</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">？？有问题</span></span></code></pre></div>`,69),o=[e];function t(c,r,y,i,d,E){return a(),n("div",null,o)}const b=s(p,[["render",t]]);export{F as __pageData,b as default};
