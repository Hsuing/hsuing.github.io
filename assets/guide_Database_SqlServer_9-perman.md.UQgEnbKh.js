import{_ as s,o as a,c as e,R as n}from"./chunks/framework.zUbWieqp.js";const h=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/SqlServer/9-perman.md","filePath":"guide/Database/SqlServer/9-perman.md","lastUpdated":1720533756000}'),l={name:"guide/Database/SqlServer/9-perman.md"},p=n(`<h2 id="_1-maxdop-maximum-degree-of-parallelism" tabindex="-1">1.MaxDOP maximum degree of parallelism <a class="header-anchor" href="#_1-maxdop-maximum-degree-of-parallelism" aria-label="Permalink to &quot;1.MaxDOP maximum degree of parallelism&quot;">​</a></h2><p>官方文档，<a href="https://learn.microsoft.com/zh-cn/sql/database-engine/configure-windows/configure-the-max-degree-of-parallelism-server-configuration-option?view=sql-server-2017" target="_blank" rel="noreferrer">https://learn.microsoft.com/zh-cn/sql/database-engine/configure-windows/configure-the-max-degree-of-parallelism-server-configuration-option?view=sql-server-2017</a></p><p>查询执行计划如何确定最大并行度？一般按照以下准则：</p><p>（1）若要使服务器能够确定最大并行度，请将此选项设置为默认值0。</p><p>（2）若将maximumdegreeofparallelism设置为0，SQLServer将能够使用至多64个可用的处理器。</p><p>（3）若要取消生成并行计划，请将maxdegreeofparallelism设置为1。</p><p>（4）将该值设置为1到32,767之间的数值来指定执行单个查询所使用的最大处理器核数。如果指定的值比可用的处理器数大，则使用实际可用数量的处理器。</p><p>（5）如果计算机只有一个处理器，将忽略maxdegreeofparallelism值</p><p><strong>最佳实践建议：</strong></p><p>请遵循以下准则：</p><p>（1）对于使用8个以上的处理器的服务器使用以下配置：MaxDOP =8。</p><p>（2）服务器的有8个或更少的处理器，使用下列配置其中N等于处理器数：MaxDOP =0到N。</p><p>（3）对于具有NUMA配置的服务器，MaxDOP 不应超过分配给每个NUMA节点的cpu数。</p><p>（4）超线程已启用的服务器的MaxDOP 值不应超过物理处理器的数量</p><h3 id="_1-1ssms" tabindex="-1"><strong>1.1SSMS</strong> <a class="header-anchor" href="#_1-1ssms" aria-label="Permalink to &quot;**1.1SSMS**&quot;">​</a></h3><p>SQL Server Management Studio（SSMS）&gt;&gt;右键单击SQL Server实例&gt;属性&gt;&gt;高级&gt;&gt;最大并行度</p><p>在“最大并行度”框中，选择执行并行计划时所使用的最大处理器数。</p><p>在“并行”下，将“并行的开阀值”选项更改为所需值，键入或选择一个值（介于0到32767之间）</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141020149.jpg" alt=""></p><h3 id="_1-2sp-config" tabindex="-1">1.2<strong>SP_Config</strong> <a class="header-anchor" href="#_1-2sp-config" aria-label="Permalink to &quot;1.2**SP_Config**&quot;">​</a></h3><p>在下例中，将最大并行度设置为8，将并行的开销阀值设置为10秒</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">EXECsp_configure</span><span style="color:#9ECBFF;">&#39;showadvancedoptions&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#E1E4E8;">RECONFIGUREWITHOVERRIDE;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#E1E4E8;">EXECsp_configure</span><span style="color:#9ECBFF;">&#39;maxdegreeofparallelism&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">EXECsp_configure</span><span style="color:#9ECBFF;">&#39;costthresholdforparallelism&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#E1E4E8;">RECONFIGUREWITHOVERRIDE;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"></span>
<span class="line"><span style="color:#24292E;">EXECsp_configure</span><span style="color:#032F62;">&#39;showadvancedoptions&#39;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#24292E;">RECONFIGUREWITHOVERRIDE;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#24292E;">EXECsp_configure</span><span style="color:#032F62;">&#39;maxdegreeofparallelism&#39;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">EXECsp_configure</span><span style="color:#032F62;">&#39;costthresholdforparallelism&#39;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#24292E;">RECONFIGUREWITHOVERRIDE;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><h3 id="_1-3现象" tabindex="-1">1.3现象 <a class="header-anchor" href="#_1-3现象" aria-label="Permalink to &quot;1.3现象&quot;">​</a></h3><p>运行一段代码发现报错，排查了相关代码，最后把其中拼接的sql 贴到SQL server 中运行，发现报同样的错误：‘The query processor could not start the necessary thread resources for parallel query execution.（解决方式，把并行度关闭，修改成1）</p><p>回顾追溯问题原因的过程：</p><ol><li>在排查后台相关方法逻辑没有问题的前提下，贴出拼接的sql语句，发现有可能是sql 的问题。</li><li>查看出问题的sql 的执行计划，发现是并行查询。对于SQL Server 来说，最终的执行计划是需要多方面评估决定的结果，同时还会参照当前运行的硬件资源，遇到的问题有可能是某些硬件不支持，比如： 内存限制、CPU限制、IO瓶颈等。</li><li>排除了硬件资源的限制，发现SQL Server 在处理某个数据集比较大，耗费资源比较多的时候，会采用并行的方法，把数据集拆分成若干个，若干个线程同时处理，来提高整体效率。当前的报错也是无法提供额外的线程资源，由此问题原因归咎于最大并行度。</li><li>MaxDOP 设置成1 的原因是，处理的任务只会由一个线程来处理，所以就不会有线程资源不够用的错误报出</li></ol><p><a href="https://wiki.sqlfans.cn/basic/cat/dev.html" target="_blank" rel="noreferrer">https://wiki.sqlfans.cn/basic/cat/dev.html</a></p><p><a href="https://blog.51cto.com/jimshu/category8.html" target="_blank" rel="noreferrer">https://blog.51cto.com/jimshu/category8.html</a></p>`,28),o=[p];function r(t,c,i,E,m,d){return a(),e("div",null,o)}const f=s(l,[["render",r]]);export{h as __pageData,f as default};
