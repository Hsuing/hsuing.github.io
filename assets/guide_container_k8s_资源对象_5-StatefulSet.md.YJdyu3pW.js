import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const C=JSON.parse('{"title":"1. StatefulSet基本概述","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/资源对象/5-StatefulSet.md","filePath":"guide/container/k8s/资源对象/5-StatefulSet.md","lastUpdated":1723447064000}'),p={name:"guide/container/k8s/资源对象/5-StatefulSet.md"},o=l(`<p>官方文档,<a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/statefulset/" target="_blank" rel="noreferrer">https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/statefulset/</a></p><h1 id="_1-statefulset基本概述" tabindex="-1">1. StatefulSet基本概述 <a class="header-anchor" href="#_1-statefulset基本概述" aria-label="Permalink to &quot;1. StatefulSet基本概述&quot;">​</a></h1><p>对于我们部署的应⽤，⼤体可以分为两类，⼀类是<code>⽆状态应⽤</code>，⼀类是<code>有状态应⽤</code></p><ul><li><p>像web这种类型的应用，就属于无状态应用，他们不需要存储任何数据至本地，也没有任何次序之分，同时所提供的服务也是完全一样的，像这类应用，就可以通过Deployment控制器来进行编排和部署；</p></li><li><p>像MySQL、Redis这类需要存储数据的应用程序，称之为有状态应用，它们有的有角色之分，有的是主节点，有的是从节点，而有的又存在先后次序之分。</p></li></ul><h2 id="_1-0-应用场景" tabindex="-1">1.0 应用场景 <a class="header-anchor" href="#_1-0-应用场景" aria-label="Permalink to &quot;1.0 应用场景&quot;">​</a></h2><p>StatefulSet是一种用于运行<code>有状态应用程序的控制器</code>，它具有<code>稳定的网络标识符</code>、<code>有序的</code>、逐个更新的部署方式<code>以</code>及<code>持久性存储</code>等特点，适用于需要这些特性的有状态应用程序</p><p>简单来说:</p><ul><li>Pod有序的部署、扩容、删除和停止</li><li>Pod分配一个稳定的且唯一的网络标识</li><li>Pod分配一个独享的存储</li></ul><h2 id="_1-1-什么是statefulset" tabindex="-1">1.1 什么是StatefulSet <a class="header-anchor" href="#_1-1-什么是statefulset" aria-label="Permalink to &quot;1.1 什么是StatefulSet&quot;">​</a></h2><p>StatefulSet 是用来管理有状态应用的工作负载 API 对象。</p><p>StatefulSet 用来管理某 <a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/" target="_blank" rel="noreferrer">Pod</a> 集合的部署和扩缩， 并为这些 Pod 提供持久存储和持久标识符。</p><blockquote><p>Kubernetes StatefulSet是一种用于运行有状态应用的控制器。</p><p>StatefulSet是一个有序的、可标识的Pod组，并且每个Pod都有一个独特的标识符。</p><p>这使得StatefulSet能够管理有状态应用程序，例如数据库或队列服务，这些应用程序需要稳定的网络标识符或持久性存储，并且需要有序的、逐个更新的部署方式。</p></blockquote><p>ReplicaSet 控制器能够从一个预置的 Pod 模板创建一个或者多个 Pod 资源，除了主机名和 IP 地址之外，这些 Pod 资源并没有本质上的区别，就连 Pod 的名称也是使用同一种散列模式生成，具有很强的相似性。</p><p>若 ReplicaSet 控制器在 Pod 模板中包含了某些 PVC（Persistent Volume Claim）的引用，则由它创建的所有 Pod 资源都将共享此存储卷。PVC 后端的 PV 访问模型配置为 ReadOnlyMany 或者 ReadWriteMany 时，这些 Pod 资源中的容器应用挂载存储卷后也就有了相同的数据集。</p><p>不过大多数情况是，一个集群系统的分布式应用中，每个实例都有可能需要存储使用不同的数据集，或者各自拥有其专有的数据副本，例如：分布式系统 GlusterFS 和 分布式文档存储 MongoDB 中的每个实例各自使用专有的数据集，分布式服务框架 Zookeeper 以及主从复制集群中的 Redis 的每个实例各自拥有其专用的数据副本。</p><p>由于 ReplicaSet 控制器使用同一个模板生成 Pod 资源，显然，它无法实现为每个 Pod 资源创建专用的存储卷，以及组织多个只负责生成一个 Pod 资源的 ReplicaSet 控制器则有规模扩展不变的尴尬。自主式 Pod 资源又没有自愈能力。</p><p>其次，除了要用到专用持久化存储卷外，有些集群类的分布式应用实例在运行期间还存在角色上的差异，它们存在 单向/双向 的基于 IP 地址或 主机名 的引用关系，例如 主从复制集群中的 MySQL 从节点的引用。这类应用实例，每一个都应当作一个独立的个体对待。ReplicaSet 对象控制下的 Pod 资源重构后，其 名称 和 IP地址 都存在变动的可能性，因此无法适配此种场景需求。</p><p>因此，StatefulSet（有副本状态集）则是专门用来满足此类应用的控制器类型，由其管控的每个 Pod 对象都有着固定的主机名和专用存储卷，即便被重构后亦能保持不变。</p><h2 id="_1-2-statefulset特点" tabindex="-1">1.2 StatefulSet特点 <a class="header-anchor" href="#_1-2-statefulset特点" aria-label="Permalink to &quot;1.2 StatefulSet特点&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">1.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">稳定且唯一的网络标识符</span></span>
<span class="line"><span style="color:#B392F0;">2.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">稳定且持久的存储.</span></span>
<span class="line"><span style="color:#B392F0;">3.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">有序、平滑地部署和扩展.</span></span>
<span class="line"><span style="color:#B392F0;">4.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">有序、平滑的删除和终止.</span></span>
<span class="line"><span style="color:#B392F0;">5.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">有序的滚动更新</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">1.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">稳定且唯一的网络标识符</span></span>
<span class="line"><span style="color:#6F42C1;">2.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">稳定且持久的存储.</span></span>
<span class="line"><span style="color:#6F42C1;">3.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">有序、平滑地部署和扩展.</span></span>
<span class="line"><span style="color:#6F42C1;">4.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">有序、平滑的删除和终止.</span></span>
<span class="line"><span style="color:#6F42C1;">5.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">有序的滚动更新</span></span></code></pre></div><p>1.（StatefulSet提供稳定的Pod名称，结合HeadLessService提供Pod唯⼀的DNS标识）</p><p>2.为每个Pod提供⼀个PVC，作为后端的存储，Pod故障重新启动任然会使⽤此前的PVC</p><p>3.⽐如redis主从复制r1-r6，⼀般先启动主节点r1，⽽后启动从节点r2-r6</p><p>4.⽐如redis主从复制r1-r6，⼀般先从r6-r2从节点开始删除，最后删除r1主节点</p><p>5.⽐如Redis主从复制r1-r6，⼀般先更新r2-r6从节点，⽽后更新r1主节点，前提是能兼容</p><p>在上⾯描述中，“稳定的”意味着 Pod 调度或重调度的整个过程是有持久性的（名称不变、pvc不变）。如果应⽤程序不需要任何稳定的标识符或有序的部署以及删除，则应该使⽤⽆状态的副本控制器来部署应⽤程序，⽐如Deployment或者ReplicaSet</p><h2 id="_1-3-statefulset资源状态" tabindex="-1">1.3 StatefulSet资源状态 <a class="header-anchor" href="#_1-3-statefulset资源状态" aria-label="Permalink to &quot;1.3 StatefulSet资源状态&quot;">​</a></h2><p>StatefulSet 资源的状态主要包括以下几个方面:</p><ol><li>Replicas: 指定的副本数,即 .spec.replicas字段的值。表示 StatefulSet 管理的副本数量。</li><li>ReadyReplicas: 表示已经就绪的副本数量,即当前运行且已经READY的Pod数。</li><li>CurrentReplicas: 表示当前正在运行的副本数量,即运行中的Pod总数。</li><li>UpdatedReplicas: 表示已经更新的副本数量,即最近一次更新中,更新成功的Pod数。</li><li>CurrentRevision: 当前正在执行的修订版本号。</li><li>UpdateRevision: StatefulSet 的当前修订版本号。 StatefulSet 的模板(.spec.template)每次更新时,这个值就会增加1</li><li>collisionCount：表示在创建 Pod 时发生的命名冲突的次数。</li><li>UpdateStatus: 最近一次更新的状态,可以是&quot;Running&quot;或者&quot;Failed&quot;。</li><li>ObservedGeneration: 最近一次对 StatefulSet 资源的更改,已经被看到的 Generation 数。也就是说如果 StatefulSet 的 .spec 字段被修改,该值会更新。</li></ol><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#85E89D;">status</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">observedGeneration</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">readyReplicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">currentReplicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">updatedReplicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">updateRevision</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;2&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">currentRevision</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;2&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#9ECBFF;">observedGeneration 是 2,表示 StatefulSet 的 .spec 字段已经修改过两次。</span></span>
<span class="line"><span style="color:#9ECBFF;">replicas 是 3,表示指定的副本数为 3。</span></span>
<span class="line"><span style="color:#9ECBFF;">readyReplicas, currentReplicas 和 updatedReplicas 都是 3,表示所有的 3 个副本都已经准备就绪。</span></span>
<span class="line"><span style="color:#9ECBFF;">updateRevision 和 currentRevision 都是 &quot;2&quot;,表示 StatefulSet 的模板已经更新两次,当前正在运行的也是第 2 个版本。</span></span>
<span class="line"><span style="color:#9ECBFF;">updateStatus 没有出现,表示最近一次更新状态是正常的。</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> </span><span style="color:#22863A;">status</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">observedGeneration</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">readyReplicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">currentReplicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">updatedReplicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">updateRevision</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;2&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">currentRevision</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;2&quot;</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#032F62;">observedGeneration 是 2,表示 StatefulSet 的 .spec 字段已经修改过两次。</span></span>
<span class="line"><span style="color:#032F62;">replicas 是 3,表示指定的副本数为 3。</span></span>
<span class="line"><span style="color:#032F62;">readyReplicas, currentReplicas 和 updatedReplicas 都是 3,表示所有的 3 个副本都已经准备就绪。</span></span>
<span class="line"><span style="color:#032F62;">updateRevision 和 currentRevision 都是 &quot;2&quot;,表示 StatefulSet 的模板已经更新两次,当前正在运行的也是第 2 个版本。</span></span>
<span class="line"><span style="color:#032F62;">updateStatus 没有出现,表示最近一次更新状态是正常的。</span></span></code></pre></div><h2 id="_1-4-statefulset组成部分" tabindex="-1">1.4 StatefulSet组成部分 <a class="header-anchor" href="#_1-4-statefulset组成部分" aria-label="Permalink to &quot;1.4 StatefulSet组成部分&quot;">​</a></h2><p>StatefulSet由三个组件组成：<code>HeadLessService</code>、<code>StateFulSet控制器</code>、<code>VolumeClaimTemplate</code></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406051822414.png" alt="image-20240605182154021"></p><h3 id="statefulset控制器" tabindex="-1">StatefulSet控制器 <a class="header-anchor" href="#statefulset控制器" aria-label="Permalink to &quot;StatefulSet控制器&quot;">​</a></h3><p>StatefulSet名称是固定，且创建时按照顺序进⾏创建，并固定对应的Pod名称</p><h3 id="headless-service" tabindex="-1">Headless Service <a class="header-anchor" href="#headless-service" aria-label="Permalink to &quot;Headless Service&quot;">​</a></h3><p>用于为Pod资源标识符生成可解析的DNS记录</p><h4 id="为什么要有headless" tabindex="-1">为什么要有headless <a class="header-anchor" href="#为什么要有headless" aria-label="Permalink to &quot;为什么要有headless&quot;">​</a></h4><p>在deployment中，每一个pod是没有名称，是随机字符串，是无序的。而statefulset中是要求有序的，每一个pod的名称必须是固定的。当节点挂了，重建之后的标识符是不变的，每一个节点的节点名称是不能改变的。pod名称是作为pod识别的唯一标识符，必须保证其标识符的稳定并且唯一。     为了实现标识符的稳定，这时候就需要一个headless service 解析直达到pod，还需要给pod配置一个唯一的名称。</p><h4 id="headless-使用场景" tabindex="-1">headless 使用场景 <a class="header-anchor" href="#headless-使用场景" aria-label="Permalink to &quot;headless 使用场景&quot;">​</a></h4><p>集群内部通信：Headless Service可以被用来实现Pod之间的直接通信，例如数据库集群中的各个节点之间的通信。</p><p>分布式计算：Headless Service可以被用来实现<code>分布式计算</code>中的任务分发和结果收集，例如MapReduce中的Map和Reduce节点之间的通信。</p><p>自定义服务发现：Headless Service可以被用来实现一些自定义的服务发现机制，例如一些复杂的应用程序中的服务发现和路由。</p><h4 id="headless-和-service对比" tabindex="-1">Headless 和 Service对比 <a class="header-anchor" href="#headless-和-service对比" aria-label="Permalink to &quot;Headless 和 Service对比&quot;">​</a></h4><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406061116195.png" alt="image-20240606111619188"></p><p>⽤来配置每个Pod的DNS名称，只要Pod的名称不变化，他们的DNS就是稳定且持久的</p><p>Headless Service是没有Cluster IP的Service（与普通Service的区别），在Headless Service中可以看到spec.ClusterIP=None。</p><p>若解析Headless Service的DNS域名，返回的是该Service对应的全部pod的Endpoint列表，StatefulSet在Headless Service基础上为StatefulSet控制的每个pod实例创建DNS域名，格式为$(pod_name).$(headless_service_name)，全限定域名为：FQDN：$(pod_name).$(headless_service_name).$(namespace_name).svc.cluster.local</p><h4 id="案例" tabindex="-1">案例 <a class="header-anchor" href="#案例" aria-label="Permalink to &quot;案例&quot;">​</a></h4><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#资源类型</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">clusterIP</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">None</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 为none，</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#资源类型</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">web</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">clusterIP</span><span style="color:#24292E;">: </span><span style="color:#032F62;">None</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 为none，</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span></code></pre></div><p>这个 Service 被创建后并不会被分配一个 VIP，而是会以 DNS 记录的方式暴露出它所代理的 Pod格式为</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">&lt;pod-name&gt;.&lt;svc-name&gt;.&lt;namespace&gt;.svc.cluster.local</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">&lt;pod-name&gt;.&lt;svc-name&gt;.&lt;namespace&gt;.svc.cluster.local</span></span></code></pre></div><h3 id="volumeclaimtemplate" tabindex="-1">VolumeClaimTemplate <a class="header-anchor" href="#volumeclaimtemplate" aria-label="Permalink to &quot;VolumeClaimTemplate&quot;">​</a></h3><p>作为分布式系统，每个Pod的数据是不⼀样的，所以每个Pod应该有⾃⼰的专有数据，所以他们不能使⽤同⼀个存储卷，应该使⽤各⾃⾃⼰的存储卷。(存储卷申请模板)</p><h4 id="为什么要-有volumeclaintemplate" tabindex="-1">为什么要 有volumeClainTemplate <a class="header-anchor" href="#为什么要-有volumeclaintemplate" aria-label="Permalink to &quot;为什么要 有volumeClainTemplate&quot;">​</a></h4><p>大部分有状态副本集都会用到持久存储，比如分布式系统来说，由于数据是不一样的，每个节点都需要自己专用的存储节点。而在deployment中pod模板中创建的存储卷是<code>一个共享的存储卷</code>，多个pod使用同一个存储卷，而statefulset定义中的每一个pod都不能使用同一个存储卷，由此基于pod模板创建pod是不适应的，这就需要引入volumeClainTemplate，当在使用statefulset创建pod时，会自动生成一个PVC，从而请求绑定一个PV，从而有自己专用的存储卷。</p><h2 id="_1-4-statefulset更新策略" tabindex="-1">1.4 StatefulSet更新策略 <a class="header-anchor" href="#_1-4-statefulset更新策略" aria-label="Permalink to &quot;1.4 StatefulSet更新策略&quot;">​</a></h2><p>Kubernetes 1.7 版本起，StatefulSet 资源支持自动更新机制，其更新策略由 spec.updateStrategy 字段定义，默认为 RollingUpdate，即滚动更新</p><p>StatefulSet 的更新⽀持两种策略：<code>onDelete</code> 和<code>RollingUpdate</code>，在.spec.updateStrategy 进⾏设定.并且滚动更新支持<code>分区</code>滚动更新</p><h3 id="rollingupdate滚动更新" tabindex="-1">RollingUpdate滚动更新 <a class="header-anchor" href="#rollingupdate滚动更新" aria-label="Permalink to &quot;RollingUpdate滚动更新&quot;">​</a></h3><blockquote><p>RollingUpdate 更新策略在 StatefulSet 中实现 Pod 的自动滚动更新。</p><p>当StatefulSet的 .spec.updateStrategy.type 设置为 RollingUpdate 时，默认为：RollingUpdate。</p><p>StatefulSet 控制器将在 StatefulSet 中删除并重新创建每个 Pod。 它将以与 Pod 终止相同的顺序进行（从最大的序数到最小的序数），每次更新一个 Pod。 在更新其前身之前，它将等待正在更新的 Pod 状态变成正在运行并就绪。</p></blockquote><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#默认更新策略RollingUpdate</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">updateStrategy:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">rollingUpdate:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">partition:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">#不更新小于 N 的副本</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">RollingUpdate</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#默认更新策略RollingUpdate</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">updateStrategy:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">rollingUpdate:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">partition:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">       </span><span style="color:#6A737D;">#不更新小于 N 的副本</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RollingUpdate</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#命令跟踪 StatefulSet 资源滚动更新过程中的状态信息</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rollout</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">status</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#命令跟踪 StatefulSet 资源滚动更新过程中的状态信息</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rollout</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span></span></code></pre></div><h3 id="ondelete更新" tabindex="-1">OnDelete更新 <a class="header-anchor" href="#ondelete更新" aria-label="Permalink to &quot;OnDelete更新&quot;">​</a></h3><p>当 StatefulSet 的 <code>.spec.updateStrategy.type</code> 设置为<code>OnDelete</code> 时， 控制器将不会⾃动更新 StatefulSet 中的 Pod。⽤户必须⼿动删除 Pod 以便让控制器创建新的 Pod，以此来对StatefulSet 的 <code>.spec.template</code> 的变动作出反应。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">修改：</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">updateStrategy:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">rollingUpdate:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">partition:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">RollingUpdate</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">改为:</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">updateStrategy:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">OnDelete</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">#修改为OnDelete更新模式并保存，该更新策略是，删除时才会进行更新</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">修改：</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">updateStrategy:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">rollingUpdate:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">partition:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RollingUpdate</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">改为:</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">updateStrategy:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">OnDelete</span><span style="color:#24292E;">   </span><span style="color:#6A737D;">#修改为OnDelete更新模式并保存，该更新策略是，删除时才会进行更新</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">💡 总结</p><p>StatefulSet 这个控制器的主要作用之一，就是使用 Pod 模板创建 Pod 的时候，对它们进行编号，并且按照编号顺序逐一完成创建工作。而当 StatefulSet 的“控制循环”发现 Pod 的“实际状态”与“期望状态”不一致，需要新建或者删除 Pod 进行“调谐”的时候，它会严格按照这些 Pod 编号的顺序，逐一完成这些操作.</p><p>在StatefulSet中，每个Pod都会被分配一个唯一的标识符和DNS记录，例如web-0.web.default.svc.cluster.local、web-1.web.default.svc.cluster.local等</p></div><h2 id="_1-5-暂存更新操作" tabindex="-1">1.5 暂存更新操作 <a class="header-anchor" href="#_1-5-暂存更新操作" aria-label="Permalink to &quot;1.5 暂存更新操作&quot;">​</a></h2><p>当用户需要设定一个更新操作，但又不希望它立即执行时，可将更新操作予以 &quot;暂存&quot;，待条件满足后再手动触发其执行更新。</p><p>StatefulSet 资源的分区更新机制能够实现此项功能。在设定更新操作之前，将.spec.updateStrategy.rollingUpdate.partition 字段的值设置为 Pod 资源的副本数量，即比 Pod 资源的最大索引号大 1，这就意味着，所有的 Pod 资源都不会处于可直接更新的分区之内，那么于其后设定的更新操作也就不会真正执行，直到用户降低分区编号至现有 Pod 资源索引号范围之内。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看帮助</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">explain</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">statefulset.spec.updateStrategy.rollingUpdate.partition</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看帮助</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">explain</span><span style="color:#24292E;"> </span><span style="color:#032F62;">statefulset.spec.updateStrategy.rollingUpdate.partition</span></span></code></pre></div><p>下面测试滚动更新暂存更新操作，首先将 StatefulSet 资源滚动更新分区值设定为 3：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl patch statefulset myapp -p &#39;{&quot;spec&quot;:{&quot;updateStrategy&quot;:{&quot;rollingUpdate&quot;:{&quot;partition&quot;:3}}}}&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl patch statefulset myapp -p &#39;{&quot;spec&quot;:{&quot;updateStrategy&quot;:{&quot;rollingUpdate&quot;:{&quot;partition&quot;:3}}}}&#39;</span></span></code></pre></div><p>暂存状态的更新操作对所有的 Pod 资源均不产生影响，比如即使删除某 Pod 资源，它依然会基于旧的版本镜像进行重建</p><h1 id="_2-案例" tabindex="-1">2. 案例 <a class="header-anchor" href="#_2-案例" aria-label="Permalink to &quot;2. 案例&quot;">​</a></h1><div class="warning custom-block"><p class="custom-block-title">💡 说明</p><p>创建顺序如下：</p><p>1、Volume</p><p>2、Persistent Volume</p><p>3、Persistent Volume Claim</p><p>4、Headless Service</p><p>5、StatefulSet</p><p>Volume可以有很多种类型，比如nfs、glusterfs,ceph RBD等</p></div><h2 id="_2-1-statefulset资源规范" tabindex="-1">2.1 Statefulset资源规范 <a class="header-anchor" href="#_2-1-statefulset资源规范" aria-label="Permalink to &quot;2.1 Statefulset资源规范&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看帮助</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">explain</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">statefulset</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master statefulSet]# kubectl explain statefulset.spec</span></span>
<span class="line"><span style="color:#B392F0;">KIND:</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">StatefulSet</span></span>
<span class="line"><span style="color:#B392F0;">VERSION:</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">RESOURCE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">spec</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">Objec</span><span style="color:#E1E4E8;">t</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">DESCRIPTION:</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">Spec</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">defines</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">desired</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">identities</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">of</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pods</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">this</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">A</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">StatefulSetSpec</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">specification</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">of</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">a</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">StatefulSet.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">FIELDS:</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">podManagementPolicy</span><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">strin</span><span style="color:#E1E4E8;">g</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#Pod管理策略</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">replicas</span><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">intege</span><span style="color:#E1E4E8;">r</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">#副本数量</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">revisionHistoryLimit</span><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">intege</span><span style="color:#E1E4E8;">r</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">#历史版本限制</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">selector</span><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">Objec</span><span style="color:#E1E4E8;">t</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-required-</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">#选择器，必选项</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">serviceName</span><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">strin</span><span style="color:#E1E4E8;">g</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-required-</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#服务名称，必选项</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">template</span><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">Objec</span><span style="color:#E1E4E8;">t</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-required-</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">#模板，必选项</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">updateStrategy</span><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">Objec</span><span style="color:#E1E4E8;">t</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">#更新策略</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">volumeClaimTemplates</span><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">[]Objec</span><span style="color:#E1E4E8;">t</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">#存储卷申请模板，列表对象形式</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看帮助</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">explain</span><span style="color:#24292E;"> </span><span style="color:#032F62;">statefulset</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master statefulSet]# kubectl explain statefulset.spec</span></span>
<span class="line"><span style="color:#6F42C1;">KIND:</span><span style="color:#24292E;">     </span><span style="color:#032F62;">StatefulSet</span></span>
<span class="line"><span style="color:#6F42C1;">VERSION:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">RESOURCE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">spec</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">Objec</span><span style="color:#24292E;">t</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">DESCRIPTION:</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#6F42C1;">Spec</span><span style="color:#24292E;"> </span><span style="color:#032F62;">defines</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">desired</span><span style="color:#24292E;"> </span><span style="color:#032F62;">identities</span><span style="color:#24292E;"> </span><span style="color:#032F62;">of</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pods</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">this</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#6F42C1;">A</span><span style="color:#24292E;"> </span><span style="color:#032F62;">StatefulSetSpec</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">specification</span><span style="color:#24292E;"> </span><span style="color:#032F62;">of</span><span style="color:#24292E;"> </span><span style="color:#032F62;">a</span><span style="color:#24292E;"> </span><span style="color:#032F62;">StatefulSet.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">FIELDS:</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">podManagementPolicy</span><span style="color:#24292E;">	</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">strin</span><span style="color:#24292E;">g</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">#Pod管理策略</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">replicas</span><span style="color:#24292E;">	</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">intege</span><span style="color:#24292E;">r</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">    </span><span style="color:#6A737D;">#副本数量</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">revisionHistoryLimit</span><span style="color:#24292E;">	</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">intege</span><span style="color:#24292E;">r</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#6A737D;">#历史版本限制</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">selector</span><span style="color:#24292E;">	</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">Objec</span><span style="color:#24292E;">t</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-required-</span><span style="color:#24292E;">    </span><span style="color:#6A737D;">#选择器，必选项</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">serviceName</span><span style="color:#24292E;">	</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">strin</span><span style="color:#24292E;">g</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-required-</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">#服务名称，必选项</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">template</span><span style="color:#24292E;">	</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">Objec</span><span style="color:#24292E;">t</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-required-</span><span style="color:#24292E;">    </span><span style="color:#6A737D;">#模板，必选项</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">updateStrategy</span><span style="color:#24292E;">	</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">Objec</span><span style="color:#24292E;">t</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">       </span><span style="color:#6A737D;">#更新策略</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">volumeClaimTemplates</span><span style="color:#24292E;">	</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">[]Objec</span><span style="color:#24292E;">t</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#6A737D;">#存储卷申请模板，列表对象形式</span></span></code></pre></div><h2 id="_2-2-创建headless" tabindex="-1">2.2 创建Headless <a class="header-anchor" href="#_2-2-创建headless" aria-label="Permalink to &quot;2.2 创建Headless&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master statefulSet</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat 01-web-headless.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web-svc</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#这里要创建statefulset 里面的serviceName的名字保持一致</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">my-app</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">clusterIP</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">None</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master statefulSet</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat 01-web-headless.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">web-svc</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">#这里要创建statefulset 里面的serviceName的名字保持一致</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">my-app</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">clusterIP</span><span style="color:#24292E;">: </span><span style="color:#032F62;">None</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><ul><li>执行</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master statefulSet</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl apply -f 01-web-headless.yaml</span></span>
<span class="line"><span style="color:#9ECBFF;">service/my-service-headless created</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master statefulSet</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl apply -f 01-web-headless.yaml</span></span>
<span class="line"><span style="color:#032F62;">service/my-service-headless created</span></span></code></pre></div><h2 id="_2-3-创建statefulset服务" tabindex="-1">2.3 创建StatefulSet服务 <a class="header-anchor" href="#_2-3-创建statefulset服务" aria-label="Permalink to &quot;2.3 创建StatefulSet服务&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master statefulSet</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat 2-web-statefulset.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">StatefulSet</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">my-app</span><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">#必须匹配 .spec.template.metadata.labels</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">serviceName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web-svc</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">#声明它属于哪个Headless Service.</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">my-app</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">my-app-web-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx:1.16</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">my-app-web-vol</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/usr/share/nginx/html</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">volumeClaimTemplates</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">my-app-web-vol</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">accessModes</span><span style="color:#E1E4E8;">: [ </span><span style="color:#9ECBFF;">&quot;ReadWriteOnce&quot;</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">storageClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;nfs-provisioner-storage&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">requests</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">storage</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">1Gi</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master statefulSet</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat 2-web-statefulset.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">StatefulSet</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">web</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">my-app</span><span style="color:#24292E;">        </span><span style="color:#6A737D;">#必须匹配 .spec.template.metadata.labels</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">serviceName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">web-svc</span><span style="color:#24292E;">   </span><span style="color:#6A737D;">#声明它属于哪个Headless Service.</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">my-app</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">my-app-web-nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.16</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">my-app-web-vol</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/usr/share/nginx/html</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">volumeClaimTemplates</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">my-app-web-vol</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">accessModes</span><span style="color:#24292E;">: [ </span><span style="color:#032F62;">&quot;ReadWriteOnce&quot;</span><span style="color:#24292E;"> ]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">storageClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;nfs-provisioner-storage&quot;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">storage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">1Gi</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>定义 StatefulSet 资源时，spec 中必须要嵌套的字段为 &quot;serviceName&quot; 和 &quot;template&quot;，用于指定关联的 Headless Service 和要使用的 Pod 模板</p></div><ul><li>查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get pod</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                      </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">web-0</span><span style="color:#E1E4E8;">                                     </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> (13m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)     19m</span></span>
<span class="line"><span style="color:#B392F0;">web-1</span><span style="color:#E1E4E8;">                                     </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> (12m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)     19m</span></span>
<span class="line"><span style="color:#B392F0;">web-2</span><span style="color:#E1E4E8;">                                     </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> (12m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)     19m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master statefulSet]# kubectl get pvc,pv</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                                   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">VOLUME</span><span style="color:#E1E4E8;">                                     </span><span style="color:#9ECBFF;">CAPACITY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">ACCESS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MODES</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STORAGECLASS</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">persistentvolumeclaim/my-app-web-vol-myapp-web-sts-0</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Bound</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">pvc-0aad5ba3-1921-4772-a410-44ab7239523e</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">Gi</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">RWO</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">nfs-provisioner-storage</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">82</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">persistentvolumeclaim/my-app-web-vol-myapp-web-sts-1</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Bound</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">pvc-1348f5f1-1505-49fd-aa33-f251ef8ffc00</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">Gi</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">RWO</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">nfs-provisioner-storage</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">17</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">persistentvolumeclaim/my-app-web-vol-myapp-web-sts-2</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Bound</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">pvc-7d8f415d-3ebe-49f9-9910-8f3ef36bba57</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">Gi</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">RWO</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">nfs-provisioner-storage</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">15</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                                        </span><span style="color:#9ECBFF;">CAPACITY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">ACCESS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MODES</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">RECLAIM</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">POLICY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">CLAIM</span><span style="color:#E1E4E8;">                   </span><span style="color:#9ECBFF;">STORAGECLASS</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">REASON</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">persistentvolume/pvc-0aad5ba3-1921-4772-a410-44ab7239523e</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">Gi</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">RWO</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">Delete</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">Bound</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">default/my-app-web-vol-myapp-web-sts-0</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">nfs-provisioner-storage</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">82</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">persistentvolume/pvc-1348f5f1-1505-49fd-aa33-f251ef8ffc00</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">Gi</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">RWO</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">Delete</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">Bound</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">default/my-app-web-vol-myapp-web-sts-1</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">nfs-provisioner-storage</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">17</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">persistentvolume/pvc-7d8f415d-3ebe-49f9-9910-8f3ef36bba57</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">Gi</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">RWO</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">Delete</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">Bound</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">default/my-app-web-vol-myapp-web-sts-2</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">nfs-provisioner-storage</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">15</span><span style="color:#9ECBFF;">m</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pod</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                      </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">        </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">web-0</span><span style="color:#24292E;">                                     </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> (13m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)     19m</span></span>
<span class="line"><span style="color:#6F42C1;">web-1</span><span style="color:#24292E;">                                     </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> (12m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)     19m</span></span>
<span class="line"><span style="color:#6F42C1;">web-2</span><span style="color:#24292E;">                                     </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> (12m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)     19m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master statefulSet]# kubectl get pvc,pv</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                                   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">VOLUME</span><span style="color:#24292E;">                                     </span><span style="color:#032F62;">CAPACITY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ACCESS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MODES</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STORAGECLASS</span><span style="color:#24292E;">              </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">persistentvolumeclaim/my-app-web-vol-myapp-web-sts-0</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">pvc-0aad5ba3-1921-4772-a410-44ab7239523e</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWO</span><span style="color:#24292E;">            </span><span style="color:#032F62;">nfs-provisioner-storage</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">82</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">persistentvolumeclaim/my-app-web-vol-myapp-web-sts-1</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">pvc-1348f5f1-1505-49fd-aa33-f251ef8ffc00</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWO</span><span style="color:#24292E;">            </span><span style="color:#032F62;">nfs-provisioner-storage</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">17</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">persistentvolumeclaim/my-app-web-vol-myapp-web-sts-2</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">pvc-7d8f415d-3ebe-49f9-9910-8f3ef36bba57</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWO</span><span style="color:#24292E;">            </span><span style="color:#032F62;">nfs-provisioner-storage</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">15</span><span style="color:#032F62;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                                        </span><span style="color:#032F62;">CAPACITY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ACCESS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MODES</span><span style="color:#24292E;">   </span><span style="color:#032F62;">RECLAIM</span><span style="color:#24292E;"> </span><span style="color:#032F62;">POLICY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CLAIM</span><span style="color:#24292E;">                   </span><span style="color:#032F62;">STORAGECLASS</span><span style="color:#24292E;">              </span><span style="color:#032F62;">REASON</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">persistentvolume/pvc-0aad5ba3-1921-4772-a410-44ab7239523e</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWO</span><span style="color:#24292E;">            </span><span style="color:#032F62;">Delete</span><span style="color:#24292E;">           </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">default/my-app-web-vol-myapp-web-sts-0</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nfs-provisioner-storage</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">82</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">persistentvolume/pvc-1348f5f1-1505-49fd-aa33-f251ef8ffc00</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWO</span><span style="color:#24292E;">            </span><span style="color:#032F62;">Delete</span><span style="color:#24292E;">           </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">default/my-app-web-vol-myapp-web-sts-1</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nfs-provisioner-storage</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">17</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">persistentvolume/pvc-7d8f415d-3ebe-49f9-9910-8f3ef36bba57</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">Gi</span><span style="color:#24292E;">        </span><span style="color:#032F62;">RWO</span><span style="color:#24292E;">            </span><span style="color:#032F62;">Delete</span><span style="color:#24292E;">           </span><span style="color:#032F62;">Bound</span><span style="color:#24292E;">    </span><span style="color:#032F62;">default/my-app-web-vol-myapp-web-sts-2</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nfs-provisioner-storage</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">15</span><span style="color:#032F62;">m</span></span></code></pre></div><h2 id="_2-4-测试dns解析" tabindex="-1">2.4 测试dns解析 <a class="header-anchor" href="#_2-4-测试dns解析" aria-label="Permalink to &quot;2.4 测试dns解析&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">测试格式,$(pod_name</span><span style="color:#E1E4E8;">).</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">headless_service_name</span><span style="color:#9ECBFF;">)</span><span style="color:#E1E4E8;">.</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">namespace_name</span><span style="color:#9ECBFF;">)</span><span style="color:#E1E4E8;">.svc.cluster.local</span></span>
<span class="line"><span style="color:#B392F0;">也可以简写为,$(pod_name</span><span style="color:#E1E4E8;">).</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">headless_service_name</span><span style="color:#9ECBFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-it</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--image=busybox:1.28.3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dns-test</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--restart=Never</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--rm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/bin/sh</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># nslookup web-1.web-svc</span></span>
<span class="line"><span style="color:#B392F0;">Server:</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.0.10</span></span>
<span class="line"><span style="color:#B392F0;">Address</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.0.10</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Name:</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">web-1.web-svc</span></span>
<span class="line"><span style="color:#B392F0;">Address</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.17</span><span style="color:#9ECBFF;">.74.114</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">web-1.web-svc.default.svc.cluster.local</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">测试格式,$(pod_name</span><span style="color:#24292E;">).</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">headless_service_name</span><span style="color:#032F62;">)</span><span style="color:#24292E;">.</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">namespace_name</span><span style="color:#032F62;">)</span><span style="color:#24292E;">.svc.cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">也可以简写为,$(pod_name</span><span style="color:#24292E;">).</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">headless_service_name</span><span style="color:#032F62;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-it</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--image=busybox:1.28.3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dns-test</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--restart=Never</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--rm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/bin/sh</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">/</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># nslookup web-1.web-svc</span></span>
<span class="line"><span style="color:#6F42C1;">Server:</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.0.10</span></span>
<span class="line"><span style="color:#6F42C1;">Address</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.0.10</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">      </span><span style="color:#032F62;">web-1.web-svc</span></span>
<span class="line"><span style="color:#6F42C1;">Address</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.17</span><span style="color:#032F62;">.74.114</span><span style="color:#24292E;"> </span><span style="color:#032F62;">web-1.web-svc.default.svc.cluster.local</span></span></code></pre></div><ul><li>删除pod</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master statefulSet]# kubectl get pod -owide -l app=my-app</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">IP</span><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">NOMINATED</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">READINESS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GATES</span></span>
<span class="line"><span style="color:#B392F0;">web-0</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">m58s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.30</span><span style="color:#9ECBFF;">.0.148</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">kube-node01</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">web-1</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">m56s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.17</span><span style="color:#9ECBFF;">.74.117</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">kube-node03</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">web-2</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">m54s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.23</span><span style="color:#9ECBFF;">.127.102</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">kube-node02</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master statefulSet]# kubectl delete pod -l app=my-app</span></span>
<span class="line"><span style="color:#B392F0;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;web-0&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deleted</span></span>
<span class="line"><span style="color:#B392F0;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;web-1&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deleted</span></span>
<span class="line"><span style="color:#B392F0;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;web-2&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deleted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master statefulSet]# kubectl get pod -owide -l app=my-app</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">IP</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">NOMINATED</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">READINESS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GATES</span></span>
<span class="line"><span style="color:#B392F0;">web-0</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">6</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">172.30</span><span style="color:#9ECBFF;">.0.176</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">kube-node01</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">web-1</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">172.17</span><span style="color:#9ECBFF;">.74.115</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">kube-node03</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">web-2</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">172.23</span><span style="color:#9ECBFF;">.127.87</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">kube-node02</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master statefulSet]# kubectl get pod -owide -l app=my-app</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">    </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">     </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">               </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">          </span><span style="color:#032F62;">NOMINATED</span><span style="color:#24292E;"> </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READINESS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GATES</span></span>
<span class="line"><span style="color:#6F42C1;">web-0</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m58s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.30</span><span style="color:#032F62;">.0.148</span><span style="color:#24292E;">     </span><span style="color:#032F62;">kube-node01</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">web-1</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m56s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.17</span><span style="color:#032F62;">.74.117</span><span style="color:#24292E;">    </span><span style="color:#032F62;">kube-node03</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">web-2</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m54s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.23</span><span style="color:#032F62;">.127.102</span><span style="color:#24292E;">   </span><span style="color:#032F62;">kube-node02</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master statefulSet]# kubectl delete pod -l app=my-app</span></span>
<span class="line"><span style="color:#6F42C1;">pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;web-0&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deleted</span></span>
<span class="line"><span style="color:#6F42C1;">pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;web-1&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deleted</span></span>
<span class="line"><span style="color:#6F42C1;">pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;web-2&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deleted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master statefulSet]# kubectl get pod -owide -l app=my-app</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">    </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">              </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">          </span><span style="color:#032F62;">NOMINATED</span><span style="color:#24292E;"> </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READINESS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GATES</span></span>
<span class="line"><span style="color:#6F42C1;">web-0</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">s</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">172.30</span><span style="color:#032F62;">.0.176</span><span style="color:#24292E;">    </span><span style="color:#032F62;">kube-node01</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">web-1</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">s</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">172.17</span><span style="color:#032F62;">.74.115</span><span style="color:#24292E;">   </span><span style="color:#032F62;">kube-node03</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">web-2</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">s</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">172.23</span><span style="color:#032F62;">.127.87</span><span style="color:#24292E;">   </span><span style="color:#032F62;">kube-node02</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><p>Pod 的序号、主机名、SRV 条目和记录名称没有改变，但和 Pod 相关联的 IP 地址可能发生了改变 如果你需要查找并连接一个 StatefulSet 的活动成员，你应该查询 Headless Service 的 CNAME和 CNAME 相关联的 SRV 记录只会包含 StatefulSet 中处于 Running 和 Ready 状态的 Pod。</p><h2 id="_2-5-扩缩statefulset" tabindex="-1">2.5 扩缩StatefulSet <a class="header-anchor" href="#_2-5-扩缩statefulset" aria-label="Permalink to &quot;2.5 扩缩StatefulSet&quot;">​</a></h2><p>对 StatefulSet 资源来说，<code>kubectl scale</code> 和 <code>kubectl path</code> 命令均可实现此功能，也可以使用 kubectl edit 命令直接修改其副本，或者在修改配置文件之后，由 Kubectl apply 命令重新声明</p><p>扩展StatefulSet副本数，它则会按照编号⼀个⼀个的顺序创建出来</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl scale statefulset web --replicas=5</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl scale statefulset web --replicas=5</span></span></code></pre></div><p>查看Pod的创建过程，对于包含 N 个 副本的 StatefulSet，当部署 Pod 时，它们是依次创建的，顺序为0..N-1</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-l</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">app=my-app</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-w</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-l</span><span style="color:#24292E;"> </span><span style="color:#032F62;">app=my-app</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-w</span></span></code></pre></div><p>或者</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl patch sts web -p &#39;{&quot;spec&quot;:{&quot;replicas&quot;:4}}&#39; -n nginx-ss  #扩容</span></span>
<span class="line"><span style="color:#e1e4e8;">kubectl patch sts web -p &#39;{&quot;spec&quot;:{&quot;replicas&quot;:2}}&#39; -n nginx-ss  #缩容</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl patch sts web -p &#39;{&quot;spec&quot;:{&quot;replicas&quot;:4}}&#39; -n nginx-ss  #扩容</span></span>
<span class="line"><span style="color:#24292e;">kubectl patch sts web -p &#39;{&quot;spec&quot;:{&quot;replicas&quot;:2}}&#39; -n nginx-ss  #缩容</span></span></code></pre></div><h2 id="_2-6-更新策略和版本升级" tabindex="-1">2.6 更新策略和版本升级 <a class="header-anchor" href="#_2-6-更新策略和版本升级" aria-label="Permalink to &quot;2.6 更新策略和版本升级&quot;">​</a></h2><p>修改更新策略，以partition方式进行更新，更新值为2，只有myapp编号大于等于2的才会进行更新。类似于金丝雀部署方式</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">updateStrategy</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">rollingUpdate:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">partition:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#副本大于设置的值时进行更新，也就是分段更新,这里是大于2的副本更新</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">RollingUpdate</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">updateStrategy</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">rollingUpdate:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">partition:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">#副本大于设置的值时进行更新，也就是分段更新,这里是大于2的副本更新</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RollingUpdate</span></span></code></pre></div><p>partiton是保留几个pod不更新，其他的pod进行更新</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@k8s-master mainfests]# kubectl edit sts web</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">或者</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master mainfests]# kubectl patch sts web -p </span><span style="color:#9ECBFF;">&#39;{&quot;spec&quot;:{&quot;updateStrategy&quot;:{&quot;rollingUpdate&quot;:{&quot;partition&quot;:2}}}}&#39;</span></span>
<span class="line"><span style="color:#B392F0;">statefulset.apps/myapp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patched</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get sts web</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">DESIRED</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">CURRENT</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">myapp</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">h</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl describe sts web</span></span>
<span class="line"><span style="color:#B392F0;">Name:</span><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">myapp</span></span>
<span class="line"><span style="color:#B392F0;">Namespace:</span><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">default</span></span>
<span class="line"><span style="color:#B392F0;">CreationTimestamp:</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Wed,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Oct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2018</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">21</span><span style="color:#9ECBFF;">:58:24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-0400</span></span>
<span class="line"><span style="color:#B392F0;">Selector:</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">app=myapp-pod</span></span>
<span class="line"><span style="color:#B392F0;">Labels:</span><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">Annotations:</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">kubectl.kubernetes.io/last-applied-configuration={&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;StatefulSet&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;myapp&quot;,&quot;namespace&quot;:&quot;default&quot;},&quot;spec&quot;:{&quot;replicas&quot;:3,&quot;selector&quot;:{&quot;match...</span></span>
<span class="line"><span style="color:#9ECBFF;">Replicas:           4 desired | 4 total</span></span>
<span class="line"><span style="color:#9ECBFF;">Update Strategy:    RollingUpdate</span></span>
<span class="line"><span style="color:#9ECBFF;">  Partition:        2</span></span>
<span class="line"><span style="color:#9ECBFF;">......</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@k8s-master mainfests]# kubectl edit sts web</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">或者</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master mainfests]# kubectl patch sts web -p </span><span style="color:#032F62;">&#39;{&quot;spec&quot;:{&quot;updateStrategy&quot;:{&quot;rollingUpdate&quot;:{&quot;partition&quot;:2}}}}&#39;</span></span>
<span class="line"><span style="color:#6F42C1;">statefulset.apps/myapp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patched</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get sts web</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">      </span><span style="color:#032F62;">DESIRED</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CURRENT</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">myapp</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">h</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl describe sts web</span></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">               </span><span style="color:#032F62;">myapp</span></span>
<span class="line"><span style="color:#6F42C1;">Namespace:</span><span style="color:#24292E;">          </span><span style="color:#032F62;">default</span></span>
<span class="line"><span style="color:#6F42C1;">CreationTimestamp:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Wed,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Oct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2018</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">21</span><span style="color:#032F62;">:58:24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-0400</span></span>
<span class="line"><span style="color:#6F42C1;">Selector:</span><span style="color:#24292E;">           </span><span style="color:#032F62;">app=myapp-pod</span></span>
<span class="line"><span style="color:#6F42C1;">Labels:</span><span style="color:#24292E;">             </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Annotations:</span><span style="color:#24292E;">        </span><span style="color:#032F62;">kubectl.kubernetes.io/last-applied-configuration={&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;StatefulSet&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;myapp&quot;,&quot;namespace&quot;:&quot;default&quot;},&quot;spec&quot;:{&quot;replicas&quot;:3,&quot;selector&quot;:{&quot;match...</span></span>
<span class="line"><span style="color:#032F62;">Replicas:           4 desired | 4 total</span></span>
<span class="line"><span style="color:#032F62;">Update Strategy:    RollingUpdate</span></span>
<span class="line"><span style="color:#032F62;">  Partition:        2</span></span>
<span class="line"><span style="color:#032F62;">......</span></span></code></pre></div><p>版本升级，将image的版本升级为v2，升级后对比web-2和web-1的image版本是不同的。这样就实现了金丝雀发布的效果。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@k8s-master mainfests]# kubectl set image sts/web myapp=ikubernetes/myapp:v3</span></span>
<span class="line"><span style="color:#B392F0;">statefulset.apps/myapp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">image</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">updated</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get sts -o wide</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">DESIRED</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">CURRENT</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">CONTAINERS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">IMAGES</span></span>
<span class="line"><span style="color:#B392F0;">web</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">h</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">myapp</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">ikubernetes/myapp:v3</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get pods web-2 -o yaml </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">image</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">image:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ikubernetes/myapp:v3</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">imagePullPolicy:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">image:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ikubernetes/myapp:v3</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">imageID:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker-pullable://ikubernetes/myapp@sha256:b8d74db2515d3c1391c78c5768272b9344428035ef6d72158fd9f6c4239b2c69</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get pods web-1 -o yaml </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">image</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">image:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ikubernetes/myapp:v2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">imagePullPolicy:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">image:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ikubernetes/myapp:v2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">imageID:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker-pullable://ikubernetes/myapp@sha256:85a2b81a62f09a414ea33b74fb8aa686ed9b168294b26b4c819df0be0712d358</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@k8s-master mainfests]# kubectl set image sts/web myapp=ikubernetes/myapp:v3</span></span>
<span class="line"><span style="color:#6F42C1;">statefulset.apps/myapp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">image</span><span style="color:#24292E;"> </span><span style="color:#032F62;">updated</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get sts -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">      </span><span style="color:#032F62;">DESIRED</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CURRENT</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">       </span><span style="color:#032F62;">CONTAINERS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IMAGES</span></span>
<span class="line"><span style="color:#6F42C1;">web</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">h</span><span style="color:#24292E;">        </span><span style="color:#032F62;">myapp</span><span style="color:#24292E;">        </span><span style="color:#032F62;">ikubernetes/myapp:v3</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods web-2 -o yaml </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">image</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">image:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ikubernetes/myapp:v3</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">imagePullPolicy:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">image:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ikubernetes/myapp:v3</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">imageID:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker-pullable://ikubernetes/myapp@sha256:b8d74db2515d3c1391c78c5768272b9344428035ef6d72158fd9f6c4239b2c69</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods web-1 -o yaml </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">image</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">image:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ikubernetes/myapp:v2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">imagePullPolicy:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">image:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ikubernetes/myapp:v2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">imageID:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker-pullable://ikubernetes/myapp@sha256:85a2b81a62f09a414ea33b74fb8aa686ed9b168294b26b4c819df0be0712d358</span></span></code></pre></div><p>将剩余的Pod也更新版本，只需要将更新策略的partition值改为0即可，如下：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@k8s-master mainfests]#  kubectl patch sts web -p </span><span style="color:#9ECBFF;">&#39;{&quot;spec&quot;:{&quot;updateStrategy&quot;:{&quot;rollingUpdate&quot;:{&quot;partition&quot;:0}}}}&#39;</span></span>
<span class="line"><span style="color:#B392F0;">statefulset.apps/web</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patched</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get pods -w</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                     </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">web-0</span><span style="color:#E1E4E8;">                  </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">58</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">web-1</span><span style="color:#E1E4E8;">                  </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">58</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">web-2</span><span style="color:#E1E4E8;">                  </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">13</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">web-3</span><span style="color:#E1E4E8;">                  </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">13</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">web-1</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Terminating</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">58</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">web-1</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Terminating</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">58</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">web-1</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Terminating</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">58</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">web-1</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Terminating</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">58</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">web-1</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Pending</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">web-1</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Pending</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">web-1</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">ContainerCreating</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">web-1</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">web-0</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Terminating</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">58</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">web-0</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Terminating</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">58</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">web-0</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Terminating</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">58</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">web-0</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Terminating</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">58</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">web-0</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Pending</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">web-0</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Pending</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">web-0</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">ContainerCreating</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">web-0</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@k8s-master mainfests]#  kubectl patch sts web -p </span><span style="color:#032F62;">&#39;{&quot;spec&quot;:{&quot;updateStrategy&quot;:{&quot;rollingUpdate&quot;:{&quot;partition&quot;:0}}}}&#39;</span></span>
<span class="line"><span style="color:#6F42C1;">statefulset.apps/web</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patched</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods -w</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                     </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">     </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">web-0</span><span style="color:#24292E;">                  </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">58</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">web-1</span><span style="color:#24292E;">                  </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">58</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">web-2</span><span style="color:#24292E;">                  </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">13</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">web-3</span><span style="color:#24292E;">                  </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">13</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">web-1</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Terminating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">58</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">web-1</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Terminating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">58</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">web-1</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Terminating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">58</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">web-1</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Terminating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">58</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">web-1</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">web-1</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">web-1</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">ContainerCreating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">web-1</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">web-0</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Terminating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">58</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">web-0</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Terminating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">58</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">web-0</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Terminating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">58</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">web-0</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Terminating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">58</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">web-0</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">web-0</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">web-0</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">ContainerCreating</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">web-0</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">       </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">s</span></span></code></pre></div><h2 id="_2-7-删除statefulset" tabindex="-1">2.7 删除StatefulSet <a class="header-anchor" href="#_2-7-删除statefulset" aria-label="Permalink to &quot;2.7 删除StatefulSet&quot;">​</a></h2><p>删除StatefulSet，它会从后往前删除，先删除web-1，然后删除web-0</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">statefulsets</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#032F62;">statefulsets</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name</span></span></code></pre></div><p>删除 Pod 时，它们是逆序终⽌的，顺序为 N-1..0</p><blockquote><p>statefulset删除分为两种</p><p>级联删除[默认] 删除statefulset时删除pod</p><p>非级联删除 删除statefulset时不删除pod</p></blockquote><h3 id="级联删除" tabindex="-1">级联删除 <a class="header-anchor" href="#级联删除" aria-label="Permalink to &quot;级联删除&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">statefulsets</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#032F62;">statefulsets</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name</span></span></code></pre></div><h3 id="非级联删除" tabindex="-1">非级联删除 <a class="header-anchor" href="#非级联删除" aria-label="Permalink to &quot;非级联删除&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[root@kube-master statefulSet]# kubectl delete sts web --cascade=orphan</span></span>
<span class="line"><span style="color:#e1e4e8;">statefulset.apps &quot;web&quot; deleted</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[root@kube-master statefulSet]# kubectl delete sts web --cascade=orphan</span></span>
<span class="line"><span style="color:#24292e;">statefulset.apps &quot;web&quot; deleted</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master statefulSet]# kubectl get pod -l app=my-app</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">web-0</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">58</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">web-1</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">58</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master statefulSet]# kubectl get sts</span></span>
<span class="line"><span style="color:#B392F0;">No</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">resources</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">found</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">default</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">namespace.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master statefulSet]# kubectl get pod -l app=my-app</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">    </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">web-0</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">58</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">web-1</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">58</span><span style="color:#032F62;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master statefulSet]# kubectl get sts</span></span>
<span class="line"><span style="color:#6F42C1;">No</span><span style="color:#24292E;"> </span><span style="color:#032F62;">resources</span><span style="color:#24292E;"> </span><span style="color:#032F62;">found</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">default</span><span style="color:#24292E;"> </span><span style="color:#032F62;">namespace.</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">💡 说明</p><p>非级联删除时，删除了sts 但是pod并未被删除</p><p>kubernetes 1.24以前版本参数 --cascade=false</p><p>kubernetes 1.24以后版本参数 --cascade=orphan</p></div>`,120),e=[o];function t(c,r,y,E,F,i){return a(),n("div",null,e)}const u=s(p,[["render",t]]);export{C as __pageData,u as default};
