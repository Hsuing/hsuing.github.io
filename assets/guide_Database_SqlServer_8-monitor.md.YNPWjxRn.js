import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const d=JSON.parse('{"title":"1.监控","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/SqlServer/8-monitor.md","filePath":"guide/Database/SqlServer/8-monitor.md","lastUpdated":1722954450000}'),p={name:"guide/Database/SqlServer/8-monitor.md"},o=l(`<p>在<strong>监控</strong>页面选择<strong>资源监控</strong>或<strong>引擎监控</strong>，并选择查询时间，即可查看相应的监控数据，具体监控项介绍如下。</p><table><thead><tr><th style="text-align:left;">类别</th><th style="text-align:left;">监控项</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>资源监控</strong></td><td style="text-align:left;">磁盘空间</td><td style="text-align:left;">实例的磁盘空间使用量，包括：磁盘空间总体使用量数据空间使用量日志空间使用量临时文件空间使用量系统文件空间使用量单位：MByte。</td></tr><tr><td style="text-align:left;">IOPS</td><td style="text-align:left;">实例的每秒I/O请求次数。单位：次/秒。</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">当前总连接数</td><td style="text-align:left;">实例当前总连接数。</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">MSSQL实例CPU使用率（占操作系统总数 %）</td><td style="text-align:left;">实例的CPU使用率（含操作系统占用）。</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">SQL Server实例平均每秒钟的输入/流出流量</td><td style="text-align:left;">实例每秒钟的输入、输出流量，单位：KB。<strong>说明</strong> 为了更精确体现SQL Server的网络带宽详情，RDS SQL Server基础版，高可用版和集群版实例直接从Windows网卡中采集流量使用情况。</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;"><strong>引擎监控</strong></td><td style="text-align:left;">平均每秒事务数</td><td style="text-align:left;">每秒钟事务处理数。</td></tr><tr><td style="text-align:left;">平均每秒SQL语句执行次数</td><td style="text-align:left;">每秒钟SQL语句执行次数。</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">缓存命中率</td><td style="text-align:left;">缓存池的读命中率。</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">每秒检查点写入Page数</td><td style="text-align:left;">实例中每秒检查点写入Page数。</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">每秒登录次数</td><td style="text-align:left;">实例中每秒登录次数。</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">平均每秒全表扫描数</td><td style="text-align:left;">每秒全表扫描次数。</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">每秒SQL编译</td><td style="text-align:left;">实例中每秒编译的SQL语句数。</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">每秒锁超时次数</td><td style="text-align:left;">实例中每秒锁超时次数。</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">每秒死锁次数</td><td style="text-align:left;">实例中每秒锁定次数。</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">每秒锁等待次数</td><td style="text-align:left;">实例中每秒锁等待次数。</td><td style="text-align:left;"></td></tr></tbody></table><h1 id="_1-监控" tabindex="-1">1.监控 <a class="header-anchor" href="#_1-监控" aria-label="Permalink to &quot;1.监控&quot;">​</a></h1><h2 id="_1-1数据库连接数" tabindex="-1">1.1数据库连接数 <a class="header-anchor" href="#_1-1数据库连接数" aria-label="Permalink to &quot;1.1数据库连接数&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 使用中的数据库连接数</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> cntr_value </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_performance_counters</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> counter_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;User Connections&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 使用中的数据库连接数</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> cntr_value </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_performance_counters</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> counter_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;User Connections&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="数据库状态" tabindex="-1">数据库状态 <a class="header-anchor" href="#数据库状态" aria-label="Permalink to &quot;数据库状态&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;">, state_desc </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">databases</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">state</span><span style="color:#24292E;">, state_desc </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">databases</span><span style="color:#24292E;">;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141017385.jpg" alt=""></p><h3 id="数据库文件状态" tabindex="-1">数据库文件状态 <a class="header-anchor" href="#数据库文件状态" aria-label="Permalink to &quot;数据库文件状态&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">physical_name</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">state</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">state_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">databases</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> a, </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">master_files</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_id</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">physical_name</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">state</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">state_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">databases</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> a, </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">master_files</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_id</span><span style="color:#24292E;">;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141017253.jpg" alt=""></p><h2 id="_1-2平均每秒事务数tps" tabindex="-1">1.2平均每秒事务数TPS <a class="header-anchor" href="#_1-2平均每秒事务数tps" aria-label="Permalink to &quot;1.2平均每秒事务数TPS&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 平均每秒事务数:</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> cntr_value </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_performance_counters</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> counter_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Transactions/sec&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> instance_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;_Total&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 平均每秒事务数:</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> cntr_value </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_performance_counters</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> counter_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Transactions/sec&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> instance_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;_Total&#39;</span></span></code></pre></div><h2 id="_1-3缓存命中率" tabindex="-1">1.3缓存命中率 <a class="header-anchor" href="#_1-3缓存命中率" aria-label="Permalink to &quot;1.3缓存命中率&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">cntr_value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">cntr_value</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> BufferCacheHitRatio</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_performance_counters</span><span style="color:#E1E4E8;"> a</span></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> cntr_value, OBJECT_NAME</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_performance_counters</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> counter_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Buffer cache hit ratio base&#39;</span></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> OBJECT_NAME </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;SQLServer:Buffer Manager&#39;</span><span style="color:#E1E4E8;">) b </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_NAME</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">counter_name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Buffer cache hit ratio&#39;</span></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;SQLServer:Buffer Manager&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">cntr_value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">cntr_value</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> BufferCacheHitRatio</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_performance_counters</span><span style="color:#24292E;"> a</span></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> cntr_value, OBJECT_NAME</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_performance_counters</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> counter_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Buffer cache hit ratio base&#39;</span></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> OBJECT_NAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;SQLServer:Buffer Manager&#39;</span><span style="color:#24292E;">) b </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_NAME</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">counter_name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Buffer cache hit ratio&#39;</span></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;SQLServer:Buffer Manager&#39;</span></span></code></pre></div><h2 id="_1-3平均每秒sql编译数" tabindex="-1">1.3平均每秒SQL编译数 <a class="header-anchor" href="#_1-3平均每秒sql编译数" aria-label="Permalink to &quot;1.3平均每秒SQL编译数&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> cntr_value </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_performance_counters</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> counter_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;SQL Compilations/sec&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> cntr_value </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_performance_counters</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> counter_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;SQL Compilations/sec&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="平均每秒sql重编译数" tabindex="-1">平均每秒SQL重编译数 <a class="header-anchor" href="#平均每秒sql重编译数" aria-label="Permalink to &quot;平均每秒SQL重编译数&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> cntr_value </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_performance_counters</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> counter_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;SQL Re-Compilations/sec&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> cntr_value </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_performance_counters</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> counter_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;SQL Re-Compilations/sec&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h2 id="_1-4每秒全表扫描数" tabindex="-1">1.4每秒全表扫描数 <a class="header-anchor" href="#_1-4每秒全表扫描数" aria-label="Permalink to &quot;1.4每秒全表扫描数&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 每秒全表扫描数:</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> cntr_value </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_performance_counters</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> counter_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Full Scans/sec&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 每秒全表扫描数:</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> cntr_value </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_performance_counters</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> counter_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Full Scans/sec&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="平均每秒batch数" tabindex="-1">平均每秒batch数 <a class="header-anchor" href="#平均每秒batch数" aria-label="Permalink to &quot;平均每秒batch数&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> cntr_value </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_performance_counters</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> counter_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Batch Requests/sec&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> cntr_value </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_performance_counters</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> counter_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Batch Requests/sec&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="每秒用户错误数" tabindex="-1">每秒用户错误数 <a class="header-anchor" href="#每秒用户错误数" aria-label="Permalink to &quot;每秒用户错误数&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> cntr_value </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_performance_counters</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> counter_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Errors/sec&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> instance_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;_Total&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> cntr_value </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_performance_counters</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> counter_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Errors/sec&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> instance_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;_Total&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h2 id="_1-5锁" tabindex="-1">1.5锁 <a class="header-anchor" href="#_1-5锁" aria-label="Permalink to &quot;1.5锁&quot;">​</a></h2><h3 id="每秒锁等待次数" tabindex="-1">每秒锁等待次数: <a class="header-anchor" href="#每秒锁等待次数" aria-label="Permalink to &quot;每秒锁等待次数:&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> cntr_value </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_performance_counters</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> counter_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Lock Waits/sec&#39;</span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> instance_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;_Total&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> cntr_value </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_performance_counters</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> counter_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Lock Waits/sec&#39;</span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> instance_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;_Total&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="每秒锁请求次数" tabindex="-1">每秒锁请求次数 <a class="header-anchor" href="#每秒锁请求次数" aria-label="Permalink to &quot;每秒锁请求次数&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> cntr_value </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_performance_counters</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> counter_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Lock Requests/sec&#39;</span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> instance_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;_Total&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> cntr_value </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_performance_counters</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> counter_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Lock Requests/sec&#39;</span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> instance_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;_Total&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="每秒锁超时次数" tabindex="-1">每秒锁超时次数 <a class="header-anchor" href="#每秒锁超时次数" aria-label="Permalink to &quot;每秒锁超时次数&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> cntr_value </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_performance_counters</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> counter_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Lock Timeouts/sec&#39;</span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> instance_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;_Total&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> cntr_value </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_performance_counters</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> counter_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Lock Timeouts/sec&#39;</span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> instance_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;_Total&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="每秒死锁次数" tabindex="-1">每秒死锁次数 <a class="header-anchor" href="#每秒死锁次数" aria-label="Permalink to &quot;每秒死锁次数&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> cntr_value </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_performance_counters</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> counter_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Number Of Deadlocks/sec&#39;</span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> instance_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;_Total&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> cntr_value </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_performance_counters</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> counter_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Number Of Deadlocks/sec&#39;</span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> instance_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;_Total&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="查看死锁" tabindex="-1">查看死锁 <a class="header-anchor" href="#查看死锁" aria-label="Permalink to &quot;查看死锁&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--查询死锁</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> request_session_id spid,</span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(resource_associated_entity_id)tableName</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_tran_locks</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> resource_type</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;OBJECT &#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--杀死死锁</span></span>
<span class="line"><span style="color:#F97583;">KILL</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">155</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--显示死锁相关信息</span></span>
<span class="line"><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_who2 </span><span style="color:#79B8FF;">137</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--查询死锁</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> request_session_id spid,</span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(resource_associated_entity_id)tableName</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_tran_locks</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> resource_type</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;OBJECT &#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--杀死死锁</span></span>
<span class="line"><span style="color:#D73A49;">KILL</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">155</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--显示死锁相关信息</span></span>
<span class="line"><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_who2 </span><span style="color:#005CC5;">137</span></span></code></pre></div><h3 id="死锁跟踪" tabindex="-1">死锁跟踪 <a class="header-anchor" href="#死锁跟踪" aria-label="Permalink to &quot;死锁跟踪&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">方法一：SQL code</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">DBCC TRACEON (3605,1204,1222,-1)  </span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">说明：</span></span>
<span class="line"><span style="color:#e1e4e8;">3605 </span></span>
<span class="line"><span style="color:#e1e4e8;">将DBCC的结果输出到错误日志。</span></span>
<span class="line"><span style="color:#e1e4e8;">1204 返回参与死锁的锁的资源和类型，以及受影响的当前命令。</span></span>
<span class="line"><span style="color:#e1e4e8;">1222 </span></span>
<span class="line"><span style="color:#e1e4e8;">返回参与死锁的锁的资源和类型，以及使用了不符合任何 XSD 架构的 XML 格式的受影响的当前命令(比1204更进一步,SQL </span></span>
<span class="line"><span style="color:#e1e4e8;">2005及以上可用)。</span></span>
<span class="line"><span style="color:#e1e4e8;">-1 以全局方式打开指定的跟踪标记。</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">以上跟踪标志作用域都是全局，即在SQL </span></span>
<span class="line"><span style="color:#e1e4e8;">Server运行过程中，会一直发挥作用，直到SQL Server重启。</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">如 果要确保SQL Server在重启后自动开启这些标志，可以在SQL </span></span>
<span class="line"><span style="color:#e1e4e8;">Server服务启动选项中，使用 /T 启动选项指定跟踪标志在启动期</span></span>
<span class="line"><span style="color:#e1e4e8;">间设置为开。(位于SQL Server配置管理器-&gt;SQL </span></span>
<span class="line"><span style="color:#e1e4e8;">Server服务-&gt;SQL Server-&gt;属性-&gt;高级-&gt;启动参数)</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">在运行上面的语句后，当SQL </span></span>
<span class="line"><span style="color:#e1e4e8;">Server中发生死锁时，已经可以在错误日志中看到了，但还不够直观(和其它信息混在一起)。（SSMS</span></span>
<span class="line"><span style="color:#e1e4e8;"> -&gt; SQL Server实例 -&gt; </span></span>
<span class="line"><span style="color:#e1e4e8;">管理 -&gt; SQL Server日志）</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">方法一：SQL code</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">DBCC TRACEON (3605,1204,1222,-1)  </span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">说明：</span></span>
<span class="line"><span style="color:#24292e;">3605 </span></span>
<span class="line"><span style="color:#24292e;">将DBCC的结果输出到错误日志。</span></span>
<span class="line"><span style="color:#24292e;">1204 返回参与死锁的锁的资源和类型，以及受影响的当前命令。</span></span>
<span class="line"><span style="color:#24292e;">1222 </span></span>
<span class="line"><span style="color:#24292e;">返回参与死锁的锁的资源和类型，以及使用了不符合任何 XSD 架构的 XML 格式的受影响的当前命令(比1204更进一步,SQL </span></span>
<span class="line"><span style="color:#24292e;">2005及以上可用)。</span></span>
<span class="line"><span style="color:#24292e;">-1 以全局方式打开指定的跟踪标记。</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">以上跟踪标志作用域都是全局，即在SQL </span></span>
<span class="line"><span style="color:#24292e;">Server运行过程中，会一直发挥作用，直到SQL Server重启。</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">如 果要确保SQL Server在重启后自动开启这些标志，可以在SQL </span></span>
<span class="line"><span style="color:#24292e;">Server服务启动选项中，使用 /T 启动选项指定跟踪标志在启动期</span></span>
<span class="line"><span style="color:#24292e;">间设置为开。(位于SQL Server配置管理器-&gt;SQL </span></span>
<span class="line"><span style="color:#24292e;">Server服务-&gt;SQL Server-&gt;属性-&gt;高级-&gt;启动参数)</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">在运行上面的语句后，当SQL </span></span>
<span class="line"><span style="color:#24292e;">Server中发生死锁时，已经可以在错误日志中看到了，但还不够直观(和其它信息混在一起)。（SSMS</span></span>
<span class="line"><span style="color:#24292e;"> -&gt; SQL Server实例 -&gt; </span></span>
<span class="line"><span style="color:#24292e;">管理 -&gt; SQL Server日志）</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">二扩展事件会话信息</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--扩展事件会话的信息</span></span>
<span class="line"><span style="color:#e1e4e8;">select * from sys.dm_xe_sessions where name = &#39;system_health&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">SELECT </span></span>
<span class="line"><span style="color:#e1e4e8;">	xed.value(&#39;@timestamp&#39;,&#39;datetime&#39;)as Creation_Date,  </span></span>
<span class="line"><span style="color:#e1e4e8;">	xed.query(&#39;.&#39;)AS Extend_Event  </span></span>
<span class="line"><span style="color:#e1e4e8;">FROM </span></span>
<span class="line"><span style="color:#e1e4e8;">(  </span></span>
<span class="line"><span style="color:#e1e4e8;">	SELECT CAST([target_data] AS XML)AS Target_Data  </span></span>
<span class="line"><span style="color:#e1e4e8;">	FROM sys.dm_xe_session_targets AS xt  </span></span>
<span class="line"><span style="color:#e1e4e8;">	INNER JOIN sys.dm_xe_sessions AS xs  </span></span>
<span class="line"><span style="color:#e1e4e8;">	ON xs.address= xt.event_session_address  </span></span>
<span class="line"><span style="color:#e1e4e8;">	WHERE xs.name=N&#39;system_health&#39;  </span></span>
<span class="line"><span style="color:#e1e4e8;">	AND xt.target_name=N&#39;ring_buffer&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">) AS XML_Data  </span></span>
<span class="line"><span style="color:#e1e4e8;">CROSS APPLY Target_Data.nodes(&#39;RingBufferTarget/event[@name=&quot;xml_deadlock_report&quot;]&#39;)AS XEventData(xed)  </span></span>
<span class="line"><span style="color:#e1e4e8;">ORDER BY Creation_Date DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">二扩展事件会话信息</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--扩展事件会话的信息</span></span>
<span class="line"><span style="color:#24292e;">select * from sys.dm_xe_sessions where name = &#39;system_health&#39;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">SELECT </span></span>
<span class="line"><span style="color:#24292e;">	xed.value(&#39;@timestamp&#39;,&#39;datetime&#39;)as Creation_Date,  </span></span>
<span class="line"><span style="color:#24292e;">	xed.query(&#39;.&#39;)AS Extend_Event  </span></span>
<span class="line"><span style="color:#24292e;">FROM </span></span>
<span class="line"><span style="color:#24292e;">(  </span></span>
<span class="line"><span style="color:#24292e;">	SELECT CAST([target_data] AS XML)AS Target_Data  </span></span>
<span class="line"><span style="color:#24292e;">	FROM sys.dm_xe_session_targets AS xt  </span></span>
<span class="line"><span style="color:#24292e;">	INNER JOIN sys.dm_xe_sessions AS xs  </span></span>
<span class="line"><span style="color:#24292e;">	ON xs.address= xt.event_session_address  </span></span>
<span class="line"><span style="color:#24292e;">	WHERE xs.name=N&#39;system_health&#39;  </span></span>
<span class="line"><span style="color:#24292e;">	AND xt.target_name=N&#39;ring_buffer&#39;</span></span>
<span class="line"><span style="color:#24292e;">) AS XML_Data  </span></span>
<span class="line"><span style="color:#24292e;">CROSS APPLY Target_Data.nodes(&#39;RingBufferTarget/event[@name=&quot;xml_deadlock_report&quot;]&#39;)AS XEventData(xed)  </span></span>
<span class="line"><span style="color:#24292e;">ORDER BY Creation_Date DESC</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">方法三：sql perfiler跟踪</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">方法三：sql perfiler跟踪</span></span></code></pre></div><h2 id="_1-6每秒检查点写入page数" tabindex="-1">1.6每秒检查点写入Page数 <a class="header-anchor" href="#_1-6每秒检查点写入page数" aria-label="Permalink to &quot;1.6每秒检查点写入Page数&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> cntr_value </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_performance_counters</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> counter_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Checkpoint pages/sec&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> cntr_value </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_performance_counters</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> counter_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Checkpoint pages/sec&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="lazy-writes-sec" tabindex="-1">Lazy writes/sec: <a class="header-anchor" href="#lazy-writes-sec" aria-label="Permalink to &quot;Lazy writes/sec:&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_performance_counters</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> counter_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Lazy writes/sec&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_performance_counters</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> counter_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Lazy writes/sec&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h2 id="_1-7always-on状态" tabindex="-1">1.7always on状态 <a class="header-anchor" href="#_1-7always-on状态" aria-label="Permalink to &quot;1.7always on状态&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_state</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_state_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">databases</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> a, </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_hadr_database_replica_states</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_local</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_state</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_state_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">databases</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> a, </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_hadr_database_replica_states</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_local</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span></code></pre></div><h2 id="_1-8慢查询" tabindex="-1">1.8慢查询 <a class="header-anchor" href="#_1-8慢查询" aria-label="Permalink to &quot;1.8慢查询&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">---先清除sql server的缓存</span></span>
<span class="line"><span style="color:#E1E4E8;">dbcc freeProcCache</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">---先清除sql server的缓存</span></span>
<span class="line"><span style="color:#24292E;">dbcc freeProcCache</span></span></code></pre></div><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> creation_time </span><span style="color:#9ECBFF;">N&#39;语句编译时间&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">,last_execution_time </span><span style="color:#9ECBFF;">N&#39;上次执行时间&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">,total_physical_reads </span><span style="color:#9ECBFF;">N&#39;物理读取总次数&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">,total_logical_reads</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">execution_count </span><span style="color:#9ECBFF;">N&#39;每次逻辑读次数&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">,total_logical_reads </span><span style="color:#9ECBFF;">N&#39;逻辑读取总次数&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">,total_logical_writes </span><span style="color:#9ECBFF;">N&#39;逻辑写入总次数&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">,execution_count </span><span style="color:#9ECBFF;">N&#39;执行次数&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">,total_worker_time</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;所用的CPU总时间ms&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">,total_elapsed_time</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;总花费时间ms&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">,(total_elapsed_time </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> execution_count)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;平均时间ms&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">st</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">, (</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">((</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> statement_end_offset</span></span>
<span class="line"><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATALENGTH</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">st</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#9ECBFF;">N&#39;执行语句&#39;</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_stats</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> qs</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">) st</span></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">st</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">, (</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">((</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> statement_end_offset</span></span>
<span class="line"><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATALENGTH</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">st</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">like</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;%fetch%&#39;</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> total_elapsed_time </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> execution_count </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> creation_time </span><span style="color:#032F62;">N&#39;语句编译时间&#39;</span></span>
<span class="line"><span style="color:#24292E;">,last_execution_time </span><span style="color:#032F62;">N&#39;上次执行时间&#39;</span></span>
<span class="line"><span style="color:#24292E;">,total_physical_reads </span><span style="color:#032F62;">N&#39;物理读取总次数&#39;</span></span>
<span class="line"><span style="color:#24292E;">,total_logical_reads</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">execution_count </span><span style="color:#032F62;">N&#39;每次逻辑读次数&#39;</span></span>
<span class="line"><span style="color:#24292E;">,total_logical_reads </span><span style="color:#032F62;">N&#39;逻辑读取总次数&#39;</span></span>
<span class="line"><span style="color:#24292E;">,total_logical_writes </span><span style="color:#032F62;">N&#39;逻辑写入总次数&#39;</span></span>
<span class="line"><span style="color:#24292E;">,execution_count </span><span style="color:#032F62;">N&#39;执行次数&#39;</span></span>
<span class="line"><span style="color:#24292E;">,total_worker_time</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;所用的CPU总时间ms&#39;</span></span>
<span class="line"><span style="color:#24292E;">,total_elapsed_time</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;总花费时间ms&#39;</span></span>
<span class="line"><span style="color:#24292E;">,(total_elapsed_time </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> execution_count)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;平均时间ms&#39;</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">st</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">, (</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">((</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> statement_end_offset</span></span>
<span class="line"><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATALENGTH</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">st</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#032F62;">N&#39;执行语句&#39;</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_stats</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> qs</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">) st</span></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">st</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">, (</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">((</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> statement_end_offset</span></span>
<span class="line"><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATALENGTH</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">st</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">like</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;%fetch%&#39;</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> total_elapsed_time </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> execution_count </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">;</span></span></code></pre></div><p>==执行比较慢==</p><ul><li>正在执行的慢查询</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ST</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transaction_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> TransactionID ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">st</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">DT</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> DatabaseName ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">ses</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">host_name</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">ses</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">login_name</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">ses</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">status</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">AT</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transaction_begin_time</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> TransactionStartTime ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">connect_time</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">DATEDIFF</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">second</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">AT</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transaction_begin_time</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()) </span><span style="color:#9ECBFF;">&quot;exec_time(s)&quot;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">DATEDIFF</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">minute</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">AT</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transaction_begin_time</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> Tran_run_time ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">AT</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transaction_type</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Read/Write Transaction&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Read-Only Transaction&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;System Transaction&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Distributed Transaction&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> TransactionType ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">AT</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transaction_state</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Transaction Not Initialized&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Transaction Initialized &amp; Not Started&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Active Transaction&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Transaction Ended&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Distributed Transaction Initiated Commit Process&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Transaction in Prepared State &amp; Waiting Resolution&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Transaction Committed&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Transaction Rolling Back&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Transaction Rolled Back&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> TransactionState</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_tran_session_transactions</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> ST</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_tran_active_transactions</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ST</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transaction_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">AT</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transaction_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_tran_database_transactions</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> DT </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ST</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transaction_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DT</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transaction_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_connections</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> C </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">st</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sessions</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> ses </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ses</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">most_recent_sql_Handle</span><span style="color:#E1E4E8;">) s</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">DATEDIFF</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">second</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">AT</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transaction_begin_time</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ST</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transaction_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> TransactionID ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">st</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">DT</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> DatabaseName ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">ses</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">host_name</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">ses</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">login_name</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">ses</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">status</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">AT</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transaction_begin_time</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> TransactionStartTime ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">connect_time</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">DATEDIFF</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">second</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">AT</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transaction_begin_time</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()) </span><span style="color:#032F62;">&quot;exec_time(s)&quot;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">DATEDIFF</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">minute</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">AT</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transaction_begin_time</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> Tran_run_time ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">AT</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transaction_type</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Read/Write Transaction&#39;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Read-Only Transaction&#39;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;System Transaction&#39;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Distributed Transaction&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> TransactionType ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">AT</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transaction_state</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Transaction Not Initialized&#39;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Transaction Initialized &amp; Not Started&#39;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Active Transaction&#39;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Transaction Ended&#39;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Distributed Transaction Initiated Commit Process&#39;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Transaction in Prepared State &amp; Waiting Resolution&#39;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Transaction Committed&#39;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Transaction Rolling Back&#39;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Transaction Rolled Back&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> TransactionState</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_tran_session_transactions</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> ST</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_tran_active_transactions</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ST</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transaction_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">AT</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transaction_id</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_tran_database_transactions</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> DT </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ST</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transaction_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DT</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transaction_id</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_connections</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> C </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">st</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sessions</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> ses </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ses</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">most_recent_sql_Handle</span><span style="color:#24292E;">) s</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">DATEDIFF</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">second</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">AT</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transaction_begin_time</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span></span></code></pre></div><ul><li>排查历史慢查询</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span></span>
<span class="line"><span style="color:#E1E4E8;">  [Total IO] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_logical_reads</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_logical_writes</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  , [Average IO] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_logical_reads</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_logical_writes</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">                                            </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_count</span></span>
<span class="line"><span style="color:#E1E4E8;">  , </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_count</span></span>
<span class="line"><span style="color:#E1E4E8;">  , </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">,(</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,    </span></span>
<span class="line"><span style="color:#E1E4E8;">  ((</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">LEN</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX), </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Individual Query]</span></span>
<span class="line"><span style="color:#E1E4E8;">  , </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Parent Query]</span></span>
<span class="line"><span style="color:#E1E4E8;">  , </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> DatabaseName</span></span>
<span class="line"><span style="color:#E1E4E8;">  , </span><span style="color:#79B8FF;">qp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_plan</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_stats</span><span style="color:#E1E4E8;"> qs</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> qt</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_plan</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">plan_handle</span><span style="color:#E1E4E8;">) qp</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [Average IO]  </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span></span>
<span class="line"><span style="color:#24292E;">  [Total IO] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_logical_reads</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_logical_writes</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  , [Average IO] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_logical_reads</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_logical_writes</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">                                            </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_count</span></span>
<span class="line"><span style="color:#24292E;">  , </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_count</span></span>
<span class="line"><span style="color:#24292E;">  , </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">,(</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,    </span></span>
<span class="line"><span style="color:#24292E;">  ((</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">LEN</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX), </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Individual Query]</span></span>
<span class="line"><span style="color:#24292E;">  , </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Parent Query]</span></span>
<span class="line"><span style="color:#24292E;">  , </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> DatabaseName</span></span>
<span class="line"><span style="color:#24292E;">  , </span><span style="color:#005CC5;">qp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_plan</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_stats</span><span style="color:#24292E;"> qs</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> qt</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_plan</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">plan_handle</span><span style="color:#24292E;">) qp</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [Average IO]  </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><ul><li>或者</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TEXT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;SQL Statement&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;"> ,last_execution_time </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Last Execution Time&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;"> ,(total_logical_reads </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> total_physical_reads </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> total_logical_writes) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> execution_count </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Average IO]</span></span>
<span class="line"><span style="color:#E1E4E8;"> ,(total_worker_time </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> execution_count) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1000000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Average CPU Time (sec)]</span></span>
<span class="line"><span style="color:#E1E4E8;"> ,(total_elapsed_time </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> execution_count) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1000000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Average Elapsed Time (sec)]</span></span>
<span class="line"><span style="color:#E1E4E8;"> ,execution_count </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Execution Count&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;"> ,</span><span style="color:#79B8FF;">qp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_plan</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Query Plan&quot;</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_stats</span><span style="color:#E1E4E8;"> qs</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">plan_handle</span><span style="color:#E1E4E8;">) st</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_plan</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">plan_handle</span><span style="color:#E1E4E8;">) qp</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> total_elapsed_time </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> execution_count </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TEXT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;SQL Statement&#39;</span></span>
<span class="line"><span style="color:#24292E;"> ,last_execution_time </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Last Execution Time&#39;</span></span>
<span class="line"><span style="color:#24292E;"> ,(total_logical_reads </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> total_physical_reads </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> total_logical_writes) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> execution_count </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Average IO]</span></span>
<span class="line"><span style="color:#24292E;"> ,(total_worker_time </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> execution_count) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1000000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Average CPU Time (sec)]</span></span>
<span class="line"><span style="color:#24292E;"> ,(total_elapsed_time </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> execution_count) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1000000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Average Elapsed Time (sec)]</span></span>
<span class="line"><span style="color:#24292E;"> ,execution_count </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Execution Count&quot;</span></span>
<span class="line"><span style="color:#24292E;"> ,</span><span style="color:#005CC5;">qp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_plan</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Query Plan&quot;</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_stats</span><span style="color:#24292E;"> qs</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">plan_handle</span><span style="color:#24292E;">) st</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_plan</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">plan_handle</span><span style="color:#24292E;">) qp</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> total_elapsed_time </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> execution_count </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><ul><li>常用</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span></span>
<span class="line"><span style="color:#6A737D;">-- SELECT * FROM dbo.sysprocesses WHERE spid IN (SELECT blocked FROM dbo.sysprocesses where blocked &lt;&gt; 0);</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">es</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">database_name=</span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_id</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">cpu_time</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">reads</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">writes</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">logical_reads</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    login_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">status</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    blocking_session_id,</span></span>
<span class="line"><span style="color:#E1E4E8;">    wait_type,</span></span>
<span class="line"><span style="color:#E1E4E8;">    wait_resource,</span></span>
<span class="line"><span style="color:#E1E4E8;">    wait_time,</span></span>
<span class="line"><span style="color:#E1E4E8;">    individual_query</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">,(</span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,((</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#F97583;">=-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">LEN</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX),</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">END-</span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">    parent_query</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    program_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">    host_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">    nt_domain,</span></span>
<span class="line"><span style="color:#E1E4E8;">    start_time,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">DATEDIFF</span><span style="color:#E1E4E8;">(MS,</span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">start_time</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">())</span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> duration,</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  query_plan  </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_plan</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">plan_handle</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;">  query_plan</span></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> er</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">INNER  JOIN</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sessions</span><span style="color:#E1E4E8;">  es  </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">es</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;">  qt</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">es</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;">         </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">es</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_Id</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;">(@@SPID)</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span></span>
<span class="line"><span style="color:#6A737D;">-- SELECT * FROM dbo.sysprocesses WHERE spid IN (SELECT blocked FROM dbo.sysprocesses where blocked &lt;&gt; 0);</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">es</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">database_name=</span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_id</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">cpu_time</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">reads</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">writes</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">logical_reads</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    login_name,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">status</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    blocking_session_id,</span></span>
<span class="line"><span style="color:#24292E;">    wait_type,</span></span>
<span class="line"><span style="color:#24292E;">    wait_resource,</span></span>
<span class="line"><span style="color:#24292E;">    wait_time,</span></span>
<span class="line"><span style="color:#24292E;">    individual_query</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">,(</span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,((</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#D73A49;">=-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">LEN</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX),</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">END-</span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">    parent_query</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    program_name,</span></span>
<span class="line"><span style="color:#24292E;">    host_name,</span></span>
<span class="line"><span style="color:#24292E;">    nt_domain,</span></span>
<span class="line"><span style="color:#24292E;">    start_time,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">DATEDIFF</span><span style="color:#24292E;">(MS,</span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">start_time</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">())</span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> duration,</span></span>
<span class="line"><span style="color:#24292E;">    (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  query_plan  </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_plan</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">plan_handle</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">AS</span><span style="color:#24292E;">  query_plan</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> er</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">INNER  JOIN</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sessions</span><span style="color:#24292E;">  es  </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">es</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">AS</span><span style="color:#24292E;">  qt</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">es</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">50</span><span style="color:#24292E;">         </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">es</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_Id</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;">(@@SPID)</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span></span></code></pre></div><blockquote><p>logical_reads:逻辑读，衡量语句的执行开销。如果大于10w，说明此语句开销很大。可以检查下索引是否合理</p><p>status：进程的状态。running 表示正在运行，sleeping 表示处于睡眠中，未运行任何语句，suspend 表示等待，runnable 等待cpu 调度</p><p>blocking_session_id: 如果不为0,例如 60 。表示52号进程正在被60阻塞。50 进程必须等待60执行完成，才能执行下面的语句</p><p>host_name ：发出请求的服务器名</p><p>program_name:发出请求的应用程序名</p><p>duration: 请求的执行时间</p></blockquote><h2 id="_1-9最耗cpu时间的会话" tabindex="-1">1.9最耗CPU时间的会话 <a class="header-anchor" href="#_1-9最耗cpu时间的会话" aria-label="Permalink to &quot;1.9最耗CPU时间的会话&quot;">​</a></h2><p><a href="https://learn.microsoft.com/zh-cn/troubleshoot/sql/database-engine/performance/troubleshoot-high-cpu-usage-issues" target="_blank" rel="noreferrer">https://learn.microsoft.com/zh-cn/troubleshoot/sql/database-engine/performance/troubleshoot-high-cpu-usage-issues</a></p><p>一般会用到三个视图sys.sysprocesses ,dm_exec_sessions ,dm_exec_requests</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">[session_id],</span></span>
<span class="line"><span style="color:#E1E4E8;">[request_id],</span></span>
<span class="line"><span style="color:#E1E4E8;"> [start_time] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;开始时间&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[status] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;状态&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[command] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;命令&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">dest.[text] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;sql语句&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">([database_id]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;数据库名&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[blocking_session_id] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;正在阻塞其他会话的会话ID&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[wait_type] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;等待资源类型&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[wait_time] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;等待时间&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[wait_resource] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;等待的资源&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[reads] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;物理读次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[writes] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;写次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[logical_reads] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;逻辑读次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[row_count] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;返回结果行数&#39;</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> sys.[dm_exec_requests] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> der </span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">sys.[dm_exec_sql_text](der.[sql_handle]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> dest </span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> [session_id]</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(der.[database_id])</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;DB_name&#39;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">-- DB_name 根据自己写</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [cpu_time] </span><span style="color:#F97583;">DESC</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">---------------------</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">   total_worker_time</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">execution_count </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> avg_cpu_cost, plan_handle,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">   execution_count,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">   (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">, statement_start_offset</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">      (</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> statement_end_offset </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">LEN</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">nvarchar</span><span style="color:#E1E4E8;">(max), </span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> statement_end_offset</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> statement_start_offset)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">sql_handle</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> query_text</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_stats</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [avg_cpu_cost] </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">[session_id],</span></span>
<span class="line"><span style="color:#24292E;">[request_id],</span></span>
<span class="line"><span style="color:#24292E;"> [start_time] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;开始时间&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[status] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;状态&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[command] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;命令&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">dest.[text] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;sql语句&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">([database_id]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;数据库名&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[blocking_session_id] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;正在阻塞其他会话的会话ID&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[wait_type] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;等待资源类型&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[wait_time] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;等待时间&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[wait_resource] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;等待的资源&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[reads] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;物理读次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[writes] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;写次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[logical_reads] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;逻辑读次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[row_count] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;返回结果行数&#39;</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> sys.[dm_exec_requests] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> der </span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">sys.[dm_exec_sql_text](der.[sql_handle]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> dest </span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> [session_id]</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(der.[database_id])</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;DB_name&#39;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">-- DB_name 根据自己写</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [cpu_time] </span><span style="color:#D73A49;">DESC</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">---------------------</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">   total_worker_time</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">execution_count </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> avg_cpu_cost, plan_handle,</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">   execution_count,</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">   (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">, statement_start_offset</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">      (</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> statement_end_offset </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">LEN</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">nvarchar</span><span style="color:#24292E;">(max), </span><span style="color:#D73A49;">text</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> statement_end_offset</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> statement_start_offset)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">sql_handle</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> query_text</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_stats</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [avg_cpu_cost] </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><ul><li>查看所有</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span></span>
<span class="line"><span style="color:#6A737D;">--如果要指定数据库就把注释去掉</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> sys.[sysprocesses] </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> [spid]</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--AND DB_NAME([dbid])=&#39;DB_name&#39;</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">COUNT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> [sys].[dm_exec_sessions] </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> [session_id]</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">50</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span></span>
<span class="line"><span style="color:#6A737D;">--如果要指定数据库就把注释去掉</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> sys.[sysprocesses] </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> [spid]</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">--AND DB_NAME([dbid])=&#39;DB_name&#39;</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">COUNT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> [sys].[dm_exec_sessions] </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> [session_id]</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">50</span></span></code></pre></div><h3 id="查看具体的cpu-耗时sql语句" tabindex="-1">查看具体的cpu 耗时sql语句 <a class="header-anchor" href="#查看具体的cpu-耗时sql语句" aria-label="Permalink to &quot;查看具体的cpu 耗时sql语句&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">dest.[text] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;sql语句&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> sys.[dm_exec_requests] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> der </span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">sys.[dm_exec_sql_text](der.[sql_handle]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> dest </span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> [session_id]</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [cpu_time] </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">dest.[text] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;sql语句&#39;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> sys.[dm_exec_requests] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> der </span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">sys.[dm_exec_sql_text](der.[sql_handle]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> dest </span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> [session_id]</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">50</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [cpu_time] </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><h3 id="查看cpu数和user-scheduler数和最大工作线程数" tabindex="-1">查看CPU数和user scheduler数和最大工作线程数 <a class="header-anchor" href="#查看cpu数和user-scheduler数和最大工作线程数" aria-label="Permalink to &quot;查看CPU数和user scheduler数和最大工作线程数&quot;">​</a></h3><p>查看CPU数和user scheduler数和最大工作线程数，检查worker是否用完也可以排查CPU占用情况</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--查看CPU数和user scheduler数目</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> cpu_count,scheduler_count </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_sys_info</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看最大工作线程数</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> max_workers_count </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_sys_info</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">--查看CPU数和user scheduler数目</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> cpu_count,scheduler_count </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_sys_info</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看最大工作线程数</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> max_workers_count </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_sys_info</span></span></code></pre></div><p>对照下面这个表 各种CPU和SQLSERVER版本组合自动配置的最大工作线程数 CPU数 32位计算机 64位计算机 &lt;=4 256 512 8 288 576 16 352 704 32 480 960</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;"> scheduler_address,</span></span>
<span class="line"><span style="color:#E1E4E8;">scheduler_id,</span></span>
<span class="line"><span style="color:#E1E4E8;">cpu_id,</span></span>
<span class="line"><span style="color:#F97583;">status</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">current_tasks_count,</span></span>
<span class="line"><span style="color:#E1E4E8;">current_workers_count,active_workers_count</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_schedulers</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;"> scheduler_address,</span></span>
<span class="line"><span style="color:#24292E;">scheduler_id,</span></span>
<span class="line"><span style="color:#24292E;">cpu_id,</span></span>
<span class="line"><span style="color:#D73A49;">status</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">current_tasks_count,</span></span>
<span class="line"><span style="color:#24292E;">current_workers_count,active_workers_count</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_schedulers</span></span></code></pre></div><h3 id="查询cpu占用高的语句" tabindex="-1">查询CPU占用高的语句 <a class="header-anchor" href="#查询cpu占用高的语句" aria-label="Permalink to &quot;查询CPU占用高的语句&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">    total_worker_time</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">execution_count </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> avg_cpu_cost, plan_handle,</span></span>
<span class="line"><span style="color:#E1E4E8;">    execution_count,</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">, statement_start_offset</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">       (</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> statement_end_offset </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">LEN</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">nvarchar</span><span style="color:#E1E4E8;">(max), </span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> statement_end_offset</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> statement_start_offset)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">sql_handle</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> query_text</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_stats</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [avg_cpu_cost] </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">    total_worker_time</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">execution_count </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> avg_cpu_cost, plan_handle,</span></span>
<span class="line"><span style="color:#24292E;">    execution_count,</span></span>
<span class="line"><span style="color:#24292E;">    (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">, statement_start_offset</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">       (</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> statement_end_offset </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">LEN</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">nvarchar</span><span style="color:#24292E;">(max), </span><span style="color:#D73A49;">text</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> statement_end_offset</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> statement_start_offset)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">sql_handle</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> query_text</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_stats</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [avg_cpu_cost] </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><h2 id="_2-0-查询sqlserver-正在执行的sql语句" tabindex="-1">2.0 查询sqlserver 正在执行的sql语句 <a class="header-anchor" href="#_2-0-查询sqlserver-正在执行的sql语句" aria-label="Permalink to &quot;2.0 查询sqlserver 正在执行的sql语句&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">     [Spid] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> session_Id, ecid, [Database] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> [User] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nt_username, [Status] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">status</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;"> [Wait] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> wait_type, </span></span>
<span class="line"><span style="color:#E1E4E8;"> [Individual Query] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, (</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">LEN</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX), </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">)) </span></span>
<span class="line"><span style="color:#E1E4E8;">                      </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">                       [Parent Query] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">                       Program </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> program_name, Hostname, </span></span>
<span class="line"><span style="color:#E1E4E8;">                       nt_domain, start_time</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> er </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sysprocesses</span><span style="color:#E1E4E8;"> sp </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">spid</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> qt</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">     session_Id </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">/* Ignore system spids.*/</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> session_Id </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> (@@SPID)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">     [Spid] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> session_Id, ecid, [Database] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;">),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> [User] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nt_username, [Status] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">status</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;"> [Wait] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> wait_type, </span></span>
<span class="line"><span style="color:#24292E;"> [Individual Query] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, (</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">LEN</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX), </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">)) </span></span>
<span class="line"><span style="color:#24292E;">                      </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">                       [Parent Query] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">                       Program </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> program_name, Hostname, </span></span>
<span class="line"><span style="color:#24292E;">                       nt_domain, start_time</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> er </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sysprocesses</span><span style="color:#24292E;"> sp </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">spid</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> qt</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">     session_Id </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">/* Ignore system spids.*/</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> session_Id </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> (@@SPID)</span></span></code></pre></div><ul><li>或者查看数据库正在执行的sql语句</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  [Spid] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> session_id ,</span></span>
<span class="line"><span style="color:#E1E4E8;">            ecid ,</span></span>
<span class="line"><span style="color:#E1E4E8;">            [Database] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">            [User] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nt_username ,</span></span>
<span class="line"><span style="color:#E1E4E8;">            [Status] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">status</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">            [Wait] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> wait_type ,</span></span>
<span class="line"><span style="color:#E1E4E8;">            [Individual Query] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                           </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                           ( </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                  </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">LEN</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX), </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                       </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                  </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span></span>
<span class="line"><span style="color:#E1E4E8;">                                             </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"><span style="color:#E1E4E8;">                                           </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">            [Parent Query] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">            Program </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> program_name ,</span></span>
<span class="line"><span style="color:#E1E4E8;">            hostname ,</span></span>
<span class="line"><span style="color:#E1E4E8;">            nt_domain ,</span></span>
<span class="line"><span style="color:#E1E4E8;">            start_time</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> er</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sysprocesses</span><span style="color:#E1E4E8;"> sp </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">spid</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> qt</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   session_id </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- Ignore system spids.</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> session_id </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> ( @@SPID ) </span><span style="color:#6A737D;">-- Ignore this current statement.</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  [Spid] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> session_id ,</span></span>
<span class="line"><span style="color:#24292E;">            ecid ,</span></span>
<span class="line"><span style="color:#24292E;">            [Database] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">            [User] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nt_username ,</span></span>
<span class="line"><span style="color:#24292E;">            [Status] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">status</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">            [Wait] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> wait_type ,</span></span>
<span class="line"><span style="color:#24292E;">            [Individual Query] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                           </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                           ( </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">                                                  </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">LEN</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX), </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">                                                       </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">                                                  </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span></span>
<span class="line"><span style="color:#24292E;">                                             </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#24292E;"> )</span></span>
<span class="line"><span style="color:#24292E;">                                           </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">            [Parent Query] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">            Program </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> program_name ,</span></span>
<span class="line"><span style="color:#24292E;">            hostname ,</span></span>
<span class="line"><span style="color:#24292E;">            nt_domain ,</span></span>
<span class="line"><span style="color:#24292E;">            start_time</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> er</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sysprocesses</span><span style="color:#24292E;"> sp </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">spid</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> qt</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   session_id </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- Ignore system spids.</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> session_id </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> ( @@SPID ) </span><span style="color:#6A737D;">-- Ignore this current statement.</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">2</span></span></code></pre></div><h3 id="查看数据库连接情况" tabindex="-1">查看数据库连接情况 <a class="header-anchor" href="#查看数据库连接情况" aria-label="Permalink to &quot;查看数据库连接情况&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> sysprocesses </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">dbid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">dbid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> sysdatabases </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name=</span><span style="color:#9ECBFF;">&#39;dbname&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#6A737D;">--或者</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">[Master].[dbo].[SYSPROCESSES] </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> [DBID] </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">   [DBID]</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">   [Master].[dbo].[SYSDATABASES]</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">NAME=</span><span style="color:#9ECBFF;">&#39;dbname&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--或者</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> @@spid </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Connection ID&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">dbid</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Database&#39;</span><span style="color:#E1E4E8;">,loginame </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Login Name&#39;</span><span style="color:#E1E4E8;">,hostname </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Host Name&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">nt_username </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Windows User Name&#39;</span><span style="color:#E1E4E8;">,program_name </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Program Name&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sysprocesses</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">dbid&gt;</span><span style="color:#79B8FF;">0</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> sysprocesses </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">dbid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">dbid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> sysdatabases </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name=</span><span style="color:#032F62;">&#39;dbname&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6A737D;">--或者</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">[Master].[dbo].[SYSPROCESSES] </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> [DBID] </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">   [DBID]</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">   [Master].[dbo].[SYSDATABASES]</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">NAME=</span><span style="color:#032F62;">&#39;dbname&#39;</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--或者</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> @@spid </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Connection ID&#39;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">dbid</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Database&#39;</span><span style="color:#24292E;">,loginame </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Login Name&#39;</span><span style="color:#24292E;">,hostname </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Host Name&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">nt_username </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Windows User Name&#39;</span><span style="color:#24292E;">,program_name </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Program Name&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sysprocesses</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">dbid&gt;</span><span style="color:#005CC5;">0</span></span></code></pre></div><h3 id="查看连接对象" tabindex="-1">查看连接对象 <a class="header-anchor" href="#查看连接对象" aria-label="Permalink to &quot;查看连接对象&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> client_net_address </span><span style="color:#9ECBFF;">&#39;客户端IP&#39;</span><span style="color:#E1E4E8;">,local_net_address </span><span style="color:#9ECBFF;">&#39;服务器的IP&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_connections</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> sys.[sysprocesses] </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> [spid]</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--AND DB_NAME([dbid])=&#39;gposdb&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> client_net_address </span><span style="color:#032F62;">&#39;客户端IP&#39;</span><span style="color:#24292E;">,local_net_address </span><span style="color:#032F62;">&#39;服务器的IP&#39;</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_connections</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> sys.[sysprocesses] </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> [spid]</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">--AND DB_NAME([dbid])=&#39;gposdb&#39;</span></span></code></pre></div><h3 id="查看连接情况" tabindex="-1">查看连接情况 <a class="header-anchor" href="#查看连接情况" aria-label="Permalink to &quot;查看连接情况&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--查看连接到数据库&quot;DB&quot;的连接</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">master</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sysprocesses </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">dbid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;DB&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#6A737D;">--查询某个数据库用户的连接情况</span></span>
<span class="line"><span style="color:#E1E4E8;">sp_who </span><span style="color:#9ECBFF;">&#39;sa&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--查看连接到数据库&quot;DB&quot;的连接</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">master</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sysprocesses </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">dbid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;DB&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6A737D;">--查询某个数据库用户的连接情况</span></span>
<span class="line"><span style="color:#24292E;">sp_who </span><span style="color:#032F62;">&#39;sa&#39;</span></span></code></pre></div><h2 id="_2-1-qps" tabindex="-1">2.1 QPS <a class="header-anchor" href="#_2-1-qps" aria-label="Permalink to &quot;2.1 QPS&quot;">​</a></h2><p><a href="https://learn.microsoft.com/zh-cn/sql/relational-databases/system-dynamic-management-views/sys-dm-os-performance-counters-transact-sql?view=sql-server-2017" target="_blank" rel="noreferrer">https://learn.microsoft.com/zh-cn/sql/relational-databases/system-dynamic-management-views/sys-dm-os-performance-counters-transact-sql?view=sql-server-2017</a></p><p>dm_os_performance_counters,该<code>视图</code>用于查看数据库的性能指标</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> t </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_performance_counters</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> object_name </span><span style="color:#F97583;">LIKE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;%SQL Statistics%&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> counter_name </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;Batch Requests/sec&#39;</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> counter_name,cntr_value </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> t</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">with</span><span style="color:#24292E;"> t </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_performance_counters</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> object_name </span><span style="color:#D73A49;">LIKE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;%SQL Statistics%&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> counter_name </span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;Batch Requests/sec&#39;</span><span style="color:#24292E;"> )</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> counter_name,cntr_value </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> t</span></span></code></pre></div><h2 id="_2-2索引" tabindex="-1">2.2索引 <a class="header-anchor" href="#_2-2索引" aria-label="Permalink to &quot;2.2索引&quot;">​</a></h2><h3 id="_2-2-1查看索引是否丢失" tabindex="-1">2.2.1查看索引是否丢失 <a class="header-anchor" href="#_2-2-1查看索引是否丢失" aria-label="Permalink to &quot;2.2.1查看索引是否丢失&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">     DatabaseName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(database_id)</span></span>
<span class="line"><span style="color:#E1E4E8;">     ,[Number Indexes Missing] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">count</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_missing_index_details</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">GROUP BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(database_id)</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">         [Total Cost]  </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ROUND</span><span style="color:#E1E4E8;">(avg_total_user_cost </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> avg_user_impact </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> (user_seeks </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> user_scans),</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         , avg_user_impact</span></span>
<span class="line"><span style="color:#E1E4E8;">         , TableName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">statement</span></span>
<span class="line"><span style="color:#E1E4E8;">         , [EqualityUsage] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> equality_columns</span></span>
<span class="line"><span style="color:#E1E4E8;">         , [InequalityUsage] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> inequality_columns</span></span>
<span class="line"><span style="color:#E1E4E8;">         , [Include Cloumns] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> included_columns</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_missing_index_groups</span><span style="color:#E1E4E8;"> g</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_missing_index_group_stats</span><span style="color:#E1E4E8;"> s</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">group_handle</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">g</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_group_handle</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_missing_index_details</span><span style="color:#E1E4E8;"> d</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_handle</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">g</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_handle</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [Total Cost] </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">     DatabaseName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(database_id)</span></span>
<span class="line"><span style="color:#24292E;">     ,[Number Indexes Missing] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">count</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_missing_index_details</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">GROUP BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(database_id)</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">         [Total Cost]  </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ROUND</span><span style="color:#24292E;">(avg_total_user_cost </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> avg_user_impact </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> (user_seeks </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> user_scans),</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         , avg_user_impact</span></span>
<span class="line"><span style="color:#24292E;">         , TableName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">statement</span></span>
<span class="line"><span style="color:#24292E;">         , [EqualityUsage] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> equality_columns</span></span>
<span class="line"><span style="color:#24292E;">         , [InequalityUsage] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> inequality_columns</span></span>
<span class="line"><span style="color:#24292E;">         , [Include Cloumns] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> included_columns</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_missing_index_groups</span><span style="color:#24292E;"> g</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_missing_index_group_stats</span><span style="color:#24292E;"> s</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">group_handle</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">g</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_group_handle</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_missing_index_details</span><span style="color:#24292E;"> d</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_handle</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">g</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_handle</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [Total Cost] </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">;</span></span></code></pre></div><h1 id="_3-io" tabindex="-1">3.io <a class="header-anchor" href="#_3-io" aria-label="Permalink to &quot;3.io&quot;">​</a></h1><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">dbid</span><span style="color:#E1E4E8;">) </span><span style="color:#9ECBFF;">&#39;Database Name&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">   physical_name </span><span style="color:#9ECBFF;">&#39;File Location&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">   NumberReads </span><span style="color:#9ECBFF;">&#39;Number of Reads&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">   BytesRead </span><span style="color:#9ECBFF;">&#39;Bytes Read&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">   NumberWrites </span><span style="color:#9ECBFF;">&#39;Number of Writes&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">   BytesWritten </span><span style="color:#9ECBFF;">&#39;Bytes Written&#39;</span><span style="color:#E1E4E8;">,   </span></span>
<span class="line"><span style="color:#E1E4E8;">   IoStallReadMS </span><span style="color:#9ECBFF;">&#39;IO Stall Read&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">   IoStallWriteMS </span><span style="color:#9ECBFF;">&#39;IO Stall Write&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">   IoStallMS </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Total IO Stall (ms)&#39;</span></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">   fn_virtualfilestats(</span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">) fs </span><span style="color:#F97583;">INNER JOIN</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">master_files</span><span style="color:#E1E4E8;"> mf </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">fs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">mf</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_id</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">fs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fileid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">mf</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">file_id</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">dbid</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">dbid</span><span style="color:#24292E;">) </span><span style="color:#032F62;">&#39;Database Name&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">   physical_name </span><span style="color:#032F62;">&#39;File Location&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">   NumberReads </span><span style="color:#032F62;">&#39;Number of Reads&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">   BytesRead </span><span style="color:#032F62;">&#39;Bytes Read&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">   NumberWrites </span><span style="color:#032F62;">&#39;Number of Writes&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">   BytesWritten </span><span style="color:#032F62;">&#39;Bytes Written&#39;</span><span style="color:#24292E;">,   </span></span>
<span class="line"><span style="color:#24292E;">   IoStallReadMS </span><span style="color:#032F62;">&#39;IO Stall Read&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">   IoStallWriteMS </span><span style="color:#032F62;">&#39;IO Stall Write&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">   IoStallMS </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Total IO Stall (ms)&#39;</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">   fn_virtualfilestats(</span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">) fs </span><span style="color:#D73A49;">INNER JOIN</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">master_files</span><span style="color:#24292E;"> mf </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">fs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">mf</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_id</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">fs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fileid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">mf</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">file_id</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">dbid</span><span style="color:#24292E;">)</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141018751.jpg" alt=""></p><p><a href="https://www.modb.pro/db/410923" target="_blank" rel="noreferrer">https://www.modb.pro/db/410923</a></p><h1 id="_4-性能检测工具" tabindex="-1">4.性能检测工具 <a class="header-anchor" href="#_4-性能检测工具" aria-label="Permalink to &quot;4.性能检测工具&quot;">​</a></h1><p>sql server profiler</p><p><a href="https://www.cnblogs.com/knowledgesea/category/373445.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/knowledgesea/category/373445.html</a></p><h2 id="_4-1-sql-server-profiler是什么" tabindex="-1">4.1 SQL Server Profiler是什么 <a class="header-anchor" href="#_4-1-sql-server-profiler是什么" aria-label="Permalink to &quot;4.1 SQL Server Profiler是什么&quot;">​</a></h2><p>SQL Server Profiler是一个界面，用于创建和管理跟踪并分析和重播跟踪结果。 这些事件保存在一个跟踪文件中，稍后试图诊断问题时，可以对该文件进行分析或用它来重播一系列特定的步骤。同时也可以利用它来对跟着文件进行分析，分析完成后会给出优化建议</p><ul><li>查找持续时间最长的查询</li></ul><p>在创建跟踪时，勾上TSQL-SQL:BatchCompleted.跟Stored Procedures-RPC:completed。这样就能找出来这个最长时间查询然后对其进行分析优化</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">select TextData,Duration,CPU from &lt;跟踪的表&gt;</span></span>
<span class="line"><span style="color:#e1e4e8;">where EventClass=12 -- 等于12表示BatchCompleted事件</span></span>
<span class="line"><span style="color:#e1e4e8;">and CPU&lt;(0.4*Duration)  --如果cpu的占用时间，小于执行sql语句时间的40%，说明该语句等待时间过长</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">select TextData,Duration,CPU from &lt;跟踪的表&gt;</span></span>
<span class="line"><span style="color:#24292e;">where EventClass=12 -- 等于12表示BatchCompleted事件</span></span>
<span class="line"><span style="color:#24292e;">and CPU&lt;(0.4*Duration)  --如果cpu的占用时间，小于执行sql语句时间的40%，说明该语句等待时间过长</span></span></code></pre></div><ul><li>最占用系统资源的查询</li></ul><p>就是占用cpu时间，跟读写IO的次数。建议事件包含Connect、Disconnect、ExistingConnection、SQL:BatchCompleted、RPC:completed，列包含writes，reads，cpu</p><ul><li>检测死锁</li></ul><p>在访问量，并发量都很大的数据库中，如果设计稍不合理，就有可能造成死锁，给系统性能带来影响。事件包含：RPC:Starting、SQL:BatchStarting、Lock：DeadLock（死锁事件）、Lock：DeadLockChaining（死锁的事件序列）</p><h2 id="_4-2-sql-server-profiler的使用" tabindex="-1">4.2 SQL Server Profiler的使用 <a class="header-anchor" href="#_4-2-sql-server-profiler的使用" aria-label="Permalink to &quot;4.2 SQL Server Profiler的使用&quot;">​</a></h2><ul><li><strong>第一步</strong></li></ul><p>启动SSMS——&gt;【工具】——&gt;【SQL Server Profiler】，即可启动SQL Server Profiler，如图1：</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141018223.jpg" alt=""></p><ul><li><strong>第二步</strong></li></ul><p>启动后会再次要求连接被跟踪的数据库，如图2：</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141018639.jpg" alt=""></p><ul><li><strong>第三步</strong></li></ul><p>设置跟踪属性，根据界面提示填入相关信息，如图3：</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141018778.jpg" alt=""></p><ul><li><strong>第四步</strong></li></ul><p>设置【事件选择】内容，根据图4中的提示，勾选相关内容即可：</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141018406.jpg" alt=""></p><ul><li><strong>第五步</strong></li></ul><p>在【事件选择】页面继续勾选显示DatabaseName列，方便显示被跟踪数据库，按图5步骤中操作：</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141018895.jpg" alt=""></p><ul><li><strong>第六步</strong></li></ul><p>按图6中步骤，先点击【列筛选器...】在弹出的页面中找到【DatabaseName】选项，然后输入指定数据库名称，这里我们输入AdventureWorks。这是小编本地数据库名称</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141018339.jpg" alt=""></p><ul><li><strong>第七步</strong></li></ul><p>按图7中步骤，选中【TextData】的选项，输入select%，其意思是跟踪以select开头的查询语句，%为通配符。点击【确定】后会弹出一个提示框，点击【确定】即可</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141018842.jpg" alt=""></p><p>*　<strong>第八步</strong></p><p>返回SSMS，选择AdventureWorks数据库，新建一个查询，点击【执行】。如图8：</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141018231.jpg" alt=""></p><ul><li><strong>第九步</strong></li></ul><p>返回SQL Server Profiler查看跟踪界面，如图9在跟踪页面上可以看到刚才执行的查询语句</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141018026.jpg" alt=""></p><p>事件分类，申请了语句，应用程序名称，操作系统用户，数据库用户，cpu占用率，读数据库次数，写数据库次说，执行脚本用时，应用程序进程号，开始时间，结束时间</p><ul><li><strong>第十步</strong></li></ul><p>将当前的跟踪文件另存为跟踪文件Test.trc，如图10：</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141018767.jpg" alt=""></p><ul><li><strong>第十一步</strong></li></ul><p>点击SQL Server Profiler菜单栏中的【工具】——&gt;【数据库引擎优化顾问】开始对刚才的Test.trc文件进行分析，如图11：</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141018376.jpg" alt=""></p><ul><li><strong>第十二步</strong></li></ul><p>在弹出的页面中，我们开始设置优化顾问。</p><ol><li>在【工作负荷】中找到刚保存的Test.trc文件</li><li>在选择要优化的数据库和表中，我们单独找到需要被分析的表Address</li></ol><p>如图12：</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141018697.jpg" alt=""></p><ul><li><strong>第十三步</strong></li></ul><p>设置完成后，点击【开始分析】即可，如图13：</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141018422.jpg" alt=""></p><ul><li><strong>第十四步</strong></li></ul><p>等分析完成后，在索引建议一栏中的最后一列【定义】中会给出优化建议，这里点开，然后点【复制到剪贴板】即可获取优化建议脚本，返回SSMS粘贴后执行即可完成优化。如图14：</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141019177.jpg" alt=""></p><ul><li><strong>第十五步</strong></li></ul><p>这一步是和第十四步功能类似，只是更加智能，由系统自动执行，无需复制粘贴执行脚本。点击数据引擎优化顾问的菜单栏的【操作】——&gt;【应用建议...】，在弹出的对话框如图15，点击确定即可自动执行引擎顾问提供的优化建议。</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141019534.jpg" alt=""></p><p><a href="https://www.cnblogs.com/bhtfg538/archive/2011/01/21/1939706.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/bhtfg538/archive/2011/01/21/1939706.html</a></p><h1 id="_5-sql-server-的状态值" tabindex="-1">5.SQL Server 的状态值 <a class="header-anchor" href="#_5-sql-server-的状态值" aria-label="Permalink to &quot;5.SQL Server 的状态值&quot;">​</a></h1><p>SQL Server 的管理、监控、效能调校时，我们可能会执行以下的 SQL 指令，去观察 SQL Server 里的状态：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sysprocesses</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_who2;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sqltext</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">TEXT</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">status</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">command</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">cpu_time</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_elapsed_time</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> req (</span><span style="color:#F97583;">NOLOCK</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">sql_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> sqltext</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sysprocesses</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_who2;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sqltext</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">TEXT</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">status</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">command</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">cpu_time</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_elapsed_time</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> req (</span><span style="color:#D73A49;">NOLOCK</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">sql_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> sqltext</span></span></code></pre></div><p>status 栏位的值，有这几种 : Pending, Runnable, Running, Suspended, Sleeping, Dormant, Background, Spinlock</p><h2 id="_5-1pending" tabindex="-1">5.1Pending <a class="header-anchor" href="#_5-1pending" aria-label="Permalink to &quot;5.1Pending&quot;">​</a></h2><p>“pending” (<code>等待</code>)，代表这个 process，既沒有 Thread 可用，也沒有 CPU 可用，正在同时等待这两项系统资源</p><h2 id="_5-2runnable" tabindex="-1">5.2runnable <a class="header-anchor" href="#_5-2runnable" aria-label="Permalink to &quot;5.2runnable&quot;">​</a></h2><p>“runnable”，代表这个 process，有 Thread 可用，但沒有 CPU 可用，所以它正在等待 CPU 这项系统资源</p><h2 id="_5-3running" tabindex="-1">5.3running <a class="header-anchor" href="#_5-3running" aria-label="Permalink to &quot;5.3running&quot;">​</a></h2><p>“running”，代表这个 process，有 Thread 可用，有 CPU 可用</p><h2 id="_5-4suspended" tabindex="-1">5.4suspended <a class="header-anchor" href="#_5-4suspended" aria-label="Permalink to &quot;5.4suspended&quot;">​</a></h2><p>“suspended” (暂停)，代表这个 process，正在「等待」別的 process 执行，等待的系统资源可能是 Disk I/O 或数据库的 Lock</p><h2 id="_5-5sleeping" tabindex="-1">5.5sleeping <a class="header-anchor" href="#_5-5sleeping" aria-label="Permalink to &quot;5.5sleeping&quot;">​</a></h2><p>“sleeping”，代表这个 process，目前没在做任何事，正在等待进一步的指令</p><h2 id="_5-6dormant" tabindex="-1">5.6dormant <a class="header-anchor" href="#_5-6dormant" aria-label="Permalink to &quot;5.6dormant&quot;">​</a></h2><p>“dormant” (暂时搁置)，代表 SQL Server 正在对这个 process 做 reset</p><h2 id="_5-6background" tabindex="-1">5.6background <a class="header-anchor" href="#_5-6background" aria-label="Permalink to &quot;5.6background&quot;">​</a></h2><p>“background”，代表这个 process 正在 SQL Server 背景执行。 即使你看到有很多 “background” process 正在执行，也不必担心</p><h2 id="_5-7-spinlock" tabindex="-1">5.7 Spinlock <a class="header-anchor" href="#_5-7-spinlock" aria-label="Permalink to &quot;5.7 Spinlock&quot;">​</a></h2><p>spin lock essentially means that query is in kind of running mode where it is busy waiting in cpu for its own turn.</p><h1 id="_6-排查步骤" tabindex="-1">6.排查步骤 <a class="header-anchor" href="#_6-排查步骤" aria-label="Permalink to &quot;6.排查步骤&quot;">​</a></h1><h2 id="_1-排查连接对象" tabindex="-1">1.排查连接对象 <a class="header-anchor" href="#_1-排查连接对象" aria-label="Permalink to &quot;1.排查连接对象&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--如果想要指定查询某个数据库，将后面的注释去掉即可</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> client_net_address </span><span style="color:#9ECBFF;">&#39;客户端IP&#39;</span><span style="color:#E1E4E8;">,local_net_address </span><span style="color:#9ECBFF;">&#39;服务器的IP&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_connections</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> sys.[sysprocesses] </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> [spid]</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--AND DB_NAME([dbid])=&#39;gposdb&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--如果想要指定查询某个数据库，将后面的注释去掉即可</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> client_net_address </span><span style="color:#032F62;">&#39;客户端IP&#39;</span><span style="color:#24292E;">,local_net_address </span><span style="color:#032F62;">&#39;服务器的IP&#39;</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_connections</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> sys.[sysprocesses] </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> [spid]</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">--AND DB_NAME([dbid])=&#39;gposdb&#39;</span></span></code></pre></div><p>各项指标是否正常，是否有阻塞，正常情况下搜索结果应该为空</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> [session_id],</span></span>
<span class="line"><span style="color:#E1E4E8;">[request_id],</span></span>
<span class="line"><span style="color:#E1E4E8;">[start_time] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;开始时间&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[status] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;状态&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[command] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;命令&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">dest.[text] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;sql语句&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">([database_id]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;数据库名&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[blocking_session_id] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;正在阻塞其他的ID&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[wait_type] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;等待资源类型&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[wait_time] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;等待时间&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[wait_resource] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;等待的资源&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[reads] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;物理读次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[writes] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;写次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[logical_reads] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;逻辑读次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">[row_count] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;返回结果行数&#39;</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> sys.[dm_exec_requests] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> der</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span></span>
<span class="line"><span style="color:#E1E4E8;">sys.[dm_exec_sql_text](der.[sql_handle]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> dest</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> [session_id]</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">50</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [cpu_time] </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> [session_id],</span></span>
<span class="line"><span style="color:#24292E;">[request_id],</span></span>
<span class="line"><span style="color:#24292E;">[start_time] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;开始时间&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[status] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;状态&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[command] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;命令&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">dest.[text] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;sql语句&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">([database_id]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;数据库名&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[blocking_session_id] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;正在阻塞其他的ID&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[wait_type] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;等待资源类型&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[wait_time] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;等待时间&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[wait_resource] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;等待的资源&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[reads] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;物理读次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[writes] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;写次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[logical_reads] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;逻辑读次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">[row_count] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;返回结果行数&#39;</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> sys.[dm_exec_requests] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> der</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span></span>
<span class="line"><span style="color:#24292E;">sys.[dm_exec_sql_text](der.[sql_handle]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> dest</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> [session_id]</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">50</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [cpu_time] </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><h2 id="_2-查看sql语句占用较大" tabindex="-1">2.查看sql语句占用较大 <a class="header-anchor" href="#_2-查看sql语句占用较大" aria-label="Permalink to &quot;2.查看sql语句占用较大&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">dest.[text] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;sql语句&#39;</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> sys.[dm_exec_requests] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> der</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span></span>
<span class="line"><span style="color:#E1E4E8;">sys.[dm_exec_sql_text](der.[sql_handle]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> dest</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> [session_id]</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">50</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [cpu_time] </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">dest.[text] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;sql语句&#39;</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> sys.[dm_exec_requests] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> der</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span></span>
<span class="line"><span style="color:#24292E;">sys.[dm_exec_sql_text](der.[sql_handle]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> dest</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> [session_id]</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">50</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [cpu_time] </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><p>如果SQLSERVER存在要等待的资源，那么执行下面语句就会显示出会话中有多少个worker在等待</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">50</span></span>
<span class="line"><span style="color:#E1E4E8;"> [session_id],</span></span>
<span class="line"><span style="color:#E1E4E8;"> [request_id],</span></span>
<span class="line"><span style="color:#E1E4E8;"> [cpu_time],</span></span>
<span class="line"><span style="color:#E1E4E8;"> [start_time] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;开始时间&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [status] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;状态&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [command] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;命令&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> dest.[text] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;sql语句&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">([database_id]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;数据库名&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [blocking_session_id] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;正在阻塞其他会话的会话ID&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> der.[wait_type] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;等待资源类型&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [wait_time] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;等待时间&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [wait_resource] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;等待的资源&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [dows].[waiting_tasks_count] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;当前正在进行等待的任务数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [reads] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;物理读次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [writes] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;写次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [logical_reads] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;逻辑读次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [row_count] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;返回结果行数&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> sys.[dm_exec_requests] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> der</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> [sys].[dm_os_wait_stats] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> dows</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> der.[wait_type]</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">[dows].[wait_type]</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span></span>
<span class="line"><span style="color:#E1E4E8;"> sys.[dm_exec_sql_text](der.[sql_handle]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> dest</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> [session_id]</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">50</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [cpu_time] </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">50</span></span>
<span class="line"><span style="color:#24292E;"> [session_id],</span></span>
<span class="line"><span style="color:#24292E;"> [request_id],</span></span>
<span class="line"><span style="color:#24292E;"> [cpu_time],</span></span>
<span class="line"><span style="color:#24292E;"> [start_time] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;开始时间&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [status] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;状态&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [command] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;命令&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> dest.[text] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;sql语句&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">([database_id]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;数据库名&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [blocking_session_id] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;正在阻塞其他会话的会话ID&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> der.[wait_type] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;等待资源类型&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [wait_time] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;等待时间&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [wait_resource] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;等待的资源&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [dows].[waiting_tasks_count] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;当前正在进行等待的任务数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [reads] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;物理读次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [writes] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;写次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [logical_reads] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;逻辑读次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [row_count] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;返回结果行数&#39;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> sys.[dm_exec_requests] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> der</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> [sys].[dm_os_wait_stats] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> dows</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> der.[wait_type]</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[dows].[wait_type]</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span></span>
<span class="line"><span style="color:#24292E;"> sys.[dm_exec_sql_text](der.[sql_handle]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> dest</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> [session_id]</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">50</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [cpu_time] </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><h2 id="_3-查询cpu占用最高的sql语句" tabindex="-1">3.查询CPU占用最高的SQL语句 <a class="header-anchor" href="#_3-查询cpu占用最高的sql语句" aria-label="Permalink to &quot;3.查询CPU占用最高的SQL语句&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> total_worker_time</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">execution_count </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> avg_cpu_cost, plan_handle,</span></span>
<span class="line"><span style="color:#E1E4E8;">   execution_count,</span></span>
<span class="line"><span style="color:#E1E4E8;">   (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">, statement_start_offset</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      (</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> statement_end_offset </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">LEN</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">nvarchar</span><span style="color:#E1E4E8;">(max), </span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> statement_end_offset</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> statement_start_offset)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">sql_handle</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> query_text</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_stats</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [avg_cpu_cost] </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> total_worker_time</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">execution_count </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> avg_cpu_cost, plan_handle,</span></span>
<span class="line"><span style="color:#24292E;">   execution_count,</span></span>
<span class="line"><span style="color:#24292E;">   (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">, statement_start_offset</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      (</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> statement_end_offset </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">LEN</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">nvarchar</span><span style="color:#24292E;">(max), </span><span style="color:#D73A49;">text</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> statement_end_offset</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> statement_start_offset)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">sql_handle</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> query_text</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_stats</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [avg_cpu_cost] </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><h3 id="cpu-调度程序在磁盘上等待" tabindex="-1">CPU 调度程序在磁盘上等待 <a class="header-anchor" href="#cpu-调度程序在磁盘上等待" aria-label="Permalink to &quot;CPU 调度程序在磁盘上等待&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">COUNT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">) Schedulers,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">AVG</span><span style="color:#E1E4E8;">(work_queue_count) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Avg Work Queue Count],</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">AVG</span><span style="color:#E1E4E8;">(pending_disk_io_count) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Avg Pending DiskIO Count],</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(work_queue_count) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [SUM Work Queue Count],</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(pending_disk_io_count) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [SUM Pending DiskIO Count]</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_schedulers</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">NOLOCK</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> scheduler_id </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--工作队列和挂起的 diskIO 数量非常多，那么很明显，CPU 调度程序正在等待更多 CPU 或更多磁盘 IO。这时我们需要开始单独调查每个调度程序的线程</span></span>
<span class="line"><span style="color:#E1E4E8;">执行下面三列</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">COUNT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">) Schedulers,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">AVG</span><span style="color:#24292E;">(work_queue_count) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Avg Work Queue Count],</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">AVG</span><span style="color:#24292E;">(pending_disk_io_count) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Avg Pending DiskIO Count],</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(work_queue_count) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [SUM Work Queue Count],</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(pending_disk_io_count) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [SUM Pending DiskIO Count]</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_schedulers</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">NOLOCK</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> scheduler_id </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">255</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--工作队列和挂起的 diskIO 数量非常多，那么很明显，CPU 调度程序正在等待更多 CPU 或更多磁盘 IO。这时我们需要开始单独调查每个调度程序的线程</span></span>
<span class="line"><span style="color:#24292E;">执行下面三列</span></span></code></pre></div><h3 id="cpu过去-60-分钟的详细信息" tabindex="-1">CPU过去 60 分钟的详细信息 <a class="header-anchor" href="#cpu过去-60-分钟的详细信息" aria-label="Permalink to &quot;CPU过去 60 分钟的详细信息&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @ms_ticks_now </span><span style="color:#F97583;">BIGINT</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @ms_ticks_now </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ms_ticks</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_sys_info</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60</span><span style="color:#E1E4E8;"> record_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">dateadd</span><span style="color:#E1E4E8;">(ms, </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> (@ms_ticks_now </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> [timestamp]), </span><span style="color:#79B8FF;">GetDate</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> EventTime</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,[SQLProcess (%)]</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,SystemIdle</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> SystemIdle </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> [SQLProcess (%)] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [OtherProcess (%)]</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">record</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;(./Record/@id)[1]&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;int&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> record_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        ,</span><span style="color:#79B8FF;">record</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;(./Record/SchedulerMonitorEvent/SystemHealth/SystemIdle)[1]&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;int&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> SystemIdle</span></span>
<span class="line"><span style="color:#E1E4E8;">        ,</span><span style="color:#79B8FF;">record</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;(./Record/SchedulerMonitorEvent/SystemHealth/ProcessUtilization)[1]&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;int&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [SQLProcess (%)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        ,</span><span style="color:#F97583;">TIMESTAMP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TIMESTAMP</span></span>
<span class="line"><span style="color:#E1E4E8;">            ,</span><span style="color:#79B8FF;">convert</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;">, record) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> record</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_ring_buffers</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> ring_buffer_type </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;RING_BUFFER_SCHEDULER_MONITOR&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> record </span><span style="color:#F97583;">LIKE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;%&lt;SystemHealth&gt;%&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> x</span></span>
<span class="line"><span style="color:#E1E4E8;">    ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> y</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> record_id </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @ms_ticks_now </span><span style="color:#D73A49;">BIGINT</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @ms_ticks_now </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ms_ticks</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_sys_info</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60</span><span style="color:#24292E;"> record_id</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">dateadd</span><span style="color:#24292E;">(ms, </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> (@ms_ticks_now </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> [timestamp]), </span><span style="color:#005CC5;">GetDate</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> EventTime</span></span>
<span class="line"><span style="color:#24292E;">    ,[SQLProcess (%)]</span></span>
<span class="line"><span style="color:#24292E;">    ,SystemIdle</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">100</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> SystemIdle </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> [SQLProcess (%)] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [OtherProcess (%)]</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">record</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;(./Record/@id)[1]&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;int&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> record_id</span></span>
<span class="line"><span style="color:#24292E;">        ,</span><span style="color:#005CC5;">record</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;(./Record/SchedulerMonitorEvent/SystemHealth/SystemIdle)[1]&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;int&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> SystemIdle</span></span>
<span class="line"><span style="color:#24292E;">        ,</span><span style="color:#005CC5;">record</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;(./Record/SchedulerMonitorEvent/SystemHealth/ProcessUtilization)[1]&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;int&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [SQLProcess (%)]</span></span>
<span class="line"><span style="color:#24292E;">        ,</span><span style="color:#D73A49;">TIMESTAMP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TIMESTAMP</span></span>
<span class="line"><span style="color:#24292E;">            ,</span><span style="color:#005CC5;">convert</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">XML</span><span style="color:#24292E;">, record) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> record</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_ring_buffers</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> ring_buffer_type </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;RING_BUFFER_SCHEDULER_MONITOR&#39;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> record </span><span style="color:#D73A49;">LIKE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;%&lt;SystemHealth&gt;%&#39;</span></span>
<span class="line"><span style="color:#24292E;">        ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> x</span></span>
<span class="line"><span style="color:#24292E;">    ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> y</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> record_id </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><h3 id="哪个查询占用了最大-cpu-查看当前正在运行的查询" tabindex="-1">哪个查询占用了最大 CPU,查看当前正在运行的查询 <a class="header-anchor" href="#哪个查询占用了最大-cpu-查看当前正在运行的查询" aria-label="Permalink to &quot;哪个查询占用了最大 CPU,查看当前正在运行的查询&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">st</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">TEXT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> batch_text</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">st</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">TEXT</span><span style="color:#E1E4E8;">, statement_start_offset </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, (</span></span>
<span class="line"><span style="color:#E1E4E8;">            (</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">CASE</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">LEN</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(max), </span><span style="color:#79B8FF;">st</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">TEXT</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#E1E4E8;">                ) </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span></span>
<span class="line"><span style="color:#E1E4E8;">            ) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> statement_text</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">qp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_plan</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;XML Plan&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">cpu_time</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_elapsed_time</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">logical_reads</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">writes</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dop</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> r</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> st</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_plan</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">plan_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> qp</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> cpu_time </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">st</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">TEXT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> batch_text</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">st</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">TEXT</span><span style="color:#24292E;">, statement_start_offset </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, (</span></span>
<span class="line"><span style="color:#24292E;">            (</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">CASE</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">LEN</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(max), </span><span style="color:#005CC5;">st</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">TEXT</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#24292E;">                ) </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span></span>
<span class="line"><span style="color:#24292E;">            ) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> statement_text</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">qp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_plan</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;XML Plan&#39;</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">cpu_time</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_elapsed_time</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">logical_reads</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">writes</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dop</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> r</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> st</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_plan</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">plan_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> qp</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> cpu_time </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><h3 id="使用-cpu-的历史查询" tabindex="-1">使用 CPU 的历史查询 <a class="header-anchor" href="#使用-cpu-的历史查询" aria-label="Permalink to &quot;使用 CPU 的历史查询&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">) </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_count</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Execution Count],</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_logical_reads</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Total Logical Reads in ms],</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_logical_reads</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_count</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Avg Logical Reads in ms],</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_worker_time</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Total Worker Time in ms],</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_worker_time</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_count</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Avg Worker Time in ms],</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_elapsed_time</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Total Elapsed Time in ms],</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_elapsed_time</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_count</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Avg Elapsed Time in ms],</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">creation_time</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Creation Time]</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Complete Query Text], </span><span style="color:#79B8FF;">qp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_plan</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Query Plan]</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_stats</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> qs </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">NOLOCK</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(plan_handle) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> t</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_plan</span><span style="color:#E1E4E8;">(plan_handle) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> qp</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_ID</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_logical_reads</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_count</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">) </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_count</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Execution Count],</span></span>
<span class="line"><span style="color:#24292E;">    (</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_logical_reads</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Total Logical Reads in ms],</span></span>
<span class="line"><span style="color:#24292E;">    (</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_logical_reads</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_count</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Avg Logical Reads in ms],</span></span>
<span class="line"><span style="color:#24292E;">    (</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_worker_time</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Total Worker Time in ms],</span></span>
<span class="line"><span style="color:#24292E;">    (</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_worker_time</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_count</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Avg Worker Time in ms],</span></span>
<span class="line"><span style="color:#24292E;">    (</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_elapsed_time</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Total Elapsed Time in ms],</span></span>
<span class="line"><span style="color:#24292E;">    (</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_elapsed_time</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_count</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Avg Elapsed Time in ms],</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">creation_time</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Creation Time]</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Complete Query Text], </span><span style="color:#005CC5;">qp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_plan</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Query Plan]</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_stats</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> qs </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">NOLOCK</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(plan_handle) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> t</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_plan</span><span style="color:#24292E;">(plan_handle) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> qp</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_ID</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_logical_reads</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_count</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="总耗cpu最多的前个sql" tabindex="-1">总耗CPU最多的前个SQL <a class="header-anchor" href="#总耗cpu最多的前个sql" aria-label="Permalink to &quot;总耗CPU最多的前个SQL&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">----- --总耗CPU最多的前个SQL:</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span></span>
<span class="line"><span style="color:#E1E4E8;">    total_worker_time</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [总消耗CPU 时间(ms)],execution_count [运行次数],</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_worker_time</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_count</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [平均消耗CPU 时间(ms)],</span></span>
<span class="line"><span style="color:#E1E4E8;">    last_execution_time </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [最后一次执行时间],max_worker_time </span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [最大执行时间(ms)],</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        (</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATALENGTH</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [使用CPU的语法], </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;"> [完整语法],</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;">, dbname</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">db_name</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objectid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">object_name</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objectid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;">) ObjectName</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_stats</span><span style="color:#E1E4E8;"> qs </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">nolock</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> qt</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> execution_count</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;">  total_worker_time </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">----- --总耗CPU最多的前个SQL:</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span></span>
<span class="line"><span style="color:#24292E;">    total_worker_time</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [总消耗CPU 时间(ms)],execution_count [运行次数],</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_worker_time</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_count</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [平均消耗CPU 时间(ms)],</span></span>
<span class="line"><span style="color:#24292E;">    last_execution_time </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [最后一次执行时间],max_worker_time </span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [最大执行时间(ms)],</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        (</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATALENGTH</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [使用CPU的语法], </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;"> [完整语法],</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;">, dbname</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">db_name</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objectid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">object_name</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objectid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;">) ObjectName</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_stats</span><span style="color:#24292E;"> qs </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">nolock</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> qt</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> execution_count</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;">  total_worker_time </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><h3 id="平均耗cpu最多的前个sql" tabindex="-1"><strong>平均耗CPU最多的前个SQL</strong> <a class="header-anchor" href="#平均耗cpu最多的前个sql" aria-label="Permalink to &quot;**平均耗CPU最多的前个SQL**&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">---平均耗CPU最多的前个SQL:</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span></span>
<span class="line"><span style="color:#E1E4E8;">    total_worker_time</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [总消耗CPU 时间(ms)],execution_count [运行次数],</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_worker_time</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_count</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [平均消耗CPU 时间(ms)],</span></span>
<span class="line"><span style="color:#E1E4E8;">    last_execution_time </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [最后一次执行时间],min_worker_time </span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [最小执行时间(ms)],</span></span>
<span class="line"><span style="color:#E1E4E8;">    max_worker_time </span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [最大执行时间(ms)],</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        (</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATALENGTH</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [使用CPU的语法], </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;"> [完整语法],</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;">, dbname</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">db_name</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objectid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">object_name</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objectid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;">) ObjectName</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_stats</span><span style="color:#E1E4E8;"> qs </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">nolock</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> qt</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">  execution_count</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_worker_time</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">qs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_count</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">---平均耗CPU最多的前个SQL:</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span></span>
<span class="line"><span style="color:#24292E;">    total_worker_time</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [总消耗CPU 时间(ms)],execution_count [运行次数],</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_worker_time</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_count</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [平均消耗CPU 时间(ms)],</span></span>
<span class="line"><span style="color:#24292E;">    last_execution_time </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [最后一次执行时间],min_worker_time </span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [最小执行时间(ms)],</span></span>
<span class="line"><span style="color:#24292E;">    max_worker_time </span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [最大执行时间(ms)],</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        (</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATALENGTH</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [使用CPU的语法], </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;"> [完整语法],</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;">, dbname</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">db_name</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objectid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">object_name</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objectid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;">) ObjectName</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_stats</span><span style="color:#24292E;"> qs </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">nolock</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> qt</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">  execution_count</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_worker_time</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">qs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_count</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><blockquote><p>如何清理看到的这些语句所运行缓存的清理</p><p>首先是清除存储过程相关的缓存语句</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">DBCC FREEPROCCACHE </span><span style="color:#6A737D;">-----清理缓存</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">DBCC FREEPROCCACHE </span><span style="color:#6A737D;">-----清理缓存</span></span></code></pre></div><p>然后对该数据库的-会话缓存</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">DBCC FREESESSIONCACHE </span><span style="color:#6A737D;">---会话清理</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">DBCC FREESESSIONCACHE </span><span style="color:#6A737D;">---会话清理</span></span></code></pre></div><p>最后两个执行的语句是对数据系统清理的语句</p><p>DBCC FREESYSTEMCACHE(&#39;All&#39;) --------系统缓存 DBCC DROPCLEANBUFFERS ---------所有缓存</p></blockquote><h3 id="sql阻塞进程" tabindex="-1">SQL阻塞进程 <a class="header-anchor" href="#sql阻塞进程" aria-label="Permalink to &quot;SQL阻塞进程&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">t1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">request_session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;wait_sid&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">t1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">resource_type</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;锁类型&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(resource_database_id) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;库明称&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">t1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">request_mode</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;wait锁类型&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">wait_duration_ms</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;wait_time_ms&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">text</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> r</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">request_session_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;wait_run_batch&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                              ( </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">                                     </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATALENGTH</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                                     </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#E1E4E8;"> ) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> r</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> qt</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">request_session_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;wait 运行的SQL语句&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;锁定sid&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">text</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sysprocesses</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> p</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">spid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;锁定SQL&#39;</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_tran_locks</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> t1</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_waiting_tasks</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> t2 </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">lock_owner_address</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">resource_address</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">t1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">request_session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;wait_sid&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">t1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">resource_type</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;锁类型&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(resource_database_id) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;库明称&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">t1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">request_mode</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;wait锁类型&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">wait_duration_ms</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;wait_time_ms&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">text</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> r</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">request_session_id</span></span>
<span class="line"><span style="color:#24292E;">        ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;wait_run_batch&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                              ( </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">                                     </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATALENGTH</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                                     </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#24292E;"> ) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> r</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> qt</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">request_session_id</span></span>
<span class="line"><span style="color:#24292E;">        ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;wait 运行的SQL语句&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;锁定sid&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">text</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sysprocesses</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> p</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">spid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span></span>
<span class="line"><span style="color:#24292E;">        ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;锁定SQL&#39;</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_tran_locks</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> t1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_waiting_tasks</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> t2 </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">lock_owner_address</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">resource_address</span></span></code></pre></div><h2 id="_4-索引缺失" tabindex="-1">4.索引缺失 <a class="header-anchor" href="#_4-索引缺失" aria-label="Permalink to &quot;4.索引缺失&quot;">​</a></h2><h1 id="_6-spid" tabindex="-1">6.SPID <a class="header-anchor" href="#_6-spid" aria-label="Permalink to &quot;6.SPID&quot;">​</a></h1><h2 id="_6-1根据spid名字" tabindex="-1">6.1根据spid名字 <a class="header-anchor" href="#_6-1根据spid名字" aria-label="Permalink to &quot;6.1根据spid名字&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--- 查询db_name中所有spid</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> spid </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span><span style="color:#E1E4E8;">..sysprocesses </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">dbid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;db_Name&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">---spid可以查看sql语句执行</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC  INPUTBUFFER(spid)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--- 查询db_name中所有spid</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> spid </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span><span style="color:#24292E;">..sysprocesses </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">dbid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;db_Name&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">---spid可以查看sql语句执行</span></span>
<span class="line"><span style="color:#24292E;">DBCC  INPUTBUFFER(spid)</span></span></code></pre></div><h1 id="_7-死锁跟踪" tabindex="-1">7.死锁跟踪 <a class="header-anchor" href="#_7-死锁跟踪" aria-label="Permalink to &quot;7.死锁跟踪&quot;">​</a></h1><h2 id="_7-1利用服务器端跟踪" tabindex="-1">7.1利用服务器端跟踪 <a class="header-anchor" href="#_7-1利用服务器端跟踪" aria-label="Permalink to &quot;7.1利用服务器端跟踪&quot;">​</a></h2><h3 id="创建脚本" tabindex="-1">创建脚本 <a class="header-anchor" href="#创建脚本" aria-label="Permalink to &quot;创建脚本&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 针对那个库进行</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> hantest</span></span>
<span class="line"><span style="color:#F97583;">go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--创建跟踪文件返回值</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @rc </span><span style="color:#F97583;">int</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--创建一个跟踪句柄</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @TraceID </span><span style="color:#F97583;">int</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--创建跟踪文件路径</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @TraceFilePath </span><span style="color:#F97583;">nvarchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">500</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @TraceFilePath</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;D:\\DBA_TOOLS\\db_deadLock_log&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--跟踪文件的大小</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @maxfilesize </span><span style="color:#F97583;">bigint</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @maxfilesize</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">200</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--设置停止的时间</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @EndTime </span><span style="color:#F97583;">datetime</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @EndTime</span><span style="color:#F97583;">=null</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--设置系统默认的操作</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @options </span><span style="color:#F97583;">int</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @options</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--设置默认滚动文件的数目</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @filecount </span><span style="color:#F97583;">int</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @filecount</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> @rc</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">sp_trace_Create</span></span>
<span class="line"><span style="color:#E1E4E8;">    @TraceID </span><span style="color:#F97583;">output</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    @options,</span></span>
<span class="line"><span style="color:#E1E4E8;">    @TraceFilePath,</span></span>
<span class="line"><span style="color:#E1E4E8;">    @maxfilesize,</span></span>
<span class="line"><span style="color:#E1E4E8;">    @EndTime,</span></span>
<span class="line"><span style="color:#E1E4E8;">    @filecount</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;">(@rc</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @on </span><span style="color:#F97583;">bit</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @on </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--下述语句中的148指的是locks:deadlock graph事件(参见sys.trace_events),12指的是spid列(参见sys.trace_columns)  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setevent @TraceID, </span><span style="color:#79B8FF;">148</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">, @on    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setevent @TraceID, </span><span style="color:#79B8FF;">148</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">11</span><span style="color:#E1E4E8;">, @on  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setevent @TraceID, </span><span style="color:#79B8FF;">148</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">, @on  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setevent @TraceID, </span><span style="color:#79B8FF;">148</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">, @on  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setevent @TraceID, </span><span style="color:#79B8FF;">148</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">26</span><span style="color:#E1E4E8;">, @on  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setevent @TraceID, </span><span style="color:#79B8FF;">148</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">64</span><span style="color:#E1E4E8;">, @on  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setevent @TraceID, </span><span style="color:#79B8FF;">148</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, @on  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- 启动跟踪  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setstatus @TraceID, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- 记录下跟踪ID，后面使用  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> TraceID </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @TraceID  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">goto</span><span style="color:#E1E4E8;"> finish  </span></span>
<span class="line"><span style="color:#E1E4E8;">    error:   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> ErrorCode</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">@rc  </span></span>
<span class="line"><span style="color:#E1E4E8;">    finish:   </span></span>
<span class="line"><span style="color:#F97583;">go</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 针对那个库进行</span></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> hantest</span></span>
<span class="line"><span style="color:#D73A49;">go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--创建跟踪文件返回值</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @rc </span><span style="color:#D73A49;">int</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--创建一个跟踪句柄</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @TraceID </span><span style="color:#D73A49;">int</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--创建跟踪文件路径</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @TraceFilePath </span><span style="color:#D73A49;">nvarchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">500</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @TraceFilePath</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;D:\\DBA_TOOLS\\db_deadLock_log&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--跟踪文件的大小</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @maxfilesize </span><span style="color:#D73A49;">bigint</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @maxfilesize</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">200</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--设置停止的时间</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @EndTime </span><span style="color:#D73A49;">datetime</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @EndTime</span><span style="color:#D73A49;">=null</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--设置系统默认的操作</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @options </span><span style="color:#D73A49;">int</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @options</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--设置默认滚动文件的数目</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @filecount </span><span style="color:#D73A49;">int</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @filecount</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> @rc</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">sp_trace_Create</span></span>
<span class="line"><span style="color:#24292E;">    @TraceID </span><span style="color:#D73A49;">output</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    @options,</span></span>
<span class="line"><span style="color:#24292E;">    @TraceFilePath,</span></span>
<span class="line"><span style="color:#24292E;">    @maxfilesize,</span></span>
<span class="line"><span style="color:#24292E;">    @EndTime,</span></span>
<span class="line"><span style="color:#24292E;">    @filecount</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(@rc</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @on </span><span style="color:#D73A49;">bit</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @on </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--下述语句中的148指的是locks:deadlock graph事件(参见sys.trace_events),12指的是spid列(参见sys.trace_columns)  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setevent @TraceID, </span><span style="color:#005CC5;">148</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">12</span><span style="color:#24292E;">, @on    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setevent @TraceID, </span><span style="color:#005CC5;">148</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">11</span><span style="color:#24292E;">, @on  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setevent @TraceID, </span><span style="color:#005CC5;">148</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">, @on  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setevent @TraceID, </span><span style="color:#005CC5;">148</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">14</span><span style="color:#24292E;">, @on  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setevent @TraceID, </span><span style="color:#005CC5;">148</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">26</span><span style="color:#24292E;">, @on  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setevent @TraceID, </span><span style="color:#005CC5;">148</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">64</span><span style="color:#24292E;">, @on  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setevent @TraceID, </span><span style="color:#005CC5;">148</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, @on  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- 启动跟踪  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setstatus @TraceID, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- 记录下跟踪ID，后面使用  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> TraceID </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @TraceID  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">goto</span><span style="color:#24292E;"> finish  </span></span>
<span class="line"><span style="color:#24292E;">    error:   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> ErrorCode</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">@rc  </span></span>
<span class="line"><span style="color:#24292E;">    finish:   </span></span>
<span class="line"><span style="color:#D73A49;">go</span></span></code></pre></div><blockquote><p>运行上述语句后，每当SQL Server中发生死锁事件,都会自动往文件D:\\DBA_TOOLS\\db_deadLock_log\\deadlockdetect.trc中插入一条记录</p></blockquote><h3 id="开机启动" tabindex="-1">开机启动 <a class="header-anchor" href="#开机启动" aria-label="Permalink to &quot;开机启动&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--默认重启实例后，跟踪会取消，所以写一个SP做实例启动执行</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">go</span></span>
<span class="line"><span style="color:#F97583;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">proc</span><span style="color:#E1E4E8;"> StartBlackBoxTrace</span></span>
<span class="line"><span style="color:#F97583;">as</span></span>
<span class="line"><span style="color:#F97583;">begin</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">--默认开启追踪所有的SQL 执行语句，文件文件路径为默认</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#6A737D;">--创建跟踪文件返回值</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @rc </span><span style="color:#F97583;">int</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">--创建一个跟踪句柄</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @TraceID </span><span style="color:#F97583;">int</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">--创建跟踪文件路径</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @TraceFilePath </span><span style="color:#F97583;">nvarchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">500</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @TraceFilePath</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;D:\\DBA_TOOLS\\db_deadLock_log&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">--跟踪文件的大小</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @maxfilesize </span><span style="color:#F97583;">bigint</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @maxfilesize</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">200</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">--设置停止的时间</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @EndTime </span><span style="color:#F97583;">datetime</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @EndTime</span><span style="color:#F97583;">=null</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">--设置系统默认的操作</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @options </span><span style="color:#F97583;">int</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @options</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">--设置默认滚动文件的数目</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @filecount </span><span style="color:#F97583;">int</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @filecount</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> @rc</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">sp_trace_Create</span></span>
<span class="line"><span style="color:#E1E4E8;">            @TraceID </span><span style="color:#F97583;">output</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            @options,</span></span>
<span class="line"><span style="color:#E1E4E8;">            @TraceFilePath,</span></span>
<span class="line"><span style="color:#E1E4E8;">            @maxfilesize,</span></span>
<span class="line"><span style="color:#E1E4E8;">            @EndTime,</span></span>
<span class="line"><span style="color:#E1E4E8;">            @filecount</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;">(@rc</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;">  @TraceID</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @on </span><span style="color:#F97583;">bit</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @on </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">--下述语句中的148指的是locks:deadlock graph事件(参见sys.trace_events),12指的是spid列(参见sys.trace_columns)  </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setevent @TraceID, </span><span style="color:#79B8FF;">148</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">, @on    </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setevent @TraceID, </span><span style="color:#79B8FF;">148</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">11</span><span style="color:#E1E4E8;">, @on  </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setevent @TraceID, </span><span style="color:#79B8FF;">148</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">, @on  </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setevent @TraceID, </span><span style="color:#79B8FF;">148</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">, @on  </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setevent @TraceID, </span><span style="color:#79B8FF;">148</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">26</span><span style="color:#E1E4E8;">, @on  </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setevent @TraceID, </span><span style="color:#79B8FF;">148</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">64</span><span style="color:#E1E4E8;">, @on  </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setevent @TraceID, </span><span style="color:#79B8FF;">148</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, @on  </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">-- 启动跟踪  </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setstatus @TraceID, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#6A737D;">--将该存储过程设置为SQL Server服务启动时自动启动</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_procoption</span></span>
<span class="line"><span style="color:#9ECBFF;">&#39;StartBlackBoxTrace&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;STARTUP&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;ON&#39;</span></span>
<span class="line"><span style="color:#F97583;">print</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ok&#39;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--默认重启实例后，跟踪会取消，所以写一个SP做实例启动执行</span></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">go</span></span>
<span class="line"><span style="color:#D73A49;">create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">proc</span><span style="color:#24292E;"> StartBlackBoxTrace</span></span>
<span class="line"><span style="color:#D73A49;">as</span></span>
<span class="line"><span style="color:#D73A49;">begin</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">--默认开启追踪所有的SQL 执行语句，文件文件路径为默认</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#6A737D;">--创建跟踪文件返回值</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @rc </span><span style="color:#D73A49;">int</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">--创建一个跟踪句柄</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @TraceID </span><span style="color:#D73A49;">int</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">--创建跟踪文件路径</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @TraceFilePath </span><span style="color:#D73A49;">nvarchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">500</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @TraceFilePath</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;D:\\DBA_TOOLS\\db_deadLock_log&#39;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">--跟踪文件的大小</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @maxfilesize </span><span style="color:#D73A49;">bigint</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @maxfilesize</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">200</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">--设置停止的时间</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @EndTime </span><span style="color:#D73A49;">datetime</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @EndTime</span><span style="color:#D73A49;">=null</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">--设置系统默认的操作</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @options </span><span style="color:#D73A49;">int</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @options</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">--设置默认滚动文件的数目</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @filecount </span><span style="color:#D73A49;">int</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @filecount</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> @rc</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">sp_trace_Create</span></span>
<span class="line"><span style="color:#24292E;">            @TraceID </span><span style="color:#D73A49;">output</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            @options,</span></span>
<span class="line"><span style="color:#24292E;">            @TraceFilePath,</span></span>
<span class="line"><span style="color:#24292E;">            @maxfilesize,</span></span>
<span class="line"><span style="color:#24292E;">            @EndTime,</span></span>
<span class="line"><span style="color:#24292E;">            @filecount</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">(@rc</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">select</span><span style="color:#24292E;">  @TraceID</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @on </span><span style="color:#D73A49;">bit</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @on </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">--下述语句中的148指的是locks:deadlock graph事件(参见sys.trace_events),12指的是spid列(参见sys.trace_columns)  </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setevent @TraceID, </span><span style="color:#005CC5;">148</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">12</span><span style="color:#24292E;">, @on    </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setevent @TraceID, </span><span style="color:#005CC5;">148</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">11</span><span style="color:#24292E;">, @on  </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setevent @TraceID, </span><span style="color:#005CC5;">148</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">, @on  </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setevent @TraceID, </span><span style="color:#005CC5;">148</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">14</span><span style="color:#24292E;">, @on  </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setevent @TraceID, </span><span style="color:#005CC5;">148</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">26</span><span style="color:#24292E;">, @on  </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setevent @TraceID, </span><span style="color:#005CC5;">148</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">64</span><span style="color:#24292E;">, @on  </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setevent @TraceID, </span><span style="color:#005CC5;">148</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, @on  </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">-- 启动跟踪  </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setstatus @TraceID, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#6A737D;">--将该存储过程设置为SQL Server服务启动时自动启动</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_procoption</span></span>
<span class="line"><span style="color:#032F62;">&#39;StartBlackBoxTrace&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;STARTUP&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;ON&#39;</span></span>
<span class="line"><span style="color:#D73A49;">print</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ok&#39;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><h3 id="查看traces" tabindex="-1">查看traces <a class="header-anchor" href="#查看traces" aria-label="Permalink to &quot;查看traces&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--查看</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">traces</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--查看</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">traces</span></span></code></pre></div><h3 id="暂停和停止及删除服务器端跟踪" tabindex="-1">暂停和停止及删除服务器端跟踪 <a class="header-anchor" href="#暂停和停止及删除服务器端跟踪" aria-label="Permalink to &quot;暂停和停止及删除服务器端跟踪&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--删除</span></span>
<span class="line"><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setstatus </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_trace_setstatus </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--删除</span></span>
<span class="line"><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setstatus </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_trace_setstatus </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span></span></code></pre></div><p>如果要启动上面的服务端跟踪，可运行下面的语句：</p><p>exec sp_trace_setstatus 2, 1 --第一个参数2表示 TraceID，可以通过select * from sys.traces查看跟踪ID。第二个参数表示将状态改为1，即启动</p><p>如果要停止上面的服务器端跟踪，可运行下面的语句：</p><p>exec sp_trace_setstatus 1, 0 --第一个参数表示TraceID,即步骤1中的输出参数。第二个参数表示将状态改为0，即暂停</p><p>如果要移除上面的服务器端跟踪，可运行下面的语句：</p><p>exec sp_trace_setstatus 1, 2 --第一个参数表示TraceID,即步骤1中的输出参数。第二个参数表示将状态改为2，即停止</p><h3 id="查看跟踪文件内容" tabindex="-1">查看跟踪文件内容 <a class="header-anchor" href="#查看跟踪文件内容" aria-label="Permalink to &quot;查看跟踪文件内容&quot;">​</a></h3><p>对于上面生成的跟踪文件(D:/DBA_TOOLS/db_deadLock_lo/deadlockdetect.trc),可通过两种方法查看：</p><p>1).执行t-sql命令</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> fn_trace_gettable(</span><span style="color:#9ECBFF;">&#39;D:/DBA_TOOLS/db_deadLock_lo/deadlockdetect.trc&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> fn_trace_gettable(</span><span style="color:#032F62;">&#39;D:/DBA_TOOLS/db_deadLock_lo/deadlockdetect.trc&#39;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span></code></pre></div><p>结果中的Extricate列即以XML的形式返回死锁的详细信息。</p><p>2).在SQL Server Profiler中打开。</p><p>依次 进入Profiler -&gt; 打开跟踪文件 -&gt;选择D:/DBA_TOOLS/db_deadLock_lo/deadlockdetect.trc，就可以看到以图形形式展现的死锁信息</p><h2 id="_7-2死锁trace-flag" tabindex="-1">7.2死锁Trace Flag <a class="header-anchor" href="#_7-2死锁trace-flag" aria-label="Permalink to &quot;7.2死锁Trace Flag&quot;">​</a></h2><p>文档，<a href="https://learn.microsoft.com/en-us/sql/t-sql/database-console-commands/dbcc-traceon-trace-flags-transact-sql?view=sql-server-2017" target="_blank" rel="noreferrer">https://learn.microsoft.com/en-us/sql/t-sql/database-console-commands/dbcc-traceon-trace-flags-transact-sql?view=sql-server-2017</a></p><p>SQL Server 跟死锁相关的Trace Flag是 1204 和 1222，两个Trace Flag的Scope都是global only，两者记录的信息基本相同，都会把造成死锁的两个事务、抢占的资源、死锁类型和命令记录下来。前者是以文本格式记录，后者是以XML格式记录的，可以同时打开这两个追踪标志，记录的数据都存储在错误日志（Error Log）中。</p><p>微软的官方文档对这两个Trace Falg的定义是：</p><ul><li>1204：Returns the resources and types of locks participating in a deadlock and also the current command affected.</li><li>1222：Returns the resources and types of locks that are participating in a deadlock and also the current command affected, in an XML format that does not comply with any XSD schema.</li></ul><h2 id="_7-3-慢查询开启" tabindex="-1">7.3 慢查询开启 <a class="header-anchor" href="#_7-3-慢查询开启" aria-label="Permalink to &quot;7.3 慢查询开启&quot;">​</a></h2><p>1.打开ssm</p><p>2.点击你要记录慢查询日志的数据库-- 右键属性-- 查询存储 （query stone）</p><p><strong><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408051018528.png" alt="image-20240805101840540"></strong></p><p>而慢查询有几种方式体现</p><p>1 查询时间长</p><p>2 使用物理I/O 多</p><p>3 内存占用多少</p><h3 id="参考文档" tabindex="-1">参考文档： <a class="header-anchor" href="#参考文档" aria-label="Permalink to &quot;参考文档：&quot;">​</a></h3><ol><li>SQL Server Objects: <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdocs.microsoft.com%2Fzh-cn%2Fsql%2Frelational-databases%2Fperformance-monitor%2Fuse-sql-server-objects%3Fview%3Dsql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/relational-databases/performance-monitor/use-sql-server-objects?view=sql-server-2017</a></li><li>SQLServer:SQL Statistics object: <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdocs.microsoft.com%2Fzh-cn%2Fsql%2Frelational-databases%2Fperformance-monitor%2Fsql-server-sql-statistics-object%3Fview%3Dsql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/relational-databases/performance-monitor/sql-server-sql-statistics-object?view=sql-server-2017</a></li><li>sys.dm_os_performance_counters 返回内容相关： <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdocs.microsoft.com%2Fzh-cn%2Fsql%2Frelational-databases%2Fsystem-dynamic-management-views%2Fsys-dm-os-performance-counters-transact-sql%3Fview%3Dsql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/relational-databases/system-dynamic-management-views/sys-dm-os-performance-counters-transact-sql?view=sql-server-2017</a></li><li>Database States： <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fdocs.microsoft.com%2Fzh-cn%2Fsql%2Frelational-databases%2Fdatabases%2Fdatabase-states%3Fview%3Dsql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/relational-databases/databases/database-states?view=sql-server-2017</a></li><li>公有云厂商说明文档 <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fsupport.huaweicloud.com%2Fusermanual-rds%2Frds_sqlserver_06_0001.html" target="_blank" rel="noreferrer">https://support.huaweicloud.com/usermanual-rds/rds_sqlserver_06_0001.html</a><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F238%2F7524" target="_blank" rel="noreferrer">https://cloud.tencent.com/document/product/238/7524</a></li></ol><p><a href="http://www.360doc.com/content/16/0318/15/11991_543342020.shtml" target="_blank" rel="noreferrer">http://www.360doc.com/content/16/0318/15/11991_543342020.shtml</a></p><p><a href="https://developer.aliyun.com/profile/z6fkuw7gdpnnm/article_1?spm=a2c6h.12873639.article-detail.84.f0d8635bRqGdEM" target="_blank" rel="noreferrer">https://developer.aliyun.com/profile/z6fkuw7gdpnnm/article_1?spm=a2c6h.12873639.article-detail.84.f0d8635bRqGdEM</a></p>`,248),e=[o];function t(c,r,E,y,i,F){return a(),n("div",null,e)}const _=s(p,[["render",t]]);export{d as __pageData,_ as default};
