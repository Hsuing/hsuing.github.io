import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const F=JSON.parse('{"title":"1. kube-state-metrics","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/monitor/prometheus/3-组件介绍.md","filePath":"guide/container/k8s/monitor/prometheus/3-组件介绍.md","lastUpdated":1731319766000}'),p={name:"guide/container/k8s/monitor/prometheus/3-组件介绍.md"},e=l(`<p>官方文档,<a href="https://github.com/kubernetes/kube-state-metrics" target="_blank" rel="noreferrer">https://github.com/kubernetes/kube-state-metrics</a></p><h1 id="_1-kube-state-metrics" tabindex="-1">1. kube-state-metrics <a class="header-anchor" href="#_1-kube-state-metrics" aria-label="Permalink to &quot;1. kube-state-metrics&quot;">​</a></h1><p>将 Kubernetes API 中的各种对象状态信息转化为Prometheus 可以使用的监控指标数据</p><h2 id="_1-1-版本对应关系" tabindex="-1">1.1 版本对应关系 <a class="header-anchor" href="#_1-1-版本对应关系" aria-label="Permalink to &quot;1.1 版本对应关系&quot;">​</a></h2><table><thead><tr><th>kube-state-metrics</th><th>Kubernetes client-go Version</th></tr></thead><tbody><tr><td><strong>v2.4.2</strong></td><td>v1.22,v1.23,1.24</td></tr><tr><td><strong>v2.5.0</strong></td><td>v1.22,v1.23,1.24</td></tr><tr><td><strong>v2.8.2</strong></td><td>v1.26</td></tr><tr><td><strong>v2.9.2</strong></td><td>v1.26</td></tr><tr><td><strong>v2.10.1</strong></td><td>v1.27</td></tr><tr><td><strong>v2.11.0</strong></td><td>v1.28</td></tr><tr><td><strong>v2.12.0</strong></td><td>v1.29</td></tr><tr><td><strong>v2.13.0</strong></td><td>v1.30</td></tr><tr><td><strong>v2.14.0</strong></td><td>v1.31</td></tr><tr><td><strong>main</strong></td><td>v1.31</td></tr></tbody></table><h2 id="_1-2-常见指标说明" tabindex="-1">1.2 常见指标说明 <a class="header-anchor" href="#_1-2-常见指标说明" aria-label="Permalink to &quot;1.2 常见指标说明&quot;">​</a></h2><p>kube-state-metrics 中的常用监控查询指标，如下表所示。</p><table><thead><tr><th><strong>分类</strong></th><th><strong>指标名称</strong></th><th><strong>类型</strong></th><th><strong>含义</strong></th></tr></thead><tbody><tr><td>节点</td><td>kube_node_info</td><td>Gauge</td><td>查询集群内所有的节点信息，可以通过 sum() 函数获得集群中的所有节点数目。</td></tr><tr><td>kube_node_spec_unschedulable</td><td>Gauge</td><td>查询节点是否可以调度新的 Pod。可以通过 sum() 函数获得集群中可以调度的 Pod 总数。</td><td></td></tr><tr><td>kube_node_status_allocatable</td><td>Gauge</td><td>查询节点可用于调度的资源总数。包括：CPU、内存、Pods 等。允许通过标签筛选，查看节点具体的资源容量。</td><td></td></tr><tr><td>kube_node_status_capacity</td><td>Gauge</td><td>查询节点的全部资源总数，包括：CPU、内存、Pods 等。允许通过标签筛选，查看节点具体的资源容量。</td><td></td></tr><tr><td>kube_node_status_condition</td><td>Gauge</td><td>查询节点的状态，可以基于 OutOfDisk、MemoryPressure、DiskPressure 等状态找到状态不正常的节点。</td><td></td></tr><tr><td>Pod</td><td>kube_pod_info</td><td>Gauge</td><td>查询所有的 Pod 信息，可以通过 sum() 函数获得集群中的所有 Pod 数目。</td></tr><tr><td>kube_pod_status_phase</td><td>Gauge</td><td>查询所有的 Pod 启动状态。状态包括：True：启动成功。Failed：启动失败。Unknown：状态未知。</td><td></td></tr><tr><td>kube_pod_status_ready</td><td>Gauge</td><td>查询所有处于 Ready 状态的 Pod。可以通过 sum() 函数获得集群中的所有 Pod 数目。</td><td></td></tr><tr><td>kube_pod_status_scheduled</td><td>Gauge</td><td>查询所有处于 scheduled 状态的 Pod。可以通过 sum() 函数获得集群中的所有 Pod 数目。</td><td></td></tr><tr><td>容器</td><td>kube_pod_container_info</td><td>Gauge</td><td>查询所有 Container 的信息。可以通过 sum() 函数获得集群中的所有 Container 数目。</td></tr><tr><td>kube_pod_container_status_ready</td><td>Gauge</td><td>查询所有状态为 Ready 的 Container 信息。可以通过 sum() 函数获得集群中的所有 Container 数目。</td><td></td></tr><tr><td>kube_pod_container_status_restarts_total</td><td>Count</td><td>查询集群中所有 Container 的重启累计次数。可以通过 irate() 函数获得集群中 Container 的重启率。</td><td></td></tr><tr><td>kube_pod_container_status_running</td><td>Gauge</td><td>查询所有状态为 Running 的 Container 信息。可以通过 sum() 函数获得集群中的所有 Container 数目。</td><td></td></tr><tr><td>kube_pod_container_status_terminated</td><td>Gauge</td><td>查询所有状态为 Terminated 的 Container 信息。可以通过 sum() 函数获得集群中的所有 Container 数目。</td><td></td></tr><tr><td>kube_pod_container_status_waiting</td><td>Gauge</td><td>查询所有状态为 Waiting 的 Container 信息。可以通过 sum() 函数获得集群中的所有 Container 数目。</td><td></td></tr><tr><td>kube_pod_container_resource_requests</td><td>Gauge</td><td>查询容器的资源需求量。允许通过标签筛选，查看容器具体的资源需求量。</td><td></td></tr><tr><td>kube_pod_container_resource_limits</td><td>Gauge</td><td>查询容器的资源限制量。允许通过标签筛选，查看容器具体的资源限制量。</td><td></td></tr></tbody></table><h2 id="_1-3-监控kubernetes集群监控的各个维度以及策略" tabindex="-1">1.3 监控Kubernetes集群监控的各个维度以及策略 <a class="header-anchor" href="#_1-3-监控kubernetes集群监控的各个维度以及策略" aria-label="Permalink to &quot;1.3 监控Kubernetes集群监控的各个维度以及策略&quot;">​</a></h2><table><thead><tr><th>目标</th><th>服务发现模式</th><th>监控方法</th><th>数据源</th></tr></thead><tbody><tr><td>从集群各节点kubelet组件中获取节点kubelet的基本运行状态的监控指标</td><td>node</td><td>白盒监控</td><td>kubelet</td></tr><tr><td>从集群各节点kubelet内置的cAdvisor中获取，节点中运行的容器的监控指标</td><td>node</td><td>白盒监控</td><td>kubelet</td></tr><tr><td>从部署到各个节点的Node Exporter中采集主机资源相关的运行资源</td><td>node</td><td>白盒监控</td><td>node exporter</td></tr><tr><td>对于内置了Prometheus支持的应用，需要从Pod实例中采集其自定义监控指标</td><td>pod</td><td>白盒监控</td><td>custom pod</td></tr><tr><td>获取API Server组件的访问地址，并从中获取Kubernetes集群相关的运行监控指标</td><td>endpoints</td><td>白盒监控</td><td>api server</td></tr><tr><td>获取集群中Service的访问地址，并通过Blackbox Exporter获取网络探测指标</td><td>service</td><td>黑盒监控</td><td>blackbox exporter</td></tr><tr><td>获取集群中Ingress的访问信息，并通过Blackbox Exporter获取网络探测指标</td><td>ingress</td><td>黑盒监控</td><td>blackbox exporter</td></tr></tbody></table><h2 id="_1-4-addon-resizer" tabindex="-1">1.4 addon-resizer <a class="header-anchor" href="#_1-4-addon-resizer" aria-label="Permalink to &quot;1.4 addon-resizer&quot;">​</a></h2><p>官当,<a href="https://github.com/kubernetes/autoscaler/tree/master/addon-resizer" target="_blank" rel="noreferrer">https://github.com/kubernetes/autoscaler/tree/master/addon-resizer</a></p><p><a href="https://github.com/kubernetes/autoscaler/tree/master/addon-resizer" target="_blank" rel="noreferrer">Addon resizer</a> 是一个很有趣的小插件。监控场景中使用了kube-state-metrics，kube-state-metrics的资源占用量会随着集群中的Pod数量的不断增长而不断上升。<code>Addon resizer 容器会以Sidecar的形式监控与自己同一个Pod内的另一个容器（在本例中是kube-state-metrics）并且垂直的扩展或收缩这个容器</code>。Addon resizer能依据集群中节点的数量线性地扩展kube-state-metrics，以保证其能够有能力提供完整的metrics API服务。</p><h1 id="_2-cadvisor" tabindex="-1">2. cAdvisor <a class="header-anchor" href="#_2-cadvisor" aria-label="Permalink to &quot;2. cAdvisor&quot;">​</a></h1><p>用于监视容器资源使用和性能的工具，它可以收集 CPU、内存、磁盘、网络和文件系统等方面的指标数据</p><h1 id="_3-node-exporter" tabindex="-1">3. node-exporter <a class="header-anchor" href="#_3-node-exporter" aria-label="Permalink to &quot;3. node-exporter&quot;">​</a></h1><p>用于监控主机指标数据的收集器，它可以收集 CPU 负载、内存使用情况、磁盘空间、网络流量等各种指标数据。</p><h1 id="_4-metrics-server" tabindex="-1">4. metrics-server <a class="header-anchor" href="#_4-metrics-server" aria-label="Permalink to &quot;4. metrics-server&quot;">​</a></h1><h2 id="_4-1-什么是metrics-server" tabindex="-1">4.1 什么是metrics server <a class="header-anchor" href="#_4-1-什么是metrics-server" aria-label="Permalink to &quot;4.1 什么是metrics server&quot;">​</a></h2><p>Metrics Server 是 Kubernetes 内置自动扩展管道的可扩展、高效的容器资源指标来源。</p><p>Metrics Server 从 Kubelet 收集资源指标，并通过Metrics API在 Kubernetes apiserver 中公开它们，以供Horizontal Pod Autoscaler和Vertical Pod Autoscaler 使用。Metrics API 也可以通过 访问kubectl top，从而更轻松地调试自动缩放管道。</p><ul><li>使用场景</li></ul><p><strong>自动伸缩</strong>：结合Horizontal Pod Autoscaler (HPA)使用时，可以根据实时负载动态调整副本数量。</p><p><strong>健康检查</strong>：定期检查关键服务的资源消耗是否正常，帮助识别潜在问题。</p><p><strong>成本优化</strong>：分析长期运行的工作负载，找出可以减少资源请求的地方以节省成本。</p><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>Metrics Server 仅用于自动扩展目的。例如，请勿将其用于将指标转发到监控解决方案，或将其作为监控解决方案指标的来源。在这种情况下，请/metrics/resource直接从 Kubelet 端点收集指标。</p></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410121628486.png" alt="2aa8d4ad0e6a65519fcc82a26a268618"></p><ul><li><p>查看资源集群状态</p><ul><li><p><strong>查看master组件状态：</strong></p><div class="language-csharp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl get cs</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl get cs</span></span></code></pre></div></li><li><p><strong>查看node状态：</strong></p><div class="language-csharp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl get node</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl get node</span></span></code></pre></div></li><li><p><strong>查看Apiserver代理的URL：</strong></p><div class="language-armasm vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">armasm</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl cluster-info</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl cluster-info</span></span></code></pre></div></li><li><p><strong>查看集群详细信息：</strong></p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl cluster</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">info dump</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl cluster</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">info dump</span></span></code></pre></div></li><li><p><strong>查看资源信息：</strong></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl describe </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">资源</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">名称</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl describe </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">资源</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">名称</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div></li><li><p><strong>查看资源信息：</strong></p><div class="language-csharp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl get </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">资源</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl get </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">资源</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div></li></ul></li><li><p>监控集群资源利用率</p><ul><li><p>查看node资源消耗</p><div class="language-css vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">css</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl top node &lt;node name</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl top node &lt;node name</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div></li><li><p>查看pod资源消耗</p><div class="language-css vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">css</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl top pod &lt;pod name</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl top pod &lt;pod name</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div></li></ul><blockquote><p>执行时会提示错误：error: Metrics API not available</p><p>这是因为这个命令需要由metric-server服务提供数据，而这个服务默认没有安装，还需要手动部署下。</p></blockquote></li><li><p>Metrics-server 工作流程图 <img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408071028975.png" alt="image"></p><ul><li>Metrics Server是一个集群范围的资源使用情况的数据聚合器。作为一个应用部署在集群中。Metric server从每个节点上KubeletAPI收集指标，通过Kubernetes聚合器注册在Master APIServer中。</li><li>为集群提供Node、Pods资源利用率指标</li><li>项目地址：<a href="https://github.com/kubernetes-sigs/metrics-server" target="_blank" rel="noreferrer">https://github.com/kubernetes-sigs/metrics-server</a></li></ul><h2 id="_4-2-metrics-server-部署" tabindex="-1">4.2 Metrics-server 部署 <a class="header-anchor" href="#_4-2-metrics-server-部署" aria-label="Permalink to &quot;4.2 Metrics-server 部署&quot;">​</a></h2><h3 id="yaml部署" tabindex="-1">yaml部署 <a class="header-anchor" href="#yaml部署" aria-label="Permalink to &quot;yaml部署&quot;">​</a></h3><ul><li><p>官网下载地址：<a href="https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.3.7/components.yaml" target="_blank" rel="noreferrer">https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.3.7/components.yaml</a></p></li><li><p>示例代码</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@k8s-master01 ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">vim metrics-server.yaml</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@k8s-master01 ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat metrics-server.yaml</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRole</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">system:aggregated-metrics-reader</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">rbac.authorization.k8s.io/aggregate-to-view</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">rbac.authorization.k8s.io/aggregate-to-edit</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">rbac.authorization.k8s.io/aggregate-to-admin</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;metrics.k8s.io&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;pods&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;nodes&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;get&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;watch&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRoleBinding</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics-server:system:auth-delegator</span></span>
<span class="line"><span style="color:#85E89D;">roleRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">apiGroup</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRole</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">system:auth-delegator</span></span>
<span class="line"><span style="color:#85E89D;">subjects</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ServiceAccount</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics-server</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">RoleBinding</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics-server-auth-reader</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"><span style="color:#85E89D;">roleRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">apiGroup</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Role</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">extension-apiserver-authentication-reader</span></span>
<span class="line"><span style="color:#85E89D;">subjects</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ServiceAccount</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics-server</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apiregistration.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">APIService</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1beta1.metrics.k8s.io</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics-server</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">group</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics.k8s.io</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">version</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1beta1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">insecureSkipTLSVerify</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">groupPriorityMinimum</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">100</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">versionPriority</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">100</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ServiceAccount</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics-server</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics-server</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics-server</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics-server</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics-server</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics-server</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">serviceAccountName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics-server</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># mount in tmp so we can safely use from-scratch images and/or read-only containers</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tmp-dir</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">emptyDir</span><span style="color:#E1E4E8;">: {}</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics-server</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">lizhenliang/metrics-server:v0.3.7</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">imagePullPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">args</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">--cert-dir=/tmp</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">--secure-port=4443</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">--kubelet-insecure-tls</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">--kubelet-preferred-address-types=InternalIP</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">main-port</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">4443</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">securityContext</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">readOnlyRootFilesystem</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">runAsNonRoot</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">runAsUser</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1000</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tmp-dir</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/tmp</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">nodeSelector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">kubernetes.io/os</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">linux</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">kubernetes.io/arch</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;amd64&quot;</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics-server</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">kubernetes.io/name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Metrics-server&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">kubernetes.io/cluster-service</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics-server</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">443</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">main-port</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRole</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">system:metrics-server</span></span>
<span class="line"><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">&quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">pods</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">nodes</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">nodes/stats</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">namespaces</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">configmaps</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">get</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">list</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">watch</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRoleBinding</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">system:metrics-server</span></span>
<span class="line"><span style="color:#85E89D;">roleRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">apiGroup</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRole</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">system:metrics-server</span></span>
<span class="line"><span style="color:#85E89D;">subjects</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ServiceAccount</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics-server</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-system</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@k8s-master01 ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">vim metrics-server.yaml</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@k8s-master01 ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat metrics-server.yaml</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRole</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">system:aggregated-metrics-reader</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">rbac.authorization.k8s.io/aggregate-to-view</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">rbac.authorization.k8s.io/aggregate-to-edit</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">rbac.authorization.k8s.io/aggregate-to-admin</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;metrics.k8s.io&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;pods&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;nodes&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;get&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRoleBinding</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics-server:system:auth-delegator</span></span>
<span class="line"><span style="color:#22863A;">roleRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRole</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">system:auth-delegator</span></span>
<span class="line"><span style="color:#22863A;">subjects</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ServiceAccount</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics-server</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RoleBinding</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics-server-auth-reader</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"><span style="color:#22863A;">roleRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Role</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">extension-apiserver-authentication-reader</span></span>
<span class="line"><span style="color:#22863A;">subjects</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ServiceAccount</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics-server</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apiregistration.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">APIService</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1beta1.metrics.k8s.io</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics-server</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">group</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics.k8s.io</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">version</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1beta1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">insecureSkipTLSVerify</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">groupPriorityMinimum</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">100</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">versionPriority</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">100</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ServiceAccount</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics-server</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics-server</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics-server</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics-server</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics-server</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics-server</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">serviceAccountName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics-server</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># mount in tmp so we can safely use from-scratch images and/or read-only containers</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tmp-dir</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">emptyDir</span><span style="color:#24292E;">: {}</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics-server</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">lizhenliang/metrics-server:v0.3.7</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">imagePullPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">args</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">--cert-dir=/tmp</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">--secure-port=4443</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">--kubelet-insecure-tls</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">--kubelet-preferred-address-types=InternalIP</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">main-port</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">4443</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">securityContext</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">readOnlyRootFilesystem</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">runAsNonRoot</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">runAsUser</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1000</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tmp-dir</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/tmp</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">nodeSelector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">kubernetes.io/os</span><span style="color:#24292E;">: </span><span style="color:#032F62;">linux</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">kubernetes.io/arch</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;amd64&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics-server</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kubernetes.io/name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Metrics-server&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kubernetes.io/cluster-service</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics-server</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">443</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#032F62;">main-port</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRole</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">system:metrics-server</span></span>
<span class="line"><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">pods</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">nodes</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">nodes/stats</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">namespaces</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">configmaps</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">get</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">list</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">watch</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRoleBinding</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">system:metrics-server</span></span>
<span class="line"><span style="color:#22863A;">roleRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRole</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">system:metrics-server</span></span>
<span class="line"><span style="color:#22863A;">subjects</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ServiceAccount</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics-server</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-system</span></span></code></pre></div></li><li><p>运行配置文件</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl apply -f metrics-server.yaml </span></span>
<span class="line"><span style="color:#B392F0;">clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">serviceaccount/metrics-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">deployment.apps/metrics-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">service/metrics-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">clusterrole.rbac.authorization.k8s.io/system:metrics-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl apply -f metrics-server.yaml </span></span>
<span class="line"><span style="color:#6F42C1;">clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">serviceaccount/metrics-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/metrics-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">service/metrics-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">clusterrole.rbac.authorization.k8s.io/system:metrics-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span></code></pre></div></li><li><p>检查是否部署成功</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get apiservices </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">metrics</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--raw</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/apis/metrics.k8s.io/v1beta1/nodesv1beta1.metrics.k8s.io</span><span style="color:#E1E4E8;">                 </span><span style="color:#9ECBFF;">kube-system/metrics-server</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">True</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">5</span><span style="color:#9ECBFF;">m58s</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get --raw /apis/metrics.k8s.io/v1beta1/nodes</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">&quot;kind&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;NodeMetricsList&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;apiVersion&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;metrics.k8s.io/v1beta1&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;metadata&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#E1E4E8;">{&quot;</span><span style="color:#B392F0;">selfLink</span><span style="color:#B392F0;">&quot;:&quot;</span><span style="color:#B392F0;">/apis/metrics.k8s.io/v1beta1/nodes</span><span style="color:#B392F0;">&quot;},&quot;</span><span style="color:#B392F0;">items</span><span style="color:#B392F0;">&quot;:</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get apiservices </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">metrics</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--raw</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/apis/metrics.k8s.io/v1beta1/nodesv1beta1.metrics.k8s.io</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">kube-system/metrics-server</span><span style="color:#24292E;">   </span><span style="color:#032F62;">True</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">m58s</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get --raw /apis/metrics.k8s.io/v1beta1/nodes</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#6F42C1;">&quot;kind&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;NodeMetricsList&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;apiVersion&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;metrics.k8s.io/v1beta1&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;metadata&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;">{&quot;</span><span style="color:#6F42C1;">selfLink</span><span style="color:#6F42C1;">&quot;:&quot;</span><span style="color:#6F42C1;">/apis/metrics.k8s.io/v1beta1/nodes</span><span style="color:#6F42C1;">&quot;},&quot;</span><span style="color:#6F42C1;">items</span><span style="color:#6F42C1;">&quot;:</span></span></code></pre></div></li></ul></li></ul><h3 id="helm部署" tabindex="-1">helm部署 <a class="header-anchor" href="#helm部署" aria-label="Permalink to &quot;helm部署&quot;">​</a></h3><p>1、添加helm仓库</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">helm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">add</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">metrics-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://kubernetes-sigs.github.io/metrics-server/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">helm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">add</span><span style="color:#24292E;"> </span><span style="color:#032F62;">metrics-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://kubernetes-sigs.github.io/metrics-server/</span></span></code></pre></div><p>2、下载并推送到harbor</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$ helm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pull</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">metrics-server/metrics-server --version</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3.12</span><span style="color:#9ECBFF;">.1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">$ helm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">push</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">metrics-server-3.12.1.tgz</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">oci://core.xxx.com/plugins</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$ helm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pull</span><span style="color:#24292E;"> </span><span style="color:#032F62;">metrics-server/metrics-server --version</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3.12</span><span style="color:#032F62;">.1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">$ helm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">push</span><span style="color:#24292E;"> </span><span style="color:#032F62;">metrics-server-3.12.1.tgz</span><span style="color:#24292E;"> </span><span style="color:#032F62;">oci://core.xxx.com/plugins</span></span></code></pre></div><p>3、拉取chart包</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$ helm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pull</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">oci://core.jiaxzeng.com/plugins/metrics-server --version</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3.12</span><span style="color:#9ECBFF;">.1 --untar --untardir /etc/kubernetes/addons/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$ helm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pull</span><span style="color:#24292E;"> </span><span style="color:#032F62;">oci://core.jiaxzeng.com/plugins/metrics-server --version</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3.12</span><span style="color:#032F62;">.1 --untar --untardir /etc/kubernetes/addons/</span></span></code></pre></div><p>4、创建metrics-server配置文件</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$ cat &lt;&lt;</span><span style="color:#B392F0;">&#39;EOF&#39;</span><span style="color:#B392F0;"> </span><span style="color:#F97583;">|</span><span style="color:#B392F0;"> sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tee /etc/kubernetes/addons/metrics-server-value.yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;"> /dev/null </span></span>
<span class="line"><span style="color:#B392F0;">image:</span></span>
<span class="line"><span style="color:#B392F0;">  repository: core.jiaxzeng.com/library/metrics-server</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">args:</span></span>
<span class="line"><span style="color:#B392F0;">  - --kubelet-insecure-tls</span></span>
<span class="line"><span style="color:#B392F0;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$ cat &lt;&lt;</span><span style="color:#6F42C1;">&#39;EOF&#39;</span><span style="color:#6F42C1;"> </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;"> sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tee /etc/kubernetes/addons/metrics-server-value.yaml</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;"> /dev/null </span></span>
<span class="line"><span style="color:#6F42C1;">image:</span></span>
<span class="line"><span style="color:#6F42C1;">  repository: core.jiaxzeng.com/library/metrics-server</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">args:</span></span>
<span class="line"><span style="color:#6F42C1;">  - --kubelet-insecure-tls</span></span>
<span class="line"><span style="color:#6F42C1;">EOF</span></span></code></pre></div><p>5、安装metrics-server</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">helm -n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">metrics-server -f /etc/kubernetes/addons/metrics-server-value.yaml /etc/kubernetes/addons/metrics-server</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">helm -n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">metrics-server -f /etc/kubernetes/addons/metrics-server-value.yaml /etc/kubernetes/addons/metrics-server</span></span></code></pre></div><p>6、验证服务</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$ kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">top</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$ kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">top</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span></span></code></pre></div><p>官档，</p><p><a href="https://kubernetes.io/docs/tasks/debug/debug-cluster/resource-metrics-pipeline/#metrics-server" target="_blank" rel="noreferrer">https://kubernetes.io/docs/tasks/debug/debug-cluster/resource-metrics-pipeline/#metrics-server</a></p><p><a href="https://github.com/kubernetes-sigs/metrics-server" target="_blank" rel="noreferrer">https://github.com/kubernetes-sigs/metrics-server</a></p>`,44),o=[e];function t(r,c,E,y,i,d){return a(),n("div",null,o)}const m=s(p,[["render",t]]);export{F as __pageData,m as default};
