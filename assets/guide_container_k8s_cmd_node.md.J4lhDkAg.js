import{_ as a,o as l,c as p,k as s,a as n,R as o}from"./chunks/framework.zUbWieqp.js";const m=JSON.parse('{"title":"0.Node相关命令","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/cmd/node.md","filePath":"guide/container/k8s/cmd/node.md","lastUpdated":1723536306000}'),e={name:"guide/container/k8s/cmd/node.md"},t=s("p",null,[n("文档，"),s("a",{href:"https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/",target:"_blank",rel:"noreferrer"},"https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/")],-1),c=s("p",null,[s("a",{href:"https://cloud-atlas.readthedocs.io/zh-cn/latest/kubernetes/administer/remove_node.html",target:"_blank",rel:"noreferrer"},"https://cloud-atlas.readthedocs.io/zh-cn/latest/kubernetes/administer/remove_node.html")],-1),r=s("h1",{id:"_0-node相关命令",tabindex:"-1"},[n("0.Node相关命令 "),s("a",{class:"header-anchor",href:"#_0-node相关命令","aria-label":'Permalink to "0.Node相关命令"'},"​")],-1),y=s("p",null,"kubectl get nodes",-1),E=s("p",{node_name:""},"kuebctl describe node",-1),i=o(`<h2 id="describe命令的node信息" tabindex="-1">describe命令的Node信息 <a class="header-anchor" href="#describe命令的node信息" aria-label="Permalink to &quot;describe命令的Node信息&quot;">​</a></h2><ul><li>Node基本信息：名称、标签、创建时间等</li><li>Node当前的状态，Node启动后会进行自检工作，磁盘是否满，内存是否不足，若都正常则切换为Ready状态。</li><li>Node的主机地址与主机名</li><li>Node上的资源总量：CPU,内存，最大可调度Pod数量等</li><li>Node可分配资源量：当前Node可用于分配的资源量</li><li>主机系统信息：主机唯一标识符UUID，Linux kernel版本号，操作系统，kubernetes版本，kubelet与kube-proxy版本</li><li>当前正在运行的Pod列表及概要信息</li><li>已分配的资源使用概要，例如资源申请的最低、最大允许使用量占系统总量的百分比</li><li>Node相关的Event信息。</li></ul><h1 id="_1-节点下线" tabindex="-1">1.节点下线 <a class="header-anchor" href="#_1-节点下线" aria-label="Permalink to &quot;1.节点下线&quot;">​</a></h1><ul><li>流程</li></ul><ol><li>node节点配置pod不可调度到该节点上。</li><li>node节点上的服务驱逐。</li><li>node节点下线</li></ol><h2 id="_1-查看node" tabindex="-1">1.查看node <a class="header-anchor" href="#_1-查看node" aria-label="Permalink to &quot;1.查看node&quot;">​</a></h2><p>下线掉node01节点</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get node</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">ROLES</span><span style="color:#E1E4E8;">                  </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">VERSION</span></span>
<span class="line"><span style="color:#B392F0;">k8s-master01</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">control-plane,master</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">41</span><span style="color:#9ECBFF;">h</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">kube-node01</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">18</span><span style="color:#9ECBFF;">h</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">kube-node02</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">18</span><span style="color:#9ECBFF;">h</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">kube-node03</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">18</span><span style="color:#9ECBFF;">h</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.17</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get node</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">           </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ROLES</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">VERSION</span></span>
<span class="line"><span style="color:#6F42C1;">k8s-master01</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#032F62;">control-plane,master</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">41</span><span style="color:#032F62;">h</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">kube-node01</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">18</span><span style="color:#032F62;">h</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">kube-node02</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">18</span><span style="color:#032F62;">h</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">kube-node03</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">18</span><span style="color:#032F62;">h</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.17</span></span></code></pre></div><h2 id="_2-设置下线节点为不可调度状态" tabindex="-1">2.设置下线节点为不可调度状态 <a class="header-anchor" href="#_2-设置下线节点为不可调度状态" aria-label="Permalink to &quot;2.设置下线节点为不可调度状态&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 配置节点不可调度</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cordon</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">NODE_NAM</span><span style="color:#E1E4E8;">E</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">此时查看节点，驱逐后查看节点状态变为：SchedulingDisabled</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get node</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">                     </span><span style="color:#9ECBFF;">ROLES</span><span style="color:#E1E4E8;">                  </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">VERSION</span></span>
<span class="line"><span style="color:#B392F0;">k8s-master01</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">                      </span><span style="color:#9ECBFF;">control-plane,master</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">42</span><span style="color:#9ECBFF;">h</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">kube-node01</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Ready,SchedulingDisabled</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">19</span><span style="color:#9ECBFF;">h</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">kube-node02</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">                      </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">19</span><span style="color:#9ECBFF;">h</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">kube-node03</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">                      </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">19</span><span style="color:#9ECBFF;">h</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.17</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 配置节点不可调度</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cordon</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">NODE_NAM</span><span style="color:#24292E;">E</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">此时查看节点，驱逐后查看节点状态变为：SchedulingDisabled</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get node</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">           </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">                     </span><span style="color:#032F62;">ROLES</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">VERSION</span></span>
<span class="line"><span style="color:#6F42C1;">k8s-master01</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">                      </span><span style="color:#032F62;">control-plane,master</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">42</span><span style="color:#032F62;">h</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">kube-node01</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Ready,SchedulingDisabled</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">19</span><span style="color:#032F62;">h</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">kube-node02</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">                      </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">19</span><span style="color:#032F62;">h</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">kube-node03</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">                      </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">19</span><span style="color:#032F62;">h</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.17</span></span></code></pre></div><blockquote><p>设置这个之后,并不影响已有pod运行</p></blockquote><h2 id="_3-驱逐pod资源" tabindex="-1">3.驱逐Pod资源 <a class="header-anchor" href="#_3-驱逐pod资源" aria-label="Permalink to &quot;3.驱逐Pod资源&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">drain</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--ignore-daemonsets</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">NODE_NAM</span><span style="color:#E1E4E8;">E</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--delete-emptydir-data</span></span>
<span class="line"><span style="color:#6A737D;"># --ignore-daemonsets 选项为忽略DaemonSet类型的pod</span></span>
<span class="line"><span style="color:#6A737D;"># --delete-emptydir-data 清理本地挂载数据</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl drain --ignore-daemonsets kube-node01 --delete-emptydir-data</span></span>
<span class="line"><span style="color:#B392F0;">node/kube-node01</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">already</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cordoned</span></span>
<span class="line"><span style="color:#B392F0;">WARNING:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ignoring</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">DaemonSet-managed</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Pods:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system/calico-node-g4c7n,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system/kube-proxy-pmkmh</span></span>
<span class="line"><span style="color:#B392F0;">evicting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system/metrics-server-54544fbf96-qgg9m</span></span>
<span class="line"><span style="color:#B392F0;">evicting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">default/deployapp-7749464894-jb2xx</span></span>
<span class="line"><span style="color:#B392F0;">evicting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">default/nginx-6799fc88d8-cp555</span></span>
<span class="line"><span style="color:#B392F0;">evicting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system/calico-typha-67c6dc57d6-frds4</span></span>
<span class="line"><span style="color:#B392F0;">pod/calico-typha-67c6dc57d6-frds4</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">evicted</span></span>
<span class="line"><span style="color:#B392F0;">pod/metrics-server-54544fbf96-qgg9m</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">evicted</span></span>
<span class="line"><span style="color:#B392F0;">pod/deployapp-7749464894-jb2xx</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">evicted</span></span>
<span class="line"><span style="color:#B392F0;">pod/nginx-6799fc88d8-cp555</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">evicted</span></span>
<span class="line"><span style="color:#B392F0;">node/kube-node01</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">evicted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#此时，再查看已经node01没有pod资源</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get pod -A -owide </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node01</span></span>
<span class="line"><span style="color:#B392F0;">kube-system</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">calico-node-g4c7n</span><span style="color:#E1E4E8;">                          </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> (54m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   19h   10.103.236.202   kube-node01  </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">kube-system</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">kube-proxy-pmkmh</span><span style="color:#E1E4E8;">                           </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> (54m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   19h   10.103.236.202   kube-node01  </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">drain</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--ignore-daemonsets</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">NODE_NAM</span><span style="color:#24292E;">E</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--delete-emptydir-data</span></span>
<span class="line"><span style="color:#6A737D;"># --ignore-daemonsets 选项为忽略DaemonSet类型的pod</span></span>
<span class="line"><span style="color:#6A737D;"># --delete-emptydir-data 清理本地挂载数据</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl drain --ignore-daemonsets kube-node01 --delete-emptydir-data</span></span>
<span class="line"><span style="color:#6F42C1;">node/kube-node01</span><span style="color:#24292E;"> </span><span style="color:#032F62;">already</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cordoned</span></span>
<span class="line"><span style="color:#6F42C1;">WARNING:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ignoring</span><span style="color:#24292E;"> </span><span style="color:#032F62;">DaemonSet-managed</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Pods:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system/calico-node-g4c7n,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system/kube-proxy-pmkmh</span></span>
<span class="line"><span style="color:#6F42C1;">evicting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system/metrics-server-54544fbf96-qgg9m</span></span>
<span class="line"><span style="color:#6F42C1;">evicting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">default/deployapp-7749464894-jb2xx</span></span>
<span class="line"><span style="color:#6F42C1;">evicting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">default/nginx-6799fc88d8-cp555</span></span>
<span class="line"><span style="color:#6F42C1;">evicting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system/calico-typha-67c6dc57d6-frds4</span></span>
<span class="line"><span style="color:#6F42C1;">pod/calico-typha-67c6dc57d6-frds4</span><span style="color:#24292E;"> </span><span style="color:#032F62;">evicted</span></span>
<span class="line"><span style="color:#6F42C1;">pod/metrics-server-54544fbf96-qgg9m</span><span style="color:#24292E;"> </span><span style="color:#032F62;">evicted</span></span>
<span class="line"><span style="color:#6F42C1;">pod/deployapp-7749464894-jb2xx</span><span style="color:#24292E;"> </span><span style="color:#032F62;">evicted</span></span>
<span class="line"><span style="color:#6F42C1;">pod/nginx-6799fc88d8-cp555</span><span style="color:#24292E;"> </span><span style="color:#032F62;">evicted</span></span>
<span class="line"><span style="color:#6F42C1;">node/kube-node01</span><span style="color:#24292E;"> </span><span style="color:#032F62;">evicted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#此时，再查看已经node01没有pod资源</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pod -A -owide </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node01</span></span>
<span class="line"><span style="color:#6F42C1;">kube-system</span><span style="color:#24292E;">   </span><span style="color:#032F62;">calico-node-g4c7n</span><span style="color:#24292E;">                          </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> (54m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   19h   10.103.236.202   kube-node01  </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">kube-system</span><span style="color:#24292E;">   </span><span style="color:#032F62;">kube-proxy-pmkmh</span><span style="color:#24292E;">                           </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> (54m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   19h   10.103.236.202   kube-node01  </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>一般而言驱逐操作就是把该节点上的pod资源调度到其他节点，在生产环节中，一个node节点上可能会运行多个pod资源， 如果使用驱逐命令，可能会导致有大量的pod同时删除和创建，对业务抖动较为严重。一般生产环境通过命令对节点上的pod资源进行手动删除，确保服务整体稳定性</p></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 获取node节点上所有的pod名称</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-A</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wide</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">NODE_NAM</span><span style="color:#E1E4E8;">E</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 删除pod资源，重新调度到其他节点</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">NAMESPAC</span><span style="color:#E1E4E8;">E</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">POD_NAM</span><span style="color:#E1E4E8;">E</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 获取node节点上所有的pod名称</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-A</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wide</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">NODE_NAM</span><span style="color:#24292E;">E</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 删除pod资源，重新调度到其他节点</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">NAMESPAC</span><span style="color:#24292E;">E</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">POD_NAM</span><span style="color:#24292E;">E</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><h2 id="_4-删除node" tabindex="-1">4.删除node <a class="header-anchor" href="#_4-删除node" aria-label="Permalink to &quot;4.删除node&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 验证该node上无pod资源</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-A</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wide</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">NODE_NAM</span><span style="color:#E1E4E8;">E</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#验证该节点上无业务pod，即可对该node进行删除操作</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">NODE_NAM</span><span style="color:#E1E4E8;">E</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#6A737D;"># 验证已无该node资源</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">NODE_NAM</span><span style="color:#E1E4E8;">E</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 验证该node上无pod资源</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-A</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wide</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">NODE_NAM</span><span style="color:#24292E;">E</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#验证该节点上无业务pod，即可对该node进行删除操作</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">NODE_NAM</span><span style="color:#24292E;">E</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6A737D;"># 验证已无该node资源</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">NODE_NAM</span><span style="color:#24292E;">E</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><blockquote><p>如果是云上节点不用之后，可以直接删除节点</p></blockquote><h2 id="_5-清理环境" tabindex="-1">5.清理环境 <a class="header-anchor" href="#_5-清理环境" aria-label="Permalink to &quot;5.清理环境&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">reset</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">ifconfig</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tunl0</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">down</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">ip</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">link</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tunl0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-fr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/</span><span style="color:#79B8FF;">*</span></span>
<span class="line"><span style="color:#B392F0;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-fr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/cni/</span><span style="color:#79B8FF;">*</span></span>
<span class="line"><span style="color:#B392F0;">iptables</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-F</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">iptables</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nat</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-F</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">iptables</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mangle</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-F</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">iptables</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-X</span></span>
<span class="line"><span style="color:#B392F0;">ipvsadm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--clear</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stop</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker.socket</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stop</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">reset</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">ifconfig</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tunl0</span><span style="color:#24292E;"> </span><span style="color:#032F62;">down</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">ip</span><span style="color:#24292E;"> </span><span style="color:#032F62;">link</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tunl0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-fr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/</span><span style="color:#005CC5;">*</span></span>
<span class="line"><span style="color:#6F42C1;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-fr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/cni/</span><span style="color:#005CC5;">*</span></span>
<span class="line"><span style="color:#6F42C1;">iptables</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-F</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">iptables</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nat</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-F</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">iptables</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mangle</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-F</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">iptables</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span></span>
<span class="line"><span style="color:#6F42C1;">ipvsadm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--clear</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker.socket</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet</span></span></code></pre></div><h1 id="_2-新节点上线" tabindex="-1">2.新节点上线 <a class="header-anchor" href="#_2-新节点上线" aria-label="Permalink to &quot;2.新节点上线&quot;">​</a></h1><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看token，如果显示空则token已过期</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubeadm token list</span></span>
<span class="line"><span style="color:#B392F0;">TOKEN</span><span style="color:#E1E4E8;">                     </span><span style="color:#9ECBFF;">TTL</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">EXPIRES</span><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">USAGES</span><span style="color:#E1E4E8;">                   </span><span style="color:#9ECBFF;">DESCRIPTION</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">EXTRA</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GROUPS</span></span>
<span class="line"><span style="color:#B392F0;">qa2k39.fg9cjrmbdfsu0w29</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">h</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">2024</span><span style="color:#9ECBFF;">-04-12T06:59:46Z</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">authentication,signing</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">system:bootstrappers:kubeadm:default-node-token</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#token过期，重新创建token</span></span>
<span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">token</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#删除token</span></span>
<span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">token</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">token前面的i</span><span style="color:#E1E4E8;">d</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#获取hash值</span></span>
<span class="line"><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">x509</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-pubkey</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/ca.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rsa</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-pubin</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-outform</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">der</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dgst</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-sha256</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-hex</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sed</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;s/^.* //&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-node01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubeadm join 10.103.236.201:6443 --token qa2k39.fg9cjrmbdfsu0w29 --discovery-token-ca-cert-hash sha256:89ad2d95b4ffcdbf9370ccc4925f0195a80e98e5436404ecef548091db31b234</span></span>
<span class="line"><span style="color:#E1E4E8;">[preflight] Running pre-flight checks</span></span>
<span class="line"><span style="color:#E1E4E8;">[preflight] Reading configuration from the cluster...</span></span>
<span class="line"><span style="color:#E1E4E8;">[preflight] FYI: You can look at this config file with </span><span style="color:#9ECBFF;">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">[kubelet-start] Writing kubelet configuration to file </span><span style="color:#9ECBFF;">&quot;/var/lib/kubelet/config.yaml&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">[kubelet-start] Writing kubelet environment file with flags to file </span><span style="color:#9ECBFF;">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">[kubelet-start] Starting the kubelet</span></span>
<span class="line"><span style="color:#E1E4E8;">[kubelet-start] Waiting </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> the kubelet to perform the TLS Bootstrap...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">This</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">has</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">joined</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster:</span></span>
<span class="line"><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> Certificate signing request was sent to apiserver and a response was received.</span></span>
<span class="line"><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> The Kubelet was informed of the new secure connection details.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Run</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;kubectl get nodes&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">control-plane</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">see</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">this</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">join</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看token，如果显示空则token已过期</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubeadm token list</span></span>
<span class="line"><span style="color:#6F42C1;">TOKEN</span><span style="color:#24292E;">                     </span><span style="color:#032F62;">TTL</span><span style="color:#24292E;">         </span><span style="color:#032F62;">EXPIRES</span><span style="color:#24292E;">                </span><span style="color:#032F62;">USAGES</span><span style="color:#24292E;">                   </span><span style="color:#032F62;">DESCRIPTION</span><span style="color:#24292E;">           </span><span style="color:#032F62;">EXTRA</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GROUPS</span></span>
<span class="line"><span style="color:#6F42C1;">qa2k39.fg9cjrmbdfsu0w29</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">h</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2024</span><span style="color:#032F62;">-04-12T06:59:46Z</span><span style="color:#24292E;">   </span><span style="color:#032F62;">authentication,signing</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#032F62;">system:bootstrappers:kubeadm:default-node-token</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#token过期，重新创建token</span></span>
<span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">token</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#删除token</span></span>
<span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">token</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">token前面的i</span><span style="color:#24292E;">d</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#获取hash值</span></span>
<span class="line"><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-pubkey</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/ca.crt</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rsa</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-pubin</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-outform</span><span style="color:#24292E;"> </span><span style="color:#032F62;">der</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dgst</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-sha256</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-hex</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sed</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;s/^.* //&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-node01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubeadm join 10.103.236.201:6443 --token qa2k39.fg9cjrmbdfsu0w29 --discovery-token-ca-cert-hash sha256:89ad2d95b4ffcdbf9370ccc4925f0195a80e98e5436404ecef548091db31b234</span></span>
<span class="line"><span style="color:#24292E;">[preflight] Running pre-flight checks</span></span>
<span class="line"><span style="color:#24292E;">[preflight] Reading configuration from the cluster...</span></span>
<span class="line"><span style="color:#24292E;">[preflight] FYI: You can look at this config file with </span><span style="color:#032F62;">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span></span>
<span class="line"><span style="color:#24292E;">[kubelet-start] Writing kubelet configuration to file </span><span style="color:#032F62;">&quot;/var/lib/kubelet/config.yaml&quot;</span></span>
<span class="line"><span style="color:#24292E;">[kubelet-start] Writing kubelet environment file with flags to file </span><span style="color:#032F62;">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span>
<span class="line"><span style="color:#24292E;">[kubelet-start] Starting the kubelet</span></span>
<span class="line"><span style="color:#24292E;">[kubelet-start] Waiting </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> the kubelet to perform the TLS Bootstrap...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">This</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">has</span><span style="color:#24292E;"> </span><span style="color:#032F62;">joined</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster:</span></span>
<span class="line"><span style="color:#D73A49;">*</span><span style="color:#24292E;"> Certificate signing request was sent to apiserver and a response was received.</span></span>
<span class="line"><span style="color:#D73A49;">*</span><span style="color:#24292E;"> The Kubelet was informed of the new secure connection details.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Run</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;kubectl get nodes&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">control-plane</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">see</span><span style="color:#24292E;"> </span><span style="color:#032F62;">this</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">join</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster.</span></span></code></pre></div><h1 id="_3-节点维护" tabindex="-1">3.节点维护 <a class="header-anchor" href="#_3-节点维护" aria-label="Permalink to &quot;3.节点维护&quot;">​</a></h1><h1 id="_4-修改node中pod数目" tabindex="-1">4. 修改node中Pod数目 <a class="header-anchor" href="#_4-修改node中pod数目" aria-label="Permalink to &quot;4. 修改node中Pod数目&quot;">​</a></h1><p>kubernetes版本要求： 1.24+</p><h2 id="_4-1修改配置" tabindex="-1">4.1修改配置 <a class="header-anchor" href="#_4-1修改配置" aria-label="Permalink to &quot;4.1修改配置&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">systemctl status kubelet</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">● kubelet.service - kubelet: The Kubernetes Node Agent</span></span>
<span class="line"><span style="color:#e1e4e8;">Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span></span>
<span class="line"><span style="color:#e1e4e8;">Drop-In: /usr/lib/systemd/system/kubelet.service.d</span></span>
<span class="line"><span style="color:#e1e4e8;">        └─10-kubeadm.conf</span></span>
<span class="line"><span style="color:#e1e4e8;">Active: active (running) since Thu 2023-05-04 15:00:49 CST; 4min 45s ago</span></span>
<span class="line"><span style="color:#e1e4e8;">  Docs: https://kubernetes.io/docs/</span></span>
<span class="line"><span style="color:#e1e4e8;">Main PID: 43623 (kubelet)</span></span>
<span class="line"><span style="color:#e1e4e8;"> Tasks: 69</span></span>
<span class="line"><span style="color:#e1e4e8;">Memory: 192.0M</span></span>
<span class="line"><span style="color:#e1e4e8;">CGroup: /system.slice/kubelet.service</span></span>
<span class="line"><span style="color:#e1e4e8;">        └─43623 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --container-runtime=remote --container-runtime-endpoint=unix:///va...</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">systemctl status kubelet</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">● kubelet.service - kubelet: The Kubernetes Node Agent</span></span>
<span class="line"><span style="color:#24292e;">Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span></span>
<span class="line"><span style="color:#24292e;">Drop-In: /usr/lib/systemd/system/kubelet.service.d</span></span>
<span class="line"><span style="color:#24292e;">        └─10-kubeadm.conf</span></span>
<span class="line"><span style="color:#24292e;">Active: active (running) since Thu 2023-05-04 15:00:49 CST; 4min 45s ago</span></span>
<span class="line"><span style="color:#24292e;">  Docs: https://kubernetes.io/docs/</span></span>
<span class="line"><span style="color:#24292e;">Main PID: 43623 (kubelet)</span></span>
<span class="line"><span style="color:#24292e;"> Tasks: 69</span></span>
<span class="line"><span style="color:#24292e;">Memory: 192.0M</span></span>
<span class="line"><span style="color:#24292e;">CGroup: /system.slice/kubelet.service</span></span>
<span class="line"><span style="color:#24292e;">        └─43623 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --container-runtime=remote --container-runtime-endpoint=unix:///va...</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">...</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">vim /var/lib/kubelet/config.yaml</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">作者：Lance.Wu</span></span>
<span class="line"><span style="color:#e1e4e8;">链接：https://www.orchome.com/16833</span></span>
<span class="line"><span style="color:#e1e4e8;">来源：OrcHome</span></span>
<span class="line"><span style="color:#e1e4e8;">著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">vim /var/lib/kubelet/config.yaml</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">apiVersion: kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#e1e4e8;">...</span></span>
<span class="line"><span style="color:#e1e4e8;">kind: KubeletConfiguration</span></span>
<span class="line"><span style="color:#e1e4e8;">...</span></span>
<span class="line"><span style="color:#e1e4e8;">volumeStatsAggPeriod: 0s</span></span>
<span class="line"><span style="color:#e1e4e8;">maxPods: 150 # 添加的配置内容，默认为110个，设置成150个。</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">vim /var/lib/kubelet/config.yaml</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">作者：Lance.Wu</span></span>
<span class="line"><span style="color:#24292e;">链接：https://www.orchome.com/16833</span></span>
<span class="line"><span style="color:#24292e;">来源：OrcHome</span></span>
<span class="line"><span style="color:#24292e;">著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">vim /var/lib/kubelet/config.yaml</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">apiVersion: kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#24292e;">...</span></span>
<span class="line"><span style="color:#24292e;">kind: KubeletConfiguration</span></span>
<span class="line"><span style="color:#24292e;">...</span></span>
<span class="line"><span style="color:#24292e;">volumeStatsAggPeriod: 0s</span></span>
<span class="line"><span style="color:#24292e;">maxPods: 150 # 添加的配置内容，默认为110个，设置成150个。</span></span></code></pre></div><ul><li>重启</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemon-reload</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemon-reload</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet</span></span></code></pre></div><ul><li>验证结果</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">describe</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node-name</span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-A6</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Capacity\\|Allocatable&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">describe</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node-name</span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-A6</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Capacity\\|Allocatable&quot;</span></span></code></pre></div>`,32),F=[t,c,r,y,E,i];function d(u,b,C,k,g,h){return l(),p("div",null,F)}const v=a(e,[["render",d]]);export{m as __pageData,v as default};
