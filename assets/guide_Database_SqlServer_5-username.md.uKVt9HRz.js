import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const C=JSON.parse('{"title":"1.sqlServer创建用户及分配权限","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/SqlServer/5-username.md","filePath":"guide/Database/SqlServer/5-username.md","lastUpdated":1720533756000}'),p={name:"guide/Database/SqlServer/5-username.md"},o=l(`<h1 id="_1-sqlserver创建用户及分配权限" tabindex="-1">1.sqlServer创建用户及分配权限 <a class="header-anchor" href="#_1-sqlserver创建用户及分配权限" aria-label="Permalink to &quot;1.sqlServer创建用户及分配权限&quot;">​</a></h1><p>官方文档，<a href="https://docs.microsoft.com/zh-CN/sql/sql-server/?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-CN/sql/sql-server/?view=sql-server-2017</a></p><h2 id="_1-1架构主体" tabindex="-1">1.1架构主体 <a class="header-anchor" href="#_1-1架构主体" aria-label="Permalink to &quot;1.1架构主体&quot;">​</a></h2><h3 id="数据库主体" tabindex="-1">数据库主体 <a class="header-anchor" href="#数据库主体" aria-label="Permalink to &quot;数据库主体&quot;">​</a></h3><p>--数据库主体 【创建数据库用户的信息会写入该主体中】</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141014117.jpg" alt=""></p><h3 id="数据库架构" tabindex="-1">数据库架构 <a class="header-anchor" href="#数据库架构" aria-label="Permalink to &quot;数据库架构&quot;">​</a></h3><p>--创建角色权限的信息会写入该主体中</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schemas</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schemas</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141014114.jpg" alt=""></p><h3 id="服务器主体" tabindex="-1">服务器主体 <a class="header-anchor" href="#服务器主体" aria-label="Permalink to &quot;服务器主体&quot;">​</a></h3><p>--创建登录用户的信息会写入该主体中</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">server_principals</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">server_principals</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141014670.jpg" alt=""></p><h2 id="_1-2用户级别" tabindex="-1">1.2用户级别 <a class="header-anchor" href="#_1-2用户级别" aria-label="Permalink to &quot;1.2用户级别&quot;">​</a></h2><h3 id="_1-2-1服务器级别" tabindex="-1">1.2.1服务器级别 <a class="header-anchor" href="#_1-2-1服务器级别" aria-label="Permalink to &quot;1.2.1服务器级别&quot;">​</a></h3><p>官方文档，<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/security/authentication-access/server-level-roles?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/relational-databases/security/authentication-access/server-level-roles?view=sql-server-2017</a></p><h4 id="_1-2-1-1服务器级用户-即-登录名" tabindex="-1">1.2.1.1服务器级用户（即：登录名） <a class="header-anchor" href="#_1-2-1-1服务器级用户-即-登录名" aria-label="Permalink to &quot;1.2.1.1服务器级用户（即：登录名）&quot;">​</a></h4><p>服务器级别下的登录名是指：有权限登录到某个SQL Server服务器的用户。</p><p>例如：超级管理员的登录名是sa；</p><p>登录名具体位置在： 数据库——&gt;安全性——&gt;登录名</p><h4 id="_1-2-1-2服务器级角色" tabindex="-1">1.2.1.2服务器级角色 <a class="header-anchor" href="#_1-2-1-2服务器级角色" aria-label="Permalink to &quot;1.2.1.2服务器级角色&quot;">​</a></h4><p>服务器角色具体位置在： 数据库——&gt;安全性——&gt;服务器角色</p><p>服务器级角色是指：为帮助您管理服务器上的权限，SQL Server 提供了若干角色，这些角色是用于对其他主体进行分组的安全主体。 服务器级角色的权限作用域为服务器范围。SQL Server 提供了九种固定服务器角色， 无法更改授予固定服务器角色的权限，这9组角色分别如下：</p><table><thead><tr><th>服务器级的固定角色</th><th>说明</th></tr></thead><tbody><tr><td><strong>sysadmin</strong></td><td>sysadmin 固定服务器角色的成员可以在服务器上执行任何活动。</td></tr><tr><td><strong>serveradmin</strong></td><td><strong>serveradmin</strong> 固定服务器角色的成员可以更改服务器范围的配置选项和关闭服务器。</td></tr><tr><td><strong>securityadmin</strong></td><td><strong>securityadmin</strong> 固定服务器角色的成员可以管理登录名及其属性。 他们可以 <code>GRANT</code>、<code>DENY</code> 和 <code>REVOKE</code> 服务器级权限。 他们还可以 <code>GRANT</code>、<code>DENY</code> 和 <code>REVOKE</code> 数据库级权限（如果他们具有数据库的访问权限）。 此外，他们还可以重置登录SQL Server密码。 **重要：**通过向用户授予访问权限数据库引擎配置用户权限的能力允许安全管理员分配大多数服务器权限。 <strong>securityadmin</strong> 角色应视为与 <strong>sysadmin</strong> 角色等效。</td></tr><tr><td><strong>processadmin</strong></td><td><strong>processadmin 固定服务器</strong>角色的成员可以结束在实例中运行的进程SQL Server。</td></tr><tr><td><strong>setupadmin</strong></td><td><strong>setupadmin 固定服务器</strong>角色的成员可以使用 Transact-SQL 服务器。 (<strong>Management Studio</strong>.)</td></tr><tr><td><strong>bulkadmin</strong></td><td><strong>bulkadmin 固定服务器</strong>角色的成员可以运行 语句。 Linux 上的 SQL Server 不支持 bulkadmin 角色或管理大容量操作权限。 只有 sysadmin 才能对 Linux 上的 SQL Server 执行批量插入。</td></tr><tr><td><strong>diskadmin</strong></td><td>diskadmin 固定服务器角色用于管理磁盘文件。</td></tr><tr><td><strong>dbcreator</strong></td><td><strong>dbcreator</strong> 固定服务器角色的成员可以创建、更改、删除和还原任何数据库。</td></tr><tr><td><strong>public</strong></td><td>登录SQL Server属于公共<strong>服务器</strong>角色。 如果未向某个服务器主体授予或拒绝对某个安全对象的特定权限，该用户将继承授予该对象的 public 角色的权限。 只有在希望所有用户都能使用对象时，才在对象上分配 Public 权限。 你无法更改具有 Public 角色的成员身份。 注意：public 与其他角色的实现方式不同，可通过 public 固定服务器角色授予、拒绝或撤销权限。</td></tr></tbody></table><h5 id="固定服务器角色的权限" tabindex="-1">固定服务器角色的权限 <a class="header-anchor" href="#固定服务器角色的权限" aria-label="Permalink to &quot;固定服务器角色的权限&quot;">​</a></h5><p>每个固定服务器角色都被分配了特定的权限。 下图显示了分配给服务器角色的权限。</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141014118.png" alt=""></p><ul><li>查看服务器权限</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fn_builtin_permissions</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;SERVER&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> permission_name;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fn_builtin_permissions</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;SERVER&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> permission_name;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141014460.jpg" alt=""></p><h3 id="_1-2-2数据库级别" tabindex="-1">1.2.2数据库级别 <a class="header-anchor" href="#_1-2-2数据库级别" aria-label="Permalink to &quot;1.2.2数据库级别&quot;">​</a></h3><h4 id="_1-2-2-1数据库级用户" tabindex="-1">1.2.2.1数据库级用户 <a class="header-anchor" href="#_1-2-2-1数据库级用户" aria-label="Permalink to &quot;1.2.2.1数据库级用户&quot;">​</a></h4><p>数据库级用户是指：有权限能操作（比如：增删查改等权限）数据库的用户。</p><p>用户具体位置在 数据库——&gt;某个具体库——&gt;安全性——&gt;用户</p><h4 id="_1-2-2-2数据库级角色" tabindex="-1">1.2.2.2数据库级角色 <a class="header-anchor" href="#_1-2-2-2数据库级角色" aria-label="Permalink to &quot;1.2.2.2数据库级角色&quot;">​</a></h4><p>官方文档，<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/security/authentication-access/database-level-roles?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/relational-databases/security/authentication-access/database-level-roles?view=sql-server-2017</a></p><p>通过使用角色，不必针对各个用户单独维护权限.</p><p>存在两种类型的数据库级角色：数据库中预定义的“固定数据库角色”和可以创建的“用户定义的数据库角色”。</p><p>固定数据库角色是在数据库级别定义的，并且存在于每个数据库中。 <strong>db_owner</strong> 数据库角色的成员可以管理固定数据库角色成员身份。 msdb 数据库中还有一些特殊用途的数据库角色</p><p>SQL Server 支持四种类型的角色</p><ul><li>固定服务器角色</li><li>用户定义的服务器角色</li><li>固定的数据库角色</li><li>用户定义的数据库角色</li></ul><h5 id="固定数据库角色" tabindex="-1">固定数据库角色 <a class="header-anchor" href="#固定数据库角色" aria-label="Permalink to &quot;固定数据库角色&quot;">​</a></h5><p>下表显示了固定数据库角色及其能够执行的操作。 所有数据库中都有这些角色。 无法更改分配给固定数据库角色的权限，“公共”数据库角色除外</p><table><thead><tr><th>固定数据库角色名</th><th>说明</th></tr></thead><tbody><tr><td><strong>db_owner</strong></td><td>db_owner 固定数据库角色的成员可以执行数据库的所有配置和维护活动，还可以 <code>drop</code> SQL Server 中的数据库。 （在 SQL 数据库 和 Synapse Analytics 中，某些维护活动需要服务器级别权限，并且不能由 db_owners 执行。）</td></tr><tr><td><strong>db_securityadmin</strong></td><td>db_securityadmin 固定数据库角色的成员可以仅修改自定义角色的角色成员资格和管理权限。 此角色的成员可能会提升其权限，应监视其操作。</td></tr><tr><td><strong>db_accessadmin</strong></td><td><strong>db_accessadmin</strong> 固定数据库角色的成员可以为 Windows 登录名、Windows 组和 SQL Server 登录名添加或删除数据库访问权限。</td></tr><tr><td><strong>db_backupoperator</strong></td><td><strong>db_backupoperator</strong> 固定数据库角色的成员可以备份数据库。</td></tr><tr><td><strong>db_ddladmin</strong></td><td><strong>db_ddladmin</strong> 固定数据库角色的成员可以在数据库中运行任何数据定义语言 (DDL) 命令。</td></tr><tr><td><strong>db_datawriter</strong></td><td><strong>db_datawriter</strong> 固定数据库角色的成员可以在所有用户表中添加、删除或更改数据。</td></tr><tr><td><strong>db_datareader</strong></td><td>db_datareader 固定数据库角色的成员可以从所有用户表和视图中读取所有数据。 用户对象可能存在于除 sys 和 INFORMATION_SCHEMA 以外的任何架构中 。</td></tr><tr><td><strong>db_denydatawriter</strong></td><td><strong>db_denydatawriter</strong> 固定数据库角色的成员不能添加、修改或删除数据库内用户表中的任何数据。</td></tr><tr><td><strong>db_denydatareader</strong></td><td>db_denydatareader 固定数据库角色的成员不能读取数据库内用户表和视图中的任何数据。</td></tr></tbody></table><ul><li>下图显示了分配给固定数据库角色的权限</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141014614.png" alt=""></p><ul><li><h3 id="将用户添加到数据库级角色" tabindex="-1">将用户添加到数据库级角色 <a class="header-anchor" href="#将用户添加到数据库级角色" aria-label="Permalink to &quot;将用户添加到数据库级角色&quot;">​</a></h3></li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ROLE</span><span style="color:#E1E4E8;"> db_datareader</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">ADD</span><span style="color:#E1E4E8;"> MEMBER username;  </span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ROLE</span><span style="color:#24292E;"> db_datareader</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">ADD</span><span style="color:#24292E;"> MEMBER username;  </span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><ul><li><h3 id="列出作为数据库级别角色成员的所有数据库主体" tabindex="-1">列出作为数据库级别角色成员的所有数据库主体 <a class="header-anchor" href="#列出作为数据库级别角色成员的所有数据库主体" aria-label="Permalink to &quot;列出作为数据库级别角色成员的所有数据库主体&quot;">​</a></h3></li></ul><p>下面的语句将返回任何数据库角色的所有成员</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_name</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">roles</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> RolePrincipalID</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,    </span><span style="color:#79B8FF;">roles</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">                                    </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> RolePrincipalName</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,    </span><span style="color:#79B8FF;">database_role_members</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">member_principal_id</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> MemberPrincipalID</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,    </span><span style="color:#79B8FF;">members</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> MemberPrincipalName</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_role_members</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> database_role_members  </span></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> roles  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">database_role_members</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">role_principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">roles</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> members  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">database_role_members</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">member_principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">members</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_name</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">roles</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;">                            </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> RolePrincipalID</span></span>
<span class="line"><span style="color:#24292E;">    ,    </span><span style="color:#005CC5;">roles</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">                                    </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> RolePrincipalName</span></span>
<span class="line"><span style="color:#24292E;">    ,    </span><span style="color:#005CC5;">database_role_members</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">member_principal_id</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> MemberPrincipalID</span></span>
<span class="line"><span style="color:#24292E;">    ,    </span><span style="color:#005CC5;">members</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">                                </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> MemberPrincipalName</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_role_members</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> database_role_members  </span></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> roles  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">database_role_members</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">role_principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">roles</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> members  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">database_role_members</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">member_principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">members</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;">;</span></span></code></pre></div><h2 id="_1-2权限层次结构" tabindex="-1">1.2权限层次结构 <a class="header-anchor" href="#_1-2权限层次结构" aria-label="Permalink to &quot;1.2权限层次结构&quot;">​</a></h2><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141014490.gif" alt=""></p><h2 id="_1-3查看当前的用户连接" tabindex="-1">1.3查看当前的用户连接 <a class="header-anchor" href="#_1-3查看当前的用户连接" aria-label="Permalink to &quot;1.3查看当前的用户连接&quot;">​</a></h2><p>非系统连接</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">---使用SQL语句查看当前连接的用户</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> spid,</span><span style="color:#79B8FF;">db_name</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">dbid</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> DBname,login_time ,last_batch ,</span><span style="color:#F97583;">status</span><span style="color:#E1E4E8;"> ,hostname ,program_name ,loginame   </span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sysprocesses</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> spid </span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">50</span></span>
<span class="line"><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> loginame </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;DESKTOP-ABCD\\Administrator&#39;</span></span>
<span class="line"><span style="color:#6A737D;">--and dbid in (select dbid from master.dbo.sysdatabases where name =&#39;要查询的数据库名称&#39;)</span></span>
<span class="line"><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> last_batch </span><span style="color:#F97583;">desc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">---使用SQL语句查看当前连接的用户</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> spid,</span><span style="color:#005CC5;">db_name</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">dbid</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> DBname,login_time ,last_batch ,</span><span style="color:#D73A49;">status</span><span style="color:#24292E;"> ,hostname ,program_name ,loginame   </span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sysprocesses</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> spid </span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">50</span></span>
<span class="line"><span style="color:#D73A49;">and</span><span style="color:#24292E;"> loginame </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;DESKTOP-ABCD\\Administrator&#39;</span></span>
<span class="line"><span style="color:#6A737D;">--and dbid in (select dbid from master.dbo.sysdatabases where name =&#39;要查询的数据库名称&#39;)</span></span>
<span class="line"><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> last_batch </span><span style="color:#D73A49;">desc</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141014912.jpg" alt=""></p><h2 id="_1-3创建用户" tabindex="-1">1.3创建用户 <a class="header-anchor" href="#_1-3创建用户" aria-label="Permalink to &quot;1.3创建用户&quot;">​</a></h2><p>官方文档，<a href="https://docs.microsoft.com/zh-cn/sql/t-sql/statements/create-user-transact-sql?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/t-sql/statements/create-user-transact-sql?view=sql-server-2017</a></p><p><a href="https://docs.microsoft.com/zh-cn/sql/t-sql/lesson-2-configuring-permissions-on-database-objects?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/t-sql/lesson-2-configuring-permissions-on-database-objects?view=sql-server-2017</a></p><p><a href="https://docs.microsoft.com/zh-cn/sql/t-sql/statements/create-login-transact-sql?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/t-sql/statements/create-login-transact-sql?view=sql-server-2017</a></p><h3 id="_1-3-0-用户类型" tabindex="-1">1.3.0 用户类型 <a class="header-anchor" href="#_1-3-0-用户类型" aria-label="Permalink to &quot;1.3.0 用户类型&quot;">​</a></h3><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141014304.png" alt=""></p><h3 id="_1-3-1创建登录用户" tabindex="-1">1.3.1创建登录用户 <a class="header-anchor" href="#_1-3-1创建登录用户" aria-label="Permalink to &quot;1.3.1创建登录用户&quot;">​</a></h3><ul><li>语法</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- Syntax for SQL Server</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LOGIN</span><span style="color:#E1E4E8;"> login_name { </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">option_list1</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">sources</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">option_list1</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> ::</span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">PASSWORD</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#9ECBFF;">&#39;password&#39;</span><span style="color:#E1E4E8;"> | hashed_password </span><span style="color:#F97583;">HASHED</span><span style="color:#E1E4E8;"> } [ MUST_CHANGE ]</span></span>
<span class="line"><span style="color:#E1E4E8;">    [ , &lt;option_list2&gt; [ ,... ] ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">option_list2</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> ::</span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">sid</span></span>
<span class="line"><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">DEFAULT_DATABASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span></span>
<span class="line"><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">DEFAULT_LANGUAGE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">language</span></span>
<span class="line"><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">CHECK_EXPIRATION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">OFF</span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">CHECK_POLICY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">OFF</span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">CREDENTIAL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> credential_name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">sources</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> ::</span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WINDOWS</span><span style="color:#E1E4E8;"> [ WITH &lt;windows_options&gt;[ ,... ] ]</span></span>
<span class="line"><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">CERTIFICATE</span><span style="color:#E1E4E8;"> certname</span></span>
<span class="line"><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">ASYMMETRIC</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">KEY</span><span style="color:#E1E4E8;"> asym_key_name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">windows_options</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> ::</span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">DEFAULT_DATABASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span></span>
<span class="line"><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">DEFAULT_LANGUAGE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">language</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- Syntax for SQL Server</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LOGIN</span><span style="color:#24292E;"> login_name { </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">option_list1</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">sources</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">option_list1</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> ::</span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">PASSWORD</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#032F62;">&#39;password&#39;</span><span style="color:#24292E;"> | hashed_password </span><span style="color:#D73A49;">HASHED</span><span style="color:#24292E;"> } [ MUST_CHANGE ]</span></span>
<span class="line"><span style="color:#24292E;">    [ , &lt;option_list2&gt; [ ,... ] ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">option_list2</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> ::</span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">sid</span></span>
<span class="line"><span style="color:#24292E;">    | </span><span style="color:#D73A49;">DEFAULT_DATABASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span></span>
<span class="line"><span style="color:#24292E;">    | </span><span style="color:#D73A49;">DEFAULT_LANGUAGE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">language</span></span>
<span class="line"><span style="color:#24292E;">    | </span><span style="color:#D73A49;">CHECK_EXPIRATION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">OFF</span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">    | </span><span style="color:#D73A49;">CHECK_POLICY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">OFF</span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">    | </span><span style="color:#D73A49;">CREDENTIAL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> credential_name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">sources</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> ::</span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WINDOWS</span><span style="color:#24292E;"> [ WITH &lt;windows_options&gt;[ ,... ] ]</span></span>
<span class="line"><span style="color:#24292E;">    | </span><span style="color:#D73A49;">CERTIFICATE</span><span style="color:#24292E;"> certname</span></span>
<span class="line"><span style="color:#24292E;">    | </span><span style="color:#D73A49;">ASYMMETRIC</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">KEY</span><span style="color:#24292E;"> asym_key_name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">windows_options</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> ::</span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">DEFAULT_DATABASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span></span>
<span class="line"><span style="color:#24292E;">    | </span><span style="color:#D73A49;">DEFAULT_LANGUAGE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">language</span></span></code></pre></div><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- Syntax for SQL Server, Azure SQL Database, and Azure SQL Managed Instance</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">-- Syntax Users based on logins in master  </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">USER</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">user_name</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    [   </span></span>
<span class="line"><span style="color:#E1E4E8;">        { </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">LOGIN</span><span style="color:#E1E4E8;"> login_name   </span></span>
<span class="line"><span style="color:#E1E4E8;">    ]  </span></span>
<span class="line"><span style="color:#E1E4E8;">    [ WITH &lt;limited_options_list&gt; [ ,... ] ]   </span></span>
<span class="line"><span style="color:#E1E4E8;">[ ; ]  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">-- Users that authenticate at the database  </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> USER   </span></span>
<span class="line"><span style="color:#E1E4E8;">    {  </span></span>
<span class="line"><span style="color:#E1E4E8;">      windows_principal [ WITH &lt;options_list&gt; [ ,... ] ]  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">    | user_name </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PASSWORD</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;password&#39;</span><span style="color:#E1E4E8;"> [ , &lt;options_list&gt; [ ,... ]   </span></span>
<span class="line"><span style="color:#E1E4E8;">    | Azure_Active_Directory_principal </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">EXTERNAL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PROVIDER</span></span>
<span class="line"><span style="color:#E1E4E8;">    }  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> [ ; ]  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">-- Users based on Windows principals that connect through Windows group logins  </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> USER   </span></span>
<span class="line"><span style="color:#E1E4E8;">    {   </span></span>
<span class="line"><span style="color:#E1E4E8;">          windows_principal [ { FOR | FROM } LOGIN windows_principal ]  </span></span>
<span class="line"><span style="color:#E1E4E8;">        | user_name { </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">LOGIN</span><span style="color:#E1E4E8;"> windows_principal  </span></span>
<span class="line"><span style="color:#E1E4E8;">}  </span></span>
<span class="line"><span style="color:#E1E4E8;">    [ WITH &lt;limited_options_list&gt; [ ,... ] ]   </span></span>
<span class="line"><span style="color:#E1E4E8;">[ ; ]  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">-- Users that cannot authenticate   </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">USER</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">user_name</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    {  </span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">WITHOUT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LOGIN</span><span style="color:#E1E4E8;"> [ WITH &lt;limited_options_list&gt; [ ,... ] ]  </span></span>
<span class="line"><span style="color:#E1E4E8;">       | { </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">CERTIFICATE</span><span style="color:#E1E4E8;"> cert_name   </span></span>
<span class="line"><span style="color:#E1E4E8;">       | { </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">ASYMMETRIC</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">KEY</span><span style="color:#E1E4E8;"> asym_key_name   </span></span>
<span class="line"><span style="color:#E1E4E8;">    }  </span></span>
<span class="line"><span style="color:#E1E4E8;"> [ ; ]  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">options_list</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> ::</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">DEFAULT_SCHEMA</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> schema_name  </span></span>
<span class="line"><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">DEFAULT_LANGUAGE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#F97583;">NONE</span><span style="color:#E1E4E8;"> | lcid | </span><span style="color:#F97583;">language</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">language</span><span style="color:#E1E4E8;"> alias }  </span></span>
<span class="line"><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">SID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">sid</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">ALLOW_ENCRYPTED_VALUE_MODIFICATIONS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [ ON | OFF ] ]  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">limited_options_list</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> ::</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">DEFAULT_SCHEMA</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> schema_name ]   </span></span>
<span class="line"><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">ALLOW_ENCRYPTED_VALUE_MODIFICATIONS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [ ON | OFF ] ]  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">-- SQL Database syntax when connected to a federation member  </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">USER</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">user_name</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">[;]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- Syntax for users based on Azure AD logins for Azure SQL Managed Instance</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">USER</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">user_name</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    [   { FOR | FROM } LOGIN login_name  ]  </span></span>
<span class="line"><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">EXTERNAL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PROVIDER</span></span>
<span class="line"><span style="color:#E1E4E8;">    [ WITH &lt;limited_options_list&gt; [ ,... ] ]   </span></span>
<span class="line"><span style="color:#E1E4E8;">[ ; ]  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">limited_options_list</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> ::</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">DEFAULT_SCHEMA</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> schema_name </span></span>
<span class="line"><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">DEFAULT_LANGUAGE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> { </span><span style="color:#F97583;">NONE</span><span style="color:#E1E4E8;"> | lcid | </span><span style="color:#F97583;">language</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">language</span><span style="color:#E1E4E8;"> alias }   </span></span>
<span class="line"><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">ALLOW_ENCRYPTED_VALUE_MODIFICATIONS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [ ON | OFF ] ]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- Syntax for SQL Server, Azure SQL Database, and Azure SQL Managed Instance</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#6A737D;">-- Syntax Users based on logins in master  </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">USER</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">user_name</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    [   </span></span>
<span class="line"><span style="color:#24292E;">        { </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> } </span><span style="color:#D73A49;">LOGIN</span><span style="color:#24292E;"> login_name   </span></span>
<span class="line"><span style="color:#24292E;">    ]  </span></span>
<span class="line"><span style="color:#24292E;">    [ WITH &lt;limited_options_list&gt; [ ,... ] ]   </span></span>
<span class="line"><span style="color:#24292E;">[ ; ]  </span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#6A737D;">-- Users that authenticate at the database  </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> USER   </span></span>
<span class="line"><span style="color:#24292E;">    {  </span></span>
<span class="line"><span style="color:#24292E;">      windows_principal [ WITH &lt;options_list&gt; [ ,... ] ]  </span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">    | user_name </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PASSWORD</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;password&#39;</span><span style="color:#24292E;"> [ , &lt;options_list&gt; [ ,... ]   </span></span>
<span class="line"><span style="color:#24292E;">    | Azure_Active_Directory_principal </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">EXTERNAL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PROVIDER</span></span>
<span class="line"><span style="color:#24292E;">    }  </span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> [ ; ]  </span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#6A737D;">-- Users based on Windows principals that connect through Windows group logins  </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> USER   </span></span>
<span class="line"><span style="color:#24292E;">    {   </span></span>
<span class="line"><span style="color:#24292E;">          windows_principal [ { FOR | FROM } LOGIN windows_principal ]  </span></span>
<span class="line"><span style="color:#24292E;">        | user_name { </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> } </span><span style="color:#D73A49;">LOGIN</span><span style="color:#24292E;"> windows_principal  </span></span>
<span class="line"><span style="color:#24292E;">}  </span></span>
<span class="line"><span style="color:#24292E;">    [ WITH &lt;limited_options_list&gt; [ ,... ] ]   </span></span>
<span class="line"><span style="color:#24292E;">[ ; ]  </span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#6A737D;">-- Users that cannot authenticate   </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">USER</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">user_name</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    {  </span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">WITHOUT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LOGIN</span><span style="color:#24292E;"> [ WITH &lt;limited_options_list&gt; [ ,... ] ]  </span></span>
<span class="line"><span style="color:#24292E;">       | { </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> } </span><span style="color:#D73A49;">CERTIFICATE</span><span style="color:#24292E;"> cert_name   </span></span>
<span class="line"><span style="color:#24292E;">       | { </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> } </span><span style="color:#D73A49;">ASYMMETRIC</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">KEY</span><span style="color:#24292E;"> asym_key_name   </span></span>
<span class="line"><span style="color:#24292E;">    }  </span></span>
<span class="line"><span style="color:#24292E;"> [ ; ]  </span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">options_list</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> ::</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">DEFAULT_SCHEMA</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> schema_name  </span></span>
<span class="line"><span style="color:#24292E;">    | </span><span style="color:#D73A49;">DEFAULT_LANGUAGE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#D73A49;">NONE</span><span style="color:#24292E;"> | lcid | </span><span style="color:#D73A49;">language</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">language</span><span style="color:#24292E;"> alias }  </span></span>
<span class="line"><span style="color:#24292E;">    | </span><span style="color:#D73A49;">SID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">sid</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    | </span><span style="color:#D73A49;">ALLOW_ENCRYPTED_VALUE_MODIFICATIONS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [ ON | OFF ] ]  </span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">limited_options_list</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> ::</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">DEFAULT_SCHEMA</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> schema_name ]   </span></span>
<span class="line"><span style="color:#24292E;">    | </span><span style="color:#D73A49;">ALLOW_ENCRYPTED_VALUE_MODIFICATIONS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [ ON | OFF ] ]  </span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#6A737D;">-- SQL Database syntax when connected to a federation member  </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">USER</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">user_name</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">[;]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- Syntax for users based on Azure AD logins for Azure SQL Managed Instance</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">USER</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">user_name</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    [   { FOR | FROM } LOGIN login_name  ]  </span></span>
<span class="line"><span style="color:#24292E;">    | </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">EXTERNAL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PROVIDER</span></span>
<span class="line"><span style="color:#24292E;">    [ WITH &lt;limited_options_list&gt; [ ,... ] ]   </span></span>
<span class="line"><span style="color:#24292E;">[ ; ]  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">limited_options_list</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> ::</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">DEFAULT_SCHEMA</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> schema_name </span></span>
<span class="line"><span style="color:#24292E;">    | </span><span style="color:#D73A49;">DEFAULT_LANGUAGE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> { </span><span style="color:#D73A49;">NONE</span><span style="color:#24292E;"> | lcid | </span><span style="color:#D73A49;">language</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">language</span><span style="color:#24292E;"> alias }   </span></span>
<span class="line"><span style="color:#24292E;">    | </span><span style="color:#D73A49;">ALLOW_ENCRYPTED_VALUE_MODIFICATIONS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [ ON | OFF ] ]</span></span></code></pre></div><ul><li>创建登陆名</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">login</span><span style="color:#E1E4E8;"> LoginUserName </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">password</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;340$Uuxwp7Mcxo7Khy&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">default_database=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database_name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">login</span><span style="color:#24292E;"> LoginUserName </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">password</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;340$Uuxwp7Mcxo7Khy&#39;</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">default_database=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database_name</span></span></code></pre></div><p>==该句执行，数据会保存在服务器主体sys.server_principals中==</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141015201.jpg" alt=""></p><ul><li>创建数据库用户并与登录用户建立连接</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">#指定默认数据库【为了保持创建数据库用户与创建登录用户默认数据库一致,当前sql所在数据库可能不是创建登录用户的默认数据库。若一致，则可以不用执行</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#DatabaseUserName]和[LoginUserName]名最好保持一致，方便确定以后登录和查看对应关系</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> DatabaseUserName</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> USER [DatabaseUserName] </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">login</span><span style="color:#E1E4E8;"> [LoginUserName] </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">default_schema</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> dbo</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">#指定默认数据库【为了保持创建数据库用户与创建登录用户默认数据库一致,当前sql所在数据库可能不是创建登录用户的默认数据库。若一致，则可以不用执行</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#DatabaseUserName]和[LoginUserName]名最好保持一致，方便确定以后登录和查看对应关系</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> DatabaseUserName</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> USER [DatabaseUserName] </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">login</span><span style="color:#24292E;"> [LoginUserName] </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">default_schema</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> dbo</span></span></code></pre></div><p>==该句执行，数据会保存在数据库主体sys.database_principals中==</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141015328.jpg" alt=""></p><h3 id="_1-3-2删除登陆用户" tabindex="-1">1.3.2删除登陆用户 <a class="header-anchor" href="#_1-3-2删除登陆用户" aria-label="Permalink to &quot;1.3.2删除登陆用户&quot;">​</a></h3><ul><li>语法</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--声明数据库引用</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database_name</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">go</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">--判断是否存在用户，如果存在则删除</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">exists</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_logins</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name=</span><span style="color:#E1E4E8;">login_name)</span></span>
<span class="line"><span style="color:#F97583;">drop</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">login</span><span style="color:#E1E4E8;"> login_name;</span></span>
<span class="line"><span style="color:#F97583;">go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 或者</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_revokedbaccess </span><span style="color:#9ECBFF;">&quot;[LoginUserName]&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--声明数据库引用</span></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database_name</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">go</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">--判断是否存在用户，如果存在则删除</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">exists</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_logins</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name=</span><span style="color:#24292E;">login_name)</span></span>
<span class="line"><span style="color:#D73A49;">drop</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">login</span><span style="color:#24292E;"> login_name;</span></span>
<span class="line"><span style="color:#D73A49;">go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 或者</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_revokedbaccess </span><span style="color:#032F62;">&quot;[LoginUserName]&quot;</span></span></code></pre></div><h3 id="_1-3-3禁用登陆帐户" tabindex="-1">1.3.3禁用登陆帐户 <a class="header-anchor" href="#_1-3-3禁用登陆帐户" aria-label="Permalink to &quot;1.3.3禁用登陆帐户&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">alter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">login</span><span style="color:#E1E4E8;"> login_usernmae </span><span style="color:#F97583;">disable</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">alter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">login</span><span style="color:#24292E;"> login_usernmae </span><span style="color:#D73A49;">disable</span></span></code></pre></div><h3 id="_1-3-4启用登陆帐户" tabindex="-1">1.3.4启用登陆帐户 <a class="header-anchor" href="#_1-3-4启用登陆帐户" aria-label="Permalink to &quot;1.3.4启用登陆帐户&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">alter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">login</span><span style="color:#E1E4E8;"> login_usernmae </span><span style="color:#F97583;">enable</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">alter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">login</span><span style="color:#24292E;"> login_usernmae </span><span style="color:#D73A49;">enable</span></span></code></pre></div><h3 id="_1-3-5登陆帐户改名" tabindex="-1">1.3.5登陆帐户改名 <a class="header-anchor" href="#_1-3-5登陆帐户改名" aria-label="Permalink to &quot;1.3.5登陆帐户改名&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">alter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">login</span><span style="color:#E1E4E8;"> old_login_username </span><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name=</span><span style="color:#E1E4E8;">new_login_username</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">alter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">login</span><span style="color:#24292E;"> old_login_username </span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name=</span><span style="color:#24292E;">new_login_username</span></span></code></pre></div><h3 id="_1-3-6登陆帐户改密码" tabindex="-1">1.3.6登陆帐户改密码 <a class="header-anchor" href="#_1-3-6登陆帐户改密码" aria-label="Permalink to &quot;1.3.6登陆帐户改密码&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">alter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">login</span><span style="color:#E1E4E8;"> login_username </span><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">password=</span><span style="color:#9ECBFF;">&#39;newpassword&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">alter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">login</span><span style="color:#24292E;"> login_username </span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">password=</span><span style="color:#032F62;">&#39;newpassword&#39;</span></span></code></pre></div><h3 id="_1-3-7检查有没有登录权限" tabindex="-1">1.3.7检查有没有登录权限 <a class="header-anchor" href="#_1-3-7检查有没有登录权限" aria-label="Permalink to &quot;1.3.7检查有没有登录权限&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> is_disabled</span></span>
<span class="line"><span style="color:#E1E4E8;">,loginproperty(</span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;Isexpired&#39;</span><span style="color:#E1E4E8;">) is_expired</span></span>
<span class="line"><span style="color:#E1E4E8;">,loginproperty(</span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;Islocked&#39;</span><span style="color:#E1E4E8;">) is_locked</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">server_principals</span></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Login_username&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- Login_username 根据自己名字</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> is_disabled</span></span>
<span class="line"><span style="color:#24292E;">,loginproperty(</span><span style="color:#D73A49;">name</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;Isexpired&#39;</span><span style="color:#24292E;">) is_expired</span></span>
<span class="line"><span style="color:#24292E;">,loginproperty(</span><span style="color:#D73A49;">name</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;Islocked&#39;</span><span style="color:#24292E;">) is_locked</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">server_principals</span></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Login_username&#39;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- Login_username 根据自己名字</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141015960.jpg" alt=""></p><h2 id="_1-4-数据库用户名" tabindex="-1">1.4 数据库用户名 <a class="header-anchor" href="#_1-4-数据库用户名" aria-label="Permalink to &quot;1.4 数据库用户名&quot;">​</a></h2><h3 id="_1-4-0创建数据库用户" tabindex="-1">1.4.0创建数据库用户 <a class="header-anchor" href="#_1-4-0创建数据库用户" aria-label="Permalink to &quot;1.4.0创建数据库用户&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">user</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">data_usernmae</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">login</span><span style="color:#E1E4E8;"> login_username </span><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">default_schema=</span><span style="color:#E1E4E8;">dbo</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">user</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">data_usernmae</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">login</span><span style="color:#24292E;"> login_username </span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">default_schema=</span><span style="color:#24292E;">dbo</span></span></code></pre></div><h3 id="_1-4-1数据库用户改名" tabindex="-1">1.4.1数据库用户改名 <a class="header-anchor" href="#_1-4-1数据库用户改名" aria-label="Permalink to &quot;1.4.1数据库用户改名&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 语法</span></span>
<span class="line"><span style="color:#F97583;">alter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">user</span><span style="color:#E1E4E8;"> database_username </span><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name=</span><span style="color:#E1E4E8;">dba_tom</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 语法</span></span>
<span class="line"><span style="color:#D73A49;">alter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">user</span><span style="color:#24292E;"> database_username </span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name=</span><span style="color:#24292E;">dba_tom</span></span></code></pre></div><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 将数据库用户 testuser 的名称更改为 testuser1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">USER</span><span style="color:#E1E4E8;"> hantestuser </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NAME</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> hantestuser1;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 将数据库用户 testuser 的名称更改为 testuser1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">USER</span><span style="color:#24292E;"> hantestuser </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NAME</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> hantestuser1;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141015218.jpg" alt=""></p><h3 id="_1-4-2删除数据库用户" tabindex="-1">1.4.2删除数据库用户 <a class="header-anchor" href="#_1-4-2删除数据库用户" aria-label="Permalink to &quot;1.4.2删除数据库用户&quot;">​</a></h3><ul><li>语法</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- Syntax for SQL Server and Azure SQL Database  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">DROP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">USER</span><span style="color:#E1E4E8;"> [ IF EXISTS ] user_name</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- Syntax for Azure Synapse Analytics and Parallel Data Warehouse  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">DROP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">USER</span><span style="color:#E1E4E8;"> user_name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- Syntax for SQL Server and Azure SQL Database  </span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">DROP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">USER</span><span style="color:#24292E;"> [ IF EXISTS ] user_name</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- Syntax for Azure Synapse Analytics and Parallel Data Warehouse  </span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">DROP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">USER</span><span style="color:#24292E;"> user_name</span></span></code></pre></div><h2 id="_1-4查看用户" tabindex="-1">1.4查看用户 <a class="header-anchor" href="#_1-4查看用户" aria-label="Permalink to &quot;1.4查看用户&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 查看所有</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">server_principals</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看指定登陆用户</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">server_principals</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LIKE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;%han%&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 或者</span></span>
<span class="line"><span style="color:#E1E4E8;">sp_who</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看该登陆名下的所有连接</span></span>
<span class="line"><span style="color:#E1E4E8;">sp_who </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> 登录名</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 查看所有</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">server_principals</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看指定登陆用户</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">server_principals</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LIKE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;%han%&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 或者</span></span>
<span class="line"><span style="color:#24292E;">sp_who</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看该登陆名下的所有连接</span></span>
<span class="line"><span style="color:#24292E;">sp_who </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> 登录名</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141015870.jpg" alt=""></p><h3 id="查看所有登陆用户名" tabindex="-1">查看所有登陆用户名 <a class="header-anchor" href="#查看所有登陆用户名" aria-label="Permalink to &quot;查看所有登陆用户名&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">convert</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">varbinary</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">isnull</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">password</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)) passwd,</span><span style="color:#F97583;">sid</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">,loginname,</span><span style="color:#F97583;">password</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> syslogins </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">password</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS NOT NULL</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">convert</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">varbinary</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">255</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">isnull</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">password</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)) passwd,</span><span style="color:#D73A49;">sid</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">name</span><span style="color:#24292E;">,loginname,</span><span style="color:#D73A49;">password</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> syslogins </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">password</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS NOT NULL</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141015300.jpg" alt=""></p><h3 id="查看数据库映射用户" tabindex="-1">查看数据库映射用户 <a class="header-anchor" href="#查看数据库映射用户" aria-label="Permalink to &quot;查看数据库映射用户&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> hantest</span></span>
<span class="line"><span style="color:#6A737D;">-- 查看登录名和数据库的用户名的映射</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DP</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;">[user_name],</span><span style="color:#79B8FF;">SP</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> [logion_name] </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> DP ,</span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">server_principals</span><span style="color:#E1E4E8;"> SP </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SP</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DP</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sid</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> hantest</span></span>
<span class="line"><span style="color:#6A737D;">-- 查看登录名和数据库的用户名的映射</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DP</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;">[user_name],</span><span style="color:#005CC5;">SP</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> [logion_name] </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> DP ,</span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">server_principals</span><span style="color:#24292E;"> SP </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SP</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DP</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sid</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141015581.jpg" alt=""></p><h3 id="查看账号在每个db的数据库角色清单" tabindex="-1">查看账号在每个db的数据库角色清单 <a class="header-anchor" href="#查看账号在每个db的数据库角色清单" aria-label="Permalink to &quot;查看账号在每个db的数据库角色清单&quot;">​</a></h3><p>==保证每个库字符集相同，否则无法计算==</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span></span>
<span class="line"><span style="color:#F97583;">GO</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;tempdb..#tmp&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">is not null</span></span>
<span class="line"><span style="color:#F97583;">DROP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> #tmp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> #tmp(id </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">primary key</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">identity</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">), username </span><span style="color:#F97583;">nvarchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">), databasename </span><span style="color:#F97583;">nvarchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">), privs </span><span style="color:#F97583;">nvarchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @databasename </span><span style="color:#F97583;">nvarchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @sql </span><span style="color:#F97583;">nvarchar</span><span style="color:#E1E4E8;">(max)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- .过滤database_name</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> database_cursor </span><span style="color:#F97583;">CURSOR</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FOR</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">databases</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- AND name LIKE &#39;DBName%&#39; </span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">OPEN</span><span style="color:#E1E4E8;"> database_cursor</span></span>
<span class="line"><span style="color:#F97583;">FETCH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NEXT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> database_cursor </span><span style="color:#F97583;">INTO</span><span style="color:#E1E4E8;"> @databasename</span></span>
<span class="line"><span style="color:#F97583;">WHILE</span><span style="color:#E1E4E8;"> @@FETCH_STATUS </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @sql </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;USE &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(@databasename) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;;</span></span>
<span class="line"><span style="color:#9ECBFF;">  select u.name, db_name(), r.name</span></span>
<span class="line"><span style="color:#9ECBFF;">  from sys.database_principals u</span></span>
<span class="line"><span style="color:#9ECBFF;">  inner join sys.database_role_members map on u.principal_id = map.member_principal_id</span></span>
<span class="line"><span style="color:#9ECBFF;">  inner join sys.database_principals r on map.role_principal_id = r.principal_id</span></span>
<span class="line"><span style="color:#9ECBFF;">  inner join sys.sql_logins l on u.name = l.name and is_disabled = 0</span></span>
<span class="line"><span style="color:#9ECBFF;">  where u.name &lt;&gt; &#39;&#39;dbo&#39;&#39;&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> #tmp (username, databasename, privs)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> (@sql)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">FETCH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NEXT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> database_cursor </span><span style="color:#F97583;">INTO</span><span style="color:#E1E4E8;"> @databasename</span></span>
<span class="line"><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#F97583;">CLOSE</span><span style="color:#E1E4E8;"> database_cursor</span></span>
<span class="line"><span style="color:#F97583;">DEALLOCATE</span><span style="color:#E1E4E8;"> database_cursor</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> #tmp (username, databasename, privs)</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">server_role_members</span><span style="color:#E1E4E8;"> r</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">server_principals</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">role_principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;R&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_logins</span><span style="color:#E1E4E8;"> u </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">member_principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_disabled</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">member_principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">username</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">databasename</span><span style="color:#E1E4E8;">, group_concat </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">STUFF</span><span style="color:#E1E4E8;">(( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;,&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> privs </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> #tmp </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> t1 </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">username</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">username</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">databasename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">databasename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">xml</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">path</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)) , </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> , </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> , </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> #tmp </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> t2 </span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">username</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_logins</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">databasename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS NOT NULL</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">GROUP BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">username</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">t2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">databasename</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span></span>
<span class="line"><span style="color:#D73A49;">GO</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;tempdb..#tmp&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">is not null</span></span>
<span class="line"><span style="color:#D73A49;">DROP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> #tmp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> #tmp(id </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">primary key</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">identity</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">), username </span><span style="color:#D73A49;">nvarchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">), databasename </span><span style="color:#D73A49;">nvarchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">), privs </span><span style="color:#D73A49;">nvarchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @databasename </span><span style="color:#D73A49;">nvarchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @sql </span><span style="color:#D73A49;">nvarchar</span><span style="color:#24292E;">(max)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- .过滤database_name</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> database_cursor </span><span style="color:#D73A49;">CURSOR</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FOR</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">databases</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">state</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- AND name LIKE &#39;DBName%&#39; </span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">OPEN</span><span style="color:#24292E;"> database_cursor</span></span>
<span class="line"><span style="color:#D73A49;">FETCH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NEXT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> database_cursor </span><span style="color:#D73A49;">INTO</span><span style="color:#24292E;"> @databasename</span></span>
<span class="line"><span style="color:#D73A49;">WHILE</span><span style="color:#24292E;"> @@FETCH_STATUS </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @sql </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;USE &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(@databasename) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;;</span></span>
<span class="line"><span style="color:#032F62;">  select u.name, db_name(), r.name</span></span>
<span class="line"><span style="color:#032F62;">  from sys.database_principals u</span></span>
<span class="line"><span style="color:#032F62;">  inner join sys.database_role_members map on u.principal_id = map.member_principal_id</span></span>
<span class="line"><span style="color:#032F62;">  inner join sys.database_principals r on map.role_principal_id = r.principal_id</span></span>
<span class="line"><span style="color:#032F62;">  inner join sys.sql_logins l on u.name = l.name and is_disabled = 0</span></span>
<span class="line"><span style="color:#032F62;">  where u.name &lt;&gt; &#39;&#39;dbo&#39;&#39;&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> #tmp (username, databasename, privs)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> (@sql)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">FETCH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NEXT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> database_cursor </span><span style="color:#D73A49;">INTO</span><span style="color:#24292E;"> @databasename</span></span>
<span class="line"><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#D73A49;">CLOSE</span><span style="color:#24292E;"> database_cursor</span></span>
<span class="line"><span style="color:#D73A49;">DEALLOCATE</span><span style="color:#24292E;"> database_cursor</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> #tmp (username, databasename, privs)</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">server_role_members</span><span style="color:#24292E;"> r</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">server_principals</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">role_principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;R&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_logins</span><span style="color:#24292E;"> u </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">member_principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_disabled</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">member_principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">username</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">databasename</span><span style="color:#24292E;">, group_concat </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">STUFF</span><span style="color:#24292E;">(( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;,&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> privs </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> #tmp </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> t1 </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">username</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">username</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">databasename</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">databasename</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">xml</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">path</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)) , </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> , </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> , </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> #tmp </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> t2 </span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">username</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_logins</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">databasename</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS NOT NULL</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">GROUP BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">username</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">t2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">databasename</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141015537.jpg" alt=""></p><h2 id="_1-5默认架构" tabindex="-1">1.5默认架构 <a class="header-anchor" href="#_1-5默认架构" aria-label="Permalink to &quot;1.5默认架构&quot;">​</a></h2><h3 id="_1-5-0创建默认架构" tabindex="-1">1.5.0创建默认架构 <a class="header-anchor" href="#_1-5-0创建默认架构" aria-label="Permalink to &quot;1.5.0创建默认架构&quot;">​</a></h3><p><a href="https://docs.microsoft.com/zh-cn/sql/t-sql/statements/create-schema-transact-sql?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/t-sql/statements/create-schema-transact-sql?view=sql-server-2017</a></p><ul><li>语法</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- Syntax for SQL Server and Azure SQL Database  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SCHEMA</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">schema_name_clause</span><span style="color:#E1E4E8;"> [ &lt;schema_element&gt; [ ...n ] ]  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">schema_name_clause</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> ::</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">    {  </span></span>
<span class="line"><span style="color:#E1E4E8;">    schema_name  </span></span>
<span class="line"><span style="color:#E1E4E8;">    | AUTHORIZATION owner_name  </span></span>
<span class="line"><span style="color:#E1E4E8;">    | schema_name AUTHORIZATION owner_name  </span></span>
<span class="line"><span style="color:#E1E4E8;">    }  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">schema_element</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> ::</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    {   </span></span>
<span class="line"><span style="color:#E1E4E8;">        table_definition | view_definition | grant_statement |   </span></span>
<span class="line"><span style="color:#E1E4E8;">        revoke_statement | deny_statement   </span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- Syntax for SQL Server and Azure SQL Database  </span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">SCHEMA</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">schema_name_clause</span><span style="color:#24292E;"> [ &lt;schema_element&gt; [ ...n ] ]  </span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">schema_name_clause</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> ::</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">    {  </span></span>
<span class="line"><span style="color:#24292E;">    schema_name  </span></span>
<span class="line"><span style="color:#24292E;">    | AUTHORIZATION owner_name  </span></span>
<span class="line"><span style="color:#24292E;">    | schema_name AUTHORIZATION owner_name  </span></span>
<span class="line"><span style="color:#24292E;">    }  </span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">schema_element</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> ::</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    {   </span></span>
<span class="line"><span style="color:#24292E;">        table_definition | view_definition | grant_statement |   </span></span>
<span class="line"><span style="color:#24292E;">        revoke_statement | deny_statement   </span></span>
<span class="line"><span style="color:#24292E;">    }</span></span></code></pre></div><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> hantest</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SCHEMA</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">customer_services</span><span style="color:#E1E4E8;"> AUTHORIZATION  hantestuser</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> hantest</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">SCHEMA</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">customer_services</span><span style="color:#24292E;"> AUTHORIZATION  hantestuser</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><h3 id="_1-5-1更改用户的默认架构" tabindex="-1">1.5.1更改用户的默认架构 <a class="header-anchor" href="#_1-5-1更改用户的默认架构" aria-label="Permalink to &quot;1.5.1更改用户的默认架构&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">USER</span><span style="color:#E1E4E8;"> testuser1 </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DEFAULT_SCHEMA</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Purchasing;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">USER</span><span style="color:#24292E;"> testuser1 </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DEFAULT_SCHEMA</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Purchasing;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><ul><li>同时更改</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">USER</span><span style="color:#E1E4E8;"> Philip</span></span>
<span class="line"><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NAME</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Philipe</span></span>
<span class="line"><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">DEFAULT_SCHEMA</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Development</span></span>
<span class="line"><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">PASSWORD</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;W1r77TT98%ab@#&#39;</span><span style="color:#E1E4E8;"> OLD_PASSWORD </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;New Devel0per&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">DEFAULT_LANGUAGE=</span><span style="color:#E1E4E8;"> French ;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">USER</span><span style="color:#24292E;"> Philip</span></span>
<span class="line"><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NAME</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Philipe</span></span>
<span class="line"><span style="color:#24292E;">, </span><span style="color:#D73A49;">DEFAULT_SCHEMA</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Development</span></span>
<span class="line"><span style="color:#24292E;">, </span><span style="color:#D73A49;">PASSWORD</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;W1r77TT98%ab@#&#39;</span><span style="color:#24292E;"> OLD_PASSWORD </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;New Devel0per&#39;</span></span>
<span class="line"><span style="color:#24292E;">, </span><span style="color:#D73A49;">DEFAULT_LANGUAGE=</span><span style="color:#24292E;"> French ;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><h3 id="_1-5-3查询所有架构" tabindex="-1">1.5.3查询所有架构 <a class="header-anchor" href="#_1-5-3查询所有架构" aria-label="Permalink to &quot;1.5.3查询所有架构&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> schema_name,</span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> schema_owner </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schemas</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sysusers</span><span style="color:#E1E4E8;"> u </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">uid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> schema_name,</span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> schema_owner </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schemas</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sysusers</span><span style="color:#24292E;"> u </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">uid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141015085.jpg" alt=""></p><h3 id="_1-5-4删除架构" tabindex="-1">1.5.4删除架构 <a class="header-anchor" href="#_1-5-4删除架构" aria-label="Permalink to &quot;1.5.4删除架构&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">DROP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SCHEMA</span><span style="color:#E1E4E8;"> [IF EXISTS] schema_name;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">DROP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">SCHEMA</span><span style="color:#24292E;"> [IF EXISTS] schema_name;</span></span></code></pre></div><h1 id="_1-6角色" tabindex="-1">1.6角色 <a class="header-anchor" href="#_1-6角色" aria-label="Permalink to &quot;1.6角色&quot;">​</a></h1><p>角色是一类权限的组合。</p><h2 id="_1-6-0数据库角色授权" tabindex="-1">1.6.0数据库角色授权 <a class="header-anchor" href="#_1-6-0数据库角色授权" aria-label="Permalink to &quot;1.6.0数据库角色授权&quot;">​</a></h2><p>9中<strong>固定数据库角色</strong></p><p>&quot;db_owner&quot; --拥有数据库全部权限，包括删除数据库权限</p><p>&quot;db_accessadmin&quot; --只给数据库用户创建其他数据库用户的权限，而没有创建登录用户的权限。</p><p>&quot;db_securityadmin&quot; --可以管理全部权限、对象所有权、角色和角色成员资格</p><p>&quot;db_ddladmin&quot; --可以发出所有DDL(Create,Alter和Drop)，但不能发出GRANT、REVOKE或DENY语句</p><p>&quot;db_backupoperator&quot; --允许对数据库进行备份和还原的权限【备份与还原是通过sql sever management studio也可以进行】</p><p>&quot;db_datareader&quot; --可以选择数据库内任何用户表中的所有数据</p><p>&quot;db_datawriter&quot; --可以更改数据库内任何用户表中的所有数据</p><p>&quot;db_denydatareader&quot; --不能查询数据库内任何用户表中的任何数据</p><p>&quot;db_denydatawriter&quot; --不能更改数据库内任何用户表中的任何数据</p><p>==DataBase级别的角色作用范围是整个DB的，比如db_datareader，db_datawriter都是作用在数据库所有的对象==</p><ul><li>语法</li></ul><p><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-stored-procedures/sp-addrolemember-transact-sql?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/relational-databases/system-stored-procedures/sp-addrolemember-transact-sql?view=sql-server-2017</a></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">sp_addrolemember [ @rolename = ] </span><span style="color:#9ECBFF;">&#39;role&#39;</span><span style="color:#E1E4E8;">, [ @membername = ] </span><span style="color:#9ECBFF;">&#39;security_account&#39;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[ @rolename= ] </span><span style="color:#9ECBFF;">&quot;@rolename=&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">当前数据库中的数据库角色的名称。 </span><span style="color:#F97583;">role</span><span style="color:#E1E4E8;"> 是 </span><span style="color:#F97583;">sysname</span><span style="color:#E1E4E8;">，无默认值。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[ @membername= ] </span><span style="color:#9ECBFF;">&#39;@membername=&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">添加到该角色中的安全帐户。 security_account 是 </span><span style="color:#F97583;">sysname</span><span style="color:#E1E4E8;">，无默认值。 security_account可以是数据库用户、数据库角色、</span><span style="color:#F97583;">Windows</span><span style="color:#E1E4E8;"> 登录名或 </span><span style="color:#F97583;">Windows</span><span style="color:#E1E4E8;"> 组</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">sp_addrolemember [ @rolename = ] </span><span style="color:#032F62;">&#39;role&#39;</span><span style="color:#24292E;">, [ @membername = ] </span><span style="color:#032F62;">&#39;security_account&#39;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[ @rolename= ] </span><span style="color:#032F62;">&quot;@rolename=&quot;</span></span>
<span class="line"><span style="color:#24292E;">当前数据库中的数据库角色的名称。 </span><span style="color:#D73A49;">role</span><span style="color:#24292E;"> 是 </span><span style="color:#D73A49;">sysname</span><span style="color:#24292E;">，无默认值。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[ @membername= ] </span><span style="color:#032F62;">&#39;@membername=&#39;</span></span>
<span class="line"><span style="color:#24292E;">添加到该角色中的安全帐户。 security_account 是 </span><span style="color:#D73A49;">sysname</span><span style="color:#24292E;">，无默认值。 security_account可以是数据库用户、数据库角色、</span><span style="color:#D73A49;">Windows</span><span style="color:#24292E;"> 登录名或 </span><span style="color:#D73A49;">Windows</span><span style="color:#24292E;"> 组</span></span></code></pre></div><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_addrolemember </span><span style="color:#9ECBFF;">&quot;db_datareader&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;hantestuser&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_addrolemember </span><span style="color:#032F62;">&quot;db_datareader&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;hantestuser&quot;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141015008.jpg" alt=""></p><h3 id="_1-6-0-创建角色" tabindex="-1">1.6.0 创建角色 <a class="header-anchor" href="#_1-6-0-创建角色" aria-label="Permalink to &quot;1.6.0 创建角色&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> db_name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--创建角色 r_test</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_addrole </span><span style="color:#9ECBFF;">&#39;r_test&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> db_name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--创建角色 r_test</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_addrole </span><span style="color:#032F62;">&#39;r_test&#39;</span></span></code></pre></div><h3 id="_1-6-1查看用户角色授权" tabindex="-1">1.6.1查看用户角色授权 <a class="header-anchor" href="#_1-6-1查看用户角色授权" aria-label="Permalink to &quot;1.6.1查看用户角色授权&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> UserName, </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> UserType, </span><span style="color:#79B8FF;">pp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> DBRoleName, </span><span style="color:#79B8FF;">pp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> DBRoleType, </span><span style="color:#79B8FF;">pp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_fixed_role</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> IfFixedRole</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_role_members</span><span style="color:#E1E4E8;"> roles</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">roles</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">member_principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> pp </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">roles</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">role_principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;db_owner&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;db_datareader&#39;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> UserName, </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> UserType, </span><span style="color:#005CC5;">pp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> DBRoleName, </span><span style="color:#005CC5;">pp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> DBRoleType, </span><span style="color:#005CC5;">pp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_fixed_role</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> IfFixedRole</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_role_members</span><span style="color:#24292E;"> roles</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">roles</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">member_principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> pp </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">roles</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">role_principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;db_owner&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;db_datareader&#39;</span><span style="color:#24292E;">)</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141015774.jpg" alt=""></p><h3 id="_1-6-2查看服务器角色授权" tabindex="-1">1.6.2查看服务器角色授权 <a class="header-anchor" href="#_1-6-2查看服务器角色授权" aria-label="Permalink to &quot;1.6.2查看服务器角色授权&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> UserName, </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> UserType, </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> LoginName, </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> LoginType </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> dp </span><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">server_principals</span><span style="color:#E1E4E8;"> sp </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> UserType</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> UserName, </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> UserType, </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> LoginName, </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> LoginType </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> dp </span><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">server_principals</span><span style="color:#24292E;"> sp </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> UserType</span></span></code></pre></div><h3 id="_1-6-3删除数据库用户角色" tabindex="-1">1.6.3删除数据库用户角色 <a class="header-anchor" href="#_1-6-3删除数据库用户角色" aria-label="Permalink to &quot;1.6.3删除数据库用户角色&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> hantest</span></span>
<span class="line"><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_droprolemember </span><span style="color:#9ECBFF;">&#39;db_datareader&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;hantestuser&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> hantest</span></span>
<span class="line"><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_droprolemember </span><span style="color:#032F62;">&#39;db_datareader&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;hantestuser&#39;</span></span></code></pre></div><h3 id="_1-6-4查询一个username拥有的所有权限" tabindex="-1">1.6.4查询一个UserName拥有的所有权限 <a class="header-anchor" href="#_1-6-4查询一个username拥有的所有权限" aria-label="Permalink to &quot;1.6.4查询一个UserName拥有的所有权限&quot;">​</a></h3><p>通过角色集成的权限和自身具备的权限</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--</span></span>
<span class="line"><span style="color:#6A737D;">-- 查询一个UserName拥有的角色以及角色拥有的操作对象, xxx 根据自己的名字</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @login_name </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;xxx&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">;</span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> LoginName</span></span>
<span class="line"><span style="color:#F97583;">AS</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> LoginName,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> RoleName,</span></span>
<span class="line"><span style="color:#E1E4E8;">        role_principal_id   </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> PrincipalId</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_role_members</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> m</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> r </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">role_principal_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> u </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">member_principal_id</span></span>
<span class="line"><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">UserPermission</span></span>
<span class="line"><span style="color:#F97583;">AS</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">USER_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">grantee_principal_id</span><span style="color:#E1E4E8;">)   </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> principal_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> principal_id,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type_desc</span><span style="color:#E1E4E8;">                       </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> principal_type_desc,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">class_desc</span><span style="color:#E1E4E8;">                       </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> class_desc,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">major_id</span><span style="color:#E1E4E8;">)            </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> object_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">permission_name</span><span style="color:#E1E4E8;">                  </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> permission_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">state_desc</span><span style="color:#E1E4E8;">                       </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> permission_state_desc</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_permissions</span><span style="color:#E1E4E8;"> p</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> dp </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">grantee_principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- 通过角色获取的权限对象</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">LoginName</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">RoleName</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_type_desc</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">class_desc</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">permission_name</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_name</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">permission_state_desc</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> LoginName u </span><span style="color:#F97583;">left join</span><span style="color:#E1E4E8;"> UserPermission p </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">RoleName</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">LoginName</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @login_name</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">UNION ALL</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- 直接授权给账号的权限对象</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;">      @login_name             </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> LoginName,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">                      </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> RoleName,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type_desc</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> principal_type_desc,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">class_desc</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> class_desc,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">permission_name</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> permission_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">major_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> object_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">state_desc</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> permission_state_desc</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_permissions</span><span style="color:#E1E4E8;"> p</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> dp </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">grantee_principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">USER_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">grantee_principal_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @login_name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">UNION ALL</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- 固定服务器角色的权限</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">            ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">cast</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">))    ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type_desc</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> class_desc,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> object_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">p2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> permission_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> permission_state_desc</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">server_principals</span><span style="color:#E1E4E8;"> r</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">server_role_members</span><span style="color:#E1E4E8;"> m </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">member_principal_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">server_principals</span><span style="color:#E1E4E8;"> p1 </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">member_principal_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">server_principals</span><span style="color:#E1E4E8;"> p2 </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">role_principal_id</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @login_name</span></span>
<span class="line"><span style="color:#E1E4E8;">)t</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--</span></span>
<span class="line"><span style="color:#6A737D;">-- 查询一个UserName拥有的角色以及角色拥有的操作对象, xxx 根据自己的名字</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @login_name </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;xxx&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">;</span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> LoginName</span></span>
<span class="line"><span style="color:#D73A49;">AS</span></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> LoginName,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">          </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> RoleName,</span></span>
<span class="line"><span style="color:#24292E;">        role_principal_id   </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> PrincipalId</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_role_members</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> m</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> r </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">role_principal_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> u </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">member_principal_id</span></span>
<span class="line"><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">UserPermission</span></span>
<span class="line"><span style="color:#D73A49;">AS</span></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">USER_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">grantee_principal_id</span><span style="color:#24292E;">)   </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> principal_name,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;">                    </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> principal_id,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type_desc</span><span style="color:#24292E;">                       </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> principal_type_desc,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">class_desc</span><span style="color:#24292E;">                       </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> class_desc,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">major_id</span><span style="color:#24292E;">)            </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> object_name,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">permission_name</span><span style="color:#24292E;">                  </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> permission_name,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">state_desc</span><span style="color:#24292E;">                       </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> permission_state_desc</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_permissions</span><span style="color:#24292E;"> p</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> dp </span><span style="color:#D73A49;">on</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">grantee_principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- 通过角色获取的权限对象</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">LoginName</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">RoleName</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_type_desc</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">class_desc</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">permission_name</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_name</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">permission_state_desc</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> LoginName u </span><span style="color:#D73A49;">left join</span><span style="color:#24292E;"> UserPermission p </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">RoleName</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">LoginName</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @login_name</span></span>
<span class="line"><span style="color:#24292E;">      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">UNION ALL</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- 直接授权给账号的权限对象</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">select</span><span style="color:#24292E;">      @login_name             </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> LoginName,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">                      </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> RoleName,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type_desc</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> principal_type_desc,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">class_desc</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> class_desc,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">permission_name</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> permission_name,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">major_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> object_name,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">state_desc</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> permission_state_desc</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_permissions</span><span style="color:#24292E;"> p</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> dp </span><span style="color:#D73A49;">on</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">grantee_principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">USER_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">grantee_principal_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @login_name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">UNION ALL</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- 固定服务器角色的权限</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">            ,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">cast</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">))    ,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type_desc</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> class_desc,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> object_name,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">p2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> permission_name,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> permission_state_desc</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">server_principals</span><span style="color:#24292E;"> r</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">server_role_members</span><span style="color:#24292E;"> m </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">member_principal_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">server_principals</span><span style="color:#24292E;"> p1 </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">member_principal_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">server_principals</span><span style="color:#24292E;"> p2 </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">role_principal_id</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @login_name</span></span>
<span class="line"><span style="color:#24292E;">)t</span></span></code></pre></div><h3 id="_1-6-5查询某个账号有哪些权限" tabindex="-1">1.6.5查询某个账号有哪些权限 <a class="header-anchor" href="#_1-6-5查询某个账号有哪些权限" aria-label="Permalink to &quot;1.6.5查询某个账号有哪些权限&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--查询某个账号有哪些权限，直接授权给账号的,而不是通过角色继承来的,xxx根据自己填写</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">USER_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">grantee_principal_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> principal_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">grantee_principal_id</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> principal_type_desc,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">class_desc</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">major_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> object_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">permission_name</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">state_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> permission_state_desc</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_permissions</span><span style="color:#E1E4E8;"> p </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> dp </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">grantee_principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">USER_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">grantee_principal_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;xxx&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--查询某个账号有哪些权限，直接授权给账号的,而不是通过角色继承来的,xxx根据自己填写</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">USER_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">grantee_principal_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> principal_name,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">grantee_principal_id</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> principal_type_desc,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">class_desc</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">major_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> object_name,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">permission_name</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">state_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> permission_state_desc</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_permissions</span><span style="color:#24292E;"> p </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> dp </span><span style="color:#D73A49;">on</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">grantee_principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">USER_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">grantee_principal_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;xxx&#39;</span></span></code></pre></div><h3 id="_1-6-6查询某个user有哪些角色的权限" tabindex="-1">1.6.6查询某个User有哪些角色的权限 <a class="header-anchor" href="#_1-6-6查询某个user有哪些角色的权限" aria-label="Permalink to &quot;1.6.6查询某个User有哪些角色的权限&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--某个User有哪些角色的权限（User属于哪一个（多个）角色）</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_role_members</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> m</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> r </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">role_principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> u </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">member_principal_id</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ReadUser&#39;</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">--UserName</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--某个User有哪些角色的权限（User属于哪一个（多个）角色）</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_role_members</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> m</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> r </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">role_principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> u </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">member_principal_id</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ReadUser&#39;</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">--UserName</span></span></code></pre></div><h3 id="_1-6-7查询某个自定义角色拥有哪些权限" tabindex="-1">1.6.7查询某个自定义角色拥有哪些权限 <a class="header-anchor" href="#_1-6-7查询某个自定义角色拥有哪些权限" aria-label="Permalink to &quot;1.6.7查询某个自定义角色拥有哪些权限&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--查询某个角色拥有的权限</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">USER_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">grantee_principal_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> principal_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> principal_type_desc,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">class_desc</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">major_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> object_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">permission_name</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">state_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> permission_state_desc</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_permissions</span><span style="color:#E1E4E8;"> p </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> dp </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">grantee_principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">USER_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">grantee_principal_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&#39;ReadRole&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- 角色名称</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--查询某个角色拥有的权限</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">USER_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">grantee_principal_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> principal_name,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> principal_type_desc,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">class_desc</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">major_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> object_name,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">permission_name</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">state_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> permission_state_desc</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_permissions</span><span style="color:#24292E;"> p </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> dp </span><span style="color:#D73A49;">on</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">grantee_principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">USER_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">grantee_principal_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span><span style="color:#032F62;">&#39;ReadRole&#39;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- 角色名称</span></span></code></pre></div><h3 id="_1-6-8-查看用户被赋予的权限" tabindex="-1">1.6.8 查看用户被赋予的权限 <a class="header-anchor" href="#_1-6-8-查看用户被赋予的权限" aria-label="Permalink to &quot;1.6.8 查看用户被赋予的权限&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- use PointsMall_Manage</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_name</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_helprotect </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;userName&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"># 或者</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_name</span></span>
<span class="line"><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_helprotect @username </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;haojianyu&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- use PointsMall_Manage</span></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_name</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_helprotect </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;userName&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"># 或者</span></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_name</span></span>
<span class="line"><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_helprotect @username </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;haojianyu&#39;</span></span></code></pre></div><h3 id="_1-6-9列出作为数据库级别角色成员" tabindex="-1">1.6.9列出作为数据库级别角色成员 <a class="header-anchor" href="#_1-6-9列出作为数据库级别角色成员" aria-label="Permalink to &quot;1.6.9列出作为数据库级别角色成员&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_name</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">roles</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> RolePrincipalID</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,    </span><span style="color:#79B8FF;">roles</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">                                    </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> RolePrincipalName</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,    </span><span style="color:#79B8FF;">database_role_members</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">member_principal_id</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> MemberPrincipalID</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,    </span><span style="color:#79B8FF;">members</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> MemberPrincipalName</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_role_members</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> database_role_members  </span></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> roles  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">database_role_members</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">role_principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">roles</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> members  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">database_role_members</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">member_principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">members</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_name</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">roles</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;">                            </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> RolePrincipalID</span></span>
<span class="line"><span style="color:#24292E;">    ,    </span><span style="color:#005CC5;">roles</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">                                    </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> RolePrincipalName</span></span>
<span class="line"><span style="color:#24292E;">    ,    </span><span style="color:#005CC5;">database_role_members</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">member_principal_id</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> MemberPrincipalID</span></span>
<span class="line"><span style="color:#24292E;">    ,    </span><span style="color:#005CC5;">members</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">                                </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> MemberPrincipalName</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_role_members</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> database_role_members  </span></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> roles  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">database_role_members</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">role_principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">roles</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> members  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">database_role_members</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">member_principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">members</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="_1-6-9-用户所属数据库角色" tabindex="-1">1.6.9 用户所属数据库角色 <a class="header-anchor" href="#_1-6-9-用户所属数据库角色" aria-label="Permalink to &quot;1.6.9 用户所属数据库角色&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_name</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> DbRole </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">g</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, MemberName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, MemberSID </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sid</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> u, </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> g, </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_role_members</span><span style="color:#E1E4E8;"> m</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">g</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">role_principal_id</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">u</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">member_principal_id</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_name</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> DbRole </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">g</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, MemberName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, MemberSID </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sid</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> u, </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> g, </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_role_members</span><span style="color:#24292E;"> m</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">g</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">role_principal_id</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">u</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">member_principal_id</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span></span></code></pre></div><h3 id="案例" tabindex="-1">案例 <a class="header-anchor" href="#案例" aria-label="Permalink to &quot;案例&quot;">​</a></h3><ul><li>角色</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#6A737D;">--创建一个用户</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LOGIN</span><span style="color:#E1E4E8;"> ReadUser </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PASSWORD</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;123qwe!@#&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">DEFAULT_DATABASE=</span><span style="color:#E1E4E8;">DBTest</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> DBTest</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--创建数据库用户，指定到上面</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">USER</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReadUser</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LOGIN</span><span style="color:#E1E4E8;"> ReadUser </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DEFAULT_SCHEMA</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> dbo</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> DBTest</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#F97583;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">role</span><span style="color:#E1E4E8;"> ReadRole</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 将多张表的权限授予新建的ReadRole</span></span>
<span class="line"><span style="color:#F97583;">grant</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DEPT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> ReadRole</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 将Readuser 加入到ReadRole这个角色中</span></span>
<span class="line"><span style="color:#F97583;">alter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">role</span><span style="color:#E1E4E8;"> ReadRole </span><span style="color:#F97583;">add</span><span style="color:#E1E4E8;"> member ReadUser</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#6A737D;">--创建一个用户</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LOGIN</span><span style="color:#24292E;"> ReadUser </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PASSWORD</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;123qwe!@#&#39;</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">DEFAULT_DATABASE=</span><span style="color:#24292E;">DBTest</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> DBTest</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">--创建数据库用户，指定到上面</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">USER</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReadUser</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LOGIN</span><span style="color:#24292E;"> ReadUser </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DEFAULT_SCHEMA</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> dbo</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> DBTest</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#D73A49;">create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">role</span><span style="color:#24292E;"> ReadRole</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 将多张表的权限授予新建的ReadRole</span></span>
<span class="line"><span style="color:#D73A49;">grant</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DEPT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">to</span><span style="color:#24292E;"> ReadRole</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 将Readuser 加入到ReadRole这个角色中</span></span>
<span class="line"><span style="color:#D73A49;">alter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">role</span><span style="color:#24292E;"> ReadRole </span><span style="color:#D73A49;">add</span><span style="color:#24292E;"> member ReadUser</span></span></code></pre></div><h2 id="_1-7服务器角色" tabindex="-1">1.7服务器角色 <a class="header-anchor" href="#_1-7服务器角色" aria-label="Permalink to &quot;1.7服务器角色&quot;">​</a></h2><p>官方文档，<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/security/authentication-access/server-level-roles?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/relational-databases/security/authentication-access/server-level-roles?view=sql-server-2017</a></p><p>服务器角色的拥有者只有登入名，服务器角色是固定的，用户无法创建服务器角色.</p><blockquote><p>注意：一般不建议给用户直接分配服务器角色，因为服务器角色是全局的，也就是说你拥有了服务器级别的权限，一般建议给用户分配数据库，然后给对应的数据库分配数据库角色权限</p></blockquote><h2 id="_1-7用户grant授权" tabindex="-1">1.7用户grant授权 <a class="header-anchor" href="#_1-7用户grant授权" aria-label="Permalink to &quot;1.7用户grant授权&quot;">​</a></h2><p>官方文档，<a href="https://docs.microsoft.com/zh-cn/sql/t-sql/statements/grant-schema-permissions-transact-sql?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/t-sql/statements/grant-schema-permissions-transact-sql?view=sql-server-2017</a></p><ul><li>语法</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">GRANT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">permission</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> [ ,...n ]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">TO</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">database_principal</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> [ ,...n ] [ WITH GRANT OPTION ]</span></span>
<span class="line"><span style="color:#E1E4E8;">    [ AS &lt;database_principal&gt; ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">permission</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">permission | ALL [ PRIVILEGES ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">database_principal</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> ::</span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">    Database_user</span></span>
<span class="line"><span style="color:#E1E4E8;">  | Database_role</span></span>
<span class="line"><span style="color:#E1E4E8;">  | Application_role</span></span>
<span class="line"><span style="color:#E1E4E8;">  | Database_user_mapped_to_Windows_User</span></span>
<span class="line"><span style="color:#E1E4E8;">  | Database_user_mapped_to_Windows_Group</span></span>
<span class="line"><span style="color:#E1E4E8;">  | Database_user_mapped_to_certificate</span></span>
<span class="line"><span style="color:#E1E4E8;">  | Database_user_mapped_to_asymmetric_key</span></span>
<span class="line"><span style="color:#E1E4E8;">  | Database_user_with_no_login</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">GRANT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">permission</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> [ ,...n ]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">TO</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">database_principal</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> [ ,...n ] [ WITH GRANT OPTION ]</span></span>
<span class="line"><span style="color:#24292E;">    [ AS &lt;database_principal&gt; ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">permission</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">permission | ALL [ PRIVILEGES ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">database_principal</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> ::</span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">    Database_user</span></span>
<span class="line"><span style="color:#24292E;">  | Database_role</span></span>
<span class="line"><span style="color:#24292E;">  | Application_role</span></span>
<span class="line"><span style="color:#24292E;">  | Database_user_mapped_to_Windows_User</span></span>
<span class="line"><span style="color:#24292E;">  | Database_user_mapped_to_Windows_Group</span></span>
<span class="line"><span style="color:#24292E;">  | Database_user_mapped_to_certificate</span></span>
<span class="line"><span style="color:#24292E;">  | Database_user_mapped_to_asymmetric_key</span></span>
<span class="line"><span style="color:#24292E;">  | Database_user_with_no_login</span></span></code></pre></div><p><a href="https://www.cnblogs.com/gered/p/9378937.html#_label0_1" target="_blank" rel="noreferrer">https://www.cnblogs.com/gered/p/9378937.html#_label0_1</a></p><h3 id="_1-7-1-revoke" tabindex="-1">1.7.1 revoke <a class="header-anchor" href="#_1-7-1-revoke" aria-label="Permalink to &quot;1.7.1 revoke&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">USE InsideTSQL2008</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--创建角色 r_test</span></span>
<span class="line"><span style="color:#e1e4e8;">EXEC sp_addrole &#39;r_test&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--添加登录 l_test,设置密码为pwd,默认数据库为pubs</span></span>
<span class="line"><span style="color:#e1e4e8;">EXEC sp_addlogin &#39;l_test&#39;,&#39;a@cd123&#39;,&#39;InsideTSQL2008&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--为登录 l_test 在数据库 pubs 中添加安全账户 u_test</span></span>
<span class="line"><span style="color:#e1e4e8;">EXEC sp_grantdbaccess &#39;l_test&#39;,&#39;u_test&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--添加 u_test 为角色 r_test 的成员</span></span>
<span class="line"><span style="color:#e1e4e8;">EXEC sp_addrolemember &#39;r_test&#39;,&#39;u_test&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--用l_test登陆,发现在SSMS中找不到仍和表，因此执行下述两条语句出错。</span></span>
<span class="line"><span style="color:#e1e4e8;">select * from Sales.Orders</span></span>
<span class="line"><span style="color:#e1e4e8;">select * from HR.Employees</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--授予角色 r_test 对 HR.Employees 表的所有权限</span></span>
<span class="line"><span style="color:#e1e4e8;">GRANT ALL ON HR.Employees TO r_test</span></span>
<span class="line"><span style="color:#e1e4e8;">--The ALL permission is deprecated and maintained only for compatibility. </span></span>
<span class="line"><span style="color:#e1e4e8;">--It DOES NOT imply ALL permissions defined on the entity.</span></span>
<span class="line"><span style="color:#e1e4e8;">--ALL 权限已不再推荐使用，并且只保留用于兼容性目的。它并不表示对实体定义了 ALL 权限。</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--测试可以查询表HR.Employees，但是Sales.Orders无法查询</span></span>
<span class="line"><span style="color:#e1e4e8;">select * from HR.Employees</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--如果要收回权限，可以使用如下语句。（可选择执行）</span></span>
<span class="line"><span style="color:#e1e4e8;">revoke all on HR.Employees from r_test</span></span>
<span class="line"><span style="color:#e1e4e8;">--ALL 权限已不再推荐使用，并且只保留用于兼容性目的。它并不表示对实体定义了 ALL 权限。</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--授予角色 r_test 对 Sales.Orders 表的 SELECT 权限</span></span>
<span class="line"><span style="color:#e1e4e8;">GRANT SELECT ON Sales.Orders TO r_test</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--用l_test登陆,发现可以查询Sales.Orders和HR.Employees两张表</span></span>
<span class="line"><span style="color:#e1e4e8;">select * from Sales.Orders</span></span>
<span class="line"><span style="color:#e1e4e8;">select * from HR.Employees</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--拒绝安全账户 u_test 对 HR.Employees 表的 SELECT 权限</span></span>
<span class="line"><span style="color:#e1e4e8;">DENY SELECT ON HR.Employees TO u_test</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--再次执行查询HR.Employees表的语句，提示：拒绝了对对象 &#39;Employees&#39; (数据库 &#39;InsideTSQL2008&#39;，架构 &#39;HR&#39;)的 SELECT 权限。</span></span>
<span class="line"><span style="color:#e1e4e8;">select * from HR.Employees</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--重新授权</span></span>
<span class="line"><span style="color:#e1e4e8;">GRANT SELECT ON HR.Employees TO u_test</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--再次查询，可以查询出结果。</span></span>
<span class="line"><span style="color:#e1e4e8;">select * from HR.Employees</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">USE InsideTSQL2008</span></span>
<span class="line"><span style="color:#e1e4e8;">--从数据库中删除安全账户,failed</span></span>
<span class="line"><span style="color:#e1e4e8;">EXEC sp_revokedbaccess &#39;u_test&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">--删除角色 r_test,failed</span></span>
<span class="line"><span style="color:#e1e4e8;">EXEC sp_droprole &#39;r_test&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">--删除登录 l_test,success</span></span>
<span class="line"><span style="color:#e1e4e8;">EXEC sp_droplogin &#39;l_test&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">USE InsideTSQL2008</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--创建角色 r_test</span></span>
<span class="line"><span style="color:#24292e;">EXEC sp_addrole &#39;r_test&#39;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--添加登录 l_test,设置密码为pwd,默认数据库为pubs</span></span>
<span class="line"><span style="color:#24292e;">EXEC sp_addlogin &#39;l_test&#39;,&#39;a@cd123&#39;,&#39;InsideTSQL2008&#39;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--为登录 l_test 在数据库 pubs 中添加安全账户 u_test</span></span>
<span class="line"><span style="color:#24292e;">EXEC sp_grantdbaccess &#39;l_test&#39;,&#39;u_test&#39;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--添加 u_test 为角色 r_test 的成员</span></span>
<span class="line"><span style="color:#24292e;">EXEC sp_addrolemember &#39;r_test&#39;,&#39;u_test&#39;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--用l_test登陆,发现在SSMS中找不到仍和表，因此执行下述两条语句出错。</span></span>
<span class="line"><span style="color:#24292e;">select * from Sales.Orders</span></span>
<span class="line"><span style="color:#24292e;">select * from HR.Employees</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--授予角色 r_test 对 HR.Employees 表的所有权限</span></span>
<span class="line"><span style="color:#24292e;">GRANT ALL ON HR.Employees TO r_test</span></span>
<span class="line"><span style="color:#24292e;">--The ALL permission is deprecated and maintained only for compatibility. </span></span>
<span class="line"><span style="color:#24292e;">--It DOES NOT imply ALL permissions defined on the entity.</span></span>
<span class="line"><span style="color:#24292e;">--ALL 权限已不再推荐使用，并且只保留用于兼容性目的。它并不表示对实体定义了 ALL 权限。</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--测试可以查询表HR.Employees，但是Sales.Orders无法查询</span></span>
<span class="line"><span style="color:#24292e;">select * from HR.Employees</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--如果要收回权限，可以使用如下语句。（可选择执行）</span></span>
<span class="line"><span style="color:#24292e;">revoke all on HR.Employees from r_test</span></span>
<span class="line"><span style="color:#24292e;">--ALL 权限已不再推荐使用，并且只保留用于兼容性目的。它并不表示对实体定义了 ALL 权限。</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--授予角色 r_test 对 Sales.Orders 表的 SELECT 权限</span></span>
<span class="line"><span style="color:#24292e;">GRANT SELECT ON Sales.Orders TO r_test</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--用l_test登陆,发现可以查询Sales.Orders和HR.Employees两张表</span></span>
<span class="line"><span style="color:#24292e;">select * from Sales.Orders</span></span>
<span class="line"><span style="color:#24292e;">select * from HR.Employees</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--拒绝安全账户 u_test 对 HR.Employees 表的 SELECT 权限</span></span>
<span class="line"><span style="color:#24292e;">DENY SELECT ON HR.Employees TO u_test</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--再次执行查询HR.Employees表的语句，提示：拒绝了对对象 &#39;Employees&#39; (数据库 &#39;InsideTSQL2008&#39;，架构 &#39;HR&#39;)的 SELECT 权限。</span></span>
<span class="line"><span style="color:#24292e;">select * from HR.Employees</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--重新授权</span></span>
<span class="line"><span style="color:#24292e;">GRANT SELECT ON HR.Employees TO u_test</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--再次查询，可以查询出结果。</span></span>
<span class="line"><span style="color:#24292e;">select * from HR.Employees</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">USE InsideTSQL2008</span></span>
<span class="line"><span style="color:#24292e;">--从数据库中删除安全账户,failed</span></span>
<span class="line"><span style="color:#24292e;">EXEC sp_revokedbaccess &#39;u_test&#39;</span></span>
<span class="line"><span style="color:#24292e;">--删除角色 r_test,failed</span></span>
<span class="line"><span style="color:#24292e;">EXEC sp_droprole &#39;r_test&#39;</span></span>
<span class="line"><span style="color:#24292e;">--删除登录 l_test,success</span></span>
<span class="line"><span style="color:#24292e;">EXEC sp_droplogin &#39;l_test&#39;</span></span></code></pre></div><h3 id="_1-7-2-deny" tabindex="-1">1.7.2 deny <a class="header-anchor" href="#_1-7-2-deny" aria-label="Permalink to &quot;1.7.2 deny&quot;">​</a></h3><h2 id="_1-8存储创建角色" tabindex="-1">1.8存储创建角色 <a class="header-anchor" href="#_1-8存储创建角色" aria-label="Permalink to &quot;1.8存储创建角色&quot;">​</a></h2><p>sp_addlogin 登录名，登陆密码，默认数据库，默认语言，安全码，是否加密</p><p>sp_password 旧密码，新密码，指定登录号</p><p>sp_defaultdb 指定登录号，默认数据库</p><p>sp_defaultlanguage 指定登录号，默认语言</p><p>sp_helplogins 指定登录号</p><p>sp_droplogin 指定登录号</p><p>-------------------------数据库用户管理--- sp_grantdbaccess 登录号，数据库用户名</p><p>sp_helpuser 数据库用户名</p><p>sp_revokedbaccess 指定数据库用户名</p><p>------------------------服务器角色-------- sp_addsrvrolermemeber 登陆账号名，服务器角色名</p><p>sp_dropsrvrolermember 登陆用户名，服务器角色名</p><p>------------------------数据库角色---------</p><p>sp_addrole 数据库角色名，数据库角色的所有者</p><p>sp_droprole 数据库角色名</p><p>------------创建数据库角色的成员----</p><p>sp_addrolemember 数据库角色名，数据库用户</p><p>sp_droprolemember 数据库角色名，数据库用户</p><h3 id="_1-8-1创建角色" tabindex="-1">1.8.1创建角色 <a class="header-anchor" href="#_1-8-1创建角色" aria-label="Permalink to &quot;1.8.1创建角色&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--创建一个类似于db_datareader的角色,数据库会存在数据库架构sys.schemas中</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_addrole </span><span style="color:#9ECBFF;">&quot;[db_selectUpdate]&quot;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--给该角色赋予查询和修改的权限</span></span>
<span class="line"><span style="color:#F97583;">GRANT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">UPDATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TO</span><span style="color:#E1E4E8;"> [db_selectUpdate] </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--给新建的数据库用户分配刚才赋予的权限【之后想只给查看和修改权限的就用新建的就可以了】</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_addrolemember </span><span style="color:#9ECBFF;">&quot;[db_selectUpdate]&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;[DatabaseUserName]&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--创建一个类似于db_datareader的角色,数据库会存在数据库架构sys.schemas中</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_addrole </span><span style="color:#032F62;">&quot;[db_selectUpdate]&quot;</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--给该角色赋予查询和修改的权限</span></span>
<span class="line"><span style="color:#D73A49;">GRANT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">UPDATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TO</span><span style="color:#24292E;"> [db_selectUpdate] </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--给新建的数据库用户分配刚才赋予的权限【之后想只给查看和修改权限的就用新建的就可以了】</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_addrolemember </span><span style="color:#032F62;">&quot;[db_selectUpdate]&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;[DatabaseUserName]&quot;</span></span></code></pre></div><h3 id="_1-8-2删除角色" tabindex="-1">1.8.2删除角色 <a class="header-anchor" href="#_1-8-2删除角色" aria-label="Permalink to &quot;1.8.2删除角色&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--删除角色 r_test,failed</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> data_name</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_droprole </span><span style="color:#9ECBFF;">&#39;role_name&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--删除登录 l_test,success</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_droplogin </span><span style="color:#9ECBFF;">&#39;login_name&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--删除角色 r_test,failed</span></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> data_name</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_droprole </span><span style="color:#032F62;">&#39;role_name&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--删除登录 l_test,success</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_droplogin </span><span style="color:#032F62;">&#39;login_name&#39;</span></span></code></pre></div><h1 id="完整案例" tabindex="-1">完整案例 <a class="header-anchor" href="#完整案例" aria-label="Permalink to &quot;完整案例&quot;">​</a></h1><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- create user 完整案例</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">login</span><span style="color:#E1E4E8;"> dba </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">password</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;340$Uuxwp7Mcxo7Khy&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">default_database=</span><span style="color:#E1E4E8;"> PointsMall_Manage</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> PointsMall_Organization</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> USER [dba] </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">login</span><span style="color:#E1E4E8;"> [haojianyu] </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">default_schema</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> dbo</span></span>
<span class="line"><span style="color:#6A737D;">-- 上面两步只能登陆和看到数据库，表并不能看到</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> PointsMall_Manage</span></span>
<span class="line"><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_addrolemember </span><span style="color:#9ECBFF;">&#39;db_owner&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;dba&#39;</span></span>
<span class="line"><span style="color:#6A737D;">-- </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#如果是多个数据库</span></span>
<span class="line"><span style="color:#6A737D;">-- 让 SQL Server 登陆帐户“dba”访问多个数据库</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> mydb2</span></span>
<span class="line"><span style="color:#F97583;">go</span></span>
<span class="line"><span style="color:#F97583;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">user</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">dba</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">login</span><span style="color:#E1E4E8;"> dba </span><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">default_schema=</span><span style="color:#E1E4E8;">dbo</span></span>
<span class="line"><span style="color:#F97583;">go</span></span>
<span class="line"><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_addrolemember </span><span style="color:#9ECBFF;">&#39;db_owner&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;dba&#39;</span></span>
<span class="line"><span style="color:#F97583;">go</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查询用户权限</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">USER_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">grantee_principal_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> principal_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">grantee_principal_id</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> principal_type_desc,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">class_desc</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">major_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> object_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">permission_name</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">state_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> permission_state_desc</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_permissions</span><span style="color:#E1E4E8;"> p </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_principals</span><span style="color:#E1E4E8;"> dp </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">grantee_principal_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">dp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">principal_id</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">USER_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">grantee_principal_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;haojianyu&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- create user 完整案例</span></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">login</span><span style="color:#24292E;"> dba </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">password</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;340$Uuxwp7Mcxo7Khy&#39;</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">default_database=</span><span style="color:#24292E;"> PointsMall_Manage</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> PointsMall_Organization</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> USER [dba] </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">login</span><span style="color:#24292E;"> [haojianyu] </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">default_schema</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> dbo</span></span>
<span class="line"><span style="color:#6A737D;">-- 上面两步只能登陆和看到数据库，表并不能看到</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> PointsMall_Manage</span></span>
<span class="line"><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_addrolemember </span><span style="color:#032F62;">&#39;db_owner&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;dba&#39;</span></span>
<span class="line"><span style="color:#6A737D;">-- </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#如果是多个数据库</span></span>
<span class="line"><span style="color:#6A737D;">-- 让 SQL Server 登陆帐户“dba”访问多个数据库</span></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> mydb2</span></span>
<span class="line"><span style="color:#D73A49;">go</span></span>
<span class="line"><span style="color:#D73A49;">create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">user</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">dba</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">login</span><span style="color:#24292E;"> dba </span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">default_schema=</span><span style="color:#24292E;">dbo</span></span>
<span class="line"><span style="color:#D73A49;">go</span></span>
<span class="line"><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_addrolemember </span><span style="color:#032F62;">&#39;db_owner&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;dba&#39;</span></span>
<span class="line"><span style="color:#D73A49;">go</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查询用户权限</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">USER_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">grantee_principal_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> principal_name,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">grantee_principal_id</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> principal_type_desc,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">class_desc</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">major_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> object_name,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">permission_name</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">state_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> permission_state_desc</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_permissions</span><span style="color:#24292E;"> p </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_principals</span><span style="color:#24292E;"> dp </span><span style="color:#D73A49;">on</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">grantee_principal_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">dp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">principal_id</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">USER_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">grantee_principal_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;haojianyu&#39;</span></span></code></pre></div><h2 id="权限传递" tabindex="-1">权限传递 <a class="header-anchor" href="#权限传递" aria-label="Permalink to &quot;权限传递&quot;">​</a></h2><p>用sa（SQL Server管理猿帐号）创建UserA, UserB。然后把SELECT News表的授权给UserA，再让UserA授权给UserB，最后回收UserA的权限，看看UserB还有木有权限</p><p>首先，创建用户的脚本如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">-- Create a SQL Server login named UserA, and then creates a corresponding database user UserA in TestDb.</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE LOGIN UserA WITH PASSWORD = &#39;aaa@123&#39;;</span></span>
<span class="line"><span style="color:#e1e4e8;">USE TestDb;</span></span>
<span class="line"><span style="color:#e1e4e8;">GO</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE USER UserA FOR LOGIN UserA;</span></span>
<span class="line"><span style="color:#e1e4e8;">GO</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">-- do the same for UserB</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE LOGIN UserB WITH PASSWORD = &#39;bbb@123&#39;;</span></span>
<span class="line"><span style="color:#e1e4e8;">USE TestDb;</span></span>
<span class="line"><span style="color:#e1e4e8;">GO</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE USER UserB FOR LOGIN UserB;</span></span>
<span class="line"><span style="color:#e1e4e8;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">-- Create a SQL Server login named UserA, and then creates a corresponding database user UserA in TestDb.</span></span>
<span class="line"><span style="color:#24292e;">CREATE LOGIN UserA WITH PASSWORD = &#39;aaa@123&#39;;</span></span>
<span class="line"><span style="color:#24292e;">USE TestDb;</span></span>
<span class="line"><span style="color:#24292e;">GO</span></span>
<span class="line"><span style="color:#24292e;">CREATE USER UserA FOR LOGIN UserA;</span></span>
<span class="line"><span style="color:#24292e;">GO</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">-- do the same for UserB</span></span>
<span class="line"><span style="color:#24292e;">CREATE LOGIN UserB WITH PASSWORD = &#39;bbb@123&#39;;</span></span>
<span class="line"><span style="color:#24292e;">USE TestDb;</span></span>
<span class="line"><span style="color:#24292e;">GO</span></span>
<span class="line"><span style="color:#24292e;">CREATE USER UserB FOR LOGIN UserB;</span></span>
<span class="line"><span style="color:#24292e;">GO</span></span></code></pre></div><p>然后，我要给UserA授权，不然UserA登录数据库的时候，是看不见任何表的，也不能SELECT</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">GRANT SELECT ON TestDb.dbo.News TO UserA</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">GRANT SELECT ON TestDb.dbo.News TO UserA WITH GRANT OPTION</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">GRANT SELECT ON TestDb.dbo.News TO UserA</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">GRANT SELECT ON TestDb.dbo.News TO UserA WITH GRANT OPTION</span></span></code></pre></div><p>在回收传递的权限时，必须在REVOKE语句的最后加上CASCADE：</p><div class="language-vbnet vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">vbnet</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">-- do revoke</span></span>
<span class="line"><span style="color:#e1e4e8;">REVOKE SELECT ON TestDb.dbo.News TO UserA CASCADE</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">-- do revoke</span></span>
<span class="line"><span style="color:#24292e;">REVOKE SELECT ON TestDb.dbo.News TO UserA CASCADE</span></span></code></pre></div><hr><p><a href="https://blog.csdn.net/xiaochao2011111167/article/details/87272038" target="_blank" rel="noreferrer">https://blog.csdn.net/xiaochao2011111167/article/details/87272038</a></p><p><a href="https://www.yiibai.com/sqlserver/what-is-sql-server.html" target="_blank" rel="noreferrer">https://www.yiibai.com/sqlserver/what-is-sql-server.html</a></p><p><a href="https://blog.csdn.net/weixin_45816550/article/details/109347333" target="_blank" rel="noreferrer">https://blog.csdn.net/weixin_45816550/article/details/109347333</a></p><p><a href="https://blog.csdn.net/qq_38950819/article/details/121269948" target="_blank" rel="noreferrer">https://blog.csdn.net/qq_38950819/article/details/121269948</a></p><p><a href="https://blog.csdn.net/zhoujunah/article/details/104396000" target="_blank" rel="noreferrer">https://blog.csdn.net/zhoujunah/article/details/104396000</a></p><p><a href="https://blog.csdn.net/qq_43974000/article/details/105309576" target="_blank" rel="noreferrer">https://blog.csdn.net/qq_43974000/article/details/105309576</a></p><p><a href="https://www.cnblogs.com/programsky/archive/2018/07/05/9268823.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/programsky/archive/2018/07/05/9268823.html</a></p><p><a href="https://www.cnblogs.com/zhy-1992/p/6743511.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/zhy-1992/p/6743511.html</a></p><p><a href="https://docs.microsoft.com/zh-cn/sql/t-sql/statements/alter-role-transact-sql?view=sql-server-ver15" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/t-sql/statements/alter-role-transact-sql?view=sql-server-ver15</a></p><p><a href="https://docs.microsoft.com/zh-cn/sql/t-sql/statements/grant-schema-permissions-transact-sql?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/t-sql/statements/grant-schema-permissions-transact-sql?view=sql-server-2017</a></p><p><a href="https://www.cnblogs.com/jennyjiang-00/p/5803047.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/jennyjiang-00/p/5803047.html</a></p><p><a href="https://www.cnblogs.com/txdblog/p/15222291.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/txdblog/p/15222291.html</a></p><p><a href="https://developer.aliyun.com/article/15905" target="_blank" rel="noreferrer">https://developer.aliyun.com/article/15905</a></p><p><a href="https://www.cnblogs.com/bandaobudaoweng/p/9958126.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/bandaobudaoweng/p/9958126.html</a></p><p><a href="https://www.cnblogs.com/willingtolove/p/9122738.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/willingtolove/p/9122738.html</a></p><p><a href="https://blog.51cto.com/abnerluo/1320530" target="_blank" rel="noreferrer">https://blog.51cto.com/abnerluo/1320530</a></p><p><a href="https://www.jc2182.com/sqlserver/sql-server-architecture.html" target="_blank" rel="noreferrer">https://www.jc2182.com/sqlserver/sql-server-architecture.html</a></p><p><a href="https://www.cnblogs.com/wy123/category/834336.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/wy123/category/834336.html</a></p><p><a href="https://www.cnblogs.com/vuenote/category/1266651.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/vuenote/category/1266651.html</a></p><hr><p><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/security/authentication-access/getting-started-with-database-engine-permissions?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/relational-databases/security/authentication-access/getting-started-with-database-engine-permissions?view=sql-server-2017</a></p><p><a href="https://www.yht7.com/news/1867" target="_blank" rel="noreferrer">https://www.yht7.com/news/1867</a></p><h1 id="_2-图形界面创建" tabindex="-1">2.图形界面创建 <a class="header-anchor" href="#_2-图形界面创建" aria-label="Permalink to &quot;2.图形界面创建&quot;">​</a></h1>`,243),e=[o];function c(t,r,E,y,i,d){return a(),n("div",null,e)}const _=s(p,[["render",c]]);export{C as __pageData,_ as default};
