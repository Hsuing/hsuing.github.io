import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const F=JSON.parse('{"title":"1. etcd_exporter","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Linux/Monitor/Prometheus/monitor_project/4-etcd.md","filePath":"guide/Linux/Monitor/Prometheus/monitor_project/4-etcd.md","lastUpdated":1731579751000}'),p={name:"guide/Linux/Monitor/Prometheus/monitor_project/4-etcd.md"},o=l(`<h1 id="_1-etcd-exporter" tabindex="-1">1. etcd_exporter <a class="header-anchor" href="#_1-etcd-exporter" aria-label="Permalink to &quot;1. etcd_exporter&quot;">​</a></h1><p><a href="https://etcd.io/docs/v3.5/metrics/" target="_blank" rel="noreferrer">官当</a></p><h2 id="_1-1-介绍" tabindex="-1">1.1 介绍 <a class="header-anchor" href="#_1-1-介绍" aria-label="Permalink to &quot;1.1 介绍&quot;">​</a></h2><p><code>etcd</code>内置了<code>metrics</code>接口供收集数据，在<code>etcd</code>集群任意一台节点上可通过<code>ip:2379/metrics</code>检查是否能正常收集数据</p><h2 id="_1-2-部署" tabindex="-1">1.2 部署 <a class="header-anchor" href="#_1-2-部署" aria-label="Permalink to &quot;1.2 部署&quot;">​</a></h2><p>由于内置了mtrics，安装省略</p><h3 id="_1-访问" tabindex="-1">1.访问 <a class="header-anchor" href="#_1-访问" aria-label="Permalink to &quot;1.访问&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#无证书情况下</span></span>
<span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-L</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://localhost:2379/metrics</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#无证书情况下</span></span>
<span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-L</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://localhost:2379/metrics</span></span></code></pre></div><ul><li>有证书情况</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--cacert</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/etcd/ssl/etcd-ca.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--cert</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/etcd/ssl/etcd.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/etcd/ssl/etcd-key.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-k</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://10.103.236.150:2379/metrics</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">curl</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">--cacert</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/etcd/ssl/etcd-ca.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--cert</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/etcd/ssl/etcd.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/etcd/ssl/etcd-key.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-k</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://10.103.236.150:2379/metrics</span></span></code></pre></div><h2 id="_1-3-prometheus采集" tabindex="-1">1.3 Prometheus采集 <a class="header-anchor" href="#_1-3-prometheus采集" aria-label="Permalink to &quot;1.3 Prometheus采集&quot;">​</a></h2><div class="warning custom-block"><p class="custom-block-title">💡 说明</p><p><strong>外置etcd</strong></p></div><h3 id="_1-tls" tabindex="-1">1.tls <a class="header-anchor" href="#_1-tls" aria-label="Permalink to &quot;1.tls&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scheme</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">https</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">tls_config</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ca_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/etcd/ssl/etcd-ca.pem</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">cert_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/etcd/ssl/etcd.pem</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">key_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/etcd/ssl/etcd-key.pem</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">: [ </span><span style="color:#9ECBFF;">&#39;10.103.236.150:2379&#39;</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">: [ </span><span style="color:#9ECBFF;">&#39;10.103.236.151:2379&#39;</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">: [ </span><span style="color:#9ECBFF;">&#39;10.103.236.152:2379&#39;</span><span style="color:#E1E4E8;"> ]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/metrics</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scheme</span><span style="color:#24292E;">: </span><span style="color:#032F62;">https</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">tls_config</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ca_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/etcd/ssl/etcd-ca.pem</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">cert_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/etcd/ssl/etcd.pem</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">key_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/etcd/ssl/etcd-key.pem</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">: [ </span><span style="color:#032F62;">&#39;10.103.236.150:2379&#39;</span><span style="color:#24292E;"> ]</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">: [ </span><span style="color:#032F62;">&#39;10.103.236.151:2379&#39;</span><span style="color:#24292E;"> ]</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">: [ </span><span style="color:#032F62;">&#39;10.103.236.152:2379&#39;</span><span style="color:#24292E;"> ]</span></span></code></pre></div><ul><li>热更新</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">curl -X POST http://127.0.0.1:9090/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">curl -X POST http://127.0.0.1:9090/-/reload</span></span></code></pre></div><h3 id="_2-insecure-tls" tabindex="-1">2.insecure_tls <a class="header-anchor" href="#_2-insecure-tls" aria-label="Permalink to &quot;2.insecure_tls&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;etcd&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scheme</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">https</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">tls_config</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">insecure_skip_verify</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;10.103.236.150:2379&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;10.103.236.151:2379&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;10.103.236.152:2379&#39;</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;etcd&quot;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scheme</span><span style="color:#24292E;">: </span><span style="color:#032F62;">https</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">tls_config</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">insecure_skip_verify</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;10.103.236.150:2379&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;10.103.236.151:2379&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;10.103.236.152:2379&#39;</span><span style="color:#24292E;">]</span></span></code></pre></div><h3 id="_3-k8s" tabindex="-1">3.k8s <a class="header-anchor" href="#_3-k8s" aria-label="Permalink to &quot;3.k8s&quot;">​</a></h3><div class="warning custom-block"><p class="custom-block-title">💡 说明</p><p><strong>外置etcd</strong></p></div><h4 id="_1-代理-推荐" tabindex="-1">1.代理-推荐 <a class="header-anchor" href="#_1-代理-推荐" aria-label="Permalink to &quot;1.代理-推荐&quot;">​</a></h4><h5 id="_1-创建代理" tabindex="-1">1.创建代理 <a class="header-anchor" href="#_1-创建代理" aria-label="Permalink to &quot;1.创建代理&quot;">​</a></h5><p>对于外置的 etcd 集群，或者以静态 pod 方式启动的 etcd 集群，都不会在 k8s 里创建 service，而 Prometheus 需要根据 service + endpoint 来抓取，因此需要手动创建</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">cat &gt; etcd-svc-ep.yaml &lt;&lt; EOF</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd-k8s</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd</span><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">## Kubernetes 会根据该标签和 Endpoints 资源关联</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app.kubernetes.io/name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">## Prometheus 会根据该标签服务发现到该服务</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterIP</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">clusterIP</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">None</span><span style="color:#E1E4E8;">               </span><span style="color:#6A737D;">## 设置为 None,不分配 Service IP</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">port</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2379</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Endpoints</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd-k8s</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd</span></span>
<span class="line"><span style="color:#85E89D;">subsets</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">addresses</span><span style="color:#E1E4E8;">:                      </span><span style="color:#6A737D;">## 代理的应用IP地址列表</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">ip</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10.103.236.150</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">ip</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10.103.236.151</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">ip</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10.103.236.152</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2379</span><span style="color:#E1E4E8;">                    </span><span style="color:#6A737D;">## 代理的应用端口号</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">cat &gt; etcd-svc-ep.yaml &lt;&lt; EOF</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd-k8s</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd</span><span style="color:#24292E;">                </span><span style="color:#6A737D;">## Kubernetes 会根据该标签和 Endpoints 资源关联</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app.kubernetes.io/name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">## Prometheus 会根据该标签服务发现到该服务</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">clusterIP</span><span style="color:#24292E;">: </span><span style="color:#032F62;">None</span><span style="color:#24292E;">               </span><span style="color:#6A737D;">## 设置为 None,不分配 Service IP</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">port</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2379</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Endpoints</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd-k8s</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd</span></span>
<span class="line"><span style="color:#22863A;">subsets</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">addresses</span><span style="color:#24292E;">:                      </span><span style="color:#6A737D;">## 代理的应用IP地址列表</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">ip</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10.103.236.150</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">ip</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10.103.236.151</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">ip</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10.103.236.152</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2379</span><span style="color:#24292E;">                    </span><span style="color:#6A737D;">## 代理的应用端口号</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd-svc-ep.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;">  </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd-svc-ep.yaml</span></span></code></pre></div><h5 id="_2-创建-secret-存储证书" tabindex="-1">2.创建 secret 存储证书 <a class="header-anchor" href="#_2-创建-secret-存储证书" aria-label="Permalink to &quot;2.创建 secret 存储证书&quot;">​</a></h5><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">monitor</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">secret</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">generic</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd-ssl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--from-file=/etc/etcd/ssl/etcd-ca.pem</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--from-file=/etc/etcd/ssl/etcd.pem</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--from-file=/etc/etcd/ssl/etcd-key.pem</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">monitor</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">secret</span><span style="color:#24292E;"> </span><span style="color:#032F62;">generic</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd-ssl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--from-file=/etc/etcd/ssl/etcd-ca.pem</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">--from-file=/etc/etcd/ssl/etcd.pem</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">--from-file=/etc/etcd/ssl/etcd-key.pem</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">secret</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-nmonitor</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">DATA</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">etcd-ssl</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Opaque</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">77</span><span style="color:#9ECBFF;">s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">secret</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">-nmonitor</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">       </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">     </span><span style="color:#032F62;">DATA</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">etcd-ssl</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Opaque</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">77</span><span style="color:#032F62;">s</span></span></code></pre></div><h5 id="_3-修改prometheus配置" tabindex="-1">3.修改prometheus配置 <a class="header-anchor" href="#_3-修改prometheus配置" aria-label="Permalink to &quot;3.修改prometheus配置&quot;">​</a></h5><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">certs</span><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">#### 将ETCD证书的ConfigMap挂进Prometheus容器</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/certs</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">readOnly</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">certs</span><span style="color:#E1E4E8;">               </span><span style="color:#6A737D;">#### 将ETCD证书的ConfigMap挂进Prometheus容器</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">secret</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">secretName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd-ssl</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">certs</span><span style="color:#24292E;">            </span><span style="color:#6A737D;">#### 将ETCD证书的ConfigMap挂进Prometheus容器</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/certs</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">readOnly</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">certs</span><span style="color:#24292E;">               </span><span style="color:#6A737D;">#### 将ETCD证书的ConfigMap挂进Prometheus容器</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">secret</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">secretName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd-ssl</span></span></code></pre></div><h5 id="_4-配置采集" tabindex="-1">4.配置采集 <a class="header-anchor" href="#_4-配置采集" aria-label="Permalink to &quot;4.配置采集&quot;">​</a></h5><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">###################### kubernetes-etcd ######################</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;kubernetes-etcd&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">scheme</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">https</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tls_config</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">## 配置 ETCD 证书所在路径(Prometheus 容器内的文件路径)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">ca_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/certs/etcd-ca.pem</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">cert_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/certs/etcd.pem</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">key_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/certs/etcd-key.pem</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">insecure_skip_verify</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">## 配置服务发现机制,指定 ETCD Service 所在的Namespace名称</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">endpoints</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">namespaces</span><span style="color:#E1E4E8;">:               </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">names</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;monitor&quot;</span><span style="color:#E1E4E8;">]         </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">## 指定从 app.kubernetes.io/name 标签等于 etcd 的 service 服务获取指标信息</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_label_app_kubernetes_io_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">###################### kubernetes-etcd ######################</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;kubernetes-etcd&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">scheme</span><span style="color:#24292E;">: </span><span style="color:#032F62;">https</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tls_config</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">## 配置 ETCD 证书所在路径(Prometheus 容器内的文件路径)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">ca_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/certs/etcd-ca.pem</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">cert_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/certs/etcd.pem</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">key_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/certs/etcd-key.pem</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">insecure_skip_verify</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">## 配置服务发现机制,指定 ETCD Service 所在的Namespace名称</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">endpoints</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">namespaces</span><span style="color:#24292E;">:               </span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">names</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;monitor&quot;</span><span style="color:#24292E;">]         </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">## 指定从 app.kubernetes.io/name 标签等于 etcd 的 service 服务获取指标信息</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_label_app_kubernetes_io_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd</span></span></code></pre></div><ul><li>更新服务</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span><span style="color:#9ECBFF;">.prometheus-deploy.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">.prometheus-deploy.yaml</span></span></code></pre></div><ul><li>热更新</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-XPOST</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-XPOST</span><span style="color:#24292E;">  </span><span style="color:#032F62;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre></div><ul><li>效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202411132248135.png" alt="image-20241113224827472"></p><h4 id="_2-非代理" tabindex="-1">2.非代理 <a class="header-anchor" href="#_2-非代理" aria-label="Permalink to &quot;2.非代理&quot;">​</a></h4><h5 id="_1-配置采集" tabindex="-1">1.配置采集 <a class="header-anchor" href="#_1-配置采集" aria-label="Permalink to &quot;1.配置采集&quot;">​</a></h5><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd_external</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scheme</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">https</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">tls_config</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ca_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/certs/etcd-ca.pem</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">cert_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/certs/etcd.pem</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">key_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/certs/etcd-key.pem</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">insecure_skip_verify</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">: [ </span><span style="color:#9ECBFF;">&#39;10.103.236.150:2379&#39;</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">: [ </span><span style="color:#9ECBFF;">&#39;10.103.236.151:2379&#39;</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">: [ </span><span style="color:#9ECBFF;">&#39;10.103.236.152:2379&#39;</span><span style="color:#E1E4E8;"> ]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd_external</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/metrics</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scheme</span><span style="color:#24292E;">: </span><span style="color:#032F62;">https</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">tls_config</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ca_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/certs/etcd-ca.pem</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">cert_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/certs/etcd.pem</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">key_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/certs/etcd-key.pem</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">insecure_skip_verify</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">: [ </span><span style="color:#032F62;">&#39;10.103.236.150:2379&#39;</span><span style="color:#24292E;"> ]</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">: [ </span><span style="color:#032F62;">&#39;10.103.236.151:2379&#39;</span><span style="color:#24292E;"> ]</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">: [ </span><span style="color:#032F62;">&#39;10.103.236.152:2379&#39;</span><span style="color:#24292E;"> ]</span></span></code></pre></div><h5 id="_2-创建-secret-存储证书-1" tabindex="-1">2.创建 secret 存储证书 <a class="header-anchor" href="#_2-创建-secret-存储证书-1" aria-label="Permalink to &quot;2.创建 secret 存储证书&quot;">​</a></h5><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">monitor</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">secret</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">generic</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd-ssl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--from-file=/etc/etcd/ssl/etcd-ca.pem</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--from-file=/etc/etcd/ssl/etcd.pem</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--from-file=/etc/etcd/ssl/etcd-key.pem</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">monitor</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">secret</span><span style="color:#24292E;"> </span><span style="color:#032F62;">generic</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd-ssl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--from-file=/etc/etcd/ssl/etcd-ca.pem</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">--from-file=/etc/etcd/ssl/etcd.pem</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">--from-file=/etc/etcd/ssl/etcd-key.pem</span></span></code></pre></div><h5 id="_3-修改prometheus配置-1" tabindex="-1">3.修改prometheus配置 <a class="header-anchor" href="#_3-修改prometheus配置-1" aria-label="Permalink to &quot;3.修改prometheus配置&quot;">​</a></h5><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">certs</span><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">#### 将ETCD证书的ConfigMap挂进Prometheus容器</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/certs</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">readOnly</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">certs</span><span style="color:#E1E4E8;">               </span><span style="color:#6A737D;">#### 将ETCD证书的ConfigMap挂进Prometheus容器</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">secret</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">secretName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd-ssl</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">certs</span><span style="color:#24292E;">            </span><span style="color:#6A737D;">#### 将ETCD证书的ConfigMap挂进Prometheus容器</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/certs</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">readOnly</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">certs</span><span style="color:#24292E;">               </span><span style="color:#6A737D;">#### 将ETCD证书的ConfigMap挂进Prometheus容器</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">secret</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">secretName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd-ssl</span></span></code></pre></div><ul><li>更新服务</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span><span style="color:#9ECBFF;">.prometheus-deploy.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">.prometheus-deploy.yaml</span></span></code></pre></div><ul><li>热更新</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-XPOST</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-XPOST</span><span style="color:#24292E;">  </span><span style="color:#032F62;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre></div><ul><li>效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202411132226812.png" alt="image-20241113222632658"></p><h3 id="_4-报警规则" tabindex="-1">4. 报警规则 <a class="header-anchor" href="#_4-报警规则" aria-label="Permalink to &quot;4. 报警规则&quot;">​</a></h3><p>官方规则<a href="https://github.com/etcd-io/etcd/blob/v3.4.9/Documentation/op-guide/etcd3_alert.rules.yml" target="_blank" rel="noreferrer">etcd3_alert.rules.yml</a></p><p>监视指标,例如etcd_debugging_mvcc_db_total_size_in_bytes,etcd_debugging_mvcc_keys_total和etcd_debugging_store_expires_total</p><h4 id="_1-规则" tabindex="-1">1.规则 <a class="header-anchor" href="#_1-规则" aria-label="Permalink to &quot;1.规则&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"># 当前存活的 etcd 节点数是否小于 (n+1)/2</span></span>
<span class="line"><span style="color:#e1e4e8;">sum(up{job=~&quot;.\\*etcd.\\*&quot;} == bool 1) by (job) &lt; ((count(up{job=~&quot;.\\*etcd.\\*&quot;}) by (job) + 1) / 2)</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># etcd 是否存在 leader，为 0 则表示不存在 leader，表示集群不可用</span></span>
<span class="line"><span style="color:#e1e4e8;">etcd_server_has_leader{job=~&quot;.\\*etcd.\\*&quot;} == 0</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># 15 分钟 内集群 leader 切换次数是否超过 3 次</span></span>
<span class="line"><span style="color:#e1e4e8;">rate(etcd_server_leader_changes_seen_total{job=~&quot;.\\*etcd.\\*&quot;}[15m]) &gt; 3</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># 5 分钟内 WAL fsync 调用延迟 p99 大于 500ms</span></span>
<span class="line"><span style="color:#e1e4e8;">histogram_quantile(0.99, rate(etcd_disk_wal_fsync_duration_seconds_bucket{job=~&quot;.\\*etcd.\\*&quot;}[5m])) &gt; 0.5</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># 5 分钟内 DB fsync 调用延迟 p99 大于 500ms</span></span>
<span class="line"><span style="color:#e1e4e8;">histogram_quantile(0.99, rate(etcd_disk_backend_commit_duration_seconds_bucket{job=~&quot;.\\*etcd.\\*&quot;}[5m])) &gt; 0.25</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># 5 分钟内 节点之间 RTT 大于 500 ms</span></span>
<span class="line"><span style="color:#e1e4e8;">histogram_quantile(0.99,rate(etcd_network_peer_round_trip_time_seconds_bucket[5m])) &gt; 0.5</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"># 当前存活的 etcd 节点数是否小于 (n+1)/2</span></span>
<span class="line"><span style="color:#24292e;">sum(up{job=~&quot;.\\*etcd.\\*&quot;} == bool 1) by (job) &lt; ((count(up{job=~&quot;.\\*etcd.\\*&quot;}) by (job) + 1) / 2)</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># etcd 是否存在 leader，为 0 则表示不存在 leader，表示集群不可用</span></span>
<span class="line"><span style="color:#24292e;">etcd_server_has_leader{job=~&quot;.\\*etcd.\\*&quot;} == 0</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># 15 分钟 内集群 leader 切换次数是否超过 3 次</span></span>
<span class="line"><span style="color:#24292e;">rate(etcd_server_leader_changes_seen_total{job=~&quot;.\\*etcd.\\*&quot;}[15m]) &gt; 3</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># 5 分钟内 WAL fsync 调用延迟 p99 大于 500ms</span></span>
<span class="line"><span style="color:#24292e;">histogram_quantile(0.99, rate(etcd_disk_wal_fsync_duration_seconds_bucket{job=~&quot;.\\*etcd.\\*&quot;}[5m])) &gt; 0.5</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># 5 分钟内 DB fsync 调用延迟 p99 大于 500ms</span></span>
<span class="line"><span style="color:#24292e;">histogram_quantile(0.99, rate(etcd_disk_backend_commit_duration_seconds_bucket{job=~&quot;.\\*etcd.\\*&quot;}[5m])) &gt; 0.25</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># 5 分钟内 节点之间 RTT 大于 500 ms</span></span>
<span class="line"><span style="color:#24292e;">histogram_quantile(0.99,rate(etcd_network_peer_round_trip_time_seconds_bucket[5m])) &gt; 0.5</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># these rules synced manually from https://github.com/etcd-io/etcd/blob/master/Documentation/etcd-mixin/mixin.libsonnet</span></span>
<span class="line"><span style="color:#85E89D;">groups</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd_InsufficientMembers</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: insufficient members ({{ $value</span></span>
<span class="line"><span style="color:#9ECBFF;">        }}).&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">                    sum(up{job=~&quot;.*etcd.*&quot;} == bool 1) by (job) &lt; ((count(up{job=~&quot;.*etcd.*&quot;}) by (job) + 1) / 2)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">3m</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">critical</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd_NoLeader</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: member {{ $labels.instance }} has</span></span>
<span class="line"><span style="color:#9ECBFF;">        no leader.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">                    etcd_server_has_leader{job=~&quot;.*etcd.*&quot;} == 0</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">1m</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">critical</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd_HighFsyncDurations</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: 99th percentile fync durations are</span></span>
<span class="line"><span style="color:#9ECBFF;">        {{ $value }}s on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">          histogram_quantile(0.99, rate(etcd_disk_wal_fsync_duration_seconds_bucket{job=~&quot;.*etcd.*&quot;}[5m]))</span></span>
<span class="line"><span style="color:#9ECBFF;">          &gt; 0.5          </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10m</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">warning</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd_HighCommitDurations</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: 99th percentile commit durations</span></span>
<span class="line"><span style="color:#9ECBFF;">        {{ $value }}s on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">          histogram_quantile(0.99, rate(etcd_disk_backend_commit_duration_seconds_bucket{job=~&quot;.*etcd.*&quot;}[5m]))</span></span>
<span class="line"><span style="color:#9ECBFF;">          &gt; 0.25          </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10m</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">warning</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd_HighNodeRTTDurations</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: node RTT durations&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      {{ </span><span style="color:#9ECBFF;">$value</span><span style="color:#E1E4E8;"> }}</span><span style="color:#9ECBFF;">s on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">                    histogram_quantile(0.99,rate(etcd_network_peer_round_trip_time_seconds_bucket[5m])) &gt; 0.5</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10m</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">warning</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># these rules synced manually from https://github.com/etcd-io/etcd/blob/master/Documentation/etcd-mixin/mixin.libsonnet</span></span>
<span class="line"><span style="color:#22863A;">groups</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd_InsufficientMembers</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: insufficient members ({{ $value</span></span>
<span class="line"><span style="color:#032F62;">        }}).&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">                    sum(up{job=~&quot;.*etcd.*&quot;} == bool 1) by (job) &lt; ((count(up{job=~&quot;.*etcd.*&quot;}) by (job) + 1) / 2)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">3m</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">critical</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd_NoLeader</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: member {{ $labels.instance }} has</span></span>
<span class="line"><span style="color:#032F62;">        no leader.&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">                    etcd_server_has_leader{job=~&quot;.*etcd.*&quot;} == 0</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">1m</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">critical</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd_HighFsyncDurations</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: 99th percentile fync durations are</span></span>
<span class="line"><span style="color:#032F62;">        {{ $value }}s on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">          histogram_quantile(0.99, rate(etcd_disk_wal_fsync_duration_seconds_bucket{job=~&quot;.*etcd.*&quot;}[5m]))</span></span>
<span class="line"><span style="color:#032F62;">          &gt; 0.5          </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10m</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">warning</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd_HighCommitDurations</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: 99th percentile commit durations</span></span>
<span class="line"><span style="color:#032F62;">        {{ $value }}s on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">          histogram_quantile(0.99, rate(etcd_disk_backend_commit_duration_seconds_bucket{job=~&quot;.*etcd.*&quot;}[5m]))</span></span>
<span class="line"><span style="color:#032F62;">          &gt; 0.25          </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10m</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">warning</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd_HighNodeRTTDurations</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: node RTT durations&#39;</span></span>
<span class="line"><span style="color:#24292E;">      {{ </span><span style="color:#032F62;">$value</span><span style="color:#24292E;"> }}</span><span style="color:#032F62;">s on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">                    histogram_quantile(0.99,rate(etcd_network_peer_round_trip_time_seconds_bucket[5m])) &gt; 0.5</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10m</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">warning</span></span></code></pre></div><blockquote><p>完整</p></blockquote><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># These rules were manually synced from https://github.com/etcd-io/etcd/blob/master/contrib/mixin/mixin.libsonnet</span></span>
<span class="line"><span style="color:#85E89D;">groups</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd</span></span>
<span class="line"><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcdInsufficientMembers</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: insufficient members ({{ $value</span></span>
<span class="line"><span style="color:#9ECBFF;">      }}).&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">    sum(up{job=~&quot;.*etcd.*&quot;} == bool 1) by (job) &lt; ((count(up{job=~&quot;.*etcd.*&quot;}) by (job) + 1) / 2)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">3m</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">critical</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcdNoLeader</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: member {{ $labels.instance }} has</span></span>
<span class="line"><span style="color:#9ECBFF;">      no leader.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">    etcd_server_has_leader{job=~&quot;.*etcd.*&quot;} == 0</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">1m</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">critical</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcdHighNumberOfLeaderChanges</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: instance {{ $labels.instance }}</span></span>
<span class="line"><span style="color:#9ECBFF;">      has seen {{ $value }} leader changes within the last hour.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">    rate(etcd_server_leader_changes_seen_total{job=~&quot;.*etcd.*&quot;}[15m]) &gt; 3</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">15m</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">warning</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcdHighNumberOfFailedGRPCRequests</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: {{ $value }}% of requests for {{</span></span>
<span class="line"><span style="color:#9ECBFF;">      $labels.grpc_method }} failed on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">    100 * sum(rate(grpc_server_handled_total{job=~&quot;.*etcd.*&quot;, grpc_code!=&quot;OK&quot;}[5m])) BY (job, instance, grpc_service, grpc_method)</span></span>
<span class="line"><span style="color:#9ECBFF;">      /</span></span>
<span class="line"><span style="color:#9ECBFF;">    sum(rate(grpc_server_handled_total{job=~&quot;.*etcd.*&quot;}[5m])) BY (job, instance, grpc_service, grpc_method)</span></span>
<span class="line"><span style="color:#9ECBFF;">      &gt; 1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10m</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">warning</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcdHighNumberOfFailedGRPCRequests</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: {{ $value }}% of requests for {{</span></span>
<span class="line"><span style="color:#9ECBFF;">      $labels.grpc_method }} failed on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">    100 * sum(rate(grpc_server_handled_total{job=~&quot;.*etcd.*&quot;, grpc_code!=&quot;OK&quot;}[5m])) BY (job, instance, grpc_service, grpc_method)</span></span>
<span class="line"><span style="color:#9ECBFF;">      /</span></span>
<span class="line"><span style="color:#9ECBFF;">    sum(rate(grpc_server_handled_total{job=~&quot;.*etcd.*&quot;}[5m])) BY (job, instance, grpc_service, grpc_method)</span></span>
<span class="line"><span style="color:#9ECBFF;">      &gt; 5</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">5m</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">critical</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcdGRPCRequestsSlow</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: gRPC requests to {{ $labels.grpc_method</span></span>
<span class="line"><span style="color:#9ECBFF;">      }} are taking {{ $value }}s on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">    histogram_quantile(0.99, sum(rate(grpc_server_handling_seconds_bucket{job=~&quot;.*etcd.*&quot;, grpc_type=&quot;unary&quot;}[5m])) by (job, instance, grpc_service, grpc_method, le))</span></span>
<span class="line"><span style="color:#9ECBFF;">    &gt; 0.15</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10m</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">critical</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcdMemberCommunicationSlow</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: member communication with {{ $labels.To</span></span>
<span class="line"><span style="color:#9ECBFF;">      }} is taking {{ $value }}s on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">    histogram_quantile(0.99, rate(etcd_network_peer_round_trip_time_seconds_bucket{job=~&quot;.*etcd.*&quot;}[5m]))</span></span>
<span class="line"><span style="color:#9ECBFF;">    &gt; 0.15</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10m</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">warning</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcdHighNumberOfFailedProposals</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: {{ $value }} proposal failures within</span></span>
<span class="line"><span style="color:#9ECBFF;">      the last hour on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">    rate(etcd_server_proposals_failed_total{job=~&quot;.*etcd.*&quot;}[15m]) &gt; 5</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">15m</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">warning</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcdHighFsyncDurations</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: 99th percentile fync durations are</span></span>
<span class="line"><span style="color:#9ECBFF;">      {{ $value }}s on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">    histogram_quantile(0.99, rate(etcd_disk_wal_fsync_duration_seconds_bucket{job=~&quot;.*etcd.*&quot;}[5m]))</span></span>
<span class="line"><span style="color:#9ECBFF;">    &gt; 0.5</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10m</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">warning</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcdHighCommitDurations</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: 99th percentile commit durations</span></span>
<span class="line"><span style="color:#9ECBFF;">      {{ $value }}s on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">    histogram_quantile(0.99, rate(etcd_disk_backend_commit_duration_seconds_bucket{job=~&quot;.*etcd.*&quot;}[5m]))</span></span>
<span class="line"><span style="color:#9ECBFF;">    &gt; 0.25</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10m</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">warning</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcdHighNumberOfFailedHTTPRequests</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;{{ $value }}% of requests for {{ $labels.method }} failed on etcd</span></span>
<span class="line"><span style="color:#9ECBFF;">      instance {{ $labels.instance }}&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">    sum(rate(etcd_http_failed_total{job=~&quot;.*etcd.*&quot;, code!=&quot;404&quot;}[5m])) BY (method) / sum(rate(etcd_http_received_total{job=~&quot;.*etcd.*&quot;}[5m]))</span></span>
<span class="line"><span style="color:#9ECBFF;">    BY (method) &gt; 0.01</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10m</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">warning</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcdHighNumberOfFailedHTTPRequests</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;{{ $value }}% of requests for {{ $labels.method }} failed on etcd</span></span>
<span class="line"><span style="color:#9ECBFF;">      instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">    sum(rate(etcd_http_failed_total{job=~&quot;.*etcd.*&quot;, code!=&quot;404&quot;}[5m])) BY (method) / sum(rate(etcd_http_received_total{job=~&quot;.*etcd.*&quot;}[5m]))</span></span>
<span class="line"><span style="color:#9ECBFF;">    BY (method) &gt; 0.05</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10m</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">critical</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">alert</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcdHTTPRequestsSlow</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">message</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd instance {{ $labels.instance }} HTTP requests to {{ $labels.method</span></span>
<span class="line"><span style="color:#E1E4E8;">      }} </span><span style="color:#9ECBFF;">are slow.</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">expr</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">    histogram_quantile(0.99, rate(etcd_http_successful_duration_seconds_bucket[5m]))</span></span>
<span class="line"><span style="color:#9ECBFF;">    &gt; 0.15</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10m</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">severity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">warning</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># These rules were manually synced from https://github.com/etcd-io/etcd/blob/master/contrib/mixin/mixin.libsonnet</span></span>
<span class="line"><span style="color:#22863A;">groups</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd</span></span>
<span class="line"><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcdInsufficientMembers</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: insufficient members ({{ $value</span></span>
<span class="line"><span style="color:#032F62;">      }}).&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    sum(up{job=~&quot;.*etcd.*&quot;} == bool 1) by (job) &lt; ((count(up{job=~&quot;.*etcd.*&quot;}) by (job) + 1) / 2)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">3m</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">critical</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcdNoLeader</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: member {{ $labels.instance }} has</span></span>
<span class="line"><span style="color:#032F62;">      no leader.&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    etcd_server_has_leader{job=~&quot;.*etcd.*&quot;} == 0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">1m</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">critical</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcdHighNumberOfLeaderChanges</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: instance {{ $labels.instance }}</span></span>
<span class="line"><span style="color:#032F62;">      has seen {{ $value }} leader changes within the last hour.&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    rate(etcd_server_leader_changes_seen_total{job=~&quot;.*etcd.*&quot;}[15m]) &gt; 3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">15m</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">warning</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcdHighNumberOfFailedGRPCRequests</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: {{ $value }}% of requests for {{</span></span>
<span class="line"><span style="color:#032F62;">      $labels.grpc_method }} failed on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    100 * sum(rate(grpc_server_handled_total{job=~&quot;.*etcd.*&quot;, grpc_code!=&quot;OK&quot;}[5m])) BY (job, instance, grpc_service, grpc_method)</span></span>
<span class="line"><span style="color:#032F62;">      /</span></span>
<span class="line"><span style="color:#032F62;">    sum(rate(grpc_server_handled_total{job=~&quot;.*etcd.*&quot;}[5m])) BY (job, instance, grpc_service, grpc_method)</span></span>
<span class="line"><span style="color:#032F62;">      &gt; 1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10m</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">warning</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcdHighNumberOfFailedGRPCRequests</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: {{ $value }}% of requests for {{</span></span>
<span class="line"><span style="color:#032F62;">      $labels.grpc_method }} failed on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    100 * sum(rate(grpc_server_handled_total{job=~&quot;.*etcd.*&quot;, grpc_code!=&quot;OK&quot;}[5m])) BY (job, instance, grpc_service, grpc_method)</span></span>
<span class="line"><span style="color:#032F62;">      /</span></span>
<span class="line"><span style="color:#032F62;">    sum(rate(grpc_server_handled_total{job=~&quot;.*etcd.*&quot;}[5m])) BY (job, instance, grpc_service, grpc_method)</span></span>
<span class="line"><span style="color:#032F62;">      &gt; 5</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">5m</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">critical</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcdGRPCRequestsSlow</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: gRPC requests to {{ $labels.grpc_method</span></span>
<span class="line"><span style="color:#032F62;">      }} are taking {{ $value }}s on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    histogram_quantile(0.99, sum(rate(grpc_server_handling_seconds_bucket{job=~&quot;.*etcd.*&quot;, grpc_type=&quot;unary&quot;}[5m])) by (job, instance, grpc_service, grpc_method, le))</span></span>
<span class="line"><span style="color:#032F62;">    &gt; 0.15</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10m</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">critical</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcdMemberCommunicationSlow</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: member communication with {{ $labels.To</span></span>
<span class="line"><span style="color:#032F62;">      }} is taking {{ $value }}s on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    histogram_quantile(0.99, rate(etcd_network_peer_round_trip_time_seconds_bucket{job=~&quot;.*etcd.*&quot;}[5m]))</span></span>
<span class="line"><span style="color:#032F62;">    &gt; 0.15</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10m</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">warning</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcdHighNumberOfFailedProposals</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: {{ $value }} proposal failures within</span></span>
<span class="line"><span style="color:#032F62;">      the last hour on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    rate(etcd_server_proposals_failed_total{job=~&quot;.*etcd.*&quot;}[15m]) &gt; 5</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">15m</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">warning</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcdHighFsyncDurations</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: 99th percentile fync durations are</span></span>
<span class="line"><span style="color:#032F62;">      {{ $value }}s on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    histogram_quantile(0.99, rate(etcd_disk_wal_fsync_duration_seconds_bucket{job=~&quot;.*etcd.*&quot;}[5m]))</span></span>
<span class="line"><span style="color:#032F62;">    &gt; 0.5</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10m</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">warning</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcdHighCommitDurations</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;etcd cluster &quot;{{ $labels.job }}&quot;: 99th percentile commit durations</span></span>
<span class="line"><span style="color:#032F62;">      {{ $value }}s on etcd instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    histogram_quantile(0.99, rate(etcd_disk_backend_commit_duration_seconds_bucket{job=~&quot;.*etcd.*&quot;}[5m]))</span></span>
<span class="line"><span style="color:#032F62;">    &gt; 0.25</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10m</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">warning</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcdHighNumberOfFailedHTTPRequests</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;{{ $value }}% of requests for {{ $labels.method }} failed on etcd</span></span>
<span class="line"><span style="color:#032F62;">      instance {{ $labels.instance }}&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    sum(rate(etcd_http_failed_total{job=~&quot;.*etcd.*&quot;, code!=&quot;404&quot;}[5m])) BY (method) / sum(rate(etcd_http_received_total{job=~&quot;.*etcd.*&quot;}[5m]))</span></span>
<span class="line"><span style="color:#032F62;">    BY (method) &gt; 0.01</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10m</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">warning</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcdHighNumberOfFailedHTTPRequests</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;{{ $value }}% of requests for {{ $labels.method }} failed on etcd</span></span>
<span class="line"><span style="color:#032F62;">      instance {{ $labels.instance }}.&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    sum(rate(etcd_http_failed_total{job=~&quot;.*etcd.*&quot;, code!=&quot;404&quot;}[5m])) BY (method) / sum(rate(etcd_http_received_total{job=~&quot;.*etcd.*&quot;}[5m]))</span></span>
<span class="line"><span style="color:#032F62;">    BY (method) &gt; 0.05</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10m</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">critical</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">alert</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcdHTTPRequestsSlow</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">message</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd instance {{ $labels.instance }} HTTP requests to {{ $labels.method</span></span>
<span class="line"><span style="color:#24292E;">      }} </span><span style="color:#032F62;">are slow.</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">expr</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    histogram_quantile(0.99, rate(etcd_http_successful_duration_seconds_bucket[5m]))</span></span>
<span class="line"><span style="color:#032F62;">    &gt; 0.15</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10m</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">severity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">warning</span></span></code></pre></div><h2 id="_1-4-grafana" tabindex="-1">1.4 grafana <a class="header-anchor" href="#_1-4-grafana" aria-label="Permalink to &quot;1.4 grafana&quot;">​</a></h2><p>默认搜索，<a href="https://grafana.com/grafana/dashboards/" target="_blank" rel="noreferrer">https://grafana.com/grafana/dashboards/</a></p><p>导入模板9733</p>`,63),e=[o];function t(c,r,E,y,i,d){return n(),a("div",null,e)}const m=s(p,[["render",t]]);export{F as __pageData,m as default};
