import{_ as s,o as n,c as a,R as p}from"./chunks/framework.zUbWieqp.js";const B=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Linux/vpn/9-install_sh.md","filePath":"guide/Linux/vpn/9-install_sh.md","lastUpdated":1701595065000}'),l={name:"guide/Linux/vpn/9-install_sh.md"},o=p(`<div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># https://github.com/Nyr/openvpn-install</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># Copyright (c) 2013 Nyr. Released under the MIT License.</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-qs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Ubuntu 16.04&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/etc/os-release&quot;</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Ubuntu 16.04 is no longer supported in the current version of openvpn-install</span></span>
<span class="line"><span style="color:#9ECBFF;">Use an older version if Ubuntu 16.04 support is needed: https://git.io/vpn1604&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">exit</span></span>
<span class="line"><span style="color:#F97583;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Detect Debian users running the script with &quot;sh&quot; instead of bash</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">readlink</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/proc/</span><span style="color:#79B8FF;">$$</span><span style="color:#9ECBFF;">/exe</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-q</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;dash&quot;</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;This script needs to be run with bash, not sh&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">exit</span></span>
<span class="line"><span style="color:#F97583;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$EUID</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-ne</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Sorry, you need to run this as root&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">exit</span></span>
<span class="line"><span style="color:#F97583;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-e</span><span style="color:#E1E4E8;"> /dev/net/tun ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;The TUN device is not available</span></span>
<span class="line"><span style="color:#9ECBFF;">You need to enable TUN before running this script&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">exit</span></span>
<span class="line"><span style="color:#F97583;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ </span><span style="color:#F97583;">-e</span><span style="color:#E1E4E8;"> /etc/debian_version ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">	OS</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">debian</span></span>
<span class="line"><span style="color:#E1E4E8;">	GROUPNAME</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">nogroup</span></span>
<span class="line"><span style="color:#F97583;">elif</span><span style="color:#E1E4E8;"> [[ </span><span style="color:#F97583;">-e</span><span style="color:#E1E4E8;"> /etc/centos-release </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-e</span><span style="color:#E1E4E8;"> /etc/redhat-release ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">	OS</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">centos</span></span>
<span class="line"><span style="color:#E1E4E8;">	GROUPNAME</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">nobody</span></span>
<span class="line"><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Looks like you aren&#39;t running this installer on Debian, Ubuntu or CentOS&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">exit</span></span>
<span class="line"><span style="color:#F97583;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">newclient</span><span style="color:#E1E4E8;"> () {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># Generates the custom client.ovpn</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/client-common.txt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/</span><span style="color:#FFAB70;">$1</span><span style="color:#9ECBFF;">.ovpn</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&lt;ca&gt;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/</span><span style="color:#FFAB70;">$1</span><span style="color:#9ECBFF;">.ovpn</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/easy-rsa/pki/ca.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/</span><span style="color:#FFAB70;">$1</span><span style="color:#9ECBFF;">.ovpn</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&lt;/ca&gt;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/</span><span style="color:#FFAB70;">$1</span><span style="color:#9ECBFF;">.ovpn</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&lt;cert&gt;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/</span><span style="color:#FFAB70;">$1</span><span style="color:#9ECBFF;">.ovpn</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">sed</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-ne</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;/BEGIN CERTIFICATE/,$ p&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/easy-rsa/pki/issued/</span><span style="color:#FFAB70;">$1</span><span style="color:#9ECBFF;">.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/</span><span style="color:#FFAB70;">$1</span><span style="color:#9ECBFF;">.ovpn</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&lt;/cert&gt;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/</span><span style="color:#FFAB70;">$1</span><span style="color:#9ECBFF;">.ovpn</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&lt;key&gt;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/</span><span style="color:#FFAB70;">$1</span><span style="color:#9ECBFF;">.ovpn</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/easy-rsa/pki/private/</span><span style="color:#FFAB70;">$1</span><span style="color:#9ECBFF;">.key</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/</span><span style="color:#FFAB70;">$1</span><span style="color:#9ECBFF;">.ovpn</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&lt;/key&gt;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/</span><span style="color:#FFAB70;">$1</span><span style="color:#9ECBFF;">.ovpn</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&lt;tls-auth&gt;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/</span><span style="color:#FFAB70;">$1</span><span style="color:#9ECBFF;">.ovpn</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">sed</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-ne</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;/BEGIN OpenVPN Static key/,$ p&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/ta.key</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/</span><span style="color:#FFAB70;">$1</span><span style="color:#9ECBFF;">.ovpn</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&lt;/tls-auth&gt;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/</span><span style="color:#FFAB70;">$1</span><span style="color:#9ECBFF;">.ovpn</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ </span><span style="color:#F97583;">-e</span><span style="color:#E1E4E8;"> /etc/openvpn/server/server.conf ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">clear</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Looks like OpenVPN is already installed.&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;What do you want to do?&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;   1) Add a new user&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;   2) Revoke an existing user&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;   3) Remove OpenVPN&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;   4) Exit&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">read</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Select an option [1-4]: &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">option</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> $option </span><span style="color:#F97583;">in</span></span>
<span class="line"><span style="color:#E1E4E8;">			1) </span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Tell me a name for the client certificate.&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Please, use one word only, no special characters.&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">read</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Client name: &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CLIENT</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/easy-rsa/</span></span>
<span class="line"><span style="color:#E1E4E8;">			EASYRSA_CERT_EXPIRE</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3650</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">./easyrsa</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">build-client-full</span><span style="color:#E1E4E8;"> $CLIENT </span><span style="color:#9ECBFF;">nopass</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#6A737D;"># Generates the custom client.ovpn</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#B392F0;">newclient</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$CLIENT</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Client </span><span style="color:#E1E4E8;">$CLIENT</span><span style="color:#9ECBFF;"> added, configuration is available at:&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/&quot;</span><span style="color:#E1E4E8;">$CLIENT</span><span style="color:#9ECBFF;">.ovpn&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">exit</span></span>
<span class="line"><span style="color:#E1E4E8;">			;;</span></span>
<span class="line"><span style="color:#E1E4E8;">			2)</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#6A737D;"># This option could be documented a bit better and maybe even be simplified</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#6A737D;"># ...but what can I say, I want some sleep too</span></span>
<span class="line"><span style="color:#E1E4E8;">			NUMBEROFCLIENTS</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">tail</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#9ECBFF;"> +2 /etc/openvpn/server/easy-rsa/pki/index.txt </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-c</span><span style="color:#9ECBFF;"> &quot;^V&quot;)</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$NUMBEROFCLIENTS</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;0&#39;</span><span style="color:#E1E4E8;"> ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;You have no existing clients!&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#79B8FF;">exit</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Select the existing client certificate you want to revoke:&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#B392F0;">tail</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/easy-rsa/pki/index.txt</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;^V&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cut</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;=&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">nl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-s</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;) &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$NUMBEROFCLIENTS</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;1&#39;</span><span style="color:#E1E4E8;"> ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#79B8FF;">read</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Select one client [1]: &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CLIENTNUMBER</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#79B8FF;">read</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Select one client [1-</span><span style="color:#E1E4E8;">$NUMBEROFCLIENTS</span><span style="color:#9ECBFF;">]: &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CLIENTNUMBER</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">			CLIENT</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">tail</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#9ECBFF;"> +2 /etc/openvpn/server/easy-rsa/pki/index.txt </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> &quot;^V&quot; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">cut</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#9ECBFF;"> &#39;=&#39; </span><span style="color:#79B8FF;">-f</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;"> </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">sed</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#9ECBFF;"> &quot;</span><span style="color:#E1E4E8;">$CLIENTNUMBER</span><span style="color:#9ECBFF;">&quot;p)</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">read</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Do you really want to revoke access for client </span><span style="color:#E1E4E8;">$CLIENT</span><span style="color:#9ECBFF;">? [y/N]: &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">REVOKE</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$REVOKE</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;y&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$REVOKE</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Y&#39;</span><span style="color:#E1E4E8;"> ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/easy-rsa/</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#B392F0;">./easyrsa</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--batch</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">revoke</span><span style="color:#E1E4E8;"> $CLIENT</span></span>
<span class="line"><span style="color:#E1E4E8;">				EASYRSA_CRL_DAYS</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3650</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">./easyrsa</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gen-crl</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#B392F0;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pki/reqs/</span><span style="color:#E1E4E8;">$CLIENT</span><span style="color:#9ECBFF;">.req</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#B392F0;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pki/private/</span><span style="color:#E1E4E8;">$CLIENT</span><span style="color:#9ECBFF;">.key</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#B392F0;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pki/issued/</span><span style="color:#E1E4E8;">$CLIENT</span><span style="color:#9ECBFF;">.crt</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#B392F0;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/crl.pem</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#B392F0;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/easy-rsa/pki/crl.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/crl.pem</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#6A737D;"># CRL is read with each client connection, when OpenVPN is dropped to nobody</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#B392F0;">chown</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody:</span><span style="color:#E1E4E8;">$GROUPNAME </span><span style="color:#9ECBFF;">/etc/openvpn/server/crl.pem</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Certificate for client </span><span style="color:#E1E4E8;">$CLIENT</span><span style="color:#9ECBFF;"> revoked!&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Certificate revocation for client </span><span style="color:#E1E4E8;">$CLIENT</span><span style="color:#9ECBFF;"> aborted!&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">exit</span></span>
<span class="line"><span style="color:#E1E4E8;">			;;</span></span>
<span class="line"><span style="color:#E1E4E8;">			3) </span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">read</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Do you really want to remove OpenVPN? [y/N]: &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">REMOVE</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$REMOVE</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;y&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$REMOVE</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Y&#39;</span><span style="color:#E1E4E8;"> ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">				PORT</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> &#39;^port &#39; /etc/openvpn/server/server.conf </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">cut</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#9ECBFF;"> &quot; &quot; </span><span style="color:#79B8FF;">-f</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">				PROTOCOL</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> &#39;^proto &#39; /etc/openvpn/server/server.conf </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">cut</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#9ECBFF;"> &quot; &quot; </span><span style="color:#79B8FF;">-f</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pgrep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">firewalld</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">					IP</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">firewall-cmd</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">--direct</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">--get-rules</span><span style="color:#9ECBFF;"> ipv4 nat POSTROUTING </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> &#39;\\-s 10.8.0.0/24 &#39;&quot;&#39;&quot;&#39;!&#39;&quot;&#39;&quot;&#39; -d 10.8.0.0/24 -j SNAT --to &#39; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">cut</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#9ECBFF;"> &quot; &quot; </span><span style="color:#79B8FF;">-f</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">					</span><span style="color:#6A737D;"># Using both permanent and not permanent rules to avoid a firewalld reload.</span></span>
<span class="line"><span style="color:#E1E4E8;">					</span><span style="color:#B392F0;">firewall-cmd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--remove-port=</span><span style="color:#E1E4E8;">$PORT</span><span style="color:#79B8FF;">/</span><span style="color:#E1E4E8;">$PROTOCOL</span></span>
<span class="line"><span style="color:#E1E4E8;">					</span><span style="color:#B392F0;">firewall-cmd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--zone=trusted</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--remove-source=10.8.0.0/24</span></span>
<span class="line"><span style="color:#E1E4E8;">					</span><span style="color:#B392F0;">firewall-cmd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--permanent</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--remove-port=</span><span style="color:#E1E4E8;">$PORT</span><span style="color:#79B8FF;">/</span><span style="color:#E1E4E8;">$PROTOCOL</span></span>
<span class="line"><span style="color:#E1E4E8;">					</span><span style="color:#B392F0;">firewall-cmd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--permanent</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--zone=trusted</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--remove-source=10.8.0.0/24</span></span>
<span class="line"><span style="color:#E1E4E8;">					</span><span style="color:#B392F0;">firewall-cmd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--direct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--remove-rule</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ipv4</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">POSTROUTING</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-s</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.8</span><span style="color:#9ECBFF;">.0.0/24</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">!</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.8</span><span style="color:#9ECBFF;">.0.0/24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-j</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">SNAT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--to</span><span style="color:#E1E4E8;"> $IP</span></span>
<span class="line"><span style="color:#E1E4E8;">					</span><span style="color:#B392F0;">firewall-cmd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--permanent</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--direct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--remove-rule</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ipv4</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">POSTROUTING</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-s</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.8</span><span style="color:#9ECBFF;">.0.0/24</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">!</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.8</span><span style="color:#9ECBFF;">.0.0/24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-j</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">SNAT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--to</span><span style="color:#E1E4E8;"> $IP</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">					</span><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">disable</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openvpn-iptables.service</span></span>
<span class="line"><span style="color:#E1E4E8;">					</span><span style="color:#B392F0;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/systemd/system/openvpn-iptables.service</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sestatus</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;</span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Current mode&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-q</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;enforcing&quot;</span><span style="color:#E1E4E8;"> &amp;&amp; [[ </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$PORT</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;1194&#39;</span><span style="color:#E1E4E8;"> ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">					</span><span style="color:#B392F0;">semanage</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">port</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openvpn_port_t</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> $PROTOCOL $PORT</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">disable</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openvpn-server@server.service</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#B392F0;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-rf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#B392F0;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/systemd/system/openvpn-server@server.service.d/disable-limitnproc.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#B392F0;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/sysctl.d/30-openvpn-forward.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$OS</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;debian&#39;</span><span style="color:#E1E4E8;"> ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">					</span><span style="color:#B392F0;">apt-get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">remove</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--purge</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openvpn</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">					</span><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">remove</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openvpn</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;OpenVPN removed!&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Removal aborted!&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">exit</span></span>
<span class="line"><span style="color:#E1E4E8;">			;;</span></span>
<span class="line"><span style="color:#E1E4E8;">			4) exit;;</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">esac</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">done</span></span>
<span class="line"><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">clear</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Welcome to this OpenVPN &quot;road warrior&quot; installer!&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># OpenVPN setup and first user creation</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;I need to ask you a few questions before starting the setup.&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;You can leave the default options and just press enter if you are ok with them.&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;First, provide the IPv4 address of the network interface you want OpenVPN&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;listening to.&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># Autodetect IP address and pre-fill for the user</span></span>
<span class="line"><span style="color:#E1E4E8;">	IP</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">ip</span><span style="color:#9ECBFF;"> addr </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> &#39;inet&#39; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-v</span><span style="color:#9ECBFF;"> inet6 </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-vE</span><span style="color:#9ECBFF;"> &#39;127\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}&#39; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-oE</span><span style="color:#9ECBFF;"> &#39;[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}&#39; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">head</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-1</span><span style="color:#9ECBFF;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">read</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;IP address: &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-i</span><span style="color:#E1E4E8;"> $IP </span><span style="color:#9ECBFF;">IP</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">#If $IP is a private IP address, the server must be behind NAT</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$IP</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-qE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;^(10\\.|172\\.1[6789]\\.|172\\.2[0-9]\\.|172\\.3[01]\\.|192\\.168)&#39;</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;This server is behind NAT. What is the public IPv4 address or hostname?&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">read</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Public IP address / hostname: &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PUBLICIP</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Which protocol do you want for OpenVPN connections?&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;   1) UDP (recommended)&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;   2) TCP&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">read</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Protocol [1-2]: &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-i</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PROTOCOL</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> $PROTOCOL </span><span style="color:#F97583;">in</span></span>
<span class="line"><span style="color:#E1E4E8;">		1) </span></span>
<span class="line"><span style="color:#E1E4E8;">		PROTOCOL</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">udp</span></span>
<span class="line"><span style="color:#E1E4E8;">		;;</span></span>
<span class="line"><span style="color:#E1E4E8;">		2) </span></span>
<span class="line"><span style="color:#E1E4E8;">		PROTOCOL</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">		;;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">esac</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;What port do you want OpenVPN listening to?&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">read</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Port: &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-i</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1194</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PORT</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Which DNS do you want to use with the VPN?&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;   1) Current system resolvers&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;   2) 1.1.1.1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;   3) Google&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;   4) OpenDNS&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;   5) Verisign&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">read</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;DNS [1-5]: &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-i</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">DNS</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Finally, tell me your name for the client certificate.&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Please, use one word only, no special characters.&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">read</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Client name: &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-i</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">client</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CLIENT</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Okay, that was all I needed. We are ready to set up your OpenVPN server now.&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">read</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-r</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Press any key to continue...&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># If running inside a container, disable LimitNPROC to prevent conflicts</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">systemd-detect-virt</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-cq</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/systemd/system/openvpn-server@server.service.d/</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;</span><span style="color:#9ECBFF;">/dev/null</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;[Service]</span></span>
<span class="line"><span style="color:#9ECBFF;">LimitNPROC=infinity&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/systemd/system/openvpn-server@server.service.d/disable-limitnproc.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$OS</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;debian&#39;</span><span style="color:#E1E4E8;"> ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">apt-get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">update</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">apt-get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openvpn</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">iptables</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ca-certificates</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;"># Else, the distro is CentOS</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">epel-release</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openvpn</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">iptables</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ca-certificates</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># Get easy-rsa</span></span>
<span class="line"><span style="color:#E1E4E8;">	EASYRSAURL</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.5/EasyRSA-nix-3.0.5.tgz&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-O</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/easyrsa.tgz</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$EASYRSAURL</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;</span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-Lo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/easyrsa.tgz</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$EASYRSAURL</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">tar</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">xzf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/easyrsa.tgz</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-C</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">mv</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/EasyRSA-3.0.5/</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">mv</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/EasyRSA-3.0.5/</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/easy-rsa/</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">chown</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-R</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root:root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/easy-rsa/</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/easyrsa.tgz</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/easy-rsa/</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># Create the PKI, set up the CA and the server and client certificates</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">./easyrsa</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">init-pki</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">./easyrsa</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--batch</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">build-ca</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nopass</span></span>
<span class="line"><span style="color:#E1E4E8;">	EASYRSA_CERT_EXPIRE</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3650</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">./easyrsa</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">build-server-full</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nopass</span></span>
<span class="line"><span style="color:#E1E4E8;">	EASYRSA_CERT_EXPIRE</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3650</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">./easyrsa</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">build-client-full</span><span style="color:#E1E4E8;"> $CLIENT </span><span style="color:#9ECBFF;">nopass</span></span>
<span class="line"><span style="color:#E1E4E8;">	EASYRSA_CRL_DAYS</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3650</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">./easyrsa</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gen-crl</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># Move the stuff we need</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pki/ca.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pki/private/ca.key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pki/issued/server.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pki/private/server.key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pki/crl.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># CRL is read with each client connection, when OpenVPN is dropped to nobody</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">chown</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nobody:</span><span style="color:#E1E4E8;">$GROUPNAME </span><span style="color:#9ECBFF;">/etc/openvpn/server/crl.pem</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># Generate key for tls-auth</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">openvpn</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--genkey</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--secret</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/ta.key</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># Create the DH parameters file using the predefined ffdhe2048 group</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;-----BEGIN DH PARAMETERS-----</span></span>
<span class="line"><span style="color:#9ECBFF;">MIIBCAKCAQEA//////////+t+FRYortKmq/cViAnPTzx2LnFg84tNpWp4TZBFGQz</span></span>
<span class="line"><span style="color:#9ECBFF;">+8yTnc4kmz75fS/jY2MMddj2gbICrsRhetPfHtXV/WVhJDP1H18GbtCFY2VVPe0a</span></span>
<span class="line"><span style="color:#9ECBFF;">87VXE15/V8k1mE8McODmi3fipona8+/och3xWKE2rec1MKzKT0g6eXq8CrGCsyT7</span></span>
<span class="line"><span style="color:#9ECBFF;">YdEIqUuyyOP7uWrat2DX9GgdT0Kj3jlN9K5W7edjcrsZCwenyO4KbXCeAvzhzffi</span></span>
<span class="line"><span style="color:#9ECBFF;">7MA0BM0oNC9hkXL+nOmFg/+OTxIy7vKBg8P+OxtMb61zO7X8vC7CIAXFjvGDfRaD</span></span>
<span class="line"><span style="color:#9ECBFF;">ssbzSibBsu/6iGtCOGEoXJf//////////wIBAg==</span></span>
<span class="line"><span style="color:#9ECBFF;">-----END DH PARAMETERS-----&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/dh.pem</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># Generate server.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;port </span><span style="color:#E1E4E8;">$PORT</span></span>
<span class="line"><span style="color:#9ECBFF;">proto </span><span style="color:#E1E4E8;">$PROTOCOL</span></span>
<span class="line"><span style="color:#9ECBFF;">dev tun</span></span>
<span class="line"><span style="color:#9ECBFF;">sndbuf 0</span></span>
<span class="line"><span style="color:#9ECBFF;">rcvbuf 0</span></span>
<span class="line"><span style="color:#9ECBFF;">ca ca.crt</span></span>
<span class="line"><span style="color:#9ECBFF;">cert server.crt</span></span>
<span class="line"><span style="color:#9ECBFF;">key server.key</span></span>
<span class="line"><span style="color:#9ECBFF;">dh dh.pem</span></span>
<span class="line"><span style="color:#9ECBFF;">auth SHA512</span></span>
<span class="line"><span style="color:#9ECBFF;">tls-auth ta.key 0</span></span>
<span class="line"><span style="color:#9ECBFF;">topology subnet</span></span>
<span class="line"><span style="color:#9ECBFF;">server 10.8.0.0 255.255.255.0</span></span>
<span class="line"><span style="color:#9ECBFF;">ifconfig-pool-persist ipp.txt&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;push &quot;redirect-gateway def1 bypass-dhcp&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># DNS</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> $DNS </span><span style="color:#F97583;">in</span></span>
<span class="line"><span style="color:#E1E4E8;">		1)</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;"># Locate the proper resolv.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;"># Needed for systems running systemd-resolved</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-q</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;127.0.0.53&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/etc/resolv.conf&quot;</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">			RESOLVCONF</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;/run/systemd/resolve/resolv.conf&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">			RESOLVCONF</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;/etc/resolv.conf&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;"># Obtain the resolvers from resolv.conf and use them for OpenVPN</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-v</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;#&#39;</span><span style="color:#E1E4E8;"> $RESOLVCONF </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;nameserver&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-E</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">read</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">line</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;push </span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">dhcp-option DNS </span><span style="color:#E1E4E8;">$line</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">done</span></span>
<span class="line"><span style="color:#E1E4E8;">		;;</span></span>
<span class="line"><span style="color:#E1E4E8;">		2)</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;push &quot;dhcp-option DNS 1.1.1.1&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;push &quot;dhcp-option DNS 1.0.0.1&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">		;;</span></span>
<span class="line"><span style="color:#E1E4E8;">		3)</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;push &quot;dhcp-option DNS 8.8.8.8&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;push &quot;dhcp-option DNS 8.8.4.4&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">		;;</span></span>
<span class="line"><span style="color:#E1E4E8;">		4)</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;push &quot;dhcp-option DNS 208.67.222.222&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;push &quot;dhcp-option DNS 208.67.220.220&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">		;;</span></span>
<span class="line"><span style="color:#E1E4E8;">		5)</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;push &quot;dhcp-option DNS 64.6.64.6&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;push &quot;dhcp-option DNS 64.6.65.6&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">		;;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">esac</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;keepalive 10 120</span></span>
<span class="line"><span style="color:#9ECBFF;">cipher AES-256-CBC</span></span>
<span class="line"><span style="color:#9ECBFF;">user nobody</span></span>
<span class="line"><span style="color:#9ECBFF;">group </span><span style="color:#E1E4E8;">$GROUPNAME</span></span>
<span class="line"><span style="color:#9ECBFF;">persist-key</span></span>
<span class="line"><span style="color:#9ECBFF;">persist-tun</span></span>
<span class="line"><span style="color:#9ECBFF;">status openvpn-status.log</span></span>
<span class="line"><span style="color:#9ECBFF;">verb 3</span></span>
<span class="line"><span style="color:#9ECBFF;">crl-verify crl.pem&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># Enable net.ipv4.ip_forward for the system</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;net.ipv4.ip_forward=1&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/sysctl.d/30-openvpn-forward.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># Enable without waiting for a reboot or service restart</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/proc/sys/net/ipv4/ip_forward</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pgrep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">firewalld</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;"># Using both permanent and not permanent rules to avoid a firewalld</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;"># reload.</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;"># We don&#39;t use --add-service=openvpn because that would only work with</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;"># the default port and protocol.</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">firewall-cmd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--add-port=</span><span style="color:#E1E4E8;">$PORT</span><span style="color:#79B8FF;">/</span><span style="color:#E1E4E8;">$PROTOCOL</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">firewall-cmd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--zone=trusted</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--add-source=10.8.0.0/24</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">firewall-cmd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--permanent</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--add-port=</span><span style="color:#E1E4E8;">$PORT</span><span style="color:#79B8FF;">/</span><span style="color:#E1E4E8;">$PROTOCOL</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">firewall-cmd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--permanent</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--zone=trusted</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--add-source=10.8.0.0/24</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;"># Set NAT for the VPN subnet</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">firewall-cmd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--direct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--add-rule</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ipv4</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">POSTROUTING</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-s</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.8</span><span style="color:#9ECBFF;">.0.0/24</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">!</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.8</span><span style="color:#9ECBFF;">.0.0/24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-j</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">SNAT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--to</span><span style="color:#E1E4E8;"> $IP</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">firewall-cmd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--permanent</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--direct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--add-rule</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ipv4</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">POSTROUTING</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-s</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.8</span><span style="color:#9ECBFF;">.0.0/24</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">!</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.8</span><span style="color:#9ECBFF;">.0.0/24</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-j</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">SNAT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--to</span><span style="color:#E1E4E8;"> $IP</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;"># Create a service to set up persistent iptables rules</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;[Unit]</span></span>
<span class="line"><span style="color:#9ECBFF;">Before=network.target</span></span>
<span class="line"><span style="color:#9ECBFF;">[Service]</span></span>
<span class="line"><span style="color:#9ECBFF;">Type=oneshot</span></span>
<span class="line"><span style="color:#9ECBFF;">ExecStart=/sbin/iptables -t nat -A POSTROUTING -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to </span><span style="color:#E1E4E8;">$IP</span></span>
<span class="line"><span style="color:#9ECBFF;">ExecStart=/sbin/iptables -I INPUT -p </span><span style="color:#E1E4E8;">$PROTOCOL</span><span style="color:#9ECBFF;"> --dport </span><span style="color:#E1E4E8;">$PORT</span><span style="color:#9ECBFF;"> -j ACCEPT</span></span>
<span class="line"><span style="color:#9ECBFF;">ExecStart=/sbin/iptables -I FORWARD -s 10.8.0.0/24 -j ACCEPT</span></span>
<span class="line"><span style="color:#9ECBFF;">ExecStart=/sbin/iptables -I FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT</span></span>
<span class="line"><span style="color:#9ECBFF;">ExecStop=/sbin/iptables -t nat -D POSTROUTING -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to </span><span style="color:#E1E4E8;">$IP</span></span>
<span class="line"><span style="color:#9ECBFF;">ExecStop=/sbin/iptables -D INPUT -p </span><span style="color:#E1E4E8;">$PROTOCOL</span><span style="color:#9ECBFF;"> --dport </span><span style="color:#E1E4E8;">$PORT</span><span style="color:#9ECBFF;"> -j ACCEPT</span></span>
<span class="line"><span style="color:#9ECBFF;">ExecStop=/sbin/iptables -D FORWARD -s 10.8.0.0/24 -j ACCEPT</span></span>
<span class="line"><span style="color:#9ECBFF;">ExecStop=/sbin/iptables -D FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT</span></span>
<span class="line"><span style="color:#9ECBFF;">RemainAfterExit=yes</span></span>
<span class="line"><span style="color:#9ECBFF;">[Install]</span></span>
<span class="line"><span style="color:#9ECBFF;">WantedBy=multi-user.target&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/systemd/system/openvpn-iptables.service</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openvpn-iptables.service</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># If SELinux is enabled and a custom port was selected, we need this</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sestatus</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;</span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Current mode&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-q</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;enforcing&quot;</span><span style="color:#E1E4E8;"> &amp;&amp; [[ </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$PORT</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;1194&#39;</span><span style="color:#E1E4E8;"> ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;"># Install semanage if not already present</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">hash</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">semanage</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;</span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-qs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;CentOS Linux release 7&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/etc/centos-release&quot;</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">policycoreutils-python</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">policycoreutils-python-utils</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#B392F0;">semanage</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">port</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-a</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openvpn_port_t</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> $PROTOCOL $PORT</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># And finally, enable and start the OpenVPN service</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openvpn-server@server.service</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># If the server is behind a NAT, use the correct IP address</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$PUBLICIP</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">		IP</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">$PUBLICIP</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># client-common.txt is created so we have a template to add further users later</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;client</span></span>
<span class="line"><span style="color:#9ECBFF;">dev tun</span></span>
<span class="line"><span style="color:#9ECBFF;">proto </span><span style="color:#E1E4E8;">$PROTOCOL</span></span>
<span class="line"><span style="color:#9ECBFF;">sndbuf 0</span></span>
<span class="line"><span style="color:#9ECBFF;">rcvbuf 0</span></span>
<span class="line"><span style="color:#9ECBFF;">remote </span><span style="color:#E1E4E8;">$IP</span><span style="color:#9ECBFF;"> </span><span style="color:#E1E4E8;">$PORT</span></span>
<span class="line"><span style="color:#9ECBFF;">resolv-retry infinite</span></span>
<span class="line"><span style="color:#9ECBFF;">nobind</span></span>
<span class="line"><span style="color:#9ECBFF;">persist-key</span></span>
<span class="line"><span style="color:#9ECBFF;">persist-tun</span></span>
<span class="line"><span style="color:#9ECBFF;">remote-cert-tls server</span></span>
<span class="line"><span style="color:#9ECBFF;">auth SHA512</span></span>
<span class="line"><span style="color:#9ECBFF;">cipher AES-256-CBC</span></span>
<span class="line"><span style="color:#9ECBFF;">setenv opt block-outside-dns</span></span>
<span class="line"><span style="color:#9ECBFF;">key-direction 1</span></span>
<span class="line"><span style="color:#9ECBFF;">verb 3&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/openvpn/server/client-common.txt</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># Generates the custom client.ovpn</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">newclient</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$CLIENT</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Finished!&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Your client configuration is available at:&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/&quot;</span><span style="color:#E1E4E8;">$CLIENT</span><span style="color:#9ECBFF;">.ovpn&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;If you want to add more clients, you simply need to run this script again!&quot;</span></span>
<span class="line"><span style="color:#F97583;">fi</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># https://github.com/Nyr/openvpn-install</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># Copyright (c) 2013 Nyr. Released under the MIT License.</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-qs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Ubuntu 16.04&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/etc/os-release&quot;</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Ubuntu 16.04 is no longer supported in the current version of openvpn-install</span></span>
<span class="line"><span style="color:#032F62;">Use an older version if Ubuntu 16.04 support is needed: https://git.io/vpn1604&#39;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">exit</span></span>
<span class="line"><span style="color:#D73A49;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Detect Debian users running the script with &quot;sh&quot; instead of bash</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">readlink</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/proc/</span><span style="color:#005CC5;">$$</span><span style="color:#032F62;">/exe</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-q</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;dash&quot;</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;This script needs to be run with bash, not sh&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">exit</span></span>
<span class="line"><span style="color:#D73A49;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$EUID</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-ne</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Sorry, you need to run this as root&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">exit</span></span>
<span class="line"><span style="color:#D73A49;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ </span><span style="color:#D73A49;">!</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-e</span><span style="color:#24292E;"> /dev/net/tun ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;The TUN device is not available</span></span>
<span class="line"><span style="color:#032F62;">You need to enable TUN before running this script&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">exit</span></span>
<span class="line"><span style="color:#D73A49;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ </span><span style="color:#D73A49;">-e</span><span style="color:#24292E;"> /etc/debian_version ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">	OS</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">debian</span></span>
<span class="line"><span style="color:#24292E;">	GROUPNAME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">nogroup</span></span>
<span class="line"><span style="color:#D73A49;">elif</span><span style="color:#24292E;"> [[ </span><span style="color:#D73A49;">-e</span><span style="color:#24292E;"> /etc/centos-release </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-e</span><span style="color:#24292E;"> /etc/redhat-release ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">	OS</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">centos</span></span>
<span class="line"><span style="color:#24292E;">	GROUPNAME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">nobody</span></span>
<span class="line"><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Looks like you aren&#39;t running this installer on Debian, Ubuntu or CentOS&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">exit</span></span>
<span class="line"><span style="color:#D73A49;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">newclient</span><span style="color:#24292E;"> () {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># Generates the custom client.ovpn</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">cp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/client-common.txt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/</span><span style="color:#E36209;">$1</span><span style="color:#032F62;">.ovpn</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&lt;ca&gt;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/</span><span style="color:#E36209;">$1</span><span style="color:#032F62;">.ovpn</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/easy-rsa/pki/ca.crt</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/</span><span style="color:#E36209;">$1</span><span style="color:#032F62;">.ovpn</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&lt;/ca&gt;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/</span><span style="color:#E36209;">$1</span><span style="color:#032F62;">.ovpn</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&lt;cert&gt;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/</span><span style="color:#E36209;">$1</span><span style="color:#032F62;">.ovpn</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">sed</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-ne</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;/BEGIN CERTIFICATE/,$ p&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/easy-rsa/pki/issued/</span><span style="color:#E36209;">$1</span><span style="color:#032F62;">.crt</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/</span><span style="color:#E36209;">$1</span><span style="color:#032F62;">.ovpn</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&lt;/cert&gt;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/</span><span style="color:#E36209;">$1</span><span style="color:#032F62;">.ovpn</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&lt;key&gt;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/</span><span style="color:#E36209;">$1</span><span style="color:#032F62;">.ovpn</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/easy-rsa/pki/private/</span><span style="color:#E36209;">$1</span><span style="color:#032F62;">.key</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/</span><span style="color:#E36209;">$1</span><span style="color:#032F62;">.ovpn</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&lt;/key&gt;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/</span><span style="color:#E36209;">$1</span><span style="color:#032F62;">.ovpn</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&lt;tls-auth&gt;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/</span><span style="color:#E36209;">$1</span><span style="color:#032F62;">.ovpn</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">sed</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-ne</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;/BEGIN OpenVPN Static key/,$ p&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/ta.key</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/</span><span style="color:#E36209;">$1</span><span style="color:#032F62;">.ovpn</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&lt;/tls-auth&gt;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/</span><span style="color:#E36209;">$1</span><span style="color:#032F62;">.ovpn</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ </span><span style="color:#D73A49;">-e</span><span style="color:#24292E;"> /etc/openvpn/server/server.conf ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">:</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">clear</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Looks like OpenVPN is already installed.&quot;</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;What do you want to do?&quot;</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;   1) Add a new user&quot;</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;   2) Revoke an existing user&quot;</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;   3) Remove OpenVPN&quot;</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;   4) Exit&quot;</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">read</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Select an option [1-4]: &quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">option</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> $option </span><span style="color:#D73A49;">in</span></span>
<span class="line"><span style="color:#24292E;">			1) </span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Tell me a name for the client certificate.&quot;</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Please, use one word only, no special characters.&quot;</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">read</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Client name: &quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CLIENT</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/easy-rsa/</span></span>
<span class="line"><span style="color:#24292E;">			EASYRSA_CERT_EXPIRE</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3650</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">./easyrsa</span><span style="color:#24292E;"> </span><span style="color:#032F62;">build-client-full</span><span style="color:#24292E;"> $CLIENT </span><span style="color:#032F62;">nopass</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#6A737D;"># Generates the custom client.ovpn</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#6F42C1;">newclient</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$CLIENT</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Client </span><span style="color:#24292E;">$CLIENT</span><span style="color:#032F62;"> added, configuration is available at:&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/&quot;</span><span style="color:#24292E;">$CLIENT</span><span style="color:#032F62;">.ovpn&quot;</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">exit</span></span>
<span class="line"><span style="color:#24292E;">			;;</span></span>
<span class="line"><span style="color:#24292E;">			2)</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#6A737D;"># This option could be documented a bit better and maybe even be simplified</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#6A737D;"># ...but what can I say, I want some sleep too</span></span>
<span class="line"><span style="color:#24292E;">			NUMBEROFCLIENTS</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">tail</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-n</span><span style="color:#032F62;"> +2 /etc/openvpn/server/easy-rsa/pki/index.txt </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-c</span><span style="color:#032F62;"> &quot;^V&quot;)</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$NUMBEROFCLIENTS</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;0&#39;</span><span style="color:#24292E;"> ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;You have no existing clients!&quot;</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#005CC5;">exit</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Select the existing client certificate you want to revoke:&quot;</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#6F42C1;">tail</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/easy-rsa/pki/index.txt</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;^V&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cut</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;=&#39;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">nl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-s</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;) &#39;</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$NUMBEROFCLIENTS</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;1&#39;</span><span style="color:#24292E;"> ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#005CC5;">read</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Select one client [1]: &quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CLIENTNUMBER</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#005CC5;">read</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Select one client [1-</span><span style="color:#24292E;">$NUMBEROFCLIENTS</span><span style="color:#032F62;">]: &quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CLIENTNUMBER</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">			CLIENT</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">tail</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-n</span><span style="color:#032F62;"> +2 /etc/openvpn/server/easy-rsa/pki/index.txt </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> &quot;^V&quot; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">cut</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-d</span><span style="color:#032F62;"> &#39;=&#39; </span><span style="color:#005CC5;">-f</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">2</span><span style="color:#032F62;"> </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">sed</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-n</span><span style="color:#032F62;"> &quot;</span><span style="color:#24292E;">$CLIENTNUMBER</span><span style="color:#032F62;">&quot;p)</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">read</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Do you really want to revoke access for client </span><span style="color:#24292E;">$CLIENT</span><span style="color:#032F62;">? [y/N]: &quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">REVOKE</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$REVOKE</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;y&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$REVOKE</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Y&#39;</span><span style="color:#24292E;"> ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/easy-rsa/</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6F42C1;">./easyrsa</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--batch</span><span style="color:#24292E;"> </span><span style="color:#032F62;">revoke</span><span style="color:#24292E;"> $CLIENT</span></span>
<span class="line"><span style="color:#24292E;">				EASYRSA_CRL_DAYS</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3650</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">./easyrsa</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gen-crl</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6F42C1;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pki/reqs/</span><span style="color:#24292E;">$CLIENT</span><span style="color:#032F62;">.req</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6F42C1;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pki/private/</span><span style="color:#24292E;">$CLIENT</span><span style="color:#032F62;">.key</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6F42C1;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pki/issued/</span><span style="color:#24292E;">$CLIENT</span><span style="color:#032F62;">.crt</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6F42C1;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/crl.pem</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6F42C1;">cp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/easy-rsa/pki/crl.pem</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/crl.pem</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6A737D;"># CRL is read with each client connection, when OpenVPN is dropped to nobody</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6F42C1;">chown</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody:</span><span style="color:#24292E;">$GROUPNAME </span><span style="color:#032F62;">/etc/openvpn/server/crl.pem</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Certificate for client </span><span style="color:#24292E;">$CLIENT</span><span style="color:#032F62;"> revoked!&quot;</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Certificate revocation for client </span><span style="color:#24292E;">$CLIENT</span><span style="color:#032F62;"> aborted!&quot;</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">exit</span></span>
<span class="line"><span style="color:#24292E;">			;;</span></span>
<span class="line"><span style="color:#24292E;">			3) </span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">read</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Do you really want to remove OpenVPN? [y/N]: &quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">REMOVE</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$REMOVE</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;y&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$REMOVE</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Y&#39;</span><span style="color:#24292E;"> ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">				PORT</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> &#39;^port &#39; /etc/openvpn/server/server.conf </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">cut</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-d</span><span style="color:#032F62;"> &quot; &quot; </span><span style="color:#005CC5;">-f</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">)</span></span>
<span class="line"><span style="color:#24292E;">				PROTOCOL</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> &#39;^proto &#39; /etc/openvpn/server/server.conf </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">cut</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-d</span><span style="color:#032F62;"> &quot; &quot; </span><span style="color:#005CC5;">-f</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">)</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pgrep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">firewalld</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">					IP</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">firewall-cmd</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">--direct</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">--get-rules</span><span style="color:#032F62;"> ipv4 nat POSTROUTING </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> &#39;\\-s 10.8.0.0/24 &#39;&quot;&#39;&quot;&#39;!&#39;&quot;&#39;&quot;&#39; -d 10.8.0.0/24 -j SNAT --to &#39; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">cut</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-d</span><span style="color:#032F62;"> &quot; &quot; </span><span style="color:#005CC5;">-f</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">)</span></span>
<span class="line"><span style="color:#24292E;">					</span><span style="color:#6A737D;"># Using both permanent and not permanent rules to avoid a firewalld reload.</span></span>
<span class="line"><span style="color:#24292E;">					</span><span style="color:#6F42C1;">firewall-cmd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--remove-port=</span><span style="color:#24292E;">$PORT</span><span style="color:#005CC5;">/</span><span style="color:#24292E;">$PROTOCOL</span></span>
<span class="line"><span style="color:#24292E;">					</span><span style="color:#6F42C1;">firewall-cmd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--zone=trusted</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--remove-source=10.8.0.0/24</span></span>
<span class="line"><span style="color:#24292E;">					</span><span style="color:#6F42C1;">firewall-cmd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--permanent</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--remove-port=</span><span style="color:#24292E;">$PORT</span><span style="color:#005CC5;">/</span><span style="color:#24292E;">$PROTOCOL</span></span>
<span class="line"><span style="color:#24292E;">					</span><span style="color:#6F42C1;">firewall-cmd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--permanent</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--zone=trusted</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--remove-source=10.8.0.0/24</span></span>
<span class="line"><span style="color:#24292E;">					</span><span style="color:#6F42C1;">firewall-cmd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--direct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--remove-rule</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ipv4</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">POSTROUTING</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-s</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.8</span><span style="color:#032F62;">.0.0/24</span><span style="color:#24292E;"> </span><span style="color:#032F62;">!</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.8</span><span style="color:#032F62;">.0.0/24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-j</span><span style="color:#24292E;"> </span><span style="color:#032F62;">SNAT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--to</span><span style="color:#24292E;"> $IP</span></span>
<span class="line"><span style="color:#24292E;">					</span><span style="color:#6F42C1;">firewall-cmd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--permanent</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--direct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--remove-rule</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ipv4</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">POSTROUTING</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-s</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.8</span><span style="color:#032F62;">.0.0/24</span><span style="color:#24292E;"> </span><span style="color:#032F62;">!</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.8</span><span style="color:#032F62;">.0.0/24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-j</span><span style="color:#24292E;"> </span><span style="color:#032F62;">SNAT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--to</span><span style="color:#24292E;"> $IP</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">					</span><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">disable</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openvpn-iptables.service</span></span>
<span class="line"><span style="color:#24292E;">					</span><span style="color:#6F42C1;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/systemd/system/openvpn-iptables.service</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sestatus</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;</span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Current mode&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-q</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;enforcing&quot;</span><span style="color:#24292E;"> &amp;&amp; [[ </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$PORT</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;1194&#39;</span><span style="color:#24292E;"> ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">					</span><span style="color:#6F42C1;">semanage</span><span style="color:#24292E;"> </span><span style="color:#032F62;">port</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openvpn_port_t</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> $PROTOCOL $PORT</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">disable</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openvpn-server@server.service</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6F42C1;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-rf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6F42C1;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/systemd/system/openvpn-server@server.service.d/disable-limitnproc.conf</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6F42C1;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/sysctl.d/30-openvpn-forward.conf</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$OS</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;debian&#39;</span><span style="color:#24292E;"> ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">					</span><span style="color:#6F42C1;">apt-get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">remove</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--purge</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openvpn</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">					</span><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">remove</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openvpn</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;OpenVPN removed!&quot;</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Removal aborted!&quot;</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">exit</span></span>
<span class="line"><span style="color:#24292E;">			;;</span></span>
<span class="line"><span style="color:#24292E;">			4) exit;;</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">esac</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">done</span></span>
<span class="line"><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">clear</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Welcome to this OpenVPN &quot;road warrior&quot; installer!&#39;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># OpenVPN setup and first user creation</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;I need to ask you a few questions before starting the setup.&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;You can leave the default options and just press enter if you are ok with them.&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;First, provide the IPv4 address of the network interface you want OpenVPN&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;listening to.&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># Autodetect IP address and pre-fill for the user</span></span>
<span class="line"><span style="color:#24292E;">	IP</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">ip</span><span style="color:#032F62;"> addr </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> &#39;inet&#39; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-v</span><span style="color:#032F62;"> inet6 </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-vE</span><span style="color:#032F62;"> &#39;127\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}&#39; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-oE</span><span style="color:#032F62;"> &#39;[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}&#39; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">head</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-1</span><span style="color:#032F62;">)</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">read</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;IP address: &quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-i</span><span style="color:#24292E;"> $IP </span><span style="color:#032F62;">IP</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">#If $IP is a private IP address, the server must be behind NAT</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$IP</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-qE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;^(10\\.|172\\.1[6789]\\.|172\\.2[0-9]\\.|172\\.3[01]\\.|192\\.168)&#39;</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;This server is behind NAT. What is the public IPv4 address or hostname?&quot;</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">read</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Public IP address / hostname: &quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PUBLICIP</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Which protocol do you want for OpenVPN connections?&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;   1) UDP (recommended)&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;   2) TCP&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">read</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Protocol [1-2]: &quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-i</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PROTOCOL</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> $PROTOCOL </span><span style="color:#D73A49;">in</span></span>
<span class="line"><span style="color:#24292E;">		1) </span></span>
<span class="line"><span style="color:#24292E;">		PROTOCOL</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">udp</span></span>
<span class="line"><span style="color:#24292E;">		;;</span></span>
<span class="line"><span style="color:#24292E;">		2) </span></span>
<span class="line"><span style="color:#24292E;">		PROTOCOL</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp</span></span>
<span class="line"><span style="color:#24292E;">		;;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">esac</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;What port do you want OpenVPN listening to?&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">read</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Port: &quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-i</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1194</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PORT</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Which DNS do you want to use with the VPN?&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;   1) Current system resolvers&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;   2) 1.1.1.1&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;   3) Google&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;   4) OpenDNS&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;   5) Verisign&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">read</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;DNS [1-5]: &quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-i</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">DNS</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Finally, tell me your name for the client certificate.&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Please, use one word only, no special characters.&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">read</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Client name: &quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-i</span><span style="color:#24292E;"> </span><span style="color:#032F62;">client</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CLIENT</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Okay, that was all I needed. We are ready to set up your OpenVPN server now.&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">read</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-r</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Press any key to continue...&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># If running inside a container, disable LimitNPROC to prevent conflicts</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">systemd-detect-virt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-cq</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/systemd/system/openvpn-server@server.service.d/</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;</span><span style="color:#032F62;">/dev/null</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;[Service]</span></span>
<span class="line"><span style="color:#032F62;">LimitNPROC=infinity&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/systemd/system/openvpn-server@server.service.d/disable-limitnproc.conf</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$OS</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;debian&#39;</span><span style="color:#24292E;"> ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">apt-get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">update</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">apt-get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openvpn</span><span style="color:#24292E;"> </span><span style="color:#032F62;">iptables</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ca-certificates</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;"># Else, the distro is CentOS</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">epel-release</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openvpn</span><span style="color:#24292E;"> </span><span style="color:#032F62;">iptables</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ca-certificates</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># Get easy-rsa</span></span>
<span class="line"><span style="color:#24292E;">	EASYRSAURL</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.5/EasyRSA-nix-3.0.5.tgz&#39;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-O</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/easyrsa.tgz</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$EASYRSAURL</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;</span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-Lo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/easyrsa.tgz</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$EASYRSAURL</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">tar</span><span style="color:#24292E;"> </span><span style="color:#032F62;">xzf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/easyrsa.tgz</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-C</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/EasyRSA-3.0.5/</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/EasyRSA-3.0.5/</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/easy-rsa/</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">chown</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-R</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root:root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/easy-rsa/</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/easyrsa.tgz</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/easy-rsa/</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># Create the PKI, set up the CA and the server and client certificates</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">./easyrsa</span><span style="color:#24292E;"> </span><span style="color:#032F62;">init-pki</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">./easyrsa</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--batch</span><span style="color:#24292E;"> </span><span style="color:#032F62;">build-ca</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nopass</span></span>
<span class="line"><span style="color:#24292E;">	EASYRSA_CERT_EXPIRE</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3650</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">./easyrsa</span><span style="color:#24292E;"> </span><span style="color:#032F62;">build-server-full</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nopass</span></span>
<span class="line"><span style="color:#24292E;">	EASYRSA_CERT_EXPIRE</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3650</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">./easyrsa</span><span style="color:#24292E;"> </span><span style="color:#032F62;">build-client-full</span><span style="color:#24292E;"> $CLIENT </span><span style="color:#032F62;">nopass</span></span>
<span class="line"><span style="color:#24292E;">	EASYRSA_CRL_DAYS</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3650</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">./easyrsa</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gen-crl</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># Move the stuff we need</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">cp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pki/ca.crt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pki/private/ca.key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pki/issued/server.crt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pki/private/server.key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pki/crl.pem</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># CRL is read with each client connection, when OpenVPN is dropped to nobody</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">chown</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nobody:</span><span style="color:#24292E;">$GROUPNAME </span><span style="color:#032F62;">/etc/openvpn/server/crl.pem</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># Generate key for tls-auth</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">openvpn</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--genkey</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--secret</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/ta.key</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># Create the DH parameters file using the predefined ffdhe2048 group</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;-----BEGIN DH PARAMETERS-----</span></span>
<span class="line"><span style="color:#032F62;">MIIBCAKCAQEA//////////+t+FRYortKmq/cViAnPTzx2LnFg84tNpWp4TZBFGQz</span></span>
<span class="line"><span style="color:#032F62;">+8yTnc4kmz75fS/jY2MMddj2gbICrsRhetPfHtXV/WVhJDP1H18GbtCFY2VVPe0a</span></span>
<span class="line"><span style="color:#032F62;">87VXE15/V8k1mE8McODmi3fipona8+/och3xWKE2rec1MKzKT0g6eXq8CrGCsyT7</span></span>
<span class="line"><span style="color:#032F62;">YdEIqUuyyOP7uWrat2DX9GgdT0Kj3jlN9K5W7edjcrsZCwenyO4KbXCeAvzhzffi</span></span>
<span class="line"><span style="color:#032F62;">7MA0BM0oNC9hkXL+nOmFg/+OTxIy7vKBg8P+OxtMb61zO7X8vC7CIAXFjvGDfRaD</span></span>
<span class="line"><span style="color:#032F62;">ssbzSibBsu/6iGtCOGEoXJf//////////wIBAg==</span></span>
<span class="line"><span style="color:#032F62;">-----END DH PARAMETERS-----&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/dh.pem</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># Generate server.conf</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;port </span><span style="color:#24292E;">$PORT</span></span>
<span class="line"><span style="color:#032F62;">proto </span><span style="color:#24292E;">$PROTOCOL</span></span>
<span class="line"><span style="color:#032F62;">dev tun</span></span>
<span class="line"><span style="color:#032F62;">sndbuf 0</span></span>
<span class="line"><span style="color:#032F62;">rcvbuf 0</span></span>
<span class="line"><span style="color:#032F62;">ca ca.crt</span></span>
<span class="line"><span style="color:#032F62;">cert server.crt</span></span>
<span class="line"><span style="color:#032F62;">key server.key</span></span>
<span class="line"><span style="color:#032F62;">dh dh.pem</span></span>
<span class="line"><span style="color:#032F62;">auth SHA512</span></span>
<span class="line"><span style="color:#032F62;">tls-auth ta.key 0</span></span>
<span class="line"><span style="color:#032F62;">topology subnet</span></span>
<span class="line"><span style="color:#032F62;">server 10.8.0.0 255.255.255.0</span></span>
<span class="line"><span style="color:#032F62;">ifconfig-pool-persist ipp.txt&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;push &quot;redirect-gateway def1 bypass-dhcp&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># DNS</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> $DNS </span><span style="color:#D73A49;">in</span></span>
<span class="line"><span style="color:#24292E;">		1)</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;"># Locate the proper resolv.conf</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;"># Needed for systems running systemd-resolved</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-q</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;127.0.0.53&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/etc/resolv.conf&quot;</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">			RESOLVCONF</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;/run/systemd/resolve/resolv.conf&#39;</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">			RESOLVCONF</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;/etc/resolv.conf&#39;</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;"># Obtain the resolvers from resolv.conf and use them for OpenVPN</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-v</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;#&#39;</span><span style="color:#24292E;"> $RESOLVCONF </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;nameserver&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-E</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">read</span><span style="color:#24292E;"> </span><span style="color:#032F62;">line</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;push </span><span style="color:#005CC5;">\\&quot;</span><span style="color:#032F62;">dhcp-option DNS </span><span style="color:#24292E;">$line</span><span style="color:#005CC5;">\\&quot;</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">done</span></span>
<span class="line"><span style="color:#24292E;">		;;</span></span>
<span class="line"><span style="color:#24292E;">		2)</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;push &quot;dhcp-option DNS 1.1.1.1&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;push &quot;dhcp-option DNS 1.0.0.1&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#24292E;">		;;</span></span>
<span class="line"><span style="color:#24292E;">		3)</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;push &quot;dhcp-option DNS 8.8.8.8&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;push &quot;dhcp-option DNS 8.8.4.4&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#24292E;">		;;</span></span>
<span class="line"><span style="color:#24292E;">		4)</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;push &quot;dhcp-option DNS 208.67.222.222&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;push &quot;dhcp-option DNS 208.67.220.220&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#24292E;">		;;</span></span>
<span class="line"><span style="color:#24292E;">		5)</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;push &quot;dhcp-option DNS 64.6.64.6&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;push &quot;dhcp-option DNS 64.6.65.6&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#24292E;">		;;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">esac</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;keepalive 10 120</span></span>
<span class="line"><span style="color:#032F62;">cipher AES-256-CBC</span></span>
<span class="line"><span style="color:#032F62;">user nobody</span></span>
<span class="line"><span style="color:#032F62;">group </span><span style="color:#24292E;">$GROUPNAME</span></span>
<span class="line"><span style="color:#032F62;">persist-key</span></span>
<span class="line"><span style="color:#032F62;">persist-tun</span></span>
<span class="line"><span style="color:#032F62;">status openvpn-status.log</span></span>
<span class="line"><span style="color:#032F62;">verb 3</span></span>
<span class="line"><span style="color:#032F62;">crl-verify crl.pem&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/server.conf</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># Enable net.ipv4.ip_forward for the system</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;net.ipv4.ip_forward=1&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/sysctl.d/30-openvpn-forward.conf</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># Enable without waiting for a reboot or service restart</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/proc/sys/net/ipv4/ip_forward</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pgrep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">firewalld</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;"># Using both permanent and not permanent rules to avoid a firewalld</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;"># reload.</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;"># We don&#39;t use --add-service=openvpn because that would only work with</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;"># the default port and protocol.</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">firewall-cmd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--add-port=</span><span style="color:#24292E;">$PORT</span><span style="color:#005CC5;">/</span><span style="color:#24292E;">$PROTOCOL</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">firewall-cmd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--zone=trusted</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--add-source=10.8.0.0/24</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">firewall-cmd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--permanent</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--add-port=</span><span style="color:#24292E;">$PORT</span><span style="color:#005CC5;">/</span><span style="color:#24292E;">$PROTOCOL</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">firewall-cmd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--permanent</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--zone=trusted</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--add-source=10.8.0.0/24</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;"># Set NAT for the VPN subnet</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">firewall-cmd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--direct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--add-rule</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ipv4</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">POSTROUTING</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-s</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.8</span><span style="color:#032F62;">.0.0/24</span><span style="color:#24292E;"> </span><span style="color:#032F62;">!</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.8</span><span style="color:#032F62;">.0.0/24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-j</span><span style="color:#24292E;"> </span><span style="color:#032F62;">SNAT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--to</span><span style="color:#24292E;"> $IP</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">firewall-cmd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--permanent</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--direct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--add-rule</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ipv4</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">POSTROUTING</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-s</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.8</span><span style="color:#032F62;">.0.0/24</span><span style="color:#24292E;"> </span><span style="color:#032F62;">!</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.8</span><span style="color:#032F62;">.0.0/24</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-j</span><span style="color:#24292E;"> </span><span style="color:#032F62;">SNAT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--to</span><span style="color:#24292E;"> $IP</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;"># Create a service to set up persistent iptables rules</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;[Unit]</span></span>
<span class="line"><span style="color:#032F62;">Before=network.target</span></span>
<span class="line"><span style="color:#032F62;">[Service]</span></span>
<span class="line"><span style="color:#032F62;">Type=oneshot</span></span>
<span class="line"><span style="color:#032F62;">ExecStart=/sbin/iptables -t nat -A POSTROUTING -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to </span><span style="color:#24292E;">$IP</span></span>
<span class="line"><span style="color:#032F62;">ExecStart=/sbin/iptables -I INPUT -p </span><span style="color:#24292E;">$PROTOCOL</span><span style="color:#032F62;"> --dport </span><span style="color:#24292E;">$PORT</span><span style="color:#032F62;"> -j ACCEPT</span></span>
<span class="line"><span style="color:#032F62;">ExecStart=/sbin/iptables -I FORWARD -s 10.8.0.0/24 -j ACCEPT</span></span>
<span class="line"><span style="color:#032F62;">ExecStart=/sbin/iptables -I FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT</span></span>
<span class="line"><span style="color:#032F62;">ExecStop=/sbin/iptables -t nat -D POSTROUTING -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to </span><span style="color:#24292E;">$IP</span></span>
<span class="line"><span style="color:#032F62;">ExecStop=/sbin/iptables -D INPUT -p </span><span style="color:#24292E;">$PROTOCOL</span><span style="color:#032F62;"> --dport </span><span style="color:#24292E;">$PORT</span><span style="color:#032F62;"> -j ACCEPT</span></span>
<span class="line"><span style="color:#032F62;">ExecStop=/sbin/iptables -D FORWARD -s 10.8.0.0/24 -j ACCEPT</span></span>
<span class="line"><span style="color:#032F62;">ExecStop=/sbin/iptables -D FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT</span></span>
<span class="line"><span style="color:#032F62;">RemainAfterExit=yes</span></span>
<span class="line"><span style="color:#032F62;">[Install]</span></span>
<span class="line"><span style="color:#032F62;">WantedBy=multi-user.target&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/systemd/system/openvpn-iptables.service</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openvpn-iptables.service</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># If SELinux is enabled and a custom port was selected, we need this</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sestatus</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;</span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Current mode&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-q</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;enforcing&quot;</span><span style="color:#24292E;"> &amp;&amp; [[ </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$PORT</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;1194&#39;</span><span style="color:#24292E;"> ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;"># Install semanage if not already present</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">hash</span><span style="color:#24292E;"> </span><span style="color:#032F62;">semanage</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;</span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-qs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;CentOS Linux release 7&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/etc/centos-release&quot;</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">policycoreutils-python</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">policycoreutils-python-utils</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6F42C1;">semanage</span><span style="color:#24292E;"> </span><span style="color:#032F62;">port</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-a</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openvpn_port_t</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> $PROTOCOL $PORT</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># And finally, enable and start the OpenVPN service</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openvpn-server@server.service</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># If the server is behind a NAT, use the correct IP address</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$PUBLICIP</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">		IP</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">$PUBLICIP</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># client-common.txt is created so we have a template to add further users later</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;client</span></span>
<span class="line"><span style="color:#032F62;">dev tun</span></span>
<span class="line"><span style="color:#032F62;">proto </span><span style="color:#24292E;">$PROTOCOL</span></span>
<span class="line"><span style="color:#032F62;">sndbuf 0</span></span>
<span class="line"><span style="color:#032F62;">rcvbuf 0</span></span>
<span class="line"><span style="color:#032F62;">remote </span><span style="color:#24292E;">$IP</span><span style="color:#032F62;"> </span><span style="color:#24292E;">$PORT</span></span>
<span class="line"><span style="color:#032F62;">resolv-retry infinite</span></span>
<span class="line"><span style="color:#032F62;">nobind</span></span>
<span class="line"><span style="color:#032F62;">persist-key</span></span>
<span class="line"><span style="color:#032F62;">persist-tun</span></span>
<span class="line"><span style="color:#032F62;">remote-cert-tls server</span></span>
<span class="line"><span style="color:#032F62;">auth SHA512</span></span>
<span class="line"><span style="color:#032F62;">cipher AES-256-CBC</span></span>
<span class="line"><span style="color:#032F62;">setenv opt block-outside-dns</span></span>
<span class="line"><span style="color:#032F62;">key-direction 1</span></span>
<span class="line"><span style="color:#032F62;">verb 3&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/openvpn/server/client-common.txt</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;"># Generates the custom client.ovpn</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">newclient</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$CLIENT</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Finished!&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Your client configuration is available at:&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/&quot;</span><span style="color:#24292E;">$CLIENT</span><span style="color:#032F62;">.ovpn&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;If you want to add more clients, you simply need to run this script again!&quot;</span></span>
<span class="line"><span style="color:#D73A49;">fi</span></span></code></pre></div>`,1),e=[o];function t(c,r,E,y,F,i){return n(),a("div",null,e)}const u=s(l,[["render",t]]);export{B as __pageData,u as default};
