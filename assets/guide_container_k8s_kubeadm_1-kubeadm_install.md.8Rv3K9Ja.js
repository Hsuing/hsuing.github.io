import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const u=JSON.parse('{"title":"0.环境","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/kubeadm/1-kubeadm_install.md","filePath":"guide/container/k8s/kubeadm/1-kubeadm_install.md","lastUpdated":1730196597000}'),p={name:"guide/container/k8s/kubeadm/1-kubeadm_install.md"},o=l(`<h1 id="_0-环境" tabindex="-1">0.环境 <a class="header-anchor" href="#_0-环境" aria-label="Permalink to &quot;0.环境&quot;">​</a></h1><h3 id="_1-软件版本" tabindex="-1">1.软件版本 <a class="header-anchor" href="#_1-软件版本" aria-label="Permalink to &quot;1.软件版本&quot;">​</a></h3><table><thead><tr><th>系统</th><th>版本</th></tr></thead><tbody><tr><td>centos</td><td>7.9(内核采用4.19)</td></tr><tr><td>docker</td><td>20.10.15</td></tr><tr><td>kubeadm</td><td>1.22.17</td></tr></tbody></table><h3 id="_2-ip划分" tabindex="-1">2.ip划分 <a class="header-anchor" href="#_2-ip划分" aria-label="Permalink to &quot;2.ip划分&quot;">​</a></h3><table><thead><tr><th>主机名</th><th>ip地址</th><th>系统配置</th></tr></thead><tbody><tr><td>slb</td><td>10.103.236.236</td><td>1core_2g</td></tr><tr><td>kubeadm-master</td><td>10.103.236.201</td><td>2core_2g</td></tr><tr><td>kubeadm-node01</td><td>10.103.236.202</td><td>1core_2g</td></tr><tr><td>kubeadm-node02</td><td>10.103.236.203</td><td>1core_2g</td></tr><tr><td>kubeadm-node03</td><td>10.103.236.204</td><td>1core_2g</td></tr><tr><td>pod网段</td><td>172.16.0.0/12</td><td></td></tr><tr><td>service网段</td><td>192.168.0.0/16</td><td></td></tr><tr><td>host网段</td><td>10.103.236.0/12</td><td></td></tr></tbody></table><h3 id="_3-图" tabindex="-1">3.图 <a class="header-anchor" href="#_3-图" aria-label="Permalink to &quot;3.图&quot;">​</a></h3><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202404091646839.png" alt="image-20240409164629612"></p><h3 id="_4-port" tabindex="-1">4. Port <a class="header-anchor" href="#_4-port" aria-label="Permalink to &quot;4. Port&quot;">​</a></h3><p>Control-plane node(s)</p><table><thead><tr><th>Protocol</th><th>Direction</th><th>Port Range</th><th>Purpose</th><th>Used By</th></tr></thead><tbody><tr><td>TCP</td><td>Inbound</td><td>6443*</td><td>KubernetesAPlserver</td><td>AII</td></tr><tr><td>TCP</td><td>Inbound</td><td>2379-2380</td><td>etcd server client API</td><td>kube-apiserver,etd</td></tr><tr><td>TCP</td><td>Inbound</td><td>10250</td><td>Kubelet API</td><td>Self,Control plane</td></tr><tr><td>TCP</td><td>Inbound</td><td>10251</td><td>kube-scheduler</td><td>Self</td></tr><tr><td>TCP</td><td>Inbound</td><td>10252(高版本之后1.22，10257)</td><td>kube-controller-manager</td><td>Self</td></tr></tbody></table><p>Worker node(s)</p><table><thead><tr><th>TCP</th><th>Inbound</th><th>10250</th><th>Kubelet API</th><th>Self,Controlplane</th></tr></thead><tbody><tr><td>TCP</td><td>Inbound</td><td>30000-32767</td><td>NodePort Services</td><td>AII</td></tr></tbody></table><h1 id="_1-配置kubeadm源" tabindex="-1">1.配置kubeadm源 <a class="header-anchor" href="#_1-配置kubeadm源" aria-label="Permalink to &quot;1.配置kubeadm源&quot;">​</a></h1><h2 id="_1-1安装依赖" tabindex="-1">1.1安装依赖 <a class="header-anchor" href="#_1-1安装依赖" aria-label="Permalink to &quot;1.1安装依赖&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yum-utils</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">device-mapper-persistent-data</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">lvm2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">jq</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">psmisc</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">net-tools</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">telnet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yum-utils</span><span style="color:#24292E;"> </span><span style="color:#032F62;">device-mapper-persistent-data</span><span style="color:#24292E;"> </span><span style="color:#032F62;">lvm2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wget</span><span style="color:#24292E;"> </span><span style="color:#032F62;">jq</span><span style="color:#24292E;"> </span><span style="color:#032F62;">psmisc</span><span style="color:#24292E;"> </span><span style="color:#032F62;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">net-tools</span><span style="color:#24292E;"> </span><span style="color:#032F62;">telnet</span></span></code></pre></div><h2 id="_1-2配置aliyun源" tabindex="-1">1.2配置aliyun源 <a class="header-anchor" href="#_1-2配置aliyun源" aria-label="Permalink to &quot;1.2配置aliyun源&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/yum.repos.d/CentOS-Base.repo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://mirrors.aliyun.com/repo/Centos-7.repo</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#修改地址</span></span>
<span class="line"><span style="color:#B392F0;">sed</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-i</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;/mirrors.cloud.aliyuncs.com/d&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;/mirrors.aliyuncs.com/d&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/yum.repos.d/CentOS-Base.repo</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/yum.repos.d/CentOS-Base.repo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://mirrors.aliyun.com/repo/Centos-7.repo</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#修改地址</span></span>
<span class="line"><span style="color:#6F42C1;">sed</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-i</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;/mirrors.cloud.aliyuncs.com/d&#39;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;/mirrors.aliyuncs.com/d&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/yum.repos.d/CentOS-Base.repo</span></span></code></pre></div><h2 id="_1-3配置docker源" tabindex="-1">1.3配置docker源 <a class="header-anchor" href="#_1-3配置docker源" aria-label="Permalink to &quot;1.3配置docker源&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">yum-config-manager</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--add-repo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">yum-config-manager</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--add-repo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span></code></pre></div><h2 id="_1-4配置kubernetes源" tabindex="-1">1.4配置kubernetes源 <a class="header-anchor" href="#_1-4配置kubernetes源" aria-label="Permalink to &quot;1.4配置kubernetes源&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> /etc/yum.repos.d/kubernetes.repo</span></span>
<span class="line"><span style="color:#9ECBFF;">[kubernetes]</span></span>
<span class="line"><span style="color:#9ECBFF;">name=Kubernetes</span></span>
<span class="line"><span style="color:#9ECBFF;">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span>
<span class="line"><span style="color:#9ECBFF;">enabled=1</span></span>
<span class="line"><span style="color:#9ECBFF;">gpgcheck=0</span></span>
<span class="line"><span style="color:#9ECBFF;">repo_gpgcheck=0</span></span>
<span class="line"><span style="color:#9ECBFF;">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> /etc/yum.repos.d/kubernetes.repo</span></span>
<span class="line"><span style="color:#032F62;">[kubernetes]</span></span>
<span class="line"><span style="color:#032F62;">name=Kubernetes</span></span>
<span class="line"><span style="color:#032F62;">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span>
<span class="line"><span style="color:#032F62;">enabled=1</span></span>
<span class="line"><span style="color:#032F62;">gpgcheck=0</span></span>
<span class="line"><span style="color:#032F62;">repo_gpgcheck=0</span></span>
<span class="line"><span style="color:#032F62;">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span></code></pre></div><h1 id="_2-基本环境配置" tabindex="-1">2.基本环境配置 <a class="header-anchor" href="#_2-基本环境配置" aria-label="Permalink to &quot;2.基本环境配置&quot;">​</a></h1><p>文档，<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" target="_blank" rel="noreferrer">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a></p><h2 id="_2-1-关闭selinux等" tabindex="-1">2.1 关闭selinux等 <a class="header-anchor" href="#_2-1-关闭selinux等" aria-label="Permalink to &quot;2.1 关闭selinux等&quot;">​</a></h2><p><strong>所有节点</strong>关闭防火墙、selinux、dnsmasq、swap</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">disable</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">firewalld</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">disable</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dnsmasq</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">disable</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">NetworkManager</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">setenforce</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">sed</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-i</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/sysconfig/selinux</span></span>
<span class="line"><span style="color:#B392F0;">sed</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-i</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/selinux/config</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">disable</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">firewalld</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">disable</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dnsmasq</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">disable</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">NetworkManager</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">setenforce</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">sed</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-i</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/sysconfig/selinux</span></span>
<span class="line"><span style="color:#6F42C1;">sed</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-i</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/selinux/config</span></span></code></pre></div><h2 id="_2-2-关闭swap" tabindex="-1">2.2 关闭swap <a class="header-anchor" href="#_2-2-关闭swap" aria-label="Permalink to &quot;2.2 关闭swap&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">swapoff</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-a</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">sysctl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-w</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">vm.swappiness=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">sed</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-ri</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;/^[^#]*swap/s@^@#@&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/fstab</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">swapoff</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-a</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">sysctl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-w</span><span style="color:#24292E;"> </span><span style="color:#032F62;">vm.swappiness=</span><span style="color:#005CC5;">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">sed</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-ri</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;/^[^#]*swap/s@^@#@&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/fstab</span></span></code></pre></div><h2 id="_2-3-时间同步" tabindex="-1">2.3 时间同步 <a class="header-anchor" href="#_2-3-时间同步" aria-label="Permalink to &quot;2.3 时间同步&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#安装服务</span></span>
<span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">chrony</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#启动服务</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">chronyd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#同步时间</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master yum.repos.d]# chronyc sources</span></span>
<span class="line"><span style="color:#B392F0;">210</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Number</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">of</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sources</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span></span>
<span class="line"><span style="color:#B392F0;">MS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Name/IP</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">address</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">Stratum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Poll</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Reach</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">LastRx</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Last</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sample</span></span>
<span class="line"><span style="color:#E1E4E8;">===============================================================================</span></span>
<span class="line"><span style="color:#B392F0;">^-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tock.ntp.infomaniak.ch</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">377</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">283</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">-10ms[  -10ms]</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+/-</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">87</span><span style="color:#9ECBFF;">ms</span></span>
<span class="line"><span style="color:#B392F0;">^-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ntp8.flashdance.cx</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">377</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">192</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">-18ms[  -18ms]</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+/-</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">154</span><span style="color:#9ECBFF;">ms</span></span>
<span class="line"><span style="color:#B392F0;">^*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">139.199</span><span style="color:#9ECBFF;">.215.251</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">377</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">859</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">-902us[ -511us]</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+/-</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">59</span><span style="color:#9ECBFF;">ms</span></span>
<span class="line"><span style="color:#B392F0;">^-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tick.ntp.infomaniak.ch</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">377</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">27</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">+26ms[</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">+26ms]</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+/-</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">133</span><span style="color:#9ECBFF;">ms</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#安装服务</span></span>
<span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">chrony</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#启动服务</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">chronyd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#同步时间</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master yum.repos.d]# chronyc sources</span></span>
<span class="line"><span style="color:#6F42C1;">210</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Number</span><span style="color:#24292E;"> </span><span style="color:#032F62;">of</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sources</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span></span>
<span class="line"><span style="color:#6F42C1;">MS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Name/IP</span><span style="color:#24292E;"> </span><span style="color:#032F62;">address</span><span style="color:#24292E;">         </span><span style="color:#032F62;">Stratum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Poll</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Reach</span><span style="color:#24292E;"> </span><span style="color:#032F62;">LastRx</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Last</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sample</span></span>
<span class="line"><span style="color:#24292E;">===============================================================================</span></span>
<span class="line"><span style="color:#6F42C1;">^-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tock.ntp.infomaniak.ch</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">377</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">283</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">-10ms[  -10ms]</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+/-</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">87</span><span style="color:#032F62;">ms</span></span>
<span class="line"><span style="color:#6F42C1;">^-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ntp8.flashdance.cx</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">377</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">192</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">-18ms[  -18ms]</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+/-</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">154</span><span style="color:#032F62;">ms</span></span>
<span class="line"><span style="color:#6F42C1;">^*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">139.199</span><span style="color:#032F62;">.215.251</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">377</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">859</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">-902us[ -511us]</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+/-</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">59</span><span style="color:#032F62;">ms</span></span>
<span class="line"><span style="color:#6F42C1;">^-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tick.ntp.infomaniak.ch</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">377</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">27</span><span style="color:#032F62;">m</span><span style="color:#24292E;">    </span><span style="color:#032F62;">+26ms[</span><span style="color:#24292E;">  </span><span style="color:#032F62;">+26ms]</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+/-</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">133</span><span style="color:#032F62;">ms</span></span></code></pre></div><ul><li>或者</li></ul><p>安装ntpdate</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">rpm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-ivh</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm</span></span>
<span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ntpdate</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#操作如下</span></span>
<span class="line"><span style="color:#B392F0;">ln</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-sf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/share/zoneinfo/Asia/Shanghai</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/localtime</span></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Asia/Shanghai&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">/etc/timezone</span></span>
<span class="line"><span style="color:#B392F0;">ntpdate</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">time2.aliyun.com</span></span>
<span class="line"><span style="color:#6A737D;"># 加入到crontab</span></span>
<span class="line"><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">/5 </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> /usr/sbin/ntpdate time2.aliyun.com</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">rpm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-ivh</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm</span></span>
<span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ntpdate</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#操作如下</span></span>
<span class="line"><span style="color:#6F42C1;">ln</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-sf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/share/zoneinfo/Asia/Shanghai</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/localtime</span></span>
<span class="line"><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Asia/Shanghai&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">/etc/timezone</span></span>
<span class="line"><span style="color:#6F42C1;">ntpdate</span><span style="color:#24292E;"> </span><span style="color:#032F62;">time2.aliyun.com</span></span>
<span class="line"><span style="color:#6A737D;"># 加入到crontab</span></span>
<span class="line"><span style="color:#D73A49;">*</span><span style="color:#24292E;">/5 </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> /usr/sbin/ntpdate time2.aliyun.com</span></span></code></pre></div><h2 id="_2-4-limit配置" tabindex="-1">2.4 limit配置 <a class="header-anchor" href="#_2-4-limit配置" aria-label="Permalink to &quot;2.4 limit配置&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79B8FF;">ulimit</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-SHn</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">65535</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#添加配置文件</span></span>
<span class="line"><span style="color:#B392F0;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/security/limits.conf</span></span>
<span class="line"><span style="color:#6A737D;"># 末尾添加如下内容</span></span>
<span class="line"><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> soft nofile 65536</span></span>
<span class="line"><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> hard nofile 131072</span></span>
<span class="line"><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> soft nproc 65535</span></span>
<span class="line"><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> hard nproc 655350</span></span>
<span class="line"><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> soft memlock unlimited</span></span>
<span class="line"><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> hard memlock unlimited</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005CC5;">ulimit</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-SHn</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">65535</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#添加配置文件</span></span>
<span class="line"><span style="color:#6F42C1;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/security/limits.conf</span></span>
<span class="line"><span style="color:#6A737D;"># 末尾添加如下内容</span></span>
<span class="line"><span style="color:#D73A49;">*</span><span style="color:#24292E;"> soft nofile 65536</span></span>
<span class="line"><span style="color:#D73A49;">*</span><span style="color:#24292E;"> hard nofile 131072</span></span>
<span class="line"><span style="color:#D73A49;">*</span><span style="color:#24292E;"> soft nproc 65535</span></span>
<span class="line"><span style="color:#D73A49;">*</span><span style="color:#24292E;"> hard nproc 655350</span></span>
<span class="line"><span style="color:#D73A49;">*</span><span style="color:#24292E;"> soft memlock unlimited</span></span>
<span class="line"><span style="color:#D73A49;">*</span><span style="color:#24292E;"> hard memlock unlimited</span></span></code></pre></div><h2 id="_2-5-内核配置" tabindex="-1">2.5 内核配置 <a class="header-anchor" href="#_2-5-内核配置" aria-label="Permalink to &quot;2.5 内核配置&quot;">​</a></h2><h3 id="_1-升级内核" tabindex="-1">1.升级内核 <a class="header-anchor" href="#_1-升级内核" aria-label="Permalink to &quot;1.升级内核&quot;">​</a></h3><p>CentOS7 需要升级内核至4.18+，本地升级的版本为4.19，<strong>所有节点升级</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#下载</span></span>
<span class="line"><span style="color:#B392F0;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm</span></span>
<span class="line"><span style="color:#B392F0;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#安装</span></span>
<span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localinstall</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kernel-ml</span><span style="color:#79B8FF;">*</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#更改内核启动顺序</span></span>
<span class="line"><span style="color:#B392F0;">grub2-set-default</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">grub2-mkconfig</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/grub2.cfg</span></span>
<span class="line"><span style="color:#B392F0;">grubby</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--args=</span><span style="color:#9ECBFF;">&quot;user_namespace.enable=1&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--update-kernel=</span><span style="color:#9ECBFF;">&quot;$(</span><span style="color:#B392F0;">grubby</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">--default-kernel</span><span style="color:#9ECBFF;">)&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看内核启动版本</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master yum.repos.d]# grubby --default-kernel</span></span>
<span class="line"><span style="color:#B392F0;">/boot/vmlinuz-4.19.12-1.el7.elrepo.x86_64</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#启动所有节点</span></span>
<span class="line"><span style="color:#B392F0;">reboot</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看版本</span></span>
<span class="line"><span style="color:#B392F0;">uname</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-a</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#下载</span></span>
<span class="line"><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm</span></span>
<span class="line"><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#安装</span></span>
<span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localinstall</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kernel-ml</span><span style="color:#005CC5;">*</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#更改内核启动顺序</span></span>
<span class="line"><span style="color:#6F42C1;">grub2-set-default</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">grub2-mkconfig</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/grub2.cfg</span></span>
<span class="line"><span style="color:#6F42C1;">grubby</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--args=</span><span style="color:#032F62;">&quot;user_namespace.enable=1&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--update-kernel=</span><span style="color:#032F62;">&quot;$(</span><span style="color:#6F42C1;">grubby</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">--default-kernel</span><span style="color:#032F62;">)&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看内核启动版本</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master yum.repos.d]# grubby --default-kernel</span></span>
<span class="line"><span style="color:#6F42C1;">/boot/vmlinuz-4.19.12-1.el7.elrepo.x86_64</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#启动所有节点</span></span>
<span class="line"><span style="color:#6F42C1;">reboot</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看版本</span></span>
<span class="line"><span style="color:#6F42C1;">uname</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-a</span></span></code></pre></div><h3 id="_2-安装ipvsadm" tabindex="-1">2.安装ipvsadm <a class="header-anchor" href="#_2-安装ipvsadm" aria-label="Permalink to &quot;2.安装ipvsadm&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ipvsadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ipset</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sysstat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">conntrack</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">libseccomp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ipvsadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ipset</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sysstat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">conntrack</span><span style="color:#24292E;"> </span><span style="color:#032F62;">libseccomp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span></code></pre></div><ul><li>配置ipvs模块</li></ul><p>在内核4.19+版本nf_conntrack_ipv4已经改为nf_conntrack</p><p>在内核4.18以下使用nf_conntrack_ipv4</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/modules-load.d/ipvs.conf</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;"># 加入以下内容</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_lc</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_wlc</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_rr</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_wrr</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_lblc</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_lblcr</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_dh</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_sh</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_fo</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_nq</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_sed</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_ftp</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_sh</span></span>
<span class="line"><span style="color:#B392F0;">nf_conntrack</span></span>
<span class="line"><span style="color:#B392F0;">ip_tables</span></span>
<span class="line"><span style="color:#B392F0;">ip_set</span></span>
<span class="line"><span style="color:#B392F0;">xt_set</span></span>
<span class="line"><span style="color:#B392F0;">ipt_set</span></span>
<span class="line"><span style="color:#B392F0;">ipt_rpfilter</span></span>
<span class="line"><span style="color:#B392F0;">ipt_REJECT</span></span>
<span class="line"><span style="color:#B392F0;">ipip</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#启动</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemd-modules-load.service</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/modules-load.d/ipvs.conf</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;"># 加入以下内容</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_lc</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_wlc</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_rr</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_wrr</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_lblc</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_lblcr</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_dh</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_sh</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_fo</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_nq</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_sed</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_ftp</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_sh</span></span>
<span class="line"><span style="color:#6F42C1;">nf_conntrack</span></span>
<span class="line"><span style="color:#6F42C1;">ip_tables</span></span>
<span class="line"><span style="color:#6F42C1;">ip_set</span></span>
<span class="line"><span style="color:#6F42C1;">xt_set</span></span>
<span class="line"><span style="color:#6F42C1;">ipt_set</span></span>
<span class="line"><span style="color:#6F42C1;">ipt_rpfilter</span></span>
<span class="line"><span style="color:#6F42C1;">ipt_REJECT</span></span>
<span class="line"><span style="color:#6F42C1;">ipip</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#启动</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemd-modules-load.service</span></span></code></pre></div><ul><li>或者其他方式</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#启动时能自动加载模块</span></span>
<span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/sysconfig/modules/ipvs.modules</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#9ECBFF;">#!/bin/bash</span></span>
<span class="line"><span style="color:#9ECBFF;">modprobe -- ip_vs</span></span>
<span class="line"><span style="color:#9ECBFF;">modprobe -- ip_vs_rr</span></span>
<span class="line"><span style="color:#9ECBFF;">modprobe -- ip_vs_wrr</span></span>
<span class="line"><span style="color:#9ECBFF;">modprobe -- ip_vs_sh</span></span>
<span class="line"><span style="color:#9ECBFF;">modprobe -- nf_conntrack</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#授权</span></span>
<span class="line"><span style="color:#B392F0;">chmod</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">755</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/sysconfig/modules/ipvs.modules</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#执行</span></span>
<span class="line"><span style="color:#B392F0;">sh</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/sysconfig/modules/ipvs.modules</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master yum.repos.d]# lsmod </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ip_vs</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nf_conntrack</span></span>
<span class="line"><span style="color:#B392F0;">nf_conntrack_netlink</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">40960</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">nfnetlink</span><span style="color:#E1E4E8;">              </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nf_conntrack_netlink,ip_set</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_ftp</span><span style="color:#E1E4E8;">              </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">nf_nat</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">32768</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nf_nat_ipv4,ip_vs_ftp</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_sed</span><span style="color:#E1E4E8;">              </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_nq</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_fo</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_sh</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_dh</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_lblcr</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_lblc</span><span style="color:#E1E4E8;">             </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_wrr</span><span style="color:#E1E4E8;">              </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_rr</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_wlc</span><span style="color:#E1E4E8;">              </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs_lc</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">ip_vs</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">151552</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ip_vs_wlc,ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_fo,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed,ip_vs_ftp</span></span>
<span class="line"><span style="color:#B392F0;">nf_conntrack</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">143360</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">xt_conntrack,nf_nat,ipt_MASQUERADE,nf_nat_ipv4,nf_conntrack_netlink,ip_vs</span></span>
<span class="line"><span style="color:#B392F0;">nf_defrag_ipv6</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">20480</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nf_conntrack</span></span>
<span class="line"><span style="color:#B392F0;">nf_defrag_ipv4</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nf_conntrack</span></span>
<span class="line"><span style="color:#B392F0;">libcrc32c</span><span style="color:#E1E4E8;">              </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nf_conntrack,nf_nat,xfs,ip_vs</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#启动时能自动加载模块</span></span>
<span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/sysconfig/modules/ipvs.modules</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#032F62;">#!/bin/bash</span></span>
<span class="line"><span style="color:#032F62;">modprobe -- ip_vs</span></span>
<span class="line"><span style="color:#032F62;">modprobe -- ip_vs_rr</span></span>
<span class="line"><span style="color:#032F62;">modprobe -- ip_vs_wrr</span></span>
<span class="line"><span style="color:#032F62;">modprobe -- ip_vs_sh</span></span>
<span class="line"><span style="color:#032F62;">modprobe -- nf_conntrack</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#授权</span></span>
<span class="line"><span style="color:#6F42C1;">chmod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">755</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/sysconfig/modules/ipvs.modules</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#执行</span></span>
<span class="line"><span style="color:#6F42C1;">sh</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/sysconfig/modules/ipvs.modules</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master yum.repos.d]# lsmod </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ip_vs</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nf_conntrack</span></span>
<span class="line"><span style="color:#6F42C1;">nf_conntrack_netlink</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">40960</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">nfnetlink</span><span style="color:#24292E;">              </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nf_conntrack_netlink,ip_set</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_ftp</span><span style="color:#24292E;">              </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">nf_nat</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">32768</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nf_nat_ipv4,ip_vs_ftp</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_sed</span><span style="color:#24292E;">              </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_nq</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_fo</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_sh</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_dh</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_lblcr</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_lblc</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_wrr</span><span style="color:#24292E;">              </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_rr</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_wlc</span><span style="color:#24292E;">              </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs_lc</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">ip_vs</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">151552</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ip_vs_wlc,ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_fo,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed,ip_vs_ftp</span></span>
<span class="line"><span style="color:#6F42C1;">nf_conntrack</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">143360</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> </span><span style="color:#032F62;">xt_conntrack,nf_nat,ipt_MASQUERADE,nf_nat_ipv4,nf_conntrack_netlink,ip_vs</span></span>
<span class="line"><span style="color:#6F42C1;">nf_defrag_ipv6</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">20480</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nf_conntrack</span></span>
<span class="line"><span style="color:#6F42C1;">nf_defrag_ipv4</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nf_conntrack</span></span>
<span class="line"><span style="color:#6F42C1;">libcrc32c</span><span style="color:#24292E;">              </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nf_conntrack,nf_nat,xfs,ip_vs</span></span></code></pre></div><h3 id="_3-配置必要参数" tabindex="-1">3.配置必要参数 <a class="header-anchor" href="#_3-配置必要参数" aria-label="Permalink to &quot;3.配置必要参数&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> /etc/sysctl.d/k8s.conf</span></span>
<span class="line"><span style="color:#9ECBFF;">net.ipv4.ip_forward = 1</span></span>
<span class="line"><span style="color:#9ECBFF;">net.bridge.bridge-nf-call-iptables = 1</span></span>
<span class="line"><span style="color:#9ECBFF;">net.bridge.bridge-nf-call-ip6tables = 1</span></span>
<span class="line"><span style="color:#9ECBFF;">fs.may_detach_mounts = 1</span></span>
<span class="line"><span style="color:#9ECBFF;">net.ipv4.conf.all.route_localnet = 1</span></span>
<span class="line"><span style="color:#9ECBFF;">vm.overcommit_memory=1</span></span>
<span class="line"><span style="color:#9ECBFF;">vm.panic_on_oom=0</span></span>
<span class="line"><span style="color:#9ECBFF;">fs.inotify.max_user_watches=89100</span></span>
<span class="line"><span style="color:#9ECBFF;">fs.file-max=52706963</span></span>
<span class="line"><span style="color:#9ECBFF;">fs.nr_open=52706963</span></span>
<span class="line"><span style="color:#9ECBFF;">net.netfilter.nf_conntrack_max=2310720</span></span>
<span class="line"><span style="color:#9ECBFF;">net.ipv4.tcp_keepalive_time = 600</span></span>
<span class="line"><span style="color:#9ECBFF;">net.ipv4.tcp_keepalive_probes = 3</span></span>
<span class="line"><span style="color:#9ECBFF;">net.ipv4.tcp_keepalive_intvl =15</span></span>
<span class="line"><span style="color:#9ECBFF;">net.ipv4.tcp_max_tw_buckets = 36000</span></span>
<span class="line"><span style="color:#9ECBFF;">net.ipv4.tcp_tw_reuse = 1</span></span>
<span class="line"><span style="color:#9ECBFF;">net.ipv4.tcp_max_orphans = 327680</span></span>
<span class="line"><span style="color:#9ECBFF;">net.ipv4.tcp_orphan_retries = 3</span></span>
<span class="line"><span style="color:#9ECBFF;">net.ipv4.tcp_syncookies = 1</span></span>
<span class="line"><span style="color:#9ECBFF;">net.ipv4.tcp_max_syn_backlog = 16384</span></span>
<span class="line"><span style="color:#9ECBFF;">net.ipv4.ip_conntrack_max = 65536</span></span>
<span class="line"><span style="color:#9ECBFF;">net.ipv4.tcp_max_syn_backlog = 16384</span></span>
<span class="line"><span style="color:#9ECBFF;">net.ipv4.tcp_timestamps = 0</span></span>
<span class="line"><span style="color:#9ECBFF;">net.core.somaxconn = 16384</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> /etc/sysctl.d/k8s.conf</span></span>
<span class="line"><span style="color:#032F62;">net.ipv4.ip_forward = 1</span></span>
<span class="line"><span style="color:#032F62;">net.bridge.bridge-nf-call-iptables = 1</span></span>
<span class="line"><span style="color:#032F62;">net.bridge.bridge-nf-call-ip6tables = 1</span></span>
<span class="line"><span style="color:#032F62;">fs.may_detach_mounts = 1</span></span>
<span class="line"><span style="color:#032F62;">net.ipv4.conf.all.route_localnet = 1</span></span>
<span class="line"><span style="color:#032F62;">vm.overcommit_memory=1</span></span>
<span class="line"><span style="color:#032F62;">vm.panic_on_oom=0</span></span>
<span class="line"><span style="color:#032F62;">fs.inotify.max_user_watches=89100</span></span>
<span class="line"><span style="color:#032F62;">fs.file-max=52706963</span></span>
<span class="line"><span style="color:#032F62;">fs.nr_open=52706963</span></span>
<span class="line"><span style="color:#032F62;">net.netfilter.nf_conntrack_max=2310720</span></span>
<span class="line"><span style="color:#032F62;">net.ipv4.tcp_keepalive_time = 600</span></span>
<span class="line"><span style="color:#032F62;">net.ipv4.tcp_keepalive_probes = 3</span></span>
<span class="line"><span style="color:#032F62;">net.ipv4.tcp_keepalive_intvl =15</span></span>
<span class="line"><span style="color:#032F62;">net.ipv4.tcp_max_tw_buckets = 36000</span></span>
<span class="line"><span style="color:#032F62;">net.ipv4.tcp_tw_reuse = 1</span></span>
<span class="line"><span style="color:#032F62;">net.ipv4.tcp_max_orphans = 327680</span></span>
<span class="line"><span style="color:#032F62;">net.ipv4.tcp_orphan_retries = 3</span></span>
<span class="line"><span style="color:#032F62;">net.ipv4.tcp_syncookies = 1</span></span>
<span class="line"><span style="color:#032F62;">net.ipv4.tcp_max_syn_backlog = 16384</span></span>
<span class="line"><span style="color:#032F62;">net.ipv4.ip_conntrack_max = 65536</span></span>
<span class="line"><span style="color:#032F62;">net.ipv4.tcp_max_syn_backlog = 16384</span></span>
<span class="line"><span style="color:#032F62;">net.ipv4.tcp_timestamps = 0</span></span>
<span class="line"><span style="color:#032F62;">net.core.somaxconn = 16384</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span></code></pre></div><ul><li>重新加载</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">sysctl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--system</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">sysctl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--system</span></span></code></pre></div><ul><li>重启所有系统，查看模块是否加载好</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">reboot</span></span>
<span class="line"><span style="color:#B392F0;">lsmod</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--color=auto</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ip_vs</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nf_conntrack</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">reboot</span></span>
<span class="line"><span style="color:#6F42C1;">lsmod</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--color=auto</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ip_vs</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nf_conntrack</span></span></code></pre></div><h2 id="_2-6配置hosts" tabindex="-1">2.6配置hosts <a class="header-anchor" href="#_2-6配置hosts" aria-label="Permalink to &quot;2.6配置hosts&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#新添加如下，对应关系错误，否则会出现calico启动错误</span></span>
<span class="line"><span style="color:#B392F0;">vim</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">/etc/hosts</span></span>
<span class="line"><span style="color:#B392F0;">10.103.236.201</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-master</span></span>
<span class="line"><span style="color:#B392F0;">10.103.236.202</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-node01</span></span>
<span class="line"><span style="color:#B392F0;">10.103.236.203</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-node02</span></span>
<span class="line"><span style="color:#B392F0;">10.103.236.204</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-node03</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#新添加如下，对应关系错误，否则会出现calico启动错误</span></span>
<span class="line"><span style="color:#6F42C1;">vim</span><span style="color:#24292E;">  </span><span style="color:#032F62;">/etc/hosts</span></span>
<span class="line"><span style="color:#6F42C1;">10.103.236.201</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-master</span></span>
<span class="line"><span style="color:#6F42C1;">10.103.236.202</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-node01</span></span>
<span class="line"><span style="color:#6F42C1;">10.103.236.203</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-node02</span></span>
<span class="line"><span style="color:#6F42C1;">10.103.236.204</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-node03</span></span></code></pre></div><h2 id="_2-7配置集群命令自动补全" tabindex="-1">2.7配置集群命令自动补全 <a class="header-anchor" href="#_2-7配置集群命令自动补全" aria-label="Permalink to &quot;2.7配置集群命令自动补全&quot;">​</a></h2><p><a href="https://kubernetes.io/zh/docs/tasks/tools/included/optional-kubectl-configs-bash-linux/" target="_blank" rel="noreferrer">https://kubernetes.io/zh/docs/tasks/tools/included/optional-kubectl-configs-bash-linux/</a></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bash-completion</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;source &lt;(kubectl completion bash)&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#9ECBFF;">~/.bashrc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bash-completion</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;source &lt;(kubectl completion bash)&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#032F62;">~/.bashrc</span></span></code></pre></div><h1 id="_3-runtime安装" tabindex="-1">3.Runtime安装 <a class="header-anchor" href="#_3-runtime安装" aria-label="Permalink to &quot;3.Runtime安装&quot;">​</a></h1><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>如果安装的版本低于1.24，选择Docker和Containerd均可，高于1.24选择Containerd作为Runtime</p></div><h2 id="_3-1-containerd作为runtime" tabindex="-1">3.1 Containerd作为Runtime <a class="header-anchor" href="#_3-1-containerd作为runtime" aria-label="Permalink to &quot;3.1 Containerd作为Runtime&quot;">​</a></h2><p><strong>所有节点</strong></p><h3 id="_1-安装docker-ce-20-10" tabindex="-1">1.安装docker-ce-20.10 <a class="header-anchor" href="#_1-安装docker-ce-20-10" aria-label="Permalink to &quot;1.安装docker-ce-20.10&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker-ce-20.10.</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker-ce-cli-20.10.</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#可以无需启动Docker，只需要配置和启动Containerd即可</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker-ce-20.10.</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker-ce-cli-20.10.</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#可以无需启动Docker，只需要配置和启动Containerd即可</span></span></code></pre></div><h3 id="_2-配置containerd所需模块" tabindex="-1">2.配置Containerd所需模块 <a class="header-anchor" href="#_2-配置containerd所需模块" aria-label="Permalink to &quot;2.配置Containerd所需模块&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> sudo tee /etc/modules-load.d/containerd.conf</span></span>
<span class="line"><span style="color:#9ECBFF;">overlay</span></span>
<span class="line"><span style="color:#9ECBFF;">br_netfilter</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#加载模块</span></span>
<span class="line"><span style="color:#B392F0;">modprobe</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">overlay</span></span>
<span class="line"><span style="color:#B392F0;">modprobe</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">br_netfilter</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> sudo tee /etc/modules-load.d/containerd.conf</span></span>
<span class="line"><span style="color:#032F62;">overlay</span></span>
<span class="line"><span style="color:#032F62;">br_netfilter</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#加载模块</span></span>
<span class="line"><span style="color:#6F42C1;">modprobe</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--</span><span style="color:#24292E;"> </span><span style="color:#032F62;">overlay</span></span>
<span class="line"><span style="color:#6F42C1;">modprobe</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--</span><span style="color:#24292E;"> </span><span style="color:#032F62;">br_netfilter</span></span></code></pre></div><h3 id="_3-配置containerd所需的内核" tabindex="-1">3.配置Containerd所需的内核 <a class="header-anchor" href="#_3-配置containerd所需的内核" aria-label="Permalink to &quot;3.配置Containerd所需的内核&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span></span>
<span class="line"><span style="color:#9ECBFF;">net.bridge.bridge-nf-call-iptables  = 1</span></span>
<span class="line"><span style="color:#9ECBFF;">net.ipv4.ip_forward                 = 1</span></span>
<span class="line"><span style="color:#9ECBFF;">net.bridge.bridge-nf-call-ip6tables = 1</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#重新加载内核</span></span>
<span class="line"><span style="color:#B392F0;">sysctl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--system</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span></span>
<span class="line"><span style="color:#032F62;">net.bridge.bridge-nf-call-iptables  = 1</span></span>
<span class="line"><span style="color:#032F62;">net.ipv4.ip_forward                 = 1</span></span>
<span class="line"><span style="color:#032F62;">net.bridge.bridge-nf-call-ip6tables = 1</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#重新加载内核</span></span>
<span class="line"><span style="color:#6F42C1;">sysctl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--system</span></span></code></pre></div><h3 id="_4-配置containerd文件" tabindex="-1">4.配置Containerd文件 <a class="header-anchor" href="#_4-配置containerd文件" aria-label="Permalink to &quot;4.配置Containerd文件&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">mkdir -p /etc/containerd</span></span>
<span class="line"><span style="color:#e1e4e8;">containerd config default | tee /etc/containerd/config.toml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">mkdir -p /etc/containerd</span></span>
<span class="line"><span style="color:#24292e;">containerd config default | tee /etc/containerd/config.toml</span></span></code></pre></div><p>找到<strong>containerd.runtimes.runc.options</strong>，添加<strong>SystemdCgroup = true（如果已存在直接修改，否则会报错）</strong></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202404091747205.png" alt="image-20240409174732433"></p><ul><li>修改镜像，否则你懂的</li></ul><p>默认是， sandbox_image = &quot;registry.k8s.io/pause:3.6&quot;,根据版本进行修改</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/containerd/config.toml</span></span>
<span class="line"><span style="color:#6A737D;">#修改成</span></span>
<span class="line"><span style="color:#B392F0;">sandbox_image</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/containerd/config.toml</span></span>
<span class="line"><span style="color:#6A737D;">#修改成</span></span>
<span class="line"><span style="color:#6F42C1;">sandbox_image</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6&quot;</span></span></code></pre></div><h3 id="_5-启动" tabindex="-1">5.启动 <a class="header-anchor" href="#_5-启动" aria-label="Permalink to &quot;5.启动&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemon-reload</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">containerd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#配置crictl客户端连接的运行时位置</span></span>
<span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/crictl.yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#9ECBFF;">runtime-endpoint: unix:///run/containerd/containerd.sock</span></span>
<span class="line"><span style="color:#9ECBFF;">image-endpoint: unix:///run/containerd/containerd.sock</span></span>
<span class="line"><span style="color:#9ECBFF;">timeout: 10</span></span>
<span class="line"><span style="color:#9ECBFF;">debug: false</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemon-reload</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">containerd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#配置crictl客户端连接的运行时位置</span></span>
<span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/crictl.yaml</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#032F62;">runtime-endpoint: unix:///run/containerd/containerd.sock</span></span>
<span class="line"><span style="color:#032F62;">image-endpoint: unix:///run/containerd/containerd.sock</span></span>
<span class="line"><span style="color:#032F62;">timeout: 10</span></span>
<span class="line"><span style="color:#032F62;">debug: false</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span></code></pre></div><h2 id="_3-2-docker作为runtime" tabindex="-1">3.2 Docker作为Runtime <a class="header-anchor" href="#_3-2-docker作为runtime" aria-label="Permalink to &quot;3.2 Docker作为Runtime&quot;">​</a></h2><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>如果选择Docker作为Runtime，安装步骤较Containerd较为简单，只需要安装并启动即可（版本小于1.24）</p></div><h3 id="_1-安装" tabindex="-1">1.安装 <a class="header-anchor" href="#_1-安装" aria-label="Permalink to &quot;1.安装&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker-ce-20.10.</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker-ce-cli-20.10.</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker-ce-20.10.</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker-ce-cli-20.10.</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span></code></pre></div><p>新版官方建议，新版Kubelet建议使用systemd，所以把Docker的CgroupDriver也改成systemd</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/docker</span></span>
<span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/docker/daemon.json</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;exec-opts&quot;: [</span></span>
<span class="line"><span style="color:#9ECBFF;">  	&quot;native.cgroupdriver=systemd&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">  ],</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;max-concurrent-downloads&quot;: 10,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;max-concurrent-uploads&quot;: 5,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;live-restore&quot;:true,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;log-driver&quot;: &quot;json-file&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;log-opts&quot;: {</span></span>
<span class="line"><span style="color:#9ECBFF;">  	&quot;max-size&quot;: &quot;100m&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">	&quot;max-file&quot;:&quot;5&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">  },</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;storage-opts&quot;: [</span></span>
<span class="line"><span style="color:#9ECBFF;">  	&quot;overlay2.override_kernel_check=true&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">  ],</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;registry-mirrors&quot; : [</span></span>
<span class="line"><span style="color:#9ECBFF;">  ],</span></span>
<span class="line"><span style="color:#9ECBFF;">  &quot;data-root&quot;: &quot;/data/docker&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">}</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/docker</span></span>
<span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/docker/daemon.json</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#032F62;">  &quot;exec-opts&quot;: [</span></span>
<span class="line"><span style="color:#032F62;">  	&quot;native.cgroupdriver=systemd&quot;</span></span>
<span class="line"><span style="color:#032F62;">  ],</span></span>
<span class="line"><span style="color:#032F62;">  &quot;max-concurrent-downloads&quot;: 10,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;max-concurrent-uploads&quot;: 5,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;live-restore&quot;:true,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;log-driver&quot;: &quot;json-file&quot;,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;log-opts&quot;: {</span></span>
<span class="line"><span style="color:#032F62;">  	&quot;max-size&quot;: &quot;100m&quot;,</span></span>
<span class="line"><span style="color:#032F62;">	&quot;max-file&quot;:&quot;5&quot;</span></span>
<span class="line"><span style="color:#032F62;">  },</span></span>
<span class="line"><span style="color:#032F62;">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span></span>
<span class="line"><span style="color:#032F62;">  &quot;storage-opts&quot;: [</span></span>
<span class="line"><span style="color:#032F62;">  	&quot;overlay2.override_kernel_check=true&quot;</span></span>
<span class="line"><span style="color:#032F62;">  ],</span></span>
<span class="line"><span style="color:#032F62;">  &quot;registry-mirrors&quot; : [</span></span>
<span class="line"><span style="color:#032F62;">  ],</span></span>
<span class="line"><span style="color:#032F62;">  &quot;data-root&quot;: &quot;/data/docker&quot;</span></span>
<span class="line"><span style="color:#032F62;">}</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span></code></pre></div><h3 id="_2-启动" tabindex="-1">2.启动 <a class="header-anchor" href="#_2-启动" aria-label="Permalink to &quot;2.启动&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemon-reload</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemon-reload</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span></span></code></pre></div><h1 id="_4-安装kubernetes组件" tabindex="-1">4.安装Kubernetes组件 <a class="header-anchor" href="#_4-安装kubernetes组件" aria-label="Permalink to &quot;4.安装Kubernetes组件&quot;">​</a></h1><h2 id="_1-查看版本" tabindex="-1">1.查看版本 <a class="header-anchor" href="#_1-查看版本" aria-label="Permalink to &quot;1.查看版本&quot;">​</a></h2><ul><li>在master上面查看最新版本</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">list</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubeadm.x86_64</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--showduplicates</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sort</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-r</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">list</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubeadm.x86_64</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--showduplicates</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sort</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-r</span></span></code></pre></div><h2 id="_2-安装" tabindex="-1">2.安装 <a class="header-anchor" href="#_2-安装" aria-label="Permalink to &quot;2.安装&quot;">​</a></h2><p>所有节点安装，kubeadm、kubelet和kubectl</p><ul><li>指定版本安装</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet-1.22.17</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubeadm-1.22.</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl-1.22.17</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet-1.22.17</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubeadm-1.22.</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl-1.22.17</span></span></code></pre></div><ul><li>安装最新</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubeadm-1.22</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet-1.22</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl-1.22</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubeadm-1.22</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet-1.22</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl-1.22</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>如果选择的是Containerd作为的Runtime，需要更改Kubelet的配置使用Containerd作为Runtime：</p></div><p><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/" target="_blank" rel="noreferrer">cgroup驱动</a></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">/etc/sysconfig/kubelet</span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#9ECBFF;">KUBELET_KUBEADM_ARGS=&quot;--cgroup-driver=systemd --container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///run/containerd/containerd.sock&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">/etc/sysconfig/kubelet</span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#032F62;">KUBELET_KUBEADM_ARGS=&quot;--cgroup-driver=systemd --container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///run/containerd/containerd.sock&quot;</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">💡 说明</p><p>如果不是采用Containerd作为的Runtime，请不要执行上述命令</p></div><h2 id="_3-启动" tabindex="-1">3.启动 <a class="header-anchor" href="#_3-启动" aria-label="Permalink to &quot;3.启动&quot;">​</a></h2><blockquote><p>由于还未初始化，没有kubelet的配置文件，此时kubelet无法启动，无需担心</p></blockquote><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemon-reload</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看kubelet 是否以systemd启动</span></span>
<span class="line"><span style="color:#B392F0;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/kubelet/config.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemon-reload</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看kubelet 是否以systemd启动</span></span>
<span class="line"><span style="color:#6F42C1;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/kubelet/config.yaml</span></span></code></pre></div><h1 id="_5-kubernetes高可用" tabindex="-1">5.Kubernetes高可用 <a class="header-anchor" href="#_5-kubernetes高可用" aria-label="Permalink to &quot;5.Kubernetes高可用&quot;">​</a></h1><h1 id="_6-kubernetes初始化" tabindex="-1">6.Kubernetes初始化 <a class="header-anchor" href="#_6-kubernetes初始化" aria-label="Permalink to &quot;6.Kubernetes初始化&quot;">​</a></h1><ul><li>官当</li></ul><p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/" target="_blank" rel="noreferrer">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/</a></p><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>创建kubeadm-config.yaml配置文件，只在Master01节点执行！！！</p><p>Master01：（# 注意，如果不是高可用集群，10.103.236.236:16443改为master01的地址，16443改为apiserver的端口，默认是6443，注意更改kubernetesVersion的值和自己服务器kubeadm的版本一致：kubeadm version）</p></div><h2 id="_6-1创建配置文件" tabindex="-1">6.1创建配置文件 <a class="header-anchor" href="#_6-1创建配置文件" aria-label="Permalink to &quot;6.1创建配置文件&quot;">​</a></h2><ul><li>生成初始文件</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">print</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">init-defaults</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubeadm-init.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">print</span><span style="color:#24292E;"> </span><span style="color:#032F62;">init-defaults</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubeadm-init.yaml</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">vim kubeadm-config.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubeadm.k8s.io/v1beta2</span></span>
<span class="line"><span style="color:#85E89D;">bootstrapTokens</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">groups</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">system:bootstrappers:kubeadm:default-node-token</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">token</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">7t2weq.bjbawausm0jaxury</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ttl</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">24h0m0s</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">usages</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">signing</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">authentication</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">InitConfiguration</span></span>
<span class="line"><span style="color:#85E89D;">localAPIEndpoint</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">advertiseAddress</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10.103.236.201</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#master节点ip,如果是高可用,则填写高可用地址</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">bindPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">6443</span></span>
<span class="line"><span style="color:#85E89D;">nodeRegistration</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">criSocket</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/var/run/dockershim.sock</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 如果是Docker</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#criSocket: /run/containerd/containerd.sock # 如果是Containerd</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">k8s-master01</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">taints</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">effect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NoSchedule</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node-role.kubernetes.io/master</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiServer</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">certSANs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#79B8FF;">10.103.236.201</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">timeoutForControlPlane</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">4m0s</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubeadm.k8s.io/v1beta2</span></span>
<span class="line"><span style="color:#85E89D;">certificatesDir</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/kubernetes/pki</span></span>
<span class="line"><span style="color:#85E89D;">clusterName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes</span></span>
<span class="line"><span style="color:#85E89D;">controlPlaneEndpoint</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10.103.236.201:6443</span></span>
<span class="line"><span style="color:#85E89D;">controllerManager</span><span style="color:#E1E4E8;">: {}</span></span>
<span class="line"><span style="color:#85E89D;">dns</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">CoreDNS</span></span>
<span class="line"><span style="color:#85E89D;">etcd</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">local</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">dataDir</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/var/lib/etcd</span></span>
<span class="line"><span style="color:#85E89D;">imageRepository</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-hangzhou.aliyuncs.com/google_containers</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterConfiguration</span></span>
<span class="line"><span style="color:#85E89D;">kubernetesVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1.22.17</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 更改此处的版本号和kubeadm version一致</span></span>
<span class="line"><span style="color:#85E89D;">networking</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">dnsDomain</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cluster.local</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">podSubnet</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">172.16.0.0/12</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">serviceSubnet</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">192.168.0.0/16</span></span>
<span class="line"><span style="color:#85E89D;">scheduler</span><span style="color:#E1E4E8;">: {}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">vim kubeadm-config.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubeadm.k8s.io/v1beta2</span></span>
<span class="line"><span style="color:#22863A;">bootstrapTokens</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">groups</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">system:bootstrappers:kubeadm:default-node-token</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">token</span><span style="color:#24292E;">: </span><span style="color:#032F62;">7t2weq.bjbawausm0jaxury</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ttl</span><span style="color:#24292E;">: </span><span style="color:#032F62;">24h0m0s</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">usages</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">signing</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">authentication</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">InitConfiguration</span></span>
<span class="line"><span style="color:#22863A;">localAPIEndpoint</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">advertiseAddress</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10.103.236.201</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#master节点ip,如果是高可用,则填写高可用地址</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">bindPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">6443</span></span>
<span class="line"><span style="color:#22863A;">nodeRegistration</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">criSocket</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/run/dockershim.sock</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 如果是Docker</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">#criSocket: /run/containerd/containerd.sock # 如果是Containerd</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">k8s-master01</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">taints</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">effect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NoSchedule</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node-role.kubernetes.io/master</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiServer</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">certSANs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#005CC5;">10.103.236.201</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">timeoutForControlPlane</span><span style="color:#24292E;">: </span><span style="color:#032F62;">4m0s</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubeadm.k8s.io/v1beta2</span></span>
<span class="line"><span style="color:#22863A;">certificatesDir</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/kubernetes/pki</span></span>
<span class="line"><span style="color:#22863A;">clusterName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes</span></span>
<span class="line"><span style="color:#22863A;">controlPlaneEndpoint</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10.103.236.201:6443</span></span>
<span class="line"><span style="color:#22863A;">controllerManager</span><span style="color:#24292E;">: {}</span></span>
<span class="line"><span style="color:#22863A;">dns</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">CoreDNS</span></span>
<span class="line"><span style="color:#22863A;">etcd</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">local</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">dataDir</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/lib/etcd</span></span>
<span class="line"><span style="color:#22863A;">imageRepository</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-hangzhou.aliyuncs.com/google_containers</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterConfiguration</span></span>
<span class="line"><span style="color:#22863A;">kubernetesVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1.22.17</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 更改此处的版本号和kubeadm version一致</span></span>
<span class="line"><span style="color:#22863A;">networking</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">dnsDomain</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cluster.local</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">podSubnet</span><span style="color:#24292E;">: </span><span style="color:#032F62;">172.16.0.0/12</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">serviceSubnet</span><span style="color:#24292E;">: </span><span style="color:#032F62;">192.168.0.0/16</span></span>
<span class="line"><span style="color:#22863A;">scheduler</span><span style="color:#24292E;">: {}</span></span></code></pre></div><ul><li>更新配置文件</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">migrate</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--old-config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubeadm-config.yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--new-config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">new.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">migrate</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--old-config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubeadm-config.yaml</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--new-config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">new.yaml</span></span></code></pre></div><h2 id="_6-2拉取镜像" tabindex="-1">6.2拉取镜像 <a class="header-anchor" href="#_6-2拉取镜像" aria-label="Permalink to &quot;6.2拉取镜像&quot;">​</a></h2><ul><li>查看所需镜像</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm]# kubeadm config images list --kubernetes-version=v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">registry.k8s.io/kube-apiserver:v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">registry.k8s.io/kube-controller-manager:v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">registry.k8s.io/kube-scheduler:v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">registry.k8s.io/kube-proxy:v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">registry.k8s.io/pause:3.5</span></span>
<span class="line"><span style="color:#B392F0;">registry.k8s.io/etcd:3.5.6-0</span></span>
<span class="line"><span style="color:#B392F0;">registry.k8s.io/coredns/coredns:v1.8.4</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubeadm]# kubeadm config images list --kubernetes-version=v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">registry.k8s.io/kube-apiserver:v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">registry.k8s.io/kube-controller-manager:v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">registry.k8s.io/kube-scheduler:v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">registry.k8s.io/kube-proxy:v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">registry.k8s.io/pause:3.5</span></span>
<span class="line"><span style="color:#6F42C1;">registry.k8s.io/etcd:3.5.6-0</span></span>
<span class="line"><span style="color:#6F42C1;">registry.k8s.io/coredns/coredns:v1.8.4</span></span></code></pre></div><ul><li>手动拉取阿里云</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">images</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pull</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--image-repository</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">registry.aliyuncs.com/google_containers</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">images</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pull</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--image-repository</span><span style="color:#24292E;"> </span><span style="color:#032F62;">registry.aliyuncs.com/google_containers</span></span></code></pre></div><ul><li>根据配置文件进行拉取</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm]# kubeadm config images pull --config /root/kubeadm/new.yaml</span></span>
<span class="line"><span style="color:#E1E4E8;">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.17</span></span>
<span class="line"><span style="color:#E1E4E8;">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.17</span></span>
<span class="line"><span style="color:#E1E4E8;">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.17</span></span>
<span class="line"><span style="color:#E1E4E8;">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.17</span></span>
<span class="line"><span style="color:#E1E4E8;">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5</span></span>
<span class="line"><span style="color:#E1E4E8;">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.6-0</span></span>
<span class="line"><span style="color:#E1E4E8;">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubeadm]# kubeadm config images pull --config /root/kubeadm/new.yaml</span></span>
<span class="line"><span style="color:#24292E;">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.17</span></span>
<span class="line"><span style="color:#24292E;">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.17</span></span>
<span class="line"><span style="color:#24292E;">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.17</span></span>
<span class="line"><span style="color:#24292E;">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.17</span></span>
<span class="line"><span style="color:#24292E;">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5</span></span>
<span class="line"><span style="color:#24292E;">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.6-0</span></span>
<span class="line"><span style="color:#24292E;">[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4</span></span></code></pre></div><ul><li>所有节点设置开机自启动kubelet</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet</span></span></code></pre></div><h2 id="_6-3master节点初始化" tabindex="-1">6.3master节点初始化 <a class="header-anchor" href="#_6-3master节点初始化" aria-label="Permalink to &quot;6.3master节点初始化&quot;">​</a></h2><p>初始化以后会在/etc/kubernetes目录下生成对应的证书和配置文件，之后其他Master节点加入Master01即可</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm]# kubeadm init --config /root/kubeadm/new.yaml  --upload-certs</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[init] Using Kubernetes version: v1.22.17</span></span>
<span class="line"><span style="color:#E1E4E8;">[preflight] Running pre-flight checks</span></span>
<span class="line"><span style="color:#E1E4E8;">[preflight] Pulling images required </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> setting up a Kubernetes cluster</span></span>
<span class="line"><span style="color:#E1E4E8;">[preflight] This might take a minute or two, depending on the speed of your internet connection</span></span>
<span class="line"><span style="color:#E1E4E8;">[preflight] You can also perform this action </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> beforehand using </span><span style="color:#9ECBFF;">&#39;kubeadm config images pull&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">[certs] Using certificateDir folder </span><span style="color:#9ECBFF;">&quot;/etc/kubernetes/pki&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">[certs] Generating </span><span style="color:#9ECBFF;">&quot;ca&quot;</span><span style="color:#E1E4E8;"> certificate and key</span></span>
<span class="line"><span style="color:#E1E4E8;">[certs] Generating </span><span style="color:#9ECBFF;">&quot;apiserver&quot;</span><span style="color:#E1E4E8;"> certificate and key</span></span>
<span class="line"><span style="color:#E1E4E8;">[certs] apiserver serving cert is signed </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> DNS names [k8s-master01 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [</span><span style="color:#79B8FF;">192.168</span><span style="color:#E1E4E8;">.0.1 </span><span style="color:#79B8FF;">10.103</span><span style="color:#E1E4E8;">.236.201]</span></span>
<span class="line"><span style="color:#E1E4E8;">[certs] Generating </span><span style="color:#9ECBFF;">&quot;apiserver-kubelet-client&quot;</span><span style="color:#E1E4E8;"> certificate and key</span></span>
<span class="line"><span style="color:#E1E4E8;">[certs] Generating </span><span style="color:#9ECBFF;">&quot;front-proxy-ca&quot;</span><span style="color:#E1E4E8;"> certificate and key</span></span>
<span class="line"><span style="color:#E1E4E8;">[certs] Generating </span><span style="color:#9ECBFF;">&quot;front-proxy-client&quot;</span><span style="color:#E1E4E8;"> certificate and key</span></span>
<span class="line"><span style="color:#E1E4E8;">[certs] Generating </span><span style="color:#9ECBFF;">&quot;etcd/ca&quot;</span><span style="color:#E1E4E8;"> certificate and key</span></span>
<span class="line"><span style="color:#E1E4E8;">[certs] Generating </span><span style="color:#9ECBFF;">&quot;etcd/server&quot;</span><span style="color:#E1E4E8;"> certificate and key</span></span>
<span class="line"><span style="color:#E1E4E8;">[certs] etcd/server serving cert is signed </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> DNS names [k8s-master01 localhost] and IPs [</span><span style="color:#79B8FF;">10.103</span><span style="color:#E1E4E8;">.236.201 </span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.0.1 ::1]</span></span>
<span class="line"><span style="color:#E1E4E8;">[certs] Generating </span><span style="color:#9ECBFF;">&quot;etcd/peer&quot;</span><span style="color:#E1E4E8;"> certificate and key</span></span>
<span class="line"><span style="color:#E1E4E8;">[certs] etcd/peer serving cert is signed </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> DNS names [k8s-master01 localhost] and IPs [</span><span style="color:#79B8FF;">10.103</span><span style="color:#E1E4E8;">.236.201 </span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.0.1 ::1]</span></span>
<span class="line"><span style="color:#E1E4E8;">[certs] Generating </span><span style="color:#9ECBFF;">&quot;etcd/healthcheck-client&quot;</span><span style="color:#E1E4E8;"> certificate and key</span></span>
<span class="line"><span style="color:#E1E4E8;">[certs] Generating </span><span style="color:#9ECBFF;">&quot;apiserver-etcd-client&quot;</span><span style="color:#E1E4E8;"> certificate and key</span></span>
<span class="line"><span style="color:#E1E4E8;">[certs] Generating </span><span style="color:#9ECBFF;">&quot;sa&quot;</span><span style="color:#E1E4E8;"> key and public key</span></span>
<span class="line"><span style="color:#E1E4E8;">[kubeconfig] Using kubeconfig folder </span><span style="color:#9ECBFF;">&quot;/etc/kubernetes&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">[kubeconfig] Writing </span><span style="color:#9ECBFF;">&quot;admin.conf&quot;</span><span style="color:#E1E4E8;"> kubeconfig file</span></span>
<span class="line"><span style="color:#E1E4E8;">[kubeconfig] Writing </span><span style="color:#9ECBFF;">&quot;kubelet.conf&quot;</span><span style="color:#E1E4E8;"> kubeconfig file</span></span>
<span class="line"><span style="color:#E1E4E8;">[kubeconfig] Writing </span><span style="color:#9ECBFF;">&quot;controller-manager.conf&quot;</span><span style="color:#E1E4E8;"> kubeconfig file</span></span>
<span class="line"><span style="color:#E1E4E8;">[kubeconfig] Writing </span><span style="color:#9ECBFF;">&quot;scheduler.conf&quot;</span><span style="color:#E1E4E8;"> kubeconfig file</span></span>
<span class="line"><span style="color:#E1E4E8;">[kubelet-start] Writing kubelet environment file with flags to file </span><span style="color:#9ECBFF;">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">[kubelet-start] Writing kubelet configuration to file </span><span style="color:#9ECBFF;">&quot;/var/lib/kubelet/config.yaml&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">[kubelet-start] Starting the kubelet</span></span>
<span class="line"><span style="color:#E1E4E8;">[control-plane] Using manifest folder </span><span style="color:#9ECBFF;">&quot;/etc/kubernetes/manifests&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">[control-plane] Creating static Pod manifest </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;kube-apiserver&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">[control-plane] Creating static Pod manifest </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;kube-controller-manager&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">[control-plane] Creating static Pod manifest </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;kube-scheduler&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">[etcd] Creating static Pod manifest </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> local etcd </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/etc/kubernetes/manifests&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">[wait-control-plane] Waiting </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> the kubelet to boot up the control plane as static Pods from directory </span><span style="color:#9ECBFF;">&quot;/etc/kubernetes/manifests&quot;</span><span style="color:#E1E4E8;">. This can take up to 4m0s</span></span>
<span class="line"><span style="color:#E1E4E8;">[apiclient] All control plane components are healthy after 9.504786 seconds</span></span>
<span class="line"><span style="color:#E1E4E8;">[upload-config] Storing the configuration used </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> ConfigMap </span><span style="color:#9ECBFF;">&quot;kubeadm-config&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> the </span><span style="color:#9ECBFF;">&quot;kube-system&quot;</span><span style="color:#E1E4E8;"> Namespace</span></span>
<span class="line"><span style="color:#E1E4E8;">[kubelet] Creating a ConfigMap </span><span style="color:#9ECBFF;">&quot;kubelet-config-1.22&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> namespace kube-system with the configuration </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> the kubelets </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> the cluster</span></span>
<span class="line"><span style="color:#E1E4E8;">[upload-certs] Storing the certificates </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> Secret </span><span style="color:#9ECBFF;">&quot;kubeadm-certs&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> the </span><span style="color:#9ECBFF;">&quot;kube-system&quot;</span><span style="color:#E1E4E8;"> Namespace</span></span>
<span class="line"><span style="color:#E1E4E8;">[upload-certs] Using certificate key:</span></span>
<span class="line"><span style="color:#B392F0;">1980f439d979e2f4f73105f2230d6c962b811edde47ea7e18bead49e8d284132</span></span>
<span class="line"><span style="color:#E1E4E8;">[mark-control-plane] Marking the node k8s-master01 as control-plane by adding the labels: [node-role.kubernetes.io/master(deprecated)node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span></span>
<span class="line"><span style="color:#E1E4E8;">[mark-control-plane] Marking the node k8s-master01 as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]</span></span>
<span class="line"><span style="color:#E1E4E8;">[bootstrap-token] Using token: 7t2weq.bjbawausm0jaxury</span></span>
<span class="line"><span style="color:#E1E4E8;">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span></span>
<span class="line"><span style="color:#E1E4E8;">[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes</span></span>
<span class="line"><span style="color:#E1E4E8;">[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> order </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> nodes to get long term certificate credentials</span></span>
<span class="line"><span style="color:#E1E4E8;">[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span></span>
<span class="line"><span style="color:#E1E4E8;">[bootstrap-token] configured RBAC rules to allow certificate rotation </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> all node client certificates </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> the cluster</span></span>
<span class="line"><span style="color:#E1E4E8;">[bootstrap-token] Creating the </span><span style="color:#9ECBFF;">&quot;cluster-info&quot;</span><span style="color:#E1E4E8;"> ConfigMap </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> the </span><span style="color:#9ECBFF;">&quot;kube-public&quot;</span><span style="color:#E1E4E8;"> namespace</span></span>
<span class="line"><span style="color:#E1E4E8;">[kubelet-finalize] Updating </span><span style="color:#9ECBFF;">&quot;/etc/kubernetes/kubelet.conf&quot;</span><span style="color:#E1E4E8;"> to point to a rotatable kubelet client certificate and key</span></span>
<span class="line"><span style="color:#E1E4E8;">[addons] Applied essential addon: CoreDNS</span></span>
<span class="line"><span style="color:#E1E4E8;">[addons] Applied essential addon: kube-proxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Your</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Kubernetes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">control-plane</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">has</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">initialized</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">successfully!</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">To</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">using</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">your</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">need</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">following</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">a</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">regular</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">user:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> $HOME</span><span style="color:#9ECBFF;">/.kube</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-i</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/admin.conf</span><span style="color:#E1E4E8;"> $HOME</span><span style="color:#9ECBFF;">/.kube/config</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">chown</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">id</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-u</span><span style="color:#9ECBFF;">):$(</span><span style="color:#B392F0;">id</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-g</span><span style="color:#9ECBFF;">)</span><span style="color:#E1E4E8;"> $HOME</span><span style="color:#9ECBFF;">/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Alternatively,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">are</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">user,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">can</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> KUBECONFIG</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/kubernetes/admin.conf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">You</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">should</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deploy</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">a</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">network</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster.</span></span>
<span class="line"><span style="color:#B392F0;">Run</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;kubectl apply -f [podnetwork].yaml&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">one</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">of</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">options</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">listed</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">at:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">https://kubernetes.io/docs/concepts/cluster-administration/addons/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">You</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">can</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">join</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">any</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">number</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">of</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">control-plane</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">following</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">command</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">each</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">join</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.103</span><span style="color:#9ECBFF;">.236.201:6443</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--token</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7</span><span style="color:#9ECBFF;">t2weq.bjbawausm0jaxury</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">--discovery-token-ca-cert-hash</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sha256:89ad2d95b4ffcdbf9370ccc4925f0195a80e98e5436404ecef548091db31b234</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">--control-plane</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--certificate-key</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1980</span><span style="color:#9ECBFF;">f439d979e2f4f73105f2230d6c962b811edde47ea7e18bead49e8d284132</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Please</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">note</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">that</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">certificate-key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gives</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">access</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sensitive</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">data,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">keep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">it</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">secret!</span></span>
<span class="line"><span style="color:#B392F0;">As</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">a</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">safeguard,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">uploaded-certs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">will</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deleted</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">two</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">hours</span><span style="color:#E1E4E8;">; </span><span style="color:#B392F0;">If</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">necessary,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">can</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">use</span></span>
<span class="line"><span style="color:#B392F0;">&quot;kubeadm init phase upload-certs --upload-certs&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">reload</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">certs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">afterward.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">can</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">join</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">any</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">number</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">of</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">worker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">by</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">following</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">each</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">join</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.103</span><span style="color:#9ECBFF;">.236.201:6443</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--token</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7</span><span style="color:#9ECBFF;">t2weq.bjbawausm0jaxury</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">--discovery-token-ca-cert-hash</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sha256:89ad2d95b4ffcdbf9370ccc4925f0195a80e98e5436404ecef548091db31b234</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubeadm]# kubeadm init --config /root/kubeadm/new.yaml  --upload-certs</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[init] Using Kubernetes version: v1.22.17</span></span>
<span class="line"><span style="color:#24292E;">[preflight] Running pre-flight checks</span></span>
<span class="line"><span style="color:#24292E;">[preflight] Pulling images required </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> setting up a Kubernetes cluster</span></span>
<span class="line"><span style="color:#24292E;">[preflight] This might take a minute or two, depending on the speed of your internet connection</span></span>
<span class="line"><span style="color:#24292E;">[preflight] You can also perform this action </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> beforehand using </span><span style="color:#032F62;">&#39;kubeadm config images pull&#39;</span></span>
<span class="line"><span style="color:#24292E;">[certs] Using certificateDir folder </span><span style="color:#032F62;">&quot;/etc/kubernetes/pki&quot;</span></span>
<span class="line"><span style="color:#24292E;">[certs] Generating </span><span style="color:#032F62;">&quot;ca&quot;</span><span style="color:#24292E;"> certificate and key</span></span>
<span class="line"><span style="color:#24292E;">[certs] Generating </span><span style="color:#032F62;">&quot;apiserver&quot;</span><span style="color:#24292E;"> certificate and key</span></span>
<span class="line"><span style="color:#24292E;">[certs] apiserver serving cert is signed </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> DNS names [k8s-master01 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [</span><span style="color:#005CC5;">192.168</span><span style="color:#24292E;">.0.1 </span><span style="color:#005CC5;">10.103</span><span style="color:#24292E;">.236.201]</span></span>
<span class="line"><span style="color:#24292E;">[certs] Generating </span><span style="color:#032F62;">&quot;apiserver-kubelet-client&quot;</span><span style="color:#24292E;"> certificate and key</span></span>
<span class="line"><span style="color:#24292E;">[certs] Generating </span><span style="color:#032F62;">&quot;front-proxy-ca&quot;</span><span style="color:#24292E;"> certificate and key</span></span>
<span class="line"><span style="color:#24292E;">[certs] Generating </span><span style="color:#032F62;">&quot;front-proxy-client&quot;</span><span style="color:#24292E;"> certificate and key</span></span>
<span class="line"><span style="color:#24292E;">[certs] Generating </span><span style="color:#032F62;">&quot;etcd/ca&quot;</span><span style="color:#24292E;"> certificate and key</span></span>
<span class="line"><span style="color:#24292E;">[certs] Generating </span><span style="color:#032F62;">&quot;etcd/server&quot;</span><span style="color:#24292E;"> certificate and key</span></span>
<span class="line"><span style="color:#24292E;">[certs] etcd/server serving cert is signed </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> DNS names [k8s-master01 localhost] and IPs [</span><span style="color:#005CC5;">10.103</span><span style="color:#24292E;">.236.201 </span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.0.1 ::1]</span></span>
<span class="line"><span style="color:#24292E;">[certs] Generating </span><span style="color:#032F62;">&quot;etcd/peer&quot;</span><span style="color:#24292E;"> certificate and key</span></span>
<span class="line"><span style="color:#24292E;">[certs] etcd/peer serving cert is signed </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> DNS names [k8s-master01 localhost] and IPs [</span><span style="color:#005CC5;">10.103</span><span style="color:#24292E;">.236.201 </span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.0.1 ::1]</span></span>
<span class="line"><span style="color:#24292E;">[certs] Generating </span><span style="color:#032F62;">&quot;etcd/healthcheck-client&quot;</span><span style="color:#24292E;"> certificate and key</span></span>
<span class="line"><span style="color:#24292E;">[certs] Generating </span><span style="color:#032F62;">&quot;apiserver-etcd-client&quot;</span><span style="color:#24292E;"> certificate and key</span></span>
<span class="line"><span style="color:#24292E;">[certs] Generating </span><span style="color:#032F62;">&quot;sa&quot;</span><span style="color:#24292E;"> key and public key</span></span>
<span class="line"><span style="color:#24292E;">[kubeconfig] Using kubeconfig folder </span><span style="color:#032F62;">&quot;/etc/kubernetes&quot;</span></span>
<span class="line"><span style="color:#24292E;">[kubeconfig] Writing </span><span style="color:#032F62;">&quot;admin.conf&quot;</span><span style="color:#24292E;"> kubeconfig file</span></span>
<span class="line"><span style="color:#24292E;">[kubeconfig] Writing </span><span style="color:#032F62;">&quot;kubelet.conf&quot;</span><span style="color:#24292E;"> kubeconfig file</span></span>
<span class="line"><span style="color:#24292E;">[kubeconfig] Writing </span><span style="color:#032F62;">&quot;controller-manager.conf&quot;</span><span style="color:#24292E;"> kubeconfig file</span></span>
<span class="line"><span style="color:#24292E;">[kubeconfig] Writing </span><span style="color:#032F62;">&quot;scheduler.conf&quot;</span><span style="color:#24292E;"> kubeconfig file</span></span>
<span class="line"><span style="color:#24292E;">[kubelet-start] Writing kubelet environment file with flags to file </span><span style="color:#032F62;">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span>
<span class="line"><span style="color:#24292E;">[kubelet-start] Writing kubelet configuration to file </span><span style="color:#032F62;">&quot;/var/lib/kubelet/config.yaml&quot;</span></span>
<span class="line"><span style="color:#24292E;">[kubelet-start] Starting the kubelet</span></span>
<span class="line"><span style="color:#24292E;">[control-plane] Using manifest folder </span><span style="color:#032F62;">&quot;/etc/kubernetes/manifests&quot;</span></span>
<span class="line"><span style="color:#24292E;">[control-plane] Creating static Pod manifest </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;kube-apiserver&quot;</span></span>
<span class="line"><span style="color:#24292E;">[control-plane] Creating static Pod manifest </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;kube-controller-manager&quot;</span></span>
<span class="line"><span style="color:#24292E;">[control-plane] Creating static Pod manifest </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;kube-scheduler&quot;</span></span>
<span class="line"><span style="color:#24292E;">[etcd] Creating static Pod manifest </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> local etcd </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/etc/kubernetes/manifests&quot;</span></span>
<span class="line"><span style="color:#24292E;">[wait-control-plane] Waiting </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> the kubelet to boot up the control plane as static Pods from directory </span><span style="color:#032F62;">&quot;/etc/kubernetes/manifests&quot;</span><span style="color:#24292E;">. This can take up to 4m0s</span></span>
<span class="line"><span style="color:#24292E;">[apiclient] All control plane components are healthy after 9.504786 seconds</span></span>
<span class="line"><span style="color:#24292E;">[upload-config] Storing the configuration used </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> ConfigMap </span><span style="color:#032F62;">&quot;kubeadm-config&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> the </span><span style="color:#032F62;">&quot;kube-system&quot;</span><span style="color:#24292E;"> Namespace</span></span>
<span class="line"><span style="color:#24292E;">[kubelet] Creating a ConfigMap </span><span style="color:#032F62;">&quot;kubelet-config-1.22&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> namespace kube-system with the configuration </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> the kubelets </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> the cluster</span></span>
<span class="line"><span style="color:#24292E;">[upload-certs] Storing the certificates </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> Secret </span><span style="color:#032F62;">&quot;kubeadm-certs&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> the </span><span style="color:#032F62;">&quot;kube-system&quot;</span><span style="color:#24292E;"> Namespace</span></span>
<span class="line"><span style="color:#24292E;">[upload-certs] Using certificate key:</span></span>
<span class="line"><span style="color:#6F42C1;">1980f439d979e2f4f73105f2230d6c962b811edde47ea7e18bead49e8d284132</span></span>
<span class="line"><span style="color:#24292E;">[mark-control-plane] Marking the node k8s-master01 as control-plane by adding the labels: [node-role.kubernetes.io/master(deprecated)node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span></span>
<span class="line"><span style="color:#24292E;">[mark-control-plane] Marking the node k8s-master01 as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]</span></span>
<span class="line"><span style="color:#24292E;">[bootstrap-token] Using token: 7t2weq.bjbawausm0jaxury</span></span>
<span class="line"><span style="color:#24292E;">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span></span>
<span class="line"><span style="color:#24292E;">[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes</span></span>
<span class="line"><span style="color:#24292E;">[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> order </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> nodes to get long term certificate credentials</span></span>
<span class="line"><span style="color:#24292E;">[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span></span>
<span class="line"><span style="color:#24292E;">[bootstrap-token] configured RBAC rules to allow certificate rotation </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> all node client certificates </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> the cluster</span></span>
<span class="line"><span style="color:#24292E;">[bootstrap-token] Creating the </span><span style="color:#032F62;">&quot;cluster-info&quot;</span><span style="color:#24292E;"> ConfigMap </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> the </span><span style="color:#032F62;">&quot;kube-public&quot;</span><span style="color:#24292E;"> namespace</span></span>
<span class="line"><span style="color:#24292E;">[kubelet-finalize] Updating </span><span style="color:#032F62;">&quot;/etc/kubernetes/kubelet.conf&quot;</span><span style="color:#24292E;"> to point to a rotatable kubelet client certificate and key</span></span>
<span class="line"><span style="color:#24292E;">[addons] Applied essential addon: CoreDNS</span></span>
<span class="line"><span style="color:#24292E;">[addons] Applied essential addon: kube-proxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Your</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Kubernetes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">control-plane</span><span style="color:#24292E;"> </span><span style="color:#032F62;">has</span><span style="color:#24292E;"> </span><span style="color:#032F62;">initialized</span><span style="color:#24292E;"> </span><span style="color:#032F62;">successfully!</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">To</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">using</span><span style="color:#24292E;"> </span><span style="color:#032F62;">your</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">need</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">following</span><span style="color:#24292E;"> </span><span style="color:#032F62;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">a</span><span style="color:#24292E;"> </span><span style="color:#032F62;">regular</span><span style="color:#24292E;"> </span><span style="color:#032F62;">user:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> $HOME</span><span style="color:#032F62;">/.kube</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-i</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/admin.conf</span><span style="color:#24292E;"> $HOME</span><span style="color:#032F62;">/.kube/config</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">chown</span><span style="color:#24292E;"> </span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">id</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-u</span><span style="color:#032F62;">):$(</span><span style="color:#6F42C1;">id</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-g</span><span style="color:#032F62;">)</span><span style="color:#24292E;"> $HOME</span><span style="color:#032F62;">/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Alternatively,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">if</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">are</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">user,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">can</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">export</span><span style="color:#24292E;"> KUBECONFIG</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/kubernetes/admin.conf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">You</span><span style="color:#24292E;"> </span><span style="color:#032F62;">should</span><span style="color:#24292E;"> </span><span style="color:#032F62;">now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deploy</span><span style="color:#24292E;"> </span><span style="color:#032F62;">a</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">network</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster.</span></span>
<span class="line"><span style="color:#6F42C1;">Run</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;kubectl apply -f [podnetwork].yaml&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">with</span><span style="color:#24292E;"> </span><span style="color:#032F62;">one</span><span style="color:#24292E;"> </span><span style="color:#032F62;">of</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">options</span><span style="color:#24292E;"> </span><span style="color:#032F62;">listed</span><span style="color:#24292E;"> </span><span style="color:#032F62;">at:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">https://kubernetes.io/docs/concepts/cluster-administration/addons/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">You</span><span style="color:#24292E;"> </span><span style="color:#032F62;">can</span><span style="color:#24292E;"> </span><span style="color:#032F62;">now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">join</span><span style="color:#24292E;"> </span><span style="color:#032F62;">any</span><span style="color:#24292E;"> </span><span style="color:#032F62;">number</span><span style="color:#24292E;"> </span><span style="color:#032F62;">of</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">control-plane</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">running</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">following</span><span style="color:#24292E;"> </span><span style="color:#032F62;">command</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">each</span><span style="color:#24292E;"> </span><span style="color:#032F62;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">join</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.103</span><span style="color:#032F62;">.236.201:6443</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--token</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7</span><span style="color:#032F62;">t2weq.bjbawausm0jaxury</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">--discovery-token-ca-cert-hash</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sha256:89ad2d95b4ffcdbf9370ccc4925f0195a80e98e5436404ecef548091db31b234</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">--control-plane</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--certificate-key</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1980</span><span style="color:#032F62;">f439d979e2f4f73105f2230d6c962b811edde47ea7e18bead49e8d284132</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Please</span><span style="color:#24292E;"> </span><span style="color:#032F62;">note</span><span style="color:#24292E;"> </span><span style="color:#032F62;">that</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">certificate-key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gives</span><span style="color:#24292E;"> </span><span style="color:#032F62;">access</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sensitive</span><span style="color:#24292E;"> </span><span style="color:#032F62;">data,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">keep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">it</span><span style="color:#24292E;"> </span><span style="color:#032F62;">secret!</span></span>
<span class="line"><span style="color:#6F42C1;">As</span><span style="color:#24292E;"> </span><span style="color:#032F62;">a</span><span style="color:#24292E;"> </span><span style="color:#032F62;">safeguard,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">uploaded-certs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">will</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deleted</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">two</span><span style="color:#24292E;"> </span><span style="color:#032F62;">hours</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">If</span><span style="color:#24292E;"> </span><span style="color:#032F62;">necessary,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">can</span><span style="color:#24292E;"> </span><span style="color:#032F62;">use</span></span>
<span class="line"><span style="color:#6F42C1;">&quot;kubeadm init phase upload-certs --upload-certs&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">reload</span><span style="color:#24292E;"> </span><span style="color:#032F62;">certs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">afterward.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">can</span><span style="color:#24292E;"> </span><span style="color:#032F62;">join</span><span style="color:#24292E;"> </span><span style="color:#032F62;">any</span><span style="color:#24292E;"> </span><span style="color:#032F62;">number</span><span style="color:#24292E;"> </span><span style="color:#032F62;">of</span><span style="color:#24292E;"> </span><span style="color:#032F62;">worker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">by</span><span style="color:#24292E;"> </span><span style="color:#032F62;">running</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">following</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">each</span><span style="color:#24292E;"> </span><span style="color:#032F62;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">join</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.103</span><span style="color:#032F62;">.236.201:6443</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--token</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7</span><span style="color:#032F62;">t2weq.bjbawausm0jaxury</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">--discovery-token-ca-cert-hash</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sha256:89ad2d95b4ffcdbf9370ccc4925f0195a80e98e5436404ecef548091db31b234</span></span></code></pre></div><blockquote><p>如果初始化失败，重置后再次初始化，命令如下（没有失败不要执行）</p><p>kubeadm reset -f ; ipvsadm --clear ; rm -rf ~/.kube</p></blockquote><h3 id="配置访问k8s集群配置文件" tabindex="-1">配置访问k8s集群配置文件 <a class="header-anchor" href="#配置访问k8s集群配置文件" aria-label="Permalink to &quot;配置访问k8s集群配置文件&quot;">​</a></h3><p>Master01节点配置环境变量，用于访问Kubernetes集群，如果不配置则提示如下信息：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm]# kubectl get node</span></span>
<span class="line"><span style="color:#B392F0;">The</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connection</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localhost:8080</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">was</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">refused</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">did</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">specify</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">right</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">host</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">or</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">port?</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubeadm]# kubectl get node</span></span>
<span class="line"><span style="color:#6F42C1;">The</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connection</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localhost:8080</span><span style="color:#24292E;"> </span><span style="color:#032F62;">was</span><span style="color:#24292E;"> </span><span style="color:#032F62;">refused</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">did</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">specify</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">right</span><span style="color:#24292E;"> </span><span style="color:#032F62;">host</span><span style="color:#24292E;"> </span><span style="color:#032F62;">or</span><span style="color:#24292E;"> </span><span style="color:#032F62;">port?</span></span></code></pre></div><p>添加可以访问集群的配置</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> $HOME</span><span style="color:#9ECBFF;">/.kube</span></span>
<span class="line"><span style="color:#B392F0;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-i</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/admin.conf</span><span style="color:#E1E4E8;"> $HOME</span><span style="color:#9ECBFF;">/.kube/config</span></span>
<span class="line"><span style="color:#B392F0;">chown</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">id</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-u</span><span style="color:#9ECBFF;">):$(</span><span style="color:#B392F0;">id</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-g</span><span style="color:#9ECBFF;">)</span><span style="color:#E1E4E8;"> $HOME</span><span style="color:#9ECBFF;">/.kube/config</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> $HOME</span><span style="color:#032F62;">/.kube</span></span>
<span class="line"><span style="color:#6F42C1;">cp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-i</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/admin.conf</span><span style="color:#24292E;"> $HOME</span><span style="color:#032F62;">/.kube/config</span></span>
<span class="line"><span style="color:#6F42C1;">chown</span><span style="color:#24292E;"> </span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">id</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-u</span><span style="color:#032F62;">):$(</span><span style="color:#6F42C1;">id</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-g</span><span style="color:#032F62;">)</span><span style="color:#24292E;"> $HOME</span><span style="color:#032F62;">/.kube/config</span></span></code></pre></div><ul><li>或者</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> /root/.bashrc</span></span>
<span class="line"><span style="color:#9ECBFF;">export KUBECONFIG=/etc/kubernetes/admin.conf</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#79B8FF;">source</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/root/.bashrc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> /root/.bashrc</span></span>
<span class="line"><span style="color:#032F62;">export KUBECONFIG=/etc/kubernetes/admin.conf</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#005CC5;">source</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/root/.bashrc</span></span></code></pre></div><h3 id="查看状态" tabindex="-1">查看状态 <a class="header-anchor" href="#查看状态" aria-label="Permalink to &quot;查看状态&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubernetes]# kubectl get node</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">ROLES</span><span style="color:#E1E4E8;">                  </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">VERSION</span></span>
<span class="line"><span style="color:#B392F0;">k8s-master01</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">NotReady</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">control-plane,master</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">6</span><span style="color:#9ECBFF;">m19s</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.17</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubernetes]# kubectl get node</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">           </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">     </span><span style="color:#032F62;">ROLES</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">     </span><span style="color:#032F62;">VERSION</span></span>
<span class="line"><span style="color:#6F42C1;">k8s-master01</span><span style="color:#24292E;">   </span><span style="color:#032F62;">NotReady</span><span style="color:#24292E;">   </span><span style="color:#032F62;">control-plane,master</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">m19s</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.17</span></span></code></pre></div><p>采用初始化安装方式，所有的系统组件均以容器的方式运行并且在kube-system命名空间内，此时可以查看Pod状态：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubernetes]# kubectl get pod -n kube-system</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                   </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">coredns-7d89d9b6b8-72nw2</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Pending</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">8</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">coredns-7d89d9b6b8-fwkbz</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Pending</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">8</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">etcd-k8s-master01</span><span style="color:#E1E4E8;">                      </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">8</span><span style="color:#9ECBFF;">m14s</span></span>
<span class="line"><span style="color:#B392F0;">kube-apiserver-k8s-master01</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">8</span><span style="color:#9ECBFF;">m14s</span></span>
<span class="line"><span style="color:#B392F0;">kube-controller-manager-k8s-master01</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">8</span><span style="color:#9ECBFF;">m14s</span></span>
<span class="line"><span style="color:#B392F0;">kube-proxy-8z6lf</span><span style="color:#E1E4E8;">                       </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">8</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">kube-scheduler-k8s-master01</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">8</span><span style="color:#9ECBFF;">m14s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubernetes]# kubectl get pod -n kube-system</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                   </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">coredns-7d89d9b6b8-72nw2</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">8</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">coredns-7d89d9b6b8-fwkbz</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">8</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">etcd-k8s-master01</span><span style="color:#24292E;">                      </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">8</span><span style="color:#032F62;">m14s</span></span>
<span class="line"><span style="color:#6F42C1;">kube-apiserver-k8s-master01</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">8</span><span style="color:#032F62;">m14s</span></span>
<span class="line"><span style="color:#6F42C1;">kube-controller-manager-k8s-master01</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">8</span><span style="color:#032F62;">m14s</span></span>
<span class="line"><span style="color:#6F42C1;">kube-proxy-8z6lf</span><span style="color:#24292E;">                       </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">8</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">kube-scheduler-k8s-master01</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">8</span><span style="color:#032F62;">m14s</span></span></code></pre></div><h2 id="_6-4node节点加入" tabindex="-1">6.4node节点加入 <a class="header-anchor" href="#_6-4node节点加入" aria-label="Permalink to &quot;6.4node节点加入&quot;">​</a></h2><p><strong>到node节点下执行如下命令</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">join</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.103</span><span style="color:#9ECBFF;">.236.201:6443</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--token</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7</span><span style="color:#9ECBFF;">t2weq.bjbawausm0jaxury</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--discovery-token-ca-cert-hash </span><span style="color:#9ECBFF;">sha256:89ad2d95b4ffcdbf9370ccc4925f0195a80e98e5436404ecef548091db31b234</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">join</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.103</span><span style="color:#032F62;">.236.201:6443</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--token</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7</span><span style="color:#032F62;">t2weq.bjbawausm0jaxury</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--discovery-token-ca-cert-hash </span><span style="color:#032F62;">sha256:89ad2d95b4ffcdbf9370ccc4925f0195a80e98e5436404ecef548091db31b234</span></span></code></pre></div><p>如果node节点加入失败，删除如下文件，重新加入</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/kubelet</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-rf</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">rm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/kubelet</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-rf</span></span></code></pre></div><h2 id="_6-5master节点加入" tabindex="-1">6.5master节点加入 <a class="header-anchor" href="#_6-5master节点加入" aria-label="Permalink to &quot;6.5master节点加入&quot;">​</a></h2><p><strong>到master节点下执行如下命令</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">join</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.103</span><span style="color:#9ECBFF;">.236.201:6443</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--token</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7</span><span style="color:#9ECBFF;">t2weq.bjbawausm0jaxury</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">--discovery-token-ca-cert-hash</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sha256:89ad2d95b4ffcdbf9370ccc4925f0195a80e98e5436404ecef548091db31b234</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">--control-plane</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--certificate-key</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1980</span><span style="color:#9ECBFF;">f439d979e2f4f73105f2230d6c962b811edde47ea7e18bead49e8d284132</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">join</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.103</span><span style="color:#032F62;">.236.201:6443</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--token</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7</span><span style="color:#032F62;">t2weq.bjbawausm0jaxury</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">--discovery-token-ca-cert-hash</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sha256:89ad2d95b4ffcdbf9370ccc4925f0195a80e98e5436404ecef548091db31b234</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">--control-plane</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--certificate-key</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1980</span><span style="color:#032F62;">f439d979e2f4f73105f2230d6c962b811edde47ea7e18bead49e8d284132</span></span></code></pre></div><h3 id="key过期" tabindex="-1">key过期 <a class="header-anchor" href="#key过期" aria-label="Permalink to &quot;key过期&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看token过期时间，同new.yaml查看用的是那个key</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get secret -n kube-system </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7</span><span style="color:#9ECBFF;">t2weq</span></span>
<span class="line"><span style="color:#B392F0;">bootstrap-token-7t2weq</span><span style="color:#E1E4E8;">                           </span><span style="color:#9ECBFF;">bootstrap.kubernetes.io/token</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">68</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看token详情</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get secret -n kube-system bootstrap-token-7t2weq  -oyaml</span></span>
<span class="line"><span style="color:#B392F0;">apiVersion:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#B392F0;">data:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">auth-extra-groups:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">c3lzdGVtOmJvb3RzdHJhcHBlcnM6a3ViZWFkbTpkZWZhdWx0LW5vZGUtdG9rZW4=</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">expiration:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MjAyNC0wNC0xMVQwODozMjowNFo=</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">token-id:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N3Qyd2Vx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">token-secret:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">YmpiYXdhdXNtMGpheHVyeQ==</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">usage-bootstrap-authentication:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dHJ1ZQ==</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">usage-bootstrap-signing:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dHJ1ZQ==</span></span>
<span class="line"><span style="color:#B392F0;">kind:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Secret</span></span>
<span class="line"><span style="color:#B392F0;">metadata:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">creationTimestamp:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;2024-04-10T08:32:04Z&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bootstrap-token-7t2weq</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">namespace:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">resourceVersion:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;225&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">uid:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">da1a3e6f-1738-4fc6-a8ef-487a7bb70ec5</span></span>
<span class="line"><span style="color:#79B8FF;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">bootstrap.kubernetes.io/token</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#解密，查看时间</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# echo </span><span style="color:#9ECBFF;">&quot;MjAyNC0wNC0xMVQwODozMjowNFo=&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">base64</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span></span>
<span class="line"><span style="color:#B392F0;">2024-04-11T08:32:04Z</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Token过期后生成新的token：</span></span>
<span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">token</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--print-join-command</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Master需要生成--certificate-key</span></span>
<span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">init</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">phase</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">upload-certs</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--upload-certs</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看token过期时间，同new.yaml查看用的是那个key</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get secret -n kube-system </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7</span><span style="color:#032F62;">t2weq</span></span>
<span class="line"><span style="color:#6F42C1;">bootstrap-token-7t2weq</span><span style="color:#24292E;">                           </span><span style="color:#032F62;">bootstrap.kubernetes.io/token</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">68</span><span style="color:#032F62;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看token详情</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get secret -n kube-system bootstrap-token-7t2weq  -oyaml</span></span>
<span class="line"><span style="color:#6F42C1;">apiVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#6F42C1;">data:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">auth-extra-groups:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">c3lzdGVtOmJvb3RzdHJhcHBlcnM6a3ViZWFkbTpkZWZhdWx0LW5vZGUtdG9rZW4=</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">expiration:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MjAyNC0wNC0xMVQwODozMjowNFo=</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">token-id:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N3Qyd2Vx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">token-secret:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">YmpiYXdhdXNtMGpheHVyeQ==</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">usage-bootstrap-authentication:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dHJ1ZQ==</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">usage-bootstrap-signing:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dHJ1ZQ==</span></span>
<span class="line"><span style="color:#6F42C1;">kind:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Secret</span></span>
<span class="line"><span style="color:#6F42C1;">metadata:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">creationTimestamp:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;2024-04-10T08:32:04Z&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bootstrap-token-7t2weq</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">namespace:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">resourceVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;225&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">uid:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">da1a3e6f-1738-4fc6-a8ef-487a7bb70ec5</span></span>
<span class="line"><span style="color:#005CC5;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">bootstrap.kubernetes.io/token</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#解密，查看时间</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# echo </span><span style="color:#032F62;">&quot;MjAyNC0wNC0xMVQwODozMjowNFo=&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">base64</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span></span>
<span class="line"><span style="color:#6F42C1;">2024-04-11T08:32:04Z</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Token过期后生成新的token：</span></span>
<span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">token</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--print-join-command</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Master需要生成--certificate-key</span></span>
<span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">init</span><span style="color:#24292E;"> </span><span style="color:#032F62;">phase</span><span style="color:#24292E;"> </span><span style="color:#032F62;">upload-certs</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">--upload-certs</span></span></code></pre></div><h1 id="_7-kubernetes组件安装" tabindex="-1">7.Kubernetes组件安装 <a class="header-anchor" href="#_7-kubernetes组件安装" aria-label="Permalink to &quot;7.Kubernetes组件安装&quot;">​</a></h1><h2 id="_7-1-calico" tabindex="-1">7.1 Calico <a class="header-anchor" href="#_7-1-calico" aria-label="Permalink to &quot;7.1 Calico&quot;">​</a></h2><p>Calico可以控制策略，而flannel 不能</p><p><code>以下步骤只在master01执行</code></p><p>只修改pod网段</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">POD_SUBNET</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">cat</span><span style="color:#9ECBFF;"> /etc/kubernetes/manifests/kube-controller-manager.yaml </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> cluster-cidr= </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">awk</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-F=</span><span style="color:#9ECBFF;"> &#39;{print $NF}&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">sed</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-i</span><span style="color:#9ECBFF;"> &quot;s#POD_CIDR#\${</span><span style="color:#E1E4E8;">POD_SUBNET</span><span style="color:#9ECBFF;">}#g&quot; calico.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#安装</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> apply </span><span style="color:#79B8FF;">-f</span><span style="color:#9ECBFF;"> calico.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">POD_SUBNET</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">cat</span><span style="color:#032F62;"> /etc/kubernetes/manifests/kube-controller-manager.yaml </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> cluster-cidr= </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">awk</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-F=</span><span style="color:#032F62;"> &#39;{print $NF}&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">sed</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-i</span><span style="color:#032F62;"> &quot;s#POD_CIDR#\${</span><span style="color:#24292E;">POD_SUBNET</span><span style="color:#032F62;">}#g&quot; calico.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#安装</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#032F62;"> apply </span><span style="color:#005CC5;">-f</span><span style="color:#032F62;"> calico.yaml</span></span></code></pre></div><ul><li>再次查看状态，此时已变成ready状态</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get node</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">ROLES</span><span style="color:#E1E4E8;">                  </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">VERSION</span></span>
<span class="line"><span style="color:#B392F0;">k8s-master01</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">control-plane,master</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">5</span><span style="color:#9ECBFF;">h16m</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">kube-node01</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">5</span><span style="color:#9ECBFF;">h4m</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">kube-node02</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">h51m</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">kube-node03</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">h49m</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.17</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get node</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">           </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ROLES</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">     </span><span style="color:#032F62;">VERSION</span></span>
<span class="line"><span style="color:#6F42C1;">k8s-master01</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#032F62;">control-plane,master</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">h16m</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">kube-node01</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">h4m</span><span style="color:#24292E;">    </span><span style="color:#032F62;">v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">kube-node02</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">h51m</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">kube-node03</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">h49m</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.17</span></span></code></pre></div><h2 id="_7-2-metrics部署" tabindex="-1">7.2 Metrics部署 <a class="header-anchor" href="#_7-2-metrics部署" aria-label="Permalink to &quot;7.2 Metrics部署&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">将Master01节点的front-proxy-ca.crt复制到所有Node节点</span></span>
<span class="line"><span style="color:#B392F0;">scp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/front-proxy-ca.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-node01:/etc/kubernetes/pki/front-proxy-ca.crt</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#创建</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm-metrics-server]# kubectl  create -f comp.yaml</span></span>
<span class="line"><span style="color:#B392F0;">serviceaccount/metrics-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">clusterrole.rbac.authorization.k8s.io/system:metrics-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">service/metrics-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">deployment.apps/metrics-server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看状态</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm-metrics-server]# kubectl get po -n kube-system -l k8s-app=metrics-server</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                              </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">metrics-server-54544fbf96-sjbvt</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">49</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#执行监控命令</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm-metrics-server]# kubectl top node</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">CPU</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">cores</span><span style="color:#E1E4E8;">)   </span><span style="color:#9ECBFF;">CPU%</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">MEMORY</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">bytes</span><span style="color:#E1E4E8;">)   </span><span style="color:#9ECBFF;">MEMORY%</span></span>
<span class="line"><span style="color:#B392F0;">k8s-master01</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">182</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">9</span><span style="color:#9ECBFF;">%</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">1204</span><span style="color:#9ECBFF;">Mi</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">65</span><span style="color:#9ECBFF;">%</span></span>
<span class="line"><span style="color:#B392F0;">kube-node01</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">64</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">%</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">639</span><span style="color:#9ECBFF;">Mi</span><span style="color:#E1E4E8;">           </span><span style="color:#79B8FF;">34</span><span style="color:#9ECBFF;">%</span></span>
<span class="line"><span style="color:#B392F0;">kube-node02</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">63</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">6</span><span style="color:#9ECBFF;">%</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">659</span><span style="color:#9ECBFF;">Mi</span><span style="color:#E1E4E8;">           </span><span style="color:#79B8FF;">35</span><span style="color:#9ECBFF;">%</span></span>
<span class="line"><span style="color:#B392F0;">kube-node03</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">83</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">8</span><span style="color:#9ECBFF;">%</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">734</span><span style="color:#9ECBFF;">Mi</span><span style="color:#E1E4E8;">           </span><span style="color:#79B8FF;">39</span><span style="color:#9ECBFF;">%</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">将Master01节点的front-proxy-ca.crt复制到所有Node节点</span></span>
<span class="line"><span style="color:#6F42C1;">scp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/front-proxy-ca.crt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-node01:/etc/kubernetes/pki/front-proxy-ca.crt</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#创建</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master kubeadm-metrics-server]# kubectl  create -f comp.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">serviceaccount/metrics-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">clusterrole.rbac.authorization.k8s.io/system:metrics-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">service/metrics-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/metrics-server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看状态</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master kubeadm-metrics-server]# kubectl get po -n kube-system -l k8s-app=metrics-server</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                              </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">metrics-server-54544fbf96-sjbvt</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">49</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#执行监控命令</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master kubeadm-metrics-server]# kubectl top node</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">           </span><span style="color:#032F62;">CPU</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">cores</span><span style="color:#24292E;">)   </span><span style="color:#032F62;">CPU%</span><span style="color:#24292E;">   </span><span style="color:#032F62;">MEMORY</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">bytes</span><span style="color:#24292E;">)   </span><span style="color:#032F62;">MEMORY%</span></span>
<span class="line"><span style="color:#6F42C1;">k8s-master01</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">182</span><span style="color:#032F62;">m</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">9</span><span style="color:#032F62;">%</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1204</span><span style="color:#032F62;">Mi</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">65</span><span style="color:#032F62;">%</span></span>
<span class="line"><span style="color:#6F42C1;">kube-node01</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">64</span><span style="color:#032F62;">m</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">%</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">639</span><span style="color:#032F62;">Mi</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">34</span><span style="color:#032F62;">%</span></span>
<span class="line"><span style="color:#6F42C1;">kube-node02</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">63</span><span style="color:#032F62;">m</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">%</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">659</span><span style="color:#032F62;">Mi</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">35</span><span style="color:#032F62;">%</span></span>
<span class="line"><span style="color:#6F42C1;">kube-node03</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">83</span><span style="color:#032F62;">m</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">8</span><span style="color:#032F62;">%</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">734</span><span style="color:#032F62;">Mi</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">39</span><span style="color:#032F62;">%</span></span></code></pre></div><h1 id="_8-kubernetes集群状态测试" tabindex="-1">8.Kubernetes集群状态测试 <a class="header-anchor" href="#_8-kubernetes集群状态测试" aria-label="Permalink to &quot;8.Kubernetes集群状态测试&quot;">​</a></h1><h2 id="_8-1创建" tabindex="-1">8.1创建 <a class="header-anchor" href="#_8-1创建" aria-label="Permalink to &quot;8.1创建&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deployment</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--image=nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--replicas=3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#创建负载均衡</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">expose</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deployment</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--port=8080</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--target-port=80</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看pod，默认命名空间是defalut</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get pod</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                     </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">nginx-6799fc88d8-c4w7r</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">m18s</span></span>
<span class="line"><span style="color:#B392F0;">nginx-6799fc88d8-j7fvt</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">m18s</span></span>
<span class="line"><span style="color:#B392F0;">nginx-6799fc88d8-n5zs8</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">m18s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看service</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master calico]# kubectl get service</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">CLUSTER-IP</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">EXTERNAL-IP</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">PORT</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">S</span><span style="color:#E1E4E8;">)    </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">kubernetes</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">ClusterIP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.0.1</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">443</span><span style="color:#9ECBFF;">/TCP</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">6</span><span style="color:#9ECBFF;">h2m</span></span>
<span class="line"><span style="color:#B392F0;">nginx</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">ClusterIP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.23.94</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">8080</span><span style="color:#9ECBFF;">/TCP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">39</span><span style="color:#9ECBFF;">s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--image=nginx</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--replicas=3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#创建负载均衡</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">expose</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--port=8080</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--target-port=80</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看pod，默认命名空间是defalut</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pod</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                     </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-6799fc88d8-c4w7r</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m18s</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-6799fc88d8-j7fvt</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m18s</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-6799fc88d8-n5zs8</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m18s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看service</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master calico]# kubectl get service</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">         </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">        </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">      </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)    </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">kubernetes</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.0.1</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">443</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">h2m</span></span>
<span class="line"><span style="color:#6F42C1;">nginx</span><span style="color:#24292E;">        </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.23.94</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">8080</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">39</span><span style="color:#032F62;">s</span></span></code></pre></div><h2 id="_8-2检查ip连通性" tabindex="-1">8.2检查ip连通性 <a class="header-anchor" href="#_8-2检查ip连通性" aria-label="Permalink to &quot;8.2检查ip连通性&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master calico]# kubectl get pod -o wide</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                     </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">IP</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">NOMINATED</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">READINESS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GATES</span></span>
<span class="line"><span style="color:#B392F0;">nginx-6799fc88d8-c4w7r</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">17</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.17</span><span style="color:#9ECBFF;">.74.71</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">kube-node03</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">nginx-6799fc88d8-j7fvt</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">17</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.23</span><span style="color:#9ECBFF;">.127.65</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">kube-node02</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">nginx-6799fc88d8-n5zs8</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">17</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.30</span><span style="color:#9ECBFF;">.0.129</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">kube-node01</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#在每个节点上ping其他pod节点上的ip</span></span>
<span class="line"><span style="color:#B392F0;">ping</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod-ip</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master calico]# kubectl get pod -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                     </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">              </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">          </span><span style="color:#032F62;">NOMINATED</span><span style="color:#24292E;"> </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READINESS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GATES</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-6799fc88d8-c4w7r</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">17</span><span style="color:#032F62;">m</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.17</span><span style="color:#032F62;">.74.71</span><span style="color:#24292E;">    </span><span style="color:#032F62;">kube-node03</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-6799fc88d8-j7fvt</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">17</span><span style="color:#032F62;">m</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.23</span><span style="color:#032F62;">.127.65</span><span style="color:#24292E;">   </span><span style="color:#032F62;">kube-node02</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-6799fc88d8-n5zs8</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">17</span><span style="color:#032F62;">m</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.30</span><span style="color:#032F62;">.0.129</span><span style="color:#24292E;">    </span><span style="color:#032F62;">kube-node01</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#在每个节点上ping其他pod节点上的ip</span></span>
<span class="line"><span style="color:#6F42C1;">ping</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod-ip</span></span></code></pre></div><h2 id="_8-3检查service可达性" tabindex="-1">8.3检查service可达性 <a class="header-anchor" href="#_8-3检查service可达性" aria-label="Permalink to &quot;8.3检查service可达性&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#在每个节点上访问服务</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">service-ip:port</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#在每个节点上访问服务</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">service-ip:port</span></span></code></pre></div><h2 id="_8-4检查dns" tabindex="-1">8.4检查dns <a class="header-anchor" href="#_8-4检查dns" aria-label="Permalink to &quot;8.4检查dns&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#进入pod容器中去</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master calico]# kubectl exec -it nginx-6799fc88d8-c4w7r -- /bin/bash</span></span>
<span class="line"><span style="color:#B392F0;">root@nginx-6799fc88d8-c4w7r:/#</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.23.94:8080</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">root@nginx-6799fc88d8-c4w7r:/#</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nginx:8080</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看dns解析</span></span>
<span class="line"><span style="color:#B392F0;">root@nginx-6799fc88d8-c4w7r:/#</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/resolv.conf</span></span>
<span class="line"><span style="color:#B392F0;">nameserver</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.0.10</span></span>
<span class="line"><span style="color:#B392F0;">search</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">default.svc.cluster.local</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">svc.cluster.local</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster.local</span></span>
<span class="line"><span style="color:#B392F0;">options</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ndots:5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master calico]# kubectl get service -n kube-system</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">CLUSTER-IP</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">EXTERNAL-IP</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">PORT</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">S</span><span style="color:#E1E4E8;">)                  </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">kube-dns</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">ClusterIP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.0.10</span><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">53</span><span style="color:#9ECBFF;">/UDP,53/TCP,9153/TCP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">6</span><span style="color:#9ECBFF;">h24m</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl exec -it nginx-6799fc88d8-fqrlx -- /bin/bash</span></span>
<span class="line"><span style="color:#B392F0;">root@nginx-6799fc88d8-fqrlx:/#</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nginx.default.svc.cluster.local:8080</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#进入pod容器中去</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master calico]# kubectl exec -it nginx-6799fc88d8-c4w7r -- /bin/bash</span></span>
<span class="line"><span style="color:#6F42C1;">root@nginx-6799fc88d8-c4w7r:/#</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.23.94:8080</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">root@nginx-6799fc88d8-c4w7r:/#</span><span style="color:#24292E;"> </span><span style="color:#032F62;">curl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx:8080</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看dns解析</span></span>
<span class="line"><span style="color:#6F42C1;">root@nginx-6799fc88d8-c4w7r:/#</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/resolv.conf</span></span>
<span class="line"><span style="color:#6F42C1;">nameserver</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.0.10</span></span>
<span class="line"><span style="color:#6F42C1;">search</span><span style="color:#24292E;"> </span><span style="color:#032F62;">default.svc.cluster.local</span><span style="color:#24292E;"> </span><span style="color:#032F62;">svc.cluster.local</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">options</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ndots:5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master calico]# kubectl get service -n kube-system</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">           </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">        </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">        </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)                  </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">kube-dns</span><span style="color:#24292E;">       </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.0.10</span><span style="color:#24292E;">      </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">53</span><span style="color:#032F62;">/UDP,53/TCP,9153/TCP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">h24m</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl exec -it nginx-6799fc88d8-fqrlx -- /bin/bash</span></span>
<span class="line"><span style="color:#6F42C1;">root@nginx-6799fc88d8-fqrlx:/#</span><span style="color:#24292E;"> </span><span style="color:#032F62;">curl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx.default.svc.cluster.local:8080</span></span></code></pre></div><h1 id="_9-ipvs" tabindex="-1">9.IPVS <a class="header-anchor" href="#_9-ipvs" aria-label="Permalink to &quot;9.IPVS&quot;">​</a></h1><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#默认是iptables，由于性能不强，需更换成ipvs</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# curl 127.0.0.1:10249/proxyMode</span></span>
<span class="line"><span style="color:#B392F0;">iptables</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#在控制节点修改configmap</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">edit</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-proxy</span></span>
<span class="line"><span style="color:#B392F0;">mode:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;ipvs&quot;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#默认没有值是iptables工作模式</span></span>
<span class="line"><span style="color:#6A737D;">#或者</span></span>
<span class="line"><span style="color:#6A737D;">#更新Kube-Proxy的Pod</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patch</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemonset</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-proxy</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;{</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">spec</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">:{</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">template</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">:{</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">metadata</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">:{</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">annotations</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">:{</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">date</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">:</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">date</span><span style="color:#9ECBFF;"> +&#39;%s&#39;\`</span><span style="color:#79B8FF;">\\&quot;</span><span style="color:#9ECBFF;">}}}}}&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#验证</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# curl 127.0.0.1:10249/proxyMode</span></span>
<span class="line"><span style="color:#B392F0;">ipvs</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#默认是iptables，由于性能不强，需更换成ipvs</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# curl 127.0.0.1:10249/proxyMode</span></span>
<span class="line"><span style="color:#6F42C1;">iptables</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#在控制节点修改configmap</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">edit</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-proxy</span></span>
<span class="line"><span style="color:#6F42C1;">mode:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;ipvs&quot;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">#默认没有值是iptables工作模式</span></span>
<span class="line"><span style="color:#6A737D;">#或者</span></span>
<span class="line"><span style="color:#6A737D;">#更新Kube-Proxy的Pod</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patch</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemonset</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-proxy</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;{</span><span style="color:#005CC5;">\\&quot;</span><span style="color:#032F62;">spec</span><span style="color:#005CC5;">\\&quot;</span><span style="color:#032F62;">:{</span><span style="color:#005CC5;">\\&quot;</span><span style="color:#032F62;">template</span><span style="color:#005CC5;">\\&quot;</span><span style="color:#032F62;">:{</span><span style="color:#005CC5;">\\&quot;</span><span style="color:#032F62;">metadata</span><span style="color:#005CC5;">\\&quot;</span><span style="color:#032F62;">:{</span><span style="color:#005CC5;">\\&quot;</span><span style="color:#032F62;">annotations</span><span style="color:#005CC5;">\\&quot;</span><span style="color:#032F62;">:{</span><span style="color:#005CC5;">\\&quot;</span><span style="color:#032F62;">date</span><span style="color:#005CC5;">\\&quot;</span><span style="color:#032F62;">:</span><span style="color:#005CC5;">\\&quot;</span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">date</span><span style="color:#032F62;"> +&#39;%s&#39;\`</span><span style="color:#005CC5;">\\&quot;</span><span style="color:#032F62;">}}}}}&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#验证</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# curl 127.0.0.1:10249/proxyMode</span></span>
<span class="line"><span style="color:#6F42C1;">ipvs</span></span></code></pre></div><h1 id="_10-配置文件路径" tabindex="-1">10.配置文件路径 <a class="header-anchor" href="#_10-配置文件路径" aria-label="Permalink to &quot;10.配置文件路径&quot;">​</a></h1><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">/etc/kubernetes/manifests</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master manifests]# ls -trl</span></span>
<span class="line"><span style="color:#B392F0;">总用量</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span></span>
<span class="line"><span style="color:#B392F0;">-rw-------</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3392</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-apiserver.yaml</span></span>
<span class="line"><span style="color:#B392F0;">-rw-------</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2908</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-controller-manager.yaml</span></span>
<span class="line"><span style="color:#B392F0;">-rw-------</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1492</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-scheduler.yaml</span></span>
<span class="line"><span style="color:#B392F0;">-rw-------</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2322</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">这里面的配置文件，只要修改保存，会自动更新</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">/etc/kubernetes/manifests</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master manifests]# ls -trl</span></span>
<span class="line"><span style="color:#6F42C1;">总用量</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-------</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3392</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-apiserver.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-------</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2908</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-controller-manager.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-------</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1492</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-scheduler.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-------</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2322</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">这里面的配置文件，只要修改保存，会自动更新</span></span></code></pre></div><h1 id="_11-kubernetes环境清理" tabindex="-1">11.Kubernetes环境清理 <a class="header-anchor" href="#_11-kubernetes环境清理" aria-label="Permalink to &quot;11.Kubernetes环境清理&quot;">​</a></h1><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">reset</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">ifconfig</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tunl0</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">down</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">ip</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">link</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tunl0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-fr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/</span><span style="color:#79B8FF;">*</span></span>
<span class="line"><span style="color:#B392F0;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-fr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/cni/</span><span style="color:#79B8FF;">*</span></span>
<span class="line"><span style="color:#B392F0;">iptables</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-F</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">iptables</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nat</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-F</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">iptables</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mangle</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-F</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">iptables</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-X</span></span>
<span class="line"><span style="color:#B392F0;">ipvsadm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--clear</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stop</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker.socket</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stop</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">-----卸载</span></span>
<span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">reset</span></span>
<span class="line"><span style="color:#B392F0;">iptables</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-F</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">iptables</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nat</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-F</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">iptables</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mangle</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-F</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">iptables</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-X</span></span>
<span class="line"><span style="color:#B392F0;">ipvsadm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--clear</span></span>
<span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">remove</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span>
<span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">remove</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span>
<span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">remove</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker-ce</span><span style="color:#79B8FF;">*</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">reset</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">ifconfig</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tunl0</span><span style="color:#24292E;"> </span><span style="color:#032F62;">down</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">ip</span><span style="color:#24292E;"> </span><span style="color:#032F62;">link</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tunl0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-fr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/</span><span style="color:#005CC5;">*</span></span>
<span class="line"><span style="color:#6F42C1;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-fr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/cni/</span><span style="color:#005CC5;">*</span></span>
<span class="line"><span style="color:#6F42C1;">iptables</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-F</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">iptables</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nat</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-F</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">iptables</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mangle</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-F</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">iptables</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span></span>
<span class="line"><span style="color:#6F42C1;">ipvsadm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--clear</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker.socket</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">-----卸载</span></span>
<span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">reset</span></span>
<span class="line"><span style="color:#6F42C1;">iptables</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-F</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">iptables</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nat</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-F</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">iptables</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mangle</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-F</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">iptables</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span></span>
<span class="line"><span style="color:#6F42C1;">ipvsadm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--clear</span></span>
<span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">remove</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span>
<span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">remove</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span>
<span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">remove</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker-ce</span><span style="color:#005CC5;">*</span></span></code></pre></div><h1 id="_12-注意事项" tabindex="-1">12.注意事项 <a class="header-anchor" href="#_12-注意事项" aria-label="Permalink to &quot;12.注意事项&quot;">​</a></h1>`,173),e=[o];function t(c,r,y,E,i,F){return n(),a("div",null,e)}const C=s(p,[["render",t]]);export{u as __pageData,C as default};
