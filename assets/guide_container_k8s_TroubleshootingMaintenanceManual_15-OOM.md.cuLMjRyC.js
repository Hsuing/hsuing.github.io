import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const u=JSON.parse('{"title":"1. OOM影响因素","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/TroubleshootingMaintenanceManual/15-OOM.md","filePath":"guide/container/k8s/TroubleshootingMaintenanceManual/15-OOM.md","lastUpdated":1728986210000}'),p={name:"guide/container/k8s/TroubleshootingMaintenanceManual/15-OOM.md"},o=l(`<h1 id="_1-oom影响因素" tabindex="-1">1. OOM影响因素 <a class="header-anchor" href="#_1-oom影响因素" aria-label="Permalink to &quot;1. OOM影响因素&quot;">​</a></h1><ul><li>资源预留：影响的是节点的Allocatable的值</li><li>驱逐：kubelet对Pod进行驱逐时，只根据--eviction-hard参数（支持的指标参考本文），与system-reserved等参数无关。</li><li>OOM：当某个进程的内存超过自己的限制时，该进程会被docker(cgroup)杀掉。容器发生OOM的情况可能有两种： <ul><li>容器所使用的内存超出了自身的limit限制；</li><li>所有Pod使用的内存总和超出了 <code>/sys/fs/cgroup/memory/kubepods.slice/memory.limit_in_bytes</code>；</li></ul></li></ul><h1 id="_2-节点资源预留" tabindex="-1">2. 节点资源预留 <a class="header-anchor" href="#_2-节点资源预留" aria-label="Permalink to &quot;2. 节点资源预留&quot;">​</a></h1><h2 id="_2-1-什么要做资源预留" tabindex="-1">2.1 什么要做资源预留? <a class="header-anchor" href="#_2-1-什么要做资源预留" aria-label="Permalink to &quot;2.1 什么要做资源预留?&quot;">​</a></h2><p>1.Kubernetes的节点可以按照节点的资源容量进行调度，默认情况下Pod能够使用节点全部可用容量。这样就会造成一个问题，因为节点自己通常运行了不少驱动OS和Kubernetes的系统守护进程。除非为这些系统守护进程留出资源，否则它们将与Pod争夺资源并导致节点资源短缺问题。</p><p>2.当我们在线上使用Kubernetes集群的时候，如果没有对节点配置正确的资源预留，我们可以考虑一个场景，由于某个应用无限制的使用节点的CPU资源，导致节点上CPU使用持续100%运行，而且压榨到了kubelet组件的CPU使用，这样就会导致kubelet和 apiserver的心跳出问题，节点就会出现Not Ready状况了。默认情况下节点Not Ready过后，5分钟后会驱逐应用到其他节点，当这个应用跑到其他节点上的时候同样100%的使用CPU，是不是也会把这个节点搞挂掉，同样的情况继续下去，也就导致了整个集群的雪崩，集群内的节点一个一个的Not Ready了，后果是非常严重的，或多或少的人遇到过Kubernetes集群雪崩的情况，这个问题也是面试的时候镜像询问的问题。</p><p>3.要解决这个问题就需要为Kubernetes集群配置资源预留，kubelet暴露了一个名为NodeAllocatable的特性，有助于为系统守护进程预留计算资源，Kubernetes也是推荐集群管理员按照每个节点上的工作负载来配置NodeAllocatable。</p><p>节点压力驱逐是 kubelet 主动终止 Pod 以回收节点上资源的过程。kubelet 监控集群节点的 CPU、内存、磁盘空间和文件系统的 inode 等资源。 当这些资源中的一个或者多个达到特定的消耗水平， kubelet 可以主动地使节点上一个或者多个 Pod 失效，以回收资源防止资源不足。</p><h2 id="_2-2-查看节点资源" tabindex="-1">2.2 查看节点资源 <a class="header-anchor" href="#_2-2-查看节点资源" aria-label="Permalink to &quot;2.2 查看节点资源&quot;">​</a></h2><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410141418478.png" alt="img"></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查询节点可分配资源</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">describe</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> [NODE_NAME] </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Allocatable</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-B</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-A</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#预期输出</span></span>
<span class="line"><span style="color:#B392F0;">Capacity:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">cpu:</span><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">                 </span><span style="color:#6A737D;">#节点的CPU总核数。</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">ephemeral-storage:</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">123722704</span><span style="color:#9ECBFF;">Ki</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">#节点的临时存储总量，单位KiB。</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">hugepages-1Gi:</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">hugepages-2Mi:</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">memory:</span><span style="color:#E1E4E8;">             </span><span style="color:#79B8FF;">7925980</span><span style="color:#9ECBFF;">Ki</span><span style="color:#E1E4E8;">         </span><span style="color:#6A737D;">#节点的内存总量，单位KiB。</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">pods:</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">64</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#Allocatable 就是节点可被分配的资源，如果没有配置资源预留，默认情况下 Capacity 与 Allocatable 的值基本上是一致的</span></span>
<span class="line"><span style="color:#B392F0;">Allocatable:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">cpu:</span><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">3900</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;">             </span><span style="color:#6A737D;">#节点可分配的CPU核数。</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">ephemeral-storage:</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">114022843818</span><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">#节点可分配的临时存储，单位Byte。</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">hugepages-1Gi:</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">hugepages-2Mi:</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">memory:</span><span style="color:#E1E4E8;">             </span><span style="color:#79B8FF;">5824732</span><span style="color:#9ECBFF;">Ki</span><span style="color:#E1E4E8;">         </span><span style="color:#6A737D;">#节点可分配的内存，单位KiB。</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">pods:</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">64</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查询节点可分配资源</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">describe</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> [NODE_NAME] </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Allocatable</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-B</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-A</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#预期输出</span></span>
<span class="line"><span style="color:#6F42C1;">Capacity:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">cpu:</span><span style="color:#24292E;">                </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">                 </span><span style="color:#6A737D;">#节点的CPU总核数。</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">ephemeral-storage:</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">123722704</span><span style="color:#032F62;">Ki</span><span style="color:#24292E;">       </span><span style="color:#6A737D;">#节点的临时存储总量，单位KiB。</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">hugepages-1Gi:</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">hugepages-2Mi:</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">memory:</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">7925980</span><span style="color:#032F62;">Ki</span><span style="color:#24292E;">         </span><span style="color:#6A737D;">#节点的内存总量，单位KiB。</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">pods:</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">64</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#Allocatable 就是节点可被分配的资源，如果没有配置资源预留，默认情况下 Capacity 与 Allocatable 的值基本上是一致的</span></span>
<span class="line"><span style="color:#6F42C1;">Allocatable:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">cpu:</span><span style="color:#24292E;">                </span><span style="color:#005CC5;">3900</span><span style="color:#032F62;">m</span><span style="color:#24292E;">             </span><span style="color:#6A737D;">#节点可分配的CPU核数。</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">ephemeral-storage:</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">114022843818</span><span style="color:#24292E;">      </span><span style="color:#6A737D;">#节点可分配的临时存储，单位Byte。</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">hugepages-1Gi:</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">hugepages-2Mi:</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">memory:</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">5824732</span><span style="color:#032F62;">Ki</span><span style="color:#24292E;">         </span><span style="color:#6A737D;">#节点可分配的内存，单位KiB。</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">pods:</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">64</span></span></code></pre></div><ul><li>查看node</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master-01 kubelet]# free -k</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#B392F0;">total</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">used</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">free</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">shared</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">buff/cache</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">available</span></span>
<span class="line"><span style="color:#B392F0;">Mem:</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">3976836</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">1522420</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">959140</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">2140</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">1743812</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">2454416</span></span>
<span class="line"><span style="color:#B392F0;">Swap:</span><span style="color:#E1E4E8;">              </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">           </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">           </span><span style="color:#79B8FF;">0</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master-01 kubelet]# free -k</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#6F42C1;">total</span><span style="color:#24292E;">        </span><span style="color:#032F62;">used</span><span style="color:#24292E;">        </span><span style="color:#032F62;">free</span><span style="color:#24292E;">      </span><span style="color:#032F62;">shared</span><span style="color:#24292E;">  </span><span style="color:#032F62;">buff/cache</span><span style="color:#24292E;">   </span><span style="color:#032F62;">available</span></span>
<span class="line"><span style="color:#6F42C1;">Mem:</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">3976836</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1522420</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">959140</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">2140</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1743812</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">2454416</span></span>
<span class="line"><span style="color:#6F42C1;">Swap:</span><span style="color:#24292E;">              </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">0</span></span></code></pre></div><p>在kubernetes 1.6版本后，引入了Node的Allocatable特性，通过该特性我们可以控制每个节点可分配的资源，可分配资源和资源预留之间的关系，如下图</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410141350496.png" alt="image-20241014135037623"></p><ul><li>Kubelet Node Allocatable 用来为 Kube 组件和 System 进程预留资源，从而保证当节点出现满负荷时也能保证 Kube 和 System 进程有足够的资源。</li><li>目前支持 cpu, memory, ephemeral-storage 三种资源预留。</li><li>Node Capacity 是节点的所有硬件资源，kube-reserved 是给 kube 组件预留的资源，system-reserved 是给系统进程预留的资源，eviction-threshold 是 kubelet 驱逐的阈值设定，allocatable 才是真正调度器调度 Pod 时的参考值（保证节点上所有 Pods 的 request 资源不超过Allocatable）。</li></ul><p>节点可分配资源的计算方式为</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Allocatable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Resource</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Capacity</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Kube-reserved</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">system-reserved</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">eviction-threshold</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Allocatable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Resource</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Capacity</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Kube-reserved</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">system-reserved</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">eviction-threshold</span></span></code></pre></div><p>当kubelet启动后，<code>Node的allocatable就是固定的</code>，不会因为pod的创建与销毁而改变。</p><h2 id="_2-3-allocatable、-requests-和-limits-三者关系" tabindex="-1">2.3 allocatable、 requests 和 limits 三者关系 <a class="header-anchor" href="#_2-3-allocatable、-requests-和-limits-三者关系" aria-label="Permalink to &quot;2.3 allocatable、 requests 和 limits 三者关系&quot;">​</a></h2><p>在pod的yaml文件中，我们可以为pod设置requests与limits。其中limits与allocatable没有什么关系。但requests与allocatable关系紧密。调度到某个节点上的Pod的requests总和不能超过该节点的allocatable。limits的总和没有上限。</p><p>比如，某个节点的内存的allocatable为10Gi，有三个Pod（requests.memory=3Gi）已经调度到该节点上，那么第4个Pod就无法调度到该节点上，即使该Node上的空闲内存大于3Gi。</p><h2 id="_2-4-配置资源预留" tabindex="-1">2.4 配置资源预留 <a class="header-anchor" href="#_2-4-配置资源预留" aria-label="Permalink to &quot;2.4 配置资源预留&quot;">​</a></h2><p>系统资源预留分为两种<code>不设cgroup</code> 和 <code>设置cgroup</code>。</p><ul><li>不设cgroup：Pod使用的资源上限不会超过allocatable，如超过则被系统oom掉。系统使用资源超过kube-reserved和system-reserved阈值。可以使用allocatable的资源</li><li>设置cgroup：Pod使用的资源上限还是不会超过allocatable。但是系统使用资源超过kube-reserved和system-reserved阈值的话，会被cgroup杀掉。所以<code>推荐使用不设置cgroup。</code></li></ul><h3 id="不设cgroup" tabindex="-1">不设cgroup <a class="header-anchor" href="#不设cgroup" aria-label="Permalink to &quot;不设cgroup&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">--enforce-node-allocatable=pods</span></span>
<span class="line"><span style="color:#e1e4e8;">--kube-reserved=memory=...</span></span>
<span class="line"><span style="color:#e1e4e8;">--system-reserved=memory=...</span></span>
<span class="line"><span style="color:#e1e4e8;">--eviction-hard=...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">--enforce-node-allocatable=pods</span></span>
<span class="line"><span style="color:#24292e;">--kube-reserved=memory=...</span></span>
<span class="line"><span style="color:#24292e;">--system-reserved=memory=...</span></span>
<span class="line"><span style="color:#24292e;">--eviction-hard=...</span></span></code></pre></div><ul><li>修改kubelet.config配置</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">enforceNodeAllocatable</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#9ECBFF;">pods</span></span>
<span class="line"><span style="color:#85E89D;">kubeReserved</span><span style="color:#E1E4E8;">:  </span><span style="color:#6A737D;"># 配置 kube 资源预留</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">500m</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">1Gi</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ephemeral-storage</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">1Gi</span></span>
<span class="line"><span style="color:#85E89D;">systemReserved</span><span style="color:#E1E4E8;">:  </span><span style="color:#6A737D;"># 配置系统资源预留</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">1Gi</span></span>
<span class="line"><span style="color:#85E89D;">evictionHard</span><span style="color:#E1E4E8;">:    </span><span style="color:#6A737D;">#配置硬驱逐阈值</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">imagefs.available</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">15%</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">memory.available</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">100Mi</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">nodefs.available</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10%</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">nodefs.inodesFree</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">5%</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">enforceNodeAllocatable</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#032F62;">pods</span></span>
<span class="line"><span style="color:#22863A;">kubeReserved</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;"># 配置 kube 资源预留</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">500m</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">1Gi</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ephemeral-storage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">1Gi</span></span>
<span class="line"><span style="color:#22863A;">systemReserved</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;"># 配置系统资源预留</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">1Gi</span></span>
<span class="line"><span style="color:#22863A;">evictionHard</span><span style="color:#24292E;">:    </span><span style="color:#6A737D;">#配置硬驱逐阈值</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">imagefs.available</span><span style="color:#24292E;">: </span><span style="color:#032F62;">15%</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">memory.available</span><span style="color:#24292E;">: </span><span style="color:#032F62;">100Mi</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">nodefs.available</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10%</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">nodefs.inodesFree</span><span style="color:#24292E;">: </span><span style="color:#032F62;">5%</span></span></code></pre></div><ul><li>重启kubelet服务</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master-01 kubernetes]# kubectl describe node kube-master-01 </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Allocatable</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-B</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-A</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span></span>
<span class="line"><span style="color:#B392F0;">Capacity:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">cpu:</span><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">ephemeral-storage:</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">36400</span><span style="color:#9ECBFF;">Mi</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">hugepages-1Gi:</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">hugepages-2Mi:</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">memory:</span><span style="color:#E1E4E8;">             </span><span style="color:#79B8FF;">3976836</span><span style="color:#9ECBFF;">Ki</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">pods:</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">110</span></span>
<span class="line"><span style="color:#B392F0;">Allocatable:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">cpu:</span><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">1500</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">ephemeral-storage:</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">33277607880</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">hugepages-1Gi:</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">hugepages-2Mi:</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">memory:</span><span style="color:#E1E4E8;">             </span><span style="color:#79B8FF;">1777284</span><span style="color:#9ECBFF;">Ki</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">pods:</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">110</span></span>
<span class="line"><span style="color:#B392F0;">--</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Type</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Reason</span><span style="color:#E1E4E8;">                   </span><span style="color:#9ECBFF;">Age</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">From</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Message</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">----</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">------</span><span style="color:#E1E4E8;">                   </span><span style="color:#79B8FF;">----</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">----</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">-------</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Normal</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Starting</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">kubelet</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Starting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet.</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Warning</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">InvalidDiskCapacity</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">kubelet</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">invalid</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">capacity</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">image</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">filesystem</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Normal</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">NodeHasSufficientMemory</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">kubelet</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-master-01</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">status</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">now:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">NodeHasSufficientMemory</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Normal</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">NodeHasNoDiskPressure</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">kubelet</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-master-01</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">status</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">now:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">NodeHasNoDiskPressure</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Normal</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">NodeHasSufficientPID</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">kubelet</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-master-01</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">status</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">now:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">NodeHasSufficientPID</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Normal</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">NodeAllocatableEnforced</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">kubelet</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Updated</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Allocatable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">limit</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">across</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pods</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master-01 kubernetes]# kubectl describe node kube-master-01 </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Allocatable</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-B</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-A</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span></span>
<span class="line"><span style="color:#6F42C1;">Capacity:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">cpu:</span><span style="color:#24292E;">                </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">ephemeral-storage:</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">36400</span><span style="color:#032F62;">Mi</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">hugepages-1Gi:</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">hugepages-2Mi:</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">memory:</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">3976836</span><span style="color:#032F62;">Ki</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">pods:</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">110</span></span>
<span class="line"><span style="color:#6F42C1;">Allocatable:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">cpu:</span><span style="color:#24292E;">                </span><span style="color:#005CC5;">1500</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">ephemeral-storage:</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">33277607880</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">hugepages-1Gi:</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">hugepages-2Mi:</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">memory:</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">1777284</span><span style="color:#032F62;">Ki</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">pods:</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">110</span></span>
<span class="line"><span style="color:#6F42C1;">--</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Type</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Reason</span><span style="color:#24292E;">                   </span><span style="color:#032F62;">Age</span><span style="color:#24292E;">   </span><span style="color:#032F62;">From</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Message</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">----</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">------</span><span style="color:#24292E;">                   </span><span style="color:#005CC5;">----</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">----</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">-------</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Normal</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Starting</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span><span style="color:#24292E;">  </span><span style="color:#032F62;">kubelet</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Starting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet.</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Warning</span><span style="color:#24292E;">  </span><span style="color:#032F62;">InvalidDiskCapacity</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span><span style="color:#24292E;">  </span><span style="color:#032F62;">kubelet</span><span style="color:#24292E;">  </span><span style="color:#032F62;">invalid</span><span style="color:#24292E;"> </span><span style="color:#032F62;">capacity</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">image</span><span style="color:#24292E;"> </span><span style="color:#032F62;">filesystem</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Normal</span><span style="color:#24292E;">   </span><span style="color:#032F62;">NodeHasSufficientMemory</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span><span style="color:#24292E;">  </span><span style="color:#032F62;">kubelet</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-master-01</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">now:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">NodeHasSufficientMemory</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Normal</span><span style="color:#24292E;">   </span><span style="color:#032F62;">NodeHasNoDiskPressure</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span><span style="color:#24292E;">  </span><span style="color:#032F62;">kubelet</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-master-01</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">now:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">NodeHasNoDiskPressure</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Normal</span><span style="color:#24292E;">   </span><span style="color:#032F62;">NodeHasSufficientPID</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span><span style="color:#24292E;">  </span><span style="color:#032F62;">kubelet</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-master-01</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">now:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">NodeHasSufficientPID</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Normal</span><span style="color:#24292E;">   </span><span style="color:#032F62;">NodeAllocatableEnforced</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span><span style="color:#24292E;">  </span><span style="color:#032F62;">kubelet</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Updated</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Allocatable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">limit</span><span style="color:#24292E;"> </span><span style="color:#032F62;">across</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pods</span></span></code></pre></div><p>其中的 <code>Allocatable</code>的值恰好是 <code>Capacity</code> 减去上面我们配置的预留资源的值：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">allocatale</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">capacity</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube_reserved</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">system_reserved</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">eviction_hard</span></span>
<span class="line"><span style="color:#B392F0;">1777284Ki</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3976836</span><span style="color:#9ECBFF;">Ki</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1*</span><span style="color:#9ECBFF;">1024</span><span style="color:#79B8FF;">*</span><span style="color:#9ECBFF;">1024Ki</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1*</span><span style="color:#9ECBFF;">1024</span><span style="color:#79B8FF;">*</span><span style="color:#9ECBFF;">1024Ki</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100*</span><span style="color:#9ECBFF;">1024Ki</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#或者是百分比</span></span>
<span class="line"><span style="color:#B392F0;">allocatable</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">capacity</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">kube_reserved</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">system_reserved</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">eviction_threshhold</span></span>
<span class="line"><span style="color:#B392F0;">2510193454/1024Ki</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3861512</span><span style="color:#9ECBFF;">Ki</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">500*</span><span style="color:#9ECBFF;">1024Ki</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">500*</span><span style="color:#9ECBFF;">1024Ki</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">3861512*</span><span style="color:#9ECBFF;">10%Ki</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">allocatale</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">capacity</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube_reserved</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">system_reserved</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">eviction_hard</span></span>
<span class="line"><span style="color:#6F42C1;">1777284Ki</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3976836</span><span style="color:#032F62;">Ki</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1*</span><span style="color:#032F62;">1024</span><span style="color:#005CC5;">*</span><span style="color:#032F62;">1024Ki</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1*</span><span style="color:#032F62;">1024</span><span style="color:#005CC5;">*</span><span style="color:#032F62;">1024Ki</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100*</span><span style="color:#032F62;">1024Ki</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#或者是百分比</span></span>
<span class="line"><span style="color:#6F42C1;">allocatable</span><span style="color:#24292E;">    </span><span style="color:#032F62;">=</span><span style="color:#24292E;">  </span><span style="color:#032F62;">capacity</span><span style="color:#24292E;">  </span><span style="color:#032F62;">-</span><span style="color:#24292E;">  </span><span style="color:#032F62;">kube_reserved</span><span style="color:#24292E;">  </span><span style="color:#032F62;">-</span><span style="color:#24292E;">  </span><span style="color:#032F62;">system_reserved</span><span style="color:#24292E;">  </span><span style="color:#032F62;">-</span><span style="color:#24292E;">   </span><span style="color:#032F62;">eviction_threshhold</span></span>
<span class="line"><span style="color:#6F42C1;">2510193454/1024Ki</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3861512</span><span style="color:#032F62;">Ki</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">500*</span><span style="color:#032F62;">1024Ki</span><span style="color:#24292E;">    </span><span style="color:#032F62;">-</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">500*</span><span style="color:#032F62;">1024Ki</span><span style="color:#24292E;">     </span><span style="color:#032F62;">-</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">3861512*</span><span style="color:#032F62;">10%Ki</span></span></code></pre></div><ul><li>查看kubepods控制组</li></ul><p>查看 <code>kubepods.slice</code>（systemd 驱动是以 <code>.slice</code> 结尾）cgroup 中对节点上所有 Pod 内存的限制，该值决定了 Node 上所有的 Pod 能使用的资源上限：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/sys/fs/cgroup/memory/kubepods.slice/memory.limit_in_bytes</span></span>
<span class="line"><span style="color:#B392F0;">1924796416</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">1924796416Bytes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3976836</span><span style="color:#9ECBFF;">Ki</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Allocatable</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">1777284Ki</span><span style="color:#E1E4E8;">) </span><span style="color:#9ECBFF;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">eviction_hard</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">100*1024Ki</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#也可根据下面的计算可知，Node上Pod能实际使用的资源上限值为：</span></span>
<span class="line"><span style="color:#B392F0;">kubepods/memory.limit_in_bytes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">capacity</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube_reserved</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">system_reserved</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/sys/fs/cgroup/memory/kubepods.slice/memory.limit_in_bytes</span></span>
<span class="line"><span style="color:#6F42C1;">1924796416</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">1924796416Bytes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3976836</span><span style="color:#032F62;">Ki</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Allocatable</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">1777284Ki</span><span style="color:#24292E;">) </span><span style="color:#032F62;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">eviction_hard</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">100*1024Ki</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#也可根据下面的计算可知，Node上Pod能实际使用的资源上限值为：</span></span>
<span class="line"><span style="color:#6F42C1;">kubepods/memory.limit_in_bytes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">capacity</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube_reserved</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">system_reserved</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>一个节点上所有Pod能使用的内存总和，与eviction-hard无关</p></div><h3 id="设置cgroup" tabindex="-1">设置cgroup <a class="header-anchor" href="#设置cgroup" aria-label="Permalink to &quot;设置cgroup&quot;">​</a></h3><p>假设我们现在需要为系统预留一定的资源，那么我们可以配置如下的kubelet参数</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">--enforce-node-allocatable</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">pods,kube-reserved,system-reserved</span></span>
<span class="line"><span style="color:#E1E4E8;">--kube-reserved</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">memory=...</span></span>
<span class="line"><span style="color:#E1E4E8;">--kube-reserved-cgroup</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">--system-reserved</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">memory=...</span></span>
<span class="line"><span style="color:#E1E4E8;">--system-reserved-cgroup</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">--eviction-hard</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">..</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">--enforce-node-allocatable</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">pods,kube-reserved,system-reserved</span></span>
<span class="line"><span style="color:#24292E;">--kube-reserved</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">memory=...</span></span>
<span class="line"><span style="color:#24292E;">--kube-reserved-cgroup</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">...</span></span>
<span class="line"><span style="color:#24292E;">--system-reserved</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">memory=...</span></span>
<span class="line"><span style="color:#24292E;">--system-reserved-cgroup</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">...</span></span>
<span class="line"><span style="color:#24292E;">--eviction-hard</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">..</span></span></code></pre></div><p>如果还设置了对应的 --system-reserved-cgroup 和 --kube-reserved-cgroup参数，Pod能实际使用的资源上限不会改变（即kubepods.limit_in_bytes不变），但系统进程与kube进程也会受到资源上限的限制。如果系统进程超过了预留资源，那么系统进程会被cgroup杀掉。 但是如果不设这两个参数，那么系统进程可以使用超过预留的资源上限。</p><ul><li>配置建议</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">--enforce-node-allocatable=pods</span></span>
<span class="line"><span style="color:#e1e4e8;">--kube-reserved=cpu=xx,memory=xx,ephemeral-storage=xx</span></span>
<span class="line"><span style="color:#e1e4e8;">--system-reserved=cpu=xx,memory=xx,ephemeral-storage=xx</span></span>
<span class="line"><span style="color:#e1e4e8;">--eviction-hard=memory.available&lt;10%,nodefs.available&lt;10%</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">--enforce-node-allocatable=pods</span></span>
<span class="line"><span style="color:#24292e;">--kube-reserved=cpu=xx,memory=xx,ephemeral-storage=xx</span></span>
<span class="line"><span style="color:#24292e;">--system-reserved=cpu=xx,memory=xx,ephemeral-storage=xx</span></span>
<span class="line"><span style="color:#24292e;">--eviction-hard=memory.available&lt;10%,nodefs.available&lt;10%</span></span></code></pre></div><h3 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h3><ol><li>Node的allocatable在kubelet启动后是一个固定的值，不会因为pod的创建与删除而改变</li><li>当我们为Pod设置了resources.requests时，调度到Node上的Pod的resources.requests的总和不会超过Node的allocatable。但Pod的resources.limits总和可以超过Node的allocatable</li><li>一个Pod能否成功调度到某个Node，关键看该Pod的resources.request是否小于Node剩下的request，而不是看Node实际的资源空闲量。即使空闲资源小于Pod的requests，Pod也可以调度到该Node上</li><li>当Pod的内存资源实际使用量超过其limits时，docker（实际是cgroup）会把该Pod内超出限额的进程杀掉（OOM）；如果CPU超过，不会杀掉进程，只是进程会一直等待CPU。</li><li>allocatable与kubepods.limit的值不一样，它们之间相差一个 eviction_hard</li><li>当我们不设置cgroup时，可以达到为系统预留资源的效果，即Pod的资源实际使用量不会超过allocatable的值（因为kubepods控制组中memory.limit_in_bytes的值就为allocatable的值）。即使系统本身没有使用完预留的那部分资源，Pod也无法使用。当系统超出了预留的那部分资源时，系统进程可以抢占allocatable中的资源，即对系统使用的资源没有限制。</li></ol><h1 id="_3-imagefs与nodefs" tabindex="-1">3. imagefs与nodefs <a class="header-anchor" href="#_3-imagefs与nodefs" aria-label="Permalink to &quot;3. imagefs与nodefs&quot;">​</a></h1><p>kubelet 服务对磁盘检查是有两个参数的，分别是 <code>imagefs</code> 与 <code>nodefs</code>。其中</p><ul><li>imagefs：监控docker启动参数 <code>data-root 或者 graph</code> 目录所在的分区。默认<code>/var/lib/docker</code></li><li>nodefs：监控kubelet启动参数 <code>--root-dir</code> 指定的目录所在分区。默认<code>/var/lib/kubelet</code></li></ul><blockquote><p>nodefs是--root-dir目录所在分区</p><p>imagefs是docker安装目录所在的分区</p></blockquote><h2 id="_3-1-修改kubelet数据目录" tabindex="-1">3.1 修改kubelet数据目录 <a class="header-anchor" href="#_3-1-修改kubelet数据目录" aria-label="Permalink to &quot;3.1 修改kubelet数据目录&quot;">​</a></h2><h3 id="启动时" tabindex="-1">启动时 <a class="header-anchor" href="#启动时" aria-label="Permalink to &quot;启动时&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubelet</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--root-dir=/new/data/directory</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubelet</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--root-dir=/new/data/directory</span></span></code></pre></div><h3 id="配置文件" tabindex="-1">配置文件 <a class="header-anchor" href="#配置文件" aria-label="Permalink to &quot;配置文件&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kind:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">KubeletConfiguration</span></span>
<span class="line"><span style="color:#B392F0;">apiVersion:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#B392F0;">rootDir:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/new/data/directory&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kind:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">KubeletConfiguration</span></span>
<span class="line"><span style="color:#6F42C1;">apiVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#6F42C1;">rootDir:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/new/data/directory&quot;</span></span></code></pre></div><ul><li>重启服务</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemon-reload</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemon-reload</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet</span></span></code></pre></div><p>参考文档，</p><p><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/reserve-compute-resources/" target="_blank" rel="noreferrer">https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/reserve-compute-resources/</a></p><p><a href="https://kubernetes.io/docs/tasks/administer-cluster/reserve-compute-resources/" target="_blank" rel="noreferrer">https://kubernetes.io/docs/tasks/administer-cluster/reserve-compute-resources/</a></p><p><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/" target="_blank" rel="noreferrer">https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/</a></p><p><a href="https://kubernetes.io/zh/docs/tasks/administer-cluster/out-of-resource/" target="_blank" rel="noreferrer">https://kubernetes.io/zh/docs/tasks/administer-cluster/out-of-resource/</a><a href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/node-pressure-eviction/" target="_blank" rel="noreferrer">https://kubernetes.io/zh/docs/concepts/scheduling-eviction/node-pressure-eviction/</a></p><p>节点压力驱逐：<a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/node-pressure-eviction/" target="_blank" rel="noreferrer">https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/node-pressure-eviction/</a></p>`,64),e=[o];function c(t,r,y,E,i,F){return a(),n("div",null,e)}const C=s(p,[["render",c]]);export{u as __pageData,C as default};
