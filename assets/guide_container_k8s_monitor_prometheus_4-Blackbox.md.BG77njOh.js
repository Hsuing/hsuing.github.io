import{_ as s,o as a,c as n,R as p}from"./chunks/framework.zUbWieqp.js";const _=JSON.parse('{"title":"一. BlackBox Exporter 是什么","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/monitor/prometheus/4-Blackbox.md","filePath":"guide/container/k8s/monitor/prometheus/4-Blackbox.md","lastUpdated":1720533756000}'),l={name:"guide/container/k8s/monitor/prometheus/4-Blackbox.md"},o=p(`<h1 id="一-blackbox-exporter-是什么" tabindex="-1">一. BlackBox Exporter 是什么 <a class="header-anchor" href="#一-blackbox-exporter-是什么" aria-label="Permalink to &quot;一. BlackBox Exporter 是什么&quot;">​</a></h1><p>BlackBox Exporter 是 Prometheus 官方提供的黑盒监控解决方案，允许用户通过 HTTP、HTTPS、DNS、TCP 以及 ICMP 的方式对网络进行探测，这种探测方式常常用于探测一个服务的运行状态，观察服务是否正常运行。</p><h2 id="_1-1-应用场景" tabindex="-1">1.1 应用场景 <a class="header-anchor" href="#_1-1-应用场景" aria-label="Permalink to &quot;1.1 应用场景&quot;">​</a></h2><ul><li><strong>HTTP 测试</strong></li></ul><p>定义 Request Header 信息 判断 Http status / Http Respones Header / Http Body 内容</p><ul><li><strong>TCP 测试</strong></li></ul><p>业务组件端口状态监听 应用层协议定义与监听</p><ul><li><strong>ICMP 测试</strong></li></ul><p>主机探活机制</p><ul><li><strong>POST 测试</strong></li></ul><p>接口联通性</p><ul><li><strong>SSL 证书过期时间</strong></li></ul><h2 id="_1-2-部署方案" tabindex="-1">1.2 部署方案 <a class="header-anchor" href="#_1-2-部署方案" aria-label="Permalink to &quot;1.2 部署方案&quot;">​</a></h2><p>1.针对小型K8S环境集群环境，监控的目标范围比较小，可以使用 <code>static_configs</code>静态配置的方式来获取数据。</p><p>2.针对大型K8S环境集群环境，监控的目标范围比较大，建议使用 <code>file_sd_configs</code>文件自动发现或者</p><p><code>kubernetes_sd_configs</code>以service的方式自动采集数据。</p><p>3.<code>file_sd_configs</code>方式可以监控非K8S集群环境的服务。</p><h1 id="二-黑盒监控和白盒监控" tabindex="-1">二. 黑盒监控和白盒监控 <a class="header-anchor" href="#二-黑盒监控和白盒监控" aria-label="Permalink to &quot;二. 黑盒监控和白盒监控&quot;">​</a></h1><h2 id="_2-1-什么是白盒与黑盒监控" tabindex="-1">2.1 什么是白盒与黑盒监控 <a class="header-anchor" href="#_2-1-什么是白盒与黑盒监控" aria-label="Permalink to &quot;2.1 什么是白盒与黑盒监控&quot;">​</a></h2><p><strong>墨盒监控</strong></p><p>黑和监控指的是以用户的身份测试服务的运行状态。常见的黑盒监控手段包括 HTTP 探针、TCP 探针、DNS 探测、ICMP 等。黑盒监控常用于检测站点与服务可用性、连通性，以及访问效率等。</p><p><strong>白盒监控</strong></p><p>白盒监控一般指的是我们日常对服务器状态的监控，如服务器资源使用量、容器的运行状态、中间件的稳定情况等一系列比较直观的监控数据，这些都是支撑业务应用稳定运行的基础设施。</p><p>通过白盒能监控，可以使我们能够了解系统内部的实际运行状况，而且还可以通过对监控指标数据的观察与分析，可以让我们提前预判服务器可能出现的问题，针对可能出现的问题进行及时修正，避免造成不可预估的损失。</p><h2 id="_2-2-白盒监控和黑盒监控的区别" tabindex="-1">2.2 白盒监控和黑盒监控的区别 <a class="header-anchor" href="#_2-2-白盒监控和黑盒监控的区别" aria-label="Permalink to &quot;2.2 白盒监控和黑盒监控的区别&quot;">​</a></h2><p>黑盒监控与白盒监控有着很大的不同，俩者的区别主要是，<code>黑盒监控是以故障</code>为主导，当被监控的服务发生故障时，能快速进行预警。而白盒监控则更<code>偏向于主动的和提前预判方式，预测可能发生的故障</code>。</p><p>一套完善的监控系统是需要黑盒监控与白盒监控俩者配合同时工作的，白盒监控预判可能存在的潜在问题，而黑盒监控则是快速发现已经发生的问题。</p><h1 id="三-kubernetes-部署-blackbox-exporter" tabindex="-1">三. Kubernetes 部署 BlackBox Exporter <a class="header-anchor" href="#三-kubernetes-部署-blackbox-exporter" aria-label="Permalink to &quot;三. Kubernetes 部署 BlackBox Exporter&quot;">​</a></h1><p>官当,<a href="https://github.com/prometheus/blackbox_exporter" target="_blank" rel="noreferrer">https://github.com/prometheus/blackbox_exporter</a></p><p>configmap定义</p><p><a href="https://github.com/prometheus/blackbox_exporter/blob/master/CONFIGURATION.md" target="_blank" rel="noreferrer">https://github.com/prometheus/blackbox_exporter/blob/master/CONFIGURATION.md</a></p><p><a href="https://github.com/prometheus/blackbox_exporter/blob/master/example.yml" target="_blank" rel="noreferrer">https://github.com/prometheus/blackbox_exporter/blob/master/example.yml</a></p><p>参考 BlackBox Exporter configmap的<a href="https://github.com/prometheus/blackbox_exporter/blob/master/example.yml" target="_blank" rel="noreferrer">官方示例</a></p><h2 id="_3-0-定义blackbox在prometheus抓取设置" tabindex="-1">3.0 定义BlackBox在Prometheus抓取设置 <a class="header-anchor" href="#_3-0-定义blackbox在prometheus抓取设置" aria-label="Permalink to &quot;3.0 定义BlackBox在Prometheus抓取设置&quot;">​</a></h2><p><a href="https://github.com/prometheus/prometheus/blob/main/documentation/examples/prometheus-kubernetes.yml" target="_blank" rel="noreferrer">https://github.com/prometheus/prometheus/blob/main/documentation/examples/prometheus-kubernetes.yml</a></p><h2 id="_3-1-创建configmap" tabindex="-1">3.1 创建ConfigMap <a class="header-anchor" href="#_3-1-创建configmap" aria-label="Permalink to &quot;3.1 创建ConfigMap&quot;">​</a></h2><p>vim 1.blackbox-configmap.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ConfigMap</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">data</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">blackbox.yml</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|-</span></span>
<span class="line"><span style="color:#9ECBFF;">    modules:</span></span>
<span class="line"><span style="color:#9ECBFF;">      ## ----------- DNS 检测配置 -----------</span></span>
<span class="line"><span style="color:#9ECBFF;">      dns_tcp:</span></span>
<span class="line"><span style="color:#9ECBFF;">        prober: dns</span></span>
<span class="line"><span style="color:#9ECBFF;">        timeout: 5s</span></span>
<span class="line"><span style="color:#9ECBFF;">        dns:</span></span>
<span class="line"><span style="color:#9ECBFF;">          transport_protocol: &quot;tcp&quot;  # 默认是 udp</span></span>
<span class="line"><span style="color:#9ECBFF;">          preferred_ip_protocol: &quot;ip4&quot; # 默认是 ip6</span></span>
<span class="line"><span style="color:#9ECBFF;">          query_name: &quot;kubernetes.default.svc.cluster.local&quot;  # 利用这个域名来检查 dns 服务器</span></span>
<span class="line"><span style="color:#9ECBFF;">          query_type: &quot;A&quot; 									  # 如果是 kube-dns ，一定要加入这个</span></span>
<span class="line"><span style="color:#9ECBFF;">      ## ----------- TCP 检测模块配置 -----------</span></span>
<span class="line"><span style="color:#9ECBFF;">      tcp_connect:</span></span>
<span class="line"><span style="color:#9ECBFF;">        prober: tcp</span></span>
<span class="line"><span style="color:#9ECBFF;">        timeout: 5s</span></span>
<span class="line"><span style="color:#9ECBFF;">      ## ----------- ICMP 检测配置 -----------</span></span>
<span class="line"><span style="color:#9ECBFF;">      icmp:</span></span>
<span class="line"><span style="color:#9ECBFF;">        prober: icmp</span></span>
<span class="line"><span style="color:#9ECBFF;">        timeout: 5s</span></span>
<span class="line"><span style="color:#9ECBFF;">        icmp:</span></span>
<span class="line"><span style="color:#9ECBFF;">          preferred_ip_protocol: &quot;ip4&quot; # 默认是 ip6</span></span>
<span class="line"><span style="color:#9ECBFF;">      ## ----------- HTTP GET 2xx 检测模块配置 -----------</span></span>
<span class="line"><span style="color:#9ECBFF;">      http_get_2xx:</span></span>
<span class="line"><span style="color:#9ECBFF;">        prober: http</span></span>
<span class="line"><span style="color:#9ECBFF;">        timeout: 10s</span></span>
<span class="line"><span style="color:#9ECBFF;">        http:</span></span>
<span class="line"><span style="color:#9ECBFF;">          method: GET</span></span>
<span class="line"><span style="color:#9ECBFF;">          no_follow_redirects: false  # 是否不跟随重定向</span></span>
<span class="line"><span style="color:#9ECBFF;">          vaild_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2.0&quot;]</span></span>
<span class="line"><span style="color:#9ECBFF;">          valid_status_codes: [200]  # 验证的HTTP状态码, 默认是 2xx</span></span>
<span class="line"><span style="color:#9ECBFF;">          fail_if_ssl: false</span></span>
<span class="line"><span style="color:#9ECBFF;">          tls_config:</span></span>
<span class="line"><span style="color:#9ECBFF;">            insecure_skip_verify: true</span></span>
<span class="line"><span style="color:#9ECBFF;">          preferred_ip_protocol: &quot;ip4&quot; # 默认是 ip6</span></span>
<span class="line"><span style="color:#9ECBFF;">      ## ----------- HTTP GET 3xx 检测模块配置 -----------</span></span>
<span class="line"><span style="color:#9ECBFF;">      http_get_3xx:</span></span>
<span class="line"><span style="color:#9ECBFF;">        prober: http</span></span>
<span class="line"><span style="color:#9ECBFF;">        timeout: 10s</span></span>
<span class="line"><span style="color:#9ECBFF;">        http:</span></span>
<span class="line"><span style="color:#9ECBFF;">          method: GET</span></span>
<span class="line"><span style="color:#9ECBFF;">          no_follow_redirects: false  # 是否不跟随重定向</span></span>
<span class="line"><span style="color:#9ECBFF;">          vaild_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2.0&quot;]</span></span>
<span class="line"><span style="color:#9ECBFF;">          valid_status_codes: [300, 301, 302, 303, 307, 308]  # 验证的HTTP状态码, 默认是 2xx</span></span>
<span class="line"><span style="color:#9ECBFF;">          fail_if_ssl: false</span></span>
<span class="line"><span style="color:#9ECBFF;">          tls_config:</span></span>
<span class="line"><span style="color:#9ECBFF;">            insecure_skip_verify: true</span></span>
<span class="line"><span style="color:#9ECBFF;">          preferred_ip_protocol: &quot;ip4&quot; # 默认是 ip6</span></span>
<span class="line"><span style="color:#9ECBFF;">      ## ----------- HTTP POST 监测模块 -----------</span></span>
<span class="line"><span style="color:#9ECBFF;">      http_post_2xx:</span></span>
<span class="line"><span style="color:#9ECBFF;">        prober: http</span></span>
<span class="line"><span style="color:#9ECBFF;">        timeout: 10s</span></span>
<span class="line"><span style="color:#9ECBFF;">        http:</span></span>
<span class="line"><span style="color:#9ECBFF;">          method: POST</span></span>
<span class="line"><span style="color:#9ECBFF;">          no_follow_redirects: false  # 是否不跟随重定向</span></span>
<span class="line"><span style="color:#9ECBFF;">          vaild_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2.0&quot;]</span></span>
<span class="line"><span style="color:#9ECBFF;">          valid_status_codes: [200]  # 验证的HTTP状态码, 默认是 2xx</span></span>
<span class="line"><span style="color:#9ECBFF;">          preferred_ip_protocol: &quot;ip4&quot; # 默认是 ip6</span></span>
<span class="line"><span style="color:#9ECBFF;">          #headers:</span></span>
<span class="line"><span style="color:#9ECBFF;">          #  Content-Type: &quot;application/json&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">          #body: &#39;{}&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ConfigMap</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">data</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">blackbox.yml</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|-</span></span>
<span class="line"><span style="color:#032F62;">    modules:</span></span>
<span class="line"><span style="color:#032F62;">      ## ----------- DNS 检测配置 -----------</span></span>
<span class="line"><span style="color:#032F62;">      dns_tcp:</span></span>
<span class="line"><span style="color:#032F62;">        prober: dns</span></span>
<span class="line"><span style="color:#032F62;">        timeout: 5s</span></span>
<span class="line"><span style="color:#032F62;">        dns:</span></span>
<span class="line"><span style="color:#032F62;">          transport_protocol: &quot;tcp&quot;  # 默认是 udp</span></span>
<span class="line"><span style="color:#032F62;">          preferred_ip_protocol: &quot;ip4&quot; # 默认是 ip6</span></span>
<span class="line"><span style="color:#032F62;">          query_name: &quot;kubernetes.default.svc.cluster.local&quot;  # 利用这个域名来检查 dns 服务器</span></span>
<span class="line"><span style="color:#032F62;">          query_type: &quot;A&quot; 									  # 如果是 kube-dns ，一定要加入这个</span></span>
<span class="line"><span style="color:#032F62;">      ## ----------- TCP 检测模块配置 -----------</span></span>
<span class="line"><span style="color:#032F62;">      tcp_connect:</span></span>
<span class="line"><span style="color:#032F62;">        prober: tcp</span></span>
<span class="line"><span style="color:#032F62;">        timeout: 5s</span></span>
<span class="line"><span style="color:#032F62;">      ## ----------- ICMP 检测配置 -----------</span></span>
<span class="line"><span style="color:#032F62;">      icmp:</span></span>
<span class="line"><span style="color:#032F62;">        prober: icmp</span></span>
<span class="line"><span style="color:#032F62;">        timeout: 5s</span></span>
<span class="line"><span style="color:#032F62;">        icmp:</span></span>
<span class="line"><span style="color:#032F62;">          preferred_ip_protocol: &quot;ip4&quot; # 默认是 ip6</span></span>
<span class="line"><span style="color:#032F62;">      ## ----------- HTTP GET 2xx 检测模块配置 -----------</span></span>
<span class="line"><span style="color:#032F62;">      http_get_2xx:</span></span>
<span class="line"><span style="color:#032F62;">        prober: http</span></span>
<span class="line"><span style="color:#032F62;">        timeout: 10s</span></span>
<span class="line"><span style="color:#032F62;">        http:</span></span>
<span class="line"><span style="color:#032F62;">          method: GET</span></span>
<span class="line"><span style="color:#032F62;">          no_follow_redirects: false  # 是否不跟随重定向</span></span>
<span class="line"><span style="color:#032F62;">          vaild_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2.0&quot;]</span></span>
<span class="line"><span style="color:#032F62;">          valid_status_codes: [200]  # 验证的HTTP状态码, 默认是 2xx</span></span>
<span class="line"><span style="color:#032F62;">          fail_if_ssl: false</span></span>
<span class="line"><span style="color:#032F62;">          tls_config:</span></span>
<span class="line"><span style="color:#032F62;">            insecure_skip_verify: true</span></span>
<span class="line"><span style="color:#032F62;">          preferred_ip_protocol: &quot;ip4&quot; # 默认是 ip6</span></span>
<span class="line"><span style="color:#032F62;">      ## ----------- HTTP GET 3xx 检测模块配置 -----------</span></span>
<span class="line"><span style="color:#032F62;">      http_get_3xx:</span></span>
<span class="line"><span style="color:#032F62;">        prober: http</span></span>
<span class="line"><span style="color:#032F62;">        timeout: 10s</span></span>
<span class="line"><span style="color:#032F62;">        http:</span></span>
<span class="line"><span style="color:#032F62;">          method: GET</span></span>
<span class="line"><span style="color:#032F62;">          no_follow_redirects: false  # 是否不跟随重定向</span></span>
<span class="line"><span style="color:#032F62;">          vaild_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2.0&quot;]</span></span>
<span class="line"><span style="color:#032F62;">          valid_status_codes: [300, 301, 302, 303, 307, 308]  # 验证的HTTP状态码, 默认是 2xx</span></span>
<span class="line"><span style="color:#032F62;">          fail_if_ssl: false</span></span>
<span class="line"><span style="color:#032F62;">          tls_config:</span></span>
<span class="line"><span style="color:#032F62;">            insecure_skip_verify: true</span></span>
<span class="line"><span style="color:#032F62;">          preferred_ip_protocol: &quot;ip4&quot; # 默认是 ip6</span></span>
<span class="line"><span style="color:#032F62;">      ## ----------- HTTP POST 监测模块 -----------</span></span>
<span class="line"><span style="color:#032F62;">      http_post_2xx:</span></span>
<span class="line"><span style="color:#032F62;">        prober: http</span></span>
<span class="line"><span style="color:#032F62;">        timeout: 10s</span></span>
<span class="line"><span style="color:#032F62;">        http:</span></span>
<span class="line"><span style="color:#032F62;">          method: POST</span></span>
<span class="line"><span style="color:#032F62;">          no_follow_redirects: false  # 是否不跟随重定向</span></span>
<span class="line"><span style="color:#032F62;">          vaild_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2.0&quot;]</span></span>
<span class="line"><span style="color:#032F62;">          valid_status_codes: [200]  # 验证的HTTP状态码, 默认是 2xx</span></span>
<span class="line"><span style="color:#032F62;">          preferred_ip_protocol: &quot;ip4&quot; # 默认是 ip6</span></span>
<span class="line"><span style="color:#032F62;">          #headers:</span></span>
<span class="line"><span style="color:#032F62;">          #  Content-Type: &quot;application/json&quot;</span></span>
<span class="line"><span style="color:#032F62;">          #body: &#39;{}&#39;</span></span></code></pre></div><ul><li>apply</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master blackbox]# kubectl apply -f 1.blackbox-configmap.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master blackbox]# kubectl apply -f 1.blackbox-configmap.yaml</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master blackbox]# kubectl get configmaps blackbox-exporter -nmonitor</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">DATA</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">blackbox-exporter</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">m2s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master blackbox]# kubectl get configmaps blackbox-exporter -nmonitor</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                </span><span style="color:#032F62;">DATA</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">blackbox-exporter</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m2s</span></span></code></pre></div><h2 id="_3-2-创建deployment资源" tabindex="-1">3.2 创建deployment资源 <a class="header-anchor" href="#_3-2-创建deployment资源" aria-label="Permalink to &quot;3.2 创建deployment资源&quot;">​</a></h2><p>vim 2.blackbox-exporter.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterIP</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9115</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9115</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/blackbox-exporter:v0.21.0</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">imagePullPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">args</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">--config.file=/etc/blackbox_exporter/blackbox.yml</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># ConfigMap 中的配置文件</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">--web.listen-address=:9115</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">--log.level=info</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 错误级别控制,error</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9115</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">requests</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">100m</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">50Mi</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">limits</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">200m</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">256Mi</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">securityContext</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">runAsUser</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">65534</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">readinessProbe</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">tcpSocket</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9115</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">initialDelaySeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">timeoutSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">periodSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">successThreshold</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">failureThreshold</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">config-volume</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/blackbox_exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">config-volume</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">configMap</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">defaultMode</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">420</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9115</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9115</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/blackbox-exporter:v0.21.0</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">imagePullPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">args</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">--config.file=/etc/blackbox_exporter/blackbox.yml</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># ConfigMap 中的配置文件</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">--web.listen-address=:9115</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">--log.level=info</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 错误级别控制,error</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9115</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">100m</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">50Mi</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">limits</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">200m</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">256Mi</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">securityContext</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">runAsUser</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">65534</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">readinessProbe</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">tcpSocket</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9115</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">initialDelaySeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">timeoutSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">periodSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">successThreshold</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">failureThreshold</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">config-volume</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/blackbox_exporter</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">config-volume</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">configMap</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">defaultMode</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">420</span></span></code></pre></div><ul><li>appy</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">.blackbox-exporter.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">.blackbox-exporter.yaml</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master blackbox]# kubectl get svc -n monitor</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                 </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">CLUSTER-IP</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">EXTERNAL-IP</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">PORT</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">S</span><span style="color:#E1E4E8;">)             </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">blackbox-exporter</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">ClusterIP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.200.165</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">9115</span><span style="color:#9ECBFF;">/TCP</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master blackbox]# kubectl get svc -n monitor</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">        </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">        </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)             </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">blackbox-exporter</span><span style="color:#24292E;">    </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.200.165</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">9115</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">s</span></span></code></pre></div><h1 id="四-监控" tabindex="-1">四. 监控 <a class="header-anchor" href="#四-监控" aria-label="Permalink to &quot;四. 监控&quot;">​</a></h1><h2 id="_4-1-dns监控" tabindex="-1">4.1 dns监控 <a class="header-anchor" href="#_4-1-dns监控" aria-label="Permalink to &quot;4.1 dns监控&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;kubernetes-dns&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/probe</span><span style="color:#E1E4E8;">              </span><span style="color:#6A737D;"># 不是 metrics，是 probe</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">params</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">module</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">dns_tcp</span><span style="color:#E1E4E8;">]               </span><span style="color:#6A737D;"># 使用 DNS TCP 模块</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">kube-dns.kube-system:53</span><span style="color:#E1E4E8;">             </span><span style="color:#6A737D;"># 不要省略端口号</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">## 将上面配置的静态DNS服务器地址转换为临时变量 &quot;__param_target&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__address__</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__param_target</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">## 将 &quot;__param_target&quot; 内容设置为 instance 实例名称</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__param_target</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">instance</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">## # 服务地址，和上面的 Service 定义保持一致</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter.monitor:9115</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;kubernetes-dns&quot;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/probe</span><span style="color:#24292E;">              </span><span style="color:#6A737D;"># 不是 metrics，是 probe</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">params</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">module</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">dns_tcp</span><span style="color:#24292E;">]               </span><span style="color:#6A737D;"># 使用 DNS TCP 模块</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">kube-dns.kube-system:53</span><span style="color:#24292E;">             </span><span style="color:#6A737D;"># 不要省略端口号</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">## 将上面配置的静态DNS服务器地址转换为临时变量 &quot;__param_target&quot;</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__address__</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__param_target</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">## 将 &quot;__param_target&quot; 内容设置为 instance 实例名称</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__param_target</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">instance</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">## # 服务地址，和上面的 Service 定义保持一致</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter.monitor:9115</span></span></code></pre></div><ul><li><p>update prometheus配置</p></li><li><p>热更prometheus</p></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-XPOST</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-XPOST</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre></div><ul><li>效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406281717078.png" alt="image-20240628171723313"></p><h2 id="_4-2-icmp" tabindex="-1">4.2 icmp <a class="header-anchor" href="#_4-2-icmp" aria-label="Permalink to &quot;4.2 icmp&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">   - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">icmp-status</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/probe</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">params</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">module</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">icmp</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#79B8FF;">10.103.236.199</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">group</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">icmp</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__address__</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__param_target</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__param_target</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">instance</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter.monitor:9115</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">   - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">icmp-status</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/probe</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">params</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">module</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">icmp</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#005CC5;">10.103.236.199</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">group</span><span style="color:#24292E;">: </span><span style="color:#032F62;">icmp</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__address__</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__param_target</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__param_target</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">instance</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter.monitor:9115</span></span></code></pre></div><ul><li>热加载</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-XPOST</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-XPOST</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre></div><ul><li>效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406281716915.png" alt="image-20240628171639455"></p><h2 id="_4-3-service" tabindex="-1">4.3 Service <a class="header-anchor" href="#_4-3-service" aria-label="Permalink to &quot;4.3 Service&quot;">​</a></h2><p>创建用于探测 Kubernetes 服务的配置，对那些配置了 <code>prometheus.io/http-probe: &quot;true&quot;</code> 标签的 <strong>Kubernetes Service</strong> 资源的健康状态进行探测</p><h3 id="http" tabindex="-1">http <a class="header-anchor" href="#http" aria-label="Permalink to &quot;http&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;kubernetes-services&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/probe</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">params</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">module</span><span style="color:#E1E4E8;">:         </span><span style="color:#6A737D;">## 使用HTTP_GET_2xx与HTTP_GET_3XX模块</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">&quot;http_get_2xx&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">&quot;http_get_3xx&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:            </span><span style="color:#6A737D;">## 使用Kubernetes动态服务发现,且使用Service类型的发现</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">service</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:          </span><span style="color:#6A737D;">## 设置只监测Kubernetes Service中Annotation里配置了注解prometheus.io/http_probe: true的service</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_annotation_prometheus_io_http_probe</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: </span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">&quot;__meta_kubernetes_service_name&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">&quot;__meta_kubernetes_namespace&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">&quot;__meta_kubernetes_service_annotation_prometheus_io_http_probe_port&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">&quot;__meta_kubernetes_service_annotation_prometheus_io_http_probe_path&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__param_target</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">(.+);(.+);(.+);(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">$1.$2:$3$4</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter.monitor:9115</span><span style="color:#E1E4E8;">             </span><span style="color:#6A737D;">## BlackBox Exporter 的 Service 地址</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__param_target</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">instance</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">labelmap</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__meta_kubernetes_service_label_(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_namespace</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes_namespace</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes_name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;kubernetes-services&#39;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/probe</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">params</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">module</span><span style="color:#24292E;">:         </span><span style="color:#6A737D;">## 使用HTTP_GET_2xx与HTTP_GET_3XX模块</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">&quot;http_get_2xx&quot;</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">&quot;http_get_3xx&quot;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:            </span><span style="color:#6A737D;">## 使用Kubernetes动态服务发现,且使用Service类型的发现</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">service</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:          </span><span style="color:#6A737D;">## 设置只监测Kubernetes Service中Annotation里配置了注解prometheus.io/http_probe: true的service</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_annotation_prometheus_io_http_probe</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: </span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">&quot;__meta_kubernetes_service_name&quot;</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">&quot;__meta_kubernetes_namespace&quot;</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">&quot;__meta_kubernetes_service_annotation_prometheus_io_http_probe_port&quot;</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">&quot;__meta_kubernetes_service_annotation_prometheus_io_http_probe_path&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__param_target</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">(.+);(.+);(.+);(.+)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">$1.$2:$3$4</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter.monitor:9115</span><span style="color:#24292E;">             </span><span style="color:#6A737D;">## BlackBox Exporter 的 Service 地址</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__param_target</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">instance</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">labelmap</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__meta_kubernetes_service_label_(.+)</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_namespace</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes_namespace</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes_name</span></span></code></pre></div><ul><li>apply</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master test]# kubectl apply -f 2.prometheus-config.yaml</span></span>
<span class="line"><span style="color:#B392F0;">configmap/prometheus-config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">configured</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master test]# kubectl apply -f 2.prometheus-config.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">configmap/prometheus-config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">configured</span></span></code></pre></div><ul><li>热加载</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-XPOST</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-XPOST</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre></div><p>案例:</p><p>在<code>Service</code>上面必须开启如下参数,才能采集数据</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">prometheus.io/scrape</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#85E89D;">prometheus.io/http-probe</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#85E89D;">prometheus.io/http-probe-port</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;80&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#监控服务的端口，根据实际情况填写</span></span>
<span class="line"><span style="color:#85E89D;">prometheus.io/http-probe-path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/index.html&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#监控服务接口的地址，如果域名上下文不是为/的话,则写为/index.html</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">prometheus.io/scrape</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#22863A;">prometheus.io/http-probe</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#22863A;">prometheus.io/http-probe-port</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;80&quot;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#监控服务的端口，根据实际情况填写</span></span>
<span class="line"><span style="color:#22863A;">prometheus.io/http-probe-path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/index.html&quot;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#监控服务接口的地址，如果域名上下文不是为/的话,则写为/index.html</span></span></code></pre></div><ul><li>创建资源</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master example_service</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat 1.app-deploy-service.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-role</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-role</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#6A737D;">#Service</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-service</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">prometheus.io/http-probe</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">prometheus.io/http-probe-port</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;80&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">prometheus.io/http-probe-path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/livez&quot;</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterIP</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-role</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master example_service</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat 1.app-deploy-service.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-role</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-role</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#6A737D;">#Service</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-service</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">prometheus.io/http-probe</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">prometheus.io/http-probe-port</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;80&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">prometheus.io/http-probe-path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/livez&quot;</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-role</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><ul><li>apply</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">.app-deploy-service.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">.app-deploy-service.yaml</span></span></code></pre></div><ul><li>热加载</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"></span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"></span></span></code></pre></div><ul><li>效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406281716650.png" alt="image-20240628171600507"></p><h3 id="tcp" tabindex="-1">tcp <a class="header-anchor" href="#tcp" aria-label="Permalink to &quot;tcp&quot;">​</a></h3><ul><li>添加job</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;service-tcp-probe&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scrape_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">1m</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/probe</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># 使用blackbox-exporter配置文件的tcp_connect的探针</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">params</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">module</span><span style="color:#E1E4E8;">: [ </span><span style="color:#9ECBFF;">tcp_connect</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">service</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># 保留prometheus.io/scrape: &quot;true&quot;和prometheus.io/tcp-probe: &quot;true&quot;的service</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_annotation_prometheus_io_scrape</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">__meta_kubernetes_service_annotation_prometheus_io_tcp_probe</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">true;true</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># 将原标签名__meta_kubernetes_service_name改成service_name</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">(.*)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">service_name</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># 将原标签名__meta_kubernetes_service_name改成service_name</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_namespace</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">(.*)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">namespace</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># 将instance改成 \`clusterIP:port\` 地址</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_cluster_ip</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">__meta_kubernetes_service_annotation_prometheus_io_http_probe_port</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">(.*);(.*)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__param_target</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">$1:$2</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__param_target</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">instance</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># 将__address__的值改成 \`blackbox-exporter.monitor:9115\`</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter.monitor:9115</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;service-tcp-probe&quot;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scrape_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">1m</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/probe</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># 使用blackbox-exporter配置文件的tcp_connect的探针</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">params</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">module</span><span style="color:#24292E;">: [ </span><span style="color:#032F62;">tcp_connect</span><span style="color:#24292E;"> ]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">service</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># 保留prometheus.io/scrape: &quot;true&quot;和prometheus.io/tcp-probe: &quot;true&quot;的service</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_annotation_prometheus_io_scrape</span><span style="color:#24292E;">, </span><span style="color:#032F62;">__meta_kubernetes_service_annotation_prometheus_io_tcp_probe</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">true;true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># 将原标签名__meta_kubernetes_service_name改成service_name</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">(.*)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">service_name</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># 将原标签名__meta_kubernetes_service_name改成service_name</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_namespace</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">(.*)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">namespace</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># 将instance改成 \`clusterIP:port\` 地址</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_cluster_ip</span><span style="color:#24292E;">, </span><span style="color:#032F62;">__meta_kubernetes_service_annotation_prometheus_io_http_probe_port</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">(.*);(.*)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__param_target</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">$1:$2</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__param_target</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">instance</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># 将__address__的值改成 \`blackbox-exporter.monitor:9115\`</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter.monitor:9115</span></span></code></pre></div><ul><li>热更新</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-XPOST</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-XPOST</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre></div><ul><li>创建资源</li></ul><p>3.app-deploy-service-tcp.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-tcp</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#6A737D;">#Service</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-service-tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">prometheus.io/scrape</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#Prometheus 可以对这个服务进行数据采集</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">prometheus.io/tcp-probe</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#开启 TCP 探针</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">prometheus.io/http-probe-port</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;80&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">## HTTP 探针会使用80 端口来进行探测，以检查应用程序是否正常运行</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterIP</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-tcp</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-tcp</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-tcp</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#6A737D;">#Service</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-service-tcp</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">prometheus.io/scrape</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#Prometheus 可以对这个服务进行数据采集</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">prometheus.io/tcp-probe</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#开启 TCP 探针</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">prometheus.io/http-probe-port</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;80&quot;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">## HTTP 探针会使用80 端口来进行探测，以检查应用程序是否正常运行</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-tcp</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><ul><li>执行</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">.app-deploy-service-tcp.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">.app-deploy-service-tcp.yaml</span></span></code></pre></div><ul><li>效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406282328096.png" alt="image-20240628232801037"></p><h2 id="_4-4-ingress" tabindex="-1">4.4 ingress <a class="header-anchor" href="#_4-4-ingress" aria-label="Permalink to &quot;4.4 ingress&quot;">​</a></h2><p>需要在ingress上添加注释必须有以下三行,才能收集到数据</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">prometheus.io/http_probe</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">prometheus.io/http-probe-port</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;80&#39;</span><span style="color:#E1E4E8;">     </span><span style="color:#6A737D;">#根据需求修改</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">prometheus.io/http-probe-path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;/livez&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#根据需求修改</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">prometheus.io/http_probe</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">prometheus.io/http-probe-port</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;80&#39;</span><span style="color:#24292E;">     </span><span style="color:#6A737D;">#根据需求修改</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">prometheus.io/http-probe-path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;/livez&#39;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#根据需求修改</span></span></code></pre></div><ul><li>创建采集器</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;blackbox-ingress&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scrape_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">30s</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scrape_timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10s</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/probe</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">params</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">module</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">http_get_2xx</span><span style="color:#E1E4E8;">]  </span><span style="color:#6A737D;"># 使用定义的http模块</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># ingress 类型的服务发现</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># 只有ingress的annotation中配置了 prometheus.io/http_probe=true 的才进行发现</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_ingress_annotation_prometheus_io_http_probe</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_ingress_scheme</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">__address__</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">__meta_kubernetes_ingress_path</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">(.+);(.+);(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">\${1}://\${2}\${3}</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__param_target</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter.monitor:9115</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__param_target</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">instance</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">labelmap</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__meta_kubernetes_ingress_label_(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_namespace</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes_namespace</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_ingress_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes_name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;blackbox-ingress&#39;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scrape_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">30s</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scrape_timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10s</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/probe</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">params</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">module</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">http_get_2xx</span><span style="color:#24292E;">]  </span><span style="color:#6A737D;"># 使用定义的http模块</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># ingress 类型的服务发现</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># 只有ingress的annotation中配置了 prometheus.io/http_probe=true 的才进行发现</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_ingress_annotation_prometheus_io_http_probe</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_ingress_scheme</span><span style="color:#24292E;">,</span><span style="color:#032F62;">__address__</span><span style="color:#24292E;">,</span><span style="color:#032F62;">__meta_kubernetes_ingress_path</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">(.+);(.+);(.+)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">\${1}://\${2}\${3}</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__param_target</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter.monitor:9115</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__param_target</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">instance</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">labelmap</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__meta_kubernetes_ingress_label_(.+)</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_namespace</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes_namespace</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_ingress_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes_name</span></span></code></pre></div><ul><li>热加载</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">curl -XPOST http://prometheus.ikubernetes.net/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">curl -XPOST http://prometheus.ikubernetes.net/-/reload</span></span></code></pre></div><ul><li>效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406291940214.png" alt="image-20240629194033700"></p><h2 id="_4-5-监控域名" tabindex="-1">4.5 监控域名 <a class="header-anchor" href="#_4-5-监控域名" aria-label="Permalink to &quot;4.5 监控域名&quot;">​</a></h2><h3 id="get模式" tabindex="-1">get模式 <a class="header-anchor" href="#get模式" aria-label="Permalink to &quot;get模式&quot;">​</a></h3><ul><li>创建采集器</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;blackbox-external-website&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scrape_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">30s</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scrape_timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">15s</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/probe</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">params</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">module</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">http_get_2xx</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">https://www.baidu.com</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 改为公司对外服务的域名</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">https://www.jd.com</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__address__</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__param_target</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__param_target</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">instance</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter.monitor:9115</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;blackbox-external-website&quot;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scrape_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">30s</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scrape_timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">15s</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/probe</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">params</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">module</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">http_get_2xx</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">https://www.baidu.com</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 改为公司对外服务的域名</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">https://www.jd.com</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__address__</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__param_target</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__param_target</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">instance</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter.monitor:9115</span></span></code></pre></div><ul><li>热加载</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-XPOST</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-XPOST</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre></div><ul><li>效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406291944213.png" alt="image-20240629194429972"></p><h3 id="post模式" tabindex="-1">post模式 <a class="header-anchor" href="#post模式" aria-label="Permalink to &quot;post模式&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;blackbox-http-post&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/probe</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">params</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">module</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">http_post_2xx</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">https://www.example.com/api</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 要检查的网址</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__address__</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__param_target</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__param_target</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">instance</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">blackbox-exporter.monitor:9115</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;blackbox-http-post&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/probe</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">params</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">module</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">http_post_2xx</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">https://www.example.com/api</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 要检查的网址</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__address__</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__param_target</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__param_target</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">instance</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">blackbox-exporter.monitor:9115</span></span></code></pre></div><ul><li>热加载</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">curl -XPOST http://prometheus.ikubernetes.net/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">curl -XPOST http://prometheus.ikubernetes.net/-/reload</span></span></code></pre></div><h2 id="_4-6-监控ssl证书" tabindex="-1">4.6 监控ssl证书 <a class="header-anchor" href="#_4-6-监控ssl证书" aria-label="Permalink to &quot;4.6 监控ssl证书&quot;">​</a></h2><p>有时候blackbox监控时间不准</p><ul><li>创建采集器</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ssl-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scrape_interval</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">2m</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/probe</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">params</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">module</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;https&quot;</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;"># &lt;-----</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">&#39;kubernetes.default.svc:443&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">&#39;www.baidu.com:443&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__address__</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__param_target</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__param_target</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">instance</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ssl-exporter.monitor:9219</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ssl-exporter</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scrape_interval</span><span style="color:#24292E;">: </span><span style="color:#032F62;">2m</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/probe</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">params</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">module</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;https&quot;</span><span style="color:#24292E;">] </span><span style="color:#6A737D;"># &lt;-----</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">&#39;kubernetes.default.svc:443&#39;</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">&#39;www.baidu.com:443&#39;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__address__</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__param_target</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__param_target</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">instance</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ssl-exporter.monitor:9219</span></span></code></pre></div><ul><li>部署ssl-export</li></ul><p>1.ssl-exporter-dp.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ssl-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ssl-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ssl-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9219</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9219</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ssl-exporter</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ssl-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ssl-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ssl-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ssl-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">initContainers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># Install kube ca cert as a root CA</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ca</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/alpine:v3.7</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#9ECBFF;">sh</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#9ECBFF;">-c</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">              set -e</span></span>
<span class="line"><span style="color:#9ECBFF;">              apk add --update ca-certificates</span></span>
<span class="line"><span style="color:#9ECBFF;">              cp /var/run/secrets/kubernetes.io/serviceaccount/ca.crt /usr/local/share/ca-certificates/kube-ca.crt</span></span>
<span class="line"><span style="color:#9ECBFF;">              update-ca-certificates</span></span>
<span class="line"><span style="color:#9ECBFF;">              cp /etc/ssl/certs/* /ssl-certs</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ssl-certs</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/ssl-certs</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ssl-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/ssl-exporter:v2.4.3</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9219</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">requests</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">100m</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">50Mi</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">limits</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">200m</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">256Mi</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">securityContext</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">runAsUser</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1000</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">readOnlyRootFilesystem</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">runAsNonRoot</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">readinessProbe</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">tcpSocket</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9219</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">initialDelaySeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">timeoutSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">periodSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">successThreshold</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">failureThreshold</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ssl-certs</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/ssl/certs</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ssl-certs</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">emptyDir</span><span style="color:#E1E4E8;">: {}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ssl-exporter</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ssl-exporter</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ssl-exporter</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9219</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9219</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ssl-exporter</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ssl-exporter</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ssl-exporter</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ssl-exporter</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ssl-exporter</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">initContainers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># Install kube ca cert as a root CA</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ca</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/alpine:v3.7</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">command</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#032F62;">sh</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#032F62;">-c</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">              set -e</span></span>
<span class="line"><span style="color:#032F62;">              apk add --update ca-certificates</span></span>
<span class="line"><span style="color:#032F62;">              cp /var/run/secrets/kubernetes.io/serviceaccount/ca.crt /usr/local/share/ca-certificates/kube-ca.crt</span></span>
<span class="line"><span style="color:#032F62;">              update-ca-certificates</span></span>
<span class="line"><span style="color:#032F62;">              cp /etc/ssl/certs/* /ssl-certs</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ssl-certs</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/ssl-certs</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ssl-exporter</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/ssl-exporter:v2.4.3</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tcp</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9219</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">100m</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">50Mi</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">limits</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">200m</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">256Mi</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">securityContext</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">runAsUser</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1000</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">readOnlyRootFilesystem</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">runAsNonRoot</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">readinessProbe</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">tcpSocket</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9219</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">initialDelaySeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">timeoutSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">periodSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">successThreshold</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">failureThreshold</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ssl-certs</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/ssl/certs</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ssl-certs</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">emptyDir</span><span style="color:#24292E;">: {}</span></span></code></pre></div><ul><li>apply</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl apply -f 1.ssl-exporter-dp.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl apply -f 1.ssl-exporter-dp.yaml</span></span></code></pre></div><ul><li>热加载</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">curl -XPOST http://prometheus.ikubernetes.net/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">curl -XPOST http://prometheus.ikubernetes.net/-/reload</span></span></code></pre></div><ul><li>效果</li></ul><blockquote><p>表达式,小于30天, expr: (ssl_cert_not_after-time())/3600/24 &lt;30</p></blockquote><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406292233613.png" alt="image-20240629223318435"></p><p>可以使用图形,9965</p>`,129),e=[o];function t(c,r,E,y,i,F){return a(),n("div",null,e)}const d=s(l,[["render",t]]);export{_ as __pageData,d as default};
