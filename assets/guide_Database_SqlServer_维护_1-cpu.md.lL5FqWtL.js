import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const _=JSON.parse('{"title":"排除流程","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/SqlServer/维护/1-cpu.md","filePath":"guide/Database/SqlServer/维护/1-cpu.md","lastUpdated":1739268373000}'),p={name:"guide/Database/SqlServer/维护/1-cpu.md"},o=l(`<p>根据SSMS工具中的Query Store图形化功能/SSMS中直接执行T-SQL来判断是哪些SQL导致PAAS服务CPU占有率很高</p><p>如果是云上,则使用厂商自动图形界面进行排查</p><h1 id="排除流程" tabindex="-1">排除流程 <a class="header-anchor" href="#排除流程" aria-label="Permalink to &quot;排除流程&quot;">​</a></h1><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202502111347498.png" alt="image-20250211134702406"></p><h1 id="_1-了解-vcore-计数" tabindex="-1">1. 了解 vCore 计数 <a class="header-anchor" href="#_1-了解-vcore-计数" aria-label="Permalink to &quot;1. 了解 vCore 计数&quot;">​</a></h1><p>诊断高 CPU 事件时，了解可供数据库使用的虚拟核心 (vCore) 数会十分有用。 vCore 等效于逻辑 CPU。 vCore 数有助于了解数据库可用的 CPU 资源。使用 Transact-SQL 确定 vCore 计数的语句如下：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">COUNT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> vCores</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_schedulers</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">status</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;VISIBLE ONLINE&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">COUNT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> vCores</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_schedulers</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">status</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;VISIBLE ONLINE&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h1 id="_2-判断高-cpu-利用率的原因" tabindex="-1">2. 判断高 CPU 利用率的原因 <a class="header-anchor" href="#_2-判断高-cpu-利用率的原因" aria-label="Permalink to &quot;2. 判断高 CPU 利用率的原因&quot;">​</a></h1><h2 id="_2-1-常见导致cpu占有率高的原因" tabindex="-1">2.1 常见导致CPU占有率高的原因 <a class="header-anchor" href="#_2-1-常见导致cpu占有率高的原因" aria-label="Permalink to &quot;2.1 常见导致CPU占有率高的原因&quot;">​</a></h2><ul><li>工作负载中使用大量 CPU 的新查询。</li><li>定期运行查询的频率提高。</li><li>查询计划回归（包括由于参数敏感计划 (PSP) 问题导致的回归），从而导致一个或多个查询占用较多 CPU。</li><li>查询计划的编译或重新编译显著增加。</li><li>其中的查询使用过多并行的数据库</li></ul><h2 id="_2-2-常用检查方法" tabindex="-1">2.2 常用检查方法 <a class="header-anchor" href="#_2-2-常用检查方法" aria-label="Permalink to &quot;2.2 常用检查方法&quot;">​</a></h2><p>工作负载中是否出现使用大量 CPU 的新查询，或者是否看到定期运行查询的频率提高？ 使用以下任何方法进行调查。 查找历史记录有限的查询（新查询），并查看历史记录较长的查询的执行频率。</p><ul><li>在 云厂商 门户中查看 CPU 指标和排名靠前的相关查询</li><li>使用 Transact-SQL 按 CPU 使用率查询排名靠前的最近 15 个查询</li><li>使用 SSMS 中的交互式查询存储工具按 CPU 时间确定排名靠前的查询</li></ul><p>工作负载中的某些查询在每次执行时是否使用比过去更多的 CPU？ 如果是这样，查询执行计划是否更改？ 这些查询可能 存在参数敏感计划 (PSP) 问题。 使用以下任一方法进行调查。 查找具有多个查询执行计划并且 CPU 使用率发生显著变化的查询：</p><ul><li><p>使用 Transact-SQL 按 CPU 使用率查询排名靠前的最近 15 个查询</p></li><li><p>使用 SSMS 中的交互式查询存储工具按 CPU 时间确定排名靠前的查询</p></li><li><p>是否有出现大量编译或重新编译的证据？ 按查询哈希查询最常编译的查询，并查看编译频率。</p></li><li><p>查询是否使用过多并行？ 查询MAXDOP 数据库范围的配置 并查看 vCore 计数 在 MAXDOP 设置为 0 并且核心计数高于 8 的数据库中，通常会出现并行过多的情况。</p></li></ul><h1 id="_3-实操" tabindex="-1">3. 实操 <a class="header-anchor" href="#_3-实操" aria-label="Permalink to &quot;3. 实操&quot;">​</a></h1><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--CPU相关视图</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_sys_info</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sessions</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sysprocesses</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_tasks</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_workers</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_threads</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_schedulers</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_memory_objects</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_nodes</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_memory_nodes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--CPU相关视图</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_sys_info</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sessions</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sysprocesses</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_tasks</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_workers</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_threads</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_schedulers</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_memory_objects</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_nodes</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_memory_nodes</span></span></code></pre></div><h2 id="_3-0-查看cpu个数" tabindex="-1">3.0 查看cpu个数 <a class="header-anchor" href="#_3-0-查看cpu个数" aria-label="Permalink to &quot;3.0 查看cpu个数&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> max_workers_count,scheduler_count,cpu_count,hyperthread_ratio</span></span>
<span class="line"><span style="color:#E1E4E8;">,(hyperthread_ratio</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">cpu_count) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> physical_cpu_count</span></span>
<span class="line"><span style="color:#E1E4E8;">,(max_workers_count</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">scheduler_count) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> workers_per_scheduler_limit</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_sys_info</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> max_workers_count,scheduler_count,cpu_count,hyperthread_ratio</span></span>
<span class="line"><span style="color:#24292E;">,(hyperthread_ratio</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">cpu_count) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> physical_cpu_count</span></span>
<span class="line"><span style="color:#24292E;">,(max_workers_count</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">scheduler_count) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> workers_per_scheduler_limit</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_sys_info</span></span></code></pre></div><ul><li>查看最大工作线程数</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> max_workers_count </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_sys_info</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> max_workers_count </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_sys_info</span></span></code></pre></div><p>看到worker是否用完，当达到最大线程数的时候就要检查blocking了</p><h2 id="_3-1-查看有无死锁" tabindex="-1">3.1 查看有无死锁 <a class="header-anchor" href="#_3-1-查看有无死锁" aria-label="Permalink to &quot;3.1 查看有无死锁&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">   spid,        </span></span>
<span class="line"><span style="color:#E1E4E8;">         blocked,         </span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> DBName,        </span></span>
<span class="line"><span style="color:#E1E4E8;">         program_name,         </span></span>
<span class="line"><span style="color:#E1E4E8;">         waitresource,         </span></span>
<span class="line"><span style="color:#E1E4E8;">         lastwaittype,         </span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">loginame</span><span style="color:#E1E4E8;">,        </span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">hostname</span><span style="color:#E1E4E8;">,         </span></span>
<span class="line"><span style="color:#E1E4E8;">         a.[Text] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [TextData],        </span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">stmt_start</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">,         </span></span>
<span class="line"><span style="color:#E1E4E8;">         (</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">stmt_end</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATALENGTH</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">stmt_end</span><span style="color:#E1E4E8;">          </span></span>
<span class="line"><span style="color:#E1E4E8;">		 </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">stmt_start</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [current_cmd]</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sysprocesses</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> sp </span><span style="color:#F97583;">OUTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> A </span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> spid </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">50</span></span>
<span class="line"><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocked</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--这里blocked字段表示是否处于死锁阻塞，如果值不为0则说明死锁，反之则不死锁</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> blocked </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">ASC</span><span style="color:#E1E4E8;">, a.[text];</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">   spid,        </span></span>
<span class="line"><span style="color:#24292E;">         blocked,         </span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> DBName,        </span></span>
<span class="line"><span style="color:#24292E;">         program_name,         </span></span>
<span class="line"><span style="color:#24292E;">         waitresource,         </span></span>
<span class="line"><span style="color:#24292E;">         lastwaittype,         </span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">loginame</span><span style="color:#24292E;">,        </span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">hostname</span><span style="color:#24292E;">,         </span></span>
<span class="line"><span style="color:#24292E;">         a.[Text] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [TextData],        </span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">stmt_start</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">,         </span></span>
<span class="line"><span style="color:#24292E;">         (</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">stmt_end</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATALENGTH</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">stmt_end</span><span style="color:#24292E;">          </span></span>
<span class="line"><span style="color:#24292E;">		 </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">stmt_start</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [current_cmd]</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sysprocesses</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> sp </span><span style="color:#D73A49;">OUTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> A </span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> spid </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">50</span></span>
<span class="line"><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocked</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">--这里blocked字段表示是否处于死锁阻塞，如果值不为0则说明死锁，反之则不死锁</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> blocked </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">ASC</span><span style="color:#24292E;">, a.[text];</span></span></code></pre></div><p>如若找到死锁的记录条，则使用kill命令去杀掉blocked字段里的ID值即可，格式如下：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">KILL</span><span style="color:#E1E4E8;"> ID（blocked）</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">KILL</span><span style="color:#24292E;"> ID（blocked）</span></span></code></pre></div><h2 id="_3-2-查看消耗cpu资源比较大的语句" tabindex="-1">3.2 查看消耗CPU资源比较大的语句 <a class="header-anchor" href="#_3-2-查看消耗cpu资源比较大的语句" aria-label="Permalink to &quot;3.2 查看消耗CPU资源比较大的语句&quot;">​</a></h2><p>在上一步骤中假设没有死锁的会话或语句，则我们重点考虑如何拉出执行效率比较低的语句</p><h3 id="_3-2-1确定当前正在运行的查询" tabindex="-1">3.2.1确定当前正在运行的查询 <a class="header-anchor" href="#_3-2-1确定当前正在运行的查询" aria-label="Permalink to &quot;3.2.1确定当前正在运行的查询&quot;">​</a></h3><p>通过执行以下查询，使用 CPU 使用率和执行计划查找当前正在运行的查询。 CPU 时间以毫秒为单位返回</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">status</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">start_time</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">cpu_time</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;cpu_time_ms&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">logical_reads</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dop</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">login_name</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">host_name</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">program_name</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">object_name</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">st</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objectid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">st</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;">) </span><span style="color:#9ECBFF;">&#39;ObjectName&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">REPLACE</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">REPLACE</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">st</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">,(</span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        ((</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATALENGTH</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">st</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;">), </span><span style="color:#F97583;">CHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> statement_text,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">qp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_plan</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">qsx</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_plan</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> query_plan_with_in_flight_statistics</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> req  </span></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sessions</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> st</span></span>
<span class="line"><span style="color:#F97583;">OUTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_plan</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">plan_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> qp</span></span>
<span class="line"><span style="color:#F97583;">OUTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_query_statistics_xml</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> qsx</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">cpu_time</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">desc</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">status</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">start_time</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">cpu_time</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;cpu_time_ms&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">logical_reads</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dop</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">login_name</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">host_name</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">program_name</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">object_name</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">st</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objectid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">st</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;">) </span><span style="color:#032F62;">&#39;ObjectName&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">REPLACE</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">REPLACE</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">st</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">,(</span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        ((</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATALENGTH</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">st</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">), </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;">), </span><span style="color:#D73A49;">CHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">13</span><span style="color:#24292E;">), </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> statement_text,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">qp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_plan</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">qsx</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_plan</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> query_plan_with_in_flight_statistics</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> req  </span></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sessions</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> st</span></span>
<span class="line"><span style="color:#D73A49;">OUTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_plan</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">plan_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> qp</span></span>
<span class="line"><span style="color:#D73A49;">OUTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_query_statistics_xml</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> qsx</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">cpu_time</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">desc</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="_3-2-2查看过去一小时的-cpu-使用率指标" tabindex="-1">3.2.2查看过去一小时的 CPU 使用率指标 <a class="header-anchor" href="#_3-2-2查看过去一小时的-cpu-使用率指标" aria-label="Permalink to &quot;3.2.2查看过去一小时的 CPU 使用率指标&quot;">​</a></h3><h3 id="_3-2-3按-cpu-使用率查询排名靠前的最近-15-个查询" tabindex="-1">3.2.3按 CPU 使用率查询排名靠前的最近 15 个查询 <a class="header-anchor" href="#_3-2-3按-cpu-使用率查询排名靠前的最近-15-个查询" aria-label="Permalink to &quot;3.2.3按 CPU 使用率查询排名靠前的最近 15 个查询&quot;">​</a></h3><p><strong>前提：在SSMS中要切换到业务所在的数据库！！！！！</strong></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> AggregatedCPU </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">q</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_hash</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(count_executions </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> avg_cpu_time </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> total_cpu_ms, </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(count_executions </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> avg_cpu_time </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(count_executions) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> avg_cpu_ms, </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">MAX</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">rs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">max_cpu_time</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> max_cpu_ms, </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">MAX</span><span style="color:#E1E4E8;">(max_logical_io_reads) max_logical_reads, </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">COUNT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DISTINCT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">plan_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> number_of_distinct_plans, </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">COUNT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DISTINCT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> number_of_distinct_query_ids, </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">rs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_type_desc</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;Aborted&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> count_executions </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> aborted_execution_count, </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">rs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_type_desc</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;Regular&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> count_executions </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> regular_execution_count, </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">rs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_type_desc</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;Exception&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> count_executions </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> exception_execution_count, </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(count_executions) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> total_executions, </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">MIN</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_sql_text</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> sampled_query_text</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_store_query_text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> qt</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_store_query</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> q </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_text_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">q</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_text_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_store_plan</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">q</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_store_runtime_stats</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> rs </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">rs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">plan_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">plan_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_store_runtime_stats_interval</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> rsi </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">rsi</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">runtime_stats_interval_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">rs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">runtime_stats_interval_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">rs</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_type_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;Regular&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;Aborted&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;Exception&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">rsi</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">start_time</span><span style="color:#F97583;">&gt;=</span><span style="color:#79B8FF;">DATEADD</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">HOUR</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETUTCDATE</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">GROUP BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">q</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_hash</span><span style="color:#E1E4E8;">), </span></span>
<span class="line"><span style="color:#E1E4E8;">OrderedCPU </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">ROW_NUMBER</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">OVER</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> total_cpu_ms </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">, query_hash </span><span style="color:#F97583;">ASC</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> RN</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> AggregatedCPU)</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> OrderedCPU </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> OD</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OD</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">RN</span><span style="color:#F97583;">&lt;=</span><span style="color:#79B8FF;">15</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> total_cpu_ms </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> AggregatedCPU </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    (</span><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">q</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_hash</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(count_executions </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> avg_cpu_time </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> total_cpu_ms, </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(count_executions </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> avg_cpu_time </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(count_executions) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> avg_cpu_ms, </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">MAX</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">rs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">max_cpu_time</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> max_cpu_ms, </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">MAX</span><span style="color:#24292E;">(max_logical_io_reads) max_logical_reads, </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">COUNT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DISTINCT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">plan_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> number_of_distinct_plans, </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">COUNT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DISTINCT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> number_of_distinct_query_ids, </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">rs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_type_desc</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;Aborted&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> count_executions </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> aborted_execution_count, </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">rs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_type_desc</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;Regular&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> count_executions </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> regular_execution_count, </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">rs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_type_desc</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;Exception&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> count_executions </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> exception_execution_count, </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(count_executions) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> total_executions, </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">MIN</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_sql_text</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> sampled_query_text</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_store_query_text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> qt</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_store_query</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> q </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_text_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">q</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_text_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_store_plan</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">q</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_store_runtime_stats</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> rs </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">rs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">plan_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">plan_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_store_runtime_stats_interval</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> rsi </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">rsi</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">runtime_stats_interval_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">rs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">runtime_stats_interval_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">rs</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_type_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;Regular&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;Aborted&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;Exception&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">rsi</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">start_time</span><span style="color:#D73A49;">&gt;=</span><span style="color:#005CC5;">DATEADD</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">HOUR</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETUTCDATE</span><span style="color:#24292E;">())</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">GROUP BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">q</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_hash</span><span style="color:#24292E;">), </span></span>
<span class="line"><span style="color:#24292E;">OrderedCPU </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">ROW_NUMBER</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">OVER</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> total_cpu_ms </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">, query_hash </span><span style="color:#D73A49;">ASC</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> RN</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> AggregatedCPU)</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> OrderedCPU </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> OD</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OD</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">RN</span><span style="color:#D73A49;">&lt;=</span><span style="color:#005CC5;">15</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> total_cpu_ms </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="_3-2-4查看是否有阻塞" tabindex="-1">3.2.4查看是否有阻塞 <a class="header-anchor" href="#_3-2-4查看是否有阻塞" aria-label="Permalink to &quot;3.2.4查看是否有阻塞&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">  [session_id],</span></span>
<span class="line"><span style="color:#E1E4E8;">  [request_id],</span></span>
<span class="line"><span style="color:#E1E4E8;">  [start_time] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;开始时间&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [status] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;状态&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  [command] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;命令&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  dest.[text] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;sql语句&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">([database_id]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;数据库名&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  [blocking_session_id] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;正在阻塞其他会话的会话ID&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [wait_type] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;等待资源类型&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [wait_time] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;等待时间&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [wait_resource] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;等待的资源&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [reads] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;物理读次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [writes] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;写次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [logical_reads] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;逻辑读次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [row_count] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;返回结果行数&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> sys.[dm_exec_requests] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> der </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> sys.[dm_exec_sql_text](der.[sql_handle]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> dest </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> [session_id]</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(der.[database_id])</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;biyin&#39;</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [cpu_time] </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">  [session_id],</span></span>
<span class="line"><span style="color:#24292E;">  [request_id],</span></span>
<span class="line"><span style="color:#24292E;">  [start_time] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;开始时间&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [status] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;状态&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  [command] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;命令&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  dest.[text] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;sql语句&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">([database_id]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;数据库名&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  [blocking_session_id] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;正在阻塞其他会话的会话ID&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [wait_type] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;等待资源类型&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [wait_time] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;等待时间&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [wait_resource] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;等待的资源&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [reads] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;物理读次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [writes] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;写次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [logical_reads] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;逻辑读次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [row_count] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;返回结果行数&#39;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> sys.[dm_exec_requests] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> der </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> sys.[dm_exec_sql_text](der.[sql_handle]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> dest </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> [session_id]</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(der.[database_id])</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;biyin&#39;</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [cpu_time] </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><ul><li>查看具体语句</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">dest.[text] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;sql语句&#39;</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> sys.[dm_exec_requests] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> der </span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">sys.[dm_exec_sql_text](der.[sql_handle]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> dest </span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> [session_id]</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [cpu_time] </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">dest.[text] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;sql语句&#39;</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> sys.[dm_exec_requests] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> der </span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">sys.[dm_exec_sql_text](der.[sql_handle]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> dest </span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> [session_id]</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">50</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [cpu_time] </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><h3 id="_3-2-5查看资源是否有阻塞" tabindex="-1">3.2.5查看资源是否有阻塞 <a class="header-anchor" href="#_3-2-5查看资源是否有阻塞" aria-label="Permalink to &quot;3.2.5查看资源是否有阻塞&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;"> [session_id],</span></span>
<span class="line"><span style="color:#E1E4E8;"> [request_id],</span></span>
<span class="line"><span style="color:#E1E4E8;"> [start_time] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;开始时间&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [status] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;状态&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [command] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;命令&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> dest.[text] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;sql语句&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">([database_id]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;数据库名&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [blocking_session_id] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;正在阻塞其他会话的会话ID&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> der.[wait_type] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;等待资源类型&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [wait_time] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;等待时间&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [wait_resource] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;等待的资源&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [dows].[waiting_tasks_count] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;当前正在进行等待的任务数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [reads] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;物理读次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [writes] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;写次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [logical_reads] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;逻辑读次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> [row_count] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;返回结果行数&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> sys.[dm_exec_requests] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> der </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> [sys].[dm_os_wait_stats] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> dows </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> der.[wait_type]</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">[dows].[wait_type]</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> sys.[dm_exec_sql_text](der.[sql_handle]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> dest </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> [session_id]</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [cpu_time] </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;"> [session_id],</span></span>
<span class="line"><span style="color:#24292E;"> [request_id],</span></span>
<span class="line"><span style="color:#24292E;"> [start_time] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;开始时间&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [status] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;状态&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [command] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;命令&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> dest.[text] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;sql语句&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">([database_id]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;数据库名&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [blocking_session_id] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;正在阻塞其他会话的会话ID&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> der.[wait_type] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;等待资源类型&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [wait_time] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;等待时间&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [wait_resource] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;等待的资源&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [dows].[waiting_tasks_count] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;当前正在进行等待的任务数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [reads] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;物理读次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [writes] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;写次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [logical_reads] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;逻辑读次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> [row_count] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;返回结果行数&#39;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> sys.[dm_exec_requests] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> der </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> [sys].[dm_os_wait_stats] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> dows </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> der.[wait_type]</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[dows].[wait_type]</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> sys.[dm_exec_sql_text](der.[sql_handle]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> dest </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> [session_id]</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">50</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [cpu_time] </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><ul><li>或者</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> cteBL (session_id, blocking_these) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;">, blocking_these </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">x</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_these</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sessions</span><span style="color:#E1E4E8;"> s</span></span>
<span class="line"><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;">    (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">isnull</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">convert</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;">),</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;, &#39;</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> er</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">isnull</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> ,</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PATH</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">) ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> x (blocking_these)</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;">, blocked_by </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">bl</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_these</span></span>
<span class="line"><span style="color:#E1E4E8;">, batch_text </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">, input_buffer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ib</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">event_info</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sessions</span><span style="color:#E1E4E8;"> s</span></span>
<span class="line"><span style="color:#F97583;">LEFT OUTER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> r </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> cteBL </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> bl </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">bl</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"><span style="color:#F97583;">OUTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">) t</span></span>
<span class="line"><span style="color:#F97583;">OUTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_input_buffer</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> ib</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> blocking_these </span><span style="color:#F97583;">is not null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">bl</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_these</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">desc</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">desc</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> cteBL (session_id, blocking_these) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;">, blocking_these </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">x</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_these</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sessions</span><span style="color:#24292E;"> s</span></span>
<span class="line"><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;">    (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">isnull</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">convert</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">6</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;">),</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;, &#39;</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> er</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">isnull</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> ,</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PATH</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">) ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> x (blocking_these)</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;">, blocked_by </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">bl</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_these</span></span>
<span class="line"><span style="color:#24292E;">, batch_text </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">, input_buffer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ib</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">event_info</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sessions</span><span style="color:#24292E;"> s</span></span>
<span class="line"><span style="color:#D73A49;">LEFT OUTER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> r </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> cteBL </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> bl </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">bl</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"><span style="color:#D73A49;">OUTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">) t</span></span>
<span class="line"><span style="color:#D73A49;">OUTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_input_buffer</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> ib</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> blocking_these </span><span style="color:#D73A49;">is not null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">len</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">bl</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_these</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">desc</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">desc</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;">;</span></span></code></pre></div><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">kill</span><span style="color:#E1E4E8;"> session_id</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">kill</span><span style="color:#24292E;"> session_id</span></span></code></pre></div><h3 id="_3-2-6对现有cpu排序" tabindex="-1">3.2.6对现有cpu排序 <a class="header-anchor" href="#_3-2-6对现有cpu排序" aria-label="Permalink to &quot;3.2.6对现有cpu排序&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">  [req].[session_id],</span></span>
<span class="line"><span style="color:#E1E4E8;">  [req].[start_time],</span></span>
<span class="line"><span style="color:#E1E4E8;">  [req].[cpu_time] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [cpu_time_ms],</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">( [ST].[objectid], [ST].[dbid] ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [ObjectName],</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">REPLACE</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">REPLACE</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">          [ST].[text],</span></span>
<span class="line"><span style="color:#E1E4E8;">          ( [req].[statement_start_offset] </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> ) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">          (</span></span>
<span class="line"><span style="color:#E1E4E8;">          ( </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> [req].[statement_end_offset] </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATALENGTH</span><span style="color:#E1E4E8;">( [ST].[text] ) </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> [req].[statement_end_offset] </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> [req].[statement_start_offset] ) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">  ) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">  ),</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">CHAR</span><span style="color:#E1E4E8;"> ( </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> ),</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">  ),</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">CHAR</span><span style="color:#E1E4E8;"> ( </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> ),</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">  ),</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">512</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">  ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [statement_text] </span></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">  [sys].[dm_exec_requests] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [req] </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> [sys].dm_exec_sql_text ( [req].[sql_handle] ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [ST] </span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span></span>
<span class="line"><span style="color:#E1E4E8;">  [req].[cpu_time] </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">  [req].[session_id],</span></span>
<span class="line"><span style="color:#24292E;">  [req].[start_time],</span></span>
<span class="line"><span style="color:#24292E;">  [req].[cpu_time] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [cpu_time_ms],</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">( [ST].[objectid], [ST].[dbid] ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [ObjectName],</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">REPLACE</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">REPLACE</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">          [ST].[text],</span></span>
<span class="line"><span style="color:#24292E;">          ( [req].[statement_start_offset] </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> ) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">          (</span></span>
<span class="line"><span style="color:#24292E;">          ( </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> [req].[statement_end_offset] </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATALENGTH</span><span style="color:#24292E;">( [ST].[text] ) </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> [req].[statement_end_offset] </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> [req].[statement_start_offset] ) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">  ) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">  ),</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">CHAR</span><span style="color:#24292E;"> ( </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> ),</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">  ),</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">CHAR</span><span style="color:#24292E;"> ( </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> ),</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">  ),</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">512</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">  ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [statement_text] </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">  [sys].[dm_exec_requests] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [req] </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> [sys].dm_exec_sql_text ( [req].[sql_handle] ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [ST] </span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span></span>
<span class="line"><span style="color:#24292E;">  [req].[cpu_time] </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><h2 id="_3-3-查看是否缺失索引" tabindex="-1">3.3 查看是否缺失索引 <a class="header-anchor" href="#_3-3-查看是否缺失索引" aria-label="Permalink to &quot;3.3 查看是否缺失索引&quot;">​</a></h2><h3 id="_3-3-1查看缺失个数" tabindex="-1">3.3.1查看缺失个数 <a class="header-anchor" href="#_3-3-1查看缺失个数" aria-label="Permalink to &quot;3.3.1查看缺失个数&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    DatabaseName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(database_id)</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,[Number Indexes Missing] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">count</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_missing_index_details</span></span>
<span class="line"><span style="color:#F97583;">GROUP BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(database_id)</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    DatabaseName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(database_id)</span></span>
<span class="line"><span style="color:#24292E;">    ,[Number Indexes Missing] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">count</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_missing_index_details</span></span>
<span class="line"><span style="color:#D73A49;">GROUP BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(database_id)</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202502111336258.png" alt="image-20250211133637660"></p><h3 id="_3-3-2-列出哪些表需要添加索引" tabindex="-1">3.3.2 列出哪些表需要添加索引 <a class="header-anchor" href="#_3-3-2-列出哪些表需要添加索引" aria-label="Permalink to &quot;3.3.2 列出哪些表需要添加索引&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        [Total Cost]  </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ROUND</span><span style="color:#E1E4E8;">(avg_total_user_cost </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> avg_user_impact </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> (user_seeks </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> user_scans),</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">        , avg_user_impact</span></span>
<span class="line"><span style="color:#E1E4E8;">        , TableName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">statement</span></span>
<span class="line"><span style="color:#E1E4E8;">        , [EqualityUsage] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> equality_columns </span></span>
<span class="line"><span style="color:#E1E4E8;">        , [InequalityUsage] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> inequality_columns</span></span>
<span class="line"><span style="color:#E1E4E8;">        , [Include Cloumns] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> included_columns</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_missing_index_groups</span><span style="color:#E1E4E8;"> g </span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_missing_index_group_stats</span><span style="color:#E1E4E8;"> s </span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">group_handle</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">g</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_group_handle</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_missing_index_details</span><span style="color:#E1E4E8;"> d </span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_handle</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">g</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_handle</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [Total Cost] </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        [Total Cost]  </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ROUND</span><span style="color:#24292E;">(avg_total_user_cost </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> avg_user_impact </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> (user_seeks </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> user_scans),</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">        , avg_user_impact</span></span>
<span class="line"><span style="color:#24292E;">        , TableName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">statement</span></span>
<span class="line"><span style="color:#24292E;">        , [EqualityUsage] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> equality_columns </span></span>
<span class="line"><span style="color:#24292E;">        , [InequalityUsage] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> inequality_columns</span></span>
<span class="line"><span style="color:#24292E;">        , [Include Cloumns] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> included_columns</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_missing_index_groups</span><span style="color:#24292E;"> g </span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_missing_index_group_stats</span><span style="color:#24292E;"> s </span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">group_handle</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">g</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_group_handle</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_missing_index_details</span><span style="color:#24292E;"> d </span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_handle</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">g</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_handle</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [Total Cost] </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">;</span></span></code></pre></div><p>官当，<a href="https://learn.microsoft.com/zh-cn/troubleshoot/sql/database-engine/performance/troubleshoot-high-cpu-usage-issues" target="_blank" rel="noreferrer">https://learn.microsoft.com/zh-cn/troubleshoot/sql/database-engine/performance/troubleshoot-high-cpu-usage-issues</a></p>`,53),e=[o];function t(c,r,E,y,i,F){return n(),a("div",null,e)}const d=s(p,[["render",t]]);export{_ as __pageData,d as default};
