import{_ as s,o as a,c as n,R as p}from"./chunks/framework.zUbWieqp.js";const F=JSON.parse('{"title":"1. 有jdk情况","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/TroubleshootingMaintenanceManual/10-JvmDump.md","filePath":"guide/container/k8s/TroubleshootingMaintenanceManual/10-JvmDump.md","lastUpdated":1732530535000}'),l={name:"guide/container/k8s/TroubleshootingMaintenanceManual/10-JvmDump.md"},o=p(`<h1 id="_1-有jdk情况" tabindex="-1">1. 有jdk情况 <a class="header-anchor" href="#_1-有jdk情况" aria-label="Permalink to &quot;1. 有jdk情况&quot;">​</a></h1><h2 id="_1-1-添加钩子函数" tabindex="-1">1.1 添加钩子函数 <a class="header-anchor" href="#_1-1-添加钩子函数" aria-label="Permalink to &quot;1.1 添加钩子函数&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">idk-mob-sdk-server</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">harbor.example.com/base/example:v1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">imagePullPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">lifecycle</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">preStop</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">exec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;sh&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;-c&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;jstack -F $(jps |grep -v Jps | awk &#39;{print $1}&#39;) | tee -a /logs/thread.dump &amp;&amp; jmap -dump:format=b,file=/logs/$(date +&#39;%Y-%m-%d_%H%M%S&#39;).hprof $(jps |grep -v Jps | awk &#39;{print $1}&#39;)&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">readinessProbe</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">failureThreshold</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">httpGet</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/actuator/info</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5003</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scheme</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">HTTP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">initialDelaySeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">30</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">periodSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">15</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">successThreshold</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">timeoutSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/logs</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-logs</span></span>
<span class="line"><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">hostPath</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/logs</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">DirectoryOrCreate</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-logs</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">idk-mob-sdk-server</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">harbor.example.com/base/example:v1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">imagePullPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">lifecycle</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">preStop</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">exec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;sh&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;-c&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;jstack -F $(jps |grep -v Jps | awk &#39;{print $1}&#39;) | tee -a /logs/thread.dump &amp;&amp; jmap -dump:format=b,file=/logs/$(date +&#39;%Y-%m-%d_%H%M%S&#39;).hprof $(jps |grep -v Jps | awk &#39;{print $1}&#39;)&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">readinessProbe</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">failureThreshold</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">httpGet</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/actuator/info</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5003</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scheme</span><span style="color:#24292E;">: </span><span style="color:#032F62;">HTTP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">initialDelaySeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">30</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">periodSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">15</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">successThreshold</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">timeoutSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/logs</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-logs</span></span>
<span class="line"><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">hostPath</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/logs</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">DirectoryOrCreate</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-logs</span></span></code></pre></div><p>在线分析,<a href="https://memory.console.heapdump.cn/" target="_blank" rel="noreferrer">https://memory.console.heapdump.cn/</a></p><h1 id="_2-没有jdk情况" tabindex="-1">2. 没有jdk情况 <a class="header-anchor" href="#_2-没有jdk情况" aria-label="Permalink to &quot;2. 没有jdk情况&quot;">​</a></h1><p>jattach 实现了HotSpot Attach <a href="https://github.com/apangin/jattach" target="_blank" rel="noreferrer">API</a></p><h2 id="_2-1-下载" tabindex="-1">2.1 下载 <a class="header-anchor" href="#_2-1-下载" aria-label="Permalink to &quot;2.1 下载&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://github.com/jattach/jattach/releases/download/v2.2/jattach</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://github.com/jattach/jattach/releases/download/v2.2/jattach</span></span></code></pre></div><ul><li>重新生成dockerfile文件，吧jattach复制到镜像中去</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#!/bin/sh</span></span>
<span class="line"><span style="color:#6A737D;"># 导出当前内存信息</span></span>
<span class="line"><span style="color:#B392F0;">jattach 1 dumpheap /opt/dump/dumpheap_</span><span style="color:#B392F0;">&quot;</span><span style="color:#E1E4E8;">$HOSTNAME</span><span style="color:#B392F0;">&quot;</span><span style="color:#B392F0;">_</span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">date +%Y%m%d-%H%M%S</span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">.hprof</span></span>
<span class="line"><span style="color:#6A737D;"># 导出当前线程信息</span></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">seq 3</span><span style="color:#9ECBFF;">\`</span></span>
<span class="line"><span style="color:#E1E4E8;">do </span></span>
<span class="line"><span style="color:#B392F0;">    jattach 1 threaddump &gt; /opt/dump/threaddump_</span><span style="color:#B392F0;">&quot;</span><span style="color:#E1E4E8;">$HOSTNAME</span><span style="color:#B392F0;">&quot;</span><span style="color:#B392F0;">_</span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">date +%Y%m%d-%H%M%S</span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">.log </span><span style="color:#E1E4E8;">&amp;&amp;</span><span style="color:#B392F0;"> sleep 1</span></span>
<span class="line"><span style="color:#F97583;">done</span></span>
<span class="line"><span style="color:#6A737D;"># 导出当前使用CPU最高的线程</span></span>
<span class="line"><span style="color:#B392F0;">top -H -p 1 -n 3 -c -b &gt; /opt/dump/cpudump_</span><span style="color:#B392F0;">&quot;</span><span style="color:#E1E4E8;">$HOSTNAME</span><span style="color:#B392F0;">&quot;</span><span style="color:#B392F0;">_</span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">date +%Y%m%d-%H%M%S</span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">.log</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#!/bin/sh</span></span>
<span class="line"><span style="color:#6A737D;"># 导出当前内存信息</span></span>
<span class="line"><span style="color:#6F42C1;">jattach 1 dumpheap /opt/dump/dumpheap_</span><span style="color:#6F42C1;">&quot;</span><span style="color:#24292E;">$HOSTNAME</span><span style="color:#6F42C1;">&quot;</span><span style="color:#6F42C1;">_</span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">date +%Y%m%d-%H%M%S</span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">.hprof</span></span>
<span class="line"><span style="color:#6A737D;"># 导出当前线程信息</span></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">seq 3</span><span style="color:#032F62;">\`</span></span>
<span class="line"><span style="color:#24292E;">do </span></span>
<span class="line"><span style="color:#6F42C1;">    jattach 1 threaddump &gt; /opt/dump/threaddump_</span><span style="color:#6F42C1;">&quot;</span><span style="color:#24292E;">$HOSTNAME</span><span style="color:#6F42C1;">&quot;</span><span style="color:#6F42C1;">_</span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">date +%Y%m%d-%H%M%S</span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">.log </span><span style="color:#24292E;">&amp;&amp;</span><span style="color:#6F42C1;"> sleep 1</span></span>
<span class="line"><span style="color:#D73A49;">done</span></span>
<span class="line"><span style="color:#6A737D;"># 导出当前使用CPU最高的线程</span></span>
<span class="line"><span style="color:#6F42C1;">top -H -p 1 -n 3 -c -b &gt; /opt/dump/cpudump_</span><span style="color:#6F42C1;">&quot;</span><span style="color:#24292E;">$HOSTNAME</span><span style="color:#6F42C1;">&quot;</span><span style="color:#6F42C1;">_</span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">date +%Y%m%d-%H%M%S</span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">.log</span></span></code></pre></div><p>使用使用MAT(MemoryAnalyzer Tool)进行分析</p><h1 id="_3-arthas" tabindex="-1">3.arthas <a class="header-anchor" href="#_3-arthas" aria-label="Permalink to &quot;3.arthas&quot;">​</a></h1><p><a href="https://github.com/yilingyi/k8s-java-thread-dumper" target="_blank" rel="noreferrer">https://github.com/yilingyi/k8s-java-thread-dumper</a></p>`,13),e=[o];function t(c,r,y,E,i,d){return a(),n("div",null,e)}const u=s(l,[["render",t]]);export{F as __pageData,u as default};
