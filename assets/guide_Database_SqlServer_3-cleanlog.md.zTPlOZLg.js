import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const A=JSON.parse('{"title":"1.日志状态","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/SqlServer/3-cleanlog.md","filePath":"guide/Database/SqlServer/3-cleanlog.md","lastUpdated":1730196597000}'),p={name:"guide/Database/SqlServer/3-cleanlog.md"},o=l(`<h1 id="_1-日志状态" tabindex="-1">1.日志状态 <a class="header-anchor" href="#_1-日志状态" aria-label="Permalink to &quot;1.日志状态&quot;">​</a></h1><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">,log_reuse_wait,log_reuse_wait_desc </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">databases</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">,log_reuse_wait,log_reuse_wait_desc </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">databases</span></span></code></pre></div><table><thead><tr><th style="text-align:left;">name</th><th style="text-align:left;">log_reuse_wait</th><th style="text-align:left;">log_reuse_wait_desc</th><th style="text-align:left;">解释</th><th style="text-align:left;">备注</th></tr></thead><tbody><tr><td style="text-align:left;">xxx</td><td style="text-align:left;">0</td><td style="text-align:left;">NOTHING</td><td style="text-align:left;">无</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">xxx</td><td style="text-align:left;">1</td><td style="text-align:left;">checkpoint</td><td style="text-align:left;">检查点</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">BF_POS</td><td style="text-align:left;">2</td><td style="text-align:left;"><strong>LOG_BACKUP</strong></td><td style="text-align:left;">日志备份</td><td style="text-align:left;"><strong>说明日志待备份</strong></td></tr><tr><td style="text-align:left;">xxx</td><td style="text-align:left;">3</td><td style="text-align:left;">Active backup or restore</td><td style="text-align:left;">活动备份或还原</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">WSS_Content</td><td style="text-align:left;">4</td><td style="text-align:left;"><strong>ACTIVE_TRANSACTION</strong></td><td style="text-align:left;">活动事务</td><td style="text-align:left;"><strong>说明有事务没有提交</strong> 使用 USE abc; DBCC OPENTRAN 查看最早未提交的事务(可尝试杀掉最早未提交的事务).</td></tr><tr><td style="text-align:left;">xxx</td><td style="text-align:left;">5</td><td style="text-align:left;">Database mirroring</td><td style="text-align:left;">数据库镜像</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">xxx</td><td style="text-align:left;">6</td><td style="text-align:left;">Replication</td><td style="text-align:left;"><strong>复制</strong></td><td style="text-align:left;">2021.03.24.启用cdc若agent服务停止也会造成Replication状态</td></tr><tr><td style="text-align:left;">xxx</td><td style="text-align:left;">7</td><td style="text-align:left;">Database snapshot creation</td><td style="text-align:left;">数据库快照创建</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">xxx</td><td style="text-align:left;">8</td><td style="text-align:left;">Log scan</td><td style="text-align:left;">日志扫描</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">xxx</td><td style="text-align:left;">9</td><td style="text-align:left;"><strong>AVAILABILITY_REPLICA</strong></td><td style="text-align:left;">辅助副本正将事务日志应用到数据库</td><td style="text-align:left;"><strong>若配置了ag请确认所有节点和db状态都正常</strong></td></tr></tbody></table><h2 id="日志无法进行transaction" tabindex="-1">日志无法进行transaction <a class="header-anchor" href="#日志无法进行transaction" aria-label="Permalink to &quot;日志无法进行transaction&quot;">​</a></h2><ul><li>以下都不行</li></ul><p>CHECKPOINT</p><p>LOG_BACKUP</p><p>ACTIVE_BACKUP_OR_RESTORE</p><p>ACTIVE_TRANSACTION</p><p>DATABASE_MIRRORING</p><p>REPLICATION</p><p>DATABASE_SNAPSHOT_CREATION</p><p>LOG_SCAN</p><p>AVAILABILITY_REPLICA</p><p>OLDEST_PAGE</p><p>XTP_CHECKPOINT</p><p>OTHER TRANSIEN</p><ul><li>查看数据库日志状态</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> [name] ,[log_reuse_wait_desc] </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">master</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.databases </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> [name]</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;hantest&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> [name] ,[log_reuse_wait_desc] </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">master</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.databases </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> [name]</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;hantest&#39;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141012068.jpg" alt=""></p><h2 id="_1-0清理日志文件的方法" tabindex="-1">1.0清理日志文件的方法 <a class="header-anchor" href="#_1-0清理日志文件的方法" aria-label="Permalink to &quot;1.0清理日志文件的方法&quot;">​</a></h2><p>官方文档，<a href="https://docs.microsoft.com/zh-cn/sql/t-sql/database-console-commands/dbcc-shrinkfile-transact-sql?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/t-sql/database-console-commands/dbcc-shrinkfile-transact-sql?view=sql-server-2017</a></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [storm]  </span></span>
<span class="line"><span style="color:#F97583;">GO</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> storm </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">RECOVERY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SIMPLE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> NO_WAIT  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">GO</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> storm </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">RECOVERY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SIMPLE</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">--简单模式  </span></span>
<span class="line"><span style="color:#F97583;">GO</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> storm</span></span>
<span class="line"><span style="color:#F97583;">GO</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC SHRINKFILE (</span><span style="color:#9ECBFF;">N&#39;storm_log&#39;</span><span style="color:#E1E4E8;"> , </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, TRUNCATEONLY)  </span><span style="color:#6A737D;">--设置压缩后的日志大小为2M，可以自行指定  </span></span>
<span class="line"><span style="color:#F97583;">GO</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> storm  </span></span>
<span class="line"><span style="color:#F97583;">GO</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> storm </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">RECOVERY</span><span style="color:#E1E4E8;"> FULL </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> NO_WAIT  </span></span>
<span class="line"><span style="color:#F97583;">GO</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> storm </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">RECOVERY</span><span style="color:#E1E4E8;"> FULL  </span><span style="color:#6A737D;">--还原为完全模式  </span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [storm]  </span></span>
<span class="line"><span style="color:#D73A49;">GO</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> storm </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">RECOVERY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">SIMPLE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> NO_WAIT  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">GO</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> storm </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">RECOVERY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">SIMPLE</span><span style="color:#24292E;">   </span><span style="color:#6A737D;">--简单模式  </span></span>
<span class="line"><span style="color:#D73A49;">GO</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> storm</span></span>
<span class="line"><span style="color:#D73A49;">GO</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">DBCC SHRINKFILE (</span><span style="color:#032F62;">N&#39;storm_log&#39;</span><span style="color:#24292E;"> , </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, TRUNCATEONLY)  </span><span style="color:#6A737D;">--设置压缩后的日志大小为2M，可以自行指定  </span></span>
<span class="line"><span style="color:#D73A49;">GO</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> storm  </span></span>
<span class="line"><span style="color:#D73A49;">GO</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> storm </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">RECOVERY</span><span style="color:#24292E;"> FULL </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> NO_WAIT  </span></span>
<span class="line"><span style="color:#D73A49;">GO</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> storm </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">RECOVERY</span><span style="color:#24292E;"> FULL  </span><span style="color:#6A737D;">--还原为完全模式  </span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79B8FF;">DBCC</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">SHRINKFILE</span><span style="color:#E1E4E8;"> (DBName_log, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">); </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">File name </span><span style="color:#79B8FF;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">FROM</span><span style="color:#E1E4E8;"> sys.database_files; query to get the file name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005CC5;">DBCC</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">SHRINKFILE</span><span style="color:#24292E;"> (DBName_log, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">); </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">File name </span><span style="color:#005CC5;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">FROM</span><span style="color:#24292E;"> sys.database_files; query to get the file name</span></span></code></pre></div><h2 id="_1-1查看数据库恢复类型" tabindex="-1">1.1查看数据库恢复类型 <a class="header-anchor" href="#_1-1查看数据库恢复类型" aria-label="Permalink to &quot;1.1查看数据库恢复类型&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NAME</span><span style="color:#E1E4E8;">, recovery_model_desc </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">databases</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NAME</span><span style="color:#24292E;">, recovery_model_desc </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">databases</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141012950.jpg" alt=""></p><h3 id="_1-1-1修改full类型" tabindex="-1">1.1.1修改FULL类型 <a class="header-anchor" href="#_1-1-1修改full类型" aria-label="Permalink to &quot;1.1.1修改FULL类型&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/*如果是FULL类型，修改为SIMPLE类型*/</span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> 数据库名字 </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">RECOVERY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SIMPLE</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/*如果是FULL类型，修改为SIMPLE类型*/</span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> 数据库名字 </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">RECOVERY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">SIMPLE</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><h3 id="_1-1-2修改simple类型" tabindex="-1">1.1.2修改SIMPLE类型 <a class="header-anchor" href="#_1-1-2修改simple类型" aria-label="Permalink to &quot;1.1.2修改SIMPLE类型&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/*恢复成FULL类型*/</span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> 数据库名字 </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">RECOVERY</span><span style="color:#E1E4E8;"> FULL</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/*恢复成FULL类型*/</span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> 数据库名字 </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">RECOVERY</span><span style="color:#24292E;"> FULL</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><h2 id="_1-2查看实例文件位置" tabindex="-1">1.2查看实例文件位置 <a class="header-anchor" href="#_1-2查看实例文件位置" aria-label="Permalink to &quot;1.2查看实例文件位置&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">, physical_name </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> current_file_location </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">master_files</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(database_id)  </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;data_name&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">, physical_name </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> current_file_location </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">master_files</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(database_id)  </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;data_name&#39;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141013262.jpg" alt=""></p><h3 id="_1-2-1查看文件大小" tabindex="-1">1.2.1查看文件大小 <a class="header-anchor" href="#_1-2-1查看文件大小" aria-label="Permalink to &quot;1.2.1查看文件大小&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(database_id) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> DatabaseName,</span></span>
<span class="line"><span style="color:#F97583;">Name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> Logical_Name,</span></span>
<span class="line"><span style="color:#E1E4E8;">Physical_Name, (</span><span style="color:#F97583;">size*</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;"> SizeMB</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">master_files</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(database_id)  </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;data_name&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(database_id) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> DatabaseName,</span></span>
<span class="line"><span style="color:#D73A49;">Name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> Logical_Name,</span></span>
<span class="line"><span style="color:#24292E;">Physical_Name, (</span><span style="color:#D73A49;">size*</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1024</span><span style="color:#24292E;"> SizeMB</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">master_files</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(database_id)  </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;data_name&#39;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141013985.jpg" alt=""></p><h3 id="_1-2-1查看所有数据库大小" tabindex="-1">1.2.1查看所有数据库大小 <a class="header-anchor" href="#_1-2-1查看所有数据库大小" aria-label="Permalink to &quot;1.2.1查看所有数据库大小&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">master_files</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">master_files</span></span></code></pre></div><h2 id="_1-3数据文件收缩和查看收缩进度" tabindex="-1">1.3数据文件收缩和查看收缩进度 <a class="header-anchor" href="#_1-3数据文件收缩和查看收缩进度" aria-label="Permalink to &quot;1.3数据文件收缩和查看收缩进度&quot;">​</a></h2><h3 id="_1-3-1查看日志文件大小" tabindex="-1">1.3.1查看日志文件大小 <a class="header-anchor" href="#_1-3-1查看日志文件大小" aria-label="Permalink to &quot;1.3.1查看日志文件大小&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 查看所有数据库日志文件大小</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(database_id) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Database Name],[Name] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Logical Name],[Physical_Name] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Physical Name],((</span><span style="color:#F97583;">size</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Size(MB)]</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">master_files</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [Size(MB)] </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 查看所有数据库日志文件大小</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(database_id) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Database Name],[Name] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Logical Name],[Physical_Name] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Physical Name],((</span><span style="color:#D73A49;">size</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Size(MB)]</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">master_files</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [Size(MB)] </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141013351.jpg" alt=""></p><ul><li>或者</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> hantest</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [File Name],</span></span>
<span class="line"><span style="color:#E1E4E8;">	physical_name </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Physical Name],</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">size/</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Total Size in MB],</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">size/</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">FILEPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;SaceUsed&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Available Space In MB],</span></span>
<span class="line"><span style="color:#E1E4E8;">	[growth], [file_id] </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_files</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">type_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;LOG&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> hantest</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [File Name],</span></span>
<span class="line"><span style="color:#24292E;">	physical_name </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Physical Name],</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">size/</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Total Size in MB],</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">size/</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">FILEPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">name</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;SaceUsed&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Available Space In MB],</span></span>
<span class="line"><span style="color:#24292E;">	[growth], [file_id] </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_files</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">type_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;LOG&#39;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141013362.jpg" alt=""></p><ul><li>或者</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_log_info</span><span style="color:#E1E4E8;"> ( </span><span style="color:#79B8FF;">db_id</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;DBName&#39;</span><span style="color:#E1E4E8;">) ) </span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC SQLPERF(LOGSPACE)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_log_info</span><span style="color:#24292E;"> ( </span><span style="color:#005CC5;">db_id</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;DBName&#39;</span><span style="color:#24292E;">) ) </span></span>
<span class="line"><span style="color:#24292E;">DBCC SQLPERF(LOGSPACE)</span></span></code></pre></div><h3 id="_1-3-2查看单独数据库文件大小" tabindex="-1">1.3.2查看单独数据库文件大小 <a class="header-anchor" href="#_1-3-2查看单独数据库文件大小" aria-label="Permalink to &quot;1.3.2查看单独数据库文件大小&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 查看数据库大小</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> data_name</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> 逻辑文件名, </span><span style="color:#F97583;">size/</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;"> [totalspace文件大小(兆)],</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">FILEPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;SpaceUsed&#39;</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;"> [usedspace已用空间(兆)],</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">size/</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">FILEPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;SpaceUsed&#39;</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;"> [未用空间(兆)],</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">FILEPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;SpaceUsed&#39;</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">/size</span><span style="color:#E1E4E8;"> [使用率(%)]</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_files</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">cross join</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> recovery_model_desc, log_reuse_wait,log_reuse_wait_desc,is_auto_shrink_on  </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">databases</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name=</span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">())b</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">type=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#6A737D;">--</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 查看数据库大小</span></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> data_name</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> 逻辑文件名, </span><span style="color:#D73A49;">size/</span><span style="color:#005CC5;">128</span><span style="color:#24292E;"> [totalspace文件大小(兆)],</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">FILEPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;SpaceUsed&#39;</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">128</span><span style="color:#24292E;"> [usedspace已用空间(兆)],</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">size/</span><span style="color:#005CC5;">128</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">FILEPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;SpaceUsed&#39;</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">128</span><span style="color:#24292E;"> [未用空间(兆)],</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">FILEPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;SpaceUsed&#39;</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">/size</span><span style="color:#24292E;"> [使用率(%)]</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_files</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">cross join</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> recovery_model_desc, log_reuse_wait,log_reuse_wait_desc,is_auto_shrink_on  </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">databases</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name=</span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">())b</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">type=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6A737D;">--</span></span></code></pre></div><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141013498.jpg" style=""><h3 id="_1-3-3查看日志文件状态" tabindex="-1">1.3.3查看日志文件状态 <a class="header-anchor" href="#_1-3-3查看日志文件状态" aria-label="Permalink to &quot;1.3.3查看日志文件状态&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> [name] ,[log_reuse_wait_desc] </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">master</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.databases </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> [name]</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;data_name&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> [name] ,[log_reuse_wait_desc] </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">master</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.databases </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> [name]</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;data_name&#39;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141013864.jpg" alt=""></p><p>==只有log_reuse_wait_desc是NOTHING状态才可回收==</p><blockquote><p>常见的日志等待类型是 LOG_BACKUP，日志还没有备份，所以不能截断</p><p>解决方案： ACTIVE_TRANSACTION，有活跃事务阻塞了日志截断</p><p>解决方案： 执行 DBCC OPENTRAN ，获取下长时间的活跃事务的SPID 然后执行 DBCC INPUTBUFFER(SPID) 查看下这个请求SQL，考虑是否可以kill阻塞源，kill后再查下log_reuse_wait，尝试shrink</p></blockquote><h3 id="_1-3-4收缩日志文件" tabindex="-1">1.3.4收缩日志文件 <a class="header-anchor" href="#_1-3-4收缩日志文件" aria-label="Permalink to &quot;1.3.4收缩日志文件&quot;">​</a></h3><ul><li>==仅简单模式下操纵==</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 完整步骤</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看日志状态</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> [name] ,[log_reuse_wait_desc] </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">master</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.databases </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> [name]</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;DBName&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">BACKUP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LOG</span><span style="color:#E1E4E8;"> DBName </span><span style="color:#F97583;">TO</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISK</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;D:\\database.bak&#39;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 更改类型</span></span>
<span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [master]</span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> [数据库名称] </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">RECOVERY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SIMPLE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> NO_WAIT</span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> DBName </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">RECOVERY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SIMPLE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DBName</span></span>
<span class="line"><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @log_File_Name </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> @log_File_Name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> sysfiles </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">filename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">like</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;%LDF&#39;</span></span>
<span class="line"><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @i </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">FILE_IDEX</span><span style="color:#E1E4E8;"> ( @log_File_Name)</span></span>
<span class="line"><span style="color:#E1E4E8;">dbcc shrinkfile ( @i , </span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;">)     </span><span style="color:#6A737D;">-- sql server默认文件单位为M，所以这里是30m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 重新恢复成FULL类型</span></span>
<span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [master]</span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> [数据库名称] </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">RECOVERY</span><span style="color:#E1E4E8;"> FULL </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> NO_WAIT</span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> [database] </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">RECOVERY</span><span style="color:#E1E4E8;"> FULL</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看收缩完之后文件大小</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(database_id) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> DatabaseName,</span></span>
<span class="line"><span style="color:#F97583;">Name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> Logical_Name,</span></span>
<span class="line"><span style="color:#E1E4E8;">Physical_Name, (</span><span style="color:#F97583;">size*</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;"> SizeMB</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">master_files</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(database_id)  </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;DBName&#39;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/* 有问题</span></span>
<span class="line"><span style="color:#6A737D;">    declare @usedspace int ,@totalspace int</span></span>
<span class="line"><span style="color:#6A737D;">     </span></span>
<span class="line"><span style="color:#6A737D;">    select @usedspace= xxx,@totalspace =yyy</span></span>
<span class="line"><span style="color:#6A737D;">     </span></span>
<span class="line"><span style="color:#6A737D;">    while @totalspace&gt; @usedspace</span></span>
<span class="line"><span style="color:#6A737D;">     </span></span>
<span class="line"><span style="color:#6A737D;">    begin</span></span>
<span class="line"><span style="color:#6A737D;">     </span></span>
<span class="line"><span style="color:#6A737D;">    set @totalspace= @totalspace-5 *1024</span></span>
<span class="line"><span style="color:#6A737D;">     </span></span>
<span class="line"><span style="color:#6A737D;">    DBCC SHRINKFILE( 逻辑文件名,@totalspace )</span></span>
<span class="line"><span style="color:#6A737D;">     </span></span>
<span class="line"><span style="color:#6A737D;">    end</span></span>
<span class="line"><span style="color:#6A737D;"> 通过1.3.2获取</span></span>
<span class="line"><span style="color:#6A737D;"> </span></span>
<span class="line"><span style="color:#6A737D;">*/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 完整步骤</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看日志状态</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> [name] ,[log_reuse_wait_desc] </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">master</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.databases </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> [name]</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;DBName&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">BACKUP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LOG</span><span style="color:#24292E;"> DBName </span><span style="color:#D73A49;">TO</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISK</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;D:\\database.bak&#39;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 更改类型</span></span>
<span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [master]</span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> [数据库名称] </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">RECOVERY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">SIMPLE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> NO_WAIT</span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> DBName </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">RECOVERY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">SIMPLE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DBName</span></span>
<span class="line"><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @log_File_Name </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> @log_File_Name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> sysfiles </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">filename</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">like</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;%LDF&#39;</span></span>
<span class="line"><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @i </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">FILE_IDEX</span><span style="color:#24292E;"> ( @log_File_Name)</span></span>
<span class="line"><span style="color:#24292E;">dbcc shrinkfile ( @i , </span><span style="color:#005CC5;">30</span><span style="color:#24292E;">)     </span><span style="color:#6A737D;">-- sql server默认文件单位为M，所以这里是30m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 重新恢复成FULL类型</span></span>
<span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [master]</span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> [数据库名称] </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">RECOVERY</span><span style="color:#24292E;"> FULL </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> NO_WAIT</span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> [database] </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">RECOVERY</span><span style="color:#24292E;"> FULL</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看收缩完之后文件大小</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(database_id) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> DatabaseName,</span></span>
<span class="line"><span style="color:#D73A49;">Name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> Logical_Name,</span></span>
<span class="line"><span style="color:#24292E;">Physical_Name, (</span><span style="color:#D73A49;">size*</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1024</span><span style="color:#24292E;"> SizeMB</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">master_files</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(database_id)  </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;DBName&#39;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/* 有问题</span></span>
<span class="line"><span style="color:#6A737D;">    declare @usedspace int ,@totalspace int</span></span>
<span class="line"><span style="color:#6A737D;">     </span></span>
<span class="line"><span style="color:#6A737D;">    select @usedspace= xxx,@totalspace =yyy</span></span>
<span class="line"><span style="color:#6A737D;">     </span></span>
<span class="line"><span style="color:#6A737D;">    while @totalspace&gt; @usedspace</span></span>
<span class="line"><span style="color:#6A737D;">     </span></span>
<span class="line"><span style="color:#6A737D;">    begin</span></span>
<span class="line"><span style="color:#6A737D;">     </span></span>
<span class="line"><span style="color:#6A737D;">    set @totalspace= @totalspace-5 *1024</span></span>
<span class="line"><span style="color:#6A737D;">     </span></span>
<span class="line"><span style="color:#6A737D;">    DBCC SHRINKFILE( 逻辑文件名,@totalspace )</span></span>
<span class="line"><span style="color:#6A737D;">     </span></span>
<span class="line"><span style="color:#6A737D;">    end</span></span>
<span class="line"><span style="color:#6A737D;"> 通过1.3.2获取</span></span>
<span class="line"><span style="color:#6A737D;"> </span></span>
<span class="line"><span style="color:#6A737D;">*/</span></span></code></pre></div><ul><li>收缩前50M</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141013291.jpg" alt=""></p><ul><li>收缩后大小10M</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141013596.jpg" alt=""></p><h3 id="_1-3-5查询当前数据库备份进度" tabindex="-1">1.3.5查询当前数据库备份进度 <a class="header-anchor" href="#_1-3-5查询当前数据库备份进度" aria-label="Permalink to &quot;1.3.5查询当前数据库备份进度&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--查询当前数据库备份进度</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(er.[database_id]) [DatabaseName],er.[command] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [CommandType],er.[percent_complete]</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">start_time</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DECIMAL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) , er.[percent_complete]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Complete_Percent]</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DECIMAL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">38</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">), er.[total_elapsed_time] </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [ElapsedTime_m]  </span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DECIMAL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">38</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">), er.[estimated_completion_time] </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [EstimatedCompletionTime_m]  </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> er  </span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> er.[command] </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> ( </span><span style="color:#9ECBFF;">&#39;RESTORE DATABASE&#39;</span><span style="color:#E1E4E8;"> ,</span><span style="color:#9ECBFF;">&#39;BACKUP DATABASE&#39;</span><span style="color:#E1E4E8;">)  </span><span style="color:#6A737D;">--DB_NAME(er.[database_id]) in (&#39;ky2011&#39;) and</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--查询当前数据库备份进度</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(er.[database_id]) [DatabaseName],er.[command] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [CommandType],er.[percent_complete]</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">start_time</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DECIMAL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">5</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) , er.[percent_complete]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Complete_Percent]</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DECIMAL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">38</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">), er.[total_elapsed_time] </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [ElapsedTime_m]  </span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DECIMAL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">38</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">), er.[estimated_completion_time] </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [EstimatedCompletionTime_m]  </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> er  </span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> er.[command] </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> ( </span><span style="color:#032F62;">&#39;RESTORE DATABASE&#39;</span><span style="color:#24292E;"> ,</span><span style="color:#032F62;">&#39;BACKUP DATABASE&#39;</span><span style="color:#24292E;">)  </span><span style="color:#6A737D;">--DB_NAME(er.[database_id]) in (&#39;ky2011&#39;) and</span></span></code></pre></div><h3 id="_1-3-6查看数据库收缩进度" tabindex="-1">1.3.6查看数据库收缩进度 <a class="header-anchor" href="#_1-3-6查看数据库收缩进度" aria-label="Permalink to &quot;1.3.6查看数据库收缩进度&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DBName</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(er.[database_id]) [DatabaseName],er.[command] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [CommandType],er.[percent_complete]</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">start_time</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DECIMAL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) , er.[percent_complete]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Complete_Percent]</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DECIMAL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">38</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">), er.[total_elapsed_time] </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [ElapsedTime_m]  </span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DECIMAL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">38</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">), er.[estimated_completion_time] </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [EstimatedCompletionTime_m] </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> er </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> command </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;DbccFilesCompact&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;AUTOSHRINK&#39;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DBName</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(er.[database_id]) [DatabaseName],er.[command] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [CommandType],er.[percent_complete]</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">start_time</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DECIMAL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">5</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) , er.[percent_complete]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Complete_Percent]</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DECIMAL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">38</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">), er.[total_elapsed_time] </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [ElapsedTime_m]  </span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DECIMAL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">38</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">), er.[estimated_completion_time] </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [EstimatedCompletionTime_m] </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> er </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> command </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;DbccFilesCompact&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;AUTOSHRINK&#39;</span><span style="color:#24292E;">)</span></span></code></pre></div><h2 id="_1-4收缩日志文件的影响" tabindex="-1">1.4收缩日志文件的影响 <a class="header-anchor" href="#_1-4收缩日志文件的影响" aria-label="Permalink to &quot;1.4收缩日志文件的影响&quot;">​</a></h2><p>日志文件收缩， 回收磁盘空间。</p><p>数据文件 根据设计 设计的大小，一般情况不用收缩，收缩可能带来性能的问题。</p><p>日志</p><p>如果 选择的日志恢复模型是完全，如果没有日志截断，日志增长的很大，</p><p>建议</p><p>备份日志。</p><p>backup log db to disk=&#39;备份设备&#39;</p><p>截断日志</p><p>backup log db with no_log</p><p>然后收缩。</p><p>dbcc shrinkfile(2,10)</p><h2 id="_1-5收缩数据文件的影响" tabindex="-1">1.5收缩数据文件的影响 <a class="header-anchor" href="#_1-5收缩数据文件的影响" aria-label="Permalink to &quot;1.5收缩数据文件的影响&quot;">​</a></h2><p>数据库使用数据文件（扩展名是mdf 或 ndf)来存储数据，使用日志文件（扩展名是ldf）来存储事务日志，通常情况下，数据文件会持续增长，不会自动释放空闲空间，这样会导致硬盘空间耗尽。</p><p>如果一个数据库的文件有很多空闲空间，收缩数据库文件是一种解决硬盘空间紧张的直接方式。</p><p><strong>原理与影响：</strong></p><p><strong>在SQL Server中，我们可以使用 DBCC ShrinkFile命令收缩数据文件，该命令首先将文件尾部的区（extent）移动到文件的开头，文件结尾的空闲的硬盘空间被释放给操作系统。</strong></p><p><strong>这种操作就像截断将文件的尾部一样，这种方式不需要消耗很多IO就能释放空间；</strong></p><p><strong>但是，如果空闲部分不在文件末尾时，收缩操作必须扫描数据文件，并对正在读取的页面加锁，把文件末尾的区移动到文件开头，这是一个IO密集型的操作，影响数据库的性能；</strong></p><p><strong>1、收缩操作不是一个独占行为，在做文件收缩时，其他用户仍然可以对数据库进行读写操作。</strong></p><p><strong>2、收缩会锁表，会阻塞</strong></p><p><strong>3、在任意一个时间点停止dbcc shrinkfile命令，任何已经完成的工作都将保留。</strong></p><p><strong>建议：</strong></p><p>收缩 数据库 是非常耗费server性能的操作，如果没有必要不要收缩</p><p>收缩 无非就是把已经分配给数据库文件空间收回来，但是，收缩的时候 要移动数据页，而且可能造成大量的碎片，影响性能。</p><p>日志收缩和数据文件收缩不一样，日志中的虚拟文件状态 只有 在可复用 时候 才能收缩。</p><p>而且 凡是有活动的日志的日志虚拟文件都是活动的不能收缩</p><h2 id="_1-6always-on-日志清理" tabindex="-1">1.6always on 日志清理 <a class="header-anchor" href="#_1-6always-on-日志清理" aria-label="Permalink to &quot;1.6always on 日志清理&quot;">​</a></h2><p>SQL Server的日志只要备份后就会自动释放原有占用的空间，例如每周产生的日志为10GB，每周做一次备份，在磁盘上的日志永远都会保持在10GB左右。</p><p>因此有效的收缩办法为，针对SQL Server做事务日志的定期备份，此操作直接在SQL Server管理工具中制定维护备份计划即可。</p><p>在一般部署中，我们制定两个备份计划，一个完整备份、一个事务日志备份，并将备份按照安全要求保留一个月或更长时间，自动删除旧的备份</p><h3 id="_1-6-0-alwayson状态下" tabindex="-1">1.6.0 alwaysOn状态下 <a class="header-anchor" href="#_1-6-0-alwayson状态下" aria-label="Permalink to &quot;1.6.0 alwaysOn状态下&quot;">​</a></h3><p>为了做数据库读写分离，做了故障转移群集，以及通过Alwayson做数据库同步，但也造成了数据库日志文件不断增加，通过以前的方法处理也会出错</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141013951.jpg" alt=""></p><blockquote><p>通过截断日志可以解决此问题</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [StarDB]</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @bakfile </span><span style="color:#F97583;">nvarchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @bakfile</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;E:\\DbLogs\\log_bak_&#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">nvarchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">(),</span><span style="color:#79B8FF;">112</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;.log&#39;</span></span>
<span class="line"><span style="color:#F97583;">BACKUP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LOG</span><span style="color:#E1E4E8;"> [StarDB]  </span><span style="color:#F97583;">TO</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISK=</span><span style="color:#E1E4E8;"> @bakfile </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">RETAINDAYS=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">COMPRESSION</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC SHRINKFILE (</span><span style="color:#9ECBFF;">N&#39;StarDB_log&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--第一次执行之后，日志大小还是不变，多执行几次就可以了</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [StarDB]</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @bakfile </span><span style="color:#D73A49;">nvarchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @bakfile</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;E:\\DbLogs\\log_bak_&#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">nvarchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">(),</span><span style="color:#005CC5;">112</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;.log&#39;</span></span>
<span class="line"><span style="color:#D73A49;">BACKUP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LOG</span><span style="color:#24292E;"> [StarDB]  </span><span style="color:#D73A49;">TO</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISK=</span><span style="color:#24292E;"> @bakfile </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">RETAINDAYS=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">COMPRESSION</span></span>
<span class="line"><span style="color:#24292E;">DBCC SHRINKFILE (</span><span style="color:#032F62;">N&#39;StarDB_log&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--第一次执行之后，日志大小还是不变，多执行几次就可以了</span></span></code></pre></div></blockquote><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 若执行一次没有达到预期的收缩效果，可以多执行几次 </span></span>
<span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [master]; </span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#F97583;">BACKUP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LOG</span><span style="color:#E1E4E8;"> [TestDB] </span><span style="color:#F97583;">TO</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISK=</span><span style="color:#9ECBFF;">&#39;NUL:&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- 备份事务日志，备份成NUL，就不用占硬盘 空间，完全模式下，有过完全备份下执行</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [TestDB]; </span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC SHRINKFILE (</span><span style="color:#9ECBFF;">N&#39;TestDB_log&#39;</span><span style="color:#E1E4E8;"> , </span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">, TRUNCATEONLY) </span><span style="color:#6A737D;">--收缩数据库日志文件，收 到10M; </span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 若执行一次没有达到预期的收缩效果，可以多执行几次 </span></span>
<span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [master]; </span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#D73A49;">BACKUP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LOG</span><span style="color:#24292E;"> [TestDB] </span><span style="color:#D73A49;">TO</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISK=</span><span style="color:#032F62;">&#39;NUL:&#39;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- 备份事务日志，备份成NUL，就不用占硬盘 空间，完全模式下，有过完全备份下执行</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [TestDB]; </span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#24292E;">DBCC SHRINKFILE (</span><span style="color:#032F62;">N&#39;TestDB_log&#39;</span><span style="color:#24292E;"> , </span><span style="color:#005CC5;">12</span><span style="color:#24292E;">, TRUNCATEONLY) </span><span style="color:#6A737D;">--收缩数据库日志文件，收 到10M; </span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><h3 id="_1-6-1查看日志状态" tabindex="-1">1.6.1查看日志状态 <a class="header-anchor" href="#_1-6-1查看日志状态" aria-label="Permalink to &quot;1.6.1查看日志状态&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> hantest</span></span>
<span class="line"><span style="color:#E1E4E8;">dbcc loginfo</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> hantest</span></span>
<span class="line"><span style="color:#24292E;">dbcc loginfo</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141013803.png" alt=""></p><p>==只有状态为0才开收缩==</p><ul><li>或者查看</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">, recovery_model_desc, log_reuse_wait,log_reuse_wait_desc</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">databases</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name=</span><span style="color:#9ECBFF;">&#39;DBName&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">, recovery_model_desc, log_reuse_wait,log_reuse_wait_desc</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">databases</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name=</span><span style="color:#032F62;">&#39;DBName&#39;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141013801.jpg" alt=""></p><p>==检查数据库日志状态，处于NOTHING状态 的的才能截断日志==</p><h2 id="_1-7事务日志无法收缩" tabindex="-1">1.7事务日志无法收缩 <a class="header-anchor" href="#_1-7事务日志无法收缩" aria-label="Permalink to &quot;1.7事务日志无法收缩&quot;">​</a></h2><p>由于事务未提交而导致日志无法收缩</p><h3 id="_1-查看进程" tabindex="-1">1.查看进程 <a class="header-anchor" href="#_1-查看进程" aria-label="Permalink to &quot;1.查看进程&quot;">​</a></h3><p>使用 exec sp_who2 查看进程</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> sp_who2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> sp_who2</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141013257.png" alt=""></p><h3 id="_2-查看日志状态" tabindex="-1">2.查看日志状态 <a class="header-anchor" href="#_2-查看日志状态" aria-label="Permalink to &quot;2.查看日志状态&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> hantest</span></span>
<span class="line"><span style="color:#E1E4E8;">dbcc loginfo</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> hantest</span></span>
<span class="line"><span style="color:#24292E;">dbcc loginfo</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141013438.jpg" alt=""></p><h3 id="_3-查看是否有未提交的事务" tabindex="-1">3.查看是否有未提交的事务 <a class="header-anchor" href="#_3-查看是否有未提交的事务" aria-label="Permalink to &quot;3.查看是否有未提交的事务&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">&#39;kill &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">  ,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;">,connect_time,host_name,c.[text]program_name,host_process_id,client_version </span></span>
<span class="line"><span style="color:#E1E4E8;">  ,client_interface_name,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">login_name</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">status</span><span style="color:#E1E4E8;">,cpu_time,total_elapsed_time,total_scheduled_time </span></span>
<span class="line"><span style="color:#E1E4E8;">  ,last_request_start_time,reads,writes,logical_reads,original_login_name,client_net_address,client_tcp_port,most_recent_sql_handle </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sessions</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">inner join</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SYS</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DM_EXEC_CONNECTIONS</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SYS</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DM_EXEC_SQL_TEXT</span><span style="color:#E1E4E8;">(most_recent_sql_handle) c </span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> @@SPID </span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> connect_time</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#032F62;">&#39;kill &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">  ,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;">,connect_time,host_name,c.[text]program_name,host_process_id,client_version </span></span>
<span class="line"><span style="color:#24292E;">  ,client_interface_name,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">login_name</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">status</span><span style="color:#24292E;">,cpu_time,total_elapsed_time,total_scheduled_time </span></span>
<span class="line"><span style="color:#24292E;">  ,last_request_start_time,reads,writes,logical_reads,original_login_name,client_net_address,client_tcp_port,most_recent_sql_handle </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sessions</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">inner join</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SYS</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DM_EXEC_CONNECTIONS</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SYS</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DM_EXEC_SQL_TEXT</span><span style="color:#24292E;">(most_recent_sql_handle) c </span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> @@SPID </span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> connect_time</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141013020.jpg" alt=""></p><h3 id="_4-kill" tabindex="-1">4.kill <a class="header-anchor" href="#_4-kill" aria-label="Permalink to &quot;4.kill&quot;">​</a></h3><p>杀掉一直未提交的最早的几个事务</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">KILL</span><span style="color:#E1E4E8;"> xxx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">KILL</span><span style="color:#24292E;"> xxx</span></span></code></pre></div><h1 id="_2-事务日志" tabindex="-1">2.事务日志 <a class="header-anchor" href="#_2-事务日志" aria-label="Permalink to &quot;2.事务日志&quot;">​</a></h1><p><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002?view=sql-server-2017</a></p><p><a href="https://docs.microsoft.com/zh-cn/sql/t-sql/database-console-commands/dbcc-shrinkfile-transact-sql?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/t-sql/database-console-commands/dbcc-shrinkfile-transact-sql?view=sql-server-2017</a></p><h1 id="_3-日志原理" tabindex="-1">3.日志原理 <a class="header-anchor" href="#_3-日志原理" aria-label="Permalink to &quot;3.日志原理&quot;">​</a></h1><p><a href="https://www.cnblogs.com/gallen-n/p/6555283.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/gallen-n/p/6555283.html</a></p>`,131),e=[o];function t(c,r,E,y,i,d){return a(),n("div",null,e)}const C=s(p,[["render",t]]);export{A as __pageData,C as default};
