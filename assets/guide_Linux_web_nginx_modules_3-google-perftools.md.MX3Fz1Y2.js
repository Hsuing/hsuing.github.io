import{_ as e,D as n,o as a,c as l,I as o,w as p,R as t,a as i}from"./chunks/framework.zUbWieqp.js";const c="/assets/googleinstall.S1MRSM63.jpg",r="/assets/txt.rohTxYCk.jpg",v=JSON.parse('{"title":"一、源码安装","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Linux/web/nginx/modules/3-google-perftools.md","filePath":"guide/Linux/web/nginx/modules/3-google-perftools.md","lastUpdated":1701928035000}'),g={name:"guide/Linux/web/nginx/modules/3-google-perftools.md"},d=t('<p>环境 Centos 7.4</p><p>官网文档</p><p><a href="http://nginx.org/en/docs/ngx_google_perftools_module.html" target="_blank" rel="noreferrer">http://nginx.org/en/docs/ngx_google_perftools_module.html</a></p><p><img src="'+c+'" alt="jiegou"></p><ul><li>文本输出结果</li></ul><p><img src="'+r+`" alt="jiegou"></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">&gt;pprof --text /path/sbin/nginx /tmp/tmalloc/tmalloc.pid(num)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">&gt;pprof --text /path/sbin/nginx /tmp/tmalloc/tmalloc.pid(num)</span></span></code></pre></div><h1 id="一、源码安装" tabindex="-1">一、源码安装 <a class="header-anchor" href="#一、源码安装" aria-label="Permalink to &quot;一、源码安装&quot;">​</a></h1><h2 id="_1、下载并安装google-perftools" tabindex="-1">1、下载并安装google-perftools <a class="header-anchor" href="#_1、下载并安装google-perftools" aria-label="Permalink to &quot;1、下载并安装google-perftools&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">wget https://github.com/gperftools/gperftools/releases/download/gperftools-2.7/gperftools-2.7.tar.gz</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># 注意：</span></span>
<span class="line"><span style="color:#e1e4e8;"># 1、如果是32位系统，在configure gperftools的时候，可以不添加--enable-frame-pointers参数。</span></span>
<span class="line"><span style="color:#e1e4e8;"># 2、如果是64位系统，需要先安装libunwind，再在configure gperftools的时候，添加--enable-frame-pointers参数</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">wget https://github.com/gperftools/gperftools/releases/download/gperftools-2.7/gperftools-2.7.tar.gz</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># 注意：</span></span>
<span class="line"><span style="color:#24292e;"># 1、如果是32位系统，在configure gperftools的时候，可以不添加--enable-frame-pointers参数。</span></span>
<span class="line"><span style="color:#24292e;"># 2、如果是64位系统，需要先安装libunwind，再在configure gperftools的时候，添加--enable-frame-pointers参数</span></span></code></pre></div><h2 id="_2、安装libunwind" tabindex="-1">2、安装libunwind <a class="header-anchor" href="#_2、安装libunwind" aria-label="Permalink to &quot;2、安装libunwind&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">yum install epel-release -y</span></span>
<span class="line"><span style="color:#e1e4e8;">yum install libunwind-devel libunwind -y</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">yum install epel-release -y</span></span>
<span class="line"><span style="color:#24292e;">yum install libunwind-devel libunwind -y</span></span></code></pre></div><h2 id="_3、安装google-perftools" tabindex="-1">3、安装google-perftools <a class="header-anchor" href="#_3、安装google-perftools" aria-label="Permalink to &quot;3、安装google-perftools&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">./configure --enable-frame-pointers --enable-libunwind --with-tcmalloc-pagesize=32</span></span>
<span class="line"><span style="color:#e1e4e8;">make &amp;&amp; make install</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">./configure --enable-frame-pointers --enable-libunwind --with-tcmalloc-pagesize=32</span></span>
<span class="line"><span style="color:#24292e;">make &amp;&amp; make install</span></span></code></pre></div><h2 id="_4、nginx支持google-perftools" tabindex="-1">4、nginx支持google-perftools <a class="header-anchor" href="#_4、nginx支持google-perftools" aria-label="Permalink to &quot;4、nginx支持google-perftools&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">./configure --with-google_perftools_module</span></span>
<span class="line"><span style="color:#e1e4e8;">make &amp;&amp; make install</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># 添加线程目录</span></span>
<span class="line"><span style="color:#e1e4e8;">&gt; mkdir /tmp/tcmalloc</span></span>
<span class="line"><span style="color:#e1e4e8;">&gt; chmod 0777 /tmp/tcmalloc</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># 修改nginx.conf，在pid行下面添加如下信息</span></span>
<span class="line"><span style="color:#e1e4e8;">google_perftools_profiles /tmp/tcmalloc;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># 重启nginx</span></span>
<span class="line"><span style="color:#e1e4e8;">&gt; /opt/openresty/nginx/sbin/nginx -s reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">./configure --with-google_perftools_module</span></span>
<span class="line"><span style="color:#24292e;">make &amp;&amp; make install</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># 添加线程目录</span></span>
<span class="line"><span style="color:#24292e;">&gt; mkdir /tmp/tcmalloc</span></span>
<span class="line"><span style="color:#24292e;">&gt; chmod 0777 /tmp/tcmalloc</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># 修改nginx.conf，在pid行下面添加如下信息</span></span>
<span class="line"><span style="color:#24292e;">google_perftools_profiles /tmp/tcmalloc;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># 重启nginx</span></span>
<span class="line"><span style="color:#24292e;">&gt; /opt/openresty/nginx/sbin/nginx -s reload</span></span></code></pre></div><h2 id="_5、生成pref文件" tabindex="-1">5、生成pref文件 <a class="header-anchor" href="#_5、生成pref文件" aria-label="Permalink to &quot;5、生成pref文件&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">&gt;wrk -t6 -c30000 -d30s http://127.0.0.1:4000</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">&gt;pprof --svg /usr/local/openresty/nginx/sbin/nginx gperf.61642 &gt; nginx.svg</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">&gt;wrk -t6 -c30000 -d30s http://127.0.0.1:4000</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">&gt;pprof --svg /usr/local/openresty/nginx/sbin/nginx gperf.61642 &gt; nginx.svg</span></span></code></pre></div><h1 id="二、yum安装" tabindex="-1">二、yum安装 <a class="header-anchor" href="#二、yum安装" aria-label="Permalink to &quot;二、yum安装&quot;">​</a></h1><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">&gt;yum  install gperftools.x86_64 gperftools-libs.x86_64 gperftools-devel.x86_64 libunwind -y</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"> openresty,nginx，tengine都可</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">&gt;yum  install gperftools.x86_64 gperftools-libs.x86_64 gperftools-devel.x86_64 libunwind -y</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"> openresty,nginx，tengine都可</span></span></code></pre></div>`,20);function u(h,m,y,f,b,_){const s=n("center");return a(),l("div",null,[o(s,null,{default:p(()=>[i("使用google-perftools优化nginx提升性能")]),_:1}),d])}const k=e(g,[["render",u]]);export{v as __pageData,k as default};
