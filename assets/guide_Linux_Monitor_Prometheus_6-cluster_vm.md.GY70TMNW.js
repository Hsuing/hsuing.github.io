import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const h=JSON.parse('{"title":"1. prometheus远端存储VictoriaMetrics","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Linux/Monitor/Prometheus/6-cluster_vm.md","filePath":"guide/Linux/Monitor/Prometheus/6-cluster_vm.md","lastUpdated":1739960402000}'),p={name:"guide/Linux/Monitor/Prometheus/6-cluster_vm.md"},o=l(`<p>Github地址：<a href="https://github.com/VictoriaMetrics/VictoriaMetrics" target="_blank" rel="noreferrer">https://github.com/VictoriaMetrics/VictoriaMetrics</a></p><p>官网地址：<a href="https://docs.victoriametrics.com/Single-server-VictoriaMetrics.html" target="_blank" rel="noreferrer">https://docs.victoriametrics.com/Single-server-VictoriaMetrics.html</a></p><h1 id="_1-prometheus远端存储victoriametrics" tabindex="-1">1. prometheus远端存储VictoriaMetrics <a class="header-anchor" href="#_1-prometheus远端存储victoriametrics" aria-label="Permalink to &quot;1. prometheus远端存储VictoriaMetrics&quot;">​</a></h1><h2 id="_1-1-组件介绍" tabindex="-1">1.1 组件介绍 <a class="header-anchor" href="#_1-1-组件介绍" aria-label="Permalink to &quot;1.1 组件介绍&quot;">​</a></h2><table><thead><tr><th>组件名字</th><th>描述</th></tr></thead><tbody><tr><td><strong>vminsert</strong></td><td>写入组件，vminsert负责接收数据写入并根据对度量名称及其所有标签的一致hash结果将数据分散写入不同的后端vmstorage节点之间，vminsert默认端口8480</td></tr><tr><td><strong>vmstorage</strong></td><td>存储原始数据并返回给定时间范围内给定标签过滤器的查询数据，默认端口8482</td></tr><tr><td><strong>vmselect</strong></td><td><strong>查询组件，连接vmstorage，默认端口8481</strong></td></tr><tr><td>vmagent-可选</td><td>一个很小但功能很强大的代理，它可以从node_exporter各种来源收集度量数据，并将它们存储在VictoriaMetrics或任何其他支持远程写协议的与prometheus兼容的存储系统中，有点prometheus server的意向</td></tr><tr><td>vmalert-可选</td><td>替换prometheus server，以VictoriaMetrics为数据源，基于兼容prometheus的告警规则，判断数据是否异常，并将产生的通知发送给alertmanager</td></tr><tr><td>vmgateway-可选</td><td>读写VictoriaMetrics数据的代理网关，可实现限速和访问控制等功能，目前为企业版组件</td></tr><tr><td>vmctl-可选</td><td>VictoriaMetrics的命令行工具，目前主要用于将prometheus、opentsdb等数据源的数据迁移到VictoriaMetrics</td></tr></tbody></table><h1 id="_2-部署victoriametrics集群" tabindex="-1">2.部署VictoriaMetrics集群 <a class="header-anchor" href="#_2-部署victoriametrics集群" aria-label="Permalink to &quot;2.部署VictoriaMetrics集群&quot;">​</a></h1><h2 id="_2-1-环境介绍" tabindex="-1">2.1 环境介绍 <a class="header-anchor" href="#_2-1-环境介绍" aria-label="Permalink to &quot;2.1 环境介绍&quot;">​</a></h2><table><thead><tr><th>软件</th><th>描述</th></tr></thead><tbody><tr><td>prometheus</td><td>10.103.236.199,prometheus-server</td></tr><tr><td>vm1</td><td>10.103.236.20,<strong>vminsert、vmstorage、vmselect</strong></td></tr><tr><td>vm2</td><td>10.103.236.21,<strong>vminsert、vmstorage、vmselect</strong></td></tr><tr><td>vm3</td><td>10.103.236.22,<strong>vminsert、vmstorage、vmselect</strong></td></tr><tr><td>node1</td><td>10.103.236.203,node_export</td></tr></tbody></table><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202502181458023.png" alt="无标题-2024-05-29-0943.excalidraw"></p><h2 id="_2-2-下载" tabindex="-1">2.2 下载 <a class="header-anchor" href="#_2-2-下载" aria-label="Permalink to &quot;2.2 下载&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v1.111.0/victoria-metrics-linux-amd64-v1.111.0-cluster.tar.gz</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v1.111.0/vmutils-linux-amd64-v1.111.0.tar.gz</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v1.111.0/victoria-metrics-linux-amd64-v1.111.0.tar.gz</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v1.111.0/victoria-metrics-linux-amd64-v1.111.0-cluster.tar.gz</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v1.111.0/vmutils-linux-amd64-v1.111.0.tar.gz</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v1.111.0/victoria-metrics-linux-amd64-v1.111.0.tar.gz</span></span></code></pre></div><h2 id="_2-3-部署" tabindex="-1">2.3 部署 <a class="header-anchor" href="#_2-3-部署" aria-label="Permalink to &quot;2.3 部署&quot;">​</a></h2><p>采用二进制部署</p><h3 id="部署vmstorage-prod组件" tabindex="-1">部署vmstorage-prod组件 <a class="header-anchor" href="#部署vmstorage-prod组件" aria-label="Permalink to &quot;部署vmstorage-prod组件&quot;">​</a></h3><ul><li>解压(<code>所有节点执行</code>)</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">tar</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">zxvf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">victoria-metrics-linux-amd64-v1.111.0-cluster.tar.gz</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-C</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/local/bin</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">tar</span><span style="color:#24292E;"> </span><span style="color:#032F62;">zxvf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">victoria-metrics-linux-amd64-v1.111.0-cluster.tar.gz</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-C</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/local/bin</span></span></code></pre></div><ul><li>创建数据目录和配置目录(<code>所有节点执行</code>)</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/VictoriaMetrics</span></span>
<span class="line"><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/VictoriaMetrics</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/VictoriaMetrics</span></span>
<span class="line"><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/VictoriaMetrics</span></span></code></pre></div><ul><li>配置systemd</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/systemd/system/vmstorage.service</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#9ECBFF;">[Unit]</span></span>
<span class="line"><span style="color:#9ECBFF;">Description=Vmstorage Server</span></span>
<span class="line"><span style="color:#9ECBFF;">After=network.target</span></span>
<span class="line"><span style="color:#9ECBFF;"> </span></span>
<span class="line"><span style="color:#9ECBFF;">[Service]</span></span>
<span class="line"><span style="color:#9ECBFF;">Restart=on-failure</span></span>
<span class="line"><span style="color:#9ECBFF;">WorkingDirectory=/tmp</span></span>
<span class="line"><span style="color:#9ECBFF;">ExecStart=/usr/local/bin/vmstorage-prod -retentionPeriod=15d -loggerTimezone Asia/Shanghai -dedup.minScrapeInterval=30s -loggerLevel INFO -storageDataPath /data/VictoriaMetrics -httpListenAddr :8482 -vminsertAddr :8400 -vmselectAddr :8401</span></span>
<span class="line"><span style="color:#9ECBFF;">Restart=always</span></span>
<span class="line"><span style="color:#9ECBFF;">[Install]</span></span>
<span class="line"><span style="color:#9ECBFF;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/systemd/system/vmstorage.service</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#032F62;">[Unit]</span></span>
<span class="line"><span style="color:#032F62;">Description=Vmstorage Server</span></span>
<span class="line"><span style="color:#032F62;">After=network.target</span></span>
<span class="line"><span style="color:#032F62;"> </span></span>
<span class="line"><span style="color:#032F62;">[Service]</span></span>
<span class="line"><span style="color:#032F62;">Restart=on-failure</span></span>
<span class="line"><span style="color:#032F62;">WorkingDirectory=/tmp</span></span>
<span class="line"><span style="color:#032F62;">ExecStart=/usr/local/bin/vmstorage-prod -retentionPeriod=15d -loggerTimezone Asia/Shanghai -dedup.minScrapeInterval=30s -loggerLevel INFO -storageDataPath /data/VictoriaMetrics -httpListenAddr :8482 -vminsertAddr :8400 -vmselectAddr :8401</span></span>
<span class="line"><span style="color:#032F62;">Restart=always</span></span>
<span class="line"><span style="color:#032F62;">[Install]</span></span>
<span class="line"><span style="color:#032F62;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span></code></pre></div><ul><li>启动</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemon-reload</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">vmstorage.service</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemon-reload</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">vmstorage.service</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Rocky </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# ss -ntlp</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-E</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;8482|8400|8401&quot;</span></span>
<span class="line"><span style="color:#B392F0;">LISTEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">2048</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0.0</span><span style="color:#9ECBFF;">.0.0:8400</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">0.0</span><span style="color:#9ECBFF;">.0.0:</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">users:</span><span style="color:#E1E4E8;">((&quot;vmstorage</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">prod&quot;</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;">pid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">4045</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;">fd</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#B392F0;">LISTEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">2048</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0.0</span><span style="color:#9ECBFF;">.0.0:8401</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">0.0</span><span style="color:#9ECBFF;">.0.0:</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">users:</span><span style="color:#E1E4E8;">((&quot;vmstorage</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">prod&quot;</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;">pid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">4045</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;">fd</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#B392F0;">LISTEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">2048</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">0.0</span><span style="color:#9ECBFF;">.0.0:8482</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">0.0</span><span style="color:#9ECBFF;">.0.0:</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">users:</span><span style="color:#E1E4E8;">((&quot;vmstorage</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">prod&quot;</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;">pid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">4045</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;">fd</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">))</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Rocky </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# ss -ntlp</span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-E</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;8482|8400|8401&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">LISTEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">2048</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0.0</span><span style="color:#032F62;">.0.0:8400</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">0.0</span><span style="color:#032F62;">.0.0:</span><span style="color:#005CC5;">*</span><span style="color:#24292E;">    </span><span style="color:#032F62;">users:</span><span style="color:#24292E;">((&quot;vmstorage</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">prod&quot;</span><span style="color:#D73A49;">,</span><span style="color:#24292E;">pid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">4045</span><span style="color:#D73A49;">,</span><span style="color:#24292E;">fd</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">6</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#6F42C1;">LISTEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">2048</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0.0</span><span style="color:#032F62;">.0.0:8401</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">0.0</span><span style="color:#032F62;">.0.0:</span><span style="color:#005CC5;">*</span><span style="color:#24292E;">    </span><span style="color:#032F62;">users:</span><span style="color:#24292E;">((&quot;vmstorage</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">prod&quot;</span><span style="color:#D73A49;">,</span><span style="color:#24292E;">pid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">4045</span><span style="color:#D73A49;">,</span><span style="color:#24292E;">fd</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">7</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#6F42C1;">LISTEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">2048</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">0.0</span><span style="color:#032F62;">.0.0:8482</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">0.0</span><span style="color:#032F62;">.0.0:</span><span style="color:#005CC5;">*</span><span style="color:#24292E;">    </span><span style="color:#032F62;">users:</span><span style="color:#24292E;">((&quot;vmstorage</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">prod&quot;</span><span style="color:#D73A49;">,</span><span style="color:#24292E;">pid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">4045</span><span style="color:#D73A49;">,</span><span style="color:#24292E;">fd</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">))</span></span></code></pre></div><h3 id="部署vminsert-prod组件" tabindex="-1">部署vminsert-prod组件 <a class="header-anchor" href="#部署vminsert-prod组件" aria-label="Permalink to &quot;部署vminsert-prod组件&quot;">​</a></h3><ul><li>systemd</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/systemd/system/vminsert.service</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#9ECBFF;">[Unit]</span></span>
<span class="line"><span style="color:#9ECBFF;">Description=Vmsinsert Server</span></span>
<span class="line"><span style="color:#9ECBFF;">After=network.target</span></span>
<span class="line"><span style="color:#9ECBFF;"> </span></span>
<span class="line"><span style="color:#9ECBFF;">[Service]</span></span>
<span class="line"><span style="color:#9ECBFF;">Restart=on-failure</span></span>
<span class="line"><span style="color:#9ECBFF;">WorkingDirectory=/tmp</span></span>
<span class="line"><span style="color:#9ECBFF;">ExecStart=/usr/local/bin/vminsert-prod -httpListenAddr=:8480 -storageNode=10.103.236.20:8400,10.103.236.21:8400,10.103.236.22:8400</span></span>
<span class="line"><span style="color:#9ECBFF;"> </span></span>
<span class="line"><span style="color:#9ECBFF;">[Install]</span></span>
<span class="line"><span style="color:#9ECBFF;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/systemd/system/vminsert.service</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#032F62;">[Unit]</span></span>
<span class="line"><span style="color:#032F62;">Description=Vmsinsert Server</span></span>
<span class="line"><span style="color:#032F62;">After=network.target</span></span>
<span class="line"><span style="color:#032F62;"> </span></span>
<span class="line"><span style="color:#032F62;">[Service]</span></span>
<span class="line"><span style="color:#032F62;">Restart=on-failure</span></span>
<span class="line"><span style="color:#032F62;">WorkingDirectory=/tmp</span></span>
<span class="line"><span style="color:#032F62;">ExecStart=/usr/local/bin/vminsert-prod -httpListenAddr=:8480 -storageNode=10.103.236.20:8400,10.103.236.21:8400,10.103.236.22:8400</span></span>
<span class="line"><span style="color:#032F62;"> </span></span>
<span class="line"><span style="color:#032F62;">[Install]</span></span>
<span class="line"><span style="color:#032F62;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span></code></pre></div><ul><li>启动</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemon-reload</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">vminsert.service</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemon-reload</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">vminsert.service</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# ss -tnlp </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8480</span></span>
<span class="line"><span style="color:#B392F0;">LISTEN</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">*</span><span style="color:#9ECBFF;">:8480</span><span style="color:#E1E4E8;">                     </span><span style="color:#79B8FF;">*</span><span style="color:#9ECBFF;">:</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;">                   </span><span style="color:#9ECBFF;">users:</span><span style="color:#E1E4E8;">((&quot;vminsert</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">prod&quot;</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;">pid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3219</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;">fd</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">))</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# ss -tnlp </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8480</span></span>
<span class="line"><span style="color:#6F42C1;">LISTEN</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">*</span><span style="color:#032F62;">:8480</span><span style="color:#24292E;">                     </span><span style="color:#005CC5;">*</span><span style="color:#032F62;">:</span><span style="color:#005CC5;">*</span><span style="color:#24292E;">                   </span><span style="color:#032F62;">users:</span><span style="color:#24292E;">((&quot;vminsert</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">prod&quot;</span><span style="color:#D73A49;">,</span><span style="color:#24292E;">pid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3219</span><span style="color:#D73A49;">,</span><span style="color:#24292E;">fd</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">))</span></span></code></pre></div><h3 id="部署vmselect-prod组件" tabindex="-1">部署vmselect-prod组件 <a class="header-anchor" href="#部署vmselect-prod组件" aria-label="Permalink to &quot;部署vmselect-prod组件&quot;">​</a></h3><ul><li>systemd</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/systemd/system/vmselect.service</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#9ECBFF;">[Unit]</span></span>
<span class="line"><span style="color:#9ECBFF;">Description=Vmselect Server</span></span>
<span class="line"><span style="color:#9ECBFF;">After=network.target</span></span>
<span class="line"><span style="color:#9ECBFF;"> </span></span>
<span class="line"><span style="color:#9ECBFF;">[Service]</span></span>
<span class="line"><span style="color:#9ECBFF;">Restart=on-failure</span></span>
<span class="line"><span style="color:#9ECBFF;">WorkingDirectory=/tmp</span></span>
<span class="line"><span style="color:#9ECBFF;">ExecStart=/usr/local/bin/vmselect-prod -httpListenAddr :8481 -storageNode=10.103.236.20:8401,10.103.236.21:8401,10.103.236.22:8401  -dedup.minScrapeInterval=30s -loggerTimezone &quot;Asia/Shanghai&quot; -loggerLevel INFO</span></span>
<span class="line"><span style="color:#9ECBFF;"> </span></span>
<span class="line"><span style="color:#9ECBFF;">[Install]</span></span>
<span class="line"><span style="color:#9ECBFF;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/systemd/system/vmselect.service</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#032F62;">[Unit]</span></span>
<span class="line"><span style="color:#032F62;">Description=Vmselect Server</span></span>
<span class="line"><span style="color:#032F62;">After=network.target</span></span>
<span class="line"><span style="color:#032F62;"> </span></span>
<span class="line"><span style="color:#032F62;">[Service]</span></span>
<span class="line"><span style="color:#032F62;">Restart=on-failure</span></span>
<span class="line"><span style="color:#032F62;">WorkingDirectory=/tmp</span></span>
<span class="line"><span style="color:#032F62;">ExecStart=/usr/local/bin/vmselect-prod -httpListenAddr :8481 -storageNode=10.103.236.20:8401,10.103.236.21:8401,10.103.236.22:8401  -dedup.minScrapeInterval=30s -loggerTimezone &quot;Asia/Shanghai&quot; -loggerLevel INFO</span></span>
<span class="line"><span style="color:#032F62;"> </span></span>
<span class="line"><span style="color:#032F62;">[Install]</span></span>
<span class="line"><span style="color:#032F62;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span></code></pre></div><ul><li>启动</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemon-reload</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">vmselect.service</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemon-reload</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">vmselect.service</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@k8s-node01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# ss -tnlp </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8481</span></span>
<span class="line"><span style="color:#B392F0;">LISTEN</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">*</span><span style="color:#9ECBFF;">:8481</span><span style="color:#E1E4E8;">                     </span><span style="color:#79B8FF;">*</span><span style="color:#9ECBFF;">:</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;">                   </span><span style="color:#9ECBFF;">users:</span><span style="color:#E1E4E8;">((&quot;vmselect</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">prod&quot;</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;">pid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">4277</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;">fd</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">))</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@k8s-node01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# ss -tnlp </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8481</span></span>
<span class="line"><span style="color:#6F42C1;">LISTEN</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">*</span><span style="color:#032F62;">:8481</span><span style="color:#24292E;">                     </span><span style="color:#005CC5;">*</span><span style="color:#032F62;">:</span><span style="color:#005CC5;">*</span><span style="color:#24292E;">                   </span><span style="color:#032F62;">users:</span><span style="color:#24292E;">((&quot;vmselect</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">prod&quot;</span><span style="color:#D73A49;">,</span><span style="color:#24292E;">pid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">4277</span><span style="color:#D73A49;">,</span><span style="color:#24292E;">fd</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">))</span></span></code></pre></div><h3 id="验证服务" tabindex="-1">验证服务 <a class="header-anchor" href="#验证服务" aria-label="Permalink to &quot;验证服务&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://10.103.236.199:8480/metrics</span></span>
<span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://10.103.236.199:8481/metrics</span></span>
<span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://10.103.236.199:8482/metrics</span></span>
<span class="line"><span style="color:#B392F0;">--</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">有返回数据则证明成功</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://10.103.236.199:8480/metrics</span></span>
<span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://10.103.236.199:8481/metrics</span></span>
<span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://10.103.236.199:8482/metrics</span></span>
<span class="line"><span style="color:#6F42C1;">--</span><span style="color:#24292E;"> </span><span style="color:#032F62;">有返回数据则证明成功</span></span></code></pre></div><h2 id="_2-4-配置prometheus" tabindex="-1">2.4 配置prometheus <a class="header-anchor" href="#_2-4-配置prometheus" aria-label="Permalink to &quot;2.4 配置prometheus&quot;">​</a></h2><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">############ vm ###################</span></span>
<span class="line"><span style="color:#85E89D;">remote_write</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">url</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http://192.168.2.10:8480/insert/0/prometheus/api/v1/write</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">queue_config</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">capacity</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">50000</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">max_shards</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1000</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">min_shards</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">100</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">max_samples_per_send</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1000</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">batch_send_deadline</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">180s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">min_backoff</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">3s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">max_backoff</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">30s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">############ vm ###################</span></span>
<span class="line"><span style="color:#22863A;">remote_write</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">url</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http://192.168.2.10:8480/insert/0/prometheus/api/v1/write</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">queue_config</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">capacity</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">50000</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">max_shards</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1000</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">min_shards</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">100</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">max_samples_per_send</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1000</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">batch_send_deadline</span><span style="color:#24292E;">: </span><span style="color:#032F62;">180s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">min_backoff</span><span style="color:#24292E;">: </span><span style="color:#032F62;">3s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">max_backoff</span><span style="color:#24292E;">: </span><span style="color:#032F62;">30s</span></span></code></pre></div><h2 id="_2-5-配置grafana" tabindex="-1">2.5 配置grafana <a class="header-anchor" href="#_2-5-配置grafana" aria-label="Permalink to &quot;2.5 配置grafana&quot;">​</a></h2><ul><li>添加数据</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202502181805810.png" alt="image-20250218180457842"></p><ul><li>填写vmselect地址，这里填写<code>slb</code></li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202502181805791.png" alt="image-20250218180545660"></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">http://10.103.236.21:8481/select/0/prometheus</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">http://10.103.236.21:8481/select/0/prometheus</span></span></code></pre></div><p>保存</p><ul><li>导入node-exporter模板</li></ul><p>16098</p>`,51),e=[o];function t(r,c,i,y,E,d){return a(),n("div",null,e)}const u=s(p,[["render",t]]);export{h as __pageData,u as default};
