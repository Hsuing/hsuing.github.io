import{_ as s,o as a,c as e,R as n}from"./chunks/framework.zUbWieqp.js";const h=JSON.parse('{"title":"1. ck慢出现原因","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Linux/Logs/Clickhouse/5-optimize.md","filePath":"guide/Linux/Logs/Clickhouse/5-optimize.md","lastUpdated":1739441864000}'),l={name:"guide/Linux/Logs/Clickhouse/5-optimize.md"},o=n(`<h1 id="_1-ck慢出现原因" tabindex="-1">1. ck慢出现原因 <a class="header-anchor" href="#_1-ck慢出现原因" aria-label="Permalink to &quot;1. ck慢出现原因&quot;">​</a></h1><p>尝试通过SQL执行计划来确定一个sql 的查询瓶颈。目前查看sql 执行计划有两种方法：</p><p><strong>方法一（20.6之前版本）：</strong></p><p>在 clickhouse 20.6 版本之前要查看 SQL 语句的执行计划需要设置日志级别为 trace 才能可以看到，并且只能真正执行 sql，在执行日志里面查看</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">clickhouse</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">client </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">u xxxx </span><span style="color:#6A737D;">--password xxxxxx --send_logs_level=trace &lt;&lt;&lt; &#39;your query sql&#39; &gt; /dev/null；</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">clickhouse</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">client </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">u xxxx </span><span style="color:#6A737D;">--password xxxxxx --send_logs_level=trace &lt;&lt;&lt; &#39;your query sql&#39; &gt; /dev/null；</span></span></code></pre></div><p><strong>方法二（20.6与20.6之后版本）</strong>：explain SQL</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">比如：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">explain plan sql语句;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">比如：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">explain plan sql语句;</span></span></code></pre></div><h1 id="_2-ck硬件优化" tabindex="-1">2. ck硬件优化 <a class="header-anchor" href="#_2-ck硬件优化" aria-label="Permalink to &quot;2. ck硬件优化&quot;">​</a></h1><h2 id="_2-1-mem" tabindex="-1">2.1 mem <a class="header-anchor" href="#_2-1-mem" aria-label="Permalink to &quot;2.1 mem&quot;">​</a></h2><h2 id="_2-2-cpu" tabindex="-1">2.2 cpu <a class="header-anchor" href="#_2-2-cpu" aria-label="Permalink to &quot;2.2 cpu&quot;">​</a></h2><h2 id="_2-3-disk" tabindex="-1">2.3 disk <a class="header-anchor" href="#_2-3-disk" aria-label="Permalink to &quot;2.3 disk&quot;">​</a></h2><p>挂载ssd</p><h1 id="_3-ck配置文件优化" tabindex="-1">3. ck配置文件优化 <a class="header-anchor" href="#_3-ck配置文件优化" aria-label="Permalink to &quot;3. ck配置文件优化&quot;">​</a></h1><h2 id="_3-1服务端" tabindex="-1">3.1服务端 <a class="header-anchor" href="#_3-1服务端" aria-label="Permalink to &quot;3.1服务端&quot;">​</a></h2><p><a href="https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings" target="_blank" rel="noreferrer">https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings</a></p><h3 id="_1查看默认配置" tabindex="-1">1查看默认配置 <a class="header-anchor" href="#_1查看默认配置" aria-label="Permalink to &quot;1查看默认配置&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">show settings ilike </span><span style="color:#9ECBFF;">&#39;%distributed_aggregation_memory_efficient%&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">system</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">settings</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;max_memory_usage_for_user&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;max_memory_usage&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;max_bytes_before_external_group_by&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;max_bytes_before_external_sort&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;max_memory_usage_for_all_queries&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;max_concurrent_queries_for_user&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;max_concurrent_queries_for_all_users&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;max_concurrent_queries&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;max_server_memory_usage&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;max_server_memory_usage_to_ram_ratio&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;max_thread_pool_size&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;distributed_aggregation_memory_efficient&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    );</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">show settings ilike </span><span style="color:#032F62;">&#39;%distributed_aggregation_memory_efficient%&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">system</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">settings</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;max_memory_usage_for_user&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;max_memory_usage&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;max_bytes_before_external_group_by&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;max_bytes_before_external_sort&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;max_memory_usage_for_all_queries&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;max_concurrent_queries_for_user&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;max_concurrent_queries_for_all_users&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;max_concurrent_queries&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;max_server_memory_usage&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;max_server_memory_usage_to_ram_ratio&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;max_thread_pool_size&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;distributed_aggregation_memory_efficient&#39;</span></span>
<span class="line"><span style="color:#24292E;">    );</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202411042103089.png" alt="image-20241104210301805"></p><h3 id="_2-修改配置" tabindex="-1">2.修改配置 <a class="header-anchor" href="#_2-修改配置" aria-label="Permalink to &quot;2.修改配置&quot;">​</a></h3><ul><li>background_pool_size</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">show settings ilike </span><span style="color:#9ECBFF;">&#39;%background_pool_size%&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">show settings ilike </span><span style="color:#032F62;">&#39;%background_pool_size%&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><p>修改这个默认是16，修改成32.</p><p>默认线程池大小为16，我们调整为32，可以有更多的线程资源参与merge。上调太高这个参数，是因为较多的merge线程可能会导致系统的CPU和IO负载过高</p><ul><li>background_schedule_pool_size</li></ul><p>执行后台任务（复制表、Kafka 流、DNS 缓存更新）的线程数。默认 128，建议改成 cpu 个数的 2 倍（线程数）</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">show settings ilike </span><span style="color:#9ECBFF;">&#39;%background_schedule_pool_size%&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">show settings ilike </span><span style="color:#032F62;">&#39;%background_schedule_pool_size%&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><ul><li>background_distributed_schedule_pool_size</li></ul><p>设置为分布式发送执行后台任务的线程数，默认 16，建议改成 cpu个数的 2 倍（线程数）</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">show settings ilike </span><span style="color:#9ECBFF;">&#39;%background_distributed_schedule_pool_size%&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">show settings ilike </span><span style="color:#032F62;">&#39;%background_distributed_schedule_pool_size%&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><ul><li>max_concurrent_queries</li></ul><p>最大并发处理的请求数(包含 select,insert 等)</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">show settings ilike </span><span style="color:#9ECBFF;">&#39;%max_concurrent_queries%&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">show settings ilike </span><span style="color:#032F62;">&#39;%max_concurrent_queries%&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202411042210278.png" alt="image-20241104221036699"></p><h2 id="_3-2用户端" tabindex="-1">3.2用户端 <a class="header-anchor" href="#_3-2用户端" aria-label="Permalink to &quot;3.2用户端&quot;">​</a></h2><p><a href="https://clickhouse.com/docs/en/operations/settings/settings" target="_blank" rel="noreferrer">https://clickhouse.com/docs/en/operations/settings/settings</a></p><h1 id="_4-常见配置" tabindex="-1">4.常见配置 <a class="header-anchor" href="#_4-常见配置" aria-label="Permalink to &quot;4.常见配置&quot;">​</a></h1><p>config.xml 配置项：<a href="https://clickhouse.tech/docs/en/operations/server-configuration-parameters/settings/" target="_blank" rel="noreferrer">https://clickhouse.tech/docs/en/operations/server-configuration-parameters/settings/</a></p><p>users.xml 配置项：<a href="https://clickhouse.tech/docs/en/operations/settings/settings/" target="_blank" rel="noreferrer">https://clickhouse.tech/docs/en/operations/settings/settings/</a></p><h2 id="_4-1-cpu资源" tabindex="-1">4.1 CPU资源 <a class="header-anchor" href="#_4-1-cpu资源" aria-label="Permalink to &quot;4.1 CPU资源&quot;">​</a></h2><h2 id="_4-2-mem资源" tabindex="-1">4.2 MEM资源 <a class="header-anchor" href="#_4-2-mem资源" aria-label="Permalink to &quot;4.2 MEM资源&quot;">​</a></h2><p><a href="https://blog.csdn.net/weixin_44480009/article/details/139922122" target="_blank" rel="noreferrer">https://blog.csdn.net/weixin_44480009/article/details/139922122</a></p><p><a href="https://mp.weixin.qq.com/s/3Q-Gu_CnU3ynL7hjujkCow" target="_blank" rel="noreferrer">https://mp.weixin.qq.com/s/3Q-Gu_CnU3ynL7hjujkCow</a></p>`,42),p=[o];function t(r,c,i,E,_,d){return a(),e("div",null,p)}const u=s(l,[["render",t]]);export{h as __pageData,u as default};
