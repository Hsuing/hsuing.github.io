import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const A=JSON.parse('{"title":"一、索引使用情况","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/SqlServer/10-index.md","filePath":"guide/Database/SqlServer/10-index.md","lastUpdated":1720533756000}'),p={name:"guide/Database/SqlServer/10-index.md"},o=l(`<h1 id="一、索引使用情况" tabindex="-1">一、索引使用情况 <a class="header-anchor" href="#一、索引使用情况" aria-label="Permalink to &quot;一、索引使用情况&quot;">​</a></h1><h2 id="_1-查找缺失索引" tabindex="-1">1.查找缺失索引 <a class="header-anchor" href="#_1-查找缺失索引" aria-label="Permalink to &quot;1.查找缺失索引&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_name</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_SEEKS</span><span style="color:#E1E4E8;"> 查找次数,</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_SCANS</span><span style="color:#E1E4E8;"> 扫描次数,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">ROUND</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_TOTAL_USER_COST</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) 减少的用户查询的平均成本,</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_USER_IMPACT</span><span style="color:#E1E4E8;"> 可能获得的平均百分比收益,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">ROUND</span><span style="color:#E1E4E8;">((</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_SEEKS</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_SCANS</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_TOTAL_USER_COST</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_USER_IMPACT</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) 可能的改进优势,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">LAST_USER_SEEK</span><span style="color:#E1E4E8;"> 最近查找时间,</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">LAST_USER_SCAN</span><span style="color:#E1E4E8;"> 最近扫描时间,C.[STATEMENT] 表名,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&#39;CREATE INDEX [IDX_&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">GROUP_HANDLE</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;_&#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">C</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_HANDLE</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;_&#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">REPLACE</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">REPLACE</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">REPLACE</span><span style="color:#E1E4E8;">(C.[STATEMENT],</span><span style="color:#9ECBFF;">&#39;]&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">),</span><span style="color:#9ECBFF;">&#39;[&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">),</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;]&#39;</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39; ON &#39;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">C.[STATEMENT]</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; (&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">ISNULL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">C</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">EQUALITY_COLUMNS</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">+CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">C</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">EQUALITY_COLUMNS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">C</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INEQUALITY_COLUMNS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;,&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">ISNULL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">C</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INEQUALITY_COLUMNS</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;)&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">ISNULL</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39; INCLUDE (&#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">C</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INCLUDED_COLUMNS</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;)&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#9ECBFF;">&#39;创建语句&#39;</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_missing_index_group_stats</span><span style="color:#E1E4E8;"> A </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_missing_index_groups</span><span style="color:#E1E4E8;"> B </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">GROUP_HANDLE</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_GROUP_HANDLE</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_missing_index_details</span><span style="color:#E1E4E8;"> C </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_HANDLE</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">C</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_HANDLE</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">C</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DATABASE_ID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">DB_ID</span><span style="color:#E1E4E8;">()    </span><span style="color:#6A737D;">--默认当前数据库，若指定数据库则使用DB_ID([&#39;DB_NAME&#39;])</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ROUND</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_SEEKS</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_TOTAL_USER_COST</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_USER_IMPACT</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_name</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_SEEKS</span><span style="color:#24292E;"> 查找次数,</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_SCANS</span><span style="color:#24292E;"> 扫描次数,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">ROUND</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_TOTAL_USER_COST</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) 减少的用户查询的平均成本,</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_USER_IMPACT</span><span style="color:#24292E;"> 可能获得的平均百分比收益,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">ROUND</span><span style="color:#24292E;">((</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_SEEKS</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_SCANS</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_TOTAL_USER_COST</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_USER_IMPACT</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) 可能的改进优势,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">LAST_USER_SEEK</span><span style="color:#24292E;"> 最近查找时间,</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">LAST_USER_SCAN</span><span style="color:#24292E;"> 最近扫描时间,C.[STATEMENT] 表名,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&#39;CREATE INDEX [IDX_&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">GROUP_HANDLE</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;_&#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">C</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_HANDLE</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;_&#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">REPLACE</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">REPLACE</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">REPLACE</span><span style="color:#24292E;">(C.[STATEMENT],</span><span style="color:#032F62;">&#39;]&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">),</span><span style="color:#032F62;">&#39;[&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">),</span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;]&#39;</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39; ON &#39;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">C.[STATEMENT]</span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; (&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">ISNULL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">C</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">EQUALITY_COLUMNS</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">+CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">C</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">EQUALITY_COLUMNS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">C</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INEQUALITY_COLUMNS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;,&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">ISNULL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">C</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INEQUALITY_COLUMNS</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;)&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">ISNULL</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39; INCLUDE (&#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">C</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INCLUDED_COLUMNS</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;)&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">) </span><span style="color:#032F62;">&#39;创建语句&#39;</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_missing_index_group_stats</span><span style="color:#24292E;"> A </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_missing_index_groups</span><span style="color:#24292E;"> B </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">GROUP_HANDLE</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_GROUP_HANDLE</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_missing_index_details</span><span style="color:#24292E;"> C </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_HANDLE</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">C</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_HANDLE</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">C</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DATABASE_ID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">DB_ID</span><span style="color:#24292E;">()    </span><span style="color:#6A737D;">--默认当前数据库，若指定数据库则使用DB_ID([&#39;DB_NAME&#39;])</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ROUND</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_SEEKS</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_TOTAL_USER_COST</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_USER_IMPACT</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141020618.jpg" alt=""></p><h2 id="_2-查找未使用索引" tabindex="-1">2.查找未使用索引 <a class="header-anchor" href="#_2-查找未使用索引" aria-label="Permalink to &quot;2.查找未使用索引&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_name</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">C</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">NAME</span><span style="color:#E1E4E8;"> 表名,</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span><span style="color:#E1E4E8;"> 索引ID,</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">NAME</span><span style="color:#E1E4E8;"> 索引名,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_SEEKS</span><span style="color:#E1E4E8;"> 搜索次数,</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_SCANS</span><span style="color:#E1E4E8;"> 扫描次数,</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_LOOKUPS</span><span style="color:#E1E4E8;"> 查找次数,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_UPDATES</span><span style="color:#E1E4E8;"> 更新次数,</span><span style="color:#79B8FF;">E</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">TABLEROWS</span><span style="color:#E1E4E8;"> 表行数,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&#39;DROP INDEX &#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">NAME</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39; ON &#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">D</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">NAME</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">)) </span><span style="color:#9ECBFF;">&#39;删除语句&#39;</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_index_usage_stats</span><span style="color:#E1E4E8;"> A </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> B </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objects</span><span style="color:#E1E4E8;"> C </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">C</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schemas</span><span style="color:#E1E4E8;"> D </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">C</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schema_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">D</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schema_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        (</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> INDEX_ID,OBJECT_ID,</span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">ROWS</span><span style="color:#E1E4E8;">) TABLEROWS</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">partitions</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">GROUP BY</span><span style="color:#E1E4E8;"> INDEX_ID,OBJECT_ID</span></span>
<span class="line"><span style="color:#E1E4E8;">        ) E </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">E</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">E</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECTPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;IsUserTable&#39;</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DATABASE_ID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">DB_ID</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">TYPE_DESC</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;NONCLUSTERED&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">IS_PRIMARY_KEY</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">IS_UNIQUE_CONSTRAINT</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--AND C.NAME=&#39;INVMB&#39;    --根据实际修改表名</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_SEEKS</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_SCANS</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_LOOKUPS</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">ASC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_name</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">C</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">NAME</span><span style="color:#24292E;"> 表名,</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span><span style="color:#24292E;"> 索引ID,</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">NAME</span><span style="color:#24292E;"> 索引名,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_SEEKS</span><span style="color:#24292E;"> 搜索次数,</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_SCANS</span><span style="color:#24292E;"> 扫描次数,</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_LOOKUPS</span><span style="color:#24292E;"> 查找次数,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_UPDATES</span><span style="color:#24292E;"> 更新次数,</span><span style="color:#005CC5;">E</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">TABLEROWS</span><span style="color:#24292E;"> 表行数,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&#39;DROP INDEX &#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">NAME</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39; ON &#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">D</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">NAME</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">)) </span><span style="color:#032F62;">&#39;删除语句&#39;</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_index_usage_stats</span><span style="color:#24292E;"> A </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> B </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objects</span><span style="color:#24292E;"> C </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">C</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schemas</span><span style="color:#24292E;"> D </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">C</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schema_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">D</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schema_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        (</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> INDEX_ID,OBJECT_ID,</span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">ROWS</span><span style="color:#24292E;">) TABLEROWS</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">partitions</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">GROUP BY</span><span style="color:#24292E;"> INDEX_ID,OBJECT_ID</span></span>
<span class="line"><span style="color:#24292E;">        ) E </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">E</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">E</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECTPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;IsUserTable&#39;</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DATABASE_ID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">DB_ID</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">TYPE_DESC</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;NONCLUSTERED&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">IS_PRIMARY_KEY</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">IS_UNIQUE_CONSTRAINT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--AND C.NAME=&#39;INVMB&#39;    --根据实际修改表名</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_SEEKS</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_SCANS</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_LOOKUPS</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">ASC</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141020342.jpg" alt=""></p><blockquote><p>当更新次数很大而搜索次数及扫描次数很小或为0时，说明该索引一直在更新但基本不被使用，因而也未对查询提供多少帮助，所以可以考虑删除。</p></blockquote><h2 id="_3-查看索引使用情况" tabindex="-1">3.查看索引使用情况 <a class="header-anchor" href="#_3-查看索引使用情况" aria-label="Permalink to &quot;3.查看索引使用情况&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_name</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(A.[OBJECT_ID]) 表名,</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span><span style="color:#E1E4E8;"> 索引ID,B.[NAME] 索引名称,B.[TYPE_DESC] 索引类型,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_SEEKS</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_SCANS</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_LOOKUPS</span><span style="color:#E1E4E8;"> 读,</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_UPDATES</span><span style="color:#E1E4E8;"> 写,</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">FILL_FACTOR</span><span style="color:#E1E4E8;"> 填充因子</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_index_usage_stats</span><span style="color:#E1E4E8;"> A </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> B </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> A.[OBJECT_ID]</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">B.[OBJECT_ID] </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECTPROPERTY</span><span style="color:#E1E4E8;">(A.[OBJECT_ID],</span><span style="color:#9ECBFF;">&#39;ISUSERTABLE&#39;</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DATABASE_ID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">DB_ID</span><span style="color:#E1E4E8;">()    </span><span style="color:#6A737D;">--默认当前数据库，若指定数据库则使用DB_ID([&#39;DB_NAME&#39;])</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(A.[OBJECT_ID]),</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_UPDATES</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_SEEKS</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_SCANS</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">USER_LOOKUPS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_name</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(A.[OBJECT_ID]) 表名,</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span><span style="color:#24292E;"> 索引ID,B.[NAME] 索引名称,B.[TYPE_DESC] 索引类型,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_SEEKS</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_SCANS</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_LOOKUPS</span><span style="color:#24292E;"> 读,</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_UPDATES</span><span style="color:#24292E;"> 写,</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">FILL_FACTOR</span><span style="color:#24292E;"> 填充因子</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_index_usage_stats</span><span style="color:#24292E;"> A </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> B </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> A.[OBJECT_ID]</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">B.[OBJECT_ID] </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECTPROPERTY</span><span style="color:#24292E;">(A.[OBJECT_ID],</span><span style="color:#032F62;">&#39;ISUSERTABLE&#39;</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DATABASE_ID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">DB_ID</span><span style="color:#24292E;">()    </span><span style="color:#6A737D;">--默认当前数据库，若指定数据库则使用DB_ID([&#39;DB_NAME&#39;])</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(A.[OBJECT_ID]),</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_UPDATES</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_SEEKS</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_SCANS</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">USER_LOOKUPS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><h1 id="二、索引碎片维护" tabindex="-1">二、索引碎片维护 <a class="header-anchor" href="#二、索引碎片维护" aria-label="Permalink to &quot;二、索引碎片维护&quot;">​</a></h1><p>语法：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 查看数据库中所有索引的碎片信息</span></span>
<span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> \${数据库名}</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC SHOWCONTIG </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ALL_INDEXES</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看指定表的所有索引的碎片信息</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC SHOWCONTIG (\${表名}) </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ALL_INDEXES</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看指定表、指定索引的碎片信息</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC SHOWCONTIG (\${表名},\${索引名})</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 查看数据库中所有索引的碎片信息</span></span>
<span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> \${数据库名}</span></span>
<span class="line"><span style="color:#24292E;">DBCC SHOWCONTIG </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ALL_INDEXES</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看指定表的所有索引的碎片信息</span></span>
<span class="line"><span style="color:#24292E;">DBCC SHOWCONTIG (\${表名}) </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ALL_INDEXES</span><span style="color:#24292E;">  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看指定表、指定索引的碎片信息</span></span>
<span class="line"><span style="color:#24292E;">DBCC SHOWCONTIG (\${表名},\${索引名})</span></span></code></pre></div><h2 id="_1-产生原因及影响" tabindex="-1">1.产生原因及影响 <a class="header-anchor" href="#_1-产生原因及影响" aria-label="Permalink to &quot;1.产生原因及影响&quot;">​</a></h2><p>索引是数据库引擎中针对表(有时候也针对视图)建立的特别数据结构，用来帮助查找和整理数据，它的重要性体现在能够使数据库引擎快速返回查询结果。当对索引所在的基础数据表进行增删改时，若存储的数据进行了不适当的跨页（SQL Server中存储的最小单位是页，页是不可再分的），就会导致索引碎片的产生。随着索引碎片的不断增多，查询响应时间就会变慢，性能也因此而下降。要解决这个问题，可以通过重新生成或重新组织索引来解决</p><h2 id="_2-碎片分类" tabindex="-1">2.碎片分类 <a class="header-anchor" href="#_2-碎片分类" aria-label="Permalink to &quot;2.碎片分类&quot;">​</a></h2><h3 id="_2-1、外部碎片" tabindex="-1">2.1、外部碎片 <a class="header-anchor" href="#_2-1、外部碎片" aria-label="Permalink to &quot;2.1、外部碎片&quot;">​</a></h3><p>当索引页不在逻辑顺序上时就会产生外部碎片。索引创建时，索引键按照逻辑顺序放在一组索引页上。当新数据插入索引时，新的键可能放在存在的键之间。为了让新的键按照正确的顺序插入，可能会创建新的索引页来存储需要移动的那些存在的键。这些新的索引页通常物理上不会和那些被移动的键原来所在的页相邻。创建新页的过程会引起索引页偏离逻辑顺序</p><p>外部检测也是用LIMITED模式的<em>sys.dm_db_index_physical_stats</em>，但我们使用avg_fragmentation_in_percent 的结果来检测外部碎片。使用LIMITED模式会给我们叶子层的碎片。如果要获得非页层的碎片，可以使用DETAILED或SAMPLE模式。碎片是页的连续分配。例如如果一个索引有150页，页分配从1到50，55到60，65到120，还有140到180。每个这样序列被称为碎片，这里就是有4个碎片。</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_NAME</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_configure </span><span style="color:#9ECBFF;">&#39;show advanced options&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#F97583;">RECONFIGURE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OVERRIDE</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @DefaultFillFactor </span><span style="color:#F97583;">INT</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @Fillfactor </span><span style="color:#F97583;">TABLE</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">Name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      Minimum </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      Maximum </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      config_value </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      run_value </span><span style="color:#F97583;">INT</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#F97583;">INSERT  INTO</span><span style="color:#E1E4E8;"> @Fillfactor</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_configure </span><span style="color:#9ECBFF;">&#39;fill factor (%)&#39;</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  @DefaultFillFactor </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> run_value </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> run_value</span></span>
<span class="line"><span style="color:#E1E4E8;">                             </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    @Fillfactor</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> DBname ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> CchemaName ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> TableName ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> IndexName ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Index_type_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> IndexType ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page_count</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [PageCount] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">partition_number</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> PartitionNumber ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fill_factor</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fill_factor</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> @DefaultFillFactor</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Fill Factor] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">avg_fragmentation_in_percent</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fragment_count</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_level</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Leaf Level&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Nonleaf Level&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> IndexLevel</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_index_physical_stats</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">DB_ID</span><span style="color:#E1E4E8;">(), </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;LIMITED&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">stats</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objects</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> o ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schemas</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> s ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> i</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schema_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schema_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">avg_fragmentation_in_percent</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page_count</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1000</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">avg_fragmentation_in_percent</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page_count</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_NAME</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_configure </span><span style="color:#032F62;">&#39;show advanced options&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#D73A49;">RECONFIGURE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OVERRIDE</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @DefaultFillFactor </span><span style="color:#D73A49;">INT</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @Fillfactor </span><span style="color:#D73A49;">TABLE</span></span>
<span class="line"><span style="color:#24292E;">    (</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">Name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">      Minimum </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      Maximum </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      config_value </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      run_value </span><span style="color:#D73A49;">INT</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#D73A49;">INSERT  INTO</span><span style="color:#24292E;"> @Fillfactor</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_configure </span><span style="color:#032F62;">&#39;fill factor (%)&#39;</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  @DefaultFillFactor </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> run_value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> run_value</span></span>
<span class="line"><span style="color:#24292E;">                             </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    @Fillfactor</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> DBname ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> CchemaName ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> TableName ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> IndexName ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Index_type_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> IndexType ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page_count</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [PageCount] ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">partition_number</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> PartitionNumber ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fill_factor</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fill_factor</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> @DefaultFillFactor</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Fill Factor] ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">avg_fragmentation_in_percent</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fragment_count</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_level</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Leaf Level&#39;</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Nonleaf Level&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> IndexLevel</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_index_physical_stats</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">DB_ID</span><span style="color:#24292E;">(), </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;LIMITED&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">stats</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objects</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> o ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schemas</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> s ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> i</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schema_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schema_id</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">avg_fragmentation_in_percent</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page_count</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1000</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">avg_fragmentation_in_percent</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page_count</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141020438.jpg" alt=""></p><p>在这个查询里，我使用的WHERE条件只列出碎片大于20%且最少1000页的索引。avg_fragmentation_in_percent 值高的话，可能有下列原因：</p><ul><li>SQL Server存储引擎对表或索引从混合区开始分配页，直到页数达到8页。一旦页数达到8页，SQL Server引擎开始把整个统一区分配给索引。因此这里对于小表会有很高的碎片，重建索引会增加碎片。例如，我们假设一个索引有7页，这些页是从2个混合区分配的，当我们重建索引的时候，很可能把页分配从2个混合区变成最大7个混合区，这就导致了碎片增加。</li><li>即使也从混合区分配，还是有碎片产生的可能。当索引大小增长时，在非页层也需要更多的页。如果分配给叶子层的最后页是250，在叶子层索引结构里增加更多的记录，可能会在第1层索引需要更多的页，然后SQL Server存储引擎分配251页在第1层索引，这就在叶子层产生了碎片。</li><li>造成分页的其他常见原因就是DML操作。Rebuild/Reorganize 索引对于上述不能很好的减少碎片，但可以减少由分页或删除操作造成的碎片。</li><li>我们按下列要求进行索引的维护： <ul><li>20-40%的碎片，用Reorganize来重新组织索引。</li><li>大于40%的碎片，需要用Rebuild来重建索引。</li><li>低于1000页的索引，在索引维护逻辑上是被忽略的（不处理）</li><li>大于50k的页，碎片在10-20%之间，也要用Reorganize来重新组织索引</li></ul></li></ul><h3 id="_2-2、内部碎片" tabindex="-1">2.2、内部碎片 <a class="header-anchor" href="#_2-2、内部碎片" aria-label="Permalink to &quot;2.2、内部碎片&quot;">​</a></h3><p>当索引页没有用到最大量时就产生了内部碎片。虽然在一个有频繁数据插入的应用程序里这也许有帮助，然而设置一个fill factor（填充因子）会在索引页上留下空间，服务器内部碎片会导致索引尺寸增加，从而在返回需要的数据时要执行额外的读操作。这些额外的读操作会降低查询的性能。</p><p>可以用DETAILED模式的 <em>sys.dm_db_index_physical_stats</em>，avg_page_space_used_in_percent 列会给出索引的内部碎片</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_NAME</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_configure </span><span style="color:#9ECBFF;">&#39;show advanced options&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#F97583;">RECONFIGURE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OVERRIDE</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @DefaultFillFactor </span><span style="color:#F97583;">INT</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @Fillfactor </span><span style="color:#F97583;">TABLE</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">Name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      Minimum </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      Maximum </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      config_value </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      run_value </span><span style="color:#F97583;">INT</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#F97583;">INSERT  INTO</span><span style="color:#E1E4E8;"> @Fillfactor</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_configure </span><span style="color:#9ECBFF;">&#39;fill factor (%)&#39;</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  @DefaultFillFactor </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> run_value </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> run_value</span></span>
<span class="line"><span style="color:#E1E4E8;">                             </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    @Fillfactor</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> DBname ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> CchemaName ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> TableName ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> IndexName ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Index_type_desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> IndexType ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page_count</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [PageCount] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">partition_number</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> PartitionNumber ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fill_factor</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fill_factor</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> @DefaultFillFactor</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Fill Factor] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">avg_page_space_used_in_percent</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_level</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Leaf Level&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Nonleaf Level&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> IndexLevel</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_index_physical_stats</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">DB_ID</span><span style="color:#E1E4E8;">(), </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;DETAILED&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">stats</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objects</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> o ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schemas</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> s ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> i</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schema_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schema_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">avg_page_space_used_in_percent</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">85</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page_count</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">avg_page_space_used_in_percent</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ASC</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">stats</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page_count</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_NAME</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_configure </span><span style="color:#032F62;">&#39;show advanced options&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#D73A49;">RECONFIGURE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OVERRIDE</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @DefaultFillFactor </span><span style="color:#D73A49;">INT</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @Fillfactor </span><span style="color:#D73A49;">TABLE</span></span>
<span class="line"><span style="color:#24292E;">    (</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">Name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">      Minimum </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      Maximum </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      config_value </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      run_value </span><span style="color:#D73A49;">INT</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#D73A49;">INSERT  INTO</span><span style="color:#24292E;"> @Fillfactor</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_configure </span><span style="color:#032F62;">&#39;fill factor (%)&#39;</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  @DefaultFillFactor </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> run_value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> run_value</span></span>
<span class="line"><span style="color:#24292E;">                             </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    @Fillfactor</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> DBname ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> CchemaName ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> TableName ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> IndexName ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Index_type_desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> IndexType ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page_count</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [PageCount] ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">partition_number</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> PartitionNumber ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fill_factor</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fill_factor</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> @DefaultFillFactor</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Fill Factor] ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">avg_page_space_used_in_percent</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_level</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Leaf Level&#39;</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Nonleaf Level&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> IndexLevel</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_index_physical_stats</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">DB_ID</span><span style="color:#24292E;">(), </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;DETAILED&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">stats</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objects</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> o ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schemas</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> s ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> i</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schema_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schema_id</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">avg_page_space_used_in_percent</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">85</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page_count</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">avg_page_space_used_in_percent</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ASC</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">stats</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page_count</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><ul><li>查看单个表</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_NAME</span></span>
<span class="line"><span style="color:#6A737D;">-- 创建变量 指定要查看的表</span></span>
<span class="line"><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @table_id </span><span style="color:#F97583;">int</span></span>
<span class="line"><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @table_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;Table_name&#39;</span><span style="color:#E1E4E8;">)  </span><span style="color:#6A737D;">-- 修改成自己的表名字</span></span>
<span class="line"><span style="color:#6A737D;">-- 执行</span></span>
<span class="line"><span style="color:#E1E4E8;">dbcc showcontig(@table_id)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 执行结果</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC SHOWCONTIG 正在扫描 </span><span style="color:#9ECBFF;">&#39;Order&#39;</span><span style="color:#E1E4E8;"> 表...</span></span>
<span class="line"><span style="color:#E1E4E8;">表: </span><span style="color:#9ECBFF;">&#39;Order&#39;</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1042818777</span><span style="color:#E1E4E8;">)；索引 ID: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">，数据库 ID: </span><span style="color:#79B8FF;">29</span></span>
<span class="line"><span style="color:#E1E4E8;">已执行 </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> 级别的扫描。</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描页数................................: </span><span style="color:#79B8FF;">129096</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描区数..............................: </span><span style="color:#79B8FF;">16140</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 区切换次数..............................: </span><span style="color:#79B8FF;">16139</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 每个区的平均页数........................: </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描密度 [最佳计数:实际计数].......: </span><span style="color:#79B8FF;">99</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">98</span><span style="color:#E1E4E8;">% [16137:16140]</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 区扫描碎片 ..................: </span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">26</span><span style="color:#E1E4E8;">%</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 每页的平均可用字节数.....................: </span><span style="color:#79B8FF;">685</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 平均页密度(满).....................: </span><span style="color:#79B8FF;">91</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">53</span><span style="color:#E1E4E8;">%</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC 执行完毕。如果 DBCC 输出了错误信息，请与系统管理员联系。</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 针对所有级别</span></span>
<span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> biyin</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC SHOWCONTIG(</span><span style="color:#9ECBFF;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ALL_INDEXES</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 执行结果</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC SHOWCONTIG 正在扫描 </span><span style="color:#9ECBFF;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#E1E4E8;"> 表...</span></span>
<span class="line"><span style="color:#E1E4E8;">表: </span><span style="color:#9ECBFF;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1957582012</span><span style="color:#E1E4E8;">)；索引 ID: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">，数据库 ID: </span><span style="color:#79B8FF;">29</span></span>
<span class="line"><span style="color:#E1E4E8;">已执行 </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> 级别的扫描。</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描页数................................: </span><span style="color:#79B8FF;">26485</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描区数..............................: </span><span style="color:#79B8FF;">3312</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 区切换次数..............................: </span><span style="color:#79B8FF;">3311</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 每个区的平均页数........................: </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描密度 [最佳计数:实际计数].......: </span><span style="color:#79B8FF;">99</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">97</span><span style="color:#E1E4E8;">% [3311:3312]</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 区扫描碎片 ..................: </span><span style="color:#79B8FF;">63</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">53</span><span style="color:#E1E4E8;">%</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 每页的平均可用字节数.....................: </span><span style="color:#79B8FF;">375</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">9</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 平均页密度(满).....................: </span><span style="color:#79B8FF;">95</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">36</span><span style="color:#E1E4E8;">%</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC SHOWCONTIG 正在扫描 </span><span style="color:#9ECBFF;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#E1E4E8;"> 表...</span></span>
<span class="line"><span style="color:#E1E4E8;">表: </span><span style="color:#9ECBFF;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1957582012</span><span style="color:#E1E4E8;">)；索引 ID: </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">，数据库 ID: </span><span style="color:#79B8FF;">29</span></span>
<span class="line"><span style="color:#E1E4E8;">已执行 LEAF 级别的扫描。</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描页数................................: </span><span style="color:#79B8FF;">1465</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描区数..............................: </span><span style="color:#79B8FF;">185</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 区切换次数..............................: </span><span style="color:#79B8FF;">204</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 每个区的平均页数........................: </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">9</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描密度 [最佳计数:实际计数].......: </span><span style="color:#79B8FF;">89</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">76</span><span style="color:#E1E4E8;">% [184:205]</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 逻辑扫描碎片 ..................: </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">05</span><span style="color:#E1E4E8;">%</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 区扫描碎片 ..................: </span><span style="color:#79B8FF;">98</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">92</span><span style="color:#E1E4E8;">%</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 每页的平均可用字节数.....................: </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 平均页密度(满).....................: </span><span style="color:#79B8FF;">99</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">91</span><span style="color:#E1E4E8;">%</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC SHOWCONTIG 正在扫描 </span><span style="color:#9ECBFF;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#E1E4E8;"> 表...</span></span>
<span class="line"><span style="color:#E1E4E8;">表: </span><span style="color:#9ECBFF;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1957582012</span><span style="color:#E1E4E8;">)；索引 ID: </span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;">，数据库 ID: </span><span style="color:#79B8FF;">29</span></span>
<span class="line"><span style="color:#E1E4E8;">已执行 LEAF 级别的扫描。</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描页数................................: </span><span style="color:#79B8FF;">2919</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描区数..............................: </span><span style="color:#79B8FF;">368</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 区切换次数..............................: </span><span style="color:#79B8FF;">2875</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 每个区的平均页数........................: </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">9</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描密度 [最佳计数:实际计数].......: </span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">69</span><span style="color:#E1E4E8;">% [365:2876]</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 逻辑扫描碎片 ..................: </span><span style="color:#79B8FF;">99</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">04</span><span style="color:#E1E4E8;">%</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 区扫描碎片 ..................: </span><span style="color:#79B8FF;">95</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">38</span><span style="color:#E1E4E8;">%</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 每页的平均可用字节数.....................: </span><span style="color:#79B8FF;">3298</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 平均页密度(满).....................: </span><span style="color:#79B8FF;">59</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">25</span><span style="color:#E1E4E8;">%</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC SHOWCONTIG 正在扫描 </span><span style="color:#9ECBFF;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#E1E4E8;"> 表...</span></span>
<span class="line"><span style="color:#E1E4E8;">表: </span><span style="color:#9ECBFF;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1957582012</span><span style="color:#E1E4E8;">)；索引 ID: </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">，数据库 ID: </span><span style="color:#79B8FF;">29</span></span>
<span class="line"><span style="color:#E1E4E8;">已执行 LEAF 级别的扫描。</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描页数................................: </span><span style="color:#79B8FF;">3142</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描区数..............................: </span><span style="color:#79B8FF;">397</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 区切换次数..............................: </span><span style="color:#79B8FF;">2435</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 每个区的平均页数........................: </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">9</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描密度 [最佳计数:实际计数].......: </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;">% [393:2436]</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 逻辑扫描碎片 ..................: </span><span style="color:#79B8FF;">75</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">97</span><span style="color:#E1E4E8;">%</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 区扫描碎片 ..................: </span><span style="color:#79B8FF;">93</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">95</span><span style="color:#E1E4E8;">%</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 每页的平均可用字节数.....................: </span><span style="color:#79B8FF;">2267</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 平均页密度(满).....................: </span><span style="color:#79B8FF;">71</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">99</span><span style="color:#E1E4E8;">%</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC 执行完毕。如果 DBCC 输出了错误信息，请与系统管理员联系。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">完成时间: </span><span style="color:#79B8FF;">2023</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">04</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">20T15:</span><span style="color:#79B8FF;">36</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">6177732</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">08</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">00</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_NAME</span></span>
<span class="line"><span style="color:#6A737D;">-- 创建变量 指定要查看的表</span></span>
<span class="line"><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @table_id </span><span style="color:#D73A49;">int</span></span>
<span class="line"><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @table_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;Table_name&#39;</span><span style="color:#24292E;">)  </span><span style="color:#6A737D;">-- 修改成自己的表名字</span></span>
<span class="line"><span style="color:#6A737D;">-- 执行</span></span>
<span class="line"><span style="color:#24292E;">dbcc showcontig(@table_id)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 执行结果</span></span>
<span class="line"><span style="color:#24292E;">DBCC SHOWCONTIG 正在扫描 </span><span style="color:#032F62;">&#39;Order&#39;</span><span style="color:#24292E;"> 表...</span></span>
<span class="line"><span style="color:#24292E;">表: </span><span style="color:#032F62;">&#39;Order&#39;</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1042818777</span><span style="color:#24292E;">)；索引 ID: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">，数据库 ID: </span><span style="color:#005CC5;">29</span></span>
<span class="line"><span style="color:#24292E;">已执行 </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> 级别的扫描。</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描页数................................: </span><span style="color:#005CC5;">129096</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描区数..............................: </span><span style="color:#005CC5;">16140</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 区切换次数..............................: </span><span style="color:#005CC5;">16139</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 每个区的平均页数........................: </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描密度 [最佳计数:实际计数].......: </span><span style="color:#005CC5;">99</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">98</span><span style="color:#24292E;">% [16137:16140]</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 区扫描碎片 ..................: </span><span style="color:#005CC5;">24</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">26</span><span style="color:#24292E;">%</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 每页的平均可用字节数.....................: </span><span style="color:#005CC5;">685</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 平均页密度(满).....................: </span><span style="color:#005CC5;">91</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">53</span><span style="color:#24292E;">%</span></span>
<span class="line"><span style="color:#24292E;">DBCC 执行完毕。如果 DBCC 输出了错误信息，请与系统管理员联系。</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 针对所有级别</span></span>
<span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> biyin</span></span>
<span class="line"><span style="color:#24292E;">DBCC SHOWCONTIG(</span><span style="color:#032F62;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ALL_INDEXES</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 执行结果</span></span>
<span class="line"><span style="color:#24292E;">DBCC SHOWCONTIG 正在扫描 </span><span style="color:#032F62;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#24292E;"> 表...</span></span>
<span class="line"><span style="color:#24292E;">表: </span><span style="color:#032F62;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1957582012</span><span style="color:#24292E;">)；索引 ID: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">，数据库 ID: </span><span style="color:#005CC5;">29</span></span>
<span class="line"><span style="color:#24292E;">已执行 </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> 级别的扫描。</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描页数................................: </span><span style="color:#005CC5;">26485</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描区数..............................: </span><span style="color:#005CC5;">3312</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 区切换次数..............................: </span><span style="color:#005CC5;">3311</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 每个区的平均页数........................: </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描密度 [最佳计数:实际计数].......: </span><span style="color:#005CC5;">99</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">97</span><span style="color:#24292E;">% [3311:3312]</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 区扫描碎片 ..................: </span><span style="color:#005CC5;">63</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">53</span><span style="color:#24292E;">%</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 每页的平均可用字节数.....................: </span><span style="color:#005CC5;">375</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">9</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 平均页密度(满).....................: </span><span style="color:#005CC5;">95</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">36</span><span style="color:#24292E;">%</span></span>
<span class="line"><span style="color:#24292E;">DBCC SHOWCONTIG 正在扫描 </span><span style="color:#032F62;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#24292E;"> 表...</span></span>
<span class="line"><span style="color:#24292E;">表: </span><span style="color:#032F62;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1957582012</span><span style="color:#24292E;">)；索引 ID: </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">，数据库 ID: </span><span style="color:#005CC5;">29</span></span>
<span class="line"><span style="color:#24292E;">已执行 LEAF 级别的扫描。</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描页数................................: </span><span style="color:#005CC5;">1465</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描区数..............................: </span><span style="color:#005CC5;">185</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 区切换次数..............................: </span><span style="color:#005CC5;">204</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 每个区的平均页数........................: </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">9</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描密度 [最佳计数:实际计数].......: </span><span style="color:#005CC5;">89</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">76</span><span style="color:#24292E;">% [184:205]</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 逻辑扫描碎片 ..................: </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">05</span><span style="color:#24292E;">%</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 区扫描碎片 ..................: </span><span style="color:#005CC5;">98</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">92</span><span style="color:#24292E;">%</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 每页的平均可用字节数.....................: </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 平均页密度(满).....................: </span><span style="color:#005CC5;">99</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">91</span><span style="color:#24292E;">%</span></span>
<span class="line"><span style="color:#24292E;">DBCC SHOWCONTIG 正在扫描 </span><span style="color:#032F62;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#24292E;"> 表...</span></span>
<span class="line"><span style="color:#24292E;">表: </span><span style="color:#032F62;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1957582012</span><span style="color:#24292E;">)；索引 ID: </span><span style="color:#005CC5;">15</span><span style="color:#24292E;">，数据库 ID: </span><span style="color:#005CC5;">29</span></span>
<span class="line"><span style="color:#24292E;">已执行 LEAF 级别的扫描。</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描页数................................: </span><span style="color:#005CC5;">2919</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描区数..............................: </span><span style="color:#005CC5;">368</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 区切换次数..............................: </span><span style="color:#005CC5;">2875</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 每个区的平均页数........................: </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">9</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描密度 [最佳计数:实际计数].......: </span><span style="color:#005CC5;">12</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">69</span><span style="color:#24292E;">% [365:2876]</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 逻辑扫描碎片 ..................: </span><span style="color:#005CC5;">99</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">04</span><span style="color:#24292E;">%</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 区扫描碎片 ..................: </span><span style="color:#005CC5;">95</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">38</span><span style="color:#24292E;">%</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 每页的平均可用字节数.....................: </span><span style="color:#005CC5;">3298</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 平均页密度(满).....................: </span><span style="color:#005CC5;">59</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">25</span><span style="color:#24292E;">%</span></span>
<span class="line"><span style="color:#24292E;">DBCC SHOWCONTIG 正在扫描 </span><span style="color:#032F62;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#24292E;"> 表...</span></span>
<span class="line"><span style="color:#24292E;">表: </span><span style="color:#032F62;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1957582012</span><span style="color:#24292E;">)；索引 ID: </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">，数据库 ID: </span><span style="color:#005CC5;">29</span></span>
<span class="line"><span style="color:#24292E;">已执行 LEAF 级别的扫描。</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描页数................................: </span><span style="color:#005CC5;">3142</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描区数..............................: </span><span style="color:#005CC5;">397</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 区切换次数..............................: </span><span style="color:#005CC5;">2435</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 每个区的平均页数........................: </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">9</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描密度 [最佳计数:实际计数].......: </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">13</span><span style="color:#24292E;">% [393:2436]</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 逻辑扫描碎片 ..................: </span><span style="color:#005CC5;">75</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">97</span><span style="color:#24292E;">%</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 区扫描碎片 ..................: </span><span style="color:#005CC5;">93</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">95</span><span style="color:#24292E;">%</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 每页的平均可用字节数.....................: </span><span style="color:#005CC5;">2267</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 平均页密度(满).....................: </span><span style="color:#005CC5;">71</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">99</span><span style="color:#24292E;">%</span></span>
<span class="line"><span style="color:#24292E;">DBCC 执行完毕。如果 DBCC 输出了错误信息，请与系统管理员联系。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">完成时间: </span><span style="color:#005CC5;">2023</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">04</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">20T15:</span><span style="color:#005CC5;">36</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">6177732</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">08</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">00</span></span></code></pre></div><p><strong>基本指标</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">扫描密度（%）[最佳计数:实际计数]：这是“最佳计数”与“实际计数”的比率。如果所有内容都是连续的，则该值为 100；如果该值小于 100，则存在一些碎片。“最佳计数”是指在一切都连续链接的情况下，区更改的理想数目。“实际计数”是指区更改的实际次数。</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">逻辑扫描碎片（%）：扫描索引的叶级页时返回的出错页的百分比。此数与堆无关。对于出错页，分配给索引的下一个物理页不是由当前叶级页中的“下一页”指针所指向的页。</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">区扫描碎片（%）：扫描索引的叶级页时出错区所占的百分比。此数与堆无关。对于出错区，包含当前索引页的区在物理上不是包含上一个索引页的区的下一个区。注意： 如果索引跨越多个文件，则此数字无意义。</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">avg_page_space_used_in_percent：该参数表示数据页的填充程度，一般小于100%，但是该参数越小，表示数据页面碎片化情况越严重。若想要数据页使用率的问题，必须进行索引重建操作</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">avg_fragment_size_in_pages：平均多少个page就有一个碎片，该值 越大越好</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">avg_fragmentation_in_percent：碎片率，不解释。该值越小越好，和avg_fragment_size_in_pages 反比！</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">page_count：扫描的总page数</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">record_count：扫描的总记录数。注意：是相对于当前的扫描来说的记录数，不一定是你所认为的 用户表的一行数据</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">forwarded_record_count：页拆分的记录数目</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">扫描密度（%）[最佳计数:实际计数]：这是“最佳计数”与“实际计数”的比率。如果所有内容都是连续的，则该值为 100；如果该值小于 100，则存在一些碎片。“最佳计数”是指在一切都连续链接的情况下，区更改的理想数目。“实际计数”是指区更改的实际次数。</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">逻辑扫描碎片（%）：扫描索引的叶级页时返回的出错页的百分比。此数与堆无关。对于出错页，分配给索引的下一个物理页不是由当前叶级页中的“下一页”指针所指向的页。</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">区扫描碎片（%）：扫描索引的叶级页时出错区所占的百分比。此数与堆无关。对于出错区，包含当前索引页的区在物理上不是包含上一个索引页的区的下一个区。注意： 如果索引跨越多个文件，则此数字无意义。</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">avg_page_space_used_in_percent：该参数表示数据页的填充程度，一般小于100%，但是该参数越小，表示数据页面碎片化情况越严重。若想要数据页使用率的问题，必须进行索引重建操作</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">avg_fragment_size_in_pages：平均多少个page就有一个碎片，该值 越大越好</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">avg_fragmentation_in_percent：碎片率，不解释。该值越小越好，和avg_fragment_size_in_pages 反比！</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">page_count：扫描的总page数</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">record_count：扫描的总记录数。注意：是相对于当前的扫描来说的记录数，不一定是你所认为的 用户表的一行数据</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">forwarded_record_count：页拆分的记录数目</span></span></code></pre></div><h2 id="_3-维护方法" tabindex="-1">3.维护方法 <a class="header-anchor" href="#_3-维护方法" aria-label="Permalink to &quot;3.维护方法&quot;">​</a></h2><p>1、删除索引并重建。</p><p>2、使用DROP_EXISTING语句重建索引。</p><p>3、使用ALTER INDEX REBUILD重新生成索引。(推荐)</p><p>4、使用ALTER INDEX REORGANIZE重新组织索引。(推荐)</p><h2 id="_4-注意事项" tabindex="-1">4.注意事项 <a class="header-anchor" href="#_4-注意事项" aria-label="Permalink to &quot;4.注意事项&quot;">​</a></h2><table><thead><tr><th>碎片率</th><th>采用方法</th></tr></thead><tbody><tr><td>&gt;30%</td><td>ALTER INDEX REBUILD WITH(ONLINE = ON)</td></tr><tr><td>&gt;5% 且 &lt;=30%</td><td>ALTER INDEX REORGANIZE</td></tr></tbody></table><p><strong>重新生成索引</strong>可以联机执行，也可以脱机执行。</p><p><strong>重新组织索引</strong>始终联机执行。这些值提供了一个大致指导原则，用于确定应在ALTER INDEX REORGANIZE和ALTER INDEX REBUILD之间进行切换的点。不过，实际值可能会随情况而变化，必须要通过试验来确定最适合您环境的阈值。</p><p>非常低的碎片级别（小于5%）不应通过这些命令来解决，因为删除如此少量的碎片所获得的收益始终远低于重新生成或重新组织索引的开销。</p><p>==切记：所有索引碎片维护一定要在凌晨（非业务高峰期间）进行！！！==</p><h1 id="三、优化指导原则" tabindex="-1">三、优化指导原则 <a class="header-anchor" href="#三、优化指导原则" aria-label="Permalink to &quot;三、优化指导原则&quot;">​</a></h1><h2 id="_1-如何知道是否发生了索引碎片" tabindex="-1">1.如何知道是否发生了索引碎片？ <a class="header-anchor" href="#_1-如何知道是否发生了索引碎片" aria-label="Permalink to &quot;1.如何知道是否发生了索引碎片？&quot;">​</a></h2><p>在SQL Server数据库中，可以通过<strong>DBCC SHOWCONTIG WITH ALL_INDEXES</strong>或<strong>DBCC SHOWCONTIG(表ID或者表名) WITH ALL_INDEXES</strong>来检查索引碎片情况</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 方法一</span></span>
<span class="line"><span style="color:#6A737D;">-- 目标数据库</span></span>
<span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> DB_NAME</span></span>
<span class="line"><span style="color:#6A737D;">-- 创建变量指定要查看的表</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @TABLE_ID </span><span style="color:#F97583;">INT</span></span>
<span class="line"><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @TABLE_ID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;TABLE_NAME&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#6A737D;">-- 执行</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC SHOWCONTIG(@TABLE_ID) </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ALL_INDEXES</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 方法二</span></span>
<span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> DB_NAME</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC SHOWCONTIG(</span><span style="color:#9ECBFF;">&#39;TABLE_NAME&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ALL_INDEXES</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 方法一</span></span>
<span class="line"><span style="color:#6A737D;">-- 目标数据库</span></span>
<span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> DB_NAME</span></span>
<span class="line"><span style="color:#6A737D;">-- 创建变量指定要查看的表</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @TABLE_ID </span><span style="color:#D73A49;">INT</span></span>
<span class="line"><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @TABLE_ID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;TABLE_NAME&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6A737D;">-- 执行</span></span>
<span class="line"><span style="color:#24292E;">DBCC SHOWCONTIG(@TABLE_ID) </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ALL_INDEXES</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 方法二</span></span>
<span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> DB_NAME</span></span>
<span class="line"><span style="color:#24292E;">DBCC SHOWCONTIG(</span><span style="color:#032F62;">&#39;TABLE_NAME&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ALL_INDEXES</span></span></code></pre></div><h2 id="_2-索引碎片判断标准" tabindex="-1">2.索引碎片判断标准 <a class="header-anchor" href="#_2-索引碎片判断标准" aria-label="Permalink to &quot;2.索引碎片判断标准&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> DB_NAME</span></span>
<span class="line"><span style="color:#E1E4E8;">DBCC SHOWCONTIG(</span><span style="color:#9ECBFF;">&#39;TABLE_NAME&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ALL_INDEXES</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> DB_NAME</span></span>
<span class="line"><span style="color:#24292E;">DBCC SHOWCONTIG(</span><span style="color:#032F62;">&#39;TABLE_NAME&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ALL_INDEXES</span></span></code></pre></div><p>通过对逻辑扫描碎片（过高）、平均页密度(满)（过低）的结果分析，判定是否需要进行索引处理，如下所示：</p><p><strong>逻辑扫描碎片</strong> ..................：97.83% 该百分比应该在0%到10%之间，高了则说明有外部碎片。</p><p><strong>平均页密度(满)</strong> ..................：62.42% 该百分比应该尽可能靠近100%，低了则说明有外部碎片</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">DBCC SHOWCONTIG 正在扫描 </span><span style="color:#9ECBFF;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#E1E4E8;"> 表...</span></span>
<span class="line"><span style="color:#E1E4E8;">表: </span><span style="color:#9ECBFF;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1957582012</span><span style="color:#E1E4E8;">)；索引 ID: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">，数据库 ID: </span><span style="color:#79B8FF;">29</span></span>
<span class="line"><span style="color:#E1E4E8;">已执行 </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> 级别的扫描。</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描页数................................: </span><span style="color:#79B8FF;">26485</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描区数..............................: </span><span style="color:#79B8FF;">3312</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 区切换次数..............................: </span><span style="color:#79B8FF;">3311</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 每个区的平均页数........................: </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 扫描密度 [最佳计数:实际计数].......: </span><span style="color:#79B8FF;">99</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">97</span><span style="color:#E1E4E8;">% [3311:3312]</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 区扫描碎片 ..................: </span><span style="color:#79B8FF;">63</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">53</span><span style="color:#E1E4E8;">%</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 每页的平均可用字节数.....................: </span><span style="color:#79B8FF;">375</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">9</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> 平均页密度(满).....................: </span><span style="color:#79B8FF;">95</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">36</span><span style="color:#E1E4E8;">%</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">DBCC SHOWCONTIG 正在扫描 </span><span style="color:#032F62;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#24292E;"> 表...</span></span>
<span class="line"><span style="color:#24292E;">表: </span><span style="color:#032F62;">&#39;FundAccountMoneyFlow&#39;</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1957582012</span><span style="color:#24292E;">)；索引 ID: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">，数据库 ID: </span><span style="color:#005CC5;">29</span></span>
<span class="line"><span style="color:#24292E;">已执行 </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> 级别的扫描。</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描页数................................: </span><span style="color:#005CC5;">26485</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描区数..............................: </span><span style="color:#005CC5;">3312</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 区切换次数..............................: </span><span style="color:#005CC5;">3311</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 每个区的平均页数........................: </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 扫描密度 [最佳计数:实际计数].......: </span><span style="color:#005CC5;">99</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">97</span><span style="color:#24292E;">% [3311:3312]</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 区扫描碎片 ..................: </span><span style="color:#005CC5;">63</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">53</span><span style="color:#24292E;">%</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 每页的平均可用字节数.....................: </span><span style="color:#005CC5;">375</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">9</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;"> 平均页密度(满).....................: </span><span style="color:#005CC5;">95</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">36</span><span style="color:#24292E;">%</span></span></code></pre></div><h1 id="四、优化实践" tabindex="-1">四、优化实践 <a class="header-anchor" href="#四、优化实践" aria-label="Permalink to &quot;四、优化实践&quot;">​</a></h1><h2 id="手动方式" tabindex="-1">手动方式 <a class="header-anchor" href="#手动方式" aria-label="Permalink to &quot;手动方式&quot;">​</a></h2><p>第一步：查询数据库所有表的索引信息</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_name</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">) 表名,</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">NAME</span><span style="color:#E1E4E8;"> 索引名称,</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_TYPE_DESC</span><span style="color:#E1E4E8;"> 索引类型,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">ROUND</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) 碎片率</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_index_physical_stats</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">DB_ID</span><span style="color:#E1E4E8;">(), </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">) A </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> B </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">30</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--AND A.AVG_FRAGMENTATION_IN_PERCENT&gt;5 AND A.AVG_FRAGMENTATION_IN_PERCENT&lt;=30</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_name</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">) 表名,</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">NAME</span><span style="color:#24292E;"> 索引名称,</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_TYPE_DESC</span><span style="color:#24292E;"> 索引类型,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">ROUND</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) 碎片率</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_index_physical_stats</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">DB_ID</span><span style="color:#24292E;">(), </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">) A </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> B </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">30</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--AND A.AVG_FRAGMENTATION_IN_PERCENT&gt;5 AND A.AVG_FRAGMENTATION_IN_PERCENT&lt;=30</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141020614.jpg" alt=""></p><blockquote><p>注：通过碎片率，依<strong>4、注意事项</strong>处理方式，也可以逐个对表的索引进行对应的重新生成或重新组织处理</p></blockquote><p>第二步：生成数据库所有表的索引处理的SQL语句</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_name</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_SCHEMA_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">) 架构,</span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">) 表名,</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">NAME</span><span style="color:#E1E4E8;"> 索引名,</span><span style="color:#79B8FF;">ROUND</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) 碎片率,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;重新生成索引&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;重新组织索引&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> 处理方式,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&#39;ALTER INDEX &#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">NAME</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39; ON &#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">OBJECT_SCHEMA_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39; &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">+CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;REBUILD&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;REORGANIZE&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> 生成SQL语句</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_index_physical_stats</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">DB_ID</span><span style="color:#E1E4E8;">(),</span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">) A </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> B </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- AND OBJECT_NAME(B.OBJECT_ID) IN (&#39;dept&#39;)    --指定表</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;重新生成索引&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;重新组织索引&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_name</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_SCHEMA_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">) 架构,</span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">) 表名,</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">NAME</span><span style="color:#24292E;"> 索引名,</span><span style="color:#005CC5;">ROUND</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) 碎片率,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;重新生成索引&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;重新组织索引&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> 处理方式,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&#39;ALTER INDEX &#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">NAME</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39; ON &#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">OBJECT_SCHEMA_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39; &#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">+CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;REBUILD&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;REORGANIZE&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> 生成SQL语句</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_index_physical_stats</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">DB_ID</span><span style="color:#24292E;">(),</span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">) A </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> B </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- AND OBJECT_NAME(B.OBJECT_ID) IN (&#39;dept&#39;)    --指定表</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;重新生成索引&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;重新组织索引&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141021667.jpg" alt=""></p><h3 id="重新创建索引" tabindex="-1">重新创建索引 <a class="header-anchor" href="#重新创建索引" aria-label="Permalink to &quot;重新创建索引&quot;">​</a></h3><p>有点小问题</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_NAME</span></span>
<span class="line"><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">nocount</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">--使用游标重新组织指定库中的索引,消除索引碎片  </span></span>
<span class="line"><span style="color:#6A737D;">--R_T层游标取出当前数据库所有表  </span></span>
<span class="line"><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> R_T </span><span style="color:#F97583;">cursor</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tables</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @T </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;">)  </span></span>
<span class="line"><span style="color:#F97583;">open</span><span style="color:#E1E4E8;"> r_t  </span></span>
<span class="line"><span style="color:#F97583;">fetch</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">next</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> r_t </span><span style="color:#F97583;">into</span><span style="color:#E1E4E8;"> @t  </span></span>
<span class="line"><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> @@fetch_status</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">begin</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--R_index游标判断指定表索引碎片情况并优化  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> R_Index </span><span style="color:#F97583;">cursor</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">avg_fragmentation_in_percent</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tables</span><span style="color:#E1E4E8;"> t  </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">join</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">join</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_index_physical_stats</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">db_id</span><span style="color:#E1E4E8;">(),</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">(@T),</span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;limited&#39;</span><span style="color:#E1E4E8;">) s  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @TName </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;">),@IName </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;">),@avg </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">,@str </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">500</span><span style="color:#E1E4E8;">)  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">open</span><span style="color:#E1E4E8;"> r_index  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">fetch</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">next</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> r_index </span><span style="color:#F97583;">into</span><span style="color:#E1E4E8;"> @TName,@Iname,@avg  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> @@fetch_status</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">begin</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> @avg</span><span style="color:#F97583;">&gt;=</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--如果碎片大于30,重建索引  </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">begin</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @str</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;alter index &#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">rtrim</span><span style="color:#E1E4E8;">(@Iname)</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39; on dbo.&#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">quotename</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">rtrim</span><span style="color:#E1E4E8;">(@tname))</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39; rebuild&#39;</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">--如果碎片小于30,重新组织索引  </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">begin</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @STR</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;alter index &#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">rtrim</span><span style="color:#E1E4E8;">(@Iname)</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39; on dbo.&#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">quotename</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">rtrim</span><span style="color:#E1E4E8;">(@tname))</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39; reorganize&#39;</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">print</span><span style="color:#E1E4E8;"> @str  </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> (@str)  </span><span style="color:#6A737D;">--执行  </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">fetch</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">next</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> r_index </span><span style="color:#F97583;">into</span><span style="color:#E1E4E8;"> @TName,@Iname,@avg  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--结束r_index游标  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">close</span><span style="color:#E1E4E8;"> r_index  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">deallocate</span><span style="color:#E1E4E8;"> r_index  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">fetch</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">next</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> r_t </span><span style="color:#F97583;">into</span><span style="color:#E1E4E8;"> @t  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--结束R_T游标  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">close</span><span style="color:#E1E4E8;"> r_t  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">deallocate</span><span style="color:#E1E4E8;"> r_t  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">nocount</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">off</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_NAME</span></span>
<span class="line"><span style="color:#D73A49;">set</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">nocount</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">on</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#6A737D;">--使用游标重新组织指定库中的索引,消除索引碎片  </span></span>
<span class="line"><span style="color:#6A737D;">--R_T层游标取出当前数据库所有表  </span></span>
<span class="line"><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> R_T </span><span style="color:#D73A49;">cursor</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tables</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @T </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">50</span><span style="color:#24292E;">)  </span></span>
<span class="line"><span style="color:#D73A49;">open</span><span style="color:#24292E;"> r_t  </span></span>
<span class="line"><span style="color:#D73A49;">fetch</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">next</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> r_t </span><span style="color:#D73A49;">into</span><span style="color:#24292E;"> @t  </span></span>
<span class="line"><span style="color:#D73A49;">while</span><span style="color:#24292E;"> @@fetch_status</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">begin</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">--R_index游标判断指定表索引碎片情况并优化  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> R_Index </span><span style="color:#D73A49;">cursor</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">avg_fragmentation_in_percent</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tables</span><span style="color:#24292E;"> t  </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">join</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">join</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_index_physical_stats</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">db_id</span><span style="color:#24292E;">(),</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">(@T),</span><span style="color:#D73A49;">null</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">null</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;limited&#39;</span><span style="color:#24292E;">) s  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @TName </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">50</span><span style="color:#24292E;">),@IName </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">50</span><span style="color:#24292E;">),@avg </span><span style="color:#D73A49;">int</span><span style="color:#24292E;">,@str </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">500</span><span style="color:#24292E;">)  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">open</span><span style="color:#24292E;"> r_index  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">fetch</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">next</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> r_index </span><span style="color:#D73A49;">into</span><span style="color:#24292E;"> @TName,@Iname,@avg  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> @@fetch_status</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">begin</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> @avg</span><span style="color:#D73A49;">&gt;=</span><span style="color:#005CC5;">30</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">--如果碎片大于30,重建索引  </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">begin</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @str</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;alter index &#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">rtrim</span><span style="color:#24292E;">(@Iname)</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39; on dbo.&#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">quotename</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">rtrim</span><span style="color:#24292E;">(@tname))</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39; rebuild&#39;</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">else</span><span style="color:#24292E;">   </span><span style="color:#6A737D;">--如果碎片小于30,重新组织索引  </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">begin</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @STR</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;alter index &#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">rtrim</span><span style="color:#24292E;">(@Iname)</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39; on dbo.&#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">quotename</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">rtrim</span><span style="color:#24292E;">(@tname))</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39; reorganize&#39;</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">print</span><span style="color:#24292E;"> @str  </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> (@str)  </span><span style="color:#6A737D;">--执行  </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">fetch</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">next</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> r_index </span><span style="color:#D73A49;">into</span><span style="color:#24292E;"> @TName,@Iname,@avg  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">--结束r_index游标  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">close</span><span style="color:#24292E;"> r_index  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">deallocate</span><span style="color:#24292E;"> r_index  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">fetch</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">next</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> r_t </span><span style="color:#D73A49;">into</span><span style="color:#24292E;"> @t  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">--结束R_T游标  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">close</span><span style="color:#24292E;"> r_t  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">deallocate</span><span style="color:#24292E;"> r_t  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">nocount</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">off</span></span></code></pre></div><h2 id="自动方式" tabindex="-1">自动方式 <a class="header-anchor" href="#自动方式" aria-label="Permalink to &quot;自动方式&quot;">​</a></h2><p>第一步：在服务中启动SQL Server 代理</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141021926.jpg" alt=""></p><p>第二步：点击&quot;管理&quot;-&gt;右键&quot;维护计划&quot;-&gt;&quot;新建维护计划&quot;</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141021850.jpg" alt=""></p><p>第三步：起个名字，点击&quot;确定&quot;</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141021520.jpg" alt=""></p><p>第四步：点击左侧&quot;工具箱&quot;，将&quot;重新生成索引&quot;及&quot;重新组织索引&quot;拖至右边区域</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141021566.jpg" alt=""></p><p>第五步：分别对着&quot;重新生成索引&quot;及&quot;重新组织索引&quot;点击右键-&gt;&quot;编辑&quot;-&gt;在&quot;数据库&quot;项勾选要处理的数据库-&gt;点击&quot;确定&quot;</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141022899.jpg" alt=""></p><p>第六步：点击&quot;新建作业计划&quot;按钮-&gt;设置频率及执行时间-&gt;点击&quot;确定&quot;</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141022196.jpg" alt=""></p><p>第七步：点击&quot;保存选定项&quot;即可</p><h2 id="更新统计信息" tabindex="-1">更新统计信息 <a class="header-anchor" href="#更新统计信息" aria-label="Permalink to &quot;更新统计信息&quot;">​</a></h2><p>作用：UPDATE STATISTICS更新统计信息来提高查询效率。建议放在索引碎片计划任务执行完成之后进行</p><p>查看：查看某个表的统计信息，可以在SSMS下面查看</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141023287.jpg" alt=""></p><p>执行：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">--方法一：UPDATE STATISTICS 表名</span></span>
<span class="line"><span style="color:#e1e4e8;">UPDATE STATISTICS INVMB</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--方法二：执行存储过程SP_UPDATESTATS(更新所有表)</span></span>
<span class="line"><span style="color:#e1e4e8;">EXEC sp_updatestats</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">--方法一：UPDATE STATISTICS 表名</span></span>
<span class="line"><span style="color:#24292e;">UPDATE STATISTICS INVMB</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--方法二：执行存储过程SP_UPDATESTATS(更新所有表)</span></span>
<span class="line"><span style="color:#24292e;">EXEC sp_updatestats</span></span></code></pre></div><blockquote><p>建议不要过于频繁地执行重新生成、重新组织索引以及更新统计信息。另外需要补充的是，非常低数据量与非常低碎片级别一样，通过这些命令来解决，效果甚微</p></blockquote>`,85),e=[o];function c(t,E,r,y,F,C){return n(),a("div",null,e)}const D=s(p,[["render",c]]);export{A as __pageData,D as default};
