import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const u=JSON.parse('{"title":"1. 查看版本下载工具","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/备份/etcd备份.md","filePath":"guide/container/k8s/备份/etcd备份.md","lastUpdated":1720606881000}'),p={name:"guide/container/k8s/备份/etcd备份.md"},e=l(`<p>由于kubeadm部署的kubernetes是以容器形式运行etcd，所以在系统中没有<code>etcdctl</code>的命令，如果需要在系统中备份，则可以下载etcd二进制包来使用<code>etcdctl</code>命令。</p><h1 id="_1-查看版本下载工具" tabindex="-1">1. 查看版本下载工具 <a class="header-anchor" href="#_1-查看版本下载工具" aria-label="Permalink to &quot;1. 查看版本下载工具&quot;">​</a></h1><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># kubectl exec -it -n kube-system etcd-k8s-master01 -- etcdctl version</span></span>
<span class="line"><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">version:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3.5</span><span style="color:#9ECBFF;">.4</span></span>
<span class="line"><span style="color:#B392F0;">API</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">version:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3.5</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># kubectl exec -it -n kube-system etcd-k8s-master01 -- etcdctl version</span></span>
<span class="line"><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">version:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3.5</span><span style="color:#032F62;">.4</span></span>
<span class="line"><span style="color:#6F42C1;">API</span><span style="color:#24292E;"> </span><span style="color:#032F62;">version:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3.5</span></span></code></pre></div><p>查看到3.5.4版本后，在github下载二进制包，然后把<code>etcdctl</code>复制到系统环境变量中：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://github.com/etcd-io/etcd/releases/download/v3.5.4/etcd-v3.5.4-linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#B392F0;">tar</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-xzf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd-v3.5.4-linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#B392F0;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-a</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd-v3.5.4-linux-amd64/etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/bin/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://github.com/etcd-io/etcd/releases/download/v3.5.4/etcd-v3.5.4-linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#6F42C1;">tar</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-xzf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd-v3.5.4-linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#6F42C1;">cp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-a</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd-v3.5.4-linux-amd64/etcdctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/bin/</span></span></code></pre></div><h1 id="_2-查看etcd配置信息" tabindex="-1">2. 查看etcd配置信息 <a class="header-anchor" href="#_2-查看etcd配置信息" aria-label="Permalink to &quot;2. 查看etcd配置信息&quot;">​</a></h1><p>查看/etc/kubernetes/manifests/etcd.yaml文件,获取证书</p><p>通过<code>command</code>中的<code>--cert-file</code>、<code>--key-file</code>、<code>--trusted-ca-file</code>获取到证书信息：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">--cert-file=/etc/kubernetes/pki/etcd/server.crt</span></span>
<span class="line"><span style="color:#e1e4e8;">--key-file=/etc/kubernetes/pki/etcd/server.key</span></span>
<span class="line"><span style="color:#e1e4e8;">--trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">--cert-file=/etc/kubernetes/pki/etcd/server.crt</span></span>
<span class="line"><span style="color:#24292e;">--key-file=/etc/kubernetes/pki/etcd/server.key</span></span>
<span class="line"><span style="color:#24292e;">--trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</span></span></code></pre></div><p>使用<code>etcdctl endpoint health</code>测试连接</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># ETCDCTL_API=3 etcdctl --endpoints=&quot;https://127.0.0.1:2379&quot; --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key endpoint health</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">https://127.0.0.1:2379</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">healthy:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">successfully</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">committed</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">proposal:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">took</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">24.627386</span><span style="color:#9ECBFF;">ms</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># ETCDCTL_API=3 etcdctl --endpoints=&quot;https://127.0.0.1:2379&quot; --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key endpoint health</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">https://127.0.0.1:2379</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">healthy:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">successfully</span><span style="color:#24292E;"> </span><span style="color:#032F62;">committed</span><span style="color:#24292E;"> </span><span style="color:#032F62;">proposal:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">took</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">24.627386</span><span style="color:#032F62;">ms</span></span></code></pre></div><h1 id="_3-备份" tabindex="-1">3. 备份 <a class="header-anchor" href="#_3-备份" aria-label="Permalink to &quot;3. 备份&quot;">​</a></h1><p>通过以上获取的信息，使用etcdctl备份到/opt/etcd-snapshot.db</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--endpoints=</span><span style="color:#9ECBFF;">&quot;https://127.0.0.1:2379&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--cacert=/etc/kubernetes/pki/etcd/ca.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--cert=/etc/kubernetes/pki/etcd/server.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--key=/etc/kubernetes/pki/etcd/server.key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">snapshot</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">save</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/opt/etcd-snapshot.db</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--endpoints=</span><span style="color:#032F62;">&quot;https://127.0.0.1:2379&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--cacert=/etc/kubernetes/pki/etcd/ca.crt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--cert=/etc/kubernetes/pki/etcd/server.crt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--key=/etc/kubernetes/pki/etcd/server.key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">snapshot</span><span style="color:#24292E;"> </span><span style="color:#032F62;">save</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/opt/etcd-snapshot.db</span></span></code></pre></div><p>最后提示<code>Snapshot saved at /opt/etcd-snapshot.db</code>表示备份成功。</p><ul><li>查看备份状态</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--endpoints=</span><span style="color:#9ECBFF;">&quot;https://127.0.0.1:2379&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--cacert=/etc/kubernetes/pki/etcd/ca.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--cert=/etc/kubernetes/pki/etcd/server.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--key=/etc/kubernetes/pki/etcd/server.key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">snapshot</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">status</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/opt/etcd-snapshot.db</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--endpoints=</span><span style="color:#032F62;">&quot;https://127.0.0.1:2379&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--cacert=/etc/kubernetes/pki/etcd/ca.crt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--cert=/etc/kubernetes/pki/etcd/server.crt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--key=/etc/kubernetes/pki/etcd/server.key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">snapshot</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/opt/etcd-snapshot.db</span></span></code></pre></div><h1 id="_4-还原" tabindex="-1">4. 还原 <a class="header-anchor" href="#_4-还原" aria-label="Permalink to &quot;4. 还原&quot;">​</a></h1><h2 id="_4-1-停止所有-api-服务实例" tabindex="-1">4.1 停止所有 API 服务实例 <a class="header-anchor" href="#_4-1-停止所有-api-服务实例" aria-label="Permalink to &quot;4.1 停止所有 API 服务实例&quot;">​</a></h2><p>在各个master节点停止所有的API服务，包括kube-apiserver、kube-controller-manager、kube-scheduler</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/opt/backup</span></span>
<span class="line"><span style="color:#B392F0;">mv</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/manifests/kube-</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/opt/backup/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/opt/backup</span></span>
<span class="line"><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/manifests/kube-</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/opt/backup/</span></span></code></pre></div><p>如果不确定,查看方式</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># systemctl status kubelet.service </span></span>
<span class="line"><span style="color:#B392F0;">●</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet.service</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">The</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Kubernetes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Agent</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">Loaded:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">loaded</span><span style="color:#E1E4E8;"> (/usr/lib/systemd/system/kubelet.service; </span><span style="color:#B392F0;">enabled</span><span style="color:#E1E4E8;">; </span><span style="color:#B392F0;">vendor</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">preset:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">disabled</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Drop-In:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/lib/systemd/system/kubelet.service.d</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#B392F0;">└─10-kubeadm.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">Active:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">active</span><span style="color:#E1E4E8;"> (running) since Thu 2023-02-23 16:38:26 CST; </span><span style="color:#B392F0;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">days</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ago</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">Docs:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://kubernetes.io/docs/</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PID:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1226</span><span style="color:#E1E4E8;"> (kubelet)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Tasks:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">15</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">Memory:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">83.2</span><span style="color:#9ECBFF;">M</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">CGroup:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/system.slice/kubelet.service</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#B392F0;">└─1226</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/bin/kubelet</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--kubeconfig=/etc/kubernetes/kubelet.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--config=/var/lib/kubelet/config.yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--container-runtime=remote</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># systemctl status kubelet.service </span></span>
<span class="line"><span style="color:#6F42C1;">●</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet.service</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">The</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Kubernetes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Agent</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">Loaded:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">loaded</span><span style="color:#24292E;"> (/usr/lib/systemd/system/kubelet.service; </span><span style="color:#6F42C1;">enabled</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">vendor</span><span style="color:#24292E;"> </span><span style="color:#032F62;">preset:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">disabled</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Drop-In:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/lib/systemd/system/kubelet.service.d</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6F42C1;">└─10-kubeadm.conf</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">Active:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">active</span><span style="color:#24292E;"> (running) since Thu 2023-02-23 16:38:26 CST; </span><span style="color:#6F42C1;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">days</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ago</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#6F42C1;">Docs:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://kubernetes.io/docs/</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PID:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1226</span><span style="color:#24292E;"> (kubelet)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Tasks:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">15</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">Memory:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">83.2</span><span style="color:#032F62;">M</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">CGroup:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/system.slice/kubelet.service</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6F42C1;">└─1226</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/bin/kubelet</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--kubeconfig=/etc/kubernetes/kubelet.conf</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--config=/var/lib/kubelet/config.yaml</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--container-runtime=remote</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--...</span></span></code></pre></div><p>显示的是/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf这个文件</p><ul><li>查看这个10-kubeadm.conf文件：</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># grep -Ev &#39;^#&#39; /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">[Service]</span></span>
<span class="line"><span style="color:#E1E4E8;">Environment</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">Environment</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">EnvironmentFile</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">-/var/lib/kubelet/kubeadm-flags.env</span></span>
<span class="line"><span style="color:#E1E4E8;">EnvironmentFile</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">-/etc/sysconfig/kubelet</span></span>
<span class="line"><span style="color:#E1E4E8;">ExecStart</span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">ExecStart</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/usr/bin/kubelet</span><span style="color:#E1E4E8;"> $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># grep -Ev &#39;^#&#39; /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span></span>
<span class="line"><span style="color:#24292E;">[Service]</span></span>
<span class="line"><span style="color:#24292E;">Environment</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span></span>
<span class="line"><span style="color:#24292E;">Environment</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span></span>
<span class="line"><span style="color:#24292E;">EnvironmentFile</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">-/var/lib/kubelet/kubeadm-flags.env</span></span>
<span class="line"><span style="color:#24292E;">EnvironmentFile</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">-/etc/sysconfig/kubelet</span></span>
<span class="line"><span style="color:#24292E;">ExecStart</span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">ExecStart</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/usr/bin/kubelet</span><span style="color:#24292E;"> $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS</span></span></code></pre></div><p>在<code>KUBELET_CONFIG_ARGS</code>中看到引入了另一个文件</p><p>查看 <code>cat /var/lib/kubelet/config.yaml</code>查看配置文件</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#85E89D;">authentication</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">anonymous</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">enabled</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">webhook</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">cacheTTL</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">enabled</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">x509</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">clientCAFile</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/ca.crt</span></span>
<span class="line"><span style="color:#85E89D;">authorization</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">mode</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Webhook</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">webhook</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">cacheAuthorizedTTL</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">cacheUnauthorizedTTL</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0s</span></span>
<span class="line"><span style="color:#85E89D;">cgroupDriver</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">systemd</span></span>
<span class="line"><span style="color:#85E89D;">clusterDNS</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#79B8FF;">192.168.0.10</span></span>
<span class="line"><span style="color:#85E89D;">clusterDomain</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cluster.local</span></span>
<span class="line"><span style="color:#85E89D;">cpuManagerReconcilePeriod</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0s</span></span>
<span class="line"><span style="color:#85E89D;">evictionPressureTransitionPeriod</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0s</span></span>
<span class="line"><span style="color:#85E89D;">fileCheckFrequency</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0s</span></span>
<span class="line"><span style="color:#85E89D;">healthzBindAddress</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">127.0.0.1</span></span>
<span class="line"><span style="color:#85E89D;">healthzPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10248</span></span>
<span class="line"><span style="color:#85E89D;">httpCheckFrequency</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0s</span></span>
<span class="line"><span style="color:#85E89D;">imageMinimumGCAge</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0s</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">KubeletConfiguration</span></span>
<span class="line"><span style="color:#85E89D;">logging</span><span style="color:#E1E4E8;">: {}</span></span>
<span class="line"><span style="color:#85E89D;">memorySwap</span><span style="color:#E1E4E8;">: {}</span></span>
<span class="line"><span style="color:#85E89D;">nodeStatusReportFrequency</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0s</span></span>
<span class="line"><span style="color:#85E89D;">nodeStatusUpdateFrequency</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0s</span></span>
<span class="line"><span style="color:#85E89D;">rotateCertificates</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#85E89D;">runtimeRequestTimeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0s</span></span>
<span class="line"><span style="color:#85E89D;">shutdownGracePeriod</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0s</span></span>
<span class="line"><span style="color:#85E89D;">shutdownGracePeriodCriticalPods</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0s</span></span>
<span class="line"><span style="color:#85E89D;">staticPodPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/kubernetes/manifests</span></span>
<span class="line"><span style="color:#85E89D;">streamingConnectionIdleTimeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0s</span></span>
<span class="line"><span style="color:#85E89D;">syncFrequency</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0s</span></span>
<span class="line"><span style="color:#85E89D;">volumeStatsAggPeriod</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#22863A;">authentication</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">anonymous</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">enabled</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">webhook</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">cacheTTL</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">enabled</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">x509</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">clientCAFile</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/kubernetes/pki/ca.crt</span></span>
<span class="line"><span style="color:#22863A;">authorization</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">mode</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Webhook</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">webhook</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">cacheAuthorizedTTL</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">cacheUnauthorizedTTL</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0s</span></span>
<span class="line"><span style="color:#22863A;">cgroupDriver</span><span style="color:#24292E;">: </span><span style="color:#032F62;">systemd</span></span>
<span class="line"><span style="color:#22863A;">clusterDNS</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#005CC5;">192.168.0.10</span></span>
<span class="line"><span style="color:#22863A;">clusterDomain</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cluster.local</span></span>
<span class="line"><span style="color:#22863A;">cpuManagerReconcilePeriod</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0s</span></span>
<span class="line"><span style="color:#22863A;">evictionPressureTransitionPeriod</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0s</span></span>
<span class="line"><span style="color:#22863A;">fileCheckFrequency</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0s</span></span>
<span class="line"><span style="color:#22863A;">healthzBindAddress</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">127.0.0.1</span></span>
<span class="line"><span style="color:#22863A;">healthzPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10248</span></span>
<span class="line"><span style="color:#22863A;">httpCheckFrequency</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0s</span></span>
<span class="line"><span style="color:#22863A;">imageMinimumGCAge</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0s</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">KubeletConfiguration</span></span>
<span class="line"><span style="color:#22863A;">logging</span><span style="color:#24292E;">: {}</span></span>
<span class="line"><span style="color:#22863A;">memorySwap</span><span style="color:#24292E;">: {}</span></span>
<span class="line"><span style="color:#22863A;">nodeStatusReportFrequency</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0s</span></span>
<span class="line"><span style="color:#22863A;">nodeStatusUpdateFrequency</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0s</span></span>
<span class="line"><span style="color:#22863A;">rotateCertificates</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#22863A;">runtimeRequestTimeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0s</span></span>
<span class="line"><span style="color:#22863A;">shutdownGracePeriod</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0s</span></span>
<span class="line"><span style="color:#22863A;">shutdownGracePeriodCriticalPods</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0s</span></span>
<span class="line"><span style="color:#22863A;">staticPodPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/kubernetes/manifests</span></span>
<span class="line"><span style="color:#22863A;">streamingConnectionIdleTimeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0s</span></span>
<span class="line"><span style="color:#22863A;">syncFrequency</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0s</span></span>
<span class="line"><span style="color:#22863A;">volumeStatsAggPeriod</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0s</span></span></code></pre></div><h2 id="_4-2-在所有-etcd-实例中恢复状态" tabindex="-1">4.2 在所有 etcd 实例中恢复状态 <a class="header-anchor" href="#_4-2-在所有-etcd-实例中恢复状态" aria-label="Permalink to &quot;4.2 在所有 etcd 实例中恢复状态&quot;">​</a></h2><p>停止后，进行恢复etcd：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--endpoints=</span><span style="color:#9ECBFF;">&quot;https://127.0.0.1:2379&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--cacert=/etc/kubernetes/pki/etcd/ca.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--cert=/etc/kubernetes/pki/etcd/server.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--key=/etc/kubernetes/pki/etcd/server.key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">snapshot</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restore</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/opt/etcd-snapshot.db</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--data-dir=/var/lib/etcd</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--endpoints=</span><span style="color:#032F62;">&quot;https://127.0.0.1:2379&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--cacert=/etc/kubernetes/pki/etcd/ca.crt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--cert=/etc/kubernetes/pki/etcd/server.crt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--key=/etc/kubernetes/pki/etcd/server.key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">snapshot</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restore</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/opt/etcd-snapshot.db</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--data-dir=/var/lib/etcd</span></span></code></pre></div><p>这一步在3以前的版本中或许需要<code>--skip-hash-check</code>来忽略hash的检验</p><blockquote><p>如果修改了etcd路径,记得修改pod中的挂载路径</p></blockquote><h2 id="_4-3-重启所有-api-服务实例" tabindex="-1">4.3 重启所有 API 服务实例 <a class="header-anchor" href="#_4-3-重启所有-api-服务实例" aria-label="Permalink to &quot;4.3 重启所有 API 服务实例&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">mv</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/opt/backup/</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/manifests</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/opt/backup/</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/manifests</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet</span></span></code></pre></div>`,36),o=[e];function t(c,r,y,E,i,d){return n(),a("div",null,o)}const b=s(p,[["render",t]]);export{u as __pageData,b as default};
