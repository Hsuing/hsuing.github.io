import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const g=JSON.parse('{"title":"1. relabeling","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Linux/Monitor/Prometheus/4-promql_relabel.md","filePath":"guide/Linux/Monitor/Prometheus/4-promql_relabel.md","lastUpdated":1739528109000}'),p={name:"guide/Linux/Monitor/Prometheus/4-promql_relabel.md"},e=l(`<h1 id="_1-relabeling" tabindex="-1">1. relabeling <a class="header-anchor" href="#_1-relabeling" aria-label="Permalink to &quot;1. relabeling&quot;">​</a></h1><h2 id="_1-1-relabel简介" tabindex="-1">1.1 relabel简介 <a class="header-anchor" href="#_1-1-relabel简介" aria-label="Permalink to &quot;1.1 relabel简介&quot;">​</a></h2><p>Relabeling 是一个强大的工具，它允许你通过重写标签集来分类和过滤Prometheus<code>Target/目标</code>和<code>Metric/指标</code>。</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202412261430118.png" alt="image-20241226143000386"></p><h2 id="_1-2-relabel目的" tabindex="-1">1.2 relabel目的 <a class="header-anchor" href="#_1-2-relabel目的" aria-label="Permalink to &quot;1.2 relabel目的&quot;">​</a></h2><p>如何将指标量级降维和重组</p><ul><li><strong>要保留的数据</strong>：这涉及保留一组明确定义的重要指标和标签，并删除其他所有内容。要将指标和标签列入白名单，首先应该明确哪些核心指标和标签是希望保留的。要在Prometheus中启用白名单，需要配合relabeling action的<code>keep</code>和<code>labelkeep</code>来操作。</li><li><strong>可丢弃的数据</strong>：这涉及删除你需要明确定义的一组不重要指标，并保留其他所有指标。一旦确定了要删除的高基数指标和标签列表，拒绝名单就可能需要被使用。要在 Prometheus 中启用黑名单，需要配合relabeling action的<code>drop</code>和<code>labeldrop</code>来操作。</li></ul><div class="warning custom-block"><p class="custom-block-title">💡 说明</p><p>记住一点，我们有两个阶段可以重新标记。</p><p>第一阶段是对来自服务发现的目标进行重新标记，这是对于来自服务发现的元数据标签中的信息应用于指标上的标签来说非常有用。</p><p>第二阶段是抓取指标之后但是在存储系统之前。这样就可以确定哪些指标需要保存，哪些需要丢弃以及这些指标的样式。</p><p>抓取之前使用relabel_configs，抓取之后使用metrics_relabel_configs</p></div><h2 id="_1-3-生命周期" tabindex="-1">1.3 生命周期 <a class="header-anchor" href="#_1-3-生命周期" aria-label="Permalink to &quot;1.3 生命周期&quot;">​</a></h2><h2 id="_1-4-原理" tabindex="-1">1.4 原理 <a class="header-anchor" href="#_1-4-原理" aria-label="Permalink to &quot;1.4 原理&quot;">​</a></h2><p>重新标记标签作用:</p><p>1、动态生成新标签 根据已有的标签生成新标签</p><p>2、过滤采集的Target</p><p>3、删除不需要或者敏感标签</p><p>4、添加新标签</p><h2 id="_1-5-relabel四种方式" tabindex="-1">1.5 relabel四种方式 <a class="header-anchor" href="#_1-5-relabel四种方式" aria-label="Permalink to &quot;1.5 relabel四种方式&quot;">​</a></h2><h3 id="_1-relabel-config" tabindex="-1">1.relabel_config <a class="header-anchor" href="#_1-relabel-config" aria-label="Permalink to &quot;1.relabel_config&quot;">​</a></h3><p>重新标记（Relabeling）是一个可以在抓取目标（target）数据之前，动态修改目标的标签集的强大工具。每个抓取（scrape）配置可以定义多个重新标记步骤。它们按照在配置文件中的出现顺序应用于每个目标的标签集。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">relabel_config</span></span>
<span class="line"><span style="color:#B392F0;">在被prometheus抓取之前修改，针对的是target</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">relabel_config</span></span>
<span class="line"><span style="color:#6F42C1;">在被prometheus抓取之前修改，针对的是target</span></span></code></pre></div><h3 id="_2-metric-relabel-configs" tabindex="-1">2.metric_relabel_configs <a class="header-anchor" href="#_2-metric-relabel-configs" aria-label="Permalink to &quot;2.metric_relabel_configs&quot;">​</a></h3><p>指标重新标记（Metric relabeling）是在摄取（ingestion）之前最后一步对样本（samples）应用的。它具有与目标重标记（relabel_configs）相同的配置格式和操作。指标重标记不适用于自动生成的时间序列，例如 up。</p><p>这样做的一个用途是排除那些摄取成本过高的时间序列。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">metric_relabel_configs</span></span>
<span class="line"><span style="color:#e1e4e8;">在被prometheus存储之前修改，针对的是metric</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">metric_relabel_configs</span></span>
<span class="line"><span style="color:#24292e;">在被prometheus存储之前修改，针对的是metric</span></span></code></pre></div><h3 id="_3-alert-relabel-configs" tabindex="-1">3.alert_relabel_configs <a class="header-anchor" href="#_3-alert-relabel-configs" aria-label="Permalink to &quot;3.alert_relabel_configs&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">alert_relabel_configs</span></span>
<span class="line"><span style="color:#e1e4e8;">在被发送到alertmanager之前，针对的是alert</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">alert_relabel_configs</span></span>
<span class="line"><span style="color:#24292e;">在被发送到alertmanager之前，针对的是alert</span></span></code></pre></div><h3 id="_4-write-relabel-configs" tabindex="-1">4.write_relabel_configs <a class="header-anchor" href="#_4-write-relabel-configs" aria-label="Permalink to &quot;4.write_relabel_configs&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">write_relabel_configs</span></span>
<span class="line"><span style="color:#e1e4e8;">写到远程存储的样本</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">write_relabel_configs</span></span>
<span class="line"><span style="color:#24292e;">写到远程存储的样本</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202412261416188.png" alt="Relabeling"></p><h3 id="_5-relabel-configs-和-metric-relabel-configs-区别" tabindex="-1">5.relabel_configs 和 metric_relabel_configs 区别 <a class="header-anchor" href="#_5-relabel-configs-和-metric-relabel-configs-区别" aria-label="Permalink to &quot;5.relabel_configs 和 metric_relabel_configs 区别&quot;">​</a></h3><ol><li>应用时间点不同：relabel_configs 用于在抓取目标之前对目标进行标签重写或筛选，而 metric_relabel_configs 在指标收集完成后进行操作。</li><li>操作的对象不同：relabel_configs 用于目标级别的操作，可以对目标进行标签的修改、生成和过滤；metric_relabel_configs 用于指标级别的操作，可以对指标的标签进行修改、生成和过滤。</li><li>使用场景不同：relabel_configs 适用于需要在抓取目标前进行标签的操作，例如修改抓取数据时默认使用的端口或路径；metric_relabel_configs 适用于需要在指标收集完成后对指标进行进一步处理，例如过滤掉不需要的标签或者基于现有标签创建新的标签。</li></ol><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>如果使用 metric_relabel_configs 基于现有标签创建新的标签，那么只有已经存在老标签的指标才会有新的标签，而不是所有指标中都会有。这是因为 metric_relabel_configs 中定义的操作是基于已存在的标签进行的。如果一个指标不包含这个特定的标签，那么相关的 metric_relabel_configs 配置就不会对它产生任何影响。</p></div><ul><li>Prometheus配置</li></ul><p><a href="https://prometheus.io/docs/prometheus/2.55/configuration/configuration/#relabel_config" target="_blank" rel="noreferrer">https://prometheus.io/docs/prometheus/2.55/configuration/configuration/#relabel_config</a></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">global</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#B392F0;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">rule_files</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#B392F0;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">scrape_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">sample_job_1</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:           </span><span style="color:#6A737D;"># &lt;-</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#79B8FF;">...</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#79B8FF;">...</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metric_relabel_configs</span><span style="color:#E1E4E8;">:    </span><span style="color:#6A737D;"># &lt;-</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#79B8FF;">...</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#79B8FF;">...</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">sample_job_2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">: [</span><span style="color:#79B8FF;">...</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metric_relabel_configs</span><span style="color:#E1E4E8;">:    </span><span style="color:#6A737D;"># &lt;-</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#79B8FF;">...</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">alerting</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">alert_relabel_configs</span><span style="color:#E1E4E8;">:       </span><span style="color:#6A737D;"># &lt;-</span></span>
<span class="line"><span style="color:#E1E4E8;">    [ - </span><span style="color:#9ECBFF;">&lt;relabel_config&gt; ...</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">alertmanagers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    [ - </span><span style="color:#9ECBFF;">&lt;alertmanager_config&gt; ...</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">remote_write</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">url</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">write_relabel_configs</span><span style="color:#E1E4E8;">:       </span><span style="color:#6A737D;"># &lt;-</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#79B8FF;">...</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#79B8FF;">...</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">global</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#6F42C1;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">rule_files</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#6F42C1;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">scrape_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">sample_job_1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:           </span><span style="color:#6A737D;"># &lt;-</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#005CC5;">...</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#005CC5;">...</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metric_relabel_configs</span><span style="color:#24292E;">:    </span><span style="color:#6A737D;"># &lt;-</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#005CC5;">...</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#005CC5;">...</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">sample_job_2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">: [</span><span style="color:#005CC5;">...</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metric_relabel_configs</span><span style="color:#24292E;">:    </span><span style="color:#6A737D;"># &lt;-</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#005CC5;">...</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">alerting</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">alert_relabel_configs</span><span style="color:#24292E;">:       </span><span style="color:#6A737D;"># &lt;-</span></span>
<span class="line"><span style="color:#24292E;">    [ - </span><span style="color:#032F62;">&lt;relabel_config&gt; ...</span><span style="color:#24292E;"> ]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">alertmanagers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    [ - </span><span style="color:#032F62;">&lt;alertmanager_config&gt; ...</span><span style="color:#24292E;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">remote_write</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">url</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">write_relabel_configs</span><span style="color:#24292E;">:       </span><span style="color:#6A737D;"># &lt;-</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#005CC5;">...</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#005CC5;">...</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">...</span></span></code></pre></div><h2 id="_1-6-relabeling规则" tabindex="-1">1.6 relabeling规则 <a class="header-anchor" href="#_1-6-relabeling规则" aria-label="Permalink to &quot;1.6 relabeling规则&quot;">​</a></h2><p>常用的在以下两个阶段可以重新标记：</p><p><code>relabel_configs</code>：在采集之前（比如在采集数据之前重新定义元标签），可以使用relabel_configs添加一些标签、也可以只采集特定目标或过滤目标</p><p><code>metric_relabel_configs</code>：如果是已经抓取到指标数据时，可以使用metric_relabel_configs做最后的重新标记和过滤</p><h3 id="_1-在线分析" tabindex="-1">1.在线分析 <a class="header-anchor" href="#_1-在线分析" aria-label="Permalink to &quot;1.在线分析&quot;">​</a></h3><p>Prom Labs 的<a href="https://relabeler.promlabs.com/" target="_blank" rel="noreferrer">Relabeler</a>工具在调试relabeling配置时可能会有所帮助,它可以让你直观地确认relabel配置实施的规则</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202412261410017.png" alt="image-20241226141032849"></p><h3 id="_2-语法" tabindex="-1">2.语法 <a class="header-anchor" href="#_2-语法" aria-label="Permalink to &quot;2.语法&quot;">​</a></h3><p>除了配置的每个目标标签之外，prometheus还会自动添加几个标签：</p><ul><li>默认matedata</li></ul><p><strong>job标签：设置为job_name相应的抓取配置的值。</strong></p><p><strong>instance标签：__address__设置为目标的地址<code>&lt;host&gt;:&lt;port&gt;</code>。重新标记后，如果在重新标记期间未设置标签，则默认将__address__标签值赋值给instance。</strong></p><p><strong><strong>schema</strong>：协议类型</strong></p><p><strong>__metrics_path：抓取指标数的url</strong></p><p><strong><strong>scrape_interval</strong>：scrape抓取数据时间间隔（秒）</strong></p><p><strong><strong>scrape_timeout</strong>：scrape超时时间（秒）</strong></p><ul><li>consul的metedata</li></ul><p>如果什么也不添加，默认只显示 job 及 instance 两个标签，其他标签都默认属于 <code>before relabeling</code> 下</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#源标签，需要在现有标签中已存在</span></span>
<span class="line"><span style="color:#E1E4E8;">[ </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;[&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;labelname&gt;</span><span style="color:#E1E4E8;"> [, </span><span style="color:#79B8FF;">...</span><span style="color:#E1E4E8;">] </span><span style="color:#9ECBFF;">&#39;]&#39;</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 多个源标签的分隔符;</span></span>
<span class="line"><span style="color:#E1E4E8;">[ </span><span style="color:#85E89D;">separator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&lt;string&gt; | default = ;</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 要替换的目标标签;</span></span>
<span class="line"><span style="color:#E1E4E8;">[ </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&lt;labelname&gt;</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 正则表达式，用于匹配源标签的值</span></span>
<span class="line"><span style="color:#E1E4E8;">[ </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&lt;regex&gt; | default = (.*)</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 源标签值取hash的模块;</span></span>
<span class="line"><span style="color:#E1E4E8;">[ </span><span style="color:#85E89D;">modulus</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&lt;uint64&gt;</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 当正则表达式匹配时，用于替换的值，$1代替正则匹配到的值；</span></span>
<span class="line"><span style="color:#E1E4E8;">[ </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&lt;string&gt; | default = $1</span><span style="color:#E1E4E8;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 基于正则匹配的动作</span></span>
<span class="line"><span style="color:#E1E4E8;">[ </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&lt;relabel_action&gt; | default = replace</span><span style="color:#E1E4E8;"> ]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#源标签，需要在现有标签中已存在</span></span>
<span class="line"><span style="color:#24292E;">[ </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;[&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;labelname&gt;</span><span style="color:#24292E;"> [, </span><span style="color:#005CC5;">...</span><span style="color:#24292E;">] </span><span style="color:#032F62;">&#39;]&#39;</span><span style="color:#24292E;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 多个源标签的分隔符;</span></span>
<span class="line"><span style="color:#24292E;">[ </span><span style="color:#22863A;">separator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&lt;string&gt; | default = ;</span><span style="color:#24292E;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 要替换的目标标签;</span></span>
<span class="line"><span style="color:#24292E;">[ </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&lt;labelname&gt;</span><span style="color:#24292E;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 正则表达式，用于匹配源标签的值</span></span>
<span class="line"><span style="color:#24292E;">[ </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&lt;regex&gt; | default = (.*)</span><span style="color:#24292E;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 源标签值取hash的模块;</span></span>
<span class="line"><span style="color:#24292E;">[ </span><span style="color:#22863A;">modulus</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&lt;uint64&gt;</span><span style="color:#24292E;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 当正则表达式匹配时，用于替换的值，$1代替正则匹配到的值；</span></span>
<span class="line"><span style="color:#24292E;">[ </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&lt;string&gt; | default = $1</span><span style="color:#24292E;"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 基于正则匹配的动作</span></span>
<span class="line"><span style="color:#24292E;">[ </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&lt;relabel_action&gt; | default = replace</span><span style="color:#24292E;"> ]</span></span></code></pre></div><p>Relabeling 规则主要由以下的一些配置属性组成:</p><table><thead><tr><th style="text-align:left;">参数</th><th style="text-align:left;">解释</th></tr></thead><tbody><tr><td style="text-align:left;">action</td><td style="text-align:left;">执行的relabeling动作，可选值包括 <code>replace</code>、<code>keep</code>、<code>drop</code>、<code>hashmod</code>、<code>labelmap</code>、<code>labeldrop</code> 、<code>labelkeep</code>，默认值为<code>replace</code></td></tr><tr><td style="text-align:left;">separator</td><td style="text-align:left;">分隔符，一个字符串，合并多个 source_labels 的值时使用的分隔符，默认为<code>;</code></td></tr><tr><td style="text-align:left;">source_labels</td><td style="text-align:left;">源标签，使用配置的分隔符串联的标签名称列表，并与提供的正则表达式进行匹配</td></tr><tr><td style="text-align:left;">target_label</td><td style="text-align:left;">指定要修改或新创建的目标标签的名称，当使用<code>replace</code>或者<code>hashmod</code>动作时，应该被覆盖的标签名</td></tr><tr><td style="text-align:left;"><a href="https://regexr.com/" target="_blank" rel="noreferrer">regex</a></td><td style="text-align:left;">定义一个正则表达式，用于匹配和筛选 source_labels 的值，默认为<code>(.*)</code></td></tr><tr><td style="text-align:left;">modulus</td><td style="text-align:left;">模数，串联的源标签哈希值的模，主要用于Prometheus水平分片</td></tr><tr><td style="text-align:left;">replacement</td><td style="text-align:left;">写在目标标签上，它可以参考由 regex 捕获的正则表达式捕获组，默认值为<code>$1</code></td></tr></tbody></table><p>关于relabel_config的action类型说明：</p><table><thead><tr><th style="text-align:left;">参数</th><th style="text-align:left;">解释</th></tr></thead><tbody><tr><td style="text-align:left;">replace</td><td style="text-align:left;">设置或替换/覆盖标签值，是默认的action</td></tr><tr><td style="text-align:left;">keep</td><td style="text-align:left;">满足特定条件的target进行采集，其他的不采集</td></tr><tr><td style="text-align:left;">drop</td><td style="text-align:left;">满足特定条件的target不采集，其他的采集</td></tr><tr><td style="text-align:left;">labeldrop</td><td style="text-align:left;">匹配regex所有标签名称，对匹配到的实例标签进行删除</td></tr><tr><td style="text-align:left;">labelkeep</td><td style="text-align:left;">匹配regex所有标签名称，对匹配到的实例标签进行保留</td></tr><tr><td style="text-align:left;">labelmap</td><td style="text-align:left;">正则匹配所有标签名，将匹配的标签值部分做为新标签名，原标签值 做为新标签的值</td></tr><tr><td style="text-align:left;">hashmod</td><td style="text-align:left;"><strong>使用hashmod计算source_labels的hash值并进行对比，基于自定义的模数取模，以实现对目标进行分类、重新赋值等功能</strong></td></tr><tr><td style="text-align:left;">lowercase</td><td style="text-align:left;">将连接的 source_labels 映射到它们的小写形式</td></tr><tr><td style="text-align:left;">uppercase</td><td style="text-align:left;">将连接的 source_labels 映射到它们的大写形式</td></tr></tbody></table><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>重定义标签并应用后，__开头的标签会被删除; 要临时存储值用于下一阶段的处理,使用__tmp开头的标签名,这种标签不会被Prometheus使用;</p></div><h4 id="relabel-configs-使用示例" tabindex="-1">relabel_configs 使用示例 <a class="header-anchor" href="#relabel-configs-使用示例" aria-label="Permalink to &quot;relabel_configs 使用示例&quot;">​</a></h4><p>1.添加机器</p><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myjob</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">honor_timestamps</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;10.103.236.199:9100&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">__machine_hostname__</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;node-01&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">__machine_idc__</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;idc-01&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myjob</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">honor_timestamps</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;10.103.236.199:9100&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">__machine_hostname__</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;node-01&#39;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">__machine_idc__</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;idc-01&#39;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202502141529410.png" alt="image-20250214152823836"></p><h4 id="replace替换" tabindex="-1">replace替换 <a class="header-anchor" href="#replace替换" aria-label="Permalink to &quot;replace替换&quot;">​</a></h4><p>将__machine_hostname__的值替换到新标签hostname</p><p>流程图</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202502141722358.png" alt="image-20250214172237438"></p><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myjob</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">honor_timestamps</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;10.103.236.199:9100&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">__machine_hostname__</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;node-01&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">__machine_idc__</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;idc-01&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__machine_hostname__</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;(.*)&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;$1&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;hostname&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myjob</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">honor_timestamps</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;10.103.236.199:9100&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">__machine_hostname__</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;node-01&#39;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">__machine_idc__</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;idc-01&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__machine_hostname__</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;(.*)&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;$1&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;hostname&quot;</span></span></code></pre></div><blockquote><p>source_labels 选择了需要的提取内容的源标签，然后会用 separator 将其标签值串行拼接起来，因为没有定义 separator，这里是默认的 ; 符号</p><p>经过正则匹配后，replacement 规定了 $1的结果，其中 $1 正则匹配结果的第一组，并把这个结果赋值给 hostname这个标签</p></blockquote><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202502141551721.png" alt="image-20250214155132145"></p><h4 id="keep示例" tabindex="-1">keep示例 <a class="header-anchor" href="#keep示例" aria-label="Permalink to &quot;keep示例&quot;">​</a></h4><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__machine_hostname__</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;(.*)-01&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;hostname&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;$1&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__machine_hostname__</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;(.*)-01&quot;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;hostname&quot;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;$1&#39;</span></span></code></pre></div><h4 id="labelmap使用示例" tabindex="-1">labelmap使用示例 <a class="header-anchor" href="#labelmap使用示例" aria-label="Permalink to &quot;labelmap使用示例&quot;">​</a></h4><p>重写新的标签hostname和idc，使用原有__machine_hostname__和__machine_idc__标签的值,换句话说，将 __<em>machine_hostname</em> 为前缀的标签，去除前缀后，将键值对作为最终标签</p><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myjob</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">honor_timestamps</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;10.103.236.199:9100&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">__machine_hostname__</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;node-01&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">__machine_idc__</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;idc-01&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">labelmap</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__machine_(.*)_</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myjob</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">honor_timestamps</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;10.103.236.199:9100&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">__machine_hostname__</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;node-01&#39;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">__machine_idc__</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;idc-01&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">labelmap</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__machine_(.*)_</span></span></code></pre></div><blockquote><p>这里不再依赖 source_labels，因为在 labelmap 里，regex 是对所有__machine_开头的标签匹配的</p></blockquote><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202502141602935.png" alt="image-20250214160207203"></p><h4 id="uppercase示例" tabindex="-1">uppercase示例 <a class="header-anchor" href="#uppercase示例" aria-label="Permalink to &quot;uppercase示例&quot;">​</a></h4><p>uppercase 的操作更加的简单，不需要正则处理，直接将源标签值转变为大写</p><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myjob</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">honor_timestamps</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;10.103.236.199:9100&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">__machine_hostname__</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;node-01&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">__machine_idc__</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;idc-01&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">uppercase</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__machine_idc__</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">idc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myjob</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">honor_timestamps</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;10.103.236.199:9100&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">__machine_hostname__</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;node-01&#39;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">__machine_idc__</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;idc-01&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">uppercase</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__machine_idc__</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">idc</span></span></code></pre></div><blockquote><p>这个 action 不使用正则，因此可以忽略 regex 和 replacement，操作过程也更加简单 就是把 source_labels 指定的标签都转化为大写字母，赋值给 env_dc 标签</p></blockquote><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202502141704739.png" alt="image-20250214170414313"></p><h4 id="lowercase示例" tabindex="-1">lowercase示例 <a class="header-anchor" href="#lowercase示例" aria-label="Permalink to &quot;lowercase示例&quot;">​</a></h4><p>恰好与uppercase操作相反，同时也不需要正则处理，直接将源标签值转变为小写</p><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myjob</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">honor_timestamps</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">static_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">targets</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;10.103.236.199:9100&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">__machine_hostname__</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;node-01&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">__machine_idc__</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;IDC-01&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">uppercase</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__machine_idc__</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">idc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myjob</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">honor_timestamps</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">static_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">targets</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;10.103.236.199:9100&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">__machine_hostname__</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;node-01&#39;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">__machine_idc__</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;IDC-01&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">uppercase</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__machine_idc__</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">idc</span></span></code></pre></div><blockquote><p>这个 action 不使用正则，因此可以忽略 regex 和 replacement，操作过程也更加简单 就是把 source_labels 指定的标签的值都转化为小写字母，赋值给 env_dc 标签</p></blockquote>`,85),o=[e];function t(c,r,E,y,i,_){return a(),n("div",null,o)}const b=s(p,[["render",t]]);export{g as __pageData,b as default};
