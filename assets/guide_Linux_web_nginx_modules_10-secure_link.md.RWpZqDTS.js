import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const p="/assets/se.ZCeJMf5J.png",o="/assets/se1.A31a8WUj.png",_=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Linux/web/nginx/modules/10-secure_link.md","filePath":"guide/Linux/web/nginx/modules/10-secure_link.md","lastUpdated":1701684699000}'),e={name:"guide/Linux/web/nginx/modules/10-secure_link.md"},t=l(`<h2 id="一、安装nginx并检查是否已安装模块" tabindex="-1"><strong>一、安装nginx并检查是否已安装模块</strong> <a class="header-anchor" href="#一、安装nginx并检查是否已安装模块" aria-label="Permalink to &quot;**一、安装nginx并检查是否已安装模块**&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#输出nginx所有已安装模块，检查是否有ngx_http_secure_link_module</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@img_server </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# nginx -V</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#输出nginx所有已安装模块，检查是否有ngx_http_secure_link_module</span></span>
<span class="line"><span style="color:#24292E;">[root@img_server </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# nginx -V</span></span></code></pre></div><h2 id="二、配置nginx" tabindex="-1"><strong>二、配置nginx</strong> <a class="header-anchor" href="#二、配置nginx" aria-label="Permalink to &quot;**二、配置nginx**&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@img_server </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# vim /etc/nginx/conf.d/dowm_img_safe.conf </span></span>
<span class="line"><span style="color:#B392F0;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">listen</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">server_name</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">img_server</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">root</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">/usr/share/nginx/html/</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">secure_link</span><span style="color:#E1E4E8;"> $arg_md5</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;">$arg_expires;  </span><span style="color:#6A737D;">#这里配置了2个参数一个是arg_md5，一个是arg_expires</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">secure_link_md5</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$secure_link_expires$uri</span><span style="color:#9ECBFF;"> secret_key&quot;</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">#secret_key为自定义的加密串   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($secure_link = </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">403</span><span style="color:#E1E4E8;">;       </span><span style="color:#6A737D;">#资源不存在或哈希比对失败</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($secure_link = </span><span style="color:#9ECBFF;">&quot;0&quot;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">403</span><span style="color:#E1E4E8;">;      </span><span style="color:#6A737D;">#时间戳过期 </span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($request_filename </span><span style="color:#F97583;">~*</span><span style="color:#E1E4E8;"> ^.</span><span style="color:#F97583;">*?</span><span style="color:#79B8FF;">\\.</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">jpg</span><span style="color:#E1E4E8;">)$){</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">add_header</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Content-Disposition</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">attachment</span><span style="color:#E1E4E8;">;  </span><span style="color:#6A737D;">#不浏览，直接下载</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@img_server </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# vim /etc/nginx/conf.d/dowm_img_safe.conf </span></span>
<span class="line"><span style="color:#6F42C1;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">listen</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">server_name</span><span style="color:#24292E;">  </span><span style="color:#032F62;">img_server</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">root</span><span style="color:#24292E;">         </span><span style="color:#032F62;">/usr/share/nginx/html/</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">location</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">secure_link</span><span style="color:#24292E;"> $arg_md5</span><span style="color:#032F62;">,</span><span style="color:#24292E;">$arg_expires;  </span><span style="color:#6A737D;">#这里配置了2个参数一个是arg_md5，一个是arg_expires</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">secure_link_md5</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$secure_link_expires$uri</span><span style="color:#032F62;"> secret_key&quot;</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">#secret_key为自定义的加密串   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($secure_link = </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">403</span><span style="color:#24292E;">;       </span><span style="color:#6A737D;">#资源不存在或哈希比对失败</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($secure_link = </span><span style="color:#032F62;">&quot;0&quot;</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">403</span><span style="color:#24292E;">;      </span><span style="color:#6A737D;">#时间戳过期 </span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($request_filename </span><span style="color:#D73A49;">~*</span><span style="color:#24292E;"> ^.</span><span style="color:#D73A49;">*?</span><span style="color:#005CC5;">\\.</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">jpg</span><span style="color:#24292E;">)$){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">add_header</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Content-Disposition</span><span style="color:#24292E;"> </span><span style="color:#032F62;">attachment</span><span style="color:#24292E;">;  </span><span style="color:#6A737D;">#不浏览，直接下载</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="三、使用shell脚本生成下载的链接-生产环境由开发在代码中实现" tabindex="-1"><strong>三、使用shell脚本生成下载的链接(生产环境由开发在代码中实现)</strong> <a class="header-anchor" href="#三、使用shell脚本生成下载的链接-生产环境由开发在代码中实现" aria-label="Permalink to &quot;**三、使用shell脚本生成下载的链接(生产环境由开发在代码中实现)**&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@img_server html]# cat md5url.sh </span></span>
<span class="line"><span style="color:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="color:#E1E4E8;">servername</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;img_server&quot;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#服务器的域名</span></span>
<span class="line"><span style="color:#E1E4E8;">download_file</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;/test.jpg&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#测试下载文件的uri</span></span>
<span class="line"><span style="color:#E1E4E8;">time_num</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">date</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#9ECBFF;"> &quot;+300 seconds&quot; +%s)</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#定义过期时间为300秒</span></span>
<span class="line"><span style="color:#E1E4E8;">secret_num</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;secret_key&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#自定义的加密串，和nginx的配置文件中加密串相同</span></span>
<span class="line"><span style="color:#E1E4E8;">res</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#79B8FF;">echo</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#9ECBFF;"> &quot;\${</span><span style="color:#E1E4E8;">time_num</span><span style="color:#9ECBFF;">}\${</span><span style="color:#E1E4E8;">download_file</span><span style="color:#9ECBFF;">} \${</span><span style="color:#E1E4E8;">secret_num</span><span style="color:#9ECBFF;">}&quot;</span><span style="color:#F97583;">|</span><span style="color:#B392F0;">openssl</span><span style="color:#9ECBFF;"> md5 </span><span style="color:#79B8FF;">-binary</span><span style="color:#F97583;">|</span><span style="color:#B392F0;">openssl</span><span style="color:#9ECBFF;"> base64</span><span style="color:#F97583;">|</span><span style="color:#B392F0;">tr</span><span style="color:#9ECBFF;"> +/ </span><span style="color:#79B8FF;">-_</span><span style="color:#F97583;">|</span><span style="color:#B392F0;">tr</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#9ECBFF;"> =)</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#生成MD5值</span></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;http://\${</span><span style="color:#E1E4E8;">servername</span><span style="color:#9ECBFF;">}\${</span><span style="color:#E1E4E8;">download_file</span><span style="color:#9ECBFF;">}?md5=\${</span><span style="color:#E1E4E8;">res</span><span style="color:#9ECBFF;">}&amp;expires=\${</span><span style="color:#E1E4E8;">time_num</span><span style="color:#9ECBFF;">}&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#打印下载链接</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@img_server html]# cat md5url.sh </span></span>
<span class="line"><span style="color:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="color:#24292E;">servername</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;img_server&quot;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">#服务器的域名</span></span>
<span class="line"><span style="color:#24292E;">download_file</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;/test.jpg&quot;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#测试下载文件的uri</span></span>
<span class="line"><span style="color:#24292E;">time_num</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">date</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-d</span><span style="color:#032F62;"> &quot;+300 seconds&quot; +%s)</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#定义过期时间为300秒</span></span>
<span class="line"><span style="color:#24292E;">secret_num</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;secret_key&quot;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#自定义的加密串，和nginx的配置文件中加密串相同</span></span>
<span class="line"><span style="color:#24292E;">res</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#005CC5;">echo</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-n</span><span style="color:#032F62;"> &quot;\${</span><span style="color:#24292E;">time_num</span><span style="color:#032F62;">}\${</span><span style="color:#24292E;">download_file</span><span style="color:#032F62;">} \${</span><span style="color:#24292E;">secret_num</span><span style="color:#032F62;">}&quot;</span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">openssl</span><span style="color:#032F62;"> md5 </span><span style="color:#005CC5;">-binary</span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">openssl</span><span style="color:#032F62;"> base64</span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">tr</span><span style="color:#032F62;"> +/ </span><span style="color:#005CC5;">-_</span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">tr</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-d</span><span style="color:#032F62;"> =)</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">#生成MD5值</span></span>
<span class="line"><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;http://\${</span><span style="color:#24292E;">servername</span><span style="color:#032F62;">}\${</span><span style="color:#24292E;">download_file</span><span style="color:#032F62;">}?md5=\${</span><span style="color:#24292E;">res</span><span style="color:#032F62;">}&amp;expires=\${</span><span style="color:#24292E;">time_num</span><span style="color:#032F62;">}&quot;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#打印下载链接</span></span></code></pre></div><h2 id="四、测试" tabindex="-1"><strong>四、测试</strong> <a class="header-anchor" href="#四、测试" aria-label="Permalink to &quot;**四、测试**&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@img_server html]# chmod +x md5url.sh  </span><span style="color:#6A737D;">#添加权限</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@img_server html]# systemctl start nginx </span><span style="color:#6A737D;">#启动服务</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@img_server html]# wget http://pic17.huitu.com/res/20140314/526868_20140314230121822200_1.jpg</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@img_server html]# mv 526868_20140314230121822200_1.jpg test.jpg </span><span style="color:#6A737D;">#下载一个图片，并命名为test.jpg</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@img_server html]# chmod +x md5url.sh  </span><span style="color:#6A737D;">#添加权限</span></span>
<span class="line"><span style="color:#24292E;">[root@img_server html]# systemctl start nginx </span><span style="color:#6A737D;">#启动服务</span></span>
<span class="line"><span style="color:#24292E;">[root@img_server html]# wget http://pic17.huitu.com/res/20140314/526868_20140314230121822200_1.jpg</span></span>
<span class="line"><span style="color:#24292E;">[root@img_server html]# mv 526868_20140314230121822200_1.jpg test.jpg </span><span style="color:#6A737D;">#下载一个图片，并命名为test.jpg</span></span></code></pre></div><p><strong>1.测试直接访问(测试机器需要添加域名解析)</strong></p><p><img src="`+p+`" alt=""></p><p><strong>访问结果为403</strong></p><p><strong>2.使用生成的下载链接进行访问</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@img_server html]# sh md5url.sh </span></span>
<span class="line"><span style="color:#B392F0;">http://img_server/test.jpg?md5</span><span style="color:#E1E4E8;">=oa63dd5x_yi_E_eJLsAhHQ&amp;expires</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1523007651</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@img_server html]# sh md5url.sh </span></span>
<span class="line"><span style="color:#6F42C1;">http://img_server/test.jpg?md5</span><span style="color:#24292E;">=oa63dd5x_yi_E_eJLsAhHQ&amp;expires</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1523007651</span></span></code></pre></div><p><img src="`+o+`" alt=""></p><h3 id="注意事项" tabindex="-1"><strong>注意事项</strong> <a class="header-anchor" href="#注意事项" aria-label="Permalink to &quot;**注意事项**&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">1 密钥防止泄露、以及经常更新密钥</span></span>
<span class="line"><span style="color:#e1e4e8;">2 下载服务器和链接生成的服务器上的时间不能相差太大，否则容易出现文件一直都是过期状态.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">1 密钥防止泄露、以及经常更新密钥</span></span>
<span class="line"><span style="color:#24292e;">2 下载服务器和链接生成的服务器上的时间不能相差太大，否则容易出现文件一直都是过期状态.</span></span></code></pre></div>`,16),r=[t];function c(y,E,i,F,d,u){return n(),a("div",null,r)}const h=s(e,[["render",c]]);export{_ as __pageData,h as default};
