import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const d=JSON.parse('{"title":"1. 查看证书时间","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/TroubleshootingMaintenanceManual/3-k8s证书.md","filePath":"guide/container/k8s/TroubleshootingMaintenanceManual/3-k8s证书.md","lastUpdated":1729591632000}'),p={name:"guide/container/k8s/TroubleshootingMaintenanceManual/3-k8s证书.md"},o=l(`<p>文档,<a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/" target="_blank" rel="noreferrer">https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/</a></p><h1 id="_1-查看证书时间" tabindex="-1">1. 查看证书时间 <a class="header-anchor" href="#_1-查看证书时间" aria-label="Permalink to &quot;1. 查看证书时间&quot;">​</a></h1><p>而默认情况下ca证书是十年，而其他证书都只有一年</p><h2 id="_1-1-第一种方式" tabindex="-1">1.1 第一种方式 <a class="header-anchor" href="#_1-1-第一种方式" aria-label="Permalink to &quot;1.1 第一种方式&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#根据自己的路径进行修改</span></span>
<span class="line"><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">ls</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">*</span><span style="color:#9ECBFF;">.crt)</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;====================== </span><span style="color:#E1E4E8;">$i</span><span style="color:#9ECBFF;"> ========&quot;</span><span style="color:#E1E4E8;">; </span><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">x509</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-in</span><span style="color:#E1E4E8;"> $i </span><span style="color:#79B8FF;">-text</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-noout</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-A</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Validity&#39;</span><span style="color:#E1E4E8;"> ; </span><span style="color:#F97583;">done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">====================== </span><span style="color:#9ECBFF;">apiserver.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">========</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">Validity</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">Not</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Before:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Apr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:31:49</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2024</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GMT</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">Not</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">After</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Apr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:31:49</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2025</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GMT</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">Subject:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CN=kube-apiserver</span></span>
<span class="line"><span style="color:#79B8FF;">.....</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#根据自己的路径进行修改</span></span>
<span class="line"><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">ls</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">*</span><span style="color:#032F62;">.crt)</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;====================== </span><span style="color:#24292E;">$i</span><span style="color:#032F62;"> ========&quot;</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-in</span><span style="color:#24292E;"> $i </span><span style="color:#005CC5;">-text</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-noout</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-A</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Validity&#39;</span><span style="color:#24292E;"> ; </span><span style="color:#D73A49;">done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">====================== </span><span style="color:#032F62;">apiserver.crt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">========</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">Validity</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">Not</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Before:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Apr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:31:49</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2024</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GMT</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">Not</span><span style="color:#24292E;"> </span><span style="color:#032F62;">After</span><span style="color:#24292E;"> </span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Apr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:31:49</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2025</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GMT</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">Subject:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CN=kube-apiserver</span></span>
<span class="line"><span style="color:#005CC5;">.....</span></span></code></pre></div><h2 id="_1-2-第二种方式" tabindex="-1">1.2 第二种方式 <a class="header-anchor" href="#_1-2-第二种方式" aria-label="Permalink to &quot;1.2 第二种方式&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master pki]# kubeadm certs check-expiration</span></span>
<span class="line"><span style="color:#E1E4E8;">[check-expiration] Reading configuration from the cluster...</span></span>
<span class="line"><span style="color:#E1E4E8;">[check-expiration] FYI: You can look at this config file with </span><span style="color:#9ECBFF;">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">CERTIFICATE</span><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">EXPIRES</span><span style="color:#E1E4E8;">                  </span><span style="color:#9ECBFF;">RESIDUAL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">TIME</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">CERTIFICATE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">AUTHORITY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">EXTERNALLY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MANAGED</span></span>
<span class="line"><span style="color:#B392F0;">admin.conf</span><span style="color:#E1E4E8;">                 </span><span style="color:#9ECBFF;">Apr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2025</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UTC</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">273</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">ca</span><span style="color:#E1E4E8;">                      </span><span style="color:#9ECBFF;">no</span></span>
<span class="line"><span style="color:#B392F0;">apiserver</span><span style="color:#E1E4E8;">                  </span><span style="color:#9ECBFF;">Apr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2025</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UTC</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">273</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">ca</span><span style="color:#E1E4E8;">                      </span><span style="color:#9ECBFF;">no</span></span>
<span class="line"><span style="color:#B392F0;">apiserver-etcd-client</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">Apr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2025</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UTC</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">273</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">etcd-ca</span><span style="color:#E1E4E8;">                 </span><span style="color:#9ECBFF;">no</span></span>
<span class="line"><span style="color:#B392F0;">apiserver-kubelet-client</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Apr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2025</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UTC</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">273</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">ca</span><span style="color:#E1E4E8;">                      </span><span style="color:#9ECBFF;">no</span></span>
<span class="line"><span style="color:#B392F0;">controller-manager.conf</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Apr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2025</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UTC</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">273</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">ca</span><span style="color:#E1E4E8;">                      </span><span style="color:#9ECBFF;">no</span></span>
<span class="line"><span style="color:#B392F0;">etcd-healthcheck-client</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Apr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2025</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UTC</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">273</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">etcd-ca</span><span style="color:#E1E4E8;">                 </span><span style="color:#9ECBFF;">no</span></span>
<span class="line"><span style="color:#B392F0;">etcd-peer</span><span style="color:#E1E4E8;">                  </span><span style="color:#9ECBFF;">Apr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2025</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UTC</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">273</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">etcd-ca</span><span style="color:#E1E4E8;">                 </span><span style="color:#9ECBFF;">no</span></span>
<span class="line"><span style="color:#B392F0;">etcd-server</span><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">Apr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2025</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UTC</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">273</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">etcd-ca</span><span style="color:#E1E4E8;">                 </span><span style="color:#9ECBFF;">no</span></span>
<span class="line"><span style="color:#B392F0;">front-proxy-client</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">Apr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2025</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UTC</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">273</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">front-proxy-ca</span><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">no</span></span>
<span class="line"><span style="color:#B392F0;">scheduler.conf</span><span style="color:#E1E4E8;">             </span><span style="color:#9ECBFF;">Apr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2025</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UTC</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">273</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">ca</span><span style="color:#E1E4E8;">                      </span><span style="color:#9ECBFF;">no</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">CERTIFICATE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">AUTHORITY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">EXPIRES</span><span style="color:#E1E4E8;">                  </span><span style="color:#9ECBFF;">RESIDUAL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">TIME</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">EXTERNALLY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MANAGED</span></span>
<span class="line"><span style="color:#B392F0;">ca</span><span style="color:#E1E4E8;">                      </span><span style="color:#9ECBFF;">Apr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2034</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UTC</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">9</span><span style="color:#9ECBFF;">y</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">no</span></span>
<span class="line"><span style="color:#B392F0;">etcd-ca</span><span style="color:#E1E4E8;">                 </span><span style="color:#9ECBFF;">Apr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2034</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UTC</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">9</span><span style="color:#9ECBFF;">y</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">no</span></span>
<span class="line"><span style="color:#B392F0;">front-proxy-ca</span><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">Apr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2034</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">08</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UTC</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">9</span><span style="color:#9ECBFF;">y</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">no</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master pki]# kubeadm certs check-expiration</span></span>
<span class="line"><span style="color:#24292E;">[check-expiration] Reading configuration from the cluster...</span></span>
<span class="line"><span style="color:#24292E;">[check-expiration] FYI: You can look at this config file with </span><span style="color:#032F62;">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">CERTIFICATE</span><span style="color:#24292E;">                </span><span style="color:#032F62;">EXPIRES</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">RESIDUAL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">TIME</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CERTIFICATE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">AUTHORITY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">EXTERNALLY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MANAGED</span></span>
<span class="line"><span style="color:#6F42C1;">admin.conf</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">Apr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2025</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UTC</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">273</span><span style="color:#032F62;">d</span><span style="color:#24292E;">            </span><span style="color:#032F62;">ca</span><span style="color:#24292E;">                      </span><span style="color:#032F62;">no</span></span>
<span class="line"><span style="color:#6F42C1;">apiserver</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">Apr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2025</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UTC</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">273</span><span style="color:#032F62;">d</span><span style="color:#24292E;">            </span><span style="color:#032F62;">ca</span><span style="color:#24292E;">                      </span><span style="color:#032F62;">no</span></span>
<span class="line"><span style="color:#6F42C1;">apiserver-etcd-client</span><span style="color:#24292E;">      </span><span style="color:#032F62;">Apr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2025</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UTC</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">273</span><span style="color:#032F62;">d</span><span style="color:#24292E;">            </span><span style="color:#032F62;">etcd-ca</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">no</span></span>
<span class="line"><span style="color:#6F42C1;">apiserver-kubelet-client</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Apr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2025</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UTC</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">273</span><span style="color:#032F62;">d</span><span style="color:#24292E;">            </span><span style="color:#032F62;">ca</span><span style="color:#24292E;">                      </span><span style="color:#032F62;">no</span></span>
<span class="line"><span style="color:#6F42C1;">controller-manager.conf</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Apr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2025</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UTC</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">273</span><span style="color:#032F62;">d</span><span style="color:#24292E;">            </span><span style="color:#032F62;">ca</span><span style="color:#24292E;">                      </span><span style="color:#032F62;">no</span></span>
<span class="line"><span style="color:#6F42C1;">etcd-healthcheck-client</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Apr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2025</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UTC</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">273</span><span style="color:#032F62;">d</span><span style="color:#24292E;">            </span><span style="color:#032F62;">etcd-ca</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">no</span></span>
<span class="line"><span style="color:#6F42C1;">etcd-peer</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">Apr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2025</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UTC</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">273</span><span style="color:#032F62;">d</span><span style="color:#24292E;">            </span><span style="color:#032F62;">etcd-ca</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">no</span></span>
<span class="line"><span style="color:#6F42C1;">etcd-server</span><span style="color:#24292E;">                </span><span style="color:#032F62;">Apr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2025</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UTC</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">273</span><span style="color:#032F62;">d</span><span style="color:#24292E;">            </span><span style="color:#032F62;">etcd-ca</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">no</span></span>
<span class="line"><span style="color:#6F42C1;">front-proxy-client</span><span style="color:#24292E;">         </span><span style="color:#032F62;">Apr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2025</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UTC</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">273</span><span style="color:#032F62;">d</span><span style="color:#24292E;">            </span><span style="color:#032F62;">front-proxy-ca</span><span style="color:#24292E;">          </span><span style="color:#032F62;">no</span></span>
<span class="line"><span style="color:#6F42C1;">scheduler.conf</span><span style="color:#24292E;">             </span><span style="color:#032F62;">Apr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2025</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UTC</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">273</span><span style="color:#032F62;">d</span><span style="color:#24292E;">            </span><span style="color:#032F62;">ca</span><span style="color:#24292E;">                      </span><span style="color:#032F62;">no</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">CERTIFICATE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">AUTHORITY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">EXPIRES</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">RESIDUAL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">TIME</span><span style="color:#24292E;">   </span><span style="color:#032F62;">EXTERNALLY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MANAGED</span></span>
<span class="line"><span style="color:#6F42C1;">ca</span><span style="color:#24292E;">                      </span><span style="color:#032F62;">Apr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2034</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UTC</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">9</span><span style="color:#032F62;">y</span><span style="color:#24292E;">              </span><span style="color:#032F62;">no</span></span>
<span class="line"><span style="color:#6F42C1;">etcd-ca</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">Apr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2034</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UTC</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">9</span><span style="color:#032F62;">y</span><span style="color:#24292E;">              </span><span style="color:#032F62;">no</span></span>
<span class="line"><span style="color:#6F42C1;">front-proxy-ca</span><span style="color:#24292E;">          </span><span style="color:#032F62;">Apr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2034</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">08</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UTC</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">9</span><span style="color:#032F62;">y</span><span style="color:#24292E;">              </span><span style="color:#032F62;">no</span></span></code></pre></div><h1 id="_2-证书类型" tabindex="-1">2. 证书类型 <a class="header-anchor" href="#_2-证书类型" aria-label="Permalink to &quot;2. 证书类型&quot;">​</a></h1><h2 id="_2-1-集群根证书" tabindex="-1">2.1 集群根证书 <a class="header-anchor" href="#_2-1-集群根证书" aria-label="Permalink to &quot;2.1 集群根证书&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/ca</span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1099</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/ca.crt</span></span>
<span class="line"><span style="color:#B392F0;">-rw-------</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1679</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/ca.key</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/ca</span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1099</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/ca.crt</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-------</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1679</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/ca.key</span></span></code></pre></div><p>由此集群根证书签发的证书有：</p><ol><li>kube-apiserver 组件持有的服务端证书</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/apiserver.</span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1289</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/apiserver.crt</span></span>
<span class="line"><span style="color:#B392F0;">-rw-------</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1679</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/apiserver.key</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/apiserver.</span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1289</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/apiserver.crt</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-------</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1679</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/apiserver.key</span></span></code></pre></div><ol start="2"><li>kubelet 组件持有的客户端证书</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/apiserver-kubelet-client.</span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1164</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span></span>
<span class="line"><span style="color:#B392F0;">-rw-------</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1675</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/apiserver-kubelet-client.key</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/apiserver-kubelet-client.</span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1164</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-------</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1675</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/apiserver-kubelet-client.key</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>kubelet的/var/lib/kubelet/config.yaml 配置文件中一般不会明确指定服务端证书，而是只指定ca根证书，让kubelet根据本地主机信息自动生成服务端证书并保存到配置的cert-dir文件夹中</p></div><h2 id="_2-2-汇聚层根证书" tabindex="-1">2.2 汇聚层根证书 <a class="header-anchor" href="#_2-2-汇聚层根证书" aria-label="Permalink to &quot;2.2 汇聚层根证书&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/front-proxy-ca.</span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1115</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/front-proxy-ca.crt</span></span>
<span class="line"><span style="color:#B392F0;">-rw-------</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1675</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/front-proxy-ca.key</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/front-proxy-ca.</span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1115</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/front-proxy-ca.crt</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-------</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1675</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/front-proxy-ca.key</span></span></code></pre></div><p>由此汇聚层根证书签发的证书有</p><ol><li>代理端使用的客户端证书，用作代用户与 kube-apiserver 认证</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/front-proxy-client.</span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1119</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/front-proxy-client.crt</span></span>
<span class="line"><span style="color:#B392F0;">-rw-------</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1679</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/front-proxy-client.key</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/front-proxy-client.</span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1119</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/front-proxy-client.crt</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-------</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1679</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/front-proxy-client.key</span></span></code></pre></div><h2 id="_2-3-etcd-集群根证书" tabindex="-1">2.3 etcd 集群根证书 <a class="header-anchor" href="#_2-3-etcd-集群根证书" aria-label="Permalink to &quot;2.3 etcd 集群根证书&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/etcd/ca.</span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1086</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/ca.crt</span></span>
<span class="line"><span style="color:#B392F0;">-rw-------</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1679</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/ca.key</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/etcd/ca.</span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1086</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/ca.crt</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-------</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1679</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/ca.key</span></span></code></pre></div><p>由此 etcd 根证书签发的证书有：</p><ol><li>etcd server 服务端证书</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm]#  ll /etc/kubernetes/pki/etcd/server.</span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1208</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/server.crt</span></span>
<span class="line"><span style="color:#B392F0;">-rw-------</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1679</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/server.key</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubeadm]#  ll /etc/kubernetes/pki/etcd/server.</span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1208</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/server.crt</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-------</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1679</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/server.key</span></span></code></pre></div><ol start="2"><li>etcd 集群中 peer 节点互相通信使用的客户端证书</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/etcd/peer.</span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1208</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/peer.crt</span></span>
<span class="line"><span style="color:#B392F0;">-rw-------</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1675</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/peer.key</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/etcd/peer.</span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1208</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/peer.crt</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-------</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1675</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/peer.key</span></span></code></pre></div><ol start="3"><li>Pod 中定义 Liveness 探针使用的客户端证书</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/etcd/healthcheck-client.</span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1159</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/healthcheck-client.crt</span></span>
<span class="line"><span style="color:#B392F0;">-rw-------</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1675</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/healthcheck-client.key</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/etcd/healthcheck-client.</span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1159</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/healthcheck-client.crt</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-------</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1675</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/healthcheck-client.key</span></span></code></pre></div><ol start="4"><li>配置在 kube-apiserver 中用来与 etcd server 做双向认证的客户端证书</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm]#  ll /etc/kubernetes/pki/apiserver-etcd-client.</span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rw-r--r--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1155</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/apiserver-etcd-client.crt</span></span>
<span class="line"><span style="color:#B392F0;">-rw-------</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1679</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/apiserver-etcd-client.key</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubeadm]#  ll /etc/kubernetes/pki/apiserver-etcd-client.</span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-r--r--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1155</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/apiserver-etcd-client.crt</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-------</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1679</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/apiserver-etcd-client.key</span></span></code></pre></div><h2 id="_2-4-serveice-account-密钥" tabindex="-1">2.4 Serveice Account 密钥 <a class="header-anchor" href="#_2-4-serveice-account-密钥" aria-label="Permalink to &quot;2.4 Serveice Account 密钥&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/sa.</span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#B392F0;">-rw-------</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1675</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/sa.key</span></span>
<span class="line"><span style="color:#B392F0;">-rw-------</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">451</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">月</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/pki/sa.pub</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubeadm]# ll /etc/kubernetes/pki/sa.</span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-------</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1675</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/sa.key</span></span>
<span class="line"><span style="color:#6F42C1;">-rw-------</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">451</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">月</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/pki/sa.pub</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>Serveice Account密钥对仅提供给kube-controller-manager使用，kube-controller-manager通过sa.key对token进行签名，Master节点通过公钥sa.pub进行签名的验证</p></div><h2 id="_2-5-api-server身份验证过程" tabindex="-1">2.5 API Server身份验证过程 <a class="header-anchor" href="#_2-5-api-server身份验证过程" aria-label="Permalink to &quot;2.5 API Server身份验证过程&quot;">​</a></h2><p>API Server 的 Authentication 环节支持多种身份校验方式：Client Cert、Bearer Token、Static Password Auth 等，这些方式中只要有一种方式通过 Authentication（Kubernetes API Server 会逐个方式尝试），那么身份校验就会通过</p><p>一旦 API Server 发现 Client 发起的 Request 使用的是 Service Account Token 的方式，API Server 就会自动采用 Signed Bearer Token 方式进行身份校验。而 Request 就会使用携带的 Service Account Token 参与验证。该 Token 是 API Server 在创建 Service Account 时用 kube-controller-manager 启动参数 --service-account-private-key-file 指定的私钥签署 (sign) 的，同时必须指定 kube-apiserver 参数 --service-account-key-file（如果没指定的话，会使用 --tls-private-key-file 替代）为该私钥对应的公钥，用来在认证阶段验证 Token，也就是说该证书对通过 CN 和 O 指定了 ServiceAccount 的授权权限</p><p>通过 Authentication 后，API Server 将根据 Pod 所属 ServiceAccount 的用户名（以 system:serviceaccount: 为前缀）和组（以 system:serviceaccounts: 前缀）的权限对其进行 Authorization 和 Admission Control 两个环节的处理</p><p>不管是自动生成的 Token 还是手动创建的 Token 的值都是一样的，因为进行签署 Token 的 -–service-account-key-file 是同一个</p><p>ServiceAccount 中的 Token 是 API server 私钥签署的，Pod 在对 API Server 发起请求的时候会带上该 Token，以确保能够通过 API Server 的认证。对 ServiceAccount 的授权通过对 ServiceAccount 对应的用户或组进行 RBAC 控制即可</p><h1 id="_3-更新证书" tabindex="-1">3. 更新证书 <a class="header-anchor" href="#_3-更新证书" aria-label="Permalink to &quot;3. 更新证书&quot;">​</a></h1><h2 id="_3-1-根据源码方式" tabindex="-1">3.1 根据源码方式 <a class="header-anchor" href="#_3-1-根据源码方式" aria-label="Permalink to &quot;3.1 根据源码方式&quot;">​</a></h2><p><a href="https://www.cnblogs.com/guangdelw/p/17575730.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/guangdelw/p/17575730.html</a></p><p><a href="https://www.youqiqi.cn/archives/kubernetesxiu-gai-kubeadmzheng-shu" target="_blank" rel="noreferrer">https://www.youqiqi.cn/archives/kubernetesxiu-gai-kubeadmzheng-shu</a></p><h2 id="_3-2-kubeadm方式" tabindex="-1">3.2 kubeadm方式 <a class="header-anchor" href="#_3-2-kubeadm方式" aria-label="Permalink to &quot;3.2 kubeadm方式&quot;">​</a></h2><p><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/" target="_blank" rel="noreferrer">官当</a></p><h3 id="_0-查看kubeamd版本" tabindex="-1">0.查看kubeamd版本 <a class="header-anchor" href="#_0-查看kubeamd版本" aria-label="Permalink to &quot;0.查看kubeamd版本&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">version</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#或者</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master kubernetes]# kubectl version --short</span></span>
<span class="line"><span style="color:#B392F0;">Client</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Version:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1.22.17</span></span>
<span class="line"><span style="color:#B392F0;">Server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Version:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1.22.17</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">version</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#或者</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master kubernetes]# kubectl version --short</span></span>
<span class="line"><span style="color:#6F42C1;">Client</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Version:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1.22.17</span></span>
<span class="line"><span style="color:#6F42C1;">Server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Version:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1.22.17</span></span></code></pre></div><h3 id="_1-检查证书是否过期" tabindex="-1">1. 检查证书是否过期 <a class="header-anchor" href="#_1-检查证书是否过期" aria-label="Permalink to &quot;1. 检查证书是否过期&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubeadm certs check-expiration  //新版本,1.22之后</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">kubeadm alpha certs check-expiration //老版本，在 1.20 之前使用</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubeadm certs check-expiration  //新版本,1.22之后</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">kubeadm alpha certs check-expiration //老版本，在 1.20 之前使用</span></span></code></pre></div><h3 id="_2-备份集群证书、配置信息" tabindex="-1">2. 备份集群证书、配置信息 <a class="header-anchor" href="#_2-备份集群证书、配置信息" aria-label="Permalink to &quot;2. 备份集群证书、配置信息&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">## 将k8s和tecd相关文件做备份</span></span>
<span class="line"><span style="color:#B392F0;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-r</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/tmp/kubernetes.bak</span></span>
<span class="line"><span style="color:#B392F0;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-r</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/etcd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/tmp/etcd.bak</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">## 将k8s和tecd相关文件做备份</span></span>
<span class="line"><span style="color:#6F42C1;">cp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-r</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/tmp/kubernetes.bak</span></span>
<span class="line"><span style="color:#6F42C1;">cp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-r</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/etcd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/tmp/etcd.bak</span></span></code></pre></div><h3 id="_3-执行更新" tabindex="-1">3. 执行更新 <a class="header-anchor" href="#_3-执行更新" aria-label="Permalink to &quot;3. 执行更新&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">#续订所有证书</span></span>
<span class="line"><span style="color:#e1e4e8;">kubeadm certs renew all</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">#续订所有证书</span></span>
<span class="line"><span style="color:#24292e;">kubeadm certs renew all</span></span></code></pre></div><h3 id="_4-重启相关应用" tabindex="-1">4. 重启相关应用 <a class="header-anchor" href="#_4-重启相关应用" aria-label="Permalink to &quot;4. 重启相关应用&quot;">​</a></h3><p>（所有master都要执行）</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ps</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-E</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;k8s_kube-apiserver|k8s_kube-controller-manager|k8s_kube-scheduler|k8s_etcd_etcd&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">awk</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-F</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;{print $1}&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">xargs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ps</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-E</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;k8s_kube-apiserver|k8s_kube-controller-manager|k8s_kube-scheduler|k8s_etcd_etcd&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">awk</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-F</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;{print $1}&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">xargs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">crictl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ps</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-E</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;kube-apiserver|kube-controller-manager|kube-scheduler|etcd&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">awk</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-F</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;{print $1}&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">xargs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">crictl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stop</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">crictl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ps</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-E</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;kube-apiserver|kube-controller-manager|kube-scheduler|etcd&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">awk</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-F</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;{print $1}&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">xargs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">crictl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop</span></span></code></pre></div><h3 id="_5-kubeconfig" tabindex="-1">5.kubeconfig <a class="header-anchor" href="#_5-kubeconfig" aria-label="Permalink to &quot;5.kubeconfig&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-i</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/admin.conf</span><span style="color:#E1E4E8;"> $HOME</span><span style="color:#9ECBFF;">/.kube/config</span></span>
<span class="line"><span style="color:#B392F0;">chown</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">id</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-u</span><span style="color:#9ECBFF;">):$(</span><span style="color:#B392F0;">id</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-g</span><span style="color:#9ECBFF;">)</span><span style="color:#E1E4E8;"> $HOME</span><span style="color:#9ECBFF;">/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#更新kubeconfig</span></span>
<span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">init</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">phase</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubeconfig</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">all</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-i</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/admin.conf</span><span style="color:#24292E;"> $HOME</span><span style="color:#032F62;">/.kube/config</span></span>
<span class="line"><span style="color:#6F42C1;">chown</span><span style="color:#24292E;"> </span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">id</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-u</span><span style="color:#032F62;">):$(</span><span style="color:#6F42C1;">id</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-g</span><span style="color:#032F62;">)</span><span style="color:#24292E;"> $HOME</span><span style="color:#032F62;">/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#更新kubeconfig</span></span>
<span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">init</span><span style="color:#24292E;"> </span><span style="color:#032F62;">phase</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubeconfig</span><span style="color:#24292E;"> </span><span style="color:#032F62;">all</span></span></code></pre></div><h3 id="_6-验证" tabindex="-1">6.验证 <a class="header-anchor" href="#_6-验证" aria-label="Permalink to &quot;6.验证&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# echo </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">s_client</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-showcerts</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-connect</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1:6443</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-servername</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">api</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;</span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">x509</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-noout</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-enddate</span></span>
<span class="line"><span style="color:#E1E4E8;">notAfter</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">Oct</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">22</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">06</span><span style="color:#9ECBFF;">:15:11</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2025</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GMT</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#或者</span></span>
<span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">certs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">check-expiration</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#或者</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> item </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">find</span><span style="color:#9ECBFF;"> /etc/kubernetes/pki </span><span style="color:#79B8FF;">-maxdepth</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-name</span><span style="color:#9ECBFF;"> &quot;*.crt&quot;\`</span><span style="color:#E1E4E8;">;</span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> openssl x509 -in $item -text -noout</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Not</span><span style="color:#E1E4E8;">;</span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">======================</span><span style="color:#E1E4E8;">$item</span><span style="color:#9ECBFF;">===============</span><span style="color:#E1E4E8;">;</span><span style="color:#F97583;">done</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#执行get pod</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">如果能显示出来，说明更新证书成功</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# echo </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">s_client</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-showcerts</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-connect</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1:6443</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-servername</span><span style="color:#24292E;"> </span><span style="color:#032F62;">api</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;</span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-noout</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-enddate</span></span>
<span class="line"><span style="color:#24292E;">notAfter</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">Oct</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">22</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">06</span><span style="color:#032F62;">:15:11</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2025</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GMT</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#或者</span></span>
<span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">certs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">check-expiration</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#或者</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> item </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">find</span><span style="color:#032F62;"> /etc/kubernetes/pki </span><span style="color:#005CC5;">-maxdepth</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">2</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-name</span><span style="color:#032F62;"> &quot;*.crt&quot;\`</span><span style="color:#24292E;">;</span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> openssl x509 -in $item -text -noout</span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Not</span><span style="color:#24292E;">;</span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">======================</span><span style="color:#24292E;">$item</span><span style="color:#032F62;">===============</span><span style="color:#24292E;">;</span><span style="color:#D73A49;">done</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#执行get pod</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">如果能显示出来，说明更新证书成功</span></span></code></pre></div><p><a href="https://cloud.google.com/kubernetes-engine/distributed-cloud/bare-metal/docs/troubleshooting/expired-certs?hl=zh-cn" target="_blank" rel="noreferrer">https://cloud.google.com/kubernetes-engine/distributed-cloud/bare-metal/docs/troubleshooting/expired-certs?hl=zh-cn</a></p><h1 id="_4-二进制证书" tabindex="-1">4.二进制证书 <a class="header-anchor" href="#_4-二进制证书" aria-label="Permalink to &quot;4.二进制证书&quot;">​</a></h1><p>涉及到证书</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202409271130422.png" alt="img"></p><p>直接重新生成新的证书,替换重启服务即可</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">#查看证书到期</span></span>
<span class="line"><span style="color:#e1e4e8;">openssl x509 -in /etc/kubernetes/pki/kubelet.crt -noout -text |grep &#39;Not&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">#查看证书到期</span></span>
<span class="line"><span style="color:#24292e;">openssl x509 -in /etc/kubernetes/pki/kubelet.crt -noout -text |grep &#39;Not&#39;</span></span></code></pre></div><h1 id="_5-etcd证书更换" tabindex="-1">5.etcd证书更换 <a class="header-anchor" href="#_5-etcd证书更换" aria-label="Permalink to &quot;5.etcd证书更换&quot;">​</a></h1><p>etcd部署在外部</p><h2 id="_5-1查看证书路径" tabindex="-1">5.1查看证书路径 <a class="header-anchor" href="#_5-1查看证书路径" aria-label="Permalink to &quot;5.1查看证书路径&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cat</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">etcd</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cat</span><span style="color:#24292E;">   </span><span style="color:#032F62;">etcd</span></span></code></pre></div><h2 id="_5-2备份" tabindex="-1">5.2备份 <a class="header-anchor" href="#_5-2备份" aria-label="Permalink to &quot;5.2备份&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#停止Etcd操作</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stop</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#备份Etcd数据</span></span>
<span class="line"><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib</span></span>
<span class="line"><span style="color:#B392F0;">tar</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-zvcf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd.tar.gz</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#备份原有ssl</span></span>
<span class="line"><span style="color:#B392F0;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-r</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/etcd/ssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/tmp/etcd_ssl_backup</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#停止Etcd操作</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#备份Etcd数据</span></span>
<span class="line"><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib</span></span>
<span class="line"><span style="color:#6F42C1;">tar</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-zvcf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd.tar.gz</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#备份原有ssl</span></span>
<span class="line"><span style="color:#6F42C1;">cp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-r</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/etcd/ssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/tmp/etcd_ssl_backup</span></span></code></pre></div><h2 id="_5-3-创建配置文件" tabindex="-1">5.3 创建配置文件 <a class="header-anchor" href="#_5-3-创建配置文件" aria-label="Permalink to &quot;5.3 创建配置文件&quot;">​</a></h2><p>配置文件，在证书目录创建openssl.conf，最下面一行，如果是三台机器构建的Etcd集群，则三台ip都需要加上</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master-01 ssl]# vi openssl.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">[req]</span></span>
<span class="line"><span style="color:#B392F0;">req_extensions</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v3_req</span></span>
<span class="line"><span style="color:#B392F0;">distinguished_name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">req_distinguished_name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[req_distinguished_name]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[ v3_req ]</span></span>
<span class="line"><span style="color:#B392F0;">basicConstraints</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CA:FALSE</span></span>
<span class="line"><span style="color:#B392F0;">keyUsage</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nonRepudiation,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">digitalSignature,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">keyEncipherment</span></span>
<span class="line"><span style="color:#B392F0;">subjectAltName</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">@alt_names</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[ ssl_client ]</span></span>
<span class="line"><span style="color:#B392F0;">extendedKeyUsage</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clientAuth,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">serverAuth</span></span>
<span class="line"><span style="color:#B392F0;">basicConstraints</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CA:FALSE</span></span>
<span class="line"><span style="color:#E1E4E8;">subjectKeyIdentifier</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">hash</span></span>
<span class="line"><span style="color:#E1E4E8;">authorityKeyIdentifier</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">keyid,issuer</span></span>
<span class="line"><span style="color:#B392F0;">subjectAltName</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">@alt_names</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[ v3_ca ]</span></span>
<span class="line"><span style="color:#B392F0;">basicConstraints</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CA:TRUE</span></span>
<span class="line"><span style="color:#B392F0;">keyUsage</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nonRepudiation,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">digitalSignature,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">keyEncipherment</span></span>
<span class="line"><span style="color:#B392F0;">subjectAltName</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">@alt_names</span></span>
<span class="line"><span style="color:#E1E4E8;">authorityKeyIdentifier</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">keyid:always,issuer</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[alt_names]</span></span>
<span class="line"><span style="color:#B392F0;">DNS.1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localhost</span></span>
<span class="line"><span style="color:#B392F0;">DNS.2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd.kube-system.svc.cluster.local</span></span>
<span class="line"><span style="color:#B392F0;">DNS.3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd.kube-system.svc</span></span>
<span class="line"><span style="color:#B392F0;">DNS.4</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd.kube-system</span></span>
<span class="line"><span style="color:#B392F0;">DNS.5</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd</span></span>
<span class="line"><span style="color:#B392F0;">DNS.6</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">lb.kubesphere.local</span></span>
<span class="line"><span style="color:#B392F0;">DNS.7</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-master-01</span></span>
<span class="line"><span style="color:#B392F0;">DNS.8</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-node-01</span></span>
<span class="line"><span style="color:#B392F0;">DNS.9</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-node-02</span></span>
<span class="line"><span style="color:#B392F0;">IP.1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1</span></span>
<span class="line"><span style="color:#B392F0;">IP.2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.103</span><span style="color:#9ECBFF;">.236.150</span></span>
<span class="line"><span style="color:#B392F0;">IP.3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.103</span><span style="color:#9ECBFF;">.236.151</span></span>
<span class="line"><span style="color:#B392F0;">IP.4</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.103</span><span style="color:#9ECBFF;">.236.152</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master-01 ssl]# vi openssl.conf</span></span>
<span class="line"><span style="color:#24292E;">[req]</span></span>
<span class="line"><span style="color:#6F42C1;">req_extensions</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v3_req</span></span>
<span class="line"><span style="color:#6F42C1;">distinguished_name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">req_distinguished_name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[req_distinguished_name]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[ v3_req ]</span></span>
<span class="line"><span style="color:#6F42C1;">basicConstraints</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CA:FALSE</span></span>
<span class="line"><span style="color:#6F42C1;">keyUsage</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nonRepudiation,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">digitalSignature,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">keyEncipherment</span></span>
<span class="line"><span style="color:#6F42C1;">subjectAltName</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">@alt_names</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[ ssl_client ]</span></span>
<span class="line"><span style="color:#6F42C1;">extendedKeyUsage</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clientAuth,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">serverAuth</span></span>
<span class="line"><span style="color:#6F42C1;">basicConstraints</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CA:FALSE</span></span>
<span class="line"><span style="color:#24292E;">subjectKeyIdentifier</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">hash</span></span>
<span class="line"><span style="color:#24292E;">authorityKeyIdentifier</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">keyid,issuer</span></span>
<span class="line"><span style="color:#6F42C1;">subjectAltName</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">@alt_names</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[ v3_ca ]</span></span>
<span class="line"><span style="color:#6F42C1;">basicConstraints</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CA:TRUE</span></span>
<span class="line"><span style="color:#6F42C1;">keyUsage</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nonRepudiation,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">digitalSignature,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">keyEncipherment</span></span>
<span class="line"><span style="color:#6F42C1;">subjectAltName</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">@alt_names</span></span>
<span class="line"><span style="color:#24292E;">authorityKeyIdentifier</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">keyid:always,issuer</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[alt_names]</span></span>
<span class="line"><span style="color:#6F42C1;">DNS.1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localhost</span></span>
<span class="line"><span style="color:#6F42C1;">DNS.2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd.kube-system.svc.cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">DNS.3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd.kube-system.svc</span></span>
<span class="line"><span style="color:#6F42C1;">DNS.4</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd.kube-system</span></span>
<span class="line"><span style="color:#6F42C1;">DNS.5</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd</span></span>
<span class="line"><span style="color:#6F42C1;">DNS.6</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">lb.kubesphere.local</span></span>
<span class="line"><span style="color:#6F42C1;">DNS.7</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-master-01</span></span>
<span class="line"><span style="color:#6F42C1;">DNS.8</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-node-01</span></span>
<span class="line"><span style="color:#6F42C1;">DNS.9</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-node-02</span></span>
<span class="line"><span style="color:#6F42C1;">IP.1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1</span></span>
<span class="line"><span style="color:#6F42C1;">IP.2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.103</span><span style="color:#032F62;">.236.150</span></span>
<span class="line"><span style="color:#6F42C1;">IP.3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.103</span><span style="color:#032F62;">.236.151</span></span>
<span class="line"><span style="color:#6F42C1;">IP.4</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.103</span><span style="color:#032F62;">.236.152</span></span></code></pre></div><h2 id="_5-4生成ca" tabindex="-1">5.4生成ca <a class="header-anchor" href="#_5-4生成ca" aria-label="Permalink to &quot;5.4生成ca&quot;">​</a></h2><p>如果没有过期，不需要执行这步</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">genrsa</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-out</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ca-key.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2048</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;&amp;1</span></span>
<span class="line"><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">req</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-x509</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-new</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-nodes</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ca-key.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-days</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3650</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-out</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ca.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-subj</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/CN=etcd-ca&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;&amp;1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">genrsa</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ca-key.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2048</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/</span><span style="color:#24292E;">	</span><span style="color:#032F62;">dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;&amp;1</span></span>
<span class="line"><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">req</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-new</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-nodes</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ca-key.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-days</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3650</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ca.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-subj</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/CN=etcd-ca&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;&amp;1</span></span></code></pre></div><h3 id="生成etcd" tabindex="-1">生成etcd <a class="header-anchor" href="#生成etcd" aria-label="Permalink to &quot;生成etcd&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> host </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> kube-node-01 kube-node-02 ; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># Member key</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 用于 etcd 节点之间的通信</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">genrsa</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-out</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">member-</span><span style="color:#E1E4E8;">\${host}</span><span style="color:#9ECBFF;">-key.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2048</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;&amp;1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">req</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-new</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">member-</span><span style="color:#E1E4E8;">\${host}</span><span style="color:#9ECBFF;">-key.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-out</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">member-</span><span style="color:#E1E4E8;">\${host}</span><span style="color:#9ECBFF;">.csr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-subj</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/CN=etcd-member-\${</span><span style="color:#E1E4E8;">host</span><span style="color:#9ECBFF;">}&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openssl.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;&amp;1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">x509</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-req</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">member-</span><span style="color:#E1E4E8;">\${host}</span><span style="color:#9ECBFF;">.csr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-CA</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ca.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-CAkey</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ca-key.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-CAcreateserial</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-out</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">member-</span><span style="color:#E1E4E8;">\${host}</span><span style="color:#9ECBFF;">.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-days</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3650</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-extensions</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ssl_client</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-extfile</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openssl.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;&amp;1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># Admin key</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 用于 etcd 集群的管理</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">genrsa</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-out</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">admin-</span><span style="color:#E1E4E8;">\${host}</span><span style="color:#9ECBFF;">-key.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2048</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;&amp;1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">req</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-new</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">admin-</span><span style="color:#E1E4E8;">\${host}</span><span style="color:#9ECBFF;">-key.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-out</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">admin-</span><span style="color:#E1E4E8;">\${host}</span><span style="color:#9ECBFF;">.csr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-subj</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/CN=etcd-admin-\${</span><span style="color:#E1E4E8;">host</span><span style="color:#9ECBFF;">}&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;&amp;1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">x509</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-req</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">admin-</span><span style="color:#E1E4E8;">\${host}</span><span style="color:#9ECBFF;">.csr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-CA</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ca.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-CAkey</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ca-key.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-CAcreateserial</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-out</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">admin-</span><span style="color:#E1E4E8;">\${host}</span><span style="color:#9ECBFF;">.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-days</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3650</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-extensions</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ssl_client</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-extfile</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openssl.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;&amp;1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># Node keys</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 用于 etcd 节点与客户端之间的通信</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">genrsa</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-out</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node-</span><span style="color:#E1E4E8;">\${host}</span><span style="color:#9ECBFF;">-key.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2048</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;&amp;1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">req</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-new</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node-</span><span style="color:#E1E4E8;">\${host}</span><span style="color:#9ECBFF;">-key.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-out</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node-</span><span style="color:#E1E4E8;">\${host}</span><span style="color:#9ECBFF;">.csr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-subj</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/CN=etcd-node-\${</span><span style="color:#E1E4E8;">host</span><span style="color:#9ECBFF;">}&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;&amp;1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">x509</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-req</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node-</span><span style="color:#E1E4E8;">\${host}</span><span style="color:#9ECBFF;">.csr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-CA</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ca.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-CAkey</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ca-key.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-CAcreateserial</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-out</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node-</span><span style="color:#E1E4E8;">\${host}</span><span style="color:#9ECBFF;">.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-days</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3650</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-extensions</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ssl_client</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-extfile</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openssl.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;&amp;1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 将证书复制到每个节点</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">scp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-r</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/etcd/ssl/</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root@</span><span style="color:#E1E4E8;">\${host}</span><span style="color:#9ECBFF;">:/etc/etcd/ssl/</span></span>
<span class="line"><span style="color:#F97583;">done</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> host </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> kube-node-01 kube-node-02 ; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># Member key</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 用于 etcd 节点之间的通信</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">genrsa</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">member-</span><span style="color:#24292E;">\${host}</span><span style="color:#032F62;">-key.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2048</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;&amp;1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">req</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-new</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">member-</span><span style="color:#24292E;">\${host}</span><span style="color:#032F62;">-key.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">member-</span><span style="color:#24292E;">\${host}</span><span style="color:#032F62;">.csr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-subj</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/CN=etcd-member-\${</span><span style="color:#24292E;">host</span><span style="color:#032F62;">}&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openssl.conf</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;&amp;1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-req</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">member-</span><span style="color:#24292E;">\${host}</span><span style="color:#032F62;">.csr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-CA</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ca.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-CAkey</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ca-key.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-CAcreateserial</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">member-</span><span style="color:#24292E;">\${host}</span><span style="color:#032F62;">.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-days</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3650</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-extensions</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ssl_client</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-extfile</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openssl.conf</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;&amp;1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># Admin key</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 用于 etcd 集群的管理</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">genrsa</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">admin-</span><span style="color:#24292E;">\${host}</span><span style="color:#032F62;">-key.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2048</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;&amp;1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">req</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-new</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">admin-</span><span style="color:#24292E;">\${host}</span><span style="color:#032F62;">-key.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">admin-</span><span style="color:#24292E;">\${host}</span><span style="color:#032F62;">.csr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-subj</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/CN=etcd-admin-\${</span><span style="color:#24292E;">host</span><span style="color:#032F62;">}&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;&amp;1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-req</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">admin-</span><span style="color:#24292E;">\${host}</span><span style="color:#032F62;">.csr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-CA</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ca.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-CAkey</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ca-key.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-CAcreateserial</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">admin-</span><span style="color:#24292E;">\${host}</span><span style="color:#032F62;">.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-days</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3650</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-extensions</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ssl_client</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-extfile</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openssl.conf</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;&amp;1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># Node keys</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 用于 etcd 节点与客户端之间的通信</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">genrsa</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node-</span><span style="color:#24292E;">\${host}</span><span style="color:#032F62;">-key.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2048</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;&amp;1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">req</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-new</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node-</span><span style="color:#24292E;">\${host}</span><span style="color:#032F62;">-key.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node-</span><span style="color:#24292E;">\${host}</span><span style="color:#032F62;">.csr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-subj</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/CN=etcd-node-\${</span><span style="color:#24292E;">host</span><span style="color:#032F62;">}&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;&amp;1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-req</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node-</span><span style="color:#24292E;">\${host}</span><span style="color:#032F62;">.csr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-CA</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ca.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-CAkey</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ca-key.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-CAcreateserial</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node-</span><span style="color:#24292E;">\${host}</span><span style="color:#032F62;">.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-days</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3650</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-extensions</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ssl_client</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-extfile</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openssl.conf</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;&amp;1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 将证书复制到每个节点</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">scp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-r</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/etcd/ssl/</span><span style="color:#005CC5;">*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root@</span><span style="color:#24292E;">\${host}</span><span style="color:#032F62;">:/etc/etcd/ssl/</span></span>
<span class="line"><span style="color:#D73A49;">done</span></span></code></pre></div><h3 id="查看" tabindex="-1">查看 <a class="header-anchor" href="#查看" aria-label="Permalink to &quot;查看&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">x509</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ca.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-noout</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Not&#39;</span></span>
<span class="line"><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">x509</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">member-k8s-master1.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-noout</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Not&#39;</span></span>
<span class="line"><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">x509</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">admin-k8s-master1.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-noout</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Not&#39;</span></span>
<span class="line"><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">x509</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node-k8s-master1.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-noout</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Not&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ca.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-noout</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Not&#39;</span></span>
<span class="line"><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">member-k8s-master1.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-noout</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Not&#39;</span></span>
<span class="line"><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">admin-k8s-master1.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-noout</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Not&#39;</span></span>
<span class="line"><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node-k8s-master1.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-noout</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Not&#39;</span></span></code></pre></div><h2 id="_5-5修改配置文件" tabindex="-1">5.5修改配置文件 <a class="header-anchor" href="#_5-5修改配置文件" aria-label="Permalink to &quot;5.5修改配置文件&quot;">​</a></h2><p>修改所有etcd节点</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">Type</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">notify</span></span>
<span class="line"><span style="color:#E1E4E8;">WorkingDirectory</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/var/lib/etcd/</span></span>
<span class="line"><span style="color:#E1E4E8;">ExecStart</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/usr/local/bin/etcd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  --name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">k8s-master1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  --cert-file</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/etcd/ssl/member-k8s-master1.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  --key-file</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/etcd/ssl/member-k8s-master1-key.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  --peer-cert-file</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/etcd/ssl/member-k8s-master1.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  --peer-key-file</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/etcd/ssl/member-k8s-master1-key.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  --trusted-ca-file</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/etcd/ssl/ca.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  --peer-trusted-ca-file</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/etcd/ssl/ca.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">Type</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">notify</span></span>
<span class="line"><span style="color:#24292E;">WorkingDirectory</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/var/lib/etcd/</span></span>
<span class="line"><span style="color:#24292E;">ExecStart</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/usr/local/bin/etcd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  --name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">k8s-master1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  --cert-file</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/etcd/ssl/member-k8s-master1.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  --key-file</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/etcd/ssl/member-k8s-master1-key.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  --peer-cert-file</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/etcd/ssl/member-k8s-master1.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  --peer-key-file</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/etcd/ssl/member-k8s-master1-key.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  --trusted-ca-file</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/etcd/ssl/ca.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  --peer-trusted-ca-file</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/etcd/ssl/ca.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span></code></pre></div><ul><li>验证服务</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#重启etcd服务(记住，要3个节点一起重启，不然会hang住)</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--cacert=/etc/etcd/ssl/ca.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--cert=/etc/etcd/ssl/node-node1.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--key=/etc/etcd/ssl/node-node1-key.pem</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--endpoints=https://192.168.0.3:2379</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">endpoint</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">health</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#重启etcd服务(记住，要3个节点一起重启，不然会hang住)</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--cacert=/etc/etcd/ssl/ca.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--cert=/etc/etcd/ssl/node-node1.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--key=/etc/etcd/ssl/node-node1-key.pem</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--endpoints=https://192.168.0.3:2379</span><span style="color:#24292E;"> </span><span style="color:#032F62;">endpoint</span><span style="color:#24292E;"> </span><span style="color:#032F62;">health</span></span></code></pre></div><ul><li>key和crt 转 pem</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">.key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">转换成</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.pem：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rsa</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">temp.key</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-out</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">temp.pem</span></span>
<span class="line"><span style="color:#B392F0;">.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">转换成</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.pem：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">x509</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tmp.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-out</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tmp.pem</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">.key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">转换成</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.pem：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rsa</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">temp.key</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">temp.pem</span></span>
<span class="line"><span style="color:#6F42C1;">.crt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">转换成</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.pem：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tmp.crt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tmp.pem</span></span></code></pre></div>`,92),e=[o];function t(c,r,y,E,F,i){return a(),n("div",null,e)}const B=s(p,[["render",t]]);export{d as __pageData,B as default};
