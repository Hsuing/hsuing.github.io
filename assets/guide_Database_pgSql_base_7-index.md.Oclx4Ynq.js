import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const A=JSON.parse('{"title":"1，索引","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/pgSql/base/7-index.md","filePath":"guide/Database/pgSql/base/7-index.md","lastUpdated":1711696988000}'),p={name:"guide/Database/pgSql/base/7-index.md"},o=l(`<h1 id="_1-索引" tabindex="-1">1，索引 <a class="header-anchor" href="#_1-索引" aria-label="Permalink to &quot;1，索引&quot;">​</a></h1><h2 id="_11-1-btree索引详解" tabindex="-1">11.1 Btree索引详解 <a class="header-anchor" href="#_11-1-btree索引详解" aria-label="Permalink to &quot;11.1 Btree索引详解&quot;">​</a></h2><pre><code>当表数据量越来越大时查询速度会下降，像课本目录一样，在表的条件字段上创建索引，查询时能够快速定位感兴趣的数据所在的位置。索引的好处主要有加速带条件的查询，删除，更新，加速JOIN操作，加速外键约束更新和删除的操作等，但是索引也不是只有好处没有坏处，创建索引时会锁表，不仅将数据写入表中，还要创建索引，因此会在一定程度上影响写的性能
</code></pre><p>Btree索引适合处理能够按顺序存储的数据的=,&lt;,&gt;,&lt;=,&gt;=,以及等效这些操作符的其他操作如BETWEEN，IN以及IS NULL和以字符串开头的模糊查询。Btree索引要想起作用where条件必须包含第一个索引列</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 创建表</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> tbl_index(a </span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;">,b </span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">,c </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 插入数据</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;insert into</span><span style="color:#E1E4E8;"> tbl_index (a,b,c)  </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">generate_series</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;">),clock_timestamp()::</span><span style="color:#F97583;">timestamp</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;"> without time zone</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;got u&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">INSERT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3000000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">\\timing</span></span>
<span class="line"><span style="color:#E1E4E8;">Timing </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 创建索引前查询</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    a    |          b          |   c   </span></span>
<span class="line"><span style="color:#6A737D;">---------+---------------------+-------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">2020</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">08</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> | got u</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">117</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">992</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 创建索引</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> idx_tbl_index_a </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> btree(a); </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1194</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">789</span><span style="color:#E1E4E8;"> ms (</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">01</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">195</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 创建索引后查询</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    a    |          b          |   c   </span></span>
<span class="line"><span style="color:#6A737D;">---------+---------------------+-------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">2020</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">08</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">11</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> | got u</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">090</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 删除索引</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;drop</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> idx_tbl_index_a ; </span></span>
<span class="line"><span style="color:#F97583;">DROP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">117</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">472</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 创建组合索引</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> idx_tbl_index_a_b </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> btree(a,b);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 按字段a查询</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                          QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#6A737D;">------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> idx_tbl_index_a_b </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">43</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">45</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">033</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">035</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Cond: (a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">124</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">069</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 按字段b查询</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> b</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                        QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#6A737D;">---------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> Gather  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">35734</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">122</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">301</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">122</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">992</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   Workers Planned: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">   Workers Launched: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  Parallel Seq Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">34734</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">105</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">028</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">105</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">028</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: (b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">Rows</span><span style="color:#E1E4E8;"> Removed </span><span style="color:#F97583;">by</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1000000</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">176</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">123</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">019</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">096</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 组合字段查询 a and b</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> b</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                          QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#6A737D;">------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> idx_tbl_index_a_b </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">43</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">030</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">030</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Cond: ((a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> (b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">145</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">063</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">028</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 组合字段查询 a or b</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> b</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                        QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#6A737D;">---------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> Gather  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">38859</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">125</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">031</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">125</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">298</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   Workers Planned: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">   Workers Launched: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  Parallel Seq Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">37859</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">111</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">156</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">111</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">157</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: ((a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> (b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">Rows</span><span style="color:#E1E4E8;"> Removed </span><span style="color:#F97583;">by</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1000000</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">143</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">125</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">341</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">126</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">176</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">表中的索引实际是btree(a,b),从以上示例中可以看出，只有where条件包含索引的第一个字段，查询才会进行索引扫描，否则将进行全表扫描。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">or</span><span style="color:#E1E4E8;">，组合索引字段间使用and和or（</span><span style="color:#79B8FF;">测试例使用pg9</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">,记得低版本pg组合索引使用or查询会进行全表扫描）虽然都是索引扫描，但是and组合要比or组合查询速度更快</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 删除组合索引</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;drop</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> idx_tbl_index_a_b;</span></span>
<span class="line"><span style="color:#F97583;">DROP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">27</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">107</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 分别在a和b字段上创建索引</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> idx_tbl_index_a </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> btree (a); </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">841</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">557</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> idx_tbl_index_b </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> btree (b); </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1022</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">271</span><span style="color:#E1E4E8;"> ms (</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">01</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">022</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 分别使用a and b和a or b进行查询</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> b</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                         QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#6A737D;">----------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> idx_tbl_index_b </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">43</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">45</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">115</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">115</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Cond: (b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: (a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">873</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">164</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">353</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> b</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                          QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#6A737D;">------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> Bitmap Heap Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">88</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">89</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">172</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">174</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   Recheck Cond: ((a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> (b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">   Heap Blocks: exact</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  BitmapOr  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">88</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">88</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">163</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">163</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  Bitmap </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> idx_tbl_index_a  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">44</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">148</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">149</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Cond: (a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  Bitmap </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> idx_tbl_index_b  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">44</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">013</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">013</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Cond: (b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">148</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">243</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">567</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">结果显示分别在a和b字段上创建索引与在(a,b)组合字段上创建索引相比，and查询性能下降，但是or的性能可以提升</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 创建表</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> tbl_index(a </span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;">,b </span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">,c </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 插入数据</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;insert into</span><span style="color:#24292E;"> tbl_index (a,b,c)  </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">generate_series</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;">),clock_timestamp()::</span><span style="color:#D73A49;">timestamp</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span><span style="color:#D73A49;"> without time zone</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;got u&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">INSERT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3000000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">\\timing</span></span>
<span class="line"><span style="color:#24292E;">Timing </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">on</span><span style="color:#24292E;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 创建索引前查询</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    a    |          b          |   c   </span></span>
<span class="line"><span style="color:#6A737D;">---------+---------------------+-------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">2020</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">08</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> | got u</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">117</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">992</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 创建索引</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> idx_tbl_index_a </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> btree(a); </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1194</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">789</span><span style="color:#24292E;"> ms (</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">01</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">195</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 创建索引后查询</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    a    |          b          |   c   </span></span>
<span class="line"><span style="color:#6A737D;">---------+---------------------+-------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">2020</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">08</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">11</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> | got u</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">090</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 删除索引</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;drop</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> idx_tbl_index_a ; </span></span>
<span class="line"><span style="color:#D73A49;">DROP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">117</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">472</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 创建组合索引</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> idx_tbl_index_a_b </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> btree(a,b);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 按字段a查询</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                                                          QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#6A737D;">------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> idx_tbl_index_a_b </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">43</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">45</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">22</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">033</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">035</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Cond: (a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">124</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">069</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 按字段b查询</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> b</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                        QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#6A737D;">---------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> Gather  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">35734</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">22</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">122</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">301</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">122</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">992</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   Workers Planned: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">   Workers Launched: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  Parallel Seq Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">34734</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">22</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">105</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">028</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">105</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">028</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: (b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">Rows</span><span style="color:#24292E;"> Removed </span><span style="color:#D73A49;">by</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1000000</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">176</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">123</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">019</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">096</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 组合字段查询 a and b</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> b</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                          QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#6A737D;">------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> idx_tbl_index_a_b </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">43</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">6</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">22</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">030</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">030</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Cond: ((a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> (b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">145</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">063</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">028</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 组合字段查询 a or b</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> b</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                                                        QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#6A737D;">---------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> Gather  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">38859</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">22</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">125</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">031</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">125</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">298</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   Workers Planned: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">   Workers Launched: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  Parallel Seq Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">37859</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">22</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">111</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">156</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">111</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">157</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: ((a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> (b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">Rows</span><span style="color:#24292E;"> Removed </span><span style="color:#D73A49;">by</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1000000</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">143</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">125</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">341</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">126</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">176</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">表中的索引实际是btree(a,b),从以上示例中可以看出，只有where条件包含索引的第一个字段，查询才会进行索引扫描，否则将进行全表扫描。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">or</span><span style="color:#24292E;">，组合索引字段间使用and和or（</span><span style="color:#005CC5;">测试例使用pg9</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">6</span><span style="color:#24292E;">,记得低版本pg组合索引使用or查询会进行全表扫描）虽然都是索引扫描，但是and组合要比or组合查询速度更快</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 删除组合索引</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;drop</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> idx_tbl_index_a_b;</span></span>
<span class="line"><span style="color:#D73A49;">DROP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">27</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">107</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 分别在a和b字段上创建索引</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> idx_tbl_index_a </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> btree (a); </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">841</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">557</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> idx_tbl_index_b </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> btree (b); </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1022</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">271</span><span style="color:#24292E;"> ms (</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">01</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">022</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 分别使用a and b和a or b进行查询</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> b</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                                                         QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#6A737D;">----------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> idx_tbl_index_b </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">43</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">45</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">22</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">115</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">115</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Cond: (b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: (a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">873</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">164</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">353</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> b</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                                                          QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#6A737D;">------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> Bitmap Heap Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">88</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">89</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">22</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">172</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">174</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   Recheck Cond: ((a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> (b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">   Heap Blocks: exact</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  BitmapOr  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">88</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">88</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">163</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">163</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  Bitmap </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> idx_tbl_index_a  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">44</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">148</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">149</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Cond: (a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  Bitmap </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> idx_tbl_index_b  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">44</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">013</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">013</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Cond: (b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">148</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">243</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">567</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">结果显示分别在a和b字段上创建索引与在(a,b)组合字段上创建索引相比，and查询性能下降，但是or的性能可以提升</span></span></code></pre></div><h2 id="_11-2-gist索引" tabindex="-1">11.2 Gist索引 <a class="header-anchor" href="#_11-2-gist索引" aria-label="Permalink to &quot;11.2 Gist索引&quot;">​</a></h2><p>GiST的意思是通用的搜索树(Generalized Search Tree)。 它是一种平衡树结构的访问方法,在系统中作为一个基本模版,可以使用它实现任意索引模式。B-trees, R-trees和许多其它的索引模式都可以用GiST实现</p><p>与Btree索引比较的优缺点</p><table><thead><tr><th>与Btree索引比较的优缺点</th><th></th></tr></thead><tbody><tr><td>优点</td><td>Gist索引适用于多维数据类型和集合数据类型，和Btree索引类似，同样适用于其他的数据类型。和Btree索引相比，Gist多字段索引在查询条件中包含索引字段的任何子集都会使用索引扫描，而Btree索引只有查询条件包含第一个索引字段才会使用索引扫描</td></tr><tr><td>缺点</td><td>Gist索引创建耗时较长，占用空间也比较大</td></tr></tbody></table><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 测试表</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> tbl_index(a </span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;">,b </span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">,c </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">)); </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">771</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 插入数据</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;insert into</span><span style="color:#E1E4E8;"> tbl_index (a,b,c)  </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">generate_series</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;">),clock_timestamp()::</span><span style="color:#F97583;">timestamp</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;"> without time zone</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;got u&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">INSERT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3000000</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3018</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">547</span><span style="color:#E1E4E8;"> ms (</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">03</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">019</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 创建扩展btree_gist,</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> extension btree_gist;</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> EXTENSION</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 创建索引</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> idx_gist_tbl_index_a_b </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> gist(a,b);</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">34898</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">653</span><span style="color:#E1E4E8;"> ms (</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">34</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">899</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--如果没有在库里创建扩展，则会出现</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> idx_gist_tbl_index_a_b </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> gist(a,b);</span></span>
<span class="line"><span style="color:#E1E4E8;">ERROR:  </span><span style="color:#F97583;">data</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;"> has </span><span style="color:#F97583;">no</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;"> operator class </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> access method </span><span style="color:#9ECBFF;">&quot;gist&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">HINT:  You must specify an operator class </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> the </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> define a </span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;"> operator class </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> the </span><span style="color:#F97583;">data</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">type</span><span style="color:#E1E4E8;">.</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 使用字段a查询</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                       QUERY PLAN                                                        </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> Gather  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">35734</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">218</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">84</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">883</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   Workers Planned: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">   Workers Launched: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  Parallel Seq Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">34734</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">75</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">75</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: (a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3000000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">Rows</span><span style="color:#E1E4E8;"> Removed </span><span style="color:#F97583;">by</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1000000</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">227</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">84</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">897</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">85</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">528</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">a,b 以上两条SQL语句的区别在于第一条SQL语句按照a的类型bigint去查询，而第二条SQL语句却将bigint转成char类型查询，但是结果显示char类型的查询（索引扫描）性能远高于bigint的查询（全表扫描）性能，怀疑是不是创建索引时将bigint转成char类型了，反正Gist索引查询最好使用char</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 示例2.使用字段b查询</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> b</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                            QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D;">----</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> idx_gist_tbl_index_a_b </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">41</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">43</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">011</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">011</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span></span>
<span class="line"><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Cond: (b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">098</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">024</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">336</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">该查询不包含第一个索引字段，但是仍使用索引扫描，而此条件下Btree索引只能全表扫描</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 示例3.使用a and b查询</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;3000000&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> b</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                            QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D;">----</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> idx_gist_tbl_index_a_b </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">41</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">43</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">011</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">011</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span></span>
<span class="line"><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Cond: ((a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;3000000&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> (b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">060</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">026</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">449</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--示例4.使用a or b查询</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;3000000&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> b</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                             QUERY PLAN                                                        </span></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D;">------</span></span>
<span class="line"><span style="color:#E1E4E8;"> Bitmap Heap Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">84</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">86</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">22</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">023</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">023</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   Recheck Cond: ((a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;3000000&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> (b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">   Heap Blocks: exact</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  BitmapOr  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">84</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">84</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">019</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">019</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  Bitmap </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> idx_gist_tbl_index_a_b  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">42</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">017</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">017</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> loo</span></span>
<span class="line"><span style="color:#E1E4E8;">ps</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Cond: (a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;3000000&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  Bitmap </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> idx_gist_tbl_index_a_b  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">42</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">001</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">001</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loo</span></span>
<span class="line"><span style="color:#E1E4E8;">ps</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Cond: (b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">052</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">048</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">650</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">使用and和or查询虽然也是索引扫描，但是和Btree索引相比并没有性能提升</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看索引大小</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;select</span><span style="color:#E1E4E8;"> relname,pg_size_pretty(pg_relation_size(</span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_class </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> relname </span><span style="color:#F97583;">like</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;idx_%_tbl_index_a_b&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">         relname         | pg_size_pretty </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------+----------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> idx_btree_tbl_index_a_b | </span><span style="color:#79B8FF;">90</span><span style="color:#E1E4E8;"> MB</span></span>
<span class="line"><span style="color:#E1E4E8;"> idx_gist_tbl_index_a_b  | </span><span style="color:#79B8FF;">286</span><span style="color:#E1E4E8;"> MB</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">858</span><span style="color:#E1E4E8;"> ms</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 测试表</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> tbl_index(a </span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;">,b </span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">,c </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">)); </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">771</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 插入数据</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;insert into</span><span style="color:#24292E;"> tbl_index (a,b,c)  </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">generate_series</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;">),clock_timestamp()::</span><span style="color:#D73A49;">timestamp</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span><span style="color:#D73A49;"> without time zone</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;got u&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">INSERT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3000000</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3018</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">547</span><span style="color:#24292E;"> ms (</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">03</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">019</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 创建扩展btree_gist,</span></span>
<span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> extension btree_gist;</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> EXTENSION</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 创建索引</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> idx_gist_tbl_index_a_b </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> gist(a,b);</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">34898</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">653</span><span style="color:#24292E;"> ms (</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">34</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">899</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--如果没有在库里创建扩展，则会出现</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> idx_gist_tbl_index_a_b </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> gist(a,b);</span></span>
<span class="line"><span style="color:#24292E;">ERROR:  </span><span style="color:#D73A49;">data</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">type</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;"> has </span><span style="color:#D73A49;">no</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">default</span><span style="color:#24292E;"> operator class </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> access method </span><span style="color:#032F62;">&quot;gist&quot;</span></span>
<span class="line"><span style="color:#24292E;">HINT:  You must specify an operator class </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> the </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> define a </span><span style="color:#D73A49;">default</span><span style="color:#24292E;"> operator class </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> the </span><span style="color:#D73A49;">data</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">type</span><span style="color:#24292E;">.</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 使用字段a查询</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                       QUERY PLAN                                                        </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> Gather  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">35734</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">22</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">80</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">218</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">84</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">883</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   Workers Planned: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">   Workers Launched: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  Parallel Seq Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">34734</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">22</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">75</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">75</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">100</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: (a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3000000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">Rows</span><span style="color:#24292E;"> Removed </span><span style="color:#D73A49;">by</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1000000</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">227</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">84</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">897</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">85</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">528</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">a,b 以上两条SQL语句的区别在于第一条SQL语句按照a的类型bigint去查询，而第二条SQL语句却将bigint转成char类型查询，但是结果显示char类型的查询（索引扫描）性能远高于bigint的查询（全表扫描）性能，怀疑是不是创建索引时将bigint转成char类型了，反正Gist索引查询最好使用char</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 示例2.使用字段b查询</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> b</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                            QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D;">----</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> idx_gist_tbl_index_a_b </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">41</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">43</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">22</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">011</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">011</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span></span>
<span class="line"><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Cond: (b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">098</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">024</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">336</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">该查询不包含第一个索引字段，但是仍使用索引扫描，而此条件下Btree索引只能全表扫描</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 示例3.使用a and b查询</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;3000000&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> b</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                            QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D;">----</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> idx_gist_tbl_index_a_b </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">41</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">43</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">22</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">011</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">011</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span></span>
<span class="line"><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Cond: ((a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;3000000&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> (b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">060</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">026</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">449</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--示例4.使用a or b查询</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;3000000&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> b</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                             QUERY PLAN                                                        </span></span>
<span class="line"><span style="color:#24292E;">      </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D;">------</span></span>
<span class="line"><span style="color:#24292E;"> Bitmap Heap Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">84</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">86</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">22</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">023</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">023</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   Recheck Cond: ((a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;3000000&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> (b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">   Heap Blocks: exact</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  BitmapOr  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">84</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">84</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">019</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">019</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  Bitmap </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> idx_gist_tbl_index_a_b  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">42</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">017</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">017</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> loo</span></span>
<span class="line"><span style="color:#24292E;">ps</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Cond: (a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;3000000&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  Bitmap </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> idx_gist_tbl_index_a_b  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">42</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">001</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">001</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loo</span></span>
<span class="line"><span style="color:#24292E;">ps</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Cond: (b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2016-06-29 14:54:00&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">052</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">048</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">650</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">使用and和or查询虽然也是索引扫描，但是和Btree索引相比并没有性能提升</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看索引大小</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;select</span><span style="color:#24292E;"> relname,pg_size_pretty(pg_relation_size(</span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_class </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> relname </span><span style="color:#D73A49;">like</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;idx_%_tbl_index_a_b&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">         relname         | pg_size_pretty </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------+----------------</span></span>
<span class="line"><span style="color:#24292E;"> idx_btree_tbl_index_a_b | </span><span style="color:#005CC5;">90</span><span style="color:#24292E;"> MB</span></span>
<span class="line"><span style="color:#24292E;"> idx_gist_tbl_index_a_b  | </span><span style="color:#005CC5;">286</span><span style="color:#24292E;"> MB</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">858</span><span style="color:#24292E;"> ms</span></span></code></pre></div><h2 id="唯一索引" tabindex="-1">唯一索引 <a class="header-anchor" href="#唯一索引" aria-label="Permalink to &quot;唯一索引&quot;">​</a></h2><pre><code>唯一索引字面上理解就是在索引上增加唯一约束，不允许出现索引值相同的行，目前只有Btree索引可以声明唯一索引，唯一键会自动创建唯一索引
</code></pre><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> tbl_unique_index(a </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">, b </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">789</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 示例1.创建唯一索引，相等数据只允许插入一行，NULL除外，因为NULL不等于NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">unique</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> idx_unq_tbl_unique_index_a_b </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_unique_index </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> btree (a,b);</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">245</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看索引</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">\\d tbl_unique_index </span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">Table</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;public.tbl_unique_index&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;"> Column |  </span><span style="color:#F97583;">Type</span><span style="color:#E1E4E8;">   | Collation | Nullable | </span><span style="color:#F97583;">Default</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">--------+---------+-----------+----------+---------</span></span>
<span class="line"><span style="color:#E1E4E8;"> a      | </span><span style="color:#F97583;">integer</span><span style="color:#E1E4E8;"> |           |          | </span></span>
<span class="line"><span style="color:#E1E4E8;"> b      | </span><span style="color:#F97583;">integer</span><span style="color:#E1E4E8;"> |           |          | </span></span>
<span class="line"><span style="color:#E1E4E8;">Indexes:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;idx_unq_tbl_unique_index_a_b&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">UNIQUE</span><span style="color:#E1E4E8;">, btree (a, b)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;insert into</span><span style="color:#E1E4E8;"> tbl_unique_index </span><span style="color:#F97583;">values</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">ERROR:  duplicate </span><span style="color:#F97583;">key</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;"> violates </span><span style="color:#F97583;">unique</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">constraint</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;idx_unq_tbl_unique_index_a_b&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">DETAIL:  </span><span style="color:#F97583;">Key</span><span style="color:#E1E4E8;"> (a, b)</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) already </span><span style="color:#F97583;">exists</span><span style="color:#E1E4E8;">.</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">536</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;insert into</span><span style="color:#E1E4E8;"> tbl_unique_index </span><span style="color:#F97583;">values</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">INSERT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">357</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;insert into</span><span style="color:#E1E4E8;"> tbl_unique_index </span><span style="color:#F97583;">values</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">INSERT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">946</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;insert into</span><span style="color:#E1E4E8;"> tbl_unique_index </span><span style="color:#F97583;">values</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">INSERT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">900</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 示例2.唯一键会自动创建唯一索引</span></span>
<span class="line"><span style="color:#E1E4E8;">#清空表</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;truncate</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> tbl_unique_index ;</span></span>
<span class="line"><span style="color:#F97583;">TRUNCATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 添加索引</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;alter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> tbl_unique_index </span><span style="color:#F97583;">add</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">constraint</span><span style="color:#E1E4E8;"> pk_tbl_unique_index_a </span><span style="color:#F97583;">primary key</span><span style="color:#E1E4E8;">(a);</span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;alter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> tbl_unique_index </span><span style="color:#F97583;">add</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">constraint</span><span style="color:#E1E4E8;"> uk_tbl_unique_index_b </span><span style="color:#F97583;">unique</span><span style="color:#E1E4E8;">(b); </span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> \\d tbl_unique_index</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">Table</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;public.tbl_unique_index&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;"> Column |  </span><span style="color:#F97583;">Type</span><span style="color:#E1E4E8;">   | Collation | Nullable | </span><span style="color:#F97583;">Default</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">--------+---------+-----------+----------+---------</span></span>
<span class="line"><span style="color:#E1E4E8;"> a      | </span><span style="color:#F97583;">integer</span><span style="color:#E1E4E8;"> |           | </span><span style="color:#F97583;">not null</span><span style="color:#E1E4E8;"> | </span></span>
<span class="line"><span style="color:#E1E4E8;"> b      | </span><span style="color:#F97583;">integer</span><span style="color:#E1E4E8;"> |           |          | </span></span>
<span class="line"><span style="color:#E1E4E8;">Indexes:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;pk_tbl_unique_index_a&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PRIMARY KEY</span><span style="color:#E1E4E8;">, btree (a)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;idx_unq_tbl_unique_index_a_b&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">UNIQUE</span><span style="color:#E1E4E8;">, btree (a, b)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;uk_tbl_unique_index_b&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">UNIQUE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CONSTRAINT</span><span style="color:#E1E4E8;">, btree (b)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 插入实例</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;insert into</span><span style="color:#E1E4E8;"> tbl_unique_index </span><span style="color:#F97583;">values</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">INSERT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;insert into</span><span style="color:#E1E4E8;"> tbl_unique_index </span><span style="color:#F97583;">values</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">ERROR:  duplicate </span><span style="color:#F97583;">key</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;"> violates </span><span style="color:#F97583;">unique</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">constraint</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;pk_tbl_unique_index_a&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">DETAIL:  </span><span style="color:#F97583;">Key</span><span style="color:#E1E4E8;"> (a)</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) already </span><span style="color:#F97583;">exists</span><span style="color:#E1E4E8;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;insert into</span><span style="color:#E1E4E8;"> tbl_unique_index </span><span style="color:#F97583;">values</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">ERROR:  duplicate </span><span style="color:#F97583;">key</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;"> violates </span><span style="color:#F97583;">unique</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">constraint</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;pk_tbl_unique_index_a&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">DETAIL:  </span><span style="color:#F97583;">Key</span><span style="color:#E1E4E8;"> (a)</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) already </span><span style="color:#F97583;">exists</span><span style="color:#E1E4E8;">.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> tbl_unique_index(a </span><span style="color:#D73A49;">int</span><span style="color:#24292E;">, b </span><span style="color:#D73A49;">int</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">789</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 示例1.创建唯一索引，相等数据只允许插入一行，NULL除外，因为NULL不等于NULL</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">unique</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> idx_unq_tbl_unique_index_a_b </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_unique_index </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> btree (a,b);</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">245</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看索引</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">\\d tbl_unique_index </span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">Table</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;public.tbl_unique_index&quot;</span></span>
<span class="line"><span style="color:#24292E;"> Column |  </span><span style="color:#D73A49;">Type</span><span style="color:#24292E;">   | Collation | Nullable | </span><span style="color:#D73A49;">Default</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">--------+---------+-----------+----------+---------</span></span>
<span class="line"><span style="color:#24292E;"> a      | </span><span style="color:#D73A49;">integer</span><span style="color:#24292E;"> |           |          | </span></span>
<span class="line"><span style="color:#24292E;"> b      | </span><span style="color:#D73A49;">integer</span><span style="color:#24292E;"> |           |          | </span></span>
<span class="line"><span style="color:#24292E;">Indexes:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;idx_unq_tbl_unique_index_a_b&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">UNIQUE</span><span style="color:#24292E;">, btree (a, b)</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;insert into</span><span style="color:#24292E;"> tbl_unique_index </span><span style="color:#D73A49;">values</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">ERROR:  duplicate </span><span style="color:#D73A49;">key</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">value</span><span style="color:#24292E;"> violates </span><span style="color:#D73A49;">unique</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">constraint</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;idx_unq_tbl_unique_index_a_b&quot;</span></span>
<span class="line"><span style="color:#24292E;">DETAIL:  </span><span style="color:#D73A49;">Key</span><span style="color:#24292E;"> (a, b)</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) already </span><span style="color:#D73A49;">exists</span><span style="color:#24292E;">.</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">536</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;insert into</span><span style="color:#24292E;"> tbl_unique_index </span><span style="color:#D73A49;">values</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">INSERT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">357</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;insert into</span><span style="color:#24292E;"> tbl_unique_index </span><span style="color:#D73A49;">values</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">INSERT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">946</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;insert into</span><span style="color:#24292E;"> tbl_unique_index </span><span style="color:#D73A49;">values</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">INSERT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">900</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 示例2.唯一键会自动创建唯一索引</span></span>
<span class="line"><span style="color:#24292E;">#清空表</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;truncate</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> tbl_unique_index ;</span></span>
<span class="line"><span style="color:#D73A49;">TRUNCATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 添加索引</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;alter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> tbl_unique_index </span><span style="color:#D73A49;">add</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">constraint</span><span style="color:#24292E;"> pk_tbl_unique_index_a </span><span style="color:#D73A49;">primary key</span><span style="color:#24292E;">(a);</span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;alter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> tbl_unique_index </span><span style="color:#D73A49;">add</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">constraint</span><span style="color:#24292E;"> uk_tbl_unique_index_b </span><span style="color:#D73A49;">unique</span><span style="color:#24292E;">(b); </span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> \\d tbl_unique_index</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">Table</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;public.tbl_unique_index&quot;</span></span>
<span class="line"><span style="color:#24292E;"> Column |  </span><span style="color:#D73A49;">Type</span><span style="color:#24292E;">   | Collation | Nullable | </span><span style="color:#D73A49;">Default</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">--------+---------+-----------+----------+---------</span></span>
<span class="line"><span style="color:#24292E;"> a      | </span><span style="color:#D73A49;">integer</span><span style="color:#24292E;"> |           | </span><span style="color:#D73A49;">not null</span><span style="color:#24292E;"> | </span></span>
<span class="line"><span style="color:#24292E;"> b      | </span><span style="color:#D73A49;">integer</span><span style="color:#24292E;"> |           |          | </span></span>
<span class="line"><span style="color:#24292E;">Indexes:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;pk_tbl_unique_index_a&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PRIMARY KEY</span><span style="color:#24292E;">, btree (a)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;idx_unq_tbl_unique_index_a_b&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">UNIQUE</span><span style="color:#24292E;">, btree (a, b)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;uk_tbl_unique_index_b&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">UNIQUE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CONSTRAINT</span><span style="color:#24292E;">, btree (b)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 插入实例</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;insert into</span><span style="color:#24292E;"> tbl_unique_index </span><span style="color:#D73A49;">values</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">INSERT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;insert into</span><span style="color:#24292E;"> tbl_unique_index </span><span style="color:#D73A49;">values</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">ERROR:  duplicate </span><span style="color:#D73A49;">key</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">value</span><span style="color:#24292E;"> violates </span><span style="color:#D73A49;">unique</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">constraint</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pk_tbl_unique_index_a&quot;</span></span>
<span class="line"><span style="color:#24292E;">DETAIL:  </span><span style="color:#D73A49;">Key</span><span style="color:#24292E;"> (a)</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) already </span><span style="color:#D73A49;">exists</span><span style="color:#24292E;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;insert into</span><span style="color:#24292E;"> tbl_unique_index </span><span style="color:#D73A49;">values</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">ERROR:  duplicate </span><span style="color:#D73A49;">key</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">value</span><span style="color:#24292E;"> violates </span><span style="color:#D73A49;">unique</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">constraint</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pk_tbl_unique_index_a&quot;</span></span>
<span class="line"><span style="color:#24292E;">DETAIL:  </span><span style="color:#D73A49;">Key</span><span style="color:#24292E;"> (a)</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) already </span><span style="color:#D73A49;">exists</span><span style="color:#24292E;">.</span></span></code></pre></div><h2 id="表达式索引" tabindex="-1">表达式索引 <a class="header-anchor" href="#表达式索引" aria-label="Permalink to &quot;表达式索引&quot;">​</a></h2><pre><code>除针对表的字段直接创建索引外，还可以对字段进行某种运算之后的结果创建索引
</code></pre><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--测试表</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> tbl_expression(a </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">), b </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;insert into</span><span style="color:#E1E4E8;"> tbl_expression </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">concat</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;test&#39;</span><span style="color:#E1E4E8;">,x),</span><span style="color:#79B8FF;">concat</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;you&#39;</span><span style="color:#E1E4E8;">,x) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">generate_series</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">10000</span><span style="color:#E1E4E8;">) x;</span></span>
<span class="line"><span style="color:#F97583;">INSERT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 如果此时分别在a和b字段上各创建一个Btree索引，分别使用a和b字段查询时会进行索引扫描</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> idx_tbl_expression_a </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_expression </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> btree (a); </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> idx_tbl_expression_b </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_expression </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> btree (b); </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_expression </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;TEST&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              QUERY PLAN                                                       </span></span>
<span class="line"><span style="color:#E1E4E8;">       </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D;">-------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> idx_tbl_expression_a </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_expression  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">29</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">020</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">020</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> lo</span></span>
<span class="line"><span style="color:#E1E4E8;">ops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Cond: ((a)::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;TEST&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">297</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">041</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                                                              QUERY PLAN                                                       </span></span>
<span class="line"><span style="color:#E1E4E8;">       </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D;">-------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> idx_tbl_expression_b </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_expression  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">29</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">047</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">047</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> lo</span></span>
<span class="line"><span style="color:#E1E4E8;">ops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Cond: ((b)::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;you&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">043</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">056</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--测试表</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> tbl_expression(a </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">32</span><span style="color:#24292E;">), b </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">32</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;insert into</span><span style="color:#24292E;"> tbl_expression </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">concat</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;test&#39;</span><span style="color:#24292E;">,x),</span><span style="color:#005CC5;">concat</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;you&#39;</span><span style="color:#24292E;">,x) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">generate_series</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">10000</span><span style="color:#24292E;">) x;</span></span>
<span class="line"><span style="color:#D73A49;">INSERT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 如果此时分别在a和b字段上各创建一个Btree索引，分别使用a和b字段查询时会进行索引扫描</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> idx_tbl_expression_a </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_expression </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> btree (a); </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> idx_tbl_expression_b </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_expression </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> btree (b); </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_expression </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;TEST&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                                                              QUERY PLAN                                                       </span></span>
<span class="line"><span style="color:#24292E;">       </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D;">-------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> idx_tbl_expression_a </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_expression  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">29</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">15</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">020</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">020</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> lo</span></span>
<span class="line"><span style="color:#24292E;">ops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Cond: ((a)::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;TEST&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">297</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">041</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                                                              QUERY PLAN                                                       </span></span>
<span class="line"><span style="color:#24292E;">       </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D;">-------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> idx_tbl_expression_b </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_expression  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">29</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">15</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">047</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">047</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> lo</span></span>
<span class="line"><span style="color:#24292E;">ops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Cond: ((b)::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;you&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">043</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">056</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span></code></pre></div><p>但是下面的两种查询方式是不会进行索引扫描的</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_expression </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">upper</span><span style="color:#E1E4E8;">(a) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;TEST&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;"> a | b </span></span>
<span class="line"><span style="color:#6A737D;">---+---</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_expression </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> (a </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">b) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;test you&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;"> a | b </span></span>
<span class="line"><span style="color:#6A737D;">---+---</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_expression </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">upper</span><span style="color:#E1E4E8;">(a) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;TEST&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                 QUERY PLAN                                                 </span></span>
<span class="line"><span style="color:#6A737D;">------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> Seq Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_expression  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">213</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">447</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">447</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: (</span><span style="color:#79B8FF;">upper</span><span style="color:#E1E4E8;">((a)::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;TEST&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Rows</span><span style="color:#E1E4E8;"> Removed </span><span style="color:#F97583;">by</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10000</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">034</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">456</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_expression </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> (a </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">b) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;test you&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                 QUERY PLAN                                                 </span></span>
<span class="line"><span style="color:#6A737D;">------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> Seq Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_expression  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">238</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">370</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">370</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: ((((a)::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> (b)::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;test you&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Rows</span><span style="color:#E1E4E8;"> Removed </span><span style="color:#F97583;">by</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10000</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">039</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">381</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 此时就可以使用表达式创建索引来解决此类全表扫描问题</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_expression </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">upper</span><span style="color:#E1E4E8;">(a) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;TEST&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                 QUERY PLAN                                                 </span></span>
<span class="line"><span style="color:#6A737D;">------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> Seq Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_expression  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">213</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">9</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">952</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">9</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">952</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: (</span><span style="color:#79B8FF;">upper</span><span style="color:#E1E4E8;">((a)::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;TEST&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Rows</span><span style="color:#E1E4E8;"> Removed </span><span style="color:#F97583;">by</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10000</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">098</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">980</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> idx_tbl_expression_a_b </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_expression ((a</span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">b));</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> INDE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_expression </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> (a </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">b) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;test you&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                           QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#F97583;">-</span></span>
<span class="line"><span style="color:#E1E4E8;"> Bitmap Heap Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_expression  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">67</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">67</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">91</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">095</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">095</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   Recheck Cond: ((((a)::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> (b)::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;test you&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  Bitmap </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> idx_tbl_expression_a_b  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">66</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">092</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">092</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Cond: ((((a)::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> (b)::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;test you&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">441</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">136</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">但是还是需要根据实际业务情况仔细评估后决定采用何种索引，因为并不是索引越多越好</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_expression </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">upper</span><span style="color:#24292E;">(a) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;TEST&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;"> a | b </span></span>
<span class="line"><span style="color:#6A737D;">---+---</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_expression </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> (a </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;">b) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;test you&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;"> a | b </span></span>
<span class="line"><span style="color:#6A737D;">---+---</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_expression </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">upper</span><span style="color:#24292E;">(a) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;TEST&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                                                 QUERY PLAN                                                 </span></span>
<span class="line"><span style="color:#6A737D;">------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> Seq Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_expression  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">213</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">15</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">447</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">447</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: (</span><span style="color:#005CC5;">upper</span><span style="color:#24292E;">((a)::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;TEST&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Rows</span><span style="color:#24292E;"> Removed </span><span style="color:#D73A49;">by</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10000</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">034</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">456</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_expression </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> (a </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;">b) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;test you&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                 QUERY PLAN                                                 </span></span>
<span class="line"><span style="color:#6A737D;">------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> Seq Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_expression  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">238</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">15</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">370</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">370</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: ((((a)::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> (b)::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;test you&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Rows</span><span style="color:#24292E;"> Removed </span><span style="color:#D73A49;">by</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10000</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">039</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">381</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 此时就可以使用表达式创建索引来解决此类全表扫描问题</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_expression </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">upper</span><span style="color:#24292E;">(a) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;TEST&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                 QUERY PLAN                                                 </span></span>
<span class="line"><span style="color:#6A737D;">------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> Seq Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_expression  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">213</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">15</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">9</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">952</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">9</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">952</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: (</span><span style="color:#005CC5;">upper</span><span style="color:#24292E;">((a)::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;TEST&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Rows</span><span style="color:#24292E;"> Removed </span><span style="color:#D73A49;">by</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10000</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">098</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">980</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> idx_tbl_expression_a_b </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_expression ((a</span><span style="color:#D73A49;">||</span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;">b));</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> INDE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_expression </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> (a </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;">b) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;test you&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                           QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#D73A49;">-</span></span>
<span class="line"><span style="color:#24292E;"> Bitmap Heap Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_expression  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">67</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">67</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">91</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">15</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">095</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">095</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   Recheck Cond: ((((a)::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> (b)::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;test you&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  Bitmap </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> idx_tbl_expression_a_b  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">66</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">092</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">092</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Cond: ((((a)::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> (b)::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;test you&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">441</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">136</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">但是还是需要根据实际业务情况仔细评估后决定采用何种索引，因为并不是索引越多越好</span></span></code></pre></div><h2 id="部分索引" tabindex="-1">部分索引 <a class="header-anchor" href="#部分索引" aria-label="Permalink to &quot;部分索引&quot;">​</a></h2><pre><code>只在自己感兴趣的那部分数据上创建索引，而不是对每一行数据都创建索引，此种方式创建索引就需要使用WHERE条件了

创建两个完全相同的表比较部分索引和全索引的区别
</code></pre><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> tbl_partial_index(id </span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;">,alarm_time </span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">level</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">),alarm_desc </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">)); </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> tbl_partial_index1(id </span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;">,alarm_time </span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">level</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">),alarm_desc </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">)); </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 写入完全相同的数据</span></span>
<span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">insert into</span><span style="color:#E1E4E8;"> tbl_partial_index(id,alarm_time,</span><span style="color:#F97583;">level</span><span style="color:#E1E4E8;">,alarm_desc) </span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">generate_series</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">9000000</span><span style="color:#E1E4E8;">),clock_timestamp()::</span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;green&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;正常&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#F97583;">INSERT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">9000000</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">insert into</span><span style="color:#E1E4E8;"> tbl_partial_index(id,alarm_time,</span><span style="color:#F97583;">level</span><span style="color:#E1E4E8;">,alarm_desc) </span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">generate_series</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">9000000</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">9000100</span><span style="color:#E1E4E8;">),clock_timestamp()::</span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;red&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;攻击&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#F97583;">INSERT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">101</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">#  </span></span>
<span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">#  </span></span>
<span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">insert into</span><span style="color:#E1E4E8;"> tbl_partial_index1(id,alarm_time,</span><span style="color:#F97583;">level</span><span style="color:#E1E4E8;">,alarm_desc) </span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">generate_series</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">9000000</span><span style="color:#E1E4E8;">),clock_timestamp()::</span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;green&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;正常&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#F97583;">INSERT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">9000000</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">insert into</span><span style="color:#E1E4E8;"> tbl_partial_index1(id,alarm_time,</span><span style="color:#F97583;">level</span><span style="color:#E1E4E8;">,alarm_desc) </span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">generate_series</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">9000000</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">9000100</span><span style="color:#E1E4E8;">),clock_timestamp()::</span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;red&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;攻击&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#F97583;">INSERT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">101</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 示例1.在tbl_partial_index表字段level上创建索引</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> idx_tbl_partial_index_level </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_partial_index </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> btree (</span><span style="color:#F97583;">level</span><span style="color:#E1E4E8;">); </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_partial_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">level</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;red&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                                    QUERY PLAN                                                 </span></span>
<span class="line"><span style="color:#E1E4E8;">                   </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D;">-------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> idx_tbl_partial_index_level </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_partial_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">43</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">45</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">29</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">020</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">030</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">101</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Cond: ((</span><span style="color:#F97583;">level</span><span style="color:#E1E4E8;">)::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;red&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">142</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">045</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 索引大小</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;select</span><span style="color:#E1E4E8;"> relname,pg_size_pretty(pg_relation_size(</span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_class </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> relname</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;idx_tbl_partial_index_level&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">           relname           | pg_size_pretty </span></span>
<span class="line"><span style="color:#6A737D;">-----------------------------+----------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> idx_tbl_partial_index_level | </span><span style="color:#79B8FF;">193</span><span style="color:#E1E4E8;"> MB</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 示例2.在tbl_partial_index1表字段level等于red的行上创建索引</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> idx_tbl_partial_index1_level </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_partial_index1(</span><span style="color:#F97583;">level</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">level</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;red&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_partial_index1 </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">level</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;red&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                                     QUERY PLAN                                                </span></span>
<span class="line"><span style="color:#E1E4E8;">                     </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D;">---------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> idx_tbl_partial_index1_level </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_partial_index1  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">29</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">012</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#79B8FF;">31</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">101</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">736</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">047</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;select</span><span style="color:#E1E4E8;"> relname,pg_size_pretty(pg_relation_size(</span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_class </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> relname</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;idx_tbl_partial_index1_level&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">           relname            | pg_size_pretty </span></span>
<span class="line"><span style="color:#6A737D;">------------------------------+----------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> idx_tbl_partial_index1_level | </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">比较上面两个示例的结果可知，全表索引在耗时和大小方面要比部分索引消耗更多的资源，查询</span><span style="color:#9ECBFF;">&#39;red&#39;</span><span style="color:#E1E4E8;">的数据排除环境影响基本相同，数据量更大，</span><span style="color:#9ECBFF;">&#39;red&#39;</span><span style="color:#E1E4E8;">占比更小时性能可能会有明显差异，但是查询非</span><span style="color:#9ECBFF;">&#39;red&#39;</span><span style="color:#E1E4E8;">数据时全表索引会有明显的性能优势，因为部分索引并没有</span><span style="color:#9ECBFF;">&#39;green&#39;</span><span style="color:#E1E4E8;">数据的索引，走的是全表扫描。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">综上，根据数据的使用方式创建不同的索引在性能上是有明显差异的</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> tbl_partial_index(id </span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;">,alarm_time </span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">level</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">),alarm_desc </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">)); </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> tbl_partial_index1(id </span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;">,alarm_time </span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">level</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">),alarm_desc </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">)); </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 写入完全相同的数据</span></span>
<span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">insert into</span><span style="color:#24292E;"> tbl_partial_index(id,alarm_time,</span><span style="color:#D73A49;">level</span><span style="color:#24292E;">,alarm_desc) </span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">generate_series</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">9000000</span><span style="color:#24292E;">),clock_timestamp()::</span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;green&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;正常&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#D73A49;">INSERT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9000000</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">insert into</span><span style="color:#24292E;"> tbl_partial_index(id,alarm_time,</span><span style="color:#D73A49;">level</span><span style="color:#24292E;">,alarm_desc) </span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">generate_series</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">9000000</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">9000100</span><span style="color:#24292E;">),clock_timestamp()::</span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;red&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;攻击&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#D73A49;">INSERT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">101</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">#  </span></span>
<span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">#  </span></span>
<span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">insert into</span><span style="color:#24292E;"> tbl_partial_index1(id,alarm_time,</span><span style="color:#D73A49;">level</span><span style="color:#24292E;">,alarm_desc) </span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">generate_series</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">9000000</span><span style="color:#24292E;">),clock_timestamp()::</span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;green&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;正常&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#D73A49;">INSERT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9000000</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">insert into</span><span style="color:#24292E;"> tbl_partial_index1(id,alarm_time,</span><span style="color:#D73A49;">level</span><span style="color:#24292E;">,alarm_desc) </span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">generate_series</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">9000000</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">9000100</span><span style="color:#24292E;">),clock_timestamp()::</span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;red&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;攻击&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#D73A49;">INSERT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">101</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 示例1.在tbl_partial_index表字段level上创建索引</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> idx_tbl_partial_index_level </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_partial_index </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> btree (</span><span style="color:#D73A49;">level</span><span style="color:#24292E;">); </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_partial_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">level</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;red&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                                    QUERY PLAN                                                 </span></span>
<span class="line"><span style="color:#24292E;">                   </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D;">-------------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> idx_tbl_partial_index_level </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_partial_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">43</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">45</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">29</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">020</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">030</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">101</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Cond: ((</span><span style="color:#D73A49;">level</span><span style="color:#24292E;">)::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;red&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">142</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">045</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 索引大小</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;select</span><span style="color:#24292E;"> relname,pg_size_pretty(pg_relation_size(</span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_class </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> relname</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;idx_tbl_partial_index_level&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">           relname           | pg_size_pretty </span></span>
<span class="line"><span style="color:#6A737D;">-----------------------------+----------------</span></span>
<span class="line"><span style="color:#24292E;"> idx_tbl_partial_index_level | </span><span style="color:#005CC5;">193</span><span style="color:#24292E;"> MB</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 示例2.在tbl_partial_index1表字段level等于red的行上创建索引</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> idx_tbl_partial_index1_level </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_partial_index1(</span><span style="color:#D73A49;">level</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">level</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;red&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_partial_index1 </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">level</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;red&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                                     QUERY PLAN                                                </span></span>
<span class="line"><span style="color:#24292E;">                     </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D;">---------------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> idx_tbl_partial_index1_level </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_partial_index1  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">14</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">29</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">012</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#005CC5;">31</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">101</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">736</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">047</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;select</span><span style="color:#24292E;"> relname,pg_size_pretty(pg_relation_size(</span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_class </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> relname</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;idx_tbl_partial_index1_level&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">           relname            | pg_size_pretty </span></span>
<span class="line"><span style="color:#6A737D;">------------------------------+----------------</span></span>
<span class="line"><span style="color:#24292E;"> idx_tbl_partial_index1_level | </span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">比较上面两个示例的结果可知，全表索引在耗时和大小方面要比部分索引消耗更多的资源，查询</span><span style="color:#032F62;">&#39;red&#39;</span><span style="color:#24292E;">的数据排除环境影响基本相同，数据量更大，</span><span style="color:#032F62;">&#39;red&#39;</span><span style="color:#24292E;">占比更小时性能可能会有明显差异，但是查询非</span><span style="color:#032F62;">&#39;red&#39;</span><span style="color:#24292E;">数据时全表索引会有明显的性能优势，因为部分索引并没有</span><span style="color:#032F62;">&#39;green&#39;</span><span style="color:#24292E;">数据的索引，走的是全表扫描。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">综上，根据数据的使用方式创建不同的索引在性能上是有明显差异的</span></span></code></pre></div><h2 id="索引失效" tabindex="-1">索引失效 <a class="header-anchor" href="#索引失效" aria-label="Permalink to &quot;索引失效&quot;">​</a></h2><pre><code>什么是索引失效？如果where过滤条件设置不合理，即使索引存在，且where过滤条件中包含索引列，也会导致全表扫描，索引不起作用
</code></pre><p>什么条件下会导致索引失效</p><p>1.任何计算、函数、类型转换</p><p>2.!=</p><p>3.NOT，相当于使用函数</p><p>4.模糊查询通配符在开头</p><p>5.索引字段在表中占比较高</p><p>6.多字段btree索引查询条件不包含第一列</p><p>7.多字段索引查询条件使用OR（有时也会走索引扫描，但查询效率不高）</p><p>测试表</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> tbl_index(a </span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;">,b </span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;"> ,c </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">469</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;insert into</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">generate_series</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">10000000</span><span style="color:#E1E4E8;">),clock_timestamp()::</span><span style="color:#F97583;">timestamp without time zone</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;bit me&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">INSERT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10000000</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> tbl_index(a </span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;">,b </span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;"> ,c </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">14</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">469</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;insert into</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">generate_series</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">10000000</span><span style="color:#24292E;">),clock_timestamp()::</span><span style="color:#D73A49;">timestamp without time zone</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;bit me&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">INSERT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10000000</span></span></code></pre></div><h3 id="_1-任何计算、函数、类型转换" tabindex="-1">1.任何计算、函数、类型转换 <a class="header-anchor" href="#_1-任何计算、函数、类型转换" aria-label="Permalink to &quot;1.任何计算、函数、类型转换&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> idx_tbl_index_a </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index (a); </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                         QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#6A737D;">----------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> idx_tbl_index_a </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">43</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">45</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">105</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">107</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Cond: (a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">098</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">140</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">037</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                           QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#F97583;">-</span></span>
<span class="line"><span style="color:#E1E4E8;"> Gather  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">132195</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">50000</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">318</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">528</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">319</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">334</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   Workers Planned: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">   Workers Launched: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  Parallel Seq Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">126195</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">20833</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">299</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">300</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">299</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">301</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: ((a </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">Rows</span><span style="color:#E1E4E8;"> Removed </span><span style="color:#F97583;">by</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3333333</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">105</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">319</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">365</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">power</span><span style="color:#E1E4E8;">(a,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                           QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#F97583;">-</span></span>
<span class="line"><span style="color:#E1E4E8;"> Gather  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">142611</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">67</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">50000</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">433</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">360</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">417</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   Workers Planned: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">   Workers Launched: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  Parallel Seq Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">136611</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">67</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">20833</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">226</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">017</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">343</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">752</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: (</span><span style="color:#79B8FF;">power</span><span style="color:#E1E4E8;">((a)::</span><span style="color:#F97583;">double precision</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;2&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">double precision</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;1&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">double precision</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">Rows</span><span style="color:#E1E4E8;"> Removed </span><span style="color:#F97583;">by</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3333333</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">179</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">360</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">445</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">366</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">390</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a::</span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;1&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                           QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">--------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> Gather  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">142611</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">67</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">50000</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">655</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">584</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">484</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   Workers Planned: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">   Workers Launched: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  Parallel Seq Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">136611</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">67</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">20833</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">371</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">652</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">564</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">242</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: (((a)::</span><span style="color:#F97583;">character</span><span style="color:#E1E4E8;"> varying)::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;1&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">Rows</span><span style="color:#E1E4E8;"> Removed </span><span style="color:#F97583;">by</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3333333</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">378</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">584</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">528</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">586</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">817</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">在表tbl_index</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">a字段创建btree索引</span><span style="color:#E1E4E8;">，使用a</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">1索引生效，但是下面的例子运算、函数、类型转换却导致索引失效了。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">power</span><span style="color:#E1E4E8;">(a,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a::</span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;1&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">如何解决呢？可参考前面的表达式索引解决：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">idx_tbl_index_a</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index ((a</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">idx_tbl_index_a</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index ((</span><span style="color:#79B8FF;">power</span><span style="color:#E1E4E8;">(a,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">idx_tbl_index_a</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index ((a::</span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">));</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> idx_tbl_index_a </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index (a); </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                                                         QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#6A737D;">----------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> idx_tbl_index_a </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">43</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">45</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">105</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">107</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Cond: (a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">098</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">140</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">037</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                           QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#D73A49;">-</span></span>
<span class="line"><span style="color:#24292E;"> Gather  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">132195</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">50000</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">318</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">528</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">319</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">334</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   Workers Planned: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">   Workers Launched: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  Parallel Seq Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">126195</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">20833</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">299</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">300</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">299</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">301</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: ((a </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">Rows</span><span style="color:#24292E;"> Removed </span><span style="color:#D73A49;">by</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3333333</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">105</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">319</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">365</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">power</span><span style="color:#24292E;">(a,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                           QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#D73A49;">-</span></span>
<span class="line"><span style="color:#24292E;"> Gather  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">142611</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">67</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">50000</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">433</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">360</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">417</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   Workers Planned: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">   Workers Launched: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  Parallel Seq Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">136611</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">67</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">20833</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">226</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">017</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">343</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">752</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: (</span><span style="color:#005CC5;">power</span><span style="color:#24292E;">((a)::</span><span style="color:#D73A49;">double precision</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;2&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">double precision</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;1&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">double precision</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">Rows</span><span style="color:#24292E;"> Removed </span><span style="color:#D73A49;">by</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3333333</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">179</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">360</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">445</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">366</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">390</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a::</span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;1&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                           QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">--------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> Gather  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">142611</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">67</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">50000</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">655</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">584</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">484</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   Workers Planned: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">   Workers Launched: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  Parallel Seq Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">136611</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">67</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">20833</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">371</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">652</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">564</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">242</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: (((a)::</span><span style="color:#D73A49;">character</span><span style="color:#24292E;"> varying)::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;1&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">Rows</span><span style="color:#24292E;"> Removed </span><span style="color:#D73A49;">by</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3333333</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">378</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">584</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">528</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">586</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">817</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">在表tbl_index</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">a字段创建btree索引</span><span style="color:#24292E;">，使用a</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">1索引生效，但是下面的例子运算、函数、类型转换却导致索引失效了。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">power</span><span style="color:#24292E;">(a,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a::</span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;1&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">如何解决呢？可参考前面的表达式索引解决：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">idx_tbl_index_a</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index ((a</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">idx_tbl_index_a</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index ((</span><span style="color:#005CC5;">power</span><span style="color:#24292E;">(a,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">idx_tbl_index_a</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index ((a::</span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">));</span></span></code></pre></div><h3 id="_2" tabindex="-1">2.!= <a class="header-anchor" href="#_2" aria-label="Permalink to &quot;2.!=&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                      QUERY PLAN                                                       </span></span>
<span class="line"><span style="color:#6A737D;">--------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> Seq Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">188695</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">9999999</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">025</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">769</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">603</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">9999999</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: (a </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Rows</span><span style="color:#E1E4E8;"> Removed </span><span style="color:#F97583;">by</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">120</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1050</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">284</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1051</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">117</span><span style="color:#E1E4E8;"> ms (</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">01</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">051</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                      QUERY PLAN                                                       </span></span>
<span class="line"><span style="color:#6A737D;">--------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> Seq Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">188695</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">9999999</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">025</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">769</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">603</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">9999999</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: (a </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Rows</span><span style="color:#24292E;"> Removed </span><span style="color:#D73A49;">by</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">120</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1050</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">284</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1051</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">117</span><span style="color:#24292E;"> ms (</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">01</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">051</span><span style="color:#24292E;">)</span></span></code></pre></div><h3 id="_3-not-相当于使用函数" tabindex="-1">3.NOT，相当于使用函数 <a class="header-anchor" href="#_3-not-相当于使用函数" aria-label="Permalink to &quot;3.NOT，相当于使用函数&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                         QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#6A737D;">--------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Scan </span><span style="color:#F97583;">using</span><span style="color:#E1E4E8;"> idx_tbl_index_a </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">43</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">45</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">223</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">223</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Index</span><span style="color:#E1E4E8;"> Cond: (a </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">205</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">258</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">205</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> explain analyze </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> tbl_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">is not null</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                       QUERY PLAN                                                        </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> Seq Scan </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> tbl_index  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">163695</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">10000000</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual </span><span style="color:#F97583;">time=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">029</span><span style="color:#E1E4E8;">..</span><span style="color:#79B8FF;">765</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">278</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows=</span><span style="color:#79B8FF;">10000000</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">Filter</span><span style="color:#E1E4E8;">: (a </span><span style="color:#F97583;">IS NOT NULL</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">118</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution </span><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1051</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">602</span><span style="color:#E1E4E8;"> ms</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">Time</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1052</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">313</span><span style="color:#E1E4E8;"> ms (</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">01</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">052</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">以上比较可知where a </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> null索引生效，但是where a </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> null导致索引生效。类似导致索引失效的还有NOT </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;">，</span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> LIKE等，但是NOT EXISTS不会导致索引失效。下面的例子可以看到tbl_index表仍进行索引扫描，但是性能仍有限制，使用NOT IN虽然索引失效，但性能比NOT EXISTS要高。这个和我之前的认识有些出入，之前测试发现NOT EXISTS比NOT IN性能高，看来情况不同，性能也是不一定</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                         QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#6A737D;">--------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Scan </span><span style="color:#D73A49;">using</span><span style="color:#24292E;"> idx_tbl_index_a </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">43</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">45</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">223</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">223</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Index</span><span style="color:#24292E;"> Cond: (a </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">205</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">258</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">205</span><span style="color:#24292E;"> ms</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> explain analyze </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> tbl_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">is not null</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                       QUERY PLAN                                                        </span></span>
<span class="line"><span style="color:#6A737D;">-------------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> Seq Scan </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> tbl_index  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">163695</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">10000000</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual </span><span style="color:#D73A49;">time=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">029</span><span style="color:#24292E;">..</span><span style="color:#005CC5;">765</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">278</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows=</span><span style="color:#005CC5;">10000000</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">Filter</span><span style="color:#24292E;">: (a </span><span style="color:#D73A49;">IS NOT NULL</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> Planning </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">118</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;"> Execution </span><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1051</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">602</span><span style="color:#24292E;"> ms</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">Time</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1052</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">313</span><span style="color:#24292E;"> ms (</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">01</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">052</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">以上比较可知where a </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> null索引生效，但是where a </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> null导致索引生效。类似导致索引失效的还有NOT </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;">，</span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> LIKE等，但是NOT EXISTS不会导致索引失效。下面的例子可以看到tbl_index表仍进行索引扫描，但是性能仍有限制，使用NOT IN虽然索引失效，但性能比NOT EXISTS要高。这个和我之前的认识有些出入，之前测试发现NOT EXISTS比NOT IN性能高，看来情况不同，性能也是不一定</span></span></code></pre></div><h3 id="_4-模糊查询通配符在开头" tabindex="-1">4.模糊查询通配符在开头 <a class="header-anchor" href="#_4-模糊查询通配符在开头" aria-label="Permalink to &quot;4.模糊查询通配符在开头&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># explain analyze select </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> from tbl_index where c like </span><span style="color:#9ECBFF;">&#39;bit%&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                        QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#F97583;">--------------------------------------------------------------------------------------------------------------------------</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> Seq Scan on </span><span style="color:#B392F0;">tbl_index</span><span style="color:#E1E4E8;">  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.00</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">140899</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">00</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10000000</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.099</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">1685</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">317</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10000000</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">   Filter</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> ((c)</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">text </span><span style="color:#F97583;">~~</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;bit%&#39;</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">text) </span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">55.373</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2104.863</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> rows) </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">Time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2164.464</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># explain analyze select </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> from tbl_index where c like </span><span style="color:#9ECBFF;">&#39;%me&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                        QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#F97583;">---------------------------------------------------------------------------------------------------------------------------</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> Seq Scan on </span><span style="color:#B392F0;">tbl_index</span><span style="color:#E1E4E8;">  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.00</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">140899</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">00</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10000000</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">20.172</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">5507</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">741</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10000000</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">   Filter</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> ((c)</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">text </span><span style="color:#F97583;">~~</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;%me&#39;</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">text) </span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">65.603</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6007.367</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> rows)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># explain analyze select </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> from tbl_index where c like </span><span style="color:#032F62;">&#39;bit%&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                        QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#D73A49;">--------------------------------------------------------------------------------------------------------------------------</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> Seq Scan on </span><span style="color:#6F42C1;">tbl_index</span><span style="color:#24292E;">  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.00</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">140899</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">00</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10000000</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.099</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">1685</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">317</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10000000</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">   Filter</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> ((c)</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">text </span><span style="color:#D73A49;">~~</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;bit%&#39;</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">text) </span></span>
<span class="line"><span style="color:#24292E;"> Planning time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">55.373</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;"> Execution time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2104.863</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> rows) </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">Time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2164.464</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># explain analyze select </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> from tbl_index where c like </span><span style="color:#032F62;">&#39;%me&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                        QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#D73A49;">---------------------------------------------------------------------------------------------------------------------------</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> Seq Scan on </span><span style="color:#6F42C1;">tbl_index</span><span style="color:#24292E;">  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.00</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">140899</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">00</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10000000</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">20.172</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">5507</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">741</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10000000</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">   Filter</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> ((c)</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">text </span><span style="color:#D73A49;">~~</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;%me&#39;</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">text) </span></span>
<span class="line"><span style="color:#24292E;"> Planning time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">65.603</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;"> Execution time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6007.367</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> rows)</span></span></code></pre></div><h3 id="_5-索引字段在表中占比较高" tabindex="-1">5.索引字段在表中占比较高 <a class="header-anchor" href="#_5-索引字段在表中占比较高" aria-label="Permalink to &quot;5.索引字段在表中占比较高&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># insert into tbl_index </span><span style="color:#B392F0;">values</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">10000001</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;2015-05-23 00:00:00&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;haha&#39;</span><span style="color:#E1E4E8;">); </span></span>
<span class="line"><span style="color:#E1E4E8;">INSERT </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">Time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">88.226</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># explain analyze select </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> from tbl_index where c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;bit me&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                        QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#F97583;">--------------------------------------------------------------------------------------------------------------------------</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> Seq Scan on </span><span style="color:#B392F0;">tbl_index</span><span style="color:#E1E4E8;">  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.00</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">140899</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">00</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10000000</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.051</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">6758</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">236</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10000000</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">   Filter</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> ((c)</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">text </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;bit me&#39;</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">text) </span></span>
<span class="line"><span style="color:#E1E4E8;">   Rows Removed by Filter</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.128</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7237.900</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> rows) </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">Time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7238.685</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># explain analyze select </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> from tbl_index where c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;haha&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                         QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#F97583;">----------------------------------------------------------------------------------------------------------------------------</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> Index Scan using idx_tbl_index_c on </span><span style="color:#B392F0;">tbl_index</span><span style="color:#E1E4E8;">  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.43</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">4</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">45</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.063</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">065</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">   Index Cond</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> ((c)</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">text </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;haha&#39;</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">text) </span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.219</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2.869</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> rows) </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">Time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4.942</span><span style="color:#E1E4E8;"> ms</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># insert into tbl_index </span><span style="color:#6F42C1;">values</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">10000001</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;2015-05-23 00:00:00&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;haha&#39;</span><span style="color:#24292E;">); </span></span>
<span class="line"><span style="color:#24292E;">INSERT </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">Time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">88.226</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># explain analyze select </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> from tbl_index where c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;bit me&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                        QUERY PLAN                                                         </span></span>
<span class="line"><span style="color:#D73A49;">--------------------------------------------------------------------------------------------------------------------------</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> Seq Scan on </span><span style="color:#6F42C1;">tbl_index</span><span style="color:#24292E;">  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.00</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">140899</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">00</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10000000</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.051</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">6758</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">236</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10000000</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">   Filter</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> ((c)</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">text </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;bit me&#39;</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">text) </span></span>
<span class="line"><span style="color:#24292E;">   Rows Removed by Filter</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> Planning time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.128</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;"> Execution time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7237.900</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> rows) </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">Time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7238.685</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># explain analyze select </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> from tbl_index where c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;haha&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                         QUERY PLAN                                                          </span></span>
<span class="line"><span style="color:#D73A49;">----------------------------------------------------------------------------------------------------------------------------</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> Index Scan using idx_tbl_index_c on </span><span style="color:#6F42C1;">tbl_index</span><span style="color:#24292E;">  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.43</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">4</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">45</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.063</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">065</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">   Index Cond</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> ((c)</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">text </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;haha&#39;</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">text) </span></span>
<span class="line"><span style="color:#24292E;"> Planning time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.219</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;"> Execution time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2.869</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> rows) </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">Time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4.942</span><span style="color:#24292E;"> ms</span></span></code></pre></div><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># drop index idx_tbl_index_a; </span></span>
<span class="line"><span style="color:#E1E4E8;">DROP INDEX </span></span>
<span class="line"><span style="color:#E1E4E8;">Time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">134.873</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># drop index idx_tbl_index_c; </span></span>
<span class="line"><span style="color:#E1E4E8;">DROP INDEX </span></span>
<span class="line"><span style="color:#E1E4E8;">Time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">173.572</span><span style="color:#E1E4E8;"> ms</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># drop index idx_tbl_index_a; </span></span>
<span class="line"><span style="color:#24292E;">DROP INDEX </span></span>
<span class="line"><span style="color:#24292E;">Time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">134.873</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># drop index idx_tbl_index_c; </span></span>
<span class="line"><span style="color:#24292E;">DROP INDEX </span></span>
<span class="line"><span style="color:#24292E;">Time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">173.572</span><span style="color:#24292E;"> ms</span></span></code></pre></div><h3 id="_6-多字段btree索引查询条件不包含第一列" tabindex="-1">6.多字段btree索引查询条件不包含第一列 <a class="header-anchor" href="#_6-多字段btree索引查询条件不包含第一列" aria-label="Permalink to &quot;6.多字段btree索引查询条件不包含第一列&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># explain analyze select </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> from tbl_index where a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10000001</span><span style="color:#E1E4E8;"> and c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;haha&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                           QUERY PLAN                                                            </span></span>
<span class="line"><span style="color:#F97583;">--------------------------------------------------------------------------------------------------------------------------------</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> Index Scan using idx_tbl_index_a_c on </span><span style="color:#B392F0;">tbl_index</span><span style="color:#E1E4E8;">  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.43</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">6</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">20</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23.254</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">23</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">257</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">   Index Cond</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> ((a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10000001</span><span style="color:#E1E4E8;">) </span><span style="color:#B392F0;">AND</span><span style="color:#E1E4E8;"> ((c)</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">text </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;haha&#39;</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">text)) </span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">36.050</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">35.710</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> rows) </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">Time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">78.816</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># explain analyze select </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> from tbl_index where  c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;haha&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                         QUERY PLAN                                                           </span></span>
<span class="line"><span style="color:#F97583;">-----------------------------------------------------------------------------------------------------------------------------</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Gather</span><span style="color:#E1E4E8;">  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1000.00</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">68982</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">44</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">7869.579</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">7890</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">974</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">   Workers Planned</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">   Workers Launched</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  Parallel Seq Scan on </span><span style="color:#B392F0;">tbl_index</span><span style="color:#E1E4E8;">  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.00</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">67982</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">34</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">7468.480</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">7468</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">480</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">         Filter</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> ((c)</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">text </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;haha&#39;</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">text) </span></span>
<span class="line"><span style="color:#E1E4E8;">         Rows Removed by Filter</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3333333</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.130</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7891.137</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> rows) </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">Time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7891.937</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># explain analyze select </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> from tbl_index where a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10000001</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                          QUERY PLAN                                                           </span></span>
<span class="line"><span style="color:#F97583;">------------------------------------------------------------------------------------------------------------------------------</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> Index Scan using idx_tbl_index_a_c on </span><span style="color:#B392F0;">tbl_index</span><span style="color:#E1E4E8;">  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.43</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">8</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">45</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.154</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">156</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">   Index Cond</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> (a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10000001</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.257</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.206</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> rows) </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">Time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1.119</span><span style="color:#E1E4E8;"> ms</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># explain analyze select </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> from tbl_index where a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10000001</span><span style="color:#24292E;"> and c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;haha&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                           QUERY PLAN                                                            </span></span>
<span class="line"><span style="color:#D73A49;">--------------------------------------------------------------------------------------------------------------------------------</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> Index Scan using idx_tbl_index_a_c on </span><span style="color:#6F42C1;">tbl_index</span><span style="color:#24292E;">  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.43</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">6</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">20</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23.254</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">23</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">257</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">   Index Cond</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> ((a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10000001</span><span style="color:#24292E;">) </span><span style="color:#6F42C1;">AND</span><span style="color:#24292E;"> ((c)</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">text </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;haha&#39;</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">text)) </span></span>
<span class="line"><span style="color:#24292E;"> Planning time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">36.050</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;"> Execution time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">35.710</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> rows) </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">Time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">78.816</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># explain analyze select </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> from tbl_index where  c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;haha&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                         QUERY PLAN                                                           </span></span>
<span class="line"><span style="color:#D73A49;">-----------------------------------------------------------------------------------------------------------------------------</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Gather</span><span style="color:#24292E;">  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1000.00</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">68982</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">44</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">7869.579</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">7890</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">974</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">   Workers Planned</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">   Workers Launched</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  Parallel Seq Scan on </span><span style="color:#6F42C1;">tbl_index</span><span style="color:#24292E;">  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.00</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">67982</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">34</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">7468.480</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">7468</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">480</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">         Filter</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> ((c)</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">text </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;haha&#39;</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">text) </span></span>
<span class="line"><span style="color:#24292E;">         Rows Removed by Filter</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3333333</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> Planning time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.130</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;"> Execution time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7891.137</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> rows) </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">Time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7891.937</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># explain analyze select </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> from tbl_index where a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10000001</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                          QUERY PLAN                                                           </span></span>
<span class="line"><span style="color:#D73A49;">------------------------------------------------------------------------------------------------------------------------------</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> Index Scan using idx_tbl_index_a_c on </span><span style="color:#6F42C1;">tbl_index</span><span style="color:#24292E;">  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.43</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">8</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">45</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.154</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">156</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">   Index Cond</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> (a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10000001</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;"> Planning time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.257</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;"> Execution time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.206</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> rows) </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">Time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1.119</span><span style="color:#24292E;"> ms</span></span></code></pre></div><h3 id="_7-多字段索引查询条件使用or" tabindex="-1">7.多字段索引查询条件使用OR <a class="header-anchor" href="#_7-多字段索引查询条件使用or" aria-label="Permalink to &quot;7.多字段索引查询条件使用OR&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># explain analyze select </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> from tbl_index where a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10000001</span><span style="color:#E1E4E8;"> or c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;haha&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                         QUERY PLAN                                                           </span></span>
<span class="line"><span style="color:#F97583;">-----------------------------------------------------------------------------------------------------------------------------</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Gather</span><span style="color:#E1E4E8;">  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1000.00</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">79399</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">11</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">7321.821</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">7323</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">593</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">   Workers Planned</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">   Workers Launched</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;">  Parallel Seq Scan on </span><span style="color:#B392F0;">tbl_index</span><span style="color:#E1E4E8;">  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.00</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">78399</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">01</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">7307.413</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">7307</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">413</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">         Filter</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> ((a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10000001</span><span style="color:#E1E4E8;">) </span><span style="color:#B392F0;">OR</span><span style="color:#E1E4E8;"> ((c)</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">text </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;haha&#39;</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">text)) </span></span>
<span class="line"><span style="color:#E1E4E8;">         Rows Removed by Filter</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3333333</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.163</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7324.821</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> rows) </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">Time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7325.532</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># explain analyze select </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> from tbl_index where a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10000001</span><span style="color:#E1E4E8;"> and c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;haha&#39;</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                          QUERY PLAN                                                           </span></span>
<span class="line"><span style="color:#F97583;">------------------------------------------------------------------------------------------------------------------------------</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> Index Scan using idx_tbl_index_a_c on </span><span style="color:#B392F0;">tbl_index</span><span style="color:#E1E4E8;">  (cost</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.43</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">6</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">20</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> width</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;">) (actual time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0.040</span><span style="color:#E1E4E8;">..</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">041</span><span style="color:#E1E4E8;"> rows</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> loops</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;">   Index Cond</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> ((a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10000001</span><span style="color:#E1E4E8;">) </span><span style="color:#B392F0;">AND</span><span style="color:#E1E4E8;"> ((c)</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">text </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;haha&#39;</span><span style="color:#F97583;">::</span><span style="color:#E1E4E8;">text)) </span></span>
<span class="line"><span style="color:#E1E4E8;"> Planning time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.165</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;"> Execution time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.093</span><span style="color:#E1E4E8;"> ms </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> rows) </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">Time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">32.904</span><span style="color:#E1E4E8;"> ms</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># explain analyze select </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> from tbl_index where a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10000001</span><span style="color:#24292E;"> or c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;haha&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                         QUERY PLAN                                                           </span></span>
<span class="line"><span style="color:#D73A49;">-----------------------------------------------------------------------------------------------------------------------------</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Gather</span><span style="color:#24292E;">  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1000.00</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">79399</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">11</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">7321.821</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">7323</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">593</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">   Workers Planned</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">   Workers Launched</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;">  Parallel Seq Scan on </span><span style="color:#6F42C1;">tbl_index</span><span style="color:#24292E;">  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.00</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">78399</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">01</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">7307.413</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">7307</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">413</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">         Filter</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> ((a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10000001</span><span style="color:#24292E;">) </span><span style="color:#6F42C1;">OR</span><span style="color:#24292E;"> ((c)</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">text </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;haha&#39;</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">text)) </span></span>
<span class="line"><span style="color:#24292E;">         Rows Removed by Filter</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3333333</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> Planning time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.163</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;"> Execution time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7324.821</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> rows) </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">Time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7325.532</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># explain analyze select </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> from tbl_index where a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10000001</span><span style="color:#24292E;"> and c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;haha&#39;</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">                                                          QUERY PLAN                                                           </span></span>
<span class="line"><span style="color:#D73A49;">------------------------------------------------------------------------------------------------------------------------------</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> Index Scan using idx_tbl_index_a_c on </span><span style="color:#6F42C1;">tbl_index</span><span style="color:#24292E;">  (cost</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.43</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">6</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">20</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> width</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">23</span><span style="color:#24292E;">) (actual time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0.040</span><span style="color:#24292E;">..</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">041</span><span style="color:#24292E;"> rows</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> loops</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;">   Index Cond</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> ((a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10000001</span><span style="color:#24292E;">) </span><span style="color:#6F42C1;">AND</span><span style="color:#24292E;"> ((c)</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">text </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;haha&#39;</span><span style="color:#D73A49;">::</span><span style="color:#24292E;">text)) </span></span>
<span class="line"><span style="color:#24292E;"> Planning time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.165</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;"> Execution time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.093</span><span style="color:#24292E;"> ms </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> rows) </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">Time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">32.904</span><span style="color:#24292E;"> ms</span></span></code></pre></div><h1 id="_2-index-的命中率" tabindex="-1">2,INDEX 的命中率 <a class="header-anchor" href="#_2-index-的命中率" aria-label="Permalink to &quot;2,INDEX 的命中率&quot;">​</a></h1><h2 id="_1-内存是否存在短缺的可能" tabindex="-1">1, 内存是否存在短缺的可能 <a class="header-anchor" href="#_1-内存是否存在短缺的可能" aria-label="Permalink to &quot;1, 内存是否存在短缺的可能&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">	</span></span>
<span class="line"><span style="color:#9ECBFF;">&#39;index hit rate&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sum</span><span style="color:#E1E4E8;">(idx_blks_hit)) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nullif</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sum</span><span style="color:#E1E4E8;">(idx_blks_hit </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> idx_blks_read),</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> ratio</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> pg_statio_user_indexes</span></span>
<span class="line"><span style="color:#F97583;">UNION ALL</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#9ECBFF;">&#39;table hit rate&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">sum</span><span style="color:#E1E4E8;">(heap_blks_hit) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nullif</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sum</span><span style="color:#E1E4E8;">(heap_blks_hit) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sum</span><span style="color:#E1E4E8;">(heap_blks_read),</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> ratio</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> pg_statio_user_tables;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">      |         ratio          </span></span>
<span class="line"><span style="color:#6A737D;">----------------+------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> hit rate | </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">88235294117647058824</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> hit rate | </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">87755102040816326531</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">	</span></span>
<span class="line"><span style="color:#032F62;">&#39;index hit rate&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">sum</span><span style="color:#24292E;">(idx_blks_hit)) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nullif</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sum</span><span style="color:#24292E;">(idx_blks_hit </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> idx_blks_read),</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> ratio</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> pg_statio_user_indexes</span></span>
<span class="line"><span style="color:#D73A49;">UNION ALL</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#032F62;">&#39;table hit rate&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#005CC5;">sum</span><span style="color:#24292E;">(heap_blks_hit) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nullif</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sum</span><span style="color:#24292E;">(heap_blks_hit) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sum</span><span style="color:#24292E;">(heap_blks_read),</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> ratio</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> pg_statio_user_tables;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">      |         ratio          </span></span>
<span class="line"><span style="color:#6A737D;">----------------+------------------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> hit rate | </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">88235294117647058824</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> hit rate | </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">87755102040816326531</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span></code></pre></div><h2 id="_2-查询的方式是否合理" tabindex="-1">2,查询的方式是否合理 <a class="header-anchor" href="#_2-查询的方式是否合理" aria-label="Permalink to &quot;2,查询的方式是否合理&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 表中的INDEX 的命中率</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> relname,	</span></span>
<span class="line"><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> idx_scan</span></span>
<span class="line"><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NULL</span></span>
<span class="line"><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">round</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> idx_scan </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> (seq_scan </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> idx_scan), </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> percent_of_times_index_used,</span></span>
<span class="line"><span style="color:#E1E4E8;">n_live_tup rows_in_table</span></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">pg_stat_user_tables</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span></span>
<span class="line"><span style="color:#E1E4E8;">n_live_tup </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> relname | percent_of_times_index_used | rows_in_table </span></span>
<span class="line"><span style="color:#6A737D;">---------+-----------------------------+---------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> emp1    |                             |             </span><span style="color:#79B8FF;">7</span></span>
<span class="line"><span style="color:#E1E4E8;"> job     |                    </span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">81481</span><span style="color:#E1E4E8;"> |             </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;"> t       |                             |             </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 表中的INDEX 的命中率</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> relname,	</span></span>
<span class="line"><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> idx_scan</span></span>
<span class="line"><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NULL</span></span>
<span class="line"><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">round</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> idx_scan </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> (seq_scan </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> idx_scan), </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">END</span><span style="color:#24292E;"> percent_of_times_index_used,</span></span>
<span class="line"><span style="color:#24292E;">n_live_tup rows_in_table</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">pg_stat_user_tables</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span></span>
<span class="line"><span style="color:#24292E;">n_live_tup </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> relname | percent_of_times_index_used | rows_in_table </span></span>
<span class="line"><span style="color:#6A737D;">---------+-----------------------------+---------------</span></span>
<span class="line"><span style="color:#24292E;"> emp1    |                             |             </span><span style="color:#005CC5;">7</span></span>
<span class="line"><span style="color:#24292E;"> job     |                    </span><span style="color:#005CC5;">14</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">81481</span><span style="color:#24292E;"> |             </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;"> t       |                             |             </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span></code></pre></div><p>在查询中基本上都愿意使用INDEX 来进行相关的查询，那表中的查询使用INDEX 索引和不使用之间的时间比是多少，通过这样的脚本可以进一步分析哪些表可能存在缺少搜索的情况</p><p>3 检查数据库中那些索引没有被使用过，这是一个经常需要问的问题，当然通过脚本获取的数据后，到底这个索引需要不需要，也是要在分析的，不能由于这个索引被使用的次数过小，就直接将他删除</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">	</span></span>
<span class="line"><span style="color:#E1E4E8;">schemaname </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> relname </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">indexrelname </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">pg_size_pretty(pg_relation_size(</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexrelid</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> index_size,</span></span>
<span class="line"><span style="color:#E1E4E8;">idx_scan </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> index_scans</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> pg_stat_user_indexes ui</span></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> pg_index i </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ui</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexrelid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexrelid</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> indisunique</span></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> idx_scan </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">50</span></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> pg_relation_size(relid) </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8192</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> pg_relation_size(</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexrelid</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nullif</span><span style="color:#E1E4E8;">(idx_scan, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NULLS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FIRST</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">pg_relation_size(</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexrelid</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">	</span></span>
<span class="line"><span style="color:#24292E;">schemaname </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> relname </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">indexrelname </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">pg_size_pretty(pg_relation_size(</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexrelid</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> index_size,</span></span>
<span class="line"><span style="color:#24292E;">idx_scan </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> index_scans</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> pg_stat_user_indexes ui</span></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> pg_index i </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ui</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexrelid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexrelid</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> indisunique</span></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> idx_scan </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">50</span></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> pg_relation_size(relid) </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8192</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> pg_relation_size(</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexrelid</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nullif</span><span style="color:#24292E;">(idx_scan, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NULLS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FIRST</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">pg_relation_size(</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexrelid</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">;</span></span></code></pre></div><h2 id="_4-查看表大小" tabindex="-1">4,查看表大小 <a class="header-anchor" href="#_4-查看表大小" aria-label="Permalink to &quot;4,查看表大小&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">,	</span></span>
<span class="line"><span style="color:#E1E4E8;">pg_size_pretty(pg_total_relation_size(</span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">size</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> pg_class c</span></span>
<span class="line"><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> pg_namespace n </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">n</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relnamespace</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">n</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nspname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;pg_catalog&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;information_schema&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">n</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nspname</span><span style="color:#E1E4E8;"> !~ </span><span style="color:#9ECBFF;">&#39;^pg_toast&#39;</span></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relkind</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;r&#39;</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> pg_total_relation_size(</span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> |    </span><span style="color:#F97583;">size</span><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">------+------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> job  | </span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> t    | </span><span style="color:#79B8FF;">8192</span><span style="color:#E1E4E8;"> bytes</span></span>
<span class="line"><span style="color:#E1E4E8;"> emp1 | </span><span style="color:#79B8FF;">8192</span><span style="color:#E1E4E8;"> bytes</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--或者</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">\\d</span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">                      List of relations</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Schema</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">Name</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">Type</span><span style="color:#E1E4E8;">  |  </span><span style="color:#F97583;">Owner</span><span style="color:#E1E4E8;">   |    </span><span style="color:#F97583;">Size</span><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">Description</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">--------+------+-------+----------+------------+-------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> public | emp1 | </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> | postgres | </span><span style="color:#79B8FF;">8192</span><span style="color:#E1E4E8;"> bytes | </span></span>
<span class="line"><span style="color:#E1E4E8;"> public | t    | </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> | postgres | </span><span style="color:#79B8FF;">8192</span><span style="color:#E1E4E8;"> bytes | </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">,	</span></span>
<span class="line"><span style="color:#24292E;">pg_size_pretty(pg_total_relation_size(</span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">size</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> pg_class c</span></span>
<span class="line"><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> pg_namespace n </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">n</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relnamespace</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">n</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nspname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;pg_catalog&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;information_schema&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">n</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nspname</span><span style="color:#24292E;"> !~ </span><span style="color:#032F62;">&#39;^pg_toast&#39;</span></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relkind</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;r&#39;</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> pg_total_relation_size(</span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> |    </span><span style="color:#D73A49;">size</span><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#6A737D;">------+------------</span></span>
<span class="line"><span style="color:#24292E;"> job  | </span><span style="color:#005CC5;">32</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> t    | </span><span style="color:#005CC5;">8192</span><span style="color:#24292E;"> bytes</span></span>
<span class="line"><span style="color:#24292E;"> emp1 | </span><span style="color:#005CC5;">8192</span><span style="color:#24292E;"> bytes</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--或者</span></span>
<span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">\\d</span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">                      List of relations</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">Schema</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">Name</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">Type</span><span style="color:#24292E;">  |  </span><span style="color:#D73A49;">Owner</span><span style="color:#24292E;">   |    </span><span style="color:#D73A49;">Size</span><span style="color:#24292E;">    | </span><span style="color:#D73A49;">Description</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">--------+------+-------+----------+------------+-------------</span></span>
<span class="line"><span style="color:#24292E;"> public | emp1 | </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> | postgres | </span><span style="color:#005CC5;">8192</span><span style="color:#24292E;"> bytes | </span></span>
<span class="line"><span style="color:#24292E;"> public | t    | </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> | postgres | </span><span style="color:#005CC5;">8192</span><span style="color:#24292E;"> bytes | </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span></code></pre></div><p>5， 查询当前系统中语句的状态，包含锁的状态，这个语句可能是会经常被使用的，如果当前系统例如出现性能，或应用系统的问题，首先就要查看当前语句运行的情况</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">count</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">pg_stat_activity</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> number_of_queries,       </span><span style="color:#79B8FF;">substring</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">trim</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">LEADING</span><span style="color:#E1E4E8;">                      </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> regexp_replace(</span><span style="color:#79B8FF;">pg_stat_activity</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;[\\n\\r]+&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">,                       </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;g&#39;</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">))                 </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">                 </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> query_name,       </span><span style="color:#79B8FF;">max</span><span style="color:#E1E4E8;">(age(CURRENT_TIMESTAMP, query_start)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> max_wait_time,       wait_event,       usename,       locktype,       mode,       granted  </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> pg_stat_activity  </span><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> pg_locks </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_stat_activity</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> query </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;IDLE&gt;&#39;</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> query </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> ILIKE </span><span style="color:#9ECBFF;">&#39;%pg_%&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> query </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> ILIKE </span><span style="color:#9ECBFF;">&#39;%application_name%&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> query </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> ILIKE </span><span style="color:#9ECBFF;">&#39;%inet%&#39;</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> age(CURRENT_TIMESTAMP, query_start) </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;5 milliseconds&#39;</span><span style="color:#E1E4E8;">::interval  </span><span style="color:#F97583;">GROUP BY</span><span style="color:#E1E4E8;"> query_name,           wait_event,           usename,           locktype,           mode,           granted  </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> max_wait_time </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> number_of_queries | query_name | max_wait_time | wait_event | usename | locktype | mode | granted </span></span>
<span class="line"><span style="color:#6A737D;">-------------------+------------+---------------+------------+---------+----------+------+---------</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">count</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">pg_stat_activity</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> number_of_queries,       </span><span style="color:#005CC5;">substring</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">trim</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">LEADING</span><span style="color:#24292E;">                      </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> regexp_replace(</span><span style="color:#005CC5;">pg_stat_activity</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;[\\n\\r]+&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">,                       </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;g&#39;</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">))                 </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">                 </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> query_name,       </span><span style="color:#005CC5;">max</span><span style="color:#24292E;">(age(CURRENT_TIMESTAMP, query_start)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> max_wait_time,       wait_event,       usename,       locktype,       mode,       granted  </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> pg_stat_activity  </span><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> pg_locks </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_stat_activity</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> query </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;IDLE&gt;&#39;</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> query </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> ILIKE </span><span style="color:#032F62;">&#39;%pg_%&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> query </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> ILIKE </span><span style="color:#032F62;">&#39;%application_name%&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> query </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> ILIKE </span><span style="color:#032F62;">&#39;%inet%&#39;</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> age(CURRENT_TIMESTAMP, query_start) </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;5 milliseconds&#39;</span><span style="color:#24292E;">::interval  </span><span style="color:#D73A49;">GROUP BY</span><span style="color:#24292E;"> query_name,           wait_event,           usename,           locktype,           mode,           granted  </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> max_wait_time </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> number_of_queries | query_name | max_wait_time | wait_event | usename | locktype | mode | granted </span></span>
<span class="line"><span style="color:#6A737D;">-------------------+------------+---------------+------------+---------+----------+------+---------</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;</span></span></code></pre></div><p>6 ，在查询中表读取在内存中的命中的数据块是一个需要被关注的参数，下面的脚本中可以看到每个表被读取时，在磁盘中读取和在内存中直接读取之间的数字和比率</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;SELECT</span><span style="color:#E1E4E8;"> relname </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;relation&quot;</span><span style="color:#E1E4E8;">,heap_blks_read </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> heap_read,heap_blks_hit </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> heap_hit, ( (heap_blks_hit</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULLIF</span><span style="color:#E1E4E8;">((heap_blks_hit </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> heap_blks_read), </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> ratio </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> pg_statio_user_tables;</span></span>
<span class="line"><span style="color:#E1E4E8;"> relation | heap_read | heap_hit | ratio </span></span>
<span class="line"><span style="color:#6A737D;">----------+-----------+----------+-------</span></span>
<span class="line"><span style="color:#E1E4E8;"> emp1     |         </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> |       </span><span style="color:#79B8FF;">19</span><span style="color:#E1E4E8;"> |    </span><span style="color:#79B8FF;">95</span></span>
<span class="line"><span style="color:#E1E4E8;"> job      |         </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> |       </span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> |    </span><span style="color:#79B8FF;">82</span></span>
<span class="line"><span style="color:#E1E4E8;"> t        |         </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> |        </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> |      </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;SELECT</span><span style="color:#24292E;"> relname </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;relation&quot;</span><span style="color:#24292E;">,heap_blks_read </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> heap_read,heap_blks_hit </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> heap_hit, ( (heap_blks_hit</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULLIF</span><span style="color:#24292E;">((heap_blks_hit </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> heap_blks_read), </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> ratio </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> pg_statio_user_tables;</span></span>
<span class="line"><span style="color:#24292E;"> relation | heap_read | heap_hit | ratio </span></span>
<span class="line"><span style="color:#6A737D;">----------+-----------+----------+-------</span></span>
<span class="line"><span style="color:#24292E;"> emp1     |         </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> |       </span><span style="color:#005CC5;">19</span><span style="color:#24292E;"> |    </span><span style="color:#005CC5;">95</span></span>
<span class="line"><span style="color:#24292E;"> job      |         </span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> |       </span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> |    </span><span style="color:#005CC5;">82</span></span>
<span class="line"><span style="color:#24292E;"> t        |         </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> |        </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> |      </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span></code></pre></div><p><strong>7, 表膨胀的问题是PG中需要关注和注意的，所以经常监控膨胀率是一个很重要的问题</strong></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> constants </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> (	</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> current_setting(</span><span style="color:#9ECBFF;">&#39;block_size&#39;</span><span style="color:#E1E4E8;">)::</span><span style="color:#F97583;">numeric</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> bs, </span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> hdr, </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> ma</span></span>
<span class="line"><span style="color:#E1E4E8;">), bloat_info </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">ma,bs,schemaname,tablename,</span></span>
<span class="line"><span style="color:#E1E4E8;">(datawidth</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">(hdr</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">ma</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> hdr%ma</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> ma </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> hdr%ma </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">)))::</span><span style="color:#F97583;">numeric</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> datahdr,</span></span>
<span class="line"><span style="color:#E1E4E8;">(maxfracsum</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">(nullhdr</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">ma</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> nullhdr%ma</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> ma </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> nullhdr%ma </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">))) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> nullhdr2</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">schemaname, tablename, hdr, ma, bs,</span></span>
<span class="line"><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">((</span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">null_frac)</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">avg_width) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> datawidth,</span></span>
<span class="line"><span style="color:#79B8FF;">MAX</span><span style="color:#E1E4E8;">(null_frac) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> maxfracsum,</span></span>
<span class="line"><span style="color:#E1E4E8;">hdr</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">count</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">8</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> pg_stats s2</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> null_frac</span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schemaname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schemaname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tablename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tablename</span></span>
<span class="line"><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> nullhdr</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> pg_stats s, constants</span></span>
<span class="line"><span style="color:#F97583;">GROUP BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> foo</span></span>
<span class="line"><span style="color:#E1E4E8;">), table_bloat </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">schemaname, tablename, </span><span style="color:#79B8FF;">cc</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relpages</span><span style="color:#E1E4E8;">, bs,</span></span>
<span class="line"><span style="color:#E1E4E8;">CEIL((</span><span style="color:#79B8FF;">cc</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">reltuples</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">((datahdr</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">ma</span><span style="color:#F97583;">-</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> datahdr%ma</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> ma </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> datahdr%ma </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">nullhdr2</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">(bs</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">float</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> otta</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> bloat_info</span></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> pg_class cc </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">cc</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">bloat_info</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tablename</span></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> pg_namespace nn </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">cc</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relnamespace</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nn</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nn</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nspname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">bloat_info</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schemaname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nn</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nspname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;information_schema&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">), index_bloat </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">schemaname, tablename, bs,</span></span>
<span class="line"><span style="color:#79B8FF;">COALESCE</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">c2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relname</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;?&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> iname, </span><span style="color:#79B8FF;">COALESCE</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">c2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">reltuples</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> ituples, </span><span style="color:#79B8FF;">COALESCE</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">c2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relpages</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> ipages,</span></span>
<span class="line"><span style="color:#79B8FF;">COALESCE</span><span style="color:#E1E4E8;">(CEIL((</span><span style="color:#79B8FF;">c2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">reltuples</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">(datahdr</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">(bs</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">float</span><span style="color:#E1E4E8;">)),</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> iotta </span><span style="color:#6A737D;">-- very rough approximation, assumes all cols</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> bloat_info</span></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> pg_class cc </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">cc</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">bloat_info</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tablename</span></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> pg_namespace nn </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">cc</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relnamespace</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nn</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nn</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nspname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">bloat_info</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schemaname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nn</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nspname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;information_schema&#39;</span></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> pg_index i </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> indrelid </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">cc</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> pg_class c2 </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">c2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexrelid</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#F97583;">type</span><span style="color:#E1E4E8;">, schemaname, object_name, bloat, pg_size_pretty(raw_waste) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> waste</span></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#9ECBFF;">&#39;table&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">type</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">schemaname,</span></span>
<span class="line"><span style="color:#E1E4E8;">tablename </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> object_name,</span></span>
<span class="line"><span style="color:#79B8FF;">ROUND</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> otta</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">table_bloat</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relpages</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">otta::</span><span style="color:#F97583;">numeric</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> bloat,</span></span>
<span class="line"><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> relpages </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> otta </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;0&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> (bs</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">table_bloat</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relpages</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">otta)::</span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;">)::</span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> raw_waste</span></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">table_bloat</span></span>
<span class="line"><span style="color:#F97583;">UNION</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#9ECBFF;">&#39;index&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">type</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">schemaname,</span></span>
<span class="line"><span style="color:#E1E4E8;">tablename </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;::&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> iname </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> object_name,</span></span>
<span class="line"><span style="color:#79B8FF;">ROUND</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> iotta</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> ipages</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> ipages</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">iotta::</span><span style="color:#F97583;">numeric</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> bloat,</span></span>
<span class="line"><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> ipages </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> iotta </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;0&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> (bs</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">(ipages</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">iotta))::</span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> raw_waste</span></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">index_bloat) bloat_summary</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> raw_waste </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">, bloat </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">type</span><span style="color:#E1E4E8;">  | schemaname |                         object_name                          | bloat |   waste    </span></span>
<span class="line"><span style="color:#6A737D;">-------+------------+--------------------------------------------------------------+-------+------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> | public     | tbl_partial_index1                                           |   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">776</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> | public     | tbl_partial_index                                            |   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">776</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> | public     | tbl_index                                                    |   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">504</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> | public     | tbl_expression::idx_tbl_expression_a_b                       |   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">136</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> | public     | tbl_expression                                               |   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">72</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> | pg_catalog | pg_depend::pg_depend_reference_index                         |   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">72</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> | public     | tbl_expression::idx_tbl_expression_a                         |   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">48</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> | pg_catalog | pg_depend                                                    |   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">40</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> | pg_catalog | pg_ts_config_map::pg_ts_config_map_index                     |   </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> | pg_catalog | pg_amproc::pg_amproc_fam_proc_index                          |   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> | pg_catalog | pg_amop::pg_amop_opr_fam_index                               |   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> | pg_catalog | pg_class                                                     |   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> | pg_catalog | pg_constraint::pg_constraint_conparentid_index               |   </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">8192</span><span style="color:#E1E4E8;"> bytes</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">index</span><span style="color:#E1E4E8;"> | pg_catalog | pg_constraint::pg_constraint_conrelid_contypid_conname_index |   </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">8192</span><span style="color:#E1E4E8;"> bytes</span></span>
<span class="line"><span style="color:#E1E4E8;">......</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> constants </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> (	</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> current_setting(</span><span style="color:#032F62;">&#39;block_size&#39;</span><span style="color:#24292E;">)::</span><span style="color:#D73A49;">numeric</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> bs, </span><span style="color:#005CC5;">23</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> hdr, </span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> ma</span></span>
<span class="line"><span style="color:#24292E;">), bloat_info </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">ma,bs,schemaname,tablename,</span></span>
<span class="line"><span style="color:#24292E;">(datawidth</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">(hdr</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">ma</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> hdr%ma</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> ma </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> hdr%ma </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">)))::</span><span style="color:#D73A49;">numeric</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> datahdr,</span></span>
<span class="line"><span style="color:#24292E;">(maxfracsum</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">(nullhdr</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">ma</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> nullhdr%ma</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> ma </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> nullhdr%ma </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">))) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> nullhdr2</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">schemaname, tablename, hdr, ma, bs,</span></span>
<span class="line"><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">((</span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">null_frac)</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">avg_width) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> datawidth,</span></span>
<span class="line"><span style="color:#005CC5;">MAX</span><span style="color:#24292E;">(null_frac) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> maxfracsum,</span></span>
<span class="line"><span style="color:#24292E;">hdr</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">count</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">8</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> pg_stats s2</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> null_frac</span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schemaname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schemaname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tablename</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tablename</span></span>
<span class="line"><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> nullhdr</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> pg_stats s, constants</span></span>
<span class="line"><span style="color:#D73A49;">GROUP BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">5</span></span>
<span class="line"><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> foo</span></span>
<span class="line"><span style="color:#24292E;">), table_bloat </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">schemaname, tablename, </span><span style="color:#005CC5;">cc</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relpages</span><span style="color:#24292E;">, bs,</span></span>
<span class="line"><span style="color:#24292E;">CEIL((</span><span style="color:#005CC5;">cc</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">reltuples</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">((datahdr</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">ma</span><span style="color:#D73A49;">-</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> datahdr%ma</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> ma </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> datahdr%ma </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">nullhdr2</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">(bs</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">20</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">float</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> otta</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> bloat_info</span></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> pg_class cc </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">cc</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">bloat_info</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tablename</span></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> pg_namespace nn </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">cc</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relnamespace</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nn</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nn</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nspname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">bloat_info</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schemaname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nn</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nspname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;information_schema&#39;</span></span>
<span class="line"><span style="color:#24292E;">), index_bloat </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">schemaname, tablename, bs,</span></span>
<span class="line"><span style="color:#005CC5;">COALESCE</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">c2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relname</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;?&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> iname, </span><span style="color:#005CC5;">COALESCE</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">c2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">reltuples</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> ituples, </span><span style="color:#005CC5;">COALESCE</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">c2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relpages</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> ipages,</span></span>
<span class="line"><span style="color:#005CC5;">COALESCE</span><span style="color:#24292E;">(CEIL((</span><span style="color:#005CC5;">c2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">reltuples</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">(datahdr</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">(bs</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">20</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">float</span><span style="color:#24292E;">)),</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> iotta </span><span style="color:#6A737D;">-- very rough approximation, assumes all cols</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> bloat_info</span></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> pg_class cc </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">cc</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">bloat_info</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tablename</span></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> pg_namespace nn </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">cc</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relnamespace</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nn</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nn</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nspname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">bloat_info</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schemaname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nn</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nspname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;information_schema&#39;</span></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> pg_index i </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> indrelid </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">cc</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> pg_class c2 </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">c2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexrelid</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#D73A49;">type</span><span style="color:#24292E;">, schemaname, object_name, bloat, pg_size_pretty(raw_waste) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> waste</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#032F62;">&#39;table&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">type</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">schemaname,</span></span>
<span class="line"><span style="color:#24292E;">tablename </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> object_name,</span></span>
<span class="line"><span style="color:#005CC5;">ROUND</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> otta</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">table_bloat</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relpages</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">otta::</span><span style="color:#D73A49;">numeric</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> bloat,</span></span>
<span class="line"><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> relpages </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> otta </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;0&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> (bs</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">table_bloat</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relpages</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">otta)::</span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;">)::</span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> raw_waste</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">table_bloat</span></span>
<span class="line"><span style="color:#D73A49;">UNION</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#032F62;">&#39;index&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">type</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">schemaname,</span></span>
<span class="line"><span style="color:#24292E;">tablename </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;::&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> iname </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> object_name,</span></span>
<span class="line"><span style="color:#005CC5;">ROUND</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> iotta</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> ipages</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> ipages</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">iotta::</span><span style="color:#D73A49;">numeric</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> bloat,</span></span>
<span class="line"><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> ipages </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> iotta </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;0&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> (bs</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">(ipages</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">iotta))::</span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> raw_waste</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">index_bloat) bloat_summary</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> raw_waste </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">, bloat </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">type</span><span style="color:#24292E;">  | schemaname |                         object_name                          | bloat |   waste    </span></span>
<span class="line"><span style="color:#6A737D;">-------+------------+--------------------------------------------------------------+-------+------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> | public     | tbl_partial_index1                                           |   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">776</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> | public     | tbl_partial_index                                            |   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">776</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> | public     | tbl_index                                                    |   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">504</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> | public     | tbl_expression::idx_tbl_expression_a_b                       |   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">136</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> | public     | tbl_expression                                               |   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">72</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> | pg_catalog | pg_depend::pg_depend_reference_index                         |   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">72</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> | public     | tbl_expression::idx_tbl_expression_a                         |   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">48</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> | pg_catalog | pg_depend                                                    |   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">40</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> | pg_catalog | pg_ts_config_map::pg_ts_config_map_index                     |   </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> | pg_catalog | pg_amproc::pg_amproc_fam_proc_index                          |   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">7</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> | pg_catalog | pg_amop::pg_amop_opr_fam_index                               |   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> | pg_catalog | pg_class                                                     |   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> | pg_catalog | pg_constraint::pg_constraint_conparentid_index               |   </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">8192</span><span style="color:#24292E;"> bytes</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">index</span><span style="color:#24292E;"> | pg_catalog | pg_constraint::pg_constraint_conrelid_contypid_conname_index |   </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">8192</span><span style="color:#24292E;"> bytes</span></span>
<span class="line"><span style="color:#24292E;">......</span></span></code></pre></div><p>8 ,在PG 中一个数据块系统中有没有进行autovacuum 什么时候做的，最后一次分析是什么时间，等等都是重要的信息，一个系统的管理或者DBA是需要知晓这些事情，并根据这些信息来进行后续的操作等等</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> table_opts </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> (	</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#79B8FF;">pg_class</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;">, relname, nspname, array_to_string(reloptions, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> relopts</span></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">pg_class </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> pg_namespace ns </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> relnamespace </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ns</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span></span>
<span class="line"><span style="color:#E1E4E8;">), vacuum_settings </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">, relname, nspname,</span></span>
<span class="line"><span style="color:#F97583;">CASE</span></span>
<span class="line"><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> relopts </span><span style="color:#F97583;">LIKE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;%autovacuum_analyze_threshold%&#39;</span></span>
<span class="line"><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">substring</span><span style="color:#E1E4E8;">(relopts, </span><span style="color:#9ECBFF;">&#39;.*autovacuum_analyze_threshold=([0-9.]+).*&#39;</span><span style="color:#E1E4E8;">)::</span><span style="color:#F97583;">integer</span></span>
<span class="line"><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> current_setting(</span><span style="color:#9ECBFF;">&#39;autovacuum_analyze_threshold&#39;</span><span style="color:#E1E4E8;">)::</span><span style="color:#F97583;">integer</span></span>
<span class="line"><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> autovacuum_analyze_threshold,</span></span>
<span class="line"><span style="color:#F97583;">CASE</span></span>
<span class="line"><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> relopts </span><span style="color:#F97583;">LIKE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;%autovacuum_analyze_scale_factor%&#39;</span></span>
<span class="line"><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">substring</span><span style="color:#E1E4E8;">(relopts, </span><span style="color:#9ECBFF;">&#39;.*autovacuum_analyze_scale_factor=([0-9.]+).*&#39;</span><span style="color:#E1E4E8;">)::</span><span style="color:#F97583;">real</span></span>
<span class="line"><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> current_setting(</span><span style="color:#9ECBFF;">&#39;autovacuum_analyze_scale_factor&#39;</span><span style="color:#E1E4E8;">)::</span><span style="color:#F97583;">real</span></span>
<span class="line"><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> autovacuum_analyze_scale_factor</span></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">table_opts</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#79B8FF;">vacuum_settings</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">to_char(</span><span style="color:#79B8FF;">psut</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">last_analyze</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;YYYY-MM-DD HH24:MI&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> last_analyze,</span></span>
<span class="line"><span style="color:#E1E4E8;">to_char(</span><span style="color:#79B8FF;">psut</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">last_autoanalyze</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;YYYY-MM-DD HH24:MI&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> last_autoanalyze,</span></span>
<span class="line"><span style="color:#E1E4E8;">to_char(</span><span style="color:#79B8FF;">pg_class</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">reltuples</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;9G999G999G999&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> rowcount,</span></span>
<span class="line"><span style="color:#E1E4E8;">to_char(</span><span style="color:#79B8FF;">pg_class</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">reltuples</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULLIF</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">pg_class</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relpages</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&#39;999G999.99&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> rows_per_page,</span></span>
<span class="line"><span style="color:#E1E4E8;">to_char(autovacuum_analyze_threshold</span></span>
<span class="line"><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> (autovacuum_analyze_scale_factor::</span><span style="color:#F97583;">numeric</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_class</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">reltuples</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&#39;9G999G999G999&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> autovacuum_analyze_threshold,</span></span>
<span class="line"><span style="color:#F97583;">CASE</span></span>
<span class="line"><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> autovacuum_analyze_threshold </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> (autovacuum_analyze_scale_factor::</span><span style="color:#F97583;">numeric</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_class</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">reltuples</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">psut</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">n_dead_tup</span></span>
<span class="line"><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;yes&#39;</span></span>
<span class="line"><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> will_analyze</span></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">pg_stat_user_tables psut </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> pg_class </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">psut</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_class</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> vacuum_settings </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_class</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">vacuum_settings</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> table_opts </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> (	</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#005CC5;">pg_class</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;">, relname, nspname, array_to_string(reloptions, </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> relopts</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">pg_class </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> pg_namespace ns </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> relnamespace </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ns</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span></span>
<span class="line"><span style="color:#24292E;">), vacuum_settings </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#D73A49;">oid</span><span style="color:#24292E;">, relname, nspname,</span></span>
<span class="line"><span style="color:#D73A49;">CASE</span></span>
<span class="line"><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> relopts </span><span style="color:#D73A49;">LIKE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;%autovacuum_analyze_threshold%&#39;</span></span>
<span class="line"><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">substring</span><span style="color:#24292E;">(relopts, </span><span style="color:#032F62;">&#39;.*autovacuum_analyze_threshold=([0-9.]+).*&#39;</span><span style="color:#24292E;">)::</span><span style="color:#D73A49;">integer</span></span>
<span class="line"><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> current_setting(</span><span style="color:#032F62;">&#39;autovacuum_analyze_threshold&#39;</span><span style="color:#24292E;">)::</span><span style="color:#D73A49;">integer</span></span>
<span class="line"><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> autovacuum_analyze_threshold,</span></span>
<span class="line"><span style="color:#D73A49;">CASE</span></span>
<span class="line"><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> relopts </span><span style="color:#D73A49;">LIKE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;%autovacuum_analyze_scale_factor%&#39;</span></span>
<span class="line"><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">substring</span><span style="color:#24292E;">(relopts, </span><span style="color:#032F62;">&#39;.*autovacuum_analyze_scale_factor=([0-9.]+).*&#39;</span><span style="color:#24292E;">)::</span><span style="color:#D73A49;">real</span></span>
<span class="line"><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> current_setting(</span><span style="color:#032F62;">&#39;autovacuum_analyze_scale_factor&#39;</span><span style="color:#24292E;">)::</span><span style="color:#D73A49;">real</span></span>
<span class="line"><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> autovacuum_analyze_scale_factor</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">table_opts</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#005CC5;">vacuum_settings</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">to_char(</span><span style="color:#005CC5;">psut</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">last_analyze</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;YYYY-MM-DD HH24:MI&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> last_analyze,</span></span>
<span class="line"><span style="color:#24292E;">to_char(</span><span style="color:#005CC5;">psut</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">last_autoanalyze</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;YYYY-MM-DD HH24:MI&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> last_autoanalyze,</span></span>
<span class="line"><span style="color:#24292E;">to_char(</span><span style="color:#005CC5;">pg_class</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">reltuples</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;9G999G999G999&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> rowcount,</span></span>
<span class="line"><span style="color:#24292E;">to_char(</span><span style="color:#005CC5;">pg_class</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">reltuples</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULLIF</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">pg_class</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relpages</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">), </span><span style="color:#032F62;">&#39;999G999.99&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> rows_per_page,</span></span>
<span class="line"><span style="color:#24292E;">to_char(autovacuum_analyze_threshold</span></span>
<span class="line"><span style="color:#D73A49;">+</span><span style="color:#24292E;"> (autovacuum_analyze_scale_factor::</span><span style="color:#D73A49;">numeric</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_class</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">reltuples</span><span style="color:#24292E;">), </span><span style="color:#032F62;">&#39;9G999G999G999&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> autovacuum_analyze_threshold,</span></span>
<span class="line"><span style="color:#D73A49;">CASE</span></span>
<span class="line"><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> autovacuum_analyze_threshold </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> (autovacuum_analyze_scale_factor::</span><span style="color:#D73A49;">numeric</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_class</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">reltuples</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">psut</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">n_dead_tup</span></span>
<span class="line"><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;yes&#39;</span></span>
<span class="line"><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> will_analyze</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">pg_stat_user_tables psut </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> pg_class </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">psut</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_class</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> vacuum_settings </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_class</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">vacuum_settings</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202403291512619.png" alt=""></p><h2 id="_5-将view-和表之间的关系打印出来" tabindex="-1">5,将VIEW 和表之间的关系打印出来 <a class="header-anchor" href="#_5-将view-和表之间的关系打印出来" aria-label="Permalink to &quot;5,将VIEW 和表之间的关系打印出来&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;SELECT</span><span style="color:#E1E4E8;"> view_schema,view_name parent, table_schema, table_name </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">information_schema</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">view_table_usage</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> view_name </span><span style="color:#F97583;">LIKE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;_&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> view_name;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> view_schema | parent | table_schema | table_name </span></span>
<span class="line"><span style="color:#6A737D;">-------------+--------+--------------+------------</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;SELECT</span><span style="color:#24292E;"> view_schema,view_name parent, table_schema, table_name </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">information_schema</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">view_table_usage</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> view_name </span><span style="color:#D73A49;">LIKE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;_&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> view_name;</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> view_schema | parent | table_schema | table_name </span></span>
<span class="line"><span style="color:#6A737D;">-------------+--------+--------------+------------</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span></code></pre></div><p>6,查看锁表</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">lock1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> locked_pid,</span><span style="color:#79B8FF;">stat1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">usename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> locked_user,</span><span style="color:#79B8FF;">stat1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> locked_statement,</span><span style="color:#79B8FF;">stat1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">state</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">stat2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> locking_statement,</span><span style="color:#79B8FF;">stat2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">state</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stat1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_start</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> locking_duration,</span><span style="color:#79B8FF;">lock2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> locking_pid,</span><span style="color:#79B8FF;">stat2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">usename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> locking_user </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_locks</span><span style="color:#E1E4E8;"> lock1 </span><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_stat_activity</span><span style="color:#E1E4E8;"> stat1 </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">lock1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stat1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_locks</span><span style="color:#E1E4E8;"> lock2 </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">lock1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">locktype</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relation</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tuple</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">virtualxid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transactionid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">classid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objsubid</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISTINCT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">lock2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">locktype</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DATABASE</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relation</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tuple</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">virtualxid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transactionid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">classid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">lock2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objsubid</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_stat_activity</span><span style="color:#E1E4E8;"> stat2 </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">lock2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">stat2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">lock1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">granted</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">lock2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">granted</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">lock1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> locked_pid,</span><span style="color:#005CC5;">stat1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">usename</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> locked_user,</span><span style="color:#005CC5;">stat1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> locked_statement,</span><span style="color:#005CC5;">stat1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">state</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">state</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">stat2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> locking_statement,</span><span style="color:#005CC5;">stat2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">state</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">state</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">now</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stat1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_start</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> locking_duration,</span><span style="color:#005CC5;">lock2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> locking_pid,</span><span style="color:#005CC5;">stat2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">usename</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> locking_user </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_locks</span><span style="color:#24292E;"> lock1 </span><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_stat_activity</span><span style="color:#24292E;"> stat1 </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">lock1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stat1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_locks</span><span style="color:#24292E;"> lock2 </span><span style="color:#D73A49;">on</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">lock1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">locktype</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relation</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tuple</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">virtualxid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transactionid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">classid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objsubid</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISTINCT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">lock2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">locktype</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DATABASE</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relation</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tuple</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">virtualxid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transactionid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">classid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">lock2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objsubid</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_stat_activity</span><span style="color:#24292E;"> stat2 </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">lock2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">stat2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">lock1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">granted</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">lock2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">granted</span><span style="color:#24292E;">;</span></span></code></pre></div><p>将连接切断.</p><p>select pg_terminate_backend(pid)</p><h2 id="_6-重复索引" tabindex="-1">6,重复索引 <a class="header-anchor" href="#_6-重复索引" aria-label="Permalink to &quot;6,重复索引&quot;">​</a></h2><p>对于找到无用的index的问题,有两个点可以被用到, 第一个技术是找到索引重复的, 第二个是基于索引被访问到的状态.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">WITH index_info AS</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">(SELECT pg_get_indexdef(indexrelid) AS index_def, indexrelid::regclass</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">index_name , indrelid::regclass table_name, array_agg(attname) AS index_att </span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">FROM  pg_index i </span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">JOIN pg_attribute a ON i.indexrelid = a.attrelid</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">GROUP BY pg_get_indexdef(indexrelid), indrelid, indexrelid</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">)</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">SELECT DISTINCT</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">CASE WHEN a.index_name &gt; b.index_name THEN a.index_def</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">ELSE b.index_def END AS index_def,</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">CASE WHEN a.index_name &gt; b.index_name THEN</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">a.index_name ELSE b.index_name END AS index_name,</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">CASE WHEN a.index_name &gt; b.index_name THEN b.index_def</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">ELSE a.index_def END AS overlap_index_def,</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">CASE WHEN a.index_name &gt; b.index_name THEN b.index_def</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">ELSE a.index_def END AS overlap_index_name,</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">a.table_name</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">FROM</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">index_info a INNER </span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">JOIN index_info b ON a.index_name != b.index_name</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">AND a.table_name = b.table_name AND a.index_att &amp;&amp; b.index_att ;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">WITH index_info AS</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">(SELECT pg_get_indexdef(indexrelid) AS index_def, indexrelid::regclass</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">index_name , indrelid::regclass table_name, array_agg(attname) AS index_att </span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">FROM  pg_index i </span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">JOIN pg_attribute a ON i.indexrelid = a.attrelid</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">GROUP BY pg_get_indexdef(indexrelid), indrelid, indexrelid</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">)</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">SELECT DISTINCT</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">CASE WHEN a.index_name &gt; b.index_name THEN a.index_def</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">ELSE b.index_def END AS index_def,</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">CASE WHEN a.index_name &gt; b.index_name THEN</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">a.index_name ELSE b.index_name END AS index_name,</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">CASE WHEN a.index_name &gt; b.index_name THEN b.index_def</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">ELSE a.index_def END AS overlap_index_def,</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">CASE WHEN a.index_name &gt; b.index_name THEN b.index_def</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">ELSE a.index_def END AS overlap_index_name,</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">a.table_name</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">FROM</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">index_info a INNER </span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">JOIN index_info b ON a.index_name != b.index_name</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">AND a.table_name = b.table_name AND a.index_att &amp;&amp; b.index_att ;</span></span></code></pre></div><p><strong>面这段寻找INDEX 重复的主要是基于INDEX NAME 和创建INDEX语句的比对生成的. 所以在给出结果后,还需要人工来进行更细致的比对,不能进行直接的重复索引的清理</strong></p><p><a href="https://www.modb.pro/db/25190" target="_blank" rel="noreferrer">https://www.modb.pro/db/25190</a></p><h1 id="_2-dba最常用sql" tabindex="-1">2,DBA最常用SQL <a class="header-anchor" href="#_2-dba最常用sql" aria-label="Permalink to &quot;2,DBA最常用SQL&quot;">​</a></h1><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">schema</span><span style="color:#E1E4E8;"> dba;</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SCHEMA</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> view </span><span style="color:#79B8FF;">dba</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">invalid_index</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> indisvalid, indexrelid::regclass, indrelid::regclass, pg_get_indexdef(indexrelid) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_index </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> indisvalid;</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> VIEW</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> view </span><span style="color:#79B8FF;">dba</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">ro_conflicts</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> datname,pg_stat_get_db_conflict_all(</span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">) conflict_all,pg_stat_get_db_conflict_bufferpin(</span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">) conflict_bufferpin,pg_stat_get_db_conflict_lock(</span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">) conflict_lock,pg_stat_get_db_conflict_snapshot(</span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">) conflict_snapshot,pg_stat_get_db_conflict_startup_deadlock(</span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">) conflict_deadlock,pg_stat_get_db_conflict_tablespace(</span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">) conflict_tbs </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_database;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">schema</span><span style="color:#24292E;"> dba;</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">SCHEMA</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> view </span><span style="color:#005CC5;">dba</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">invalid_index</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> indisvalid, indexrelid::regclass, indrelid::regclass, pg_get_indexdef(indexrelid) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_index </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> indisvalid;</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> VIEW</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> view </span><span style="color:#005CC5;">dba</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">ro_conflicts</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> datname,pg_stat_get_db_conflict_all(</span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">) conflict_all,pg_stat_get_db_conflict_bufferpin(</span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">) conflict_bufferpin,pg_stat_get_db_conflict_lock(</span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">) conflict_lock,pg_stat_get_db_conflict_snapshot(</span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">) conflict_snapshot,pg_stat_get_db_conflict_startup_deadlock(</span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">) conflict_deadlock,pg_stat_get_db_conflict_tablespace(</span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">) conflict_tbs </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_database;</span></span></code></pre></div><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">or</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">replace</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">procedure</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">dba</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tps</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> $$</span></span>
<span class="line"><span style="color:#F97583;">declare</span></span>
<span class="line"><span style="color:#E1E4E8;">  v1 int8;</span></span>
<span class="line"><span style="color:#E1E4E8;">  v2 int8;</span></span>
<span class="line"><span style="color:#F97583;">begin</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> txid_snapshot_xmax(txid_current_snapshot()) </span><span style="color:#F97583;">into</span><span style="color:#E1E4E8;"> v1;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">commit</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  perform pg_sleep(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> txid_snapshot_xmax(txid_current_snapshot()) </span><span style="color:#F97583;">into</span><span style="color:#E1E4E8;"> v2;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">commit</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  raise notice </span><span style="color:#9ECBFF;">&#39;tps: %&#39;</span><span style="color:#E1E4E8;">, v2</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v1;</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">$$ </span><span style="color:#F97583;">language</span><span style="color:#E1E4E8;"> plpgsql ;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">or</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">replace</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">procedure</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">dba</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tps</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> $$</span></span>
<span class="line"><span style="color:#D73A49;">declare</span></span>
<span class="line"><span style="color:#24292E;">  v1 int8;</span></span>
<span class="line"><span style="color:#24292E;">  v2 int8;</span></span>
<span class="line"><span style="color:#D73A49;">begin</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> txid_snapshot_xmax(txid_current_snapshot()) </span><span style="color:#D73A49;">into</span><span style="color:#24292E;"> v1;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">commit</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  perform pg_sleep(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> txid_snapshot_xmax(txid_current_snapshot()) </span><span style="color:#D73A49;">into</span><span style="color:#24292E;"> v2;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">commit</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  raise notice </span><span style="color:#032F62;">&#39;tps: %&#39;</span><span style="color:#24292E;">, v2</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v1;</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">$$ </span><span style="color:#D73A49;">language</span><span style="color:#24292E;"> plpgsql ;</span></span></code></pre></div><p><a href="https://www.modb.pro/db/25717" target="_blank" rel="noreferrer">https://www.modb.pro/db/25717</a></p><p><a href="https://blog.csdn.net/horses/article/details/115058511?spm=1001.2014.3001.5501" target="_blank" rel="noreferrer">https://blog.csdn.net/horses/article/details/115058511?spm=1001.2014.3001.5501</a></p><p><a href="https://www.modb.pro/db/26058" target="_blank" rel="noreferrer">https://www.modb.pro/db/26058</a></p>`,84),e=[o];function t(c,r,E,y,i,F){return n(),a("div",null,e)}const D=s(p,[["render",t]]);export{A as __pageData,D as default};
