import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const u=JSON.parse('{"title":"1.单节点快照备份","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/etcd/7-backup.md","filePath":"guide/Database/etcd/7-backup.md","lastUpdated":1736331883000}'),o={name:"guide/Database/etcd/7-backup.md"},p=l(`<h1 id="_1-单节点快照备份" tabindex="-1">1.单节点快照备份 <a class="header-anchor" href="#_1-单节点快照备份" aria-label="Permalink to &quot;1.单节点快照备份&quot;">​</a></h1><p>如果没有etcdctl工具，进行下载</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# ETCD_VER=v3.5.0</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# wget https://github.com/etcd-io/etcd/releases/download/\${ETCD_VER}/etcd-\${ETCD_VER}-linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# tar xf etcd-v3.5.0-linux-amd64.tar.gz </span></span>
<span class="line"><span style="color:#E1E4E8;">[root@master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# cp etcd-v3.5.0-linux-amd64/etcdctl /usr/local/bin/</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# cp etcd-v3.5.0-linux-amd64/etcdutl /usr/local/bin/</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# etcdctl version</span></span>
<span class="line"><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">version:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3.5</span><span style="color:#9ECBFF;">.0</span></span>
<span class="line"><span style="color:#B392F0;">API</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">version:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3.5</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# ETCD_VER=v3.5.0</span></span>
<span class="line"><span style="color:#24292E;">[root@master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# wget https://github.com/etcd-io/etcd/releases/download/\${ETCD_VER}/etcd-\${ETCD_VER}-linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#24292E;">[root@master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# tar xf etcd-v3.5.0-linux-amd64.tar.gz </span></span>
<span class="line"><span style="color:#24292E;">[root@master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# cp etcd-v3.5.0-linux-amd64/etcdctl /usr/local/bin/</span></span>
<span class="line"><span style="color:#24292E;">[root@master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# cp etcd-v3.5.0-linux-amd64/etcdutl /usr/local/bin/</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# etcdctl version</span></span>
<span class="line"><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">version:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3.5</span><span style="color:#032F62;">.0</span></span>
<span class="line"><span style="color:#6F42C1;">API</span><span style="color:#24292E;"> </span><span style="color:#032F62;">version:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3.5</span></span></code></pre></div><h2 id="_1-备份" tabindex="-1">1.备份 <a class="header-anchor" href="#_1-备份" aria-label="Permalink to &quot;1.备份&quot;">​</a></h2><p>如果有证书，添加(cacert、cert、key)这三个参数即可，没有去掉即可</p><p>比如：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# export ETCDCTL_API=3</span></span>
<span class="line"><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--cacert=/etc/kubernetes/pki/etcd/ca.crt </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--cert=/etc/kubernetes/pki/etcd/server.crt </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--key=/etc/kubernetes/pki/etcd/server.key </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--endpoints=https://127.0.0.1:2379 </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">endpoint </span><span style="color:#9ECBFF;">status</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--write-out=table</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">+------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+-------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">ENDPOINT</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">ID</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">VERSION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">DB</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">SIZE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">LEADER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">LEARNER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">RAFT</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">TERM</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">RAFT</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">INDEX</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">RAFT</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">APPLIED</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">INDEX</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ERRORS</span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+-------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">https://127.0.0.1:2379</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">e8b350c59aaca55a</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">3.5.9</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">3.9</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MB</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">27</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">802333</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">             </span><span style="color:#B392F0;">802333</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">|</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# export ETCDCTL_API=3</span></span>
<span class="line"><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--cacert=/etc/kubernetes/pki/etcd/ca.crt </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--cert=/etc/kubernetes/pki/etcd/server.crt </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--key=/etc/kubernetes/pki/etcd/server.key </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--endpoints=https://127.0.0.1:2379 </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">endpoint </span><span style="color:#032F62;">status</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--write-out=table</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">+------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+-------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;">        </span><span style="color:#6F42C1;">ENDPOINT</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">        </span><span style="color:#6F42C1;">ID</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">VERSION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DB</span><span style="color:#24292E;"> </span><span style="color:#032F62;">SIZE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">LEADER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">LEARNER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RAFT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">TERM</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RAFT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">INDEX</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RAFT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">APPLIED</span><span style="color:#24292E;"> </span><span style="color:#032F62;">INDEX</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ERRORS</span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+-------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">https://127.0.0.1:2379</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">e8b350c59aaca55a</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">3.5.9</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">3.9</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MB</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">false</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">false</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">        </span><span style="color:#6F42C1;">27</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">802333</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">             </span><span style="color:#6F42C1;">802333</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">|</span></span></code></pre></div><p>etcd中每一列字段含义</p><table><thead><tr><th>字段</th><th>含义</th></tr></thead><tbody><tr><td>ENDPOINT</td><td>etcd 的访问地址，客户端通过这个地址来连接到 etcd</td></tr><tr><td>ID</td><td>etcd 节点的唯一标识符</td></tr><tr><td>VERSION</td><td>etcd 服务的版本号</td></tr><tr><td>DB SIZE</td><td>etcd 数据库的大小</td></tr><tr><td>IS LEADER</td><td>表示该节点是否是 Raft 集群的 leader。在 Raft 协议中，leader 负责处理所有的客户端交互，日志复制，以及其他的节点（followers）接收 leader 的指令。</td></tr><tr><td>IS LEARNER</td><td>表示该节点是否是 learner。在 etcd 集群中，一个节点可以作为 learner，这意味着它可以接收来自 leader 的日志条目，但不能参与投票。</td></tr><tr><td>RAFT TERM</td><td>Raft 术语中的 &quot;term&quot; 是一个逻辑时间单位，在这个&quot;term&quot; 时间内，会选出一个新的 leader。</td></tr><tr><td>RAFT INDE</td><td>最新的 Raft 日志条目的索引。</td></tr><tr><td>RAFT APPLIED INDEX</td><td>已应用到状态机的最新的 Raft 日志条目的索引。</td></tr><tr><td>ERRORS</td><td>etcd 节点在处理时遇到的错误。</td></tr></tbody></table><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">DATE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">date</span><span style="color:#9ECBFF;"> +%Y-%m-%d)</span></span>
<span class="line"><span style="color:#E1E4E8;">BIND_IP</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">/sbin/ifconfig</span><span style="color:#9ECBFF;"> \${</span><span style="color:#E1E4E8;">ETH0</span><span style="color:#9ECBFF;">}</span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-Eo</span><span style="color:#9ECBFF;"> &#39;inet (addr:)?([0-9]*\\.){3}[0-9]*&#39; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-Eo</span><span style="color:#9ECBFF;"> &#39;([0-9]*\\.){3}[0-9]*&#39; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-v</span><span style="color:#9ECBFF;"> &#39;127.0.0.1&#39; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">head</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-1</span><span style="color:#9ECBFF;">\`</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@localhost </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]#etcdctl --endpoints localhost:2379 snapshot save  $BIND_IP-snapshot-$DATE.db</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">&quot;level&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;info&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;ts&quot;</span><span style="color:#B392F0;">:1623915233.1032534,</span><span style="color:#B392F0;">&quot;caller&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;snapshot/v3_snapshot.go:119&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;msg&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;created temporary db file&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;path&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;uu.db.part&quot;</span><span style="color:#B392F0;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">&quot;level&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;info&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;ts&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;2021-06-17T03:33:53.105-0400&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;caller&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;clientv3/maintenance.go:200&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;msg&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;opened snapshot stream; downloading&quot;</span><span style="color:#B392F0;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">&quot;level&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;info&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;ts&quot;</span><span style="color:#B392F0;">:1623915233.1055887,</span><span style="color:#B392F0;">&quot;caller&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;snapshot/v3_snapshot.go:127&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;msg&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;fetching snapshot&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;endpoint&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;localhost:2379&quot;</span><span style="color:#B392F0;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">&quot;level&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;info&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;ts&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;2021-06-17T03:33:53.108-0400&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;caller&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;clientv3/maintenance.go:208&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;msg&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;completed snapshot read; closing&quot;</span><span style="color:#B392F0;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">&quot;level&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;info&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;ts&quot;</span><span style="color:#B392F0;">:1623915233.1104572,</span><span style="color:#B392F0;">&quot;caller&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;snapshot/v3_snapshot.go:142&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;msg&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;fetched snapshot&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;endpoint&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;localhost:2379&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;size&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;20 kB&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;took&quot;</span><span style="color:#B392F0;">:0.007136312}</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">&quot;level&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;info&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;ts&quot;</span><span style="color:#B392F0;">:1623915233.1106055,</span><span style="color:#B392F0;">&quot;caller&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;snapshot/v3_snapshot.go:152&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;msg&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;saved&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;path&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;uu.db&quot;</span><span style="color:#B392F0;">}</span></span>
<span class="line"><span style="color:#B392F0;">Snapshot</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">saved</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">at</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">uu.db</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">DATE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">date</span><span style="color:#032F62;"> +%Y-%m-%d)</span></span>
<span class="line"><span style="color:#24292E;">BIND_IP</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">/sbin/ifconfig</span><span style="color:#032F62;"> \${</span><span style="color:#24292E;">ETH0</span><span style="color:#032F62;">}</span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-Eo</span><span style="color:#032F62;"> &#39;inet (addr:)?([0-9]*\\.){3}[0-9]*&#39; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-Eo</span><span style="color:#032F62;"> &#39;([0-9]*\\.){3}[0-9]*&#39; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-v</span><span style="color:#032F62;"> &#39;127.0.0.1&#39; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">head</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-1</span><span style="color:#032F62;">\`</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@localhost </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]#etcdctl --endpoints localhost:2379 snapshot save  $BIND_IP-snapshot-$DATE.db</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#6F42C1;">&quot;level&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;info&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;ts&quot;</span><span style="color:#6F42C1;">:1623915233.1032534,</span><span style="color:#6F42C1;">&quot;caller&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;snapshot/v3_snapshot.go:119&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;msg&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;created temporary db file&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;path&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;uu.db.part&quot;</span><span style="color:#6F42C1;">}</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#6F42C1;">&quot;level&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;info&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;ts&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;2021-06-17T03:33:53.105-0400&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;caller&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;clientv3/maintenance.go:200&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;msg&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;opened snapshot stream; downloading&quot;</span><span style="color:#6F42C1;">}</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#6F42C1;">&quot;level&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;info&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;ts&quot;</span><span style="color:#6F42C1;">:1623915233.1055887,</span><span style="color:#6F42C1;">&quot;caller&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;snapshot/v3_snapshot.go:127&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;msg&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;fetching snapshot&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;endpoint&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;localhost:2379&quot;</span><span style="color:#6F42C1;">}</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#6F42C1;">&quot;level&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;info&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;ts&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;2021-06-17T03:33:53.108-0400&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;caller&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;clientv3/maintenance.go:208&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;msg&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;completed snapshot read; closing&quot;</span><span style="color:#6F42C1;">}</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#6F42C1;">&quot;level&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;info&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;ts&quot;</span><span style="color:#6F42C1;">:1623915233.1104572,</span><span style="color:#6F42C1;">&quot;caller&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;snapshot/v3_snapshot.go:142&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;msg&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;fetched snapshot&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;endpoint&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;localhost:2379&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;size&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;20 kB&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;took&quot;</span><span style="color:#6F42C1;">:0.007136312}</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#6F42C1;">&quot;level&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;info&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;ts&quot;</span><span style="color:#6F42C1;">:1623915233.1106055,</span><span style="color:#6F42C1;">&quot;caller&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;snapshot/v3_snapshot.go:152&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;msg&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;saved&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;path&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;uu.db&quot;</span><span style="color:#6F42C1;">}</span></span>
<span class="line"><span style="color:#6F42C1;">Snapshot</span><span style="color:#24292E;"> </span><span style="color:#032F62;">saved</span><span style="color:#24292E;"> </span><span style="color:#032F62;">at</span><span style="color:#24292E;"> </span><span style="color:#032F62;">uu.db</span></span></code></pre></div><ul><li>查看快照信息</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[root@localhost ~]# etcdctl snapshot status uu.db --write-out=table</span></span>
<span class="line"><span style="color:#e1e4e8;">+----------+----------+------------+------------+</span></span>
<span class="line"><span style="color:#e1e4e8;">|   HASH   | REVISION | TOTAL KEYS | TOTAL SIZE |</span></span>
<span class="line"><span style="color:#e1e4e8;">+----------+----------+------------+------------+</span></span>
<span class="line"><span style="color:#e1e4e8;">| 6d1803a9 |      110 |        146 |      37 kB |</span></span>
<span class="line"><span style="color:#e1e4e8;">+----------+----------+------------+------------+</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[root@localhost ~]# etcdctl snapshot status uu.db --write-out=table</span></span>
<span class="line"><span style="color:#24292e;">+----------+----------+------------+------------+</span></span>
<span class="line"><span style="color:#24292e;">|   HASH   | REVISION | TOTAL KEYS | TOTAL SIZE |</span></span>
<span class="line"><span style="color:#24292e;">+----------+----------+------------+------------+</span></span>
<span class="line"><span style="color:#24292e;">| 6d1803a9 |      110 |        146 |      37 kB |</span></span>
<span class="line"><span style="color:#24292e;">+----------+----------+------------+------------+</span></span></code></pre></div><h2 id="_2-恢复" tabindex="-1">2.恢复 <a class="header-anchor" href="#_2-恢复" aria-label="Permalink to &quot;2.恢复&quot;">​</a></h2><p>停止etcd服务，等待etcd容器停止后，在执行恢复操作</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">删除当前etcd的data目录，否则会报错目录已存在</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">操作：</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/etcd_data/</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@localhost etcd_data]# etcdctl snapshot restore /root/192.168.122.247-snapshot-2021-06-17.db --data-dir=./data/etcd_data/</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">&quot;level&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;info&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;ts&quot;</span><span style="color:#B392F0;">:1623915905.37449,</span><span style="color:#B392F0;">&quot;caller&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;snapshot/v3_snapshot.go:296&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;msg&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;restoring snapshot&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;path&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;/root/192.168.122.247-snapshot-2021-06-17.db&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;wal-dir&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;data/etcd_data/member/wal&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;data-dir&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;./data/etcd_data/&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;snap-dir&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;data/etcd_data/member/snap&quot;</span><span style="color:#B392F0;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">&quot;level&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;info&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;ts&quot;</span><span style="color:#B392F0;">:1623915905.382676,</span><span style="color:#B392F0;">&quot;caller&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;membership/cluster.go:392&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;msg&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;added member&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;cluster-id&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;cdf818194e3a8c32&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;local-member-id&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;0&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;added-peer-id&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;8e9e05c52164694d&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;added-peer-peer-urls&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#E1E4E8;">[</span><span style="color:#B392F0;">&quot;http://localhost:2380&quot;</span><span style="color:#B392F0;">]}</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">&quot;level&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;info&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;ts&quot;</span><span style="color:#B392F0;">:1623915905.391657,</span><span style="color:#B392F0;">&quot;caller&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;snapshot/v3_snapshot.go:309&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;msg&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;restored snapshot&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;path&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;/root/192.168.122.247-snapshot-2021-06-17.db&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;wal-dir&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;data/etcd_data/member/wal&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;data-dir&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;./data/etcd_data/&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;snap-dir&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;data/etcd_data/member/snap&quot;</span><span style="color:#B392F0;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#恢复完成后需要将从备份重新生成的data目录的属主和属组修改为etcd系统服务中的对应属主和属组</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@localhost etcd_data]# ls</span></span>
<span class="line"><span style="color:#B392F0;">data</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">default.etcd</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">etcd.conf</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">etcd.yml</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">etcds</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">member</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">wal</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@localhost etcd_data]# ls data/</span></span>
<span class="line"><span style="color:#B392F0;">etcd_data</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">此时会在/data/etcd/</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">下新建立</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">data目录，因此会改变存储路径，此时需要进行数据目录的修改</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">mv</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">default.etcd</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">default.etcd_bak</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">mv</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/etcd/data/etcd/default.etcd</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">/data/etcd/</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-rf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/etcd/data</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#B392F0;">重启etcd</span></span>
<span class="line"><span style="color:#6A737D;"># systemctl stop etcd</span></span>
<span class="line"><span style="color:#6A737D;"># systemctl start etcd</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">删除当前etcd的data目录，否则会报错目录已存在</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">操作：</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">export</span><span style="color:#24292E;"> ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/etcd_data/</span></span>
<span class="line"><span style="color:#24292E;">[root@localhost etcd_data]# etcdctl snapshot restore /root/192.168.122.247-snapshot-2021-06-17.db --data-dir=./data/etcd_data/</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#6F42C1;">&quot;level&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;info&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;ts&quot;</span><span style="color:#6F42C1;">:1623915905.37449,</span><span style="color:#6F42C1;">&quot;caller&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;snapshot/v3_snapshot.go:296&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;msg&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;restoring snapshot&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;path&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;/root/192.168.122.247-snapshot-2021-06-17.db&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;wal-dir&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;data/etcd_data/member/wal&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;data-dir&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;./data/etcd_data/&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;snap-dir&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;data/etcd_data/member/snap&quot;</span><span style="color:#6F42C1;">}</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#6F42C1;">&quot;level&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;info&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;ts&quot;</span><span style="color:#6F42C1;">:1623915905.382676,</span><span style="color:#6F42C1;">&quot;caller&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;membership/cluster.go:392&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;msg&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;added member&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;cluster-id&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;cdf818194e3a8c32&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;local-member-id&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;0&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;added-peer-id&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;8e9e05c52164694d&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;added-peer-peer-urls&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;">[</span><span style="color:#6F42C1;">&quot;http://localhost:2380&quot;</span><span style="color:#6F42C1;">]}</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#6F42C1;">&quot;level&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;info&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;ts&quot;</span><span style="color:#6F42C1;">:1623915905.391657,</span><span style="color:#6F42C1;">&quot;caller&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;snapshot/v3_snapshot.go:309&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;msg&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;restored snapshot&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;path&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;/root/192.168.122.247-snapshot-2021-06-17.db&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;wal-dir&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;data/etcd_data/member/wal&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;data-dir&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;./data/etcd_data/&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;snap-dir&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;data/etcd_data/member/snap&quot;</span><span style="color:#6F42C1;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#恢复完成后需要将从备份重新生成的data目录的属主和属组修改为etcd系统服务中的对应属主和属组</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@localhost etcd_data]# ls</span></span>
<span class="line"><span style="color:#6F42C1;">data</span><span style="color:#24292E;">  </span><span style="color:#032F62;">default.etcd</span><span style="color:#24292E;">  </span><span style="color:#032F62;">etcd.conf</span><span style="color:#24292E;">  </span><span style="color:#032F62;">etcd.yml</span><span style="color:#24292E;">  </span><span style="color:#032F62;">etcds</span><span style="color:#24292E;">  </span><span style="color:#032F62;">member</span><span style="color:#24292E;">  </span><span style="color:#032F62;">wal</span></span>
<span class="line"><span style="color:#24292E;">[root@localhost etcd_data]# ls data/</span></span>
<span class="line"><span style="color:#6F42C1;">etcd_data</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">此时会在/data/etcd/</span><span style="color:#24292E;"> </span><span style="color:#032F62;">下新建立</span><span style="color:#24292E;"> </span><span style="color:#032F62;">data目录，因此会改变存储路径，此时需要进行数据目录的修改</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">default.etcd</span><span style="color:#24292E;">  </span><span style="color:#032F62;">default.etcd_bak</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/etcd/data/etcd/default.etcd</span><span style="color:#24292E;">   </span><span style="color:#032F62;">/data/etcd/</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-rf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/etcd/data</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">重启etcd</span></span>
<span class="line"><span style="color:#6A737D;"># systemctl stop etcd</span></span>
<span class="line"><span style="color:#6A737D;"># systemctl start etcd</span></span></code></pre></div><h2 id="_3-2380端口备份" tabindex="-1">3. 2380端口备份 <a class="header-anchor" href="#_3-2380端口备份" aria-label="Permalink to &quot;3. 2380端口备份&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">ETCDCTL_API=3 etcdctl --endpoints=http://192.168.122.249:2380 snapshot save snapshot.db</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#恢复</span></span>
<span class="line"><span style="color:#e1e4e8;">ETCDCTL_API=3 etcdctl snapshot restore snapshot.db</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#重启故障etcd,修改已存在集群</span></span>
<span class="line"><span style="color:#e1e4e8;">initial-cluster-state为existing</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">ETCDCTL_API=3 etcdctl --endpoints=http://192.168.122.249:2380 snapshot save snapshot.db</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#恢复</span></span>
<span class="line"><span style="color:#24292e;">ETCDCTL_API=3 etcdctl snapshot restore snapshot.db</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#重启故障etcd,修改已存在集群</span></span>
<span class="line"><span style="color:#24292e;">initial-cluster-state为existing</span></span></code></pre></div><h1 id="_2-集群快照备份" tabindex="-1">2.集群快照备份 <a class="header-anchor" href="#_2-集群快照备份" aria-label="Permalink to &quot;2.集群快照备份&quot;">​</a></h1><h2 id="_1-备份-1" tabindex="-1">1.备份 <a class="header-anchor" href="#_1-备份-1" aria-label="Permalink to &quot;1.备份&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="color:#E1E4E8;">DATE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">date</span><span style="color:#9ECBFF;"> +%Y-%m-%d-%H)</span></span>
<span class="line"><span style="color:#E1E4E8;">BIND_IP</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">/sbin/ifconfig</span><span style="color:#9ECBFF;"> \${</span><span style="color:#E1E4E8;">ETH0</span><span style="color:#9ECBFF;">}</span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-Eo</span><span style="color:#9ECBFF;"> &#39;inet (addr:)?([0-9]*\\.){3}[0-9]*&#39; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-Eo</span><span style="color:#9ECBFF;"> &#39;([0-9]*\\.){3}[0-9]*&#39; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-v</span><span style="color:#9ECBFF;"> &#39;127.0.0.1&#39; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">head</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-1</span><span style="color:#9ECBFF;">\`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">backup_path</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;/data/aw-etcdbak/&quot;</span></span>
<span class="line"><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> $backup_path</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">ENDPOINTS</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;10.16.1.110:12379,10.16.1.111:12379,10.16.1.112:12379&#39;</span></span>
<span class="line"><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--endpoints=</span><span style="color:#E1E4E8;">$ENDPOINTS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">snapshot</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">save</span><span style="color:#E1E4E8;">  $BIND_IP</span><span style="color:#9ECBFF;">-snapshot-</span><span style="color:#E1E4E8;">$DATE</span><span style="color:#9ECBFF;">.db</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">find</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">./</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-type</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">f</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-name</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&quot;*.db&quot;</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-mtime</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+7</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">xargs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看备份快照信息</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@localhost </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]#  etcdctl --write-out=table snapshot status 192.168.122.247-snapshot-2021-06-17.db</span></span>
<span class="line"><span style="color:#B392F0;">+----------+----------+------------+------------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">HASH</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">REVISION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TOTAL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">KEYS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TOTAL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">SIZE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+----------+----------+------------+------------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cefed78f</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kB</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+----------+----------+------------+------------+</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="color:#24292E;">DATE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">date</span><span style="color:#032F62;"> +%Y-%m-%d-%H)</span></span>
<span class="line"><span style="color:#24292E;">BIND_IP</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">/sbin/ifconfig</span><span style="color:#032F62;"> \${</span><span style="color:#24292E;">ETH0</span><span style="color:#032F62;">}</span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-Eo</span><span style="color:#032F62;"> &#39;inet (addr:)?([0-9]*\\.){3}[0-9]*&#39; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-Eo</span><span style="color:#032F62;"> &#39;([0-9]*\\.){3}[0-9]*&#39; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-v</span><span style="color:#032F62;"> &#39;127.0.0.1&#39; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">head</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-1</span><span style="color:#032F62;">\`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">backup_path</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;/data/aw-etcdbak/&quot;</span></span>
<span class="line"><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> $backup_path</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">ENDPOINTS</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;10.16.1.110:12379,10.16.1.111:12379,10.16.1.112:12379&#39;</span></span>
<span class="line"><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--endpoints=</span><span style="color:#24292E;">$ENDPOINTS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">snapshot</span><span style="color:#24292E;"> </span><span style="color:#032F62;">save</span><span style="color:#24292E;">  $BIND_IP</span><span style="color:#032F62;">-snapshot-</span><span style="color:#24292E;">$DATE</span><span style="color:#032F62;">.db</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">find</span><span style="color:#24292E;"> </span><span style="color:#032F62;">./</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-type</span><span style="color:#24292E;"> </span><span style="color:#032F62;">f</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-name</span><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;*.db&quot;</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">-mtime</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+7</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">xargs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看备份快照信息</span></span>
<span class="line"><span style="color:#24292E;">[root@localhost </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]#  etcdctl --write-out=table snapshot status 192.168.122.247-snapshot-2021-06-17.db</span></span>
<span class="line"><span style="color:#6F42C1;">+----------+----------+------------+------------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">HASH</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">REVISION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TOTAL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">KEYS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TOTAL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">SIZE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+----------+----------+------------+------------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cefed78f</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">        </span><span style="color:#6F42C1;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">          </span><span style="color:#6F42C1;">3</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">      </span><span style="color:#6F42C1;">20</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kB</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+----------+----------+------------+------------+</span></span></code></pre></div><h2 id="_2-数据恢复" tabindex="-1">2.数据恢复 <a class="header-anchor" href="#_2-数据恢复" aria-label="Permalink to &quot;2.数据恢复&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">etcd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">获取备份数据172.24.119.41-snapshot-2021-06-17.db</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">后，分别将改备份数据分发至三个节点</span></span>
<span class="line"><span style="color:#B392F0;">分别停止etcd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">三个节点</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stop</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd</span></span>
<span class="line"><span style="color:#B392F0;">确认停掉三个节点后依次执行恢复操作</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">node1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">恢复操作</span></span>
<span class="line"><span style="color:#B392F0;">mv</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/etcd/node1.etcd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/etcd/node1.etcd_bak</span></span>
<span class="line"><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/etcd/</span></span>
<span class="line"><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--data-dir=/var/lib/etcd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">snapshot</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">restore</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">/data/172.24.119.41-snapshot-2019-09-24.db</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">--name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node1</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">--initial-cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node1=http://172.25.102.10:2380,node2=http://172.25.102.39:2380,node3=http://172.25.102.17:2380</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">--initial-advertise-peer-urls</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://172.25.102.10:2380</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">node2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">恢复操作</span></span>
<span class="line"><span style="color:#B392F0;">mv</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/etcd/node2.etcd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/etcd/node2.etcd_bak</span></span>
<span class="line"><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/etcd/</span></span>
<span class="line"><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--data-dir=/var/lib/etcd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">snapshot</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">restore</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">/data/172.24.119.41-snapshot-2019-09-24.db</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">--name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node2</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">--initial-cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node1=http://172.25.102.10:2380,node2=http://172.25.102.39:2380,node3=http://172.25.102.17:2380</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">--initial-advertise-peer-urls</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://172.25.102.39:2380</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">node3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">恢复操作</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">mv</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/etcd/node3.etcd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/etcd/node3.etcd_bak</span></span>
<span class="line"><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/etcd/</span></span>
<span class="line"><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--data-dir=/var/lib/etcd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">snapshot</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">restore</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">/data/172.24.119.41-snapshot-2019-09-24.db</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">--name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node3</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">--initial-cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node1=http://172.25.102.10:2380,node2=http://172.25.102.39:2380,node3=http://172.25.102.17:2380</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">--initial-advertise-peer-urls</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://172.25.102.17:2380</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">node1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">依次启动</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/ad/media</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">查看恢复的数据已正常</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">etcd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">获取备份数据172.24.119.41-snapshot-2021-06-17.db</span><span style="color:#24292E;"> </span><span style="color:#032F62;">后，分别将改备份数据分发至三个节点</span></span>
<span class="line"><span style="color:#6F42C1;">分别停止etcd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">三个节点</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd</span></span>
<span class="line"><span style="color:#6F42C1;">确认停掉三个节点后依次执行恢复操作</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">node1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">恢复操作</span></span>
<span class="line"><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/etcd/node1.etcd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/etcd/node1.etcd_bak</span></span>
<span class="line"><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/etcd/</span></span>
<span class="line"><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--data-dir=/var/lib/etcd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">snapshot</span><span style="color:#24292E;">  </span><span style="color:#032F62;">restore</span><span style="color:#24292E;">   </span><span style="color:#032F62;">/data/172.24.119.41-snapshot-2019-09-24.db</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node1</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">--initial-cluster</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node1=http://172.25.102.10:2380,node2=http://172.25.102.39:2380,node3=http://172.25.102.17:2380</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">--initial-advertise-peer-urls</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://172.25.102.10:2380</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">node2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">恢复操作</span></span>
<span class="line"><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/etcd/node2.etcd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/etcd/node2.etcd_bak</span></span>
<span class="line"><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/etcd/</span></span>
<span class="line"><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--data-dir=/var/lib/etcd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">snapshot</span><span style="color:#24292E;">  </span><span style="color:#032F62;">restore</span><span style="color:#24292E;">   </span><span style="color:#032F62;">/data/172.24.119.41-snapshot-2019-09-24.db</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node2</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">--initial-cluster</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node1=http://172.25.102.10:2380,node2=http://172.25.102.39:2380,node3=http://172.25.102.17:2380</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">--initial-advertise-peer-urls</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://172.25.102.39:2380</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">node3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">恢复操作</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/etcd/node3.etcd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/etcd/node3.etcd_bak</span></span>
<span class="line"><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/etcd/</span></span>
<span class="line"><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--data-dir=/var/lib/etcd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">snapshot</span><span style="color:#24292E;">  </span><span style="color:#032F62;">restore</span><span style="color:#24292E;">   </span><span style="color:#032F62;">/data/172.24.119.41-snapshot-2019-09-24.db</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node3</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">--initial-cluster</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node1=http://172.25.102.10:2380,node2=http://172.25.102.39:2380,node3=http://172.25.102.17:2380</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">--initial-advertise-peer-urls</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://172.25.102.17:2380</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">node1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">依次启动</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/ad/media</span><span style="color:#24292E;">  </span><span style="color:#032F62;">查看恢复的数据已正常</span></span></code></pre></div><h1 id="_3-备份目录" tabindex="-1">3.备份目录 <a class="header-anchor" href="#_3-备份目录" aria-label="Permalink to &quot;3.备份目录&quot;">​</a></h1><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">#v3.3</span></span>
<span class="line"><span style="color:#e1e4e8;">etcdctl --ca-file=ca.pem --cert-file=etcd.pem --key-file=etcd-key.pem backup --data-dir /var/lib/etcd --backup-dir /tmp/etcd</span></span>
<span class="line"><span style="color:#e1e4e8;"> </span></span>
<span class="line"><span style="color:#e1e4e8;">--data-dir：指明数据目录的位置</span></span>
<span class="line"><span style="color:#e1e4e8;">--backup-dir：指明备份的位置</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">#v3.3</span></span>
<span class="line"><span style="color:#24292e;">etcdctl --ca-file=ca.pem --cert-file=etcd.pem --key-file=etcd-key.pem backup --data-dir /var/lib/etcd --backup-dir /tmp/etcd</span></span>
<span class="line"><span style="color:#24292e;"> </span></span>
<span class="line"><span style="color:#24292e;">--data-dir：指明数据目录的位置</span></span>
<span class="line"><span style="color:#24292e;">--backup-dir：指明备份的位置</span></span></code></pre></div>`,24),t=[p];function e(c,r,y,E,F,d){return a(),n("div",null,t)}const C=s(o,[["render",e]]);export{u as __pageData,C as default};
