import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const b=JSON.parse('{"title":"1. 什么是 CronJob","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/资源对象/7-CronJob.md","filePath":"guide/container/k8s/资源对象/7-CronJob.md","lastUpdated":1723447064000}'),p={name:"guide/container/k8s/资源对象/7-CronJob.md"},o=l(`<ul><li>CronJob用于实现定时任务，像Linux的Crontab一样。 <ul><li>定时任务</li></ul></li><li>应用场景：通知，备份</li></ul><p>官档,<a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/cron-jobs/" target="_blank" rel="noreferrer">https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/cron-jobs/</a></p><h1 id="_1-什么是-cronjob" tabindex="-1">1. 什么是 CronJob <a class="header-anchor" href="#_1-什么是-cronjob" aria-label="Permalink to &quot;1. 什么是 CronJob&quot;">​</a></h1><p>CronJob 控制器用于管理 Job 控制器资源的运行时间，等到设定的时间后就会创建 Job 资源，而 Job 资源被创建后便会立即会创建一个新的 Pod 去执行指定的任务。这里 CronJob 可以说类似于 Linux 操作系统的周期性任务<code>作业计划（Crontab）</code>，其功能如下：</p><ul><li>在未来某时间点运行作业一次</li><li>在指定的时间点重复运行作</li></ul><p>CronJob 对象支持使用的时间格式类似于 <code>Crontab</code> ，略有不同的是 CronJob 控制器在指 定的时间点时，符号<code>&quot;？&quot;</code>和<code>&quot;*&quot;</code>的意义相同，都表示任何可用的有效值。</p><p>在日常中使用 CronJob 常常用作于数据备份、数仓导数、执行任务、邮件发送、数据拉取、数据推送等操作。</p><h1 id="_2-cronjob-资源示例" tabindex="-1">2. CronJob 资源示例 <a class="header-anchor" href="#_2-cronjob-资源示例" aria-label="Permalink to &quot;2. CronJob 资源示例&quot;">​</a></h1><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">batch/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">CronJob</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">hello</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">failedJobsHistoryLimit</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">successfulJobsHistoryLimit</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">schedule</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;*/1 * * * *&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">jobTemplate</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">hello</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">busybox</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">imagePullPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">args</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#9ECBFF;">/bin/sh</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#9ECBFF;">-c</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#9ECBFF;">date; echo Hello from the Kubernetes cluster</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">restartPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">OnFailure</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">batch/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">CronJob</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">hello</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">failedJobsHistoryLimit</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">successfulJobsHistoryLimit</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">schedule</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;*/1 * * * *&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">jobTemplate</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">hello</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">imagePullPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">args</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#032F62;">/bin/sh</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#032F62;">-c</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#032F62;">date; echo Hello from the Kubernetes cluster</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">restartPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">OnFailure</span></span></code></pre></div><p><strong>常用的配置项如下表所示：</strong></p><table><thead><tr><th>参数名称</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>suspend</td><td>false</td><td>是否挂起后续要执行的任务。</td></tr><tr><td>schedule</td><td>-</td><td>定时任务执行规则（使用 Cron 表达式编写表达式）。</td></tr><tr><td>failedJobsHistoryLimit</td><td>1</td><td>保留失败任务（执行任务的 job 与 pod）的数量。</td></tr><tr><td>successfulJobsHistoryLimit</td><td>3</td><td>保留成功任务（执行任务的 job 与 pod）的数量。</td></tr><tr><td>concurrencyPolicy</td><td>Allow</td><td><strong>并发执行策略:</strong> - <strong>Allow：</strong> 允许并发任务执行。 - <strong>Forbid：</strong> 不允许并发任务执行。（如果新任务的执行时间到了而老任务没有执行完，CronJob 会忽略新任务的执行。） - <strong>Replace：</strong> 如果新任务的执行时间到了而老任务没有执行完，用新任务替换当前正在运行的任务。</td></tr><tr><td>startingDeadlineSeconds</td><td>-</td><td>设置任务在多少时间内错误次数达到100后就不再调度。（单位s）</td></tr></tbody></table><h1 id="_3-cronjob-的时区" tabindex="-1">3. CronJob 的时区 <a class="header-anchor" href="#_3-cronjob-的时区" aria-label="Permalink to &quot;3. CronJob 的时区&quot;">​</a></h1><p>CronJob 的 <code>schedule</code> 时间都是基于 <code>kube-controller-manager</code> 的时区。如果你的控制平面在 Pod 或是&quot;裸容器&quot;中运行了 <code>kube-controller-manager</code>，那么为该容器所设置的时区将会决定 <code>CronJob 的控制器</code> 所使用的时区。所以，我们在使用 CronJob 之前一点要确保 <code>kube-controller-manager</code> 组件中的时区是正确的。</p><p>如果我们的时区不对，且 <code>kube-controller-manager</code> 是通过容器化部署的，那么我们可以进入 Master 节点所在服务器，修改里面的 kube-controller-manager.yaml 文件：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">$ vi /etc/kubernetes/manifests/kube-controller-manager.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">$ vi /etc/kubernetes/manifests/kube-controller-manager.yaml</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">...</span><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/ssl/certs</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ca-certs</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">readOnly</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/pki</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etc-pki</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">readOnly</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/usr/libexec/kubernetes/kubelet-plugins/volume/exec</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">flexvolume-dir</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/kubernetes/pki</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">k8s-certs</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">readOnly</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/kubernetes/controller-manager.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubeconfig</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">readOnly</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">localtime</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">## --- volumeMounts 中挂载时区 ---</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/localtime</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">readOnly</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">hostNetwork</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">priorityClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">system-node-critical</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">localtime</span><span style="color:#E1E4E8;">         </span><span style="color:#6A737D;">## --- volumes 中挂载时区 ---</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">hostPath</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/localtime</span></span>
<span class="line"><span style="color:#B392F0;">...</span><span style="color:#79B8FF;">...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">...</span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/ssl/certs</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ca-certs</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">readOnly</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/pki</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etc-pki</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">readOnly</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/usr/libexec/kubernetes/kubelet-plugins/volume/exec</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">flexvolume-dir</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/kubernetes/pki</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">k8s-certs</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">readOnly</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/kubernetes/controller-manager.conf</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubeconfig</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">readOnly</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">localtime</span><span style="color:#24292E;">       </span><span style="color:#6A737D;">## --- volumeMounts 中挂载时区 ---</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/localtime</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">readOnly</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">hostNetwork</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">priorityClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">system-node-critical</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">localtime</span><span style="color:#24292E;">         </span><span style="color:#6A737D;">## --- volumes 中挂载时区 ---</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">hostPath</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/localtime</span></span>
<span class="line"><span style="color:#6F42C1;">...</span><span style="color:#005CC5;">...</span></span></code></pre></div><h1 id="_4-cron-表达式语法" tabindex="-1">4. Cron 表达式语法 <a class="header-anchor" href="#_4-cron-表达式语法" aria-label="Permalink to &quot;4. Cron 表达式语法&quot;">​</a></h1><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># ┌───────────── 分钟 (0 - 59)</span></span>
<span class="line"><span style="color:#6A737D;"># │ ┌───────────── 小时 (0 - 23)</span></span>
<span class="line"><span style="color:#6A737D;"># │ │ ┌───────────── 月的某天 (1 - 31)</span></span>
<span class="line"><span style="color:#6A737D;"># │ │ │ ┌───────────── 月份 (1 - 12)</span></span>
<span class="line"><span style="color:#6A737D;"># │ │ │ │ ┌───────────── 周的某天 (0 - 6) （周日到周一；在某些系统上，7 也是星期日）</span></span>
<span class="line"><span style="color:#6A737D;"># │ │ │ │ │                                   </span></span>
<span class="line"><span style="color:#6A737D;"># │ │ │ │ │</span></span>
<span class="line"><span style="color:#6A737D;"># │ │ │ │ │</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">*</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">*</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># ┌───────────── 分钟 (0 - 59)</span></span>
<span class="line"><span style="color:#6A737D;"># │ ┌───────────── 小时 (0 - 23)</span></span>
<span class="line"><span style="color:#6A737D;"># │ │ ┌───────────── 月的某天 (1 - 31)</span></span>
<span class="line"><span style="color:#6A737D;"># │ │ │ ┌───────────── 月份 (1 - 12)</span></span>
<span class="line"><span style="color:#6A737D;"># │ │ │ │ ┌───────────── 周的某天 (0 - 6) （周日到周一；在某些系统上，7 也是星期日）</span></span>
<span class="line"><span style="color:#6A737D;"># │ │ │ │ │                                   </span></span>
<span class="line"><span style="color:#6A737D;"># │ │ │ │ │</span></span>
<span class="line"><span style="color:#6A737D;"># │ │ │ │ │</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">*</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">*</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">*</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">*</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">*</span></span></code></pre></div><table><thead><tr><th>输入</th><th>描述</th><th>相当于</th></tr></thead><tbody><tr><td>@yearly</td><td>(or @annually) 每年 1 月 1 日的午夜运行一次</td><td>0 0 1 1 *</td></tr><tr><td>@monthly</td><td>每月第一天的午夜运行一次</td><td>0 0 1 * *</td></tr><tr><td>@weekly</td><td>每周的周日午夜运行一次</td><td>0 0 * * 0</td></tr><tr><td>@daily</td><td>(or @midnight) 每天午夜运行一次</td><td>0 0 * * *</td></tr><tr><td>@hourly</td><td>每小时的开始一次</td><td>0 * * * *</td></tr></tbody></table><p>更详细的信息，可以查看 <a href="https://en.wikipedia.org/wiki/Cron#Time_zone_handling" target="_blank" rel="noreferrer">维基百科 Cron 介绍</a>。还可以使用 <a href="https://crontab.guru/" target="_blank" rel="noreferrer">rontab.guru</a>之类的 Web 工具进行 Cron 参数配置。</p><h1 id="_5-cronjob-限制" tabindex="-1">5. CronJob 限制 <a class="header-anchor" href="#_5-cronjob-限制" aria-label="Permalink to &quot;5. CronJob 限制&quot;">​</a></h1><p><strong>CronJob 执行时，可能会重复创建或不创建任务</strong></p><p>CronJob 会根据配置的 Schedule 参数进行执行，每次到达指定的时间后应该会创建一个 Job 来执行任务，之所以说是&quot;应该&quot;，这是因为有些情况可能会创建两个 Job 或者不创建 Job，所以，我们要执行的任务最好是幂等的，以防止重复执行任务这种情况。</p><p><strong>配置 concurrencyPolicy 来保证至少运行一次</strong></p><p>如果在创建 CronJob 时指定了 startingDeadlineSeconds 参数（默认不会配置该参数），并且 concurrencyPolicy 设置为 Allow，则 Cronjob 的 Job 能够至少运行一次。</p><p><strong>CronJob 达到一定错误次数后，将会终止执行</strong></p><p>CronJob 控制器会检查从上一次调度的时间点到现在所错过了调度次数。如果在周期内的调度次数超过 100 次， 那么它就不会启动这个任务，并记录这个错误:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Cannot</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">determine</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">job</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">needs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">started.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Too</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">many</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">missed</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">time</span><span style="color:#E1E4E8;"> (&gt; </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">).</span></span>
<span class="line"><span style="color:#B392F0;">Set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">or</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">decrease</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.spec.startingDeadlineSeconds</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">or</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">check</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clock</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">skew.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Cannot</span><span style="color:#24292E;"> </span><span style="color:#032F62;">determine</span><span style="color:#24292E;"> </span><span style="color:#032F62;">if</span><span style="color:#24292E;"> </span><span style="color:#032F62;">job</span><span style="color:#24292E;"> </span><span style="color:#032F62;">needs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">started.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Too</span><span style="color:#24292E;"> </span><span style="color:#032F62;">many</span><span style="color:#24292E;"> </span><span style="color:#032F62;">missed</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">time</span><span style="color:#24292E;"> (&gt; </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">).</span></span>
<span class="line"><span style="color:#6F42C1;">Set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">or</span><span style="color:#24292E;"> </span><span style="color:#032F62;">decrease</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.spec.startingDeadlineSeconds</span><span style="color:#24292E;"> </span><span style="color:#032F62;">or</span><span style="color:#24292E;"> </span><span style="color:#032F62;">check</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clock</span><span style="color:#24292E;"> </span><span style="color:#032F62;">skew.</span></span></code></pre></div><p>bash</p><p>需要注意的是，如果 CronJob 配置了 startingDeadlineSeconds 参数，则控制器会统计从 startingDeadlineSeconds 设置的值到现在，而不是从上一个计划时间到现在错过了多少次 Job。例如，如果 startingDeadlineSeconds 是 200，则控制器会统计在过去 200 秒中错过了多少次 Job。</p><p>如果未能在调度时间内创建 CronJob，则计为错过。例如，如果 concurrencyPolicy 被设置为 Forbid，并且当前有一个调度仍在运行的情况下， 试图调度的 CronJob 将被计算为错过。</p><p>例如，一个 CronJob 被设置为从 08:30:00 开始每隔一分钟创建一个新的 Job，并且 CronJob 未配置 startingDeadlineSeconds 参数。如果 CronJob 控制器从 08:29:00 到 10:21:00 终止运行，则该 Job 将不会启动，因为其错过的调度次数超过了 100 次。</p><p>为了进一步阐述这个概念，假设将 CronJob 设置为从 08:30:00 开始每隔一分钟创建一个新的 Job， 并将其 startingDeadlineSeconds 字段设置为 200 秒。 如果 CronJob 控制器恰好在与上一个示例相同的时间段（08:29:00 到 10:21:00）终止运行， 则 Job 仍将从 10:22:00 开始。 造成这种情况的原因是控制器现在检查在最近 200 秒（即 3 个错过的调度）中发生了多少次错过的 Job 调度，而不是从现在为止的最后一个调度时间开始。</p><p><strong>CronJob 管理 Job，而 Job 管理执行任务的 Pod</strong></p><p>CronJob 仅负责创建与其调度时间相匹配的 Job，而 Job 又负责管理其代表的 Pod</p><h1 id="_6-cronjob控制机制" tabindex="-1">6. CronJob控制机制 <a class="header-anchor" href="#_6-cronjob控制机制" aria-label="Permalink to &quot;6. CronJob控制机制&quot;">​</a></h1><p>CronJob 控制器是一个更高级别的资源，它以 Job 控制器资源为其管控对象，并借助它管理 Pod 资源的对象。</p><p>如果作业重复执行时指定的时间点较近，而作业执行时长跨过了其两次执行的时间长度，则会出现两个 Job 对象同时存在的情形。</p><p><strong>有些 Job 对象可能会存在无法或不能同时运行情形，这个时候就要通过 cronjob.spec.concruuencyPolicy 属性控制作业并存的机制，其默认值为</strong></p><p><strong>&quot;Allow&quot;，即允许前后 Job，甚至属于同一个 CronJob 的更多 Job 同时运行。其他两个可用值中，</strong></p><p><strong>&quot;Forbid&quot; 用于禁止前后两个 Job 同时运行，如果前一个尚未结束，后一个则不予启动（跳过）。</strong></p><p><strong>&quot;Replcae&quot; 用于让后一个 Job 取代前一个，即终止前一个并启动后一个。</strong></p><h1 id="_7-案例" tabindex="-1">7. 案例 <a class="header-anchor" href="#_7-案例" aria-label="Permalink to &quot;7. 案例&quot;">​</a></h1><p>使用 CronJob 经常做的就是进行数据备份，如下就是一个数据备份的 CronJob 配置示例：</p><ul><li>系统环境： <ul><li>存储 NFS1 地址：192.168.2.11</li><li>存储 NFS2 地址：192.168.2.12</li></ul></li><li>备份要求： <ul><li>时间为每天凌晨四点</li><li>备份 /data/master/ 的数据。</li><li>对备份的数据只保留三天。</li></ul></li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">batch/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">CronJob</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">data-backup</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">devops</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">data-backup</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">schedule</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0 4 * * *</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">concurrencyPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Allow</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">suspend</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">successfulJobsHistoryLimit</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">failedJobsHistoryLimit</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">jobTemplate</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">data</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">nfs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">server</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">192.168.2.11</span><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">#挂入 NFS 存储1</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/data/master/</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">data-backup</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">nfs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">server</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">192.168.2.12</span><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">#挂入 NFS 存储2</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/data/backup/</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">time-zone</span><span style="color:#E1E4E8;">               </span><span style="color:#6A737D;">#挂入宿主机的时区文件</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">hostPath</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/localtime</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">data-backup</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;busybox:1.32.0&#39;</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">#使用 busybox 镜像执行备份操作</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">:                      </span><span style="color:#6A737D;">#配置要执行的备份命令</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#9ECBFF;">sh</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#9ECBFF;">&#39;-c&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">args</span><span style="color:#E1E4E8;">:                                         </span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">                  tar -zcvf /data-backup/xxx-$(date +%Y%m%d).tar.gz /data</span></span>
<span class="line"><span style="color:#9ECBFF;">                  find /data-backup/xxx-* -mtime +2 -delete                  </span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">data</span><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">#应用运行的数据的存储的 NFS 服务器地址</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/data</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">data-backup</span><span style="color:#E1E4E8;">         </span><span style="color:#6A737D;">#存储备份数据的 NFS 服务器地址     </span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/data-backup</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">time-zone</span><span style="color:#E1E4E8;">           </span><span style="color:#6A737D;">#挂载系统时区，防止时区产生的影响</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/localtime</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">terminationMessagePath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/dev/termination-log</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">terminationMessagePolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">File</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">imagePullPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">restartPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Never</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">batch/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">CronJob</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">data-backup</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">devops</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">data-backup</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">schedule</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0 4 * * *</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">concurrencyPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Allow</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">suspend</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">successfulJobsHistoryLimit</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">failedJobsHistoryLimit</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">jobTemplate</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">data</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">nfs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">192.168.2.11</span><span style="color:#24292E;">        </span><span style="color:#6A737D;">#挂入 NFS 存储1</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/data/master/</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">data-backup</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">nfs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">server</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">192.168.2.12</span><span style="color:#24292E;">        </span><span style="color:#6A737D;">#挂入 NFS 存储2</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/data/backup/</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">time-zone</span><span style="color:#24292E;">               </span><span style="color:#6A737D;">#挂入宿主机的时区文件</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">hostPath</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/localtime</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">data-backup</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;busybox:1.32.0&#39;</span><span style="color:#24292E;">       </span><span style="color:#6A737D;">#使用 busybox 镜像执行备份操作</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">command</span><span style="color:#24292E;">:                      </span><span style="color:#6A737D;">#配置要执行的备份命令</span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#032F62;">sh</span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#032F62;">&#39;-c&#39;</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">args</span><span style="color:#24292E;">:                                         </span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">                  tar -zcvf /data-backup/xxx-$(date +%Y%m%d).tar.gz /data</span></span>
<span class="line"><span style="color:#032F62;">                  find /data-backup/xxx-* -mtime +2 -delete                  </span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">data</span><span style="color:#24292E;">                </span><span style="color:#6A737D;">#应用运行的数据的存储的 NFS 服务器地址</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/data</span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">data-backup</span><span style="color:#24292E;">         </span><span style="color:#6A737D;">#存储备份数据的 NFS 服务器地址     </span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/data-backup</span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">time-zone</span><span style="color:#24292E;">           </span><span style="color:#6A737D;">#挂载系统时区，防止时区产生的影响</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/localtime</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">terminationMessagePath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/dev/termination-log</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">terminationMessagePolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">File</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">imagePullPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">restartPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Never</span></span></code></pre></div>`,46),e=[o];function t(c,r,E,y,i,d){return n(),a("div",null,e)}const u=s(p,[["render",t]]);export{b as __pageData,u as default};
