import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const C=JSON.parse('{"title":"1.Service基本概念","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/资源对象/3-service定义.md","filePath":"guide/container/k8s/资源对象/3-service定义.md","lastUpdated":1723797041000}'),p={name:"guide/container/k8s/资源对象/3-service定义.md"},o=l(`<h1 id="_1-service基本概念" tabindex="-1">1.Service基本概念 <a class="header-anchor" href="#_1-service基本概念" aria-label="Permalink to &quot;1.Service基本概念&quot;">​</a></h1><h2 id="_1-1-什么是service" tabindex="-1">1.1 什么是Service <a class="header-anchor" href="#_1-1-什么是service" aria-label="Permalink to &quot;1.1 什么是Service&quot;">​</a></h2><p>在Kubernetes中，pod是应用程序的载体，当我们需要访问这个应用时，可以通过Pod的IP进行访问，但是这里有两个问题：</p><ol><li>Pod的IP地址不固定-旦Pod异常退出、节点故障，则会造成Pod发生重建，一旦发生重建客户端则会访问失败；</li><li>Pod如果扩展多份，会造成客户端无法有效使用新增Pod，如果Pod进行缩容又会造成客户端访问错误；</li></ol><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405161441139.png" alt="image-20240516144050288"></p><p>为了解决这个问题，k8s提供了service资源，<code>Service为动态的一组Pod提供一个固定的访问入口</code>；service资源基于标签选择器把筛选出的一组Pod对象定义成一个逻辑组合，而后Service对外提供自己的IP和端口。</p><p>当客户端请求Service的IP和端口时，Service将请求调度给标签所匹配的所有Pod，Service向客户端隐藏了真实处理请求的Pod资源，使得客户端的请求看上去是由Service直接处理并进行响应。</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405161454391.png" alt="image-20240516145426118"></p><p>Service对象的IP地址（可称为<code>ClusterIP</code>或ServiceIP）是虚拟IP地址，由Kubernetes系统在Service对象创建时在专有网络（ServiceNetwork）地址中自动分配或由用户手动指定。其次Service是基于端口过滤，并根据事先定义好的规则将请求转发至其后端Pod对应的端口上，因此这种代理机制也称为&quot;端口代理&quot;或&quot;四层代理&quot;，工作在TCP/IP协议栈的传输层；</p><h3 id="service的作用" tabindex="-1">Service的作⽤： <a class="header-anchor" href="#service的作用" aria-label="Permalink to &quot;Service的作⽤：&quot;">​</a></h3><p>暴露流量：让用户可以通过ServiceIP+ServicePort访问对应后端的Pod应用；</p><p>负载均衡：提供基于4层的TCP/IP负载均衡，并不提供HTTP/HTTPS等负载均衡</p><p>服务发现：当发现新增Pod则自动加入至Service的后端，如发现Pod异常则自动剔除Service后端；</p><h2 id="_1-2-service工作逻辑" tabindex="-1">1.2 Service⼯作逻辑 <a class="header-anchor" href="#_1-2-service工作逻辑" aria-label="Permalink to &quot;1.2 Service⼯作逻辑&quot;">​</a></h2><p>Service持续监视APIServer，监视Service标签选择器所匹配的后端Pod，并实时跟踪这些Pod对象的变动情况，例如IP地址发生变化、或Pod对象新增与减少。</p><p>不过Service并不直接与Pod建立关联关系，它们之间还有一个中间层<code>Endpoints</code>，Endpoints对象是一个由IP地址和端口组成的列表，这些IP地址和端口则来自于Service标签选择器所匹配到的Pod，默认情况下，创建Service资源时，其关联的<code>Endpoints</code>对象会被自动创建。</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405161528640.png" alt="image-20240516152847044"></p><h2 id="_1-3-service具体实现" tabindex="-1">1.3 Service具体实现 <a class="header-anchor" href="#_1-3-service具体实现" aria-label="Permalink to &quot;1.3 Service具体实现&quot;">​</a></h2><p>在Kubernetes中，Service只是抽象的一个概念，真正起作用实现负载均衡规则的其实是Kube-Proxy这个进程。它在每个节点上都需要运行一个Kube-Proxy，用来完成负载均衡规则的创建。</p><p>1、创建Service资源后，会分配一个随机的ServiceIP，返回给用户，然后写入etcd;</p><p>2、ndpoints controller负责生成和维护所有endpoints，它会监听Service和pod的状态，当pod 处于running 且准备就绪时，endpoints controller会将 pod ip 更新到对应Service的 endpoints 对象中，然后写⼊Etcd；</p><p>3、be-proxy通过API-Server监听Service、Endpoints的资源变动，一旦Service或Endpoints资源发生变化，Kube-Proxy会将最新的信息转换为对应的IptabLes、IPVS访问规则，而后在本地主机上执行。</p><p>4、客户端想要访问Service的时候，其实访问的就是本地节点上的iptabLes、IPVS规则，由它们路由到对应节点;</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405161536151.png" alt="image-20240516153355138"></p><p>实现图上的功能，主要需要以下⼏个组件协同⼯作：</p><p>1、Service：用户通过kubectl命令向apiServer发送创建Service的请求，APIServer收到后存入Etcd;</p><p>2、Endpoints：获取Service所匹配的Pod地址，而后将信息写入与Service同名的endpoints资源中;</p><p>3、Kube-Proxy：获取Service和Endpoints资源的变动，而后生成IptabLeS、IPVS规则，在本机执行;</p><p>4、ptabLes：当用户请求serviceIP时，使用iptabLes的DNAT技术将ServiceIP的请求调度至endpoint保存ip列表；</p><h1 id="_2-kube-proxy代理模型" tabindex="-1">2.Kube-Proxy代理模型 <a class="header-anchor" href="#_2-kube-proxy代理模型" aria-label="Permalink to &quot;2.Kube-Proxy代理模型&quot;">​</a></h1><h2 id="_2-1-userspace" tabindex="-1">2.1 userSpace <a class="header-anchor" href="#_2-1-userspace" aria-label="Permalink to &quot;2.1 userSpace&quot;">​</a></h2><p>userspace模式下，kube-proxy为ServiceIP创建⼀个监听端⼝，当⽤户向ServiceIP发送请求，</p><p>1、首先请求会被IptabLes规则拦截，然后重定向到Kube-Proxy对应的端口；</p><p>2、然后Kube-Proxy根据调度算法选择挑选一个Pod，将请求调度到该Pod上;</p><p>总结：Pod请求ServiceIP时，会被Iptables将请求拦截给⽤户空间的Kube-Proxy，然后再经过内核空间路由到对应的Pod；</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405161700263.png" alt="image-20240516170001208"></p><p>问题：该模式流量经过内核空间后，，会送往用户空间Kube-Proxy进程而后又送回内核空间，发往调度分配的目标后端Pod；</p><h2 id="_2-2-iptables" tabindex="-1">2.2 iptables <a class="header-anchor" href="#_2-2-iptables" aria-label="Permalink to &quot;2.2 iptables&quot;">​</a></h2><p>iptables模式下，kube-proxy为Service后端的所有Pod创建对应的iptabLes规则，当用户向ServiceIP发送请求;</p><p>1、首先Iptables会拦截用户请求</p><p>2、然后直接将请求调度到后端的Pod;</p><p>总结：Pod请求ServiceIP时，IptabLes将请求拦截并且直接完成调度，然后路由到对应的Pod，所以效率比userspace高;</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405161702779.png" alt="image-20240516170212518"></p><p>问题：⼀个Service会创建出⼤量的规则，且不⽀持更⾼级的调度算法，当Pod不可⽤也⽆法重试；</p><h2 id="_2-3-ipvs" tabindex="-1">2.3 IPVS <a class="header-anchor" href="#_2-3-ipvs" aria-label="Permalink to &quot;2.3 IPVS&quot;">​</a></h2><p>ipvs模式和iptables类似，kube-proxy为Service后端所有的Pod创建对应的IPVS规则，一个Service只会生成一条规则，所以规模较大的场景下，应该使用IPVS模式。其次IPVS更多更高级的调度算法。</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405161705319.png" alt="image-20240516170352058"></p><h1 id="_3-service资源类型" tabindex="-1">3.Service资源类型 <a class="header-anchor" href="#_3-service资源类型" aria-label="Permalink to &quot;3.Service资源类型&quot;">​</a></h1><p>无论使用那一种代理模型，Service资源都可以其工作逻辑分为ClusterIP，NodePort，LoadBalance、ExternaLName、HostPort这5种类型</p><h2 id="_3-0-hostport" tabindex="-1">3.0 HostPort <a class="header-anchor" href="#_3-0-hostport" aria-label="Permalink to &quot;3.0 HostPort&quot;">​</a></h2><p>在 Kubernetes 中，hostPort 是一种用于将主机上的特定端口映射到运行在 Pod 内部容器的端口的配置选项。通过使用 hostPort，你可以在主机上暴露容器的服务，从而允许<strong>外部网络通过主机的 IP 地址和指定的端口访问容器内的应用程序</strong>,<code>不推荐使用</code></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202407050938734.png" alt="img"></p><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>hostPort 与 NodePort 的区别是，NodePort 服务默认是把请求转发到随机的一个运行的 Pod 上，而 hostPort 是直接转发到本 Node 上的指定 Pod</p><p>一个 Node 只能启动一个 hostPort</p></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-v1-deployment</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-v1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-v1</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">hostPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9000</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-v1-deployment</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-v1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-v1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">hostPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9000</span></span></code></pre></div><h2 id="_3-1-clusterip" tabindex="-1">3.1 ClusterIP <a class="header-anchor" href="#_3-1-clusterip" aria-label="Permalink to &quot;3.1 ClusterIP&quot;">​</a></h2><p>ClusterIP：通过集群的内部 IP 暴露服务，选择ServiceIP只能够在集群内部访问。 这也是默认的 ServiceType。</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405161741166.png" alt="image-20240516174101713"></p><h2 id="_3-2-nodeport" tabindex="-1">3.2 NodePort <a class="header-anchor" href="#_3-2-nodeport" aria-label="Permalink to &quot;3.2 NodePort&quot;">​</a></h2><p>NodePort：NodePort类型是对ClusterIP类型Service资源的扩展。它通过每个节点上的IP和端⼝接⼊集群外部流量，并分发给后端的Pod处理和响应。因此通过&lt;节点IP&gt;:&lt;节点端⼝&gt;，可以从集群外部访问服务。</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405161743644.png" alt="image-20240516174258879"></p><h2 id="_3-3-loadbalance" tabindex="-1">3.3 LoadBalance <a class="header-anchor" href="#_3-3-loadbalance" aria-label="Permalink to &quot;3.3 LoadBalance&quot;">​</a></h2><p>LoadBalancer：这类Service依赖云厂商，需要通过云厂商调用API接口创建软件负载均衡将服务暴露到集群外部。当创建LoadBalance类型的Service对象时，它会在集群上自动创建一个NodePort类型的Service。集群外部的请求流量会先路由至该负载均衡，并由该负载均衡调度至各个节点的NodePort。</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405161746141.png" alt="image-20240516174454855"></p><h2 id="_3-4-externalname" tabindex="-1">3.4 ExternalName <a class="header-anchor" href="#_3-4-externalname" aria-label="Permalink to &quot;3.4 ExternalName&quot;">​</a></h2><p>ExternalName：此类型不是用来定义如何访问集群内服务的，而是把集群外部的某些服务以<code>DNS CANME</code>方式映射到集群内，从而让集群内的Pod资源能够访问外部服务的一种实现方式。</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405161752747.png" alt="image-20240516174823306"></p><h1 id="_4-service应用实践" tabindex="-1">4.Service应⽤实践 <a class="header-anchor" href="#_4-service应用实践" aria-label="Permalink to &quot;4.Service应⽤实践&quot;">​</a></h1><h2 id="_4-1-service资源规范" tabindex="-1">4.1 Service资源规范 <a class="header-anchor" href="#_4-1-service资源规范" aria-label="Permalink to &quot;4.1 Service资源规范&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;"># API的版本</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># 资源类型定义为Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:           </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">...</span><span style="color:#E1E4E8;">          </span><span style="color:#6A737D;"># Serivce的名称</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">...</span><span style="color:#E1E4E8;">     </span><span style="color:#6A737D;"># 默认的default</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#85E89D;">key1</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">value1</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;"># 标签 key:value格式；</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#85E89D;">key2</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">value2</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">type &lt;string&gt;</span><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># Service类型，默认为ClusterIP；</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">selector &lt;map[string]string&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#  标签选择器</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:                       </span><span style="color:#6A737D;">#  ClusterIP:ServicePort</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&lt;string&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#后端目标进程的端口号或名称。</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">nodePort</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&lt;integer&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 节点端口号，仅适用于NodePort和loadbalancer类型。  &quot;建议动态选择30000-32767&quot; </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clusterIP &lt;string&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># Service的集群IP，建议由系统自动分配</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">externalTrafficPolicy &lt;string&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 外部流量策略处理方式，local表示由当前节点处理，cluster表示向集群范围调度</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">loadBalancerIP &lt;string&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 外部负载均衡器使用的IP地址，仅适用于loadbalancer,前提是你的公有云得支持你自己指定;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">externalName &lt;string&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 外部服务名称，该名称作为Service的DNS CNAME值</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span><span style="color:#24292E;">       </span><span style="color:#6A737D;"># API的版本</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 资源类型定义为Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:           </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">...</span><span style="color:#24292E;">          </span><span style="color:#6A737D;"># Serivce的名称</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">...</span><span style="color:#24292E;">     </span><span style="color:#6A737D;"># 默认的default</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#22863A;">key1</span><span style="color:#24292E;">: </span><span style="color:#032F62;">value1</span><span style="color:#24292E;">   </span><span style="color:#6A737D;"># 标签 key:value格式；</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#22863A;">key2</span><span style="color:#24292E;">: </span><span style="color:#032F62;">value2</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">type &lt;string&gt;</span><span style="color:#24292E;">      </span><span style="color:#6A737D;"># Service类型，默认为ClusterIP；</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">selector &lt;map[string]string&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#  标签选择器</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:                       </span><span style="color:#6A737D;">#  ClusterIP:ServicePort</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&lt;string&gt;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">#后端目标进程的端口号或名称。</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">nodePort</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&lt;integer&gt;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 节点端口号，仅适用于NodePort和loadbalancer类型。  &quot;建议动态选择30000-32767&quot; </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#032F62;">clusterIP &lt;string&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># Service的集群IP，建议由系统自动分配</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#032F62;">externalTrafficPolicy &lt;string&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 外部流量策略处理方式，local表示由当前节点处理，cluster表示向集群范围调度</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#032F62;">loadBalancerIP &lt;string&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 外部负载均衡器使用的IP地址，仅适用于loadbalancer,前提是你的公有云得支持你自己指定;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#032F62;">externalName &lt;string&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 外部服务名称，该名称作为Service的DNS CNAME值</span></span></code></pre></div><h2 id="_4-2-clusterip示例" tabindex="-1">4.2 ClusterIP示例 <a class="header-anchor" href="#_4-2-clusterip示例" aria-label="Permalink to &quot;4.2 ClusterIP示例&quot;">​</a></h2><p>ClusterIP: 通过集群内部IP暴露服务，选择ServiceIP只能够在集群内部访问，这也是默认的Service类型；该地址仅在集群内部可见、可达。无法被集群外部客户端访问；而且是默认类型，创建的任何Service默认就是ClusterIP类型，而且只能接受集群内部客户端的访问</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">cat services-clusterip-nginx.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-clusterip</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">default</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx:alpine</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">imagePullPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">IfNotPresent</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-svc</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">default</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">clusterIP</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:     </span><span style="color:#6A737D;"># 标签选择器 </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 端口名称</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;"># 协议类型，目前支持TCP、UDP、SCTP默认为TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;"># Service的端口号</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 后端目标进程的端口号</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#9ECBFF;">kubectl apply -f services-clusterip-nginx.yaml</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#9ECBFF;">pod/nginx-clusterip created</span></span>
<span class="line"><span style="color:#9ECBFF;">service/nginx-svc created</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">cat services-clusterip-nginx.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-clusterip</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">default</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:alpine</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">imagePullPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">IfNotPresent</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-svc</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">default</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">clusterIP</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:     </span><span style="color:#6A737D;"># 标签选择器 </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 端口名称</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span><span style="color:#24292E;">   </span><span style="color:#6A737D;"># 协议类型，目前支持TCP、UDP、SCTP默认为TCP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">   </span><span style="color:#6A737D;"># Service的端口号</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 后端目标进程的端口号</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#032F62;">kubectl apply -f services-clusterip-nginx.yaml</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#032F62;">pod/nginx-clusterip created</span></span>
<span class="line"><span style="color:#032F62;">service/nginx-svc created</span></span></code></pre></div><h2 id="_4-3-nodeport示例" tabindex="-1">4.3 NodePort示例 <a class="header-anchor" href="#_4-3-nodeport示例" aria-label="Permalink to &quot;4.3 NodePort示例&quot;">​</a></h2><p>NodePort即是节点Port，通常在安装集群系统会预留一个端口范围用于NodePort,默认是3000-32767之间，与ClusterIP类型的可省略.spec.type属性所不同的是，定义NodePort类似的Service资源时，需要通过此属性明确指定其类型名称</p><ul><li>NodePort：在每个节点上启用一个端口来暴露服务，可以在集群 <ul><li>外部访问。也会分配一个稳定内部集群IP地址。</li><li>访问地址：&lt;任意NodeIP&gt;:</li><li>端口范围：30000-32767</li></ul></li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">cat services-nodeport-nginx.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-nodeport-svc</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">default</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NodePort</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">clusterIP</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 指定关联Pod的标签</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;"># Service端口</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 容器端口 # 后端Pod监听什么端口就写什么端口。要不然到达Service的请求转发给Pod，Pod没有那个端口也没用。一定真正转发到后端程序监听的端口。如果没有特殊情况的话，ServicePort和TargetPort保持一致。NodePort可以不用指定。</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nodePort</span><span style="color:#E1E4E8;">:        </span><span style="color:#6A737D;"># 正常情况下应由系统自己分配，除非事先能够明确知道它不会与某个现存的Service资源产生冲突，没有特别需求，留给系统自动配置总是好的选择。</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#kubectl apply -f services-nodeport-nginx.yaml </span></span>
<span class="line"><span style="color:#9ECBFF;">service/nginx-nodeport-svc created</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">cat services-nodeport-nginx.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-nodeport-svc</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">default</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NodePort</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">clusterIP</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 指定关联Pod的标签</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">		</span><span style="color:#6A737D;"># Service端口</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 容器端口 # 后端Pod监听什么端口就写什么端口。要不然到达Service的请求转发给Pod，Pod没有那个端口也没用。一定真正转发到后端程序监听的端口。如果没有特殊情况的话，ServicePort和TargetPort保持一致。NodePort可以不用指定。</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nodePort</span><span style="color:#24292E;">:        </span><span style="color:#6A737D;"># 正常情况下应由系统自己分配，除非事先能够明确知道它不会与某个现存的Service资源产生冲突，没有特别需求，留给系统自动配置总是好的选择。</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#kubectl apply -f services-nodeport-nginx.yaml </span></span>
<span class="line"><span style="color:#032F62;">service/nginx-nodeport-svc created</span></span></code></pre></div><p>示例图片:</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408071053886.png" alt="image"></p><h4 id="完整案例" tabindex="-1">完整案例 <a class="header-anchor" href="#完整案例" aria-label="Permalink to &quot;完整案例&quot;">​</a></h4><p>1.创建yaml文件</p><p>vim web.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">default</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:       </span><span style="color:#6A737D;"># 记录回滚参数</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">kubernetes.io/change-cause</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;web.v1-nginx-1.16&quot;</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">#记录到revision中的内容，记录版本号</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># Pod副本预期数量</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">revisionHistoryLimit</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># RS历史版本保存数量</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">strategy</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">rollingUpdate</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">maxSurge</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">25%</span><span style="color:#E1E4E8;">             </span><span style="color:#6A737D;"># 滚动更新过程最大pod副本数</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">maxUnavailable</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">25%</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;"># 滚动更新过程中最大不可用pod副本数，</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">RollingUpdate</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># Pod副本的标签</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx:1.16</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">readinessProbe</span><span style="color:#E1E4E8;">:          </span><span style="color:#6A737D;"># 存活检查,如果失败，将杀死容器，来重启</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">httpGet</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/index.html</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">initialDelaySeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#启动容器后多少秒健康检查</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">periodSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#以后间隔多少秒检查一次</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">livenessProbe</span><span style="color:#E1E4E8;">:   </span><span style="color:#6A737D;"># 就绪检查，失败就会剔除 service </span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">httpGet</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/index.html</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">web</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">default</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:       </span><span style="color:#6A737D;"># 记录回滚参数</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kubernetes.io/change-cause</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;web.v1-nginx-1.16&quot;</span><span style="color:#24292E;">   </span><span style="color:#6A737D;">#记录到revision中的内容，记录版本号</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># Pod副本预期数量</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">revisionHistoryLimit</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># RS历史版本保存数量</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">web</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">strategy</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">rollingUpdate</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">maxSurge</span><span style="color:#24292E;">: </span><span style="color:#032F62;">25%</span><span style="color:#24292E;">             </span><span style="color:#6A737D;"># 滚动更新过程最大pod副本数</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">maxUnavailable</span><span style="color:#24292E;">: </span><span style="color:#032F62;">25%</span><span style="color:#24292E;">       </span><span style="color:#6A737D;"># 滚动更新过程中最大不可用pod副本数，</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RollingUpdate</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">web</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># Pod副本的标签</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">web</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.16</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">readinessProbe</span><span style="color:#24292E;">:          </span><span style="color:#6A737D;"># 存活检查,如果失败，将杀死容器，来重启</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">httpGet</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/index.html</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">initialDelaySeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#启动容器后多少秒健康检查</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">periodSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#以后间隔多少秒检查一次</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">livenessProbe</span><span style="color:#24292E;">:   </span><span style="color:#6A737D;"># 就绪检查，失败就会剔除 service </span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">httpGet</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/index.html</span></span></code></pre></div><p>2.创建servcie文件</p><p>cat web-NodePort.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NodePort</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 服务类型</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># Service端口</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 协议</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 容器端口</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nodePort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">30009</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 对外暴露的端口，可以指定</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 指定关联Pod的标签</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">web</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">web</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NodePort</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 服务类型</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># Service端口</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 协议</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 容器端口</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nodePort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">30009</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 对外暴露的端口，可以指定</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">web</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 指定关联Pod的标签</span></span></code></pre></div><h2 id="_4-4-loadbalancer示例" tabindex="-1">4.4 LoadBalancer示例 <a class="header-anchor" href="#_4-4-loadbalancer示例" aria-label="Permalink to &quot;4.4 LoadBalancer示例&quot;">​</a></h2><p>LoadBalancer: 这类Service依赖云厂商，需要通过云厂商调用API接口创建软件负载均衡将服务暴露到集群外部，当创建LoadBalancer类型的Service对象时，它会在集群上自动创建一个NodePort类型的Service，集群外部的请求流量会先路由至该负载均衡，并由该负载均衡调度至各个节点的NodePort；</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">cat  services-loadbalancer-nginx.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-loadbalancer-svc</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">default</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">LoadBalancer</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">loadBalancerIP</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1.2.3.4</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">cat  services-loadbalancer-nginx.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-loadbalancer-svc</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">default</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">LoadBalancer</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">loadBalancerIP</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1.2.3.4</span></span></code></pre></div><h1 id="_5-service与endpoint" tabindex="-1">5.Service与Endpoint <a class="header-anchor" href="#_5-service与endpoint" aria-label="Permalink to &quot;5.Service与Endpoint&quot;">​</a></h1><h2 id="_5-0-什么是endpoint" tabindex="-1">5.0 什么是Endpoint <a class="header-anchor" href="#_5-0-什么是endpoint" aria-label="Permalink to &quot;5.0 什么是Endpoint&quot;">​</a></h2><ol><li><p>我们创建Service的时候会自动给我们创建一个同名的Endpoint资源,每一个同名的 Servie都有一个Endpoints资源，因为Service自己并不直接匹配后端Pod的标签，而是由Endpoint匹配的。这个匹配过程是由Endpoint控制器来完成的。Endpoint是由Endpoint控制器来控制的；</p></li><li><p>事实上我们Service不但能够把标签选择器选中的Pod识别为自己的后端端点。还能够对后端端点做&quot;就绪状态检测&quot;。如果后端的Pod是就绪的，就把它加到后端可用端点列表中来。否则就会移除掉。这个功能其实不是Service来做的，而是Service借助一个中间的组件。这个中间组件也是一个&quot;标准的资源类型&quot;。就叫做&quot;Endpoint&quot;；</p></li><li><p>Service通过Selector和Pod建立关联，K8s会根据Service关联到的PodIP信息组合成一个Endpoint，若Service定义中没有Selector字段，Service被创建时，Endpoint Controller不会自动创建Endpoint；</p></li><li><p>我们可以通过配置清单创建Service，而无需使用标签选择器，而后自行创建一个同名的Endpoint对象，指定对应的IP，这种一般用于将外部Mysql\\Redis等应用引入kubernetes集群内部，让内部通过Service的方式访问外部资源；</p><p>官方文档: <a href="https://kubernetes.io/zh-cn/docs/reference/kubernetes-api/service-resources/endpoints-v1/#Endpoints" target="_blank" rel="noreferrer">https://kubernetes.io/zh-cn/docs/reference/kubernetes-api/service-resources/endpoints-v1/#Endpoints</a></p></li></ol><h2 id="_5-1-endpoint与容器探针" tabindex="-1">5.1 Endpoint与容器探针 <a class="header-anchor" href="#_5-1-endpoint与容器探针" aria-label="Permalink to &quot;5.1 Endpoint与容器探针&quot;">​</a></h2><p>Service对象借助Endpoint资源来跟踪其关联的后端端点，Endpoint对象会根据Service标签选择器筛选出的后端端点的IP地址分别保存在<code>subsets.address</code>字段和<code>subsets.notReadyAddress</code>字段中，它通过APIServer持续、动态跟踪每个端点的状态变化，并及时反应到端点IP所属的字段中。</p><ul><li>subsets.address：保存就绪的容器IP，也就意味着service可以直接将请求调度至该地址段。</li><li>subsets.notReadyAddress：保存未就绪容器IP，也就意味着Service不会将请求调度至该地址段。</li></ul><h3 id="案例" tabindex="-1">案例 <a class="header-anchor" href="#案例" aria-label="Permalink to &quot;案例&quot;">​</a></h3><p>1.创建⼀个资源清单，会⾃动创建出同名的Endpoints对象</p><p>vi demoapp-readiness.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demoapp2</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web-readiness</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web-readiness</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demoapp2</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">readinessProbe</span><span style="color:#E1E4E8;">:			</span><span style="color:#6A737D;"># 就绪探针</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">httpGet</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;/readyz&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">initialDelaySeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># 初次检测延时时⻓</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">periodSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">			</span><span style="color:#6A737D;"># 检测周期</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demoapp-readiness-service</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">web-readiness</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8888</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demoapp2</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">web-readiness</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">web-readiness</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demoapp2</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">readinessProbe</span><span style="color:#24292E;">:			</span><span style="color:#6A737D;"># 就绪探针</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">httpGet</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;/readyz&#39;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">initialDelaySeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">15</span><span style="color:#24292E;">	</span><span style="color:#6A737D;"># 初次检测延时时⻓</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">periodSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">			</span><span style="color:#6A737D;"># 检测周期</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demoapp-readiness-service</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">web-readiness</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8888</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><p>2.容器初次启动延迟15s，也就意味着⾄少15s以后才能转为就绪状态，对外提供服务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master endpoint]# kubectl get ep demoapp-readiness-service -w</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">ENDPOINTS</span><span style="color:#E1E4E8;">                           </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">demoapp-readiness-service</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.23</span><span style="color:#9ECBFF;">.127.120:80,172.30.0.179:80</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">m55s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master endpoint]# kubectl get ep demoapp-readiness-service -w</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                        </span><span style="color:#032F62;">ENDPOINTS</span><span style="color:#24292E;">                           </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">demoapp-readiness-service</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.23</span><span style="color:#032F62;">.127.120:80,172.30.0.179:80</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m55s</span></span></code></pre></div><p>3.因任何原因导致后端的端点就绪状态监测失败，都会触发Endpoint对象将该端点的IP地址从subset.address字段移至subsets.notReadyAddress字段.</p><ul><li>模拟⼀个Pod故障</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master endpoint]# curl -s -X POST -d </span><span style="color:#9ECBFF;">&#39;readyz=Err&#39;</span><span style="color:#E1E4E8;">  172.23.127.120/readyz</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># ⼤约等待30s之后在检查endpoints资源</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master endpoint]# kubectl get ep demoapp-readiness-service -w</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">ENDPOINTS</span><span style="color:#E1E4E8;">                           </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">demoapp-readiness-service</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.23</span><span style="color:#9ECBFF;">.127.120:80,172.30.0.179:80</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">m19s</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">demoapp-readiness-service</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.30</span><span style="color:#9ECBFF;">.0.179:80</span><span style="color:#E1E4E8;">                     </span><span style="color:#79B8FF;">6</span><span style="color:#9ECBFF;">m20s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master endpoint]# kubectl describe endpoints demoapp-readiness-service</span></span>
<span class="line"><span style="color:#B392F0;">Name:</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">demoapp-readiness-service</span></span>
<span class="line"><span style="color:#B392F0;">Namespace:</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">default</span></span>
<span class="line"><span style="color:#B392F0;">Labels:</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">Annotations:</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">endpoints.kubernetes.io/last-change-trigger-time:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2024</span><span style="color:#9ECBFF;">-05-16T10:12:08Z</span></span>
<span class="line"><span style="color:#B392F0;">Subsets:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Addresses:</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">172.30</span><span style="color:#9ECBFF;">.0.179</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NotReadyAddresses:</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">172.23</span><span style="color:#9ECBFF;">.127.120</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;"># 故障Pod的IP会转⼊NotReadyAddress</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Ports:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Name</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Port</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Protocol</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">----</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">----</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--------</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#79B8FF;">unset</span><span style="color:#E1E4E8;">&gt;  </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Events:</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master endpoint]# curl -s -X POST -d </span><span style="color:#032F62;">&#39;readyz=Err&#39;</span><span style="color:#24292E;">  172.23.127.120/readyz</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># ⼤约等待30s之后在检查endpoints资源</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master endpoint]# kubectl get ep demoapp-readiness-service -w</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                        </span><span style="color:#032F62;">ENDPOINTS</span><span style="color:#24292E;">                           </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">demoapp-readiness-service</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.23</span><span style="color:#032F62;">.127.120:80,172.30.0.179:80</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">m19s</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">demoapp-readiness-service</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.30</span><span style="color:#032F62;">.0.179:80</span><span style="color:#24292E;">                     </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">m20s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master endpoint]# kubectl describe endpoints demoapp-readiness-service</span></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">         </span><span style="color:#032F62;">demoapp-readiness-service</span></span>
<span class="line"><span style="color:#6F42C1;">Namespace:</span><span style="color:#24292E;">    </span><span style="color:#032F62;">default</span></span>
<span class="line"><span style="color:#6F42C1;">Labels:</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Annotations:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">endpoints.kubernetes.io/last-change-trigger-time:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2024</span><span style="color:#032F62;">-05-16T10:12:08Z</span></span>
<span class="line"><span style="color:#6F42C1;">Subsets:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Addresses:</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">172.30</span><span style="color:#032F62;">.0.179</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NotReadyAddresses:</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">172.23</span><span style="color:#032F62;">.127.120</span><span style="color:#24292E;">   </span><span style="color:#6A737D;"># 故障Pod的IP会转⼊NotReadyAddress</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Ports:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Name</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Port</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Protocol</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">----</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">----</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">--------</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#005CC5;">unset</span><span style="color:#24292E;">&gt;  </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">    </span><span style="color:#032F62;">TCP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Events:</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><p>4.将故障端点重新转为就绪状态后，Endpoints对象会将其移回subsets.address字段，这种处理机制确保了Service对象不会将客户端请求流量调度给那些处于<code>运行状态但服务未就绪</code>的端点。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 恢复故障</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-s</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-X</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">POST</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;readyz=OK&#39;</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">172.23</span><span style="color:#9ECBFF;">.127.120/readyz</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 恢复故障</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-s</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">POST</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;readyz=OK&#39;</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">172.23</span><span style="color:#032F62;">.127.120/readyz</span></span></code></pre></div><h2 id="_5-2-自定义endpoint实践" tabindex="-1">5.2 ⾃定义endpoint实践 <a class="header-anchor" href="#_5-2-自定义endpoint实践" aria-label="Permalink to &quot;5.2 ⾃定义endpoint实践&quot;">​</a></h2><p>service通过selector和pod建立关联，k8s会根据service关联到的podIP信息组合成一个endpoint。若service定义中没有seLector字段，service被创建时，endpoint controller不会自动创建endpoint.</p><p>我们可以通过配置清单创建Service，而无需使用标签选择器，而后自行创建一个同名的endpoint对象，指定对应的IP。这种一般用于将外部MySQL\\Redis等应用引l入Kubernetes集群内部，让内部通过Service的方式访问外部资源。</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405171032974.png" alt="image-20240517103219305"></p><h3 id="案例-1" tabindex="-1">案例 <a class="header-anchor" href="#案例-1" aria-label="Permalink to &quot;案例&quot;">​</a></h3><p>1.准备外部MySQL服务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#安装</span></span>
<span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mariadb</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mariadb-server</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#关闭firewalld</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stop</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">firewalld.service</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">disable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">firewalld.service</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#创建远程用户</span></span>
<span class="line"><span style="color:#B392F0;">MariaDB</span><span style="color:#E1E4E8;"> [(none)]</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> grant all privileges on </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> to </span><span style="color:#9ECBFF;">&#39;han&#39;</span><span style="color:#E1E4E8;"> identified by </span><span style="color:#9ECBFF;">&#39;han123456&#39;</span><span style="color:#E1E4E8;"> ;</span></span>
<span class="line"><span style="color:#B392F0;">Query</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">OK,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rows</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">affected</span><span style="color:#E1E4E8;"> (0.000 </span><span style="color:#9ECBFF;">sec</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">MariaDB</span><span style="color:#E1E4E8;"> [(none)]</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> flush privileges;</span></span>
<span class="line"><span style="color:#B392F0;">Query</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">OK,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rows</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">affected</span><span style="color:#E1E4E8;"> (0.000 </span><span style="color:#9ECBFF;">sec</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">MariaDB</span><span style="color:#E1E4E8;"> [(none)]</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> exit</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#安装</span></span>
<span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mariadb</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mariadb-server</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#关闭firewalld</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop</span><span style="color:#24292E;"> </span><span style="color:#032F62;">firewalld.service</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">disable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">firewalld.service</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#创建远程用户</span></span>
<span class="line"><span style="color:#6F42C1;">MariaDB</span><span style="color:#24292E;"> [(none)]</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> grant all privileges on </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> to </span><span style="color:#032F62;">&#39;han&#39;</span><span style="color:#24292E;"> identified by </span><span style="color:#032F62;">&#39;han123456&#39;</span><span style="color:#24292E;"> ;</span></span>
<span class="line"><span style="color:#6F42C1;">Query</span><span style="color:#24292E;"> </span><span style="color:#032F62;">OK,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rows</span><span style="color:#24292E;"> </span><span style="color:#032F62;">affected</span><span style="color:#24292E;"> (0.000 </span><span style="color:#032F62;">sec</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">MariaDB</span><span style="color:#24292E;"> [(none)]</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> flush privileges;</span></span>
<span class="line"><span style="color:#6F42C1;">Query</span><span style="color:#24292E;"> </span><span style="color:#032F62;">OK,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rows</span><span style="color:#24292E;"> </span><span style="color:#032F62;">affected</span><span style="color:#24292E;"> (0.000 </span><span style="color:#032F62;">sec</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">MariaDB</span><span style="color:#24292E;"> [(none)]</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> exit</span></span></code></pre></div><p>2.创建Endpoints资源清单</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master endpoint</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat mysql-external-endpoint.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Endpoints</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">mysql-external</span></span>
<span class="line"><span style="color:#85E89D;">subsets</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">addresses</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">ip</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10.103.236.199</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 外部宿主机ip，如果有多个ip，继续写 - ip</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3306</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 外部MySQL运⾏的端⼝</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master endpoint</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat mysql-external-endpoint.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Endpoints</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">mysql-external</span></span>
<span class="line"><span style="color:#22863A;">subsets</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">addresses</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">ip</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10.103.236.199</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 外部宿主机ip，如果有多个ip，继续写 - ip</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3306</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 外部MySQL运⾏的端⼝</span></span></code></pre></div><ul><li>检查endpoints</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master endpoint]# kubectl get endpoints mysql-external</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">             </span><span style="color:#9ECBFF;">ENDPOINTS</span><span style="color:#E1E4E8;">             </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">mysql-external</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.103</span><span style="color:#9ECBFF;">.236.199:3306</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">63</span><span style="color:#9ECBFF;">m</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master endpoint]# kubectl get endpoints mysql-external</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">             </span><span style="color:#032F62;">ENDPOINTS</span><span style="color:#24292E;">             </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">mysql-external</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.103</span><span style="color:#032F62;">.236.199:3306</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">63</span><span style="color:#032F62;">m</span></span></code></pre></div><p>3.创建与endpoint同名的Service资源清单</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master endpoint</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat mysql-external-service.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">mysql-external</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterIP</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">13306</span><span style="color:#E1E4E8;">			</span><span style="color:#6A737D;"># 访问Service的端⼝</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3306</span><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># 后端应⽤的端⼝</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master endpoint</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat mysql-external-service.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">mysql-external</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">13306</span><span style="color:#24292E;">			</span><span style="color:#6A737D;"># 访问Service的端⼝</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3306</span><span style="color:#24292E;">	</span><span style="color:#6A737D;"># 后端应⽤的端⼝</span></span></code></pre></div><ul><li>检查Service</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master endpoint]# kubectl describe endpoints mysql-external</span></span>
<span class="line"><span style="color:#B392F0;">Name:</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">mysql-external</span></span>
<span class="line"><span style="color:#B392F0;">Namespace:</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">default</span></span>
<span class="line"><span style="color:#B392F0;">Labels:</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">Annotations:</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">Subsets:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Addresses:</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">10.103</span><span style="color:#9ECBFF;">.236.199</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">NotReadyAddresses:</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Ports:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Name</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Port</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Protocol</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">----</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">----</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--------</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#79B8FF;">unset</span><span style="color:#E1E4E8;">&gt;  </span><span style="color:#79B8FF;">3306</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Events:</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master endpoint]# kubectl describe endpoints mysql-external</span></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">         </span><span style="color:#032F62;">mysql-external</span></span>
<span class="line"><span style="color:#6F42C1;">Namespace:</span><span style="color:#24292E;">    </span><span style="color:#032F62;">default</span></span>
<span class="line"><span style="color:#6F42C1;">Labels:</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Annotations:</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Subsets:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Addresses:</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">10.103</span><span style="color:#032F62;">.236.199</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">NotReadyAddresses:</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Ports:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Name</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Port</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Protocol</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">----</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">----</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">--------</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#005CC5;">unset</span><span style="color:#24292E;">&gt;  </span><span style="color:#005CC5;">3306</span><span style="color:#24292E;">  </span><span style="color:#032F62;">TCP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Events:</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><p>4.使⽤Pod访问Service，验证能否正常访问MySQL服务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#通过ServiceIP，或ServiceName（mysql-external）都可以访问到外部数据库</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@tools /]# mysql -uhan -h 192.168.20.102 -P13306 -phan123456</span></span>
<span class="line"><span style="color:#B392F0;">Welcome</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MariaDB</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">monitor.</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Commands</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">end</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">with</span><span style="color:#E1E4E8;"> ; </span><span style="color:#B392F0;">or</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\g</span><span style="color:#9ECBFF;">.</span></span>
<span class="line"><span style="color:#B392F0;">Your</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MariaDB</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connection</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">id</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">15</span></span>
<span class="line"><span style="color:#B392F0;">Server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">version:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.3</span><span style="color:#9ECBFF;">.39-MariaDB</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MariaDB</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Server</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Copyright</span><span style="color:#E1E4E8;"> (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Type</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;help;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">or</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;\\h&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">help.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Type</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;\\c&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clear</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">current</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">input</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">statement.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">MariaDB</span><span style="color:#E1E4E8;"> [(none)]</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> create database hello_service ;</span></span>
<span class="line"><span style="color:#B392F0;">Query</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">OK,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">row</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">affected</span><span style="color:#E1E4E8;"> (0.01 </span><span style="color:#9ECBFF;">sec</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">MariaDB</span><span style="color:#E1E4E8;"> [(none)]</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> exit</span></span>
<span class="line"><span style="color:#B392F0;">Bye</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@tools /]# exit</span></span>
<span class="line"><span style="color:#79B8FF;">exit</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#通过ServiceIP，或ServiceName（mysql-external）都可以访问到外部数据库</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@tools /]# mysql -uhan -h 192.168.20.102 -P13306 -phan123456</span></span>
<span class="line"><span style="color:#6F42C1;">Welcome</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MariaDB</span><span style="color:#24292E;"> </span><span style="color:#032F62;">monitor.</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Commands</span><span style="color:#24292E;"> </span><span style="color:#032F62;">end</span><span style="color:#24292E;"> </span><span style="color:#032F62;">with</span><span style="color:#24292E;"> ; </span><span style="color:#6F42C1;">or</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\g</span><span style="color:#032F62;">.</span></span>
<span class="line"><span style="color:#6F42C1;">Your</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MariaDB</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connection</span><span style="color:#24292E;"> </span><span style="color:#032F62;">id</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">15</span></span>
<span class="line"><span style="color:#6F42C1;">Server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">version:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.3</span><span style="color:#032F62;">.39-MariaDB</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MariaDB</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Server</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Copyright</span><span style="color:#24292E;"> (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Type</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;help;&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">or</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;\\h&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">help.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Type</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;\\c&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clear</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">current</span><span style="color:#24292E;"> </span><span style="color:#032F62;">input</span><span style="color:#24292E;"> </span><span style="color:#032F62;">statement.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">MariaDB</span><span style="color:#24292E;"> [(none)]</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> create database hello_service ;</span></span>
<span class="line"><span style="color:#6F42C1;">Query</span><span style="color:#24292E;"> </span><span style="color:#032F62;">OK,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">row</span><span style="color:#24292E;"> </span><span style="color:#032F62;">affected</span><span style="color:#24292E;"> (0.01 </span><span style="color:#032F62;">sec</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">MariaDB</span><span style="color:#24292E;"> [(none)]</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> exit</span></span>
<span class="line"><span style="color:#6F42C1;">Bye</span></span>
<span class="line"><span style="color:#24292E;">[root@tools /]# exit</span></span>
<span class="line"><span style="color:#005CC5;">exit</span></span></code></pre></div><h1 id="_6-service相关字段" tabindex="-1">6.Service相关字段 <a class="header-anchor" href="#_6-service相关字段" aria-label="Permalink to &quot;6.Service相关字段&quot;">​</a></h1><h2 id="_6-1-sessionaffinity" tabindex="-1">6.1 sessionAffinity <a class="header-anchor" href="#_6-1-sessionaffinity" aria-label="Permalink to &quot;6.1 sessionAffinity&quot;">​</a></h2><p>如果要将来自于特定客户端的连接调度至同一Pod，可以使用<code>sessionAffinity</code>基于客户端的IP 地址进行会话保持.</p><p>还可以通过<code>sessionAffinityConfig.clientIP.timeoutSeconds</code>来设置最大会话停留时间。（默认10800秒，即3小时)</p><h3 id="案例-2" tabindex="-1">案例 <a class="header-anchor" href="#案例-2" aria-label="Permalink to &quot;案例&quot;">​</a></h3><h2 id="_6-2-externaltrafficpolicy" tabindex="-1">6.2 externalTrafficPolicy <a class="header-anchor" href="#_6-2-externaltrafficpolicy" aria-label="Permalink to &quot;6.2 externalTrafficPolicy&quot;">​</a></h2><p>外部流量策略：当外部用户通过NodePort请求Service，是将外部流量路由到本地节点上的Pod，还是路由到集群范围的Pod:</p><ul><li>Cluster（默认）：将用户请求路由到集群范围的所有Pod节点，具有良好的整体负载均衡。</li><li>Local：仅会将流量调度至请求的目标节点本地运行的Pod对象之上，以减少网络跳跃，降低网络延迟，但当请求指向的节点本地不存在目标Service相关的Pod对象时直接丢弃该报文。</li></ul><h3 id="案例-3" tabindex="-1">案例 <a class="header-anchor" href="#案例-3" aria-label="Permalink to &quot;案例&quot;">​</a></h3><h2 id="_6-3-internaltrafficpolicy" tabindex="-1">6.3 internalTrafficPolicy <a class="header-anchor" href="#_6-3-internaltrafficpolicy" aria-label="Permalink to &quot;6.3 internalTrafficPolicy&quot;">​</a></h2><p>本地流量策略：当本地Pod对Service发起访问时，是将流量路由到本地节点上的Pod，还是路由到集群范围的Pod:</p><ul><li>Cluster（默认）：将Pod的请求路由到集群范围的所有Pod节点，具有良好的整体负载均衡</li><li>ocal：将请求路由到与发起方处于相同节点的端点，这种机制有助于节省开销，提升效率。但当请求指向的节点本地不存在目标Service相关的Pod对象时直接丢弃该报文</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405171423254.png" alt="image-20240517142258872"></p><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>注意：在一个Service上，当externalTrafficPolicy已设置为Loca时，internaTrafficPoicy则无法使用。</p><p>换句话说，在一个集群的不同Service上可以同时使用这两个特性，但在一个Service 上不行</p></div><h3 id="案例-4" tabindex="-1">案例 <a class="header-anchor" href="#案例-4" aria-label="Permalink to &quot;案例&quot;">​</a></h3><h2 id="_6-4-publishnotreadyaddresses" tabindex="-1">6.4 publishNotReadyAddresses <a class="header-anchor" href="#_6-4-publishnotreadyaddresses" aria-label="Permalink to &quot;6.4 publishNotReadyAddresses&quot;">​</a></h2><p><code>publishNotReadyAddresses</code>:表示Pod就绪探针探测失败，也不会将失败的PodIP加入notReadyAddress列表中</p><h3 id="案例-5" tabindex="-1">案例 <a class="header-anchor" href="#案例-5" aria-label="Permalink to &quot;案例&quot;">​</a></h3><h1 id="_7-service深入理解" tabindex="-1">7.Service深⼊理解 <a class="header-anchor" href="#_7-service深入理解" aria-label="Permalink to &quot;7.Service深⼊理解&quot;">​</a></h1><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405171432964.png" alt="image-20240517143234811"></p><h2 id="_7-1-iptables模型分析" tabindex="-1">7.1 Iptables模型分析 <a class="header-anchor" href="#_7-1-iptables模型分析" aria-label="Permalink to &quot;7.1 Iptables模型分析&quot;">​</a></h2><h3 id="clusterip-模式分析" tabindex="-1">ClusterIP 模式分析 <a class="header-anchor" href="#clusterip-模式分析" aria-label="Permalink to &quot;ClusterIP 模式分析&quot;">​</a></h3><h3 id="nodeport-分析" tabindex="-1">NodePort 分析 <a class="header-anchor" href="#nodeport-分析" aria-label="Permalink to &quot;NodePort 分析&quot;">​</a></h3><h2 id="_7-2-ipvs模型分析" tabindex="-1">7.2 IPVS模型分析 <a class="header-anchor" href="#_7-2-ipvs模型分析" aria-label="Permalink to &quot;7.2 IPVS模型分析&quot;">​</a></h2><h2 id="_7-3-iptables和ipvs对比" tabindex="-1">7.3 Iptables和IPVS对比 <a class="header-anchor" href="#_7-3-iptables和ipvs对比" aria-label="Permalink to &quot;7.3 Iptables和IPVS对比&quot;">​</a></h2><ul><li>Iptables： <ul><li>灵活，功能强大</li><li>规则遍历匹配和更新，呈线性时延</li></ul></li><li>IPVS： <ul><li>工作在内核态，有更好的性能</li><li>调度算法丰富：rr，wrr，lc，wlc，ip hash...</li></ul></li><li>生产环境推荐使用IPVS</li></ul><h1 id="_8-服务发现" tabindex="-1">8.服务发现 <a class="header-anchor" href="#_8-服务发现" aria-label="Permalink to &quot;8.服务发现&quot;">​</a></h1><p>当Pod需要访问Service时，通过Service提供的clusterIP就可以实现了，但是有几个问题；</p><p>1、Service的IP不稳定，删除重建会发生变化;</p><p>2、ServiceIP难以记忆，如果能通过一个固定的名称访问就好了；</p><p>为了解决这样的问题，Kubernetes引l入了环境变量和DNS两种方案来解决这样的问题;</p><p>1、环境变量方式：通过特定的名称将环境变量注入到Pod内部；</p><p>2、DNS方式：通过APIServer来监视Service变动，而后动态创建对应Service名称与ServiceIP的域名解析记录；</p><h2 id="_8-1-环境变量" tabindex="-1">8.1 环境变量 <a class="header-anchor" href="#_8-1-环境变量" aria-label="Permalink to &quot;8.1 环境变量&quot;">​</a></h2><p>每个Pod启动的时候，会通过环境变量的方式将Service的IP以及Port信息注入进去，这样Pod 中的应用可以通过读取环境变量来获取对应Service服务的地址信息，这种方法使用起来相对简单，但是也存在一定的问题。就是Pod所依赖的Service必须优Pod启动，否则无法注入到环境变量中。</p><p>1、创建Service资源</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master endpoint</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat env-service.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">my-env</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master endpoint</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat env-service.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">my-env</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><p>2、创建容器，然后验证对应的环境变量</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master endpoint]# kubectl exec -it pod-env -- /bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#进入容器执行env</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@pod-env /]# env</span></span>
<span class="line"><span style="color:#E1E4E8;">DEMO_SERVICE_PORT_8080_TCP</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp://192.168.15.149:8080</span></span>
<span class="line"><span style="color:#E1E4E8;">NGINX_PORT_8080_TCP_PORT</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">HOSTNAME</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">pod-env</span></span>
<span class="line"><span style="color:#E1E4E8;">DEMO_SERVICE_SERVICE_HOST</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.15.149</span></span>
<span class="line"><span style="color:#E1E4E8;">KUBERNETES_PORT_443_TCP_PORT</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">443</span></span>
<span class="line"><span style="color:#E1E4E8;">KUBERNETES_PORT</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp://192.168.0.1:443</span></span>
<span class="line"><span style="color:#E1E4E8;">TERM</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">xterm</span></span>
<span class="line"><span style="color:#E1E4E8;">NGINX_PORT_8080_TCP_ADDR</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.253.94</span></span>
<span class="line"><span style="color:#E1E4E8;">DEMO_SERVICE_PORT_8080_TCP_PORT</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">NGINX_PORT_8080_TCP_PROTO</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">KUBERNETES_SERVICE_PORT</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">443</span></span>
<span class="line"><span style="color:#E1E4E8;">KUBERNETES_SERVICE_HOST</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.0.1</span></span>
<span class="line"><span style="color:#E1E4E8;">MY_ENV_SERVICE_HOST</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.8.93</span></span>
<span class="line"><span style="color:#E1E4E8;">DEMO_SERVICE_PORT_8080_TCP_PROTO</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">NGINX_SERVICE_HOST</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.253.94</span></span>
<span class="line"><span style="color:#E1E4E8;">MY_ENV_PORT_80_TCP_ADDR</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.8.93</span></span>
<span class="line"><span style="color:#E1E4E8;">NGINX_PORT_8080_TCP</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp://192.168.253.94:8080</span></span>
<span class="line"><span style="color:#E1E4E8;">DEMO_SERVICE_PORT</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp://192.168.15.149:8080</span></span>
<span class="line"><span style="color:#E1E4E8;">PATH</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span>
<span class="line"><span style="color:#E1E4E8;">PWD</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">NGINX_SERVICE_PORT</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">MY_ENV_PORT_80_TCP_PROTO</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">DEMO_SERVICE_SERVICE_PORT_HTTP</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">SHLVL</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">HOME</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/root</span></span>
<span class="line"><span style="color:#E1E4E8;">KUBERNETES_PORT_443_TCP_PROTO</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">MY_ENV_PORT</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp://192.168.8.93:80</span></span>
<span class="line"><span style="color:#E1E4E8;">KUBERNETES_SERVICE_PORT_HTTPS</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">443</span></span>
<span class="line"><span style="color:#E1E4E8;">MY_ENV_SERVICE_PORT</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">DEMO_SERVICE_SERVICE_PORT</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">KUBERNETES_PORT_443_TCP_ADDR</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.0.1</span></span>
<span class="line"><span style="color:#E1E4E8;">MY_ENV_PORT_80_TCP_PORT</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">KUBERNETES_PORT_443_TCP</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp://192.168.0.1:443</span></span>
<span class="line"><span style="color:#E1E4E8;">NGINX_PORT</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp://192.168.253.94:8080</span></span>
<span class="line"><span style="color:#E1E4E8;">DEMO_SERVICE_PORT_8080_TCP_ADDR</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.15.149</span></span>
<span class="line"><span style="color:#E1E4E8;">MY_ENV_PORT_80_TCP</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp://192.168.8.93:80</span></span>
<span class="line"><span style="color:#E1E4E8;">_</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/usr/bin/env</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master endpoint]# kubectl exec -it pod-env -- /bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#进入容器执行env</span></span>
<span class="line"><span style="color:#24292E;">[root@pod-env /]# env</span></span>
<span class="line"><span style="color:#24292E;">DEMO_SERVICE_PORT_8080_TCP</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp://192.168.15.149:8080</span></span>
<span class="line"><span style="color:#24292E;">NGINX_PORT_8080_TCP_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">HOSTNAME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">pod-env</span></span>
<span class="line"><span style="color:#24292E;">DEMO_SERVICE_SERVICE_HOST</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.15.149</span></span>
<span class="line"><span style="color:#24292E;">KUBERNETES_PORT_443_TCP_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">443</span></span>
<span class="line"><span style="color:#24292E;">KUBERNETES_PORT</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp://192.168.0.1:443</span></span>
<span class="line"><span style="color:#24292E;">TERM</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">xterm</span></span>
<span class="line"><span style="color:#24292E;">NGINX_PORT_8080_TCP_ADDR</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.253.94</span></span>
<span class="line"><span style="color:#24292E;">DEMO_SERVICE_PORT_8080_TCP_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">NGINX_PORT_8080_TCP_PROTO</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp</span></span>
<span class="line"><span style="color:#24292E;">KUBERNETES_SERVICE_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">443</span></span>
<span class="line"><span style="color:#24292E;">KUBERNETES_SERVICE_HOST</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.0.1</span></span>
<span class="line"><span style="color:#24292E;">MY_ENV_SERVICE_HOST</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.8.93</span></span>
<span class="line"><span style="color:#24292E;">DEMO_SERVICE_PORT_8080_TCP_PROTO</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp</span></span>
<span class="line"><span style="color:#24292E;">NGINX_SERVICE_HOST</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.253.94</span></span>
<span class="line"><span style="color:#24292E;">MY_ENV_PORT_80_TCP_ADDR</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.8.93</span></span>
<span class="line"><span style="color:#24292E;">NGINX_PORT_8080_TCP</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp://192.168.253.94:8080</span></span>
<span class="line"><span style="color:#24292E;">DEMO_SERVICE_PORT</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp://192.168.15.149:8080</span></span>
<span class="line"><span style="color:#24292E;">PATH</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span>
<span class="line"><span style="color:#24292E;">PWD</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/</span></span>
<span class="line"><span style="color:#24292E;">NGINX_SERVICE_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">MY_ENV_PORT_80_TCP_PROTO</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp</span></span>
<span class="line"><span style="color:#24292E;">DEMO_SERVICE_SERVICE_PORT_HTTP</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">SHLVL</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">HOME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/root</span></span>
<span class="line"><span style="color:#24292E;">KUBERNETES_PORT_443_TCP_PROTO</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp</span></span>
<span class="line"><span style="color:#24292E;">MY_ENV_PORT</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp://192.168.8.93:80</span></span>
<span class="line"><span style="color:#24292E;">KUBERNETES_SERVICE_PORT_HTTPS</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">443</span></span>
<span class="line"><span style="color:#24292E;">MY_ENV_SERVICE_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">DEMO_SERVICE_SERVICE_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">KUBERNETES_PORT_443_TCP_ADDR</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.0.1</span></span>
<span class="line"><span style="color:#24292E;">MY_ENV_PORT_80_TCP_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">KUBERNETES_PORT_443_TCP</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp://192.168.0.1:443</span></span>
<span class="line"><span style="color:#24292E;">NGINX_PORT</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp://192.168.253.94:8080</span></span>
<span class="line"><span style="color:#24292E;">DEMO_SERVICE_PORT_8080_TCP_ADDR</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.15.149</span></span>
<span class="line"><span style="color:#24292E;">MY_ENV_PORT_80_TCP</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp://192.168.8.93:80</span></span>
<span class="line"><span style="color:#24292E;">_</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/usr/bin/env</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>在使用k8s 配置文件传入变量的时候，需要注意在变量上，整数或者字符串需要使用 单引号或双引号，否则或报错</p></div><h2 id="_8-2-coredns" tabindex="-1">8.2 CoreDNS <a class="header-anchor" href="#_8-2-coredns" aria-label="Permalink to &quot;8.2 CoreDNS&quot;">​</a></h2><p>在安装Kubernetes集群时，CoreDNS作为附加组件，用来为Pod提供DNS域名解析。CoreDNS监视 Kubernetes API 中的新Service，并为每个Service名称创建一组DNS记录。这样我们就可以通过固定的Service名称来转换出不固定的ServiceIP</p><p>1、了解CoreDNS的配置</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master endpoint]# kubectl get configmap coredns -n kube-system -oyaml</span></span>
<span class="line"><span style="color:#B392F0;">apiVersion:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#B392F0;">data:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Corefile:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">.</span><span style="color:#E1E4E8;">:53 </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">errors</span><span style="color:#E1E4E8;">			</span><span style="color:#6A737D;"># 错误记录</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">health</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;"># 健康检查</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#B392F0;">lameduck</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">ready</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">kubernetes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster.local</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in-addr.arpa</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ip6.arpa</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># ⽤于解析Kubernetes集群内域名</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#B392F0;">pods</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">insecure</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#B392F0;">fallthrough</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in-addr.arpa</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ip6.arpa</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#B392F0;">ttl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">30</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">prometheus</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">:9153</span><span style="color:#E1E4E8;">				</span><span style="color:#6A737D;"># 监控的端⼝</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">forward</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/resolv.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{</span><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;"># 如果请求⾮Kubernetes域名，则由节点的resolv.conf中dns解析</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#B392F0;">max_concurrent</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1000</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">cache</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;"># 缓存所有内容</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">loop</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">reload</span><span style="color:#E1E4E8;">			</span><span style="color:#6A737D;"># ⽀持热更新</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">loadbalance</span><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;"># 负载均衡，默认轮询</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#B392F0;">kind:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ConfigMap</span></span>
<span class="line"><span style="color:#B392F0;">metadata:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">creationTimestamp:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;2024-04-10T08:32:04Z&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">coredns</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">namespace:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">resourceVersion:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;239&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">uid:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">95</span><span style="color:#9ECBFF;">de04df-4c46-436d-84e1-956c792c0ca9</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master endpoint]# kubectl get configmap coredns -n kube-system -oyaml</span></span>
<span class="line"><span style="color:#6F42C1;">apiVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#6F42C1;">data:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Corefile:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">.</span><span style="color:#24292E;">:53 </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">errors</span><span style="color:#24292E;">			</span><span style="color:#6A737D;"># 错误记录</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">health</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span><span style="color:#24292E;">		</span><span style="color:#6A737D;"># 健康检查</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6F42C1;">lameduck</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">ready</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">kubernetes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster.local</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in-addr.arpa</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ip6.arpa</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span><span style="color:#24292E;">	</span><span style="color:#6A737D;"># ⽤于解析Kubernetes集群内域名</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6F42C1;">pods</span><span style="color:#24292E;"> </span><span style="color:#032F62;">insecure</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6F42C1;">fallthrough</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in-addr.arpa</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ip6.arpa</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6F42C1;">ttl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">30</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">prometheus</span><span style="color:#24292E;"> </span><span style="color:#032F62;">:9153</span><span style="color:#24292E;">				</span><span style="color:#6A737D;"># 监控的端⼝</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">forward</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/resolv.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{</span><span style="color:#24292E;">	</span><span style="color:#6A737D;"># 如果请求⾮Kubernetes域名，则由节点的resolv.conf中dns解析</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6F42C1;">max_concurrent</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1000</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">cache</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">30</span><span style="color:#24292E;">		</span><span style="color:#6A737D;"># 缓存所有内容</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">loop</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">reload</span><span style="color:#24292E;">			</span><span style="color:#6A737D;"># ⽀持热更新</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">loadbalance</span><span style="color:#24292E;">		</span><span style="color:#6A737D;"># 负载均衡，默认轮询</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#6F42C1;">kind:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ConfigMap</span></span>
<span class="line"><span style="color:#6F42C1;">metadata:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">creationTimestamp:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;2024-04-10T08:32:04Z&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">coredns</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">namespace:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">resourceVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;239&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">uid:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">95</span><span style="color:#032F62;">de04df-4c46-436d-84e1-956c792c0ca9</span></span></code></pre></div><p>2、CoreDNS只所以是固定的IP以及固定的搜索域。是因为kubeLet将<code>--cluster-dns=&lt;dns-service-ip&gt; 、 --cluster-domain=&lt;default-local-domain&gt;</code>对应的配置传递给了每个容器。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[root@kube-master kubelet]# cat /var/lib/kubelet/config.yaml</span></span>
<span class="line"><span style="color:#e1e4e8;">....</span></span>
<span class="line"><span style="color:#e1e4e8;">clusterDNS:</span></span>
<span class="line"><span style="color:#e1e4e8;">- 192.168.0.10 # DNS的固定ServiceIP</span></span>
<span class="line"><span style="color:#e1e4e8;">clusterDomain: cluster.local # 域名</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[root@kube-master kubelet]# cat /var/lib/kubelet/config.yaml</span></span>
<span class="line"><span style="color:#24292e;">....</span></span>
<span class="line"><span style="color:#24292e;">clusterDNS:</span></span>
<span class="line"><span style="color:#24292e;">- 192.168.0.10 # DNS的固定ServiceIP</span></span>
<span class="line"><span style="color:#24292e;">clusterDomain: cluster.local # 域名</span></span></code></pre></div><p>3、进⼊任意Pod中，验证/etc/resolv.conf以及域名解析</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master kubelet]# kubectl exec -it pod-env -- /bin/bash</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@pod-env /]#</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@pod-env /]#</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@pod-env /]# cat /etc/resolv.conf</span></span>
<span class="line"><span style="color:#B392F0;">nameserver</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.0.10</span></span>
<span class="line"><span style="color:#B392F0;">search</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">default.svc.cluster.local</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">svc.cluster.local</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster.local</span></span>
<span class="line"><span style="color:#B392F0;">options</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ndots:5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 通过域名解析对应的ServiceIP</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@pod-env /]# dig @192.168.0.10 demo-service.default.svc.cluster.local +short</span></span>
<span class="line"><span style="color:#B392F0;">192.168.15.149</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master kubelet]# kubectl exec -it pod-env -- /bin/bash</span></span>
<span class="line"><span style="color:#24292E;">[root@pod-env /]#</span></span>
<span class="line"><span style="color:#24292E;">[root@pod-env /]#</span></span>
<span class="line"><span style="color:#24292E;">[root@pod-env /]# cat /etc/resolv.conf</span></span>
<span class="line"><span style="color:#6F42C1;">nameserver</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.0.10</span></span>
<span class="line"><span style="color:#6F42C1;">search</span><span style="color:#24292E;"> </span><span style="color:#032F62;">default.svc.cluster.local</span><span style="color:#24292E;"> </span><span style="color:#032F62;">svc.cluster.local</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">options</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ndots:5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 通过域名解析对应的ServiceIP</span></span>
<span class="line"><span style="color:#24292E;">[root@pod-env /]# dig @192.168.0.10 demo-service.default.svc.cluster.local +short</span></span>
<span class="line"><span style="color:#6F42C1;">192.168.15.149</span></span></code></pre></div><h2 id="_8-3-coredns策略" tabindex="-1">8.3 CoreDNS策略 <a class="header-anchor" href="#_8-3-coredns策略" aria-label="Permalink to &quot;8.3 CoreDNS策略&quot;">​</a></h2><p>DNS策略可以单独对Pod进行设定，在创建Pod时可以为其指定DNS的策略，最终配置会落在Pod的<code>/etc/resolv.conf</code>文件中，可以通过<code>pod.spec.dnsPolicy</code>字段设置DNS的策略。</p><h3 id="_1、clusterfirst-默认dns策略" tabindex="-1">1、ClusterFirst（默认DNS策略） <a class="header-anchor" href="#_1、clusterfirst-默认dns策略" aria-label="Permalink to &quot;1、ClusterFirst（默认DNS策略）&quot;">​</a></h3><p>表示Pod内的DNS使用集群中配置的DNS服务，简单来说就是使用Kubernetes中的coredns服务进行域名解析。如果解析不成功，会使用当前Pod所在的宿主机DNS进行解析。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">V1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dns-test</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">dnsPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterFirst</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tools</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">V1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dns-test</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">dnsPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterFirst</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tools</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><h3 id="_2、clusterfirstwithhostnet" tabindex="-1">2、ClusterFirstWithHostNet <a class="header-anchor" href="#_2、clusterfirstwithhostnet" aria-label="Permalink to &quot;2、ClusterFirstWithHostNet&quot;">​</a></h3><p>在某些场景下，我们的 Pod 是角HostNetwork 模式启动的，一旦使用HostNetwork模式，那该Pod则会使用当前宿主机的<code>/etc/resoLv.conf</code>来进行 DNS 查询，但如果任然想继续使用Kubernetes 的DNS服务，那就将<code>dnsPolicy</code>设置为<code>ClusterFirstWithHostNet</code>.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-pod</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">hostNetwork</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">                 </span><span style="color:#6A737D;"># 开启host网络模式</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">dnsPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterFirstWithHostNet</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 如果没配置使⽤当前Pod所在宿主机的DNS</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">:  </span><span style="color:#9ECBFF;">tools</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-pod</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">hostNetwork</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">                 </span><span style="color:#6A737D;"># 开启host网络模式</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">dnsPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterFirstWithHostNet</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 如果没配置使⽤当前Pod所在宿主机的DNS</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">:  </span><span style="color:#032F62;">tools</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span></code></pre></div><h3 id="_3、default" tabindex="-1">3、Default <a class="header-anchor" href="#_3、default" aria-label="Permalink to &quot;3、Default&quot;">​</a></h3><p>默认使用宿主机的/etc/resolv.conf但可以使用kubelet 的--resolv-conf=/etc/resolv.conf 来指定DNS解析文件地址。</p><h3 id="_4、none" tabindex="-1">4、None <a class="header-anchor" href="#_4、none" aria-label="Permalink to &quot;4、None&quot;">​</a></h3><p>空的DNS设置，这种方式一般用于自定义DNS配置的场景，往往需要和dnsConfig一起使用才可以达到自定义DNS的目的。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-dns</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-dns</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">dnsPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;None&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">dnsConfig</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nameservers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#79B8FF;">192.168.0.10</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#79B8FF;">114.114.114.114</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">searches</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">cluster.local</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">svc.cluster.local</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">default.svc.cluster.local</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">freehan.ink</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">options</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ndots</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;5&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-dns</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-dns</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">dnsPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;None&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">dnsConfig</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nameservers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#005CC5;">192.168.0.10</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#005CC5;">114.114.114.114</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">searches</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">cluster.local</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">svc.cluster.local</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">default.svc.cluster.local</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">freehan.ink</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">options</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ndots</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">value</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;5&quot;</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 检查/etc/resolv.conf配置</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-it</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">myapp-dns</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/resolv.conf</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 检查/etc/resolv.conf配置</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-it</span><span style="color:#24292E;"> </span><span style="color:#032F62;">myapp-dns</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/resolv.conf</span></span></code></pre></div><h2 id="_8-4-服务发现原理" tabindex="-1">8.4 服务发现原理 <a class="header-anchor" href="#_8-4-服务发现原理" aria-label="Permalink to &quot;8.4 服务发现原理&quot;">​</a></h2><p>在Kubernetes中，服务发现主要通过以下几个组件和机制实现：</p><ol><li><strong>Service</strong>：Service是Kubernetes中用于定义服务的抽象层，它可以将一组Pod封装成一个逻辑服务，并通过一个稳定的网络地址（通常是Cluster IP）和端口号对外暴露。Service通过标签选择器（Label Selector）将流量路由到匹配的Pod。当Pod的IP地址发生变化时，Service会自动更新其Endpoint，确保流量能够正确路由到新的Pod。</li><li><strong>Endpoint</strong>：Endpoint是Kubernetes中的一个资源对象，用于存储Service对应的Pod的网络地址和端口号。当Service被创建时，Kubernetes会自动为其创建一个Endpoint对象，并根据Service的标签选择器将匹配的Pod的IP地址和端口号添加到Endpoint中。其他Pod或Service可以通过查询Endpoint来获取要访问的Pod的网络地址和端口号。</li><li><strong>DNS</strong>：在Kubernetes集群中，每个Service都会被分配一个DNS名称，格式为<code>&lt;service-name&gt;.&lt;namespace-name&gt;.svc.cluster.local</code>。Pod可以通过这个DNS名称来访问Service，而无需知道其具体的IP地址和端口号。Kubernetes集群中的DNS服务器（如CoreDNS）会负责解析这些DNS名称，将请求路由到正确的Service。</li><li><strong>kube-proxy</strong>：kube-proxy是Kubernetes集群中的网络代理程序，它运行在每个工作节点上。kube-proxy负责监听Service和Endpoint的变化，并根据这些变化更新节点的网络规则，以确保流量能够正确路由到目标Pod。kube-proxy可以使用不同的代理模式（如iptables、ipvs等）来实现流量转发和负载均衡。</li></ol><h1 id="_9-headless-service" tabindex="-1">9.HeadLess Service <a class="header-anchor" href="#_9-headless-service" aria-label="Permalink to &quot;9.HeadLess Service&quot;">​</a></h1><h2 id="_9-1-什么是headless" tabindex="-1">9.1 什么是HeadLess <a class="header-anchor" href="#_9-1-什么是headless" aria-label="Permalink to &quot;9.1 什么是HeadLess&quot;">​</a></h2><p>HeadlessService也叫无头服务，就是创建的Service没有CLusterIP，而是为Service所匹配的每个Pod都创建一条DNS的解析记录，这样每个Pod都有一个唯一的DNS名称标识身份，访问的格式如下</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">$(service_name).$(namespace).svc.cluster.local</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">$(service_name).$(namespace).svc.cluster.local</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405171751067.png" alt="image-20240517175116805"></p><h2 id="_9-2-headless的作用" tabindex="-1">9.2 HeadLess的作⽤ <a class="header-anchor" href="#_9-2-headless的作用" aria-label="Permalink to &quot;9.2 HeadLess的作⽤&quot;">​</a></h2><p>像 elasticsearch，mongodb，kafka 等分布式服务，在做集群初始化时，配置文件中要写上集群中所有节点的IP（或是域名）但Pod是没有固定IP的，所以配置文件里写DNS名称是最合适的。</p><p>那为什么不用Service，因为Service 作为 Pod 前置的负载均衡,一般是为一组相同的后端 Pod 提供访问入口，而且Service的selector也没有办法区分同一组Pod的不同身份。</p><p>但是我们可以使用Statefulset控制器，它在创建每个Pod的时候，能为每个Pod 做一个编号，就是为了能区分这一组Pod的不同角色，各个节点的角色不会变得混乱，然后再创建 headless service 资源，集群内的节点通过Pod名称+序号.Service名称，来进行彼此间通信的，只要序号不变，访问就不会出错。</p><h3 id="案例-6" tabindex="-1">案例 <a class="header-anchor" href="#案例-6" aria-label="Permalink to &quot;案例&quot;">​</a></h3><h2 id="_9-3-service和headless-service的区别" tabindex="-1">9.3 Service和Headless Service的区别 <a class="header-anchor" href="#_9-3-service和headless-service的区别" aria-label="Permalink to &quot;9.3 Service和Headless Service的区别&quot;">​</a></h2><ul><li>普通的 Service，只能通过解析 service 的 DNS 返回 service 的 Cluster IP。</li><li>headless service作为service的一种类型，顾名思义无头服务，无头 Service 不会获得集群 IP，kube-proxy 不会处理这类 Service， 而且平台也不会为它们提供负载均衡或路由支持。</li><li>无头 Service 允许客户端直接连接到它所偏好的任一 Pod。 无头 Service 不使用虚拟 IP 地址和代理配置路由和数据包转发；相反，无头 Service 通过内部 DNS 记录报告各个 Pod 的端点 IP 地址，这些 DNS 记录是由集群的 DNS 服务所提供的。</li><li>Cluster IP 类型的 Service 用于有状态的服务，而 Headless Service 则用于有状态的服务，比如有时候 client 想自己决定使用哪个 Real Server，可以通过查询 DNS 来获取 Real Server 的信息。又或者 headless service关联的每个 endpoint（也就是 Pod）,都会有对应的 DNS 域名；这样 Pod 之间就可以互相访问。</li><li>无状态的服务，其中一个代表就是 Deployment，而有状态的服务，代表则是 StatefulSet。 其中，Headless Service 主要是为了 StatefulSet 的网络拓扑状态而服务的。</li></ul><h3 id="普通service解析dns" tabindex="-1">普通service解析DNS <a class="header-anchor" href="#普通service解析dns" aria-label="Permalink to &quot;普通service解析DNS&quot;">​</a></h3><p>Service的ClusterIP工作原理：一个 Service 可能对应一组 endpoints（所有 pod 的地址+端口），client 访问 ClusterIP，通过 iptables 或者 ipvs 转发到 Real Server（Pod）</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># kubectl get pods -o wide</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                     </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">IP</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">NOMINATED</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">READINESS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GATES</span></span>
<span class="line"><span style="color:#B392F0;">busybox</span><span style="color:#E1E4E8;">                  </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">18</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.104</span><span style="color:#9ECBFF;">.157.68</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">k8s</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">nginx-6b85df66b4-gnbwg</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">18</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.104</span><span style="color:#9ECBFF;">.157.70</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">k8s</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">nginx-6b85df66b4-rjf6g</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">18</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.104</span><span style="color:#9ECBFF;">.157.71</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">k8s</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># kubectl get service -l service=nginx</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">             </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">CLUSTER-IP</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">EXTERNAL-IP</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">PORT</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">S</span><span style="color:#E1E4E8;">)   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">nginx-service</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">ClusterIP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.16</span><span style="color:#9ECBFF;">.100.1</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">/TCP</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">21</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># kubectl get endpoints nginx-service</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">ENDPOINTS</span><span style="color:#E1E4E8;">                           </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">nginx-service</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.104</span><span style="color:#9ECBFF;">.157.70:80,10.104.157.71:80</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">45</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># kubectl exec -t busybox -- nslookup nginx-service.default.svc.cluster.local</span></span>
<span class="line"><span style="color:#B392F0;">Server:</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">172.16</span><span style="color:#9ECBFF;">.0.10</span></span>
<span class="line"><span style="color:#B392F0;">Address</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.16</span><span style="color:#9ECBFF;">.0.10</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Name:</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">nginx-service.default.svc.cluster.local</span></span>
<span class="line"><span style="color:#B392F0;">Address</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.16</span><span style="color:#9ECBFF;">.100.1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nginx-service.default.svc.cluster.local</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># kubectl get pods -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                     </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">              </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">NOMINATED</span><span style="color:#24292E;"> </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READINESS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GATES</span></span>
<span class="line"><span style="color:#6F42C1;">busybox</span><span style="color:#24292E;">                  </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">18</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.104</span><span style="color:#032F62;">.157.68</span><span style="color:#24292E;">   </span><span style="color:#032F62;">k8s</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-6b85df66b4-gnbwg</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">18</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.104</span><span style="color:#032F62;">.157.70</span><span style="color:#24292E;">   </span><span style="color:#032F62;">k8s</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-6b85df66b4-rjf6g</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">18</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.104</span><span style="color:#032F62;">.157.71</span><span style="color:#24292E;">   </span><span style="color:#032F62;">k8s</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># kubectl get service -l service=nginx</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">             </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">        </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">     </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-service</span><span style="color:#24292E;">    </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.16</span><span style="color:#032F62;">.100.1</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">21</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># kubectl get endpoints nginx-service</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">            </span><span style="color:#032F62;">ENDPOINTS</span><span style="color:#24292E;">                           </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-service</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.104</span><span style="color:#032F62;">.157.70:80,10.104.157.71:80</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">45</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># kubectl exec -t busybox -- nslookup nginx-service.default.svc.cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">Server:</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">172.16</span><span style="color:#032F62;">.0.10</span></span>
<span class="line"><span style="color:#6F42C1;">Address</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.16</span><span style="color:#032F62;">.0.10</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">      </span><span style="color:#032F62;">nginx-service.default.svc.cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">Address</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.16</span><span style="color:#032F62;">.100.1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx-service.default.svc.cluster.local</span></span></code></pre></div><p>从上面看到:</p><p>虽然 Service 有 2 个 endpoint（<code>10.104.157.70:80,10.104.157.71:80</code>），但是 DNS 查询时只会返回 Service 的 ClusterIP 地址（<code>172.16.100.1</code>），具体 Client 访问的是哪个 real server，由 iptables 或者 ipvs 决定</p><h3 id="headless-service的解析service的dns结果" tabindex="-1">headless Service的解析service的DNS结果 <a class="header-anchor" href="#headless-service的解析service的dns结果" aria-label="Permalink to &quot;headless Service的解析service的DNS结果&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># kubectl get statefulsets</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">redis</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">/2</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">38</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># kubectl get pods -o wide</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">IP</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">NOMINATED</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">READINESS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GATES</span></span>
<span class="line"><span style="color:#B392F0;">busybox</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">59</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.104</span><span style="color:#9ECBFF;">.157.77</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">k8s</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">redis-0</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">49</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.104</span><span style="color:#9ECBFF;">.157.80</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">k8s</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">redis-1</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">48</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.104</span><span style="color:#9ECBFF;">.157.81</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">k8s</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># kubectl get service -l service=redis</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">             </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">CLUSTER-IP</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">EXTERNAL-IP</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">PORT</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">S</span><span style="color:#E1E4E8;">)    </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">redis-headless</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">ClusterIP</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">None</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">6379</span><span style="color:#9ECBFF;">/TCP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">17</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">redis-service</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">ClusterIP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.16</span><span style="color:#9ECBFF;">.200.1</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">6379</span><span style="color:#9ECBFF;">/TCP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">23</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># kubectl get endpoints  redis-service </span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">ENDPOINTS</span><span style="color:#E1E4E8;">                               </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">redis-service</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.104</span><span style="color:#9ECBFF;">.157.80:6379,10.104.157.81:6379</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">25</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># kubectl exec -t busybox -- nslookup redis-headless.default.svc.cluster.local</span></span>
<span class="line"><span style="color:#B392F0;">Server:</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">172.16</span><span style="color:#9ECBFF;">.0.10</span></span>
<span class="line"><span style="color:#B392F0;">Address</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.16</span><span style="color:#9ECBFF;">.0.10</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Name:</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">redis-headless.default.svc.cluster.local</span></span>
<span class="line"><span style="color:#B392F0;">Address</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.104</span><span style="color:#9ECBFF;">.157.80</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">redis-0.redis-headless.default.svc.cluster.local</span></span>
<span class="line"><span style="color:#B392F0;">Address</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.104</span><span style="color:#9ECBFF;">.157.81</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">redis-0.redis-headless.default.svc.cluster.local</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># kubectl get statefulsets</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">    </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">redis</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">/2</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">38</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># kubectl get pods -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">      </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">              </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">NOMINATED</span><span style="color:#24292E;"> </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READINESS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GATES</span></span>
<span class="line"><span style="color:#6F42C1;">busybox</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">59</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.104</span><span style="color:#032F62;">.157.77</span><span style="color:#24292E;">   </span><span style="color:#032F62;">k8s</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">redis-0</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">49</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.104</span><span style="color:#032F62;">.157.80</span><span style="color:#24292E;">   </span><span style="color:#032F62;">k8s</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">redis-1</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">48</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.104</span><span style="color:#032F62;">.157.81</span><span style="color:#24292E;">   </span><span style="color:#032F62;">k8s</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># kubectl get service -l service=redis</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">             </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">        </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">     </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)    </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">redis-headless</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">None</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">6379</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">17</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">redis-service</span><span style="color:#24292E;">    </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.16</span><span style="color:#032F62;">.200.1</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">6379</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">23</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># kubectl get endpoints  redis-service </span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">            </span><span style="color:#032F62;">ENDPOINTS</span><span style="color:#24292E;">                               </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">redis-service</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.104</span><span style="color:#032F62;">.157.80:6379,10.104.157.81:6379</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">25</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#6A737D;"># kubectl exec -t busybox -- nslookup redis-headless.default.svc.cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">Server:</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">172.16</span><span style="color:#032F62;">.0.10</span></span>
<span class="line"><span style="color:#6F42C1;">Address</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.16</span><span style="color:#032F62;">.0.10</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">      </span><span style="color:#032F62;">redis-headless.default.svc.cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">Address</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.104</span><span style="color:#032F62;">.157.80</span><span style="color:#24292E;"> </span><span style="color:#032F62;">redis-0.redis-headless.default.svc.cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">Address</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.104</span><span style="color:#032F62;">.157.81</span><span style="color:#24292E;"> </span><span style="color:#032F62;">redis-0.redis-headless.default.svc.cluster.local</span></span></code></pre></div><p>Headless Service 的作用在于是让 <code>&lt;pod name&gt;</code> 加入了域名中，这样才能完成网络拓扑的关系确定</p><h1 id="_10-service和pod关系" tabindex="-1">10. Service和pod关系 <a class="header-anchor" href="#_10-service和pod关系" aria-label="Permalink to &quot;10. Service和pod关系&quot;">​</a></h1><ul><li>service通过标签关联一组Pod</li><li>Service使用iptables或者ipvs为一组Pod提供负载均衡能力</li><li>示例图： <img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408071048026.png" alt="image"></li></ul><p>注意这里的后缀：&quot;default.svc.cluster.local&quot;</p><p>&quot;default&quot; 是我们正在操作的 Namespace。</p><p>&quot;svc&quot; 表示这是一个 Service。</p><p>&quot;cluster.local&quot; 是您的集群域，在您自己的集群中可能会有所不同。</p>`,213),e=[o];function c(t,r,E,y,i,F){return n(),a("div",null,e)}const u=s(p,[["render",c]]);export{C as __pageData,u as default};
