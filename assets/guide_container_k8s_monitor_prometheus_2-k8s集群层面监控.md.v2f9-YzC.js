import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const _=JSON.parse('{"title":"1. KubeStateMetrics简介","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/monitor/prometheus/2-k8s集群层面监控.md","filePath":"guide/container/k8s/monitor/prometheus/2-k8s集群层面监控.md","lastUpdated":1739441864000}'),p={name:"guide/container/k8s/monitor/prometheus/2-k8s集群层面监控.md"},o=l(`<h1 id="_1-kubestatemetrics简介" tabindex="-1">1. KubeStateMetrics简介 <a class="header-anchor" href="#_1-kubestatemetrics简介" aria-label="Permalink to &quot;1. KubeStateMetrics简介&quot;">​</a></h1><p>kube-state-metrics是一个Kubernetes 组件，它通过查询Kubernetes的APl服务器，收集关于Kubernetes 中各种资源（如节点、pod、服务等）的状态信息，并将这些信息转换成Prometheus可以使用的指标。</p><p>kube-state-metrics 主要功能:</p><p><em>kube-state-metrics通过轮询kubernetes API，提供有关资源对象指标的metrics，包括：CronJob、DaemonSet、Deployment、Job、LimitRange、Node、PersistentVolume 、PersistentVolumeClaim、Pod、Pod Disruption Budget、ReplicaSet、ReplicationController、ResourceQuota、Service、StatefulSet、Namespace、Horizontal Pod Autoscaler、Endpoint、Secret、ConfigMap、Ingress、CertificateSigningRequest</em></p><blockquote><p>通过 kube-state-metrics 可以方便的对 Kubernetes 集群进行监控，发现问题，以及提前预警</p></blockquote><h2 id="_1-1-kube-state-metrics与metrics-server对比" tabindex="-1">1.1 kube-state-metrics与metrics-server对比 <a class="header-anchor" href="#_1-1-kube-state-metrics与metrics-server对比" aria-label="Permalink to &quot;1.1 kube-state-metrics与metrics-server对比&quot;">​</a></h2><p>metric-server（或heapster）是从api-server中获取cpu、内存使用率这种监控指标，并把他们发送给存储后端，如influxdb或云厂商，他当前的核心作用是：为HPA等组件提供决策指标支持。</p><p>kube-state-metrics关注于获取k8s各种资源的最新状态，如deployment或者daemonset，之所以没有把kube-state-metrics纳入到metric-server的能力中，是因为他们的关注点本质上是不一样的。metric-server仅仅是获取、格式化现有数据，写入特定的存储，实质上是一个监控系统。而kube-state-metrics是将k8s的运行状况在内存中做了个快照，并且获取新的指标，但他没有能力导出这些指标</p><h1 id="_2-kubestatemetrics" tabindex="-1">2. KubeStateMetrics <a class="header-anchor" href="#_2-kubestatemetrics" aria-label="Permalink to &quot;2. KubeStateMetrics&quot;">​</a></h1><p>包含 ServiceAccount 、 ClusterRole 、 ClusterRoleBinding 、 Deployment 、ConfigMap 、 Service 六类YAML文件.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ServiceAccount</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">kubernetes.io/cluster-service</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">addonmanager.kubernetes.io/mode</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Reconcile</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRole</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">kubernetes.io/cluster-service</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">addonmanager.kubernetes.io/mode</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Reconcile</span></span>
<span class="line"><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">configmaps</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">secrets</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">nodes</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">pods</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">services</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">resourcequotas</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">replicationcontrollers</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">limitranges</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">persistentvolumeclaims</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">persistentvolumes</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">namespaces</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">endpoints</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;watch&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;apps&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">statefulsets</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">daemonsets</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">deployments</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">replicasets</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;watch&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;batch&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">cronjobs</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">jobs</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;watch&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;autoscaling&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">horizontalpodautoscalers</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;watch&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;networking.k8s.io&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;extensions&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">ingresses</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;watch&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;storage.k8s.io&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">storageclasses</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;watch&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;certificates.k8s.io&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">certificatesigningrequests</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;watch&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;policy&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">poddisruptionbudgets</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;watch&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Role</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics-resizer</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">kubernetes.io/cluster-service</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">addonmanager.kubernetes.io/mode</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Reconcile</span></span>
<span class="line"><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">pods</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;get&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;extensions&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;apps&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">deployments</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resourceNames</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;kube-state-metrics&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;get&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;update&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRoleBinding</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">kubernetes.io/cluster-service</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">addonmanager.kubernetes.io/mode</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Reconcile</span></span>
<span class="line"><span style="color:#85E89D;">roleRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">apiGroup</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterRole</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#85E89D;">subjects</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ServiceAccount</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">RoleBinding</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">kubernetes.io/cluster-service</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">addonmanager.kubernetes.io/mode</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Reconcile</span></span>
<span class="line"><span style="color:#85E89D;">roleRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">apiGroup</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Role</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics-resizer</span></span>
<span class="line"><span style="color:#85E89D;">subjects</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ServiceAccount</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">kubernetes.io/cluster-service</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">addonmanager.kubernetes.io/mode</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Reconcile</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">version</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1.3.0</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">version</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1.3.0</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">version</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1.3.0</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">scheduler.alpha.kubernetes.io/critical-pod</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">priorityClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">system-cluster-critical</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">serviceAccountName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">#image: k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.4.2</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/kube-state-metrics:v2.4.2</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http-metrics</span><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">## 用于公开kubernetes的指标数据的端口</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">telemetry</span><span style="color:#E1E4E8;">                               </span><span style="color:#6A737D;">##用于公开自身kube-state-metrics的指标数据的端口</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8081</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">readinessProbe</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">httpGet</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/healthz</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">initialDelaySeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">timeoutSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">addon-resizer</span><span style="color:#E1E4E8;">                     </span><span style="color:#6A737D;">##addon-resizer 用来伸缩部署在集群内的 metrics-server, kube-state-metrics等监控组件</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/addon-resizer:v1.8.6</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">#image: mirrorgooglecontainers/addon-resizer:1.8.6</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">limits</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">200m</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">200Mi</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">requests</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">100m</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">30Mi</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">env</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">MY_POD_NAME</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">valueFrom</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">fieldRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">fieldPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metadata.name</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">MY_POD_NAMESPACE</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">valueFrom</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">fieldRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">fieldPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metadata.namespace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">config-volume</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/config</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">/pod_nanny</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">--config-dir=/etc/config</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">--container=kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">--cpu=100m</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">--extra-cpu=1m</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">--memory=100Mi</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">--extra-memory=2Mi</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">--threshold=5</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">--deployment=kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">config-volume</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">configMap</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics-config</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#6A737D;"># Config map for resource configuration.</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ConfigMap</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics-config</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">kubernetes.io/cluster-service</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">addonmanager.kubernetes.io/mode</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Reconcile</span></span>
<span class="line"><span style="color:#85E89D;">data</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">NannyConfiguration</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|-</span></span>
<span class="line"><span style="color:#9ECBFF;">    apiVersion: nannyconfig/v1alpha1</span></span>
<span class="line"><span style="color:#9ECBFF;">    kind: NannyConfiguration</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">kubernetes.io/cluster-service</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">addonmanager.kubernetes.io/mode</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Reconcile</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">kubernetes.io/name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;kube-state-metrics&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">prometheus.io/scrape</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;true&#39;</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">telemetry</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8081</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">telemetry</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ServiceAccount</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kubernetes.io/cluster-service</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">addonmanager.kubernetes.io/mode</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Reconcile</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRole</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kubernetes.io/cluster-service</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">addonmanager.kubernetes.io/mode</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Reconcile</span></span>
<span class="line"><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">configmaps</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">secrets</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">nodes</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">pods</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">services</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">resourcequotas</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">replicationcontrollers</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">limitranges</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">persistentvolumeclaims</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">persistentvolumes</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">namespaces</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">endpoints</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;apps&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">statefulsets</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">daemonsets</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">deployments</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">replicasets</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;batch&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">cronjobs</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">jobs</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;autoscaling&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">horizontalpodautoscalers</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;networking.k8s.io&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;extensions&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">ingresses</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;storage.k8s.io&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">storageclasses</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;certificates.k8s.io&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">certificatesigningrequests</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;policy&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">poddisruptionbudgets</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Role</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics-resizer</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kubernetes.io/cluster-service</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">addonmanager.kubernetes.io/mode</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Reconcile</span></span>
<span class="line"><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">pods</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;get&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;extensions&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;apps&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">deployments</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resourceNames</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;kube-state-metrics&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;get&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;update&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRoleBinding</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kubernetes.io/cluster-service</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">addonmanager.kubernetes.io/mode</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Reconcile</span></span>
<span class="line"><span style="color:#22863A;">roleRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterRole</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#22863A;">subjects</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ServiceAccount</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">RoleBinding</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kubernetes.io/cluster-service</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">addonmanager.kubernetes.io/mode</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Reconcile</span></span>
<span class="line"><span style="color:#22863A;">roleRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apiGroup</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Role</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics-resizer</span></span>
<span class="line"><span style="color:#22863A;">subjects</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ServiceAccount</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kubernetes.io/cluster-service</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">addonmanager.kubernetes.io/mode</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Reconcile</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">version</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1.3.0</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">version</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1.3.0</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">version</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1.3.0</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">scheduler.alpha.kubernetes.io/critical-pod</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">priorityClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">system-cluster-critical</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">serviceAccountName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">#image: k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.4.2</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/kube-state-metrics:v2.4.2</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http-metrics</span><span style="color:#24292E;">                </span><span style="color:#6A737D;">## 用于公开kubernetes的指标数据的端口</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">telemetry</span><span style="color:#24292E;">                               </span><span style="color:#6A737D;">##用于公开自身kube-state-metrics的指标数据的端口</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8081</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">readinessProbe</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">httpGet</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/healthz</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">initialDelaySeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">timeoutSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">addon-resizer</span><span style="color:#24292E;">                     </span><span style="color:#6A737D;">##addon-resizer 用来伸缩部署在集群内的 metrics-server, kube-state-metrics等监控组件</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/addon-resizer:v1.8.6</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">#image: mirrorgooglecontainers/addon-resizer:1.8.6</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">limits</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">200m</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">200Mi</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">100m</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">30Mi</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">env</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">MY_POD_NAME</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">valueFrom</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">fieldRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">fieldPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metadata.name</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">MY_POD_NAMESPACE</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">valueFrom</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">fieldRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">fieldPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metadata.namespace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">config-volume</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/config</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">command</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">/pod_nanny</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">--config-dir=/etc/config</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">--container=kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">--cpu=100m</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">--extra-cpu=1m</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">--memory=100Mi</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">--extra-memory=2Mi</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">--threshold=5</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">--deployment=kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">config-volume</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">configMap</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics-config</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#6A737D;"># Config map for resource configuration.</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ConfigMap</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics-config</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kubernetes.io/cluster-service</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">addonmanager.kubernetes.io/mode</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Reconcile</span></span>
<span class="line"><span style="color:#22863A;">data</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">NannyConfiguration</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|-</span></span>
<span class="line"><span style="color:#032F62;">    apiVersion: nannyconfig/v1alpha1</span></span>
<span class="line"><span style="color:#032F62;">    kind: NannyConfiguration</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kubernetes.io/cluster-service</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">addonmanager.kubernetes.io/mode</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Reconcile</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kubernetes.io/name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;kube-state-metrics&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">prometheus.io/scrape</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;true&#39;</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http-metrics</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http-metrics</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">telemetry</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8081</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#032F62;">telemetry</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span></code></pre></div><ul><li>创建</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-state-metrics.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-state-metrics.yaml</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master Prometheus]# kubectl get pod -n monitor</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                  </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">kube-state-metrics-69d459f598-7sf6l</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">/2</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">5</span><span style="color:#9ECBFF;">m29s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master Prometheus]# kubectl get pod -n monitor</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                  </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">kube-state-metrics-69d459f598-7sf6l</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">/2</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">m29s</span></span></code></pre></div><ul><li>验证</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">all</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-nmonitor</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-kL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get service </span><span style="color:#79B8FF;">-n</span><span style="color:#9ECBFF;"> monitor </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> kube-state-metrics </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">awk</span><span style="color:#9ECBFF;"> &#39;{ print $3 }&#39;):8080/metrics</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">all</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-nmonitor</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-kL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">kubectl</span><span style="color:#032F62;"> get service </span><span style="color:#005CC5;">-n</span><span style="color:#032F62;"> monitor </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> kube-state-metrics </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">awk</span><span style="color:#032F62;"> &#39;{ print $3 }&#39;):8080/metrics</span></span></code></pre></div><h1 id="_3-kubernetes-集群监控-自动发现" tabindex="-1">3. Kubernetes 集群监控(自动发现) <a class="header-anchor" href="#_3-kubernetes-集群监控-自动发现" aria-label="Permalink to &quot;3. Kubernetes 集群监控(自动发现)&quot;">​</a></h1><ul><li>Centos 7</li><li>Kubernetes 1.22</li><li>Prometheus 2.36.0</li><li>node-export 最新</li></ul><h2 id="资源角色" tabindex="-1">资源角色 <a class="header-anchor" href="#资源角色" aria-label="Permalink to &quot;资源角色&quot;">​</a></h2><ol><li>node角色</li></ol><p>该node 角色发现用于检索集群中的节点目标信息，其地址默认为节点kubelet的HTTP访问端口。目标地址的默认顺序为NodeInternalIP，NodeExternalIP，NodeLegacyHostIP和NodeHostName中的第一个现有地址。</p><p>该角色可获取到的元数据标签如下：</p><p>• __meta_kubernetes_node_name：节点对象的名称。</p><p>• __meta_kubernetes_node_label_labelname：节点对象所定义的各个label</p><p>• __meta_kubernetes_node_labelpresent_labelname：节点对象所定义的各个label，value固定为true。</p><p>• _meta_kubernetes_node_annotation_annotationname：来自节点对象的每个注释</p><p>• _meta_kubernetes_node_annotationpresent_annotationname：来自节点对象的每个注释，value固定为true。</p><p>• _meta_kubernetes_node_address_address_type：每个节点地址类型的第一个地址（如果存在）</p><p>此外，节点的instance标签将被设置为从API服务检索到的节点名称。</p><ol><li>service角色 该角色发现用于检索集群中每个service目标，并且将该服务开放的端口做为目标端口。该地址将设置为服务的Kubernetes DNS名称以及相应的服务端口。</li></ol><p>该角色可获取到的元数据标签如下：</p><ul><li>__meta_kubernetes_namespace: 服务对象的名称空间。</li><li>__meta_kubernetes_service_annotation_annotationname:服务对象的每个注释。</li><li>__meta_kubernetes_service_annotationpresent_annotationname: 服务对象的每个注释,value固定为true。</li><li>__meta_kubernetes_service_cluster_ip: 服务对象的集群IP。</li><li>__meta_kubernetes_service_external_name: 服务的DNS名称。</li><li>__meta_kubernetes_service_label_labelname: 服务对象中的每个label。</li><li>__meta_kubernetes_service_labelpresent_labelname: 服务对象中的每个label，value固定为true。</li><li>__meta_kubernetes_service_name: 服务对象的名称。</li><li>__meta_kubernetes_service_port_name: 目标服务端口的名称。</li><li>__meta_kubernetes_service_port_protocol: 目标服务端口的协议。</li><li>__meta_kubernetes_service_type: 服务的类型。</li></ul><p>2.Pod角色</p><p>该pod角色发现用于发现所有Pod并将其容器做为目标访问，对于容器的每个声明的端口，将生成一个目标。如果容器没有指定的端口，则会为每个容器创建无端口目标。</p><p>该角色可获取到的元数据标签如下：</p><ul><li>__meta_kubernetes_namespace: pod对象的命名空间。</li><li>__meta_kubernetes_pod_name: pod对象的名称。</li><li>__meta_kubernetes_pod_ip: pod对象的pod IP。</li><li>__meta_kubernetes_pod_label_labelname: 来自pod对象的每个标签。</li><li>__meta_kubernetes_pod_labelpresent_labelname: 来自pod对象的每个标签，value固定为true。</li><li>__meta_kubernetes_pod_annotation_annotationname: 来自pod对象的每个注释。</li><li>__meta_kubernetes_pod_annotationpresent_annotationname: 来自pod对象的每个注释，value固定为true。</li><li>__meta_kubernetes_pod_container_init: 如果容器是初始化容器，则value为true。</li><li>__meta_kubernetes_pod_container_name: 目标地址指向的容器的名称。</li><li>__meta_kubernetes_pod_container_port_name: 容器端口的名称。</li><li>__meta_kubernetes_pod_container_port_number: 容器端口号。</li><li>__meta_kubernetes_pod_container_port_protocol: 容器端口的协议。</li><li>__meta_kubernetes_pod_ready: 代表pod状态是否就绪，value为true或false。</li><li>__meta_kubernetes_pod_phase: Pod的生命周期，Value值为Pending，Running，Succeeded，Failed或Unknown 。</li><li>__meta_kubernetes_pod_node_name: Pod所在节点的名称。</li><li>__meta_kubernetes_pod_host_ip: pod所在节点的IP。</li><li>__meta_kubernetes_pod_uid: pod对象的UID。</li><li>__meta_kubernetes_pod_controller_kind: pod控制器的对象种类。</li><li>__meta_kubernetes_pod_controller_name: pod控制器的名称。</li></ul><p>3.endpoints角色</p><p>该endpoints角色发现用于检索服务的endpoints目标，且每个endpoints的port地址会生成一个目标。 如果端点由Pod支持，则该Pod的所有其他容器端口（包括未绑定到endpoints的端口）也将作为目标。</p><p>该角色可获取到的元数据标签如下：</p><ul><li>__meta_kubernetes_namespace: endpoints对象的命名空间</li><li>__meta_kubernetes_endpoints_name: endpoints对象的名称</li></ul><p>对于直接从端点列表中发现的所有目标（不包括由底层pod推断出来的目标），将附加以下标签：</p><ul><li>__meta_kubernetes_endpoint_hostname: 端点的主机名</li><li>__meta_kubernetes_endpoint_node_name: 托管endpoints的节点名称</li><li>__meta_kubernetes_endpoint_ready: 代表endpoint 状态是否就绪，value为true或false。</li><li>__meta_kubernetes_endpoint_port_name: endpoint 端口的名称。</li><li>__meta_kubernetes_endpoint_port_protocol: endpoint 端口的协议。</li><li>__meta_kubernetes_endpoint_address_target_kind: endpoint地址目标的类型，如deployment、DaemonSet等。</li><li>__meta_kubernetes_endpoint_address_target_name: endpoint地址目标的名称。</li></ul><h2 id="_3-0-修改端口" tabindex="-1">3.0 修改端口 <a class="header-anchor" href="#_3-0-修改端口" aria-label="Permalink to &quot;3.0 修改端口&quot;">​</a></h2><p>在 prometheus-config.yaml 一次添加如下采集数据：</p><p>由于环境是采用kubeadm 安装,所以修改静态配置文件在,/etc/kubernetes/manifests/</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[root@kube-master test]# cd /etc/kubernetes/manifests/</span></span>
<span class="line"><span style="color:#e1e4e8;">[root@kube-master manifests]# ls</span></span>
<span class="line"><span style="color:#e1e4e8;">etcd.yaml  kube-apiserver.yaml  kube-controller-manager.yaml  kube-scheduler.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[root@kube-master test]# cd /etc/kubernetes/manifests/</span></span>
<span class="line"><span style="color:#24292e;">[root@kube-master manifests]# ls</span></span>
<span class="line"><span style="color:#24292e;">etcd.yaml  kube-apiserver.yaml  kube-controller-manager.yaml  kube-scheduler.yaml</span></span></code></pre></div><p>直接修改保存,自动重启</p><p><em>prometheus访问监控对象端口</em></p><table><thead><tr><th>端口</th><th>端口对应监控对象</th><th>修订</th></tr></thead><tbody><tr><td>6443</td><td>apiserver</td><td></td></tr><tr><td>8080</td><td>kube-state-metrics( cAdvisor容器性能分析组件 )</td><td></td></tr><tr><td>9090</td><td>prometheus</td><td></td></tr><tr><td>9093</td><td>alertmanager</td><td></td></tr><tr><td>9100</td><td>node-exporter</td><td></td></tr><tr><td>9153</td><td>coredns</td><td></td></tr><tr><td>10249</td><td>kube-proxy</td><td><code>kubectl edit cm/kube-proxy -n kube-system</code></td></tr><tr><td>10250</td><td>kubelet</td><td><a href="https://cloud-atlas.readthedocs.io/zh-cn/latest/kubernetes/monitor/prometheus/prometheus_monitor_kubelet_controller-manager_scheduler.html#prometheus-monitor-kubelet-controller-manager-scheduler" target="_blank" rel="noreferrer">Prometheus监控Kubelet, kube-controller-manager 和 kube-scheduler</a></td></tr><tr><td>10251</td><td>scheduler</td><td><a href="https://cloud-atlas.readthedocs.io/zh-cn/latest/kubernetes/monitor/prometheus/prometheus_monitor_kubelet_controller-manager_scheduler.html#prometheus-monitor-kubelet-controller-manager-scheduler" target="_blank" rel="noreferrer">Prometheus监控Kubelet, kube-controller-manager 和 kube-scheduler</a></td></tr><tr><td>10257</td><td>controller-manager</td><td><a href="https://cloud-atlas.readthedocs.io/zh-cn/latest/kubernetes/monitor/prometheus/prometheus_monitor_kubelet_controller-manager_scheduler.html#prometheus-monitor-kubelet-controller-manager-scheduler" target="_blank" rel="noreferrer">Prometheus监控Kubelet, kube-controller-manager 和 kube-scheduler</a> 从1.22开始端口从10252变成10257</td></tr></tbody></table><p><code>kube-scheduler</code> <em>配置</em> <code>--port=0</code> <em>运行参数则会关闭HTTP访问，也就是无法获取默认的metrics</em>，需要<code>注释</code></p><p>默认只运行127.0.0.1访问,所以把127.0.0.1修改成0.0.0.0</p><h2 id="_3-1-kube-apiserver" tabindex="-1">3.1 kube-apiserver <a class="header-anchor" href="#_3-1-kube-apiserver" aria-label="Permalink to &quot;3.1 kube-apiserver&quot;">​</a></h2><p>需要注意的是使用https访问时，需要tls相关配置，可以指定ca证书路径或者insecure_skip_verify: true 跳过证书验证</p><p>除此之外，还要指定 bearer_token_file ，否则会提示 server returned HTTP status 400 Bad Request ;</p><p><code>kube-apiserver</code> 监听在节点的 6443 端口</p><p>官当<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#" target="_blank" rel="noreferrer">kubernetes_sd_configs</a>的配置</p><ul><li><p>创建采集器</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master prometheus]# kubectl describe svc kubernetes</span></span>
<span class="line"><span style="color:#B392F0;">Name:</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">kubernetes</span></span>
<span class="line"><span style="color:#B392F0;">Namespace:</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">default</span></span>
<span class="line"><span style="color:#B392F0;">Labels:</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">component=apiserver</span></span>
<span class="line"><span style="color:#E1E4E8;">                   provider</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">kubernetes</span></span>
<span class="line"><span style="color:#B392F0;">Annotations:</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">Selector:</span><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">Type:</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">ClusterIP</span></span>
<span class="line"><span style="color:#B392F0;">IP</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Family</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Policy:</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">SingleStack</span></span>
<span class="line"><span style="color:#B392F0;">IP</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Families:</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">IPv4</span></span>
<span class="line"><span style="color:#B392F0;">IP:</span><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.0.1</span></span>
<span class="line"><span style="color:#B392F0;">IPs:</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.0.1</span></span>
<span class="line"><span style="color:#B392F0;">Port:</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">https</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">443</span><span style="color:#9ECBFF;">/TCP</span></span>
<span class="line"><span style="color:#B392F0;">TargetPort:</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">6443</span><span style="color:#9ECBFF;">/TCP</span></span>
<span class="line"><span style="color:#B392F0;">Endpoints:</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">10.103</span><span style="color:#9ECBFF;">.236.201:6443</span></span>
<span class="line"><span style="color:#B392F0;">Session</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Affinity:</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">None</span></span>
<span class="line"><span style="color:#B392F0;">Events:</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master prometheus]# kubectl describe svc kubernetes</span></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">kubernetes</span></span>
<span class="line"><span style="color:#6F42C1;">Namespace:</span><span style="color:#24292E;">         </span><span style="color:#032F62;">default</span></span>
<span class="line"><span style="color:#6F42C1;">Labels:</span><span style="color:#24292E;">            </span><span style="color:#032F62;">component=apiserver</span></span>
<span class="line"><span style="color:#24292E;">                   provider</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">kubernetes</span></span>
<span class="line"><span style="color:#6F42C1;">Annotations:</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Selector:</span><span style="color:#24292E;">          </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Type:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#6F42C1;">IP</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Family</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Policy:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">SingleStack</span></span>
<span class="line"><span style="color:#6F42C1;">IP</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Families:</span><span style="color:#24292E;">       </span><span style="color:#032F62;">IPv4</span></span>
<span class="line"><span style="color:#6F42C1;">IP:</span><span style="color:#24292E;">                </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.0.1</span></span>
<span class="line"><span style="color:#6F42C1;">IPs:</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.0.1</span></span>
<span class="line"><span style="color:#6F42C1;">Port:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">https</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">443</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#6F42C1;">TargetPort:</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">6443</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#6F42C1;">Endpoints:</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">10.103</span><span style="color:#032F62;">.236.201:6443</span></span>
<span class="line"><span style="color:#6F42C1;">Session</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Affinity:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">None</span></span>
<span class="line"><span style="color:#6F42C1;">Events:</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><blockquote><p>根据svc信息可知，apiserver位于default命名空间下，标签为component=apiserver，访问方式为https，端口为6443</p></blockquote></li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-apiserver</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">endpoints</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scheme</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">https</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">tls_config</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ca_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">bearer_token_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_namespace</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">__meta_kubernetes_service_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">default;kubernetes</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_endpoints_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">endpoint</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_pod_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">service</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_namespace</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">namespace</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-apiserver</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">endpoints</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scheme</span><span style="color:#24292E;">: </span><span style="color:#032F62;">https</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">tls_config</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ca_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">bearer_token_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_namespace</span><span style="color:#24292E;">, </span><span style="color:#032F62;">__meta_kubernetes_service_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">default;kubernetes</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_endpoints_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">endpoint</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_pod_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">service</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_namespace</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">namespace</span></span></code></pre></div><h2 id="_3-2-controller-manager" tabindex="-1">3.2 controller-manager <a class="header-anchor" href="#_3-2-controller-manager" aria-label="Permalink to &quot;3.2 controller-manager&quot;">​</a></h2><p><code>kube-controller-manager</code> 监听在节点的 10257 端口</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-controller-manager</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scheme</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">https</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">tls_config</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ca_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">insecure_skip_verify</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">bearer_token_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_pod_label_component</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-controller-manager</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_pod_ip</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">\${1}:10257</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_endpoints_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">endpoint</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_pod_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">service</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_namespace</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">namespace</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-controller-manager</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scheme</span><span style="color:#24292E;">: </span><span style="color:#032F62;">https</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">tls_config</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ca_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">insecure_skip_verify</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">bearer_token_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_pod_label_component</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-controller-manager</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_pod_ip</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">(.+)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">\${1}:10257</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_endpoints_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">endpoint</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_pod_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">service</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_namespace</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">namespace</span></span></code></pre></div><h2 id="_3-3-kube-scheduler" tabindex="-1">3.3 kube-scheduler <a class="header-anchor" href="#_3-3-kube-scheduler" aria-label="Permalink to &quot;3.3 kube-scheduler&quot;">​</a></h2><p><code>kube-scheduler</code> 监听在节点的 10251 端口</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-scheduler</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">bearer_token_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_pod_label_component</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-scheduler</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_pod_ip</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">\${1}:10251</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_endpoints_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">endpoint</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_pod_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">service</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_namespace</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">namespace</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-scheduler</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">bearer_token_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_pod_label_component</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-scheduler</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_pod_ip</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">(.+)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">\${1}:10251</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_endpoints_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">endpoint</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_pod_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">service</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_namespace</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">namespace</span></span></code></pre></div><h2 id="_3-4-coredns" tabindex="-1">3.4 coredns <a class="header-anchor" href="#_3-4-coredns" aria-label="Permalink to &quot;3.4 coredns&quot;">​</a></h2><ul><li>查看coredns资源详情</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master prometheus]# kubectl describe svc -n kube-system kube-dns</span></span>
<span class="line"><span style="color:#B392F0;">Name:</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">kube-dns</span></span>
<span class="line"><span style="color:#B392F0;">Namespace:</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"><span style="color:#B392F0;">Labels:</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">k8s-app=kube-dns</span></span>
<span class="line"><span style="color:#E1E4E8;">                   </span><span style="color:#B392F0;">kubernetes.io/cluster-service</span><span style="color:#E1E4E8;">=</span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">                   </span><span style="color:#B392F0;">kubernetes.io/name</span><span style="color:#E1E4E8;">=CoreDNS</span></span>
<span class="line"><span style="color:#B392F0;">Annotations:</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">prometheus.io/port:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">9153</span></span>
<span class="line"><span style="color:#E1E4E8;">                   </span><span style="color:#B392F0;">prometheus.io/scrape:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#B392F0;">Selector:</span><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">k8s-app=kube-dns</span></span>
<span class="line"><span style="color:#B392F0;">Type:</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">ClusterIP</span></span>
<span class="line"><span style="color:#B392F0;">IP</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Family</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Policy:</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">SingleStack</span></span>
<span class="line"><span style="color:#B392F0;">IP</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Families:</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">IPv4</span></span>
<span class="line"><span style="color:#B392F0;">IP:</span><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.0.10</span></span>
<span class="line"><span style="color:#B392F0;">IPs:</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.0.10</span></span>
<span class="line"><span style="color:#B392F0;">Port:</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">dns</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">53</span><span style="color:#9ECBFF;">/UDP</span></span>
<span class="line"><span style="color:#B392F0;">TargetPort:</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">53</span><span style="color:#9ECBFF;">/UDP</span></span>
<span class="line"><span style="color:#B392F0;">Endpoints:</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">172.25</span><span style="color:#9ECBFF;">.244.198:53,172.25.244.202:53</span></span>
<span class="line"><span style="color:#B392F0;">Port:</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">dns-tcp</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">53</span><span style="color:#9ECBFF;">/TCP</span></span>
<span class="line"><span style="color:#B392F0;">TargetPort:</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">53</span><span style="color:#9ECBFF;">/TCP</span></span>
<span class="line"><span style="color:#B392F0;">Endpoints:</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">172.25</span><span style="color:#9ECBFF;">.244.198:53,172.25.244.202:53</span></span>
<span class="line"><span style="color:#B392F0;">Port:</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">metrics</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">9153</span><span style="color:#9ECBFF;">/TCP</span></span>
<span class="line"><span style="color:#B392F0;">TargetPort:</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">9153</span><span style="color:#9ECBFF;">/TCP</span></span>
<span class="line"><span style="color:#B392F0;">Endpoints:</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">172.25</span><span style="color:#9ECBFF;">.244.198:9153,172.25.244.202:9153</span></span>
<span class="line"><span style="color:#B392F0;">Session</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Affinity:</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">None</span></span>
<span class="line"><span style="color:#B392F0;">Events:</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master prometheus]# kubectl describe svc -n kube-system kube-dns</span></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">kube-dns</span></span>
<span class="line"><span style="color:#6F42C1;">Namespace:</span><span style="color:#24292E;">         </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"><span style="color:#6F42C1;">Labels:</span><span style="color:#24292E;">            </span><span style="color:#032F62;">k8s-app=kube-dns</span></span>
<span class="line"><span style="color:#24292E;">                   </span><span style="color:#6F42C1;">kubernetes.io/cluster-service</span><span style="color:#24292E;">=</span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">                   </span><span style="color:#6F42C1;">kubernetes.io/name</span><span style="color:#24292E;">=CoreDNS</span></span>
<span class="line"><span style="color:#6F42C1;">Annotations:</span><span style="color:#24292E;">       </span><span style="color:#032F62;">prometheus.io/port:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9153</span></span>
<span class="line"><span style="color:#24292E;">                   </span><span style="color:#6F42C1;">prometheus.io/scrape:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#6F42C1;">Selector:</span><span style="color:#24292E;">          </span><span style="color:#032F62;">k8s-app=kube-dns</span></span>
<span class="line"><span style="color:#6F42C1;">Type:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#6F42C1;">IP</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Family</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Policy:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">SingleStack</span></span>
<span class="line"><span style="color:#6F42C1;">IP</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Families:</span><span style="color:#24292E;">       </span><span style="color:#032F62;">IPv4</span></span>
<span class="line"><span style="color:#6F42C1;">IP:</span><span style="color:#24292E;">                </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.0.10</span></span>
<span class="line"><span style="color:#6F42C1;">IPs:</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.0.10</span></span>
<span class="line"><span style="color:#6F42C1;">Port:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">dns</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">53</span><span style="color:#032F62;">/UDP</span></span>
<span class="line"><span style="color:#6F42C1;">TargetPort:</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">53</span><span style="color:#032F62;">/UDP</span></span>
<span class="line"><span style="color:#6F42C1;">Endpoints:</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">172.25</span><span style="color:#032F62;">.244.198:53,172.25.244.202:53</span></span>
<span class="line"><span style="color:#6F42C1;">Port:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">dns-tcp</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">53</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#6F42C1;">TargetPort:</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">53</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#6F42C1;">Endpoints:</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">172.25</span><span style="color:#032F62;">.244.198:53,172.25.244.202:53</span></span>
<span class="line"><span style="color:#6F42C1;">Port:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">metrics</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">9153</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#6F42C1;">TargetPort:</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">9153</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#6F42C1;">Endpoints:</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">172.25</span><span style="color:#032F62;">.244.198:9153,172.25.244.202:9153</span></span>
<span class="line"><span style="color:#6F42C1;">Session</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Affinity:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">None</span></span>
<span class="line"><span style="color:#6F42C1;">Events:</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><blockquote><p>匹配pod对象，lable标签为component=kube-scheduler即可</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[root@kube-master test]#  kubectl get services -n kube-system</span></span>
<span class="line"><span style="color:#e1e4e8;">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                  AGE</span></span>
<span class="line"><span style="color:#e1e4e8;">calico-typha              ClusterIP   192.168.110.47   &lt;none&gt;        5473/TCP                 77d</span></span>
<span class="line"><span style="color:#e1e4e8;">kube-controller-manager   ClusterIP   None             &lt;none&gt;        10257/TCP                5h10m</span></span>
<span class="line"><span style="color:#e1e4e8;">kube-dns                  ClusterIP   192.168.0.10     &lt;none&gt;        53/UDP,53/TCP,9153/TCP   78d</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">bash-5.1# curl kube-dns.kube-system.svc:9153/metrics</span></span>
<span class="line"><span style="color:#e1e4e8;"># HELP coredns_build_info A metric with a constant &#39;1&#39; value labeled by version, revision, and goversion from which CoreDNS was built.</span></span>
<span class="line"><span style="color:#e1e4e8;"># TYPE coredns_build_info gauge</span></span>
<span class="line"><span style="color:#e1e4e8;">coredns_build_info{goversion=&quot;go1.17.1&quot;,revision=&quot;13a9191&quot;,version=&quot;1.8.6&quot;} 1</span></span>
<span class="line"><span style="color:#e1e4e8;"># HELP coredns_cache_entries The number of elements in the cache.</span></span>
<span class="line"><span style="color:#e1e4e8;"># TYPE coredns_cache_entries gauge</span></span>
<span class="line"><span style="color:#e1e4e8;">coredns_cache_entries{server=&quot;dns://:53&quot;,type=&quot;denial&quot;} 333</span></span>
<span class="line"><span style="color:#e1e4e8;">coredns_cache_entries{server=&quot;dns://:53&quot;,type=&quot;success&quot;} 63</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[root@kube-master test]#  kubectl get services -n kube-system</span></span>
<span class="line"><span style="color:#24292e;">NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                  AGE</span></span>
<span class="line"><span style="color:#24292e;">calico-typha              ClusterIP   192.168.110.47   &lt;none&gt;        5473/TCP                 77d</span></span>
<span class="line"><span style="color:#24292e;">kube-controller-manager   ClusterIP   None             &lt;none&gt;        10257/TCP                5h10m</span></span>
<span class="line"><span style="color:#24292e;">kube-dns                  ClusterIP   192.168.0.10     &lt;none&gt;        53/UDP,53/TCP,9153/TCP   78d</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">bash-5.1# curl kube-dns.kube-system.svc:9153/metrics</span></span>
<span class="line"><span style="color:#24292e;"># HELP coredns_build_info A metric with a constant &#39;1&#39; value labeled by version, revision, and goversion from which CoreDNS was built.</span></span>
<span class="line"><span style="color:#24292e;"># TYPE coredns_build_info gauge</span></span>
<span class="line"><span style="color:#24292e;">coredns_build_info{goversion=&quot;go1.17.1&quot;,revision=&quot;13a9191&quot;,version=&quot;1.8.6&quot;} 1</span></span>
<span class="line"><span style="color:#24292e;"># HELP coredns_cache_entries The number of elements in the cache.</span></span>
<span class="line"><span style="color:#24292e;"># TYPE coredns_cache_entries gauge</span></span>
<span class="line"><span style="color:#24292e;">coredns_cache_entries{server=&quot;dns://:53&quot;,type=&quot;denial&quot;} 333</span></span>
<span class="line"><span style="color:#24292e;">coredns_cache_entries{server=&quot;dns://:53&quot;,type=&quot;success&quot;} 63</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">coredns</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">endpoints</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">__meta_kubernetes_service_label_k8s_app</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-dns</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_pod_ip</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">\${1}:9153</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_endpoints_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">endpoint</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_pod_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">service</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_namespace</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">namespace</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">coredns</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">endpoints</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">__meta_kubernetes_service_label_k8s_app</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-dns</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_pod_ip</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">(.+)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">\${1}:9153</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_endpoints_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">endpoint</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_pod_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">service</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_namespace</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">namespace</span></span></code></pre></div><h2 id="_3-5-etcd" tabindex="-1">3.5 etcd <a class="header-anchor" href="#_3-5-etcd" aria-label="Permalink to &quot;3.5 etcd&quot;">​</a></h2><ul><li>查看scheduler资源详情</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master prometheus]# kubectl describe pod -n kube-system etcd-k8s-master01</span></span>
<span class="line"><span style="color:#B392F0;">Name:</span><span style="color:#E1E4E8;">                 </span><span style="color:#9ECBFF;">etcd-k8s-master01</span></span>
<span class="line"><span style="color:#B392F0;">Namespace:</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"><span style="color:#B392F0;">Priority:</span><span style="color:#E1E4E8;">             </span><span style="color:#79B8FF;">2000001000</span></span>
<span class="line"><span style="color:#B392F0;">Priority</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Class</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Name:</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">system-node-critical</span></span>
<span class="line"><span style="color:#B392F0;">Node:</span><span style="color:#E1E4E8;">                 </span><span style="color:#9ECBFF;">k8s-master01/10.103.236.201</span></span>
<span class="line"><span style="color:#B392F0;">Start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Time:</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">Sun,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Jun</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2024</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">09</span><span style="color:#9ECBFF;">:03:01</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+0800</span></span>
<span class="line"><span style="color:#B392F0;">Labels:</span><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">component=etcd</span></span>
<span class="line"><span style="color:#E1E4E8;">                      tier</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">control-plane</span></span>
<span class="line"><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Command:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">etcd</span></span>
<span class="line"><span style="color:#E1E4E8;">      --advertise-client-urls</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">https://10.103.236.201:2379</span></span>
<span class="line"><span style="color:#E1E4E8;">      --cert-file</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/server.crt</span></span>
<span class="line"><span style="color:#E1E4E8;">      --client-cert-auth</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      --data-dir</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/var/lib/etcd</span></span>
<span class="line"><span style="color:#E1E4E8;">      --experimental-initial-corrupt-check</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      --initial-advertise-peer-urls</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">https://10.103.236.201:2380</span></span>
<span class="line"><span style="color:#E1E4E8;">      --initial-cluster</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">k8s-master01=https://10.103.236.201:2380</span></span>
<span class="line"><span style="color:#E1E4E8;">      --key-file</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/server.key</span></span>
<span class="line"><span style="color:#E1E4E8;">      --listen-client-urls</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">https://127.0.0.1:2379,https://10.103.236.201:2379</span></span>
<span class="line"><span style="color:#E1E4E8;">      --listen-metrics-urls</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">http://0.0.0.0:2381</span></span>
<span class="line"><span style="color:#E1E4E8;">      --listen-peer-urls</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">https://10.103.236.201:2380</span></span>
<span class="line"><span style="color:#E1E4E8;">      --name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">k8s-master01</span></span>
<span class="line"><span style="color:#E1E4E8;">      --peer-cert-file</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/peer.crt</span></span>
<span class="line"><span style="color:#E1E4E8;">      --peer-client-cert-auth</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      --peer-key-file</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/peer.key</span></span>
<span class="line"><span style="color:#E1E4E8;">      --peer-trusted-ca-file</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/ca.crt</span></span>
<span class="line"><span style="color:#E1E4E8;">      --snapshot-count</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10000</span></span>
<span class="line"><span style="color:#E1E4E8;">      --trusted-ca-file</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/kubernetes/pki/etcd/ca.crt</span></span>
<span class="line"><span style="color:#79B8FF;">...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master prometheus]# kubectl describe pod -n kube-system etcd-k8s-master01</span></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">etcd-k8s-master01</span></span>
<span class="line"><span style="color:#6F42C1;">Namespace:</span><span style="color:#24292E;">            </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"><span style="color:#6F42C1;">Priority:</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">2000001000</span></span>
<span class="line"><span style="color:#6F42C1;">Priority</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Class</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Name:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">system-node-critical</span></span>
<span class="line"><span style="color:#6F42C1;">Node:</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">k8s-master01/10.103.236.201</span></span>
<span class="line"><span style="color:#6F42C1;">Start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Time:</span><span style="color:#24292E;">           </span><span style="color:#032F62;">Sun,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Jun</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2024</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">09</span><span style="color:#032F62;">:03:01</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+0800</span></span>
<span class="line"><span style="color:#6F42C1;">Labels:</span><span style="color:#24292E;">               </span><span style="color:#032F62;">component=etcd</span></span>
<span class="line"><span style="color:#24292E;">                      tier</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">control-plane</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Command:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">etcd</span></span>
<span class="line"><span style="color:#24292E;">      --advertise-client-urls</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">https://10.103.236.201:2379</span></span>
<span class="line"><span style="color:#24292E;">      --cert-file</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/server.crt</span></span>
<span class="line"><span style="color:#24292E;">      --client-cert-auth</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      --data-dir</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/var/lib/etcd</span></span>
<span class="line"><span style="color:#24292E;">      --experimental-initial-corrupt-check</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      --initial-advertise-peer-urls</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">https://10.103.236.201:2380</span></span>
<span class="line"><span style="color:#24292E;">      --initial-cluster</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">k8s-master01=https://10.103.236.201:2380</span></span>
<span class="line"><span style="color:#24292E;">      --key-file</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/server.key</span></span>
<span class="line"><span style="color:#24292E;">      --listen-client-urls</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">https://127.0.0.1:2379,https://10.103.236.201:2379</span></span>
<span class="line"><span style="color:#24292E;">      --listen-metrics-urls</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">http://0.0.0.0:2381</span></span>
<span class="line"><span style="color:#24292E;">      --listen-peer-urls</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">https://10.103.236.201:2380</span></span>
<span class="line"><span style="color:#24292E;">      --name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">k8s-master01</span></span>
<span class="line"><span style="color:#24292E;">      --peer-cert-file</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/peer.crt</span></span>
<span class="line"><span style="color:#24292E;">      --peer-client-cert-auth</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      --peer-key-file</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/peer.key</span></span>
<span class="line"><span style="color:#24292E;">      --peer-trusted-ca-file</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/ca.crt</span></span>
<span class="line"><span style="color:#24292E;">      --snapshot-count</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10000</span></span>
<span class="line"><span style="color:#24292E;">      --trusted-ca-file</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/kubernetes/pki/etcd/ca.crt</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span></code></pre></div><blockquote><p>由上可知，启动参数里面有一个 --listen-metrics-urls=<a href="http://127.0.0.1:2381" target="_blank" rel="noreferrer">http://127.0.0.1:2381</a> 的配置，该参数就是来指定 Metrics 接口运行在 2381 端口下面的，而且是 http 的协议，所以也不需要什么证书配置，这就比以前的版本要简单许多了，以前的版本需要用 https 协议访问，所以要配置对应的证书。但是还需修改配置文件，地址改为0.0.0.0</p></blockquote><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#9ECBFF;">__meta_kubernetes_pod_label_component</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">etcd</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_pod_ip</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">\${1}:2381</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_endpoints_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">endpoint</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_pod_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_namespace</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">namespace</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#032F62;">__meta_kubernetes_pod_label_component</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">etcd</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_pod_ip</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">(.+)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">\${1}:2381</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_endpoints_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">endpoint</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_pod_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_namespace</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">namespace</span></span></code></pre></div><h2 id="_3-6-kube-state-metrics" tabindex="-1">3.6 kube-state-metrics <a class="header-anchor" href="#_3-6-kube-state-metrics" aria-label="Permalink to &quot;3.6 kube-state-metrics&quot;">​</a></h2><p>编写prometheus配置文件，需要注意的是，他默认匹配到的是8080和801两个端 口，需要手动指定为8080端口;</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">endpoints</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-state-metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_pod_ip</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">\${1}:8080</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_endpoints_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">endpoint</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_pod_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">service</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_namespace</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">namespace</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">endpoints</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-state-metrics</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_pod_ip</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">(.+)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">\${1}:8080</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_endpoints_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">endpoint</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_pod_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">service</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_namespace</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">namespace</span></span></code></pre></div><p>部分参数介绍:</p><ul><li>kubernetes_sd_configs: 设置发现模式为 Kubernetes 动态服务发现</li><li>kubernetes_sd_configs.role:指定Kubernetes 的服务发现模式，这里设置为endpoints 的服务发现模式，该模式下会调用kube-apiserver 中的接口获取指标数据。并且还限定只获取 kube-state-metrics 所在-Namespace 的空间 kube-system 中的 Endpoints 信息</li><li>kubernetes_sd_configs.namespace:指定只在配置的 Namespace 中进行endpoints 服务发现</li><li>relabel_configs:用于对采集的标签进行重新标记</li></ul><p>热加载prometheus，使configmap配置文件生效（也可以等待prometheus的自动热加载）：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-XPOST</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-XPOST</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre></div><h2 id="_3-7-kube-proxy" tabindex="-1">3.7 kube-proxy <a class="header-anchor" href="#_3-7-kube-proxy" aria-label="Permalink to &quot;3.7 kube-proxy&quot;">​</a></h2><p>Kube-Proxy 默认暴露两个端口，10249用于暴露监控指标，在 /metrics 接口吐出 Prometheus 协议的监控数据</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl edit cm/kube-proxy -n kube-system</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">metricsBindAddress: &quot;0.0.0.0:10249&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl edit cm/kube-proxy -n kube-system</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">metricsBindAddress: &quot;0.0.0.0:10249&quot;</span></span></code></pre></div><ul><li>重启pod</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--force</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get pod </span><span style="color:#79B8FF;">-n</span><span style="color:#9ECBFF;"> kube-system </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> kube-proxy </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">awk</span><span style="color:#9ECBFF;"> &#39;{print $1}&#39;\`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">或者</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-l</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-app=kube-proxy</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--force</span><span style="color:#24292E;"> </span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">kubectl</span><span style="color:#032F62;"> get pod </span><span style="color:#005CC5;">-n</span><span style="color:#032F62;"> kube-system </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> kube-proxy </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">awk</span><span style="color:#032F62;"> &#39;{print $1}&#39;\`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">或者</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-l</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-app=kube-proxy</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system</span></span></code></pre></div><ul><li>验证</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master test]# curl -s http://localhost:10249/metrics </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">head</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># HELP apiserver_audit_event_total [ALPHA] Counter of audit events generated and sent to the audit backend.</span></span>
<span class="line"><span style="color:#6A737D;"># TYPE apiserver_audit_event_total counter</span></span>
<span class="line"><span style="color:#B392F0;">apiserver_audit_event_total</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#6A737D;"># HELP apiserver_audit_requests_rejected_total [ALPHA] Counter of apiserver requests rejected due to an error in audit logging backend.</span></span>
<span class="line"><span style="color:#6A737D;"># TYPE apiserver_audit_requests_rejected_total counter</span></span>
<span class="line"><span style="color:#B392F0;">apiserver_audit_requests_rejected_total</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#6A737D;"># HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.</span></span>
<span class="line"><span style="color:#6A737D;"># TYPE go_gc_duration_seconds summary</span></span>
<span class="line"><span style="color:#B392F0;">go_gc_duration_seconds</span><span style="color:#E1E4E8;">{quantile=</span><span style="color:#B392F0;">&quot;0&quot;</span><span style="color:#B392F0;">}</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3.2952</span><span style="color:#9ECBFF;">e-05</span></span>
<span class="line"><span style="color:#B392F0;">go_gc_duration_seconds</span><span style="color:#E1E4E8;">{quantile=</span><span style="color:#B392F0;">&quot;0.25&quot;</span><span style="color:#B392F0;">}</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4.5446</span><span style="color:#9ECBFF;">e-05</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master test]# curl -s http://localhost:10249/metrics </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">head</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># HELP apiserver_audit_event_total [ALPHA] Counter of audit events generated and sent to the audit backend.</span></span>
<span class="line"><span style="color:#6A737D;"># TYPE apiserver_audit_event_total counter</span></span>
<span class="line"><span style="color:#6F42C1;">apiserver_audit_event_total</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6A737D;"># HELP apiserver_audit_requests_rejected_total [ALPHA] Counter of apiserver requests rejected due to an error in audit logging backend.</span></span>
<span class="line"><span style="color:#6A737D;"># TYPE apiserver_audit_requests_rejected_total counter</span></span>
<span class="line"><span style="color:#6F42C1;">apiserver_audit_requests_rejected_total</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6A737D;"># HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.</span></span>
<span class="line"><span style="color:#6A737D;"># TYPE go_gc_duration_seconds summary</span></span>
<span class="line"><span style="color:#6F42C1;">go_gc_duration_seconds</span><span style="color:#24292E;">{quantile=</span><span style="color:#6F42C1;">&quot;0&quot;</span><span style="color:#6F42C1;">}</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3.2952</span><span style="color:#032F62;">e-05</span></span>
<span class="line"><span style="color:#6F42C1;">go_gc_duration_seconds</span><span style="color:#24292E;">{quantile=</span><span style="color:#6F42C1;">&quot;0.25&quot;</span><span style="color:#6F42C1;">}</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4.5446</span><span style="color:#032F62;">e-05</span></span></code></pre></div><p>10256 端口作为健康检查的端口，使用 /healthz 接口做健康检查，请求之后返回两个时间信息：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master test]# curl -s http://localhost:10256/healthz </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">jq</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">&quot;lastUpdated&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;2024-06-27 09:49:35.832247962 +0000 UTC m=+3005.426431913&quot;,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">&quot;currentTime&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;2024-06-27 09:49:35.832247962 +0000 UTC m=+3005.426431913&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master test]# curl -s http://localhost:10256/healthz </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">jq</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">&quot;lastUpdated&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;2024-06-27 09:49:35.832247962 +0000 UTC m=+3005.426431913&quot;,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">&quot;currentTime&quot;</span><span style="color:#005CC5;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;2024-06-27 09:49:35.832247962 +0000 UTC m=+3005.426431913&quot;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li>为 <code>kube-proxy</code> 创建 <code>service</code></li></ul><p>kube-proxy-svc.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-proxy</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-proxy</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterIP</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">clusterIP</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">None</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#设置为None，不分配Service IP</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-proxy-metrics-port</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10249</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10249</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-proxy</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-proxy</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">clusterIP</span><span style="color:#24292E;">: </span><span style="color:#032F62;">None</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">#设置为None，不分配Service IP</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-proxy-metrics-port</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10249</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10249</span></span></code></pre></div><ul><li>创建采集器</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;kube-proxy&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metrics</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scheme</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">tls_config</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ca_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">insecure_skip_verify</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">bearer_token_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">endpoints</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-proxy</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">labelmap</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__meta_kubernetes_pod_label_(.+)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;kube-proxy&#39;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metrics</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scheme</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">tls_config</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ca_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">insecure_skip_verify</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">bearer_token_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">endpoints</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-proxy</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">labelmap</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__meta_kubernetes_pod_label_(.+)</span></span></code></pre></div><ul><li>热加载prometheus，使configmap配置文件生效（也可以等待prometheus的自动热加载）：</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">curl -XPOST http://prometheus.ikubernetes.net/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">curl -XPOST http://prometheus.ikubernetes.net/-/reload</span></span></code></pre></div><h1 id="_4-cadvisor" tabindex="-1">4. cAdvisor <a class="header-anchor" href="#_4-cadvisor" aria-label="Permalink to &quot;4. cAdvisor&quot;">​</a></h1><p>cAdvisor 主要功能：</p><p>1.对容器资源的使用情况和性能进行监控。它以守护进程方式运行，用于收集、聚合、处理和导出正在运行容器的有关信息。</p><p>2.cAdvisor 本身就对 Docker 容器支持，并且还对其它类型的容器尽可能的提供支持，力求兼容与适配所有类型的容器。</p><p>3.Kubernetes 已经默认将其与 Kubelet 融合，所以我们无需再单独部署 cAdvisor 组件来暴露节点中容器运行的信息。</p><h2 id="_4-1-kubelet" tabindex="-1">4.1 kubelet <a class="header-anchor" href="#_4-1-kubelet" aria-label="Permalink to &quot;4.1 kubelet&quot;">​</a></h2><ul><li>查看kubelet资源详情</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master prometheus]# ss -tunlp </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet</span></span>
<span class="line"><span style="color:#B392F0;">tcp</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">LISTEN</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1:37839</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">*</span><span style="color:#9ECBFF;">:</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;">                   </span><span style="color:#9ECBFF;">users:</span><span style="color:#E1E4E8;">((&quot;kubelet&quot;</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;">pid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1178</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;">fd</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#B392F0;">tcp</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">LISTEN</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1:10248</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">*</span><span style="color:#9ECBFF;">:</span><span style="color:#79B8FF;">*</span><span style="color:#E1E4E8;">                   </span><span style="color:#9ECBFF;">users:</span><span style="color:#E1E4E8;">((&quot;kubelet&quot;</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;">pid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1178</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;">fd</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">31</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#B392F0;">tcp</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">LISTEN</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">16384</span><span style="color:#E1E4E8;">  [::]:10250              [::]:</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">                   users:((&quot;kubelet&quot;</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;">pid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1178</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;">fd</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">26</span><span style="color:#E1E4E8;">))</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master prometheus]# ss -tunlp </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet</span></span>
<span class="line"><span style="color:#6F42C1;">tcp</span><span style="color:#24292E;">    </span><span style="color:#032F62;">LISTEN</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1:37839</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">*</span><span style="color:#032F62;">:</span><span style="color:#005CC5;">*</span><span style="color:#24292E;">                   </span><span style="color:#032F62;">users:</span><span style="color:#24292E;">((&quot;kubelet&quot;</span><span style="color:#D73A49;">,</span><span style="color:#24292E;">pid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1178</span><span style="color:#D73A49;">,</span><span style="color:#24292E;">fd</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">15</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#6F42C1;">tcp</span><span style="color:#24292E;">    </span><span style="color:#032F62;">LISTEN</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1:10248</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">*</span><span style="color:#032F62;">:</span><span style="color:#005CC5;">*</span><span style="color:#24292E;">                   </span><span style="color:#032F62;">users:</span><span style="color:#24292E;">((&quot;kubelet&quot;</span><span style="color:#D73A49;">,</span><span style="color:#24292E;">pid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1178</span><span style="color:#D73A49;">,</span><span style="color:#24292E;">fd</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">31</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#6F42C1;">tcp</span><span style="color:#24292E;">    </span><span style="color:#032F62;">LISTEN</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">16384</span><span style="color:#24292E;">  [::]:10250              [::]:</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">                   users:((&quot;kubelet&quot;</span><span style="color:#D73A49;">,</span><span style="color:#24292E;">pid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1178</span><span style="color:#D73A49;">,</span><span style="color:#24292E;">fd</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">26</span><span style="color:#24292E;">))</span></span></code></pre></div><blockquote><p>kubelet在每个node节点都有运行，端口为10250，因此role使用node即可</p></blockquote><p>由于 Kubelet 中已经默认集成 cAdvisor 组件，所以无需部署该组件。需要注意的是，他的指标采集地址为 /metrics/cadvisor ，需要配置https访问，可以设置insecure_skip_verify: true 跳过证书验证;</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubelet</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">metrics_path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/metrics/cadvisor</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">scheme</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">https</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">tls_config</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">insecure_skip_verify</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">bearer_token_file</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">labelmap</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__meta_kubernetes_node_label_(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_endpoints_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">endpoint</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_pod_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_namespace</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">namespace</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubelet</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">metrics_path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/metrics/cadvisor</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">scheme</span><span style="color:#24292E;">: </span><span style="color:#032F62;">https</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">tls_config</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">insecure_skip_verify</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">bearer_token_file</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">labelmap</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__meta_kubernetes_node_label_(.+)</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_endpoints_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">endpoint</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_pod_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_namespace</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">namespace</span></span></code></pre></div><p>热加载prometheus，使configmap配置文件生效：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-XPOST</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-XPOST</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://prometheus.ikubernetes.net/-/reload</span></span></code></pre></div><h1 id="_5-node-exporter" tabindex="-1">5. node-exporter <a class="header-anchor" href="#_5-node-exporter" aria-label="Permalink to &quot;5. node-exporter&quot;">​</a></h1><p>Node Exporter 是 Prometheus 官方提供的一个节点资源采集组件，可以用于收集服务器节点的数据，如 CPU频率信息、磁盘IO统计、剩余可用内存等。</p><p>由于是针对所有K8S-node节点，使用DaemonSet这种方式；</p><p>node-exporter.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">DaemonSet</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node-exporter</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">hostPID</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">hostIPC</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">hostNetwork</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">#image: prom/node-exporter:latest</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/node-exporter:latest</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9100</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">requests</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">0.15</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">securityContext</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">privileged</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">args</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">--path.procfs</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">/host/proc</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">--path.sysfs</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">/host/sys</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">--collector.filesystem.ignored-mount-points</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">&#39;&quot;^/(sys|proc|dev|host|etc)($|/)&quot;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dev</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/host/dev</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">proc</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/host/proc</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">sys</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/host/sys</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rootfs</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/rootfs</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">tolerations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;node-role.kubernetes.io/master&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Exists&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">effect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;NoSchedule&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">proc</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">hostPath</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/proc</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dev</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">hostPath</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/dev</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">sys</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">hostPath</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/sys</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">rootfs</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">hostPath</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">DaemonSet</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node-exporter</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node-exporter</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node-exporter</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node-exporter</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">hostPID</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">hostIPC</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">hostNetwork</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node-exporter</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">#image: prom/node-exporter:latest</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/node-exporter:latest</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9100</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">0.15</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">securityContext</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">privileged</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">args</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">--path.procfs</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">/host/proc</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">--path.sysfs</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">/host/sys</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">--collector.filesystem.ignored-mount-points</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">&#39;&quot;^/(sys|proc|dev|host|etc)($|/)&quot;&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/host/dev</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">proc</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/host/proc</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">sys</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/host/sys</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rootfs</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/rootfs</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">tolerations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;node-role.kubernetes.io/master&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Exists&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">effect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;NoSchedule&quot;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">proc</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">hostPath</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/proc</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">hostPath</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/dev</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">sys</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">hostPath</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/sys</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">rootfs</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">hostPath</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/</span></span></code></pre></div><ul><li>创建</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl apply -f node-exporter.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl apply -f node-exporter.yaml</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master Prometheus]# kubectl get pod -nmonitor</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                  </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">node-exporter-bbtbp</span><span style="color:#E1E4E8;">                   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">47</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">node-exporter-lhg62</span><span style="color:#E1E4E8;">                   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">47</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">node-exporter-ll2lb</span><span style="color:#E1E4E8;">                   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">47</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">node-exporter-xhfpq</span><span style="color:#E1E4E8;">                   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">47</span><span style="color:#9ECBFF;">m</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master Prometheus]# kubectl get pod -nmonitor</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                  </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">        </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">node-exporter-bbtbp</span><span style="color:#24292E;">                   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">47</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">node-exporter-lhg62</span><span style="color:#24292E;">                   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">47</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">node-exporter-ll2lb</span><span style="color:#24292E;">                   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">47</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">node-exporter-xhfpq</span><span style="color:#24292E;">                   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">47</span><span style="color:#032F62;">m</span></span></code></pre></div><ul><li>验证</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localhost:9100/metrics</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cpu</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master Prometheus]# curl localhost:9100/metrics </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cpu</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">%</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Total</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">%</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Received</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">%</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Xferd</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Average</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Speed</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Time</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Time</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Time</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Current</span></span>
<span class="line"><span style="color:#E1E4E8;">                                 </span><span style="color:#B392F0;">Dload</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Upload</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Total</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Spent</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Left</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Speed</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">0</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--:--:--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--:--:--</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--:--:--</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">#</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">HELP</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node_cpu_guest_seconds_total</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Seconds</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CPUs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">spent</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">guests</span><span style="color:#E1E4E8;"> (VMs) </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> each mode.</span></span>
<span class="line"><span style="color:#6A737D;"># TYPE node_cpu_guest_seconds_total counter</span></span>
<span class="line"><span style="color:#B392F0;">node_cpu_guest_seconds_total</span><span style="color:#E1E4E8;">{cpu=</span><span style="color:#B392F0;">&quot;0&quot;</span><span style="color:#B392F0;">,mode</span><span style="color:#E1E4E8;">=</span><span style="color:#B392F0;">&quot;nice&quot;</span><span style="color:#B392F0;">}</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">node_cpu_guest_seconds_total</span><span style="color:#E1E4E8;">{cpu=</span><span style="color:#B392F0;">&quot;0&quot;</span><span style="color:#B392F0;">,mode</span><span style="color:#E1E4E8;">=</span><span style="color:#B392F0;">&quot;user&quot;</span><span style="color:#B392F0;">}</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">node_cpu_guest_seconds_total</span><span style="color:#E1E4E8;">{cpu=</span><span style="color:#B392F0;">&quot;1&quot;</span><span style="color:#B392F0;">,mode</span><span style="color:#E1E4E8;">=</span><span style="color:#B392F0;">&quot;nice&quot;</span><span style="color:#B392F0;">}</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">node_cpu_guest_seconds_total</span><span style="color:#E1E4E8;">{cpu=</span><span style="color:#B392F0;">&quot;1&quot;</span><span style="color:#B392F0;">,mode</span><span style="color:#E1E4E8;">=</span><span style="color:#B392F0;">&quot;user&quot;</span><span style="color:#B392F0;">}</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#6A737D;"># HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.</span></span>
<span class="line"><span style="color:#6A737D;"># TYPE node_cpu_seconds_total counter</span></span>
<span class="line"><span style="color:#B392F0;">node_cpu_seconds_total</span><span style="color:#E1E4E8;">{cpu=</span><span style="color:#B392F0;">&quot;0&quot;</span><span style="color:#B392F0;">,mode</span><span style="color:#E1E4E8;">=</span><span style="color:#B392F0;">&quot;idle&quot;</span><span style="color:#B392F0;">}</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">21715.6</span></span>
<span class="line"><span style="color:#B392F0;">node_cpu_seconds_total</span><span style="color:#E1E4E8;">{cpu=</span><span style="color:#B392F0;">&quot;0&quot;</span><span style="color:#B392F0;">,mode</span><span style="color:#E1E4E8;">=</span><span style="color:#B392F0;">&quot;iowait&quot;</span><span style="color:#B392F0;">}</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3.48</span></span>
<span class="line"><span style="color:#B392F0;">node_cpu_seconds_total</span><span style="color:#E1E4E8;">{cpu=</span><span style="color:#B392F0;">&quot;0&quot;</span><span style="color:#B392F0;">,mode</span><span style="color:#E1E4E8;">=</span><span style="color:#B392F0;">&quot;irq&quot;</span><span style="color:#B392F0;">}</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localhost:9100/metrics</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cpu</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master Prometheus]# curl localhost:9100/metrics </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cpu</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">%</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Total</span><span style="color:#24292E;">    </span><span style="color:#032F62;">%</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Received</span><span style="color:#24292E;"> </span><span style="color:#032F62;">%</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Xferd</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Average</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Speed</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Time</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Time</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Time</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Current</span></span>
<span class="line"><span style="color:#24292E;">                                 </span><span style="color:#6F42C1;">Dload</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Upload</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Total</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Spent</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Left</span><span style="color:#24292E;">  </span><span style="color:#032F62;">Speed</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">0</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--:--:--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--:--:--</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--:--:--</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">#</span><span style="color:#24292E;"> </span><span style="color:#032F62;">HELP</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node_cpu_guest_seconds_total</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Seconds</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CPUs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">spent</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">guests</span><span style="color:#24292E;"> (VMs) </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> each mode.</span></span>
<span class="line"><span style="color:#6A737D;"># TYPE node_cpu_guest_seconds_total counter</span></span>
<span class="line"><span style="color:#6F42C1;">node_cpu_guest_seconds_total</span><span style="color:#24292E;">{cpu=</span><span style="color:#6F42C1;">&quot;0&quot;</span><span style="color:#6F42C1;">,mode</span><span style="color:#24292E;">=</span><span style="color:#6F42C1;">&quot;nice&quot;</span><span style="color:#6F42C1;">}</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">node_cpu_guest_seconds_total</span><span style="color:#24292E;">{cpu=</span><span style="color:#6F42C1;">&quot;0&quot;</span><span style="color:#6F42C1;">,mode</span><span style="color:#24292E;">=</span><span style="color:#6F42C1;">&quot;user&quot;</span><span style="color:#6F42C1;">}</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">node_cpu_guest_seconds_total</span><span style="color:#24292E;">{cpu=</span><span style="color:#6F42C1;">&quot;1&quot;</span><span style="color:#6F42C1;">,mode</span><span style="color:#24292E;">=</span><span style="color:#6F42C1;">&quot;nice&quot;</span><span style="color:#6F42C1;">}</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">node_cpu_guest_seconds_total</span><span style="color:#24292E;">{cpu=</span><span style="color:#6F42C1;">&quot;1&quot;</span><span style="color:#6F42C1;">,mode</span><span style="color:#24292E;">=</span><span style="color:#6F42C1;">&quot;user&quot;</span><span style="color:#6F42C1;">}</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6A737D;"># HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.</span></span>
<span class="line"><span style="color:#6A737D;"># TYPE node_cpu_seconds_total counter</span></span>
<span class="line"><span style="color:#6F42C1;">node_cpu_seconds_total</span><span style="color:#24292E;">{cpu=</span><span style="color:#6F42C1;">&quot;0&quot;</span><span style="color:#6F42C1;">,mode</span><span style="color:#24292E;">=</span><span style="color:#6F42C1;">&quot;idle&quot;</span><span style="color:#6F42C1;">}</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">21715.6</span></span>
<span class="line"><span style="color:#6F42C1;">node_cpu_seconds_total</span><span style="color:#24292E;">{cpu=</span><span style="color:#6F42C1;">&quot;0&quot;</span><span style="color:#6F42C1;">,mode</span><span style="color:#24292E;">=</span><span style="color:#6F42C1;">&quot;iowait&quot;</span><span style="color:#6F42C1;">}</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3.48</span></span>
<span class="line"><span style="color:#6F42C1;">node_cpu_seconds_total</span><span style="color:#24292E;">{cpu=</span><span style="color:#6F42C1;">&quot;0&quot;</span><span style="color:#6F42C1;">,mode</span><span style="color:#24292E;">=</span><span style="color:#6F42C1;">&quot;irq&quot;</span><span style="color:#6F42C1;">}</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span></code></pre></div><h2 id="_5-1-k8s-node-监控" tabindex="-1">5.1 k8s-node 监控 <a class="header-anchor" href="#_5-1-k8s-node-监控" aria-label="Permalink to &quot;5.1 k8s-node 监控&quot;">​</a></h2><ul><li>查看scheduler资源详情</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master prometheus]# kubectl -nmonitor describe pod node-exporter-88fvb</span></span>
<span class="line"><span style="color:#B392F0;">Name:</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">node-exporter-88fvb</span></span>
<span class="line"><span style="color:#B392F0;">Namespace:</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">monitor</span></span>
<span class="line"><span style="color:#B392F0;">Priority:</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#B392F0;">Node:</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">kube-node03/10.103.236.204</span></span>
<span class="line"><span style="color:#B392F0;">Start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Time:</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Thu,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">27</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Jun</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2024</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">22</span><span style="color:#9ECBFF;">:22:31</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+0800</span></span>
<span class="line"><span style="color:#B392F0;">Labels:</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">controller-revision-hash=ff498cd78</span></span>
<span class="line"><span style="color:#E1E4E8;">              name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">node-exporter</span></span>
<span class="line"><span style="color:#E1E4E8;">              pod-template-generation</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">6</span></span>
<span class="line"><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Port:</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">9100</span><span style="color:#9ECBFF;">/TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Host</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Port:</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">9100</span><span style="color:#9ECBFF;">/TCP</span></span>
<span class="line"><span style="color:#79B8FF;">...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master prometheus]# kubectl -nmonitor describe pod node-exporter-88fvb</span></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">         </span><span style="color:#032F62;">node-exporter-88fvb</span></span>
<span class="line"><span style="color:#6F42C1;">Namespace:</span><span style="color:#24292E;">    </span><span style="color:#032F62;">monitor</span></span>
<span class="line"><span style="color:#6F42C1;">Priority:</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6F42C1;">Node:</span><span style="color:#24292E;">         </span><span style="color:#032F62;">kube-node03/10.103.236.204</span></span>
<span class="line"><span style="color:#6F42C1;">Start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Time:</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Thu,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">27</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Jun</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2024</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">22</span><span style="color:#032F62;">:22:31</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+0800</span></span>
<span class="line"><span style="color:#6F42C1;">Labels:</span><span style="color:#24292E;">       </span><span style="color:#032F62;">controller-revision-hash=ff498cd78</span></span>
<span class="line"><span style="color:#24292E;">              name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">node-exporter</span></span>
<span class="line"><span style="color:#24292E;">              pod-template-generation</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">6</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Port:</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">9100</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Host</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Port:</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">9100</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span></code></pre></div><p>在 prometheus-config.yaml 中新增采集 job：k8s-nodes</p><p>node_exporter也是每个node节点都运行，因此role使用node即可，默认address端口为10250，替换为9100即可；</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">k8s-nodes</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__address__</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;(.*):10250&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;\${1}:9100&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">labelmap</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__meta_kubernetes_node_label_(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_endpoints_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">endpoint</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_pod_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_namespace</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">namespace</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">k8s-nodes</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__address__</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;(.*):10250&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;\${1}:9100&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">labelmap</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__meta_kubernetes_node_label_(.+)</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_endpoints_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">endpoint</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_pod_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_namespace</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">namespace</span></span></code></pre></div><p>热加载prometheus，使configmap配置文件生效：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-XPOST</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://prometheus.ikubernetes.net/-/reload</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">或者</span></span>
<span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-XPOST</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get svc </span><span style="color:#79B8FF;">-n</span><span style="color:#9ECBFF;"> monitor prometheus</span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-v</span><span style="color:#9ECBFF;"> NAME </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">awk</span><span style="color:#9ECBFF;"> &#39;{print $3}&#39;\`</span><span style="color:#B392F0;">:9090/-/reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-XPOST</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://prometheus.ikubernetes.net/-/reload</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">或者</span></span>
<span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-XPOST</span><span style="color:#24292E;"> </span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">kubectl</span><span style="color:#032F62;"> get svc </span><span style="color:#005CC5;">-n</span><span style="color:#032F62;"> monitor prometheus</span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-v</span><span style="color:#032F62;"> NAME </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">awk</span><span style="color:#032F62;"> &#39;{print $3}&#39;\`</span><span style="color:#6F42C1;">:9090/-/reload</span></span></code></pre></div><h1 id="_6-最终效果图" tabindex="-1">6. 最终效果图 <a class="header-anchor" href="#_6-最终效果图" aria-label="Permalink to &quot;6. 最终效果图&quot;">​</a></h1><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406271823111.png" alt="image-20240627182326457"></p><h1 id="_7-pod监控" tabindex="-1">7. Pod监控 <a class="header-anchor" href="#_7-pod监控" aria-label="Permalink to &quot;7. Pod监控&quot;">​</a></h1><h2 id="_7-1-根据service发现条件metrics" tabindex="-1">7.1 根据Service发现条件metrics <a class="header-anchor" href="#_7-1-根据service发现条件metrics" aria-label="Permalink to &quot;7.1 根据Service发现条件metrics&quot;">​</a></h2><p>service进行过滤，只有在service配置了<code>prometheus.io/scrape: &quot;true&quot;</code>过滤出来</p><ul><li>创建采集器</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;kubernetes-service-endpoints&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">endpoints</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_annotation_prometheus_io_scrape</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_annotation_prometheus_io_scheme</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__scheme__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">(https?)</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_annotation_prometheus_io_path</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__metrics_path__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__address__</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">__meta_kubernetes_service_annotation_prometheus_io_port</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">([^:]+)(?::\\d+)?;(\\d+)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">$1:$2</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">labelmap</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__meta_kubernetes_service_label_(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_namespace</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes_namespace</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes_name</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_endpoints_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">job</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;kubernetes-service-endpoints&#39;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">endpoints</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_annotation_prometheus_io_scrape</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_annotation_prometheus_io_scheme</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__scheme__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">(https?)</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_annotation_prometheus_io_path</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__metrics_path__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">(.+)</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__address__</span><span style="color:#24292E;">, </span><span style="color:#032F62;">__meta_kubernetes_service_annotation_prometheus_io_port</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">([^:]+)(?::\\d+)?;(\\d+)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">$1:$2</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">labelmap</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__meta_kubernetes_service_label_(.+)</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_namespace</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes_namespace</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes_name</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_endpoints_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">job</span></span></code></pre></div><h3 id="_7-1-2-根据service动态获取" tabindex="-1">7.1.2 根据service动态获取 <a class="header-anchor" href="#_7-1-2-根据service动态获取" aria-label="Permalink to &quot;7.1.2 根据service动态获取&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;kubernetes-service-endpoints&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">endpoints</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># prometheus relabel to scrape only endpoints that have</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># \`prometheus.io/scrape: &quot;true&quot;\` annotation.</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">__meta_kubernetes_service_annotation_prometheus_io_scrape</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># prometheus relabel to customize metric path based on endpoints</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># \`prometheus.io/path: &lt;metric path&gt;\` annotation.</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">__meta_kubernetes_service_annotation_prometheus_io_path</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__metrics_path__</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">(.+)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># prometheus relabel to scrape only single, desired port for the service based</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># on endpoints \`prometheus.io/port: &lt;port&gt;\` annotation.</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">__meta_kubernetes_service_annotation_prometheus_io_port</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">([^:]+)(?::\\d+)?;(\\d+)</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">$1:$2</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># prometheus relabel to configure scrape scheme for all service scrape targets</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># based on endpoints \`prometheus.io/scheme: &lt;scheme&gt;\` annotation.</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">__meta_kubernetes_service_annotation_prometheus_io_scheme</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__scheme__</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">(https?)</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">labelmap</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__meta_kubernetes_service_label_(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_namespace</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">namespace</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_service_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">service</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;kubernetes-service-endpoints&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">endpoints</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># prometheus relabel to scrape only endpoints that have</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># \`prometheus.io/scrape: &quot;true&quot;\` annotation.</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">__meta_kubernetes_service_annotation_prometheus_io_scrape</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># prometheus relabel to customize metric path based on endpoints</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># \`prometheus.io/path: &lt;metric path&gt;\` annotation.</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">__meta_kubernetes_service_annotation_prometheus_io_path</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__metrics_path__</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">(.+)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># prometheus relabel to scrape only single, desired port for the service based</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># on endpoints \`prometheus.io/port: &lt;port&gt;\` annotation.</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">__meta_kubernetes_service_annotation_prometheus_io_port</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">([^:]+)(?::\\d+)?;(\\d+)</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">$1:$2</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># prometheus relabel to configure scrape scheme for all service scrape targets</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># based on endpoints \`prometheus.io/scheme: &lt;scheme&gt;\` annotation.</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">__meta_kubernetes_service_annotation_prometheus_io_scheme</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__scheme__</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">(https?)</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">labelmap</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__meta_kubernetes_service_label_(.+)</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_namespace</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">namespace</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_service_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">service</span></span></code></pre></div><h2 id="_7-2-根据pod注解动态采集" tabindex="-1">7.2 根据Pod注解动态采集 <a class="header-anchor" href="#_7-2-根据pod注解动态采集" aria-label="Permalink to &quot;7.2 根据Pod注解动态采集&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">job_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;kubernetes-pods&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">kubernetes_sd_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">relabel_configs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># prometheus relabel to scrape only pods that have</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># \`prometheus.io/scrape: &quot;true&quot;\` annotation.</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">keep</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># prometheus relabel to customize metric path based on pod</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># \`prometheus.io/path: &lt;metric path&gt;\` annotation.</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">__meta_kubernetes_pod_annotation_prometheus_io_path</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__metrics_path__</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">(.+)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># prometheus relabel to scrape only single, desired port for the pod</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># based on pod \`prometheus.io/port: &lt;port&gt;\` annotation.</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">__meta_kubernetes_pod_annotation_prometheus_io_port</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">([^:]+)(?::\\d+)?;(\\d+)</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">replacement</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">$1:$2</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__address__</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">labelmap</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">__meta_kubernetes_pod_label_(.+)</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_namespace</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">namespace</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">source_labels</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">__meta_kubernetes_pod_name</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">action</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">replace</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">target_label</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">job_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;kubernetes-pods&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">kubernetes_sd_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">relabel_configs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># prometheus relabel to scrape only pods that have</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># \`prometheus.io/scrape: &quot;true&quot;\` annotation.</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">keep</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># prometheus relabel to customize metric path based on pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># \`prometheus.io/path: &lt;metric path&gt;\` annotation.</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">__meta_kubernetes_pod_annotation_prometheus_io_path</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__metrics_path__</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">(.+)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># prometheus relabel to scrape only single, desired port for the pod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># based on pod \`prometheus.io/port: &lt;port&gt;\` annotation.</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">__meta_kubernetes_pod_annotation_prometheus_io_port</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">([^:]+)(?::\\d+)?;(\\d+)</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">replacement</span><span style="color:#24292E;">: </span><span style="color:#032F62;">$1:$2</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__address__</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">labelmap</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">__meta_kubernetes_pod_label_(.+)</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_namespace</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">namespace</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">source_labels</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">__meta_kubernetes_pod_name</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">action</span><span style="color:#24292E;">: </span><span style="color:#032F62;">replace</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">target_label</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod</span></span></code></pre></div><ul><li>添加注解</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">DaemonSet</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node-local-dns</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node-local-dns</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">kubernetes.io/cluster-service</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">addonmanager.kubernetes.io/mode</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Reconcile</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">updateStrategy</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">rollingUpdate</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">maxUnavailable</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10%</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node-local-dns</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node-local-dns</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">prometheus.io/port</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;9253&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">prometheus.io/scrape</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">DaemonSet</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node-local-dns</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node-local-dns</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kubernetes.io/cluster-service</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">addonmanager.kubernetes.io/mode</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Reconcile</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">updateStrategy</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">rollingUpdate</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">maxUnavailable</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10%</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node-local-dns</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node-local-dns</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">prometheus.io/port</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;9253&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">prometheus.io/scrape</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span></code></pre></div>`,144),e=[o];function t(c,r,E,y,i,F){return n(),a("div",null,e)}const d=s(p,[["render",t]]);export{_ as __pageData,d as default};
