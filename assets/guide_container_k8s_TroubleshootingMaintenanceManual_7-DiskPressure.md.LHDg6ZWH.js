import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const u=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/TroubleshootingMaintenanceManual/7-DiskPressure.md","filePath":"guide/container/k8s/TroubleshootingMaintenanceManual/7-DiskPressure.md","lastUpdated":1721730545000}'),e={name:"guide/container/k8s/TroubleshootingMaintenanceManual/7-DiskPressure.md"},o=l(`<p><strong>文档：</strong></p><ul><li><a href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/node-pressure-eviction/" target="_blank" rel="noreferrer">Kubernetes 文官方档-节点压力驱逐</a></li></ul><h2 id="一、问题描述" tabindex="-1">一、问题描述 <a class="header-anchor" href="#一、问题描述" aria-label="Permalink to &quot;一、问题描述&quot;">​</a></h2><p>在日常操作维护 Kubernetes 过程中我们会经常遇到很多问题，其中经常收到的告警信息就是节点磁盘压力，即 <code>DiskPressure</code> 警告。当出现该警告不久后 Pod 会被驱逐，甚至节点机器的 Docker 镜像也被清理。在生产中这些情况是不能忍受的，我们探究一下是什么原因导致的这些，以及如何提前预防并解决相关问题。</p><h2 id="二、问题分析" tabindex="-1">二、问题分析 <a class="header-anchor" href="#二、问题分析" aria-label="Permalink to &quot;二、问题分析&quot;">​</a></h2><p><strong>首先提出几个问题，然后分别查找相关资料，对具体的疑问一一查找答案。只有了解这些问题如何产生，才能找到具体解决办法。</strong></p><p><strong>提出的问题如下:</strong></p><h3 id="_1-kubernetes-依靠什么组件对节点磁盘进行监控" tabindex="-1">① Kubernetes 依靠什么组件对节点磁盘进行监控 <a class="header-anchor" href="#_1-kubernetes-依靠什么组件对节点磁盘进行监控" aria-label="Permalink to &quot;① Kubernetes 依靠什么组件对节点磁盘进行监控&quot;">​</a></h3><p>根据 Kubernetes 官方文档描述，在 Kubernetes 集群中，<strong>节点磁盘使用量的监控是交给 Kubelet 组件完成的</strong>，它会对节点资源使用情况进行分析，等达到一定条件后会执行发出内存、磁盘、pid 资源压力警告。</p><h3 id="_2-kubelet-监控节点的哪些文件系统" tabindex="-1">② Kubelet 监控节点的哪些文件系统 <a class="header-anchor" href="#_2-kubelet-监控节点的哪些文件系统" aria-label="Permalink to &quot;② Kubelet 监控节点的哪些文件系统&quot;">​</a></h3><p>在 Kubernetes 节点组件 Kubelet 目前只支持监控两种文件系统分区，分别为:</p><ul><li><strong>nodefs:</strong> kubelet 相关的文件系统，里面存储了 Pod 挂载的卷、守护程序日志等。</li><li><strong>imagefs:</strong> 容器文件系统，里面存储了容器运行时用于保存镜像和容器可写层。</li></ul><p>Kubelet 监控文件系统是通过 Google 的 <code>cAdvisor</code> 组件完成的，该组件专用于监控容器运行环境，当监控到上面列出的文件系统达到一定量后将会发出 <code>DiskPressure</code> 告警，等达到指定阈值，将会对容器及无用镜像相关资源进行清理。</p><h3 id="_3-kubelet-根据什么指标对-pod-执行驱逐的" tabindex="-1">③ Kubelet 根据什么指标对 Pod 执行驱逐的 <a class="header-anchor" href="#_3-kubelet-根据什么指标对-pod-执行驱逐的" aria-label="Permalink to &quot;③ Kubelet 根据什么指标对 Pod 执行驱逐的&quot;">​</a></h3><p>这个信息在 Kubernetes 官方文档中，Kubelet 会根据以下指标判断是否对 Pod 驱逐进行驱逐:</p><ul><li><strong>nodefs.available:</strong> kubelet 相关的文件系统剩余可用存储空间比例。</li><li><strong>nodefs.inodesFree:</strong> kubelet 相关文件节点表 inodes 剩余可用存储空间比例。</li><li><strong>imagefs.available:</strong> 容器运行时文件系统可用存储空间比例。</li><li><strong>imagefs.inodesFree:</strong> 容器运行时 inodes 剩余可用存储空间比例。</li></ul><h3 id="_4-kubelet-根据指标达到什么条件才会执行-pod-驱逐" tabindex="-1">④ Kubelet 根据指标达到什么条件才会执行 Pod 驱逐 <a class="header-anchor" href="#_4-kubelet-根据指标达到什么条件才会执行-pod-驱逐" aria-label="Permalink to &quot;④ Kubelet 根据指标达到什么条件才会执行 Pod 驱逐&quot;">​</a></h3><p>经过 Kubernetes 文档的介绍，Kubelet 会对下面指标进行判断，当到达设置的条件后，会执行强制驱逐 Pod:</p><ul><li><strong>memory.available&lt;100Mi:</strong> 当内存下降到 100Mi 时 kubelet 开始驱逐 Pod。</li><li><strong>nodefs.available&lt;10%:</strong> 当 kubelet 相关存储可用的存储不足 10% 时开始驱逐 Pod 及其容器来释放磁盘空间。</li><li><strong>imagefs.available&lt;15%:</strong> 当容器运行时文件系统可用存储空间不足 15% 时开始驱逐 Pod，并且删除没有被使用的镜像来释放空间。</li><li><strong>nodefs.inodesFree&lt;5％:</strong> (仅 Linux 系统): 当容器运行时 inodes 可用存储空间不足 5% 时开始驱逐 Pod 及其容器来释放磁盘空间。</li></ul><h3 id="_5-kubernetes-触发-diskpressure-告警时造成的影响" tabindex="-1">⑤ Kubernetes 触发 DiskPressure 告警时造成的影响 <a class="header-anchor" href="#_5-kubernetes-触发-diskpressure-告警时造成的影响" aria-label="Permalink to &quot;⑤ Kubernetes 触发 DiskPressure 告警时造成的影响&quot;">​</a></h3><p>当触发 <code>DiskPressure</code> 告警时，会产生如下影响:</p><ul><li>驱逐 Pod</li><li>删除未使用的容器</li><li>阻止新创建的 Pod 调度到该节点中</li></ul><h3 id="_6-什么原因导致经常出现-diskpressure-警告" tabindex="-1">⑥ 什么原因导致经常出现 DiskPressure 警告 <a class="header-anchor" href="#_6-什么原因导致经常出现-diskpressure-警告" aria-label="Permalink to &quot;⑥ 什么原因导致经常出现 DiskPressure 警告&quot;">​</a></h3><p>推测经常出现这个警告的原因可能是:</p><ul><li>默认情况下 docker 会将自己的持久化文件存储到 <code>/var/lib/docker</code> 目录下，这个目录占用空间比较大，导致 <code>/var</code> 目录挂载的磁盘容易被占满。</li><li>默认情况下 kubelet 会将自身的 Pod 运行时相关数据存储在 <code>/var/lib/kubelet</code> 目录下，这个目录空间比较大，导致 <code>/var</code> 目录挂载的磁盘容易被沾满。</li><li>默认情况下 Docker、Kubernetes 和系统等相关日志默认都会存储到 <code>/var/log</code> 目录下，日志相关文件占用空间非常大，导致 <code>/var</code> 目录挂载的磁盘容易被沾满。</li></ul><p>上面三个默认配置，一个是 kubelet，一个是 docker 的，还有就是相关日志配置的，并且发现 <code>var</code> 目录一般分配的空间不是很大，所以 <code>/var</code> 目录挂载的磁盘空间非常容易被日志文件占满。</p><p>除此之外，还有一种可能，那就是当发生 <code>DiskPressure</code> 告警时，此时磁盘其实可用存储空间还很充足，例如 <code>1TB</code> 存储空间，使用率 <code>80%</code> 提示 <code>DiskPressure</code> 告警，这时候其实还有 <code>200GB</code> 可用存储空间。所以，这个磁盘告警比例需要根据节点磁盘的真实情况进行调整。</p><h2 id="三、解决问题" tabindex="-1">三、解决问题 <a class="header-anchor" href="#三、解决问题" aria-label="Permalink to &quot;三、解决问题&quot;">​</a></h2><blockquote><p>注意: 下面的操作最好在集群搭建初期修改，如果已经在现网环境文档运行，修改请谨慎！</p></blockquote><h3 id="更改-docker-存储目录" tabindex="-1">更改 Docker 存储目录 <a class="header-anchor" href="#更改-docker-存储目录" aria-label="Permalink to &quot;更改 Docker 存储目录&quot;">​</a></h3><p>既然 <code>Docker</code> 目录默认在 <code>/var/lib/docker</code> 目录下，且这个目录所挂载的磁盘容易被占满，所以我们修改 <code>Docker</code> 配置，将存储的数据单独存放到挂载其它大磁盘的目录中。</p><p><strong>(1) 查看 Docker 状态，根据显示的信息定位 Docker 存储配置文件的位置</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">status</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-l</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-l</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker</span></span></code></pre></div><p>显示如下信息:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">●</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">docker.service</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Application</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Container</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Engine</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">Loaded:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">loaded</span><span style="color:#E1E4E8;"> (/usr/lib/systemd/system/docker.service; </span><span style="color:#B392F0;">enabled</span><span style="color:#E1E4E8;">; </span><span style="color:#B392F0;">vendor</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">preset:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">disabled</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">Active:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">active</span><span style="color:#E1E4E8;"> (running) since 二 2021-06-15 10:40:07 CST; </span><span style="color:#B392F0;">3h</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#9ECBFF;">min</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ago</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">Docs:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://docs.docker.com</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PID:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1676</span><span style="color:#E1E4E8;"> (dockerd)</span></span>
<span class="line"><span style="color:#79B8FF;">......</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">●</span><span style="color:#24292E;"> </span><span style="color:#032F62;">docker.service</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Application</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Container</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Engine</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">Loaded:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">loaded</span><span style="color:#24292E;"> (/usr/lib/systemd/system/docker.service; </span><span style="color:#6F42C1;">enabled</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">vendor</span><span style="color:#24292E;"> </span><span style="color:#032F62;">preset:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">disabled</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">Active:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">active</span><span style="color:#24292E;"> (running) since 二 2021-06-15 10:40:07 CST; </span><span style="color:#6F42C1;">3h</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#032F62;">min</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ago</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#6F42C1;">Docs:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://docs.docker.com</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PID:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1676</span><span style="color:#24292E;"> (dockerd)</span></span>
<span class="line"><span style="color:#005CC5;">......</span></span></code></pre></div><p>可以看到配置文件所在目录是 <code>/usr/lib/systemd/system/</code>，配置文件是 <code>docker.service</code>。</p><p><strong>(2) 设置 Docker 数据存储目录</strong></p><p>打开 Docker 配置文件</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">vi</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/lib/systemd/system/docker.service</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">vi</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/lib/systemd/system/docker.service</span></span></code></pre></div><p>找到 <code>ExecStartExecStart=/usr/bin/docker</code> 这行，在后台添加 <code>--graph &lt;Docker数据存储目录&gt;</code>，例如这里目录为 <code>/apps/data/docker</code> 则可以按如下配置：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">ExecStart</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/usr/bin/docker</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">--graph</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/apps/data/docker</span></span>
<span class="line"><span style="color:#79B8FF;">...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">ExecStart</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/usr/bin/docker</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">--graph</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/apps/data/docker</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span></code></pre></div><h3 id="更改-kubelet-存储目录与告警阈值" tabindex="-1">更改 kubelet 存储目录与告警阈值 <a class="header-anchor" href="#更改-kubelet-存储目录与告警阈值" aria-label="Permalink to &quot;更改 kubelet 存储目录与告警阈值&quot;">​</a></h3><p>既然 <code>Kubelet</code> 目录默认在 <code>/var/lib/kubelet</code> 目录下，且这个目录所挂载的磁盘容易被占满，所以我们修改 <code>Kubelet</code> 配置，将存储的数据单独存放到挂载其它大磁盘的目录中。并且根据磁盘真实大小，调整 <code>Kubelet</code> 触发 <code>DisPress</code> 告警的比例。</p><p><strong>(1) 查看 kubelet 状态，根据显示的信息定位 kubelet 存储配置文件的位置</strong></p><p>输入下面命令查看 kubelet 状态信息:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">status</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-l</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-l</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet</span></span></code></pre></div><p>显示如下信息:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">●</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet.service</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">The</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Kubernetes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Agent</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">Loaded:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">loaded</span><span style="color:#E1E4E8;"> (/usr/lib/systemd/system/kubelet.service; </span><span style="color:#B392F0;">enabled</span><span style="color:#E1E4E8;">; </span><span style="color:#B392F0;">vendor</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">preset:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">disabled</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Drop-In:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/lib/systemd/system/kubelet.service.d</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#B392F0;">└─10-kubeadm.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">Active:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">active</span><span style="color:#E1E4E8;"> (running) since 二 2021-06-15 10:40:03 CST; </span><span style="color:#B392F0;">1h</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">57</span><span style="color:#9ECBFF;">min</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ago</span></span>
<span class="line"><span style="color:#79B8FF;">......</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">●</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet.service</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">The</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Kubernetes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Agent</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">Loaded:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">loaded</span><span style="color:#24292E;"> (/usr/lib/systemd/system/kubelet.service; </span><span style="color:#6F42C1;">enabled</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">vendor</span><span style="color:#24292E;"> </span><span style="color:#032F62;">preset:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">disabled</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Drop-In:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/lib/systemd/system/kubelet.service.d</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6F42C1;">└─10-kubeadm.conf</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">Active:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">active</span><span style="color:#24292E;"> (running) since 二 2021-06-15 10:40:03 CST; </span><span style="color:#6F42C1;">1h</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">57</span><span style="color:#032F62;">min</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ago</span></span>
<span class="line"><span style="color:#005CC5;">......</span></span></code></pre></div><p>可以观察到配置文件目录所在位置是 <code>/usr/lib/systemd/system/kubelet.service.d/</code>，配置文件是 <code>10-kubeadm.conf</code>。</p><p><strong>(2) 查看 EnvironmentFile 配置文件所在位置</strong></p><p>打开 kubelet 配置，查看 kubelet 配置文件:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span></span></code></pre></div><p>可以看到如下内容:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[Service]</span></span>
<span class="line"><span style="color:#E1E4E8;">Environment</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">Environment</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">EnvironmentFile</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">-/var/lib/kubelet/kubeadm-flags.env</span></span>
<span class="line"><span style="color:#E1E4E8;">EnvironmentFile</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">-/etc/sysconfig/kubelet</span></span>
<span class="line"><span style="color:#E1E4E8;">ExecStart</span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">ExecStart</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/usr/bin/kubelet</span><span style="color:#E1E4E8;"> $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[Service]</span></span>
<span class="line"><span style="color:#24292E;">Environment</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span></span>
<span class="line"><span style="color:#24292E;">Environment</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span></span>
<span class="line"><span style="color:#24292E;">EnvironmentFile</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">-/var/lib/kubelet/kubeadm-flags.env</span></span>
<span class="line"><span style="color:#24292E;">EnvironmentFile</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">-/etc/sysconfig/kubelet</span></span>
<span class="line"><span style="color:#24292E;">ExecStart</span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">ExecStart</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/usr/bin/kubelet</span><span style="color:#24292E;"> $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS</span></span></code></pre></div><p>可以看到 <code>EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</code> 和 <code>EnvironmentFile=-/etc/sysconfig/kubelet</code> 俩行配置，其中 <code>/var/lib/kubelet/kubeadm-flags.env</code> 是 &quot;kubeadm init&quot; 和 &quot;kubeadm join&quot; 在运行时生成的文件，我们不需要管理该文件。而 <code>/etc/sysconfig/kubelet</code> 文件则是供我们用户添加自定义参数的，所以我们需要在这个配置文件中添加我们自定义配置参数。</p><p><strong>(3) 编辑 /etc/sysconfig/kubelet 配置文件</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">vi</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/sysconfig/kubelet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">vi</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/sysconfig/kubelet</span></span></code></pre></div><p>然后在 <code>KUBELET_EXTRA_ARGS=</code> 后面添加参数 <code>-root-dir=&lt;新的kubelet存储目录&gt;</code>:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">KUBELET_EXTRA_ARGS</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">--root-dir=/apps/data/kubelet</span><span style="color:#E1E4E8;"> --eviction-hard</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">nodefs.available</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">5%</span><span style="color:#E1E4E8;"> --eviction-hard</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">imagefs.available</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">5%</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">KUBELET_EXTRA_ARGS</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">--root-dir=/apps/data/kubelet</span><span style="color:#24292E;"> --eviction-hard</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">nodefs.available</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">5%</span><span style="color:#24292E;"> --eviction-hard</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">imagefs.available</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">5%</span></span></code></pre></div><ul><li><strong>--root-dir=/apps/data/kubelet:</strong> 设置 kubelet 数据存储在 /apps/data/kubelet 目录下。</li><li><strong>--eviction-hard=nodefs.available&lt;5%:</strong> 设置当 kubelet 相关存储可用的存储不足 5% 时开始驱逐 Pod。</li><li><strong>--eviction-hard=imagefs.available&lt;5%:</strong> 当容器运行时文件系统可用存储空间不足 5% 时开始驱逐 Pod。</li></ul><blockquote><p>上面的大小限制也可以改成具体的数值，例如 <code>--eviction-hard=imagefs.available&lt;10Gi</code>，则表示容器运行时存储小于 10Gi 时进行驱逐。</p></blockquote><p><strong>(5) 重启 daemon-reload 和 kubelet</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemon-reload</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemon-reload</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet</span></span></code></pre></div><p><strong>(6) 再次查看 kubelet 状态，观察上面配置是否生效</strong></p><p>再次支持下面命令查看 kubelet 状态:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">status</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-l</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-l</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet</span></span></code></pre></div><p>观察显示的 kubelet 参数是是否存在上面我们配置的参数:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">●</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet.service</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">The</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Kubernetes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Agent</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">Loaded:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">loaded</span><span style="color:#E1E4E8;"> (/usr/lib/systemd/system/kubelet.service; </span><span style="color:#B392F0;">enabled</span><span style="color:#E1E4E8;">; </span><span style="color:#B392F0;">vendor</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">preset:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">disabled</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Drop-In:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/lib/systemd/system/kubelet.service.d</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#B392F0;">└─10-kubeadm.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">Active:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">active</span><span style="color:#E1E4E8;"> (running) since 二 2021-06-15 13:55:29 CST; </span><span style="color:#B392F0;">1s</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ago</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">Docs:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://kubernetes.io/docs/</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PID:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">130986</span><span style="color:#E1E4E8;"> (kubelet)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">Tasks:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">14</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">Memory:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">26.1</span><span style="color:#9ECBFF;">M</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">CGroup:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/system.slice/kubelet.service</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#B392F0;">└─130986</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/bin/kubelet</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">           --bootstrap-kubeconfig</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/kubernetes/bootstrap-kubelet.conf</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">           --kubeconfig</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/kubernetes/kubelet.conf</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">           --config</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/var/lib/kubelet/config.yaml</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">           --network-plugin</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">cni</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">           --pod-infra-container-image</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">registry.aliyuncs.com/google_containers/pause:3.2</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">           --root-dir</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/apps/data/kubelet</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">           --eviction-hard</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">nodefs.available</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">5%</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">           --eviction-hard</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">imagefs.available</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">5%</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">●</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet.service</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">The</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Kubernetes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Agent</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">Loaded:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">loaded</span><span style="color:#24292E;"> (/usr/lib/systemd/system/kubelet.service; </span><span style="color:#6F42C1;">enabled</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">vendor</span><span style="color:#24292E;"> </span><span style="color:#032F62;">preset:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">disabled</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Drop-In:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/lib/systemd/system/kubelet.service.d</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6F42C1;">└─10-kubeadm.conf</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">Active:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">active</span><span style="color:#24292E;"> (running) since 二 2021-06-15 13:55:29 CST; </span><span style="color:#6F42C1;">1s</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ago</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#6F42C1;">Docs:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://kubernetes.io/docs/</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PID:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">130986</span><span style="color:#24292E;"> (kubelet)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">Tasks:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">14</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">Memory:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">26.1</span><span style="color:#032F62;">M</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">CGroup:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/system.slice/kubelet.service</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6F42C1;">└─130986</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/bin/kubelet</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">           --bootstrap-kubeconfig</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/kubernetes/bootstrap-kubelet.conf</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">           --kubeconfig</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/kubernetes/kubelet.conf</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">           --config</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/var/lib/kubelet/config.yaml</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">           --network-plugin</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">cni</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">           --pod-infra-container-image</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">registry.aliyuncs.com/google_containers/pause:3.2</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">           --root-dir</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/apps/data/kubelet</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">           --eviction-hard</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">nodefs.available</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">5%</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">           --eviction-hard</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">imagefs.available</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">5%</span></span></code></pre></div><p>可以观察到上面信息中已经加载了 <code>root-dir</code>、<code>--eviction-hard</code> 参数，说明配置已经生效</p>`,69),p=[o];function t(c,r,E,y,i,d){return a(),n("div",null,p)}const b=s(e,[["render",t]]);export{u as __pageData,b as default};
