import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const u=JSON.parse('{"title":"0. kube-scheduler","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/资源对象/2-pod调度.md","filePath":"guide/container/k8s/资源对象/2-pod调度.md","lastUpdated":1734344767000}'),p={name:"guide/container/k8s/资源对象/2-pod调度.md"},o=l(`<p>官方文档,<a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/taint-and-toleration" target="_blank" rel="noreferrer">https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/taint-and-toleration</a></p><h1 id="_0-kube-scheduler" tabindex="-1">0. kube-scheduler <a class="header-anchor" href="#_0-kube-scheduler" aria-label="Permalink to &quot;0. kube-scheduler&quot;">​</a></h1><h2 id="scheduler作用" tabindex="-1">Scheduler作用 <a class="header-anchor" href="#scheduler作用" aria-label="Permalink to &quot;Scheduler作用&quot;">​</a></h2><ol><li><strong>资源分配</strong>：根据每个Pod的资源请求（如CPU、内存），以及节点当前的可用资源情况，选择合适的Node来运行Pod。</li><li><strong>满足约束条件</strong>：考虑Pod的调度约束条件和亲和性/反亲和性规则，例如节点标签、区域、拓扑结构等要求，确保Pod被调度到符合其特定需求的Node上。</li><li><strong>服务稳定性与优化</strong>：通过预选（Filtering）和优选（Scoring）两个阶段的策略执行， Scheduler不仅确保Pod能够成功调度，还尽可能地优化集群的整体性能和可靠性。</li></ol><h3 id="原理" tabindex="-1">原理 <a class="header-anchor" href="#原理" aria-label="Permalink to &quot;原理&quot;">​</a></h3><p>Scheduler的工作流程主要包括以下几个关键步骤：</p><ol><li><strong>监听事件</strong>：Scheduler会持续监听API Server的事件，一旦有新的待调度Pod或已有Pod需要重新调度时，它将介入并进行调度决策。</li><li><strong>预选阶段（Filtering）</strong>： <ul><li>Scheduler遍历整个集群的所有Node列表。</li><li>对于每一个Node，检查该节点是否满足Pod的资源需求和其他硬性约束条件，如节点标签匹配、容忍度（Taints and Tolerations）、存储容量等。</li><li>如果一个Node通过了所有预选策略，则会被加入候选节点集合。</li></ul></li><li><strong>优选阶段（Prioritizing / Scoring）</strong>： <ul><li>Scheduler对候选节点集合应用一系列优选策略，为每个节点计算一个优先级分数。</li><li>这些优选策略可以包括默认的系统策略（如基于资源利用率的打分）以及用户自定义的策略。</li><li>Scheduler根据各个节点得到的积分排序，得分最高的节点将被选为Pod的最佳调度位置。</li></ul></li><li><strong>绑定决策</strong>： <ul><li>当确定了最优节点后，Scheduler会在API Server中为Pod创建一个binding对象，将Pod与选定的Node绑定在一起。</li><li>调度结果写入etcd，并通知kubelet开始在该Node上启动Pod。</li></ul></li><li><strong>动态调整</strong>： <ul><li>Scheduler不断地观察集群状态的变化，并相应地调整Pod的位置，以适应集群资源的实时变化及业务需求。</li></ul></li></ol><h2 id="_1-什么是调度器" tabindex="-1">1. 什么是调度器 <a class="header-anchor" href="#_1-什么是调度器" aria-label="Permalink to &quot;1. 什么是调度器&quot;">​</a></h2><p>在 Kubernetes中内置了<code>kube-scheduler</code>，它是集群默认的调度器。但<code>kube-scheduler</code>调度器它基本上仅发挥在有限的场景当中，那就是有新的Pod出现了。当我们通过APIServer创建一个Pod时，如果这个Pod<code>尚未绑定到任何节点</code>，那就需要通过调度器来调度这个Pod到对应的节点上运行；</p><p>那什么叫<code>尚未绑定到任何节点</code>呢，在Pod规范中有一个<code>nodeName</code>的字段，这个字段指定了该Pod要运行在哪个节点上，如果直接指定该字段的值，也就是直接指明该Pod要在哪个节点运行，那么调度器则不会工作。如果创建的Pod都没有定义nodeName字段的值，也就意味着该字段为空，那这个Pod究竟要运行到哪个节点上，我们的Kubernetes集群没法判定。</p><p>所以 <code>kube-scheduler</code> 它会一直监视着APIServer中所有Pod的<code>NodeName</code>字段，当监控到该字段为空时，那么它会为对应的Pod启动调度机制，然后从众多节点中挑选一个最佳的节点。挑选后还需要将选定的节点信息写入到<code>nodeNAME</code>字段，然后返回给APIServer。最后由对应节点上的<code>Kubelet</code>创建并运行该Pod (因为kubeLet也会一直监视着这个字段)</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406241700389.png" alt="image-20240624165838345"></p><h2 id="_2-调度器流程" tabindex="-1">2. 调度器流程 <a class="header-anchor" href="#_2-调度器流程" aria-label="Permalink to &quot;2. 调度器流程&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">Kubernetes 官方过滤和打分编排源码：https://github.com/kubernetes/kubernetes/blob/281023790fd27eec7bfaa7e26ff1efd45a95fb09/pkg/scheduler/framework/plugins/legacy_registry.go</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">Kubernetes 官方过滤和打分编排源码：https://github.com/kubernetes/kubernetes/blob/281023790fd27eec7bfaa7e26ff1efd45a95fb09/pkg/scheduler/framework/plugins/legacy_registry.go</span></span></code></pre></div><p>一个Pod究竟要调度到哪个节点上，应该有一些挑选标准，或调度算法;<code>kube-scheduLer</code>实现的调度器叫 <code>default-scheduler</code>，如果对调度器有其他要求，Kubernetes也允许自己写一个调度组件来替换默认的kube-scheduLer。</p><p>默认调度器在调度一个Pod时，它通过三个步骤来完成调度，（过滤、打分、绑定)</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406241701759.png" alt="image-20240624170135173"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202407121006880.png" alt="image-20240712094016189"></p><h3 id="_1、过滤阶段-预选策略" tabindex="-1">1、过滤阶段（预选策略） <a class="header-anchor" href="#_1、过滤阶段-预选策略" aria-label="Permalink to &quot;1、过滤阶段（预选策略）&quot;">​</a></h3><p>由于Pod内的每一个容器对资源都有不同的需求，所有每个Pod的需求也不同，因此 Pod 在被调度到 Node上之前，会检查候选Node的可用资源能否满足Pod的资源请求。在过滤之后，得出一个Node列表，里面包含了所有<code>可调度节点</code>。如果没有任何一个Node能满足Pod 的资源需求，那么这个 Pod 将一直停留在<code>未调度状态</code>直到调度器能够找到合适的Node。</p><h3 id="_2、打分阶段-优选策略" tabindex="-1">2、打分阶段（优选策略） <a class="header-anchor" href="#_2、打分阶段-优选策略" aria-label="Permalink to &quot;2、打分阶段（优选策略）&quot;">​</a></h3><p>在打分阶段，调度器会为Pod从所有可调度节点中选取一个最合适的 Node。根据当前启用的打分规则，调度器会给每一个可调度节点进行打分，并按综合得分进行排序，如果同时有多个节点得分一致，则随机挑选一个节点。</p><h3 id="_3、绑定节点" tabindex="-1">3、绑定节点 <a class="header-anchor" href="#_3、绑定节点" aria-label="Permalink to &quot;3、绑定节点&quot;">​</a></h3><p>最后调度器会将这个调度决定通知给APIServer，这个过程叫绑定。而后由相应节点的代理程序Kubelet启动Pod。</p><h2 id="_3-预选函数" tabindex="-1">3. 预选函数 <a class="header-anchor" href="#_3-预选函数" aria-label="Permalink to &quot;3. 预选函数&quot;">​</a></h2><p>此前我们提到过预选阶段主要用于排除那些不符合Pod申请规范的节点，所以它会通过所有已启用的预选函数对所有节点进行逐一筛查，任何一个预选函数否决，者都会造成该节点被排除掉，反之则会保留进入下一个优选阶段。</p><h3 id="_1、checknodeunschedulable" tabindex="-1">1、CheckNodeUnschedulable <a class="header-anchor" href="#_1、checknodeunschedulable" aria-label="Permalink to &quot;1、CheckNodeUnschedulable&quot;">​</a></h3><p>检查节点是否被标识为Unschedulable，这个标识表示不可调度，如果Pod能接受此类节点，则保留该节点，否则排除该节点</p><h3 id="_2、hostname" tabindex="-1">2、HostName <a class="header-anchor" href="#_2、hostname" aria-label="Permalink to &quot;2、HostName&quot;">​</a></h3><p>若Pod资源通过spec.nodeName明确指定了要绑定的目标节点，那么该节点会被保留。</p><h3 id="_3、podfitshostports" tabindex="-1">3、PodFitsHostPorts <a class="header-anchor" href="#_3、podfitshostports" aria-label="Permalink to &quot;3、PodFitsHostPorts&quot;">​</a></h3><p>若容器定义了ports.hostPort属性，那么该预选函数会检查其指定的端口是否已被节点上其他容器或服务所占用，该端口已被占用的节点将统统被排除掉</p><h3 id="_4、matchnodeselector" tabindex="-1">4、MatchNodeSelector <a class="header-anchor" href="#_4、matchnodeselector" aria-label="Permalink to &quot;4、MatchNodeSelector&quot;">​</a></h3><p>若Pod资源规范定义了spec.nodeSelector节点选择器字段，则将拥有匹配对应标签的节点保留下来，剩余节点全部排除。</p><h3 id="_5、podfitsresources" tabindex="-1">5、PodFitsResources <a class="header-anchor" href="#_5、podfitsresources" aria-label="Permalink to &quot;5、PodFitsResources&quot;">​</a></h3><p>检查节点是否有足够的CPU或内存资源，能够满足Pod的运行需求。节点会声明其资源的可用容量，而Pod会定义资源需求，于是调度器会判断节点是否有足够可用的资源来运行对应的Pod，如果无法满足则返回失败的原因。（调度器评判节点资源消耗的标准是节点已分配出去的资源使用量，也就是各个容器的Requests之和。）</p><h2 id="_4-优选函数" tabindex="-1">4. 优选函数 <a class="header-anchor" href="#_4-优选函数" aria-label="Permalink to &quot;4. 优选函数&quot;">​</a></h2><p>成功通过预选函数过滤后的节点将生成一个可调度列表，随后对节点进行优先级排序阶段。对于每个节点，调度器会使用优选函数分别为其打分（0~10之间的分数），然后将所有的分数进行相加，即为该节点的总得分，最后得分最高者胜出。</p><h3 id="_1、leastrequestedpriority" tabindex="-1">1、LeastRequestedPriority <a class="header-anchor" href="#_1、leastrequestedpriority" aria-label="Permalink to &quot;1、LeastRequestedPriority&quot;">​</a></h3><p>通过计算CPU和Memory的使用率来决定权重，使用率越低的节点权重越高。换句话说，这个优先级指标倾向于资源使用比例更低的节点。</p><h3 id="_2、balancedresourceallocation" tabindex="-1">2、BalancedResourceAllocation <a class="header-anchor" href="#_2、balancedresourceallocation" aria-label="Permalink to &quot;2、BalancedResourceAllocation&quot;">​</a></h3><p>以CPU和内存资源占用率相近的作为评估标准，二者越接近的节点权重越高，该函数不能单独使用，它需要和Least-RequestedPriority组合使用来平衡优化节点资源的使用状态选择在部署当前Pod资源后系统资源更为均衡的节点。</p><h3 id="_3、nodeaffinitypriority" tabindex="-1">3、NodeAffinityPriority <a class="header-anchor" href="#_3、nodeaffinitypriority" aria-label="Permalink to &quot;3、NodeAffinityPriority&quot;">​</a></h3><p>节点亲和调度机制，它根据Pod资源规范中的spec.nodeSeLector来对给定节点进行匹配度检查，成功匹配到的条目越多则节点得分越高。</p><h3 id="_4、tainttolerationpriority" tabindex="-1">4、TaintTolerationPriority <a class="header-anchor" href="#_4、tainttolerationpriority" aria-label="Permalink to &quot;4、TaintTolerationPriority&quot;">​</a></h3><p>基于Pod资源对节点的污点容调度偏好进行优先级评估，它将Pod对象的tolerations列表与节点的污点进行匹配度检查，成功匹配的条目越多，则节点得分越低。</p><h3 id="_5、imagelocalitypriority" tabindex="-1">5、ImageLocalityPriority <a class="header-anchor" href="#_5、imagelocalitypriority" aria-label="Permalink to &quot;5、ImageLocalityPriority&quot;">​</a></h3><p>镜像亲和调度机制，它根据给定的节点列表上是否拥有运行当前Pod的容器所依赖的镜像文件来计算节点的分值，如果没有所依赖的镜像文件节点得分为日，而存在相关镜像文件的各个节点，被Pod依赖到的镜像文件的体积越大，节点得分越高。</p><h3 id="_6、selectorspreadpriority" tabindex="-1">6、SelectorSpreadPriority <a class="header-anchor" href="#_6、selectorspreadpriority" aria-label="Permalink to &quot;6、SelectorSpreadPriority&quot;">​</a></h3><p>尽可能将Pod分散到不同节点上的调度插件，它首先查找标签选择器能匹配当前Pod标签的RS、DepLoyment、StatefuLSet等控制器，而后查找可由这类对象的标签选择器匹配的现存各Pod对象及其所在的节点，而运行此类Pod对象越少的节点得分越高。简单来说：就是将同一标签选择器匹配到的Pod资源打散到不同的节点上运行。</p><p>默认调度器能够满足我们绝大多数的要求，能够保证我们的Pod可以被分配到资源充足的节点上运行。但是在实际的线上项目中，可能我们自己会比kubernetes更加了解我们自己的应用，比如我们希望一个Pod只能运行在特定的几个节点上，或者这几个节点只能用来运行特定类型的应用，这就需要我们的调度器能够可控。</p><h1 id="_1-节点亲和调度" tabindex="-1">1. 节点亲和调度 <a class="header-anchor" href="#_1-节点亲和调度" aria-label="Permalink to &quot;1. 节点亲和调度&quot;">​</a></h1><blockquote><p>将一个 Pod 分配到某一个可以满足 Pod 资源请求的节点上，这一过程称之为调度。</p></blockquote><p>在默认情况下，一个Pod在哪个Node节点上运行，是由Scheduler组件采用相应的算法计算出来的，这个过程是不受人工控制的。但是在实际使用中，这并不满足的需求，因为很多情况下，我们想控制某些Pod到达某些节点上，那么应该怎么做呢？这就要求了解kubernetes对Pod的调度规则，kubernetes提供了四大类调度方式：</p><ul><li>自动调度：运行在哪个节点上完全由Scheduler经过一系列的算法计算得出</li><li>定向调度：NodeName、NodeSelector</li><li>亲和性调度：NodeAffinity、PodAffinity、PodAntiAffinity</li><li>污点（容忍）调度：Taints、Toleration</li></ul><h2 id="_1-1-定向调度" tabindex="-1">1.1 定向调度 <a class="header-anchor" href="#_1-1-定向调度" aria-label="Permalink to &quot;1.1 定向调度&quot;">​</a></h2><p>定向调度，指的是利用在pod上声明nodeName或者nodeSelector，以此将Pod调度到期望的node节点上。注意，这里的调度是强制的，这就意味着即使要调度的目标Node不存在，也会向上面进行调度，只不过pod运行失败而已。</p><h3 id="nodename" tabindex="-1">NodeName <a class="header-anchor" href="#nodename" aria-label="Permalink to &quot;NodeName&quot;">​</a></h3><p>NodeName用于强制约束将Pod调度到指定的Name的Node节点上。这种方式，其实是直接跳过Scheduler的调度逻辑，直接将Pod调度到指定名称的节点。</p><ul><li><p>首先<code>nodeName</code>比<code>nodeSelector</code>，或亲和性更为直接;</p></li><li><p>其次<code>nodeName</code>规则的优先级会高于使用<code>nodeSelector</code>或亲和性与非亲和性的规则。</p></li></ul><h4 id="nodename局限" tabindex="-1">nodeName局限 <a class="header-anchor" href="#nodename局限" aria-label="Permalink to &quot;nodeName局限&quot;">​</a></h4><p>使用nodeName :为Pod选择节点的方式有一些局限性：</p><p>1.如果所指定的节点不存在，则Pod 无法运行，而且在某些情况下可能会被自动删除。</p><p>2.如果所指定的节点无法提供Pod所需的资源，则会失败，失败原因也会告知是因为内存还是CPU不足而造成无法运行。</p><p>3.在云环境中的节点名称并不是可预测的，也不总是稳定的</p><p>例子:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod-nodename</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dev</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">nodeName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node1</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 指定调度到node1节点上</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod-nodename</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">nodeName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node1</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 指定调度到node1节点上</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#创建Pod</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl create -f pod-nodename.yaml</span></span>
<span class="line"><span style="color:#9ECBFF;">pod/pod-nodename created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看Pod调度到NODE属性，确实是调度到了node1节点上</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl get pods pod-nodename -n dev -o wide</span></span>
<span class="line"><span style="color:#9ECBFF;">NAME           READY   STATUS    RESTARTS   AGE   IP            NODE      ......</span></span>
<span class="line"><span style="color:#9ECBFF;">pod-nodename   1/1     Running   0          56s   10.244.1.87   node1     ......</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 接下来，删除pod，修改nodeName的值为node3（并没有node3节点）</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl delete -f pod-nodename.yaml</span></span>
<span class="line"><span style="color:#9ECBFF;">pod &quot;pod-nodename&quot; deleted</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">vim pod-nodename.yaml</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl create -f pod-nodename.yaml</span></span>
<span class="line"><span style="color:#9ECBFF;">pod/pod-nodename created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#再次查看，发现已经向Node3节点调度，但是由于不存在node3节点，所以pod无法正常运行</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl get pods pod-nodename -n dev -o wide</span></span>
<span class="line"><span style="color:#9ECBFF;">NAME           READY   STATUS    RESTARTS   AGE   IP       NODE    ......</span></span>
<span class="line"><span style="color:#9ECBFF;">pod-nodename   0/1     Pending   0          6s    &lt;none&gt;   node3   ......</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#创建Pod</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl create -f pod-nodename.yaml</span></span>
<span class="line"><span style="color:#032F62;">pod/pod-nodename created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看Pod调度到NODE属性，确实是调度到了node1节点上</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl get pods pod-nodename -n dev -o wide</span></span>
<span class="line"><span style="color:#032F62;">NAME           READY   STATUS    RESTARTS   AGE   IP            NODE      ......</span></span>
<span class="line"><span style="color:#032F62;">pod-nodename   1/1     Running   0          56s   10.244.1.87   node1     ......</span><span style="color:#24292E;">   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 接下来，删除pod，修改nodeName的值为node3（并没有node3节点）</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl delete -f pod-nodename.yaml</span></span>
<span class="line"><span style="color:#032F62;">pod &quot;pod-nodename&quot; deleted</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">vim pod-nodename.yaml</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl create -f pod-nodename.yaml</span></span>
<span class="line"><span style="color:#032F62;">pod/pod-nodename created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#再次查看，发现已经向Node3节点调度，但是由于不存在node3节点，所以pod无法正常运行</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl get pods pod-nodename -n dev -o wide</span></span>
<span class="line"><span style="color:#032F62;">NAME           READY   STATUS    RESTARTS   AGE   IP       NODE    ......</span></span>
<span class="line"><span style="color:#032F62;">pod-nodename   0/1     Pending   0          6s    &lt;none&gt;   node3   ......</span></span></code></pre></div><h3 id="nodeselector" tabindex="-1">NodeSelector <a class="header-anchor" href="#nodeselector" aria-label="Permalink to &quot;NodeSelector&quot;">​</a></h3><p>NodeSelector用于将pod调度到添加了指定标签的node节点上。它是通过kubernetes的label-selector机制实现的，也就是说，在pod创建之前，会由scheduler使用MatchNodeSelector调度策略进行label匹配，找出目标node，然后将pod调度到目标节点，该匹配规则是强制约束。</p><p>1.首先分别为node节点添加标签</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl label nodes node1 nodeenv=pro</span></span>
<span class="line"><span style="color:#B392F0;">node/node2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">labeled</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl label nodes node2 nodeenv=test</span></span>
<span class="line"><span style="color:#B392F0;">node/node2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">labeled</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl label nodes node1 nodeenv=pro</span></span>
<span class="line"><span style="color:#6F42C1;">node/node2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">labeled</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl label nodes node2 nodeenv=test</span></span>
<span class="line"><span style="color:#6F42C1;">node/node2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">labeled</span></span></code></pre></div><p>2.创建一个pod-nodeselector.yaml文件，并使用它创建Pod</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod-nodeselector</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dev</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">nodeSelector</span><span style="color:#E1E4E8;">: </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nodeenv</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pro</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 指定调度到具有nodeenv=pro标签的节点上</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod-nodeselector</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">nodeSelector</span><span style="color:#24292E;">: </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nodeenv</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pro</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 指定调度到具有nodeenv=pro标签的节点上</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#创建Pod</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl create -f pod-nodeselector.yaml</span></span>
<span class="line"><span style="color:#9ECBFF;">pod/pod-nodeselector created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看Pod调度到NODE属性，确实是调度到了node1节点上</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl get pods pod-nodeselector -n dev -o wide</span></span>
<span class="line"><span style="color:#9ECBFF;">NAME               READY   STATUS    RESTARTS   AGE     IP          NODE    ......</span></span>
<span class="line"><span style="color:#9ECBFF;">pod-nodeselector   1/1     Running   0          47s   10.244.1.87   node1   ......</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 接下来，删除pod，修改nodeSelector的值为nodeenv: xxxx（不存在打有此标签的节点）</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl delete -f pod-nodeselector.yaml</span></span>
<span class="line"><span style="color:#9ECBFF;">pod &quot;pod-nodeselector&quot; deleted</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">vim pod-nodeselector.yaml</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl create -f pod-nodeselector.yaml</span></span>
<span class="line"><span style="color:#9ECBFF;">pod/pod-nodeselector created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#再次查看，发现pod无法正常运行,Node的值为none</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#9ECBFF;">NAME               READY   STATUS    RESTARTS   AGE     IP       NODE</span><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#9ECBFF;">pod-nodeselector   0/1     Pending   0          2m20s   &lt;none&gt;   &lt;none&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看详情,发现node selector匹配失败的提示</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl describe pods pod-nodeselector -n dev</span></span>
<span class="line"><span style="color:#B392F0;">...</span><span style="color:#79B8FF;">....</span></span>
<span class="line"><span style="color:#85E89D;">Events</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">Type     Reason            Age        From               Message</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">----     ------            ----       ----               -------</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">3 node(s) didn&#39;t match node selector.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#创建Pod</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl create -f pod-nodeselector.yaml</span></span>
<span class="line"><span style="color:#032F62;">pod/pod-nodeselector created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看Pod调度到NODE属性，确实是调度到了node1节点上</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl get pods pod-nodeselector -n dev -o wide</span></span>
<span class="line"><span style="color:#032F62;">NAME               READY   STATUS    RESTARTS   AGE     IP          NODE    ......</span></span>
<span class="line"><span style="color:#032F62;">pod-nodeselector   1/1     Running   0          47s   10.244.1.87   node1   ......</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 接下来，删除pod，修改nodeSelector的值为nodeenv: xxxx（不存在打有此标签的节点）</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl delete -f pod-nodeselector.yaml</span></span>
<span class="line"><span style="color:#032F62;">pod &quot;pod-nodeselector&quot; deleted</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">vim pod-nodeselector.yaml</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl create -f pod-nodeselector.yaml</span></span>
<span class="line"><span style="color:#032F62;">pod/pod-nodeselector created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#再次查看，发现pod无法正常运行,Node的值为none</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#032F62;">NAME               READY   STATUS    RESTARTS   AGE     IP       NODE</span><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#032F62;">pod-nodeselector   0/1     Pending   0          2m20s   &lt;none&gt;   &lt;none&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看详情,发现node selector匹配失败的提示</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl describe pods pod-nodeselector -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">...</span><span style="color:#005CC5;">....</span></span>
<span class="line"><span style="color:#22863A;">Events</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">Type     Reason            Age        From               Message</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">----     ------            ----       ----               -------</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available</span><span style="color:#24292E;">: </span><span style="color:#032F62;">3 node(s) didn&#39;t match node selector.</span></span></code></pre></div><h2 id="_1-2-什么是节点亲和" tabindex="-1">1.2 什么是节点亲和 <a class="header-anchor" href="#_1-2-什么是节点亲和" aria-label="Permalink to &quot;1.2 什么是节点亲和&quot;">​</a></h2><p>节点亲和是指，Pod自身对期望运行的某类节点的倾向性，倾向于运行指定的节点即为“亲和&quot;关系，否则即为”反亲和&quot;关系。</p><p>要想实现亲和调度，首先需要在节点上定义便签，而后在Pod对象上通过标签选择器来选择对应的节点标签。而支持这种调度机制的有<code>NodeSeLector</code>和<code>NodeAffinity</code>调度插件。</p><p>但<code>nodeSelector</code>节点选择器，只能选择拥有指定标签的节点，其实现逻辑较为简单，控制粒度不够细。而nodeAffinity节点亲和，提供对选择逻辑，更强的控制能力。</p><h2 id="_1-3-节点亲和策略" tabindex="-1">1.3 节点亲和策略 <a class="header-anchor" href="#_1-3-节点亲和策略" aria-label="Permalink to &quot;1.3 节点亲和策略&quot;">​</a></h2><p>在Pod上定义节点亲和（nodeAffinity）时有两类亲和关系;(required）强制/硬亲和、(preferred）首选/软亲和。</p><p><code>强制亲和</code>：限定了调度Pod资源时必须满足的规则，如没有可用节点时Pod对象会被置为Pending状态，直到满足规则的节点出现<code>软亲和</code>：相对来强制亲和来说它更加的柔和，它倾向将Pod运行在某类特定的节点上，但无法满足调度需求时，调度器将选择一个无法匹配规则的节点，而非将Pod对象置为Pending状态。</p><p><code>requiredDuringSchedulingIgnoredDuringExecution</code>：调度器只有在规则被满足的时候才能执行调度，强制策略。</p><p><code>preferredDuringSchedulingIgnoredDuringExecution</code>:调度器会尝试寻找满足对应规则的节点，软性亲和。</p><h3 id="nodeaffinity" tabindex="-1"><strong>NodeAffinity</strong> <a class="header-anchor" href="#nodeaffinity" aria-label="Permalink to &quot;**NodeAffinity**&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">affinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">nodeAffinity</span><span style="color:#E1E4E8;">:   </span><span style="color:#6A737D;">#节点亲和力配置</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">:  </span><span style="color:#6A737D;">#硬亲和力配置</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">nodeSelectorTerms</span><span style="color:#E1E4E8;">:   </span><span style="color:#6A737D;">#节点选择器配置，只能配置一个</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">:  </span><span style="color:#6A737D;">#匹配条件设置，可以配置多个，如果是多个他们是或的关系，所有条件都可以被匹配</span></span>
<span class="line"><span style="color:#E1E4E8;">              - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">#匹配的node的key设置,可以配置多个，如果配置多个key他们的关系为and，即需要满足所有的条件才会被匹配</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span><span style="color:#E1E4E8;">     </span><span style="color:#6A737D;">#匹配方式，有多种</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:          </span><span style="color:#6A737D;">#key值，可以写多个</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#9ECBFF;">&quot;68&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#9ECBFF;">&quot;69&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">              - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ip</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#9ECBFF;">&quot;68&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#9ECBFF;">&quot;70&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">preferredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">:  </span><span style="color:#6A737D;">#软亲和力配置</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">weight</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">#软亲和力的权重，权重越高优先级越大，范围1-100</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">preference</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;">#软亲和力配置项，和weight同级</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;">#匹配条件设置</span></span>
<span class="line"><span style="color:#E1E4E8;">              - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">#匹配的node的key设置,与硬亲和力一致</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#9ECBFF;">&quot;71&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">affinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">nodeAffinity</span><span style="color:#24292E;">:   </span><span style="color:#6A737D;">#节点亲和力配置</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;">#硬亲和力配置</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">nodeSelectorTerms</span><span style="color:#24292E;">:   </span><span style="color:#6A737D;">#节点选择器配置，只能配置一个</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;">#匹配条件设置，可以配置多个，如果是多个他们是或的关系，所有条件都可以被匹配</span></span>
<span class="line"><span style="color:#24292E;">              - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node</span><span style="color:#24292E;">        </span><span style="color:#6A737D;">#匹配的node的key设置,可以配置多个，如果配置多个key他们的关系为and，即需要满足所有的条件才会被匹配</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span><span style="color:#24292E;">     </span><span style="color:#6A737D;">#匹配方式，有多种</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:          </span><span style="color:#6A737D;">#key值，可以写多个</span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#032F62;">&quot;68&quot;</span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#032F62;">&quot;69&quot;</span></span>
<span class="line"><span style="color:#24292E;">              - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ip</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#032F62;">&quot;68&quot;</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#032F62;">&quot;70&quot;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">preferredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;">#软亲和力配置</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">weight</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">   </span><span style="color:#6A737D;">#软亲和力的权重，权重越高优先级越大，范围1-100</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">preference</span><span style="color:#24292E;">: </span><span style="color:#6A737D;">#软亲和力配置项，和weight同级</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">: </span><span style="color:#6A737D;">#匹配条件设置</span></span>
<span class="line"><span style="color:#24292E;">              - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node</span><span style="color:#24292E;">       </span><span style="color:#6A737D;">#匹配的node的key设置,与硬亲和力一致</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#032F62;">&quot;71&quot;</span></span></code></pre></div><p><strong>operator：标签匹配的方式</strong>：</p><ul><li>In：相当于key = value的形式</li><li>NotIn：相当于key != value的形式</li><li>Exists：节点存在label的key为指定的值即可，不能配置values字段</li><li>DoesNotExist：节点不存在label的key为指定的值即可，不能配置values字段</li><li>Gt：大于value指定的值</li><li>Lt：小于value指定的值</li></ul><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p><strong>节点清和力配置注意事项</strong>：</p><ol><li>硬亲和力与软亲和力只能选择一个进行设置，如果同时设置软亲和力将不生效</li><li>valuse的值最好使用字符串的形式配置加<code>&quot;&quot;</code>，否则在一些情况下会报错，除了Gt与Lt</li><li>亲和力配置不要写的过于复杂，否则会极大的降低k8s调度Pod的效率，也不利于运维人员进行维护</li></ol></div><h4 id="硬限制" tabindex="-1">硬限制 <a class="header-anchor" href="#硬限制" aria-label="Permalink to &quot;硬限制&quot;">​</a></h4><p><strong>requiredDuringSchedulingIgnoredDuringExecution</strong></p><p>创建pod-nodeaffinity-required.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod-nodeaffinity-required</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dev</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">affinity</span><span style="color:#E1E4E8;">:  </span><span style="color:#6A737D;">#亲和性设置</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nodeAffinity</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;">#设置node亲和性</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;"># 硬限制</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">nodeSelectorTerms</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nodeenv</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;xxx&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;yyy&quot;</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod-nodeaffinity-required</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">affinity</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;">#亲和性设置</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nodeAffinity</span><span style="color:#24292E;">: </span><span style="color:#6A737D;">#设置node亲和性</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 硬限制</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">nodeSelectorTerms</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nodeenv</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">values</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;xxx&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;yyy&quot;</span><span style="color:#24292E;">]</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 创建pod</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl create -f pod-nodeaffinity-required.yaml</span></span>
<span class="line"><span style="color:#9ECBFF;">pod/pod-nodeaffinity-required created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看pod状态 （运行失败）</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl get pods pod-nodeaffinity-required -n dev -o wide</span></span>
<span class="line"><span style="color:#9ECBFF;">NAME                        READY   STATUS    RESTARTS   AGE   IP       NODE    ......</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#9ECBFF;">pod-nodeaffinity-required   0/1     Pending   0          16s   &lt;none&gt;   &lt;none&gt;  ......</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看Pod的详情</span></span>
<span class="line"><span style="color:#6A737D;"># 发现调度失败，提示node选择失败</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl describe pod pod-nodeaffinity-required -n dev</span></span>
<span class="line"><span style="color:#B392F0;">...</span><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">3 node(s) didn&#39;t match node selector.</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">3 node(s) didn&#39;t match node selector.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#接下来，停止pod</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl delete -f pod-nodeaffinity-required.yaml</span></span>
<span class="line"><span style="color:#9ECBFF;">pod &quot;pod-nodeaffinity-required&quot; deleted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 修改文件，将values: [&quot;xxx&quot;,&quot;yyy&quot;]------&gt; [&quot;pro&quot;,&quot;yyy&quot;]</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">vim pod-nodeaffinity-required.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 再次启动</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl create -f pod-nodeaffinity-required.yaml</span></span>
<span class="line"><span style="color:#9ECBFF;">pod/pod-nodeaffinity-required created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 此时查看，发现调度成功，已经将pod调度到了node1上</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl get pods pod-nodeaffinity-required -n dev -o wide</span></span>
<span class="line"><span style="color:#9ECBFF;">NAME                        READY   STATUS    RESTARTS   AGE   IP            NODE  ......</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#9ECBFF;">pod-nodeaffinity-required   1/1     Running   0          11s   10.244.1.89   node1 ......</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 创建pod</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl create -f pod-nodeaffinity-required.yaml</span></span>
<span class="line"><span style="color:#032F62;">pod/pod-nodeaffinity-required created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看pod状态 （运行失败）</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl get pods pod-nodeaffinity-required -n dev -o wide</span></span>
<span class="line"><span style="color:#032F62;">NAME                        READY   STATUS    RESTARTS   AGE   IP       NODE    ......</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#032F62;">pod-nodeaffinity-required   0/1     Pending   0          16s   &lt;none&gt;   &lt;none&gt;  ......</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看Pod的详情</span></span>
<span class="line"><span style="color:#6A737D;"># 发现调度失败，提示node选择失败</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl describe pod pod-nodeaffinity-required -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">...</span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available</span><span style="color:#24292E;">: </span><span style="color:#032F62;">3 node(s) didn&#39;t match node selector.</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available</span><span style="color:#24292E;">: </span><span style="color:#032F62;">3 node(s) didn&#39;t match node selector.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#接下来，停止pod</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl delete -f pod-nodeaffinity-required.yaml</span></span>
<span class="line"><span style="color:#032F62;">pod &quot;pod-nodeaffinity-required&quot; deleted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 修改文件，将values: [&quot;xxx&quot;,&quot;yyy&quot;]------&gt; [&quot;pro&quot;,&quot;yyy&quot;]</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">vim pod-nodeaffinity-required.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 再次启动</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl create -f pod-nodeaffinity-required.yaml</span></span>
<span class="line"><span style="color:#032F62;">pod/pod-nodeaffinity-required created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 此时查看，发现调度成功，已经将pod调度到了node1上</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl get pods pod-nodeaffinity-required -n dev -o wide</span></span>
<span class="line"><span style="color:#032F62;">NAME                        READY   STATUS    RESTARTS   AGE   IP            NODE  ......</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#032F62;">pod-nodeaffinity-required   1/1     Running   0          11s   10.244.1.89   node1 ......</span></span></code></pre></div><h4 id="软限制" tabindex="-1">软限制 <a class="header-anchor" href="#软限制" aria-label="Permalink to &quot;软限制&quot;">​</a></h4><p><strong>preferredDuringSchedulingIgnoredDuringExecution</strong></p><p>创建pod-nodeaffinity-preferred.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod-nodeaffinity-preferred</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dev</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">affinity</span><span style="color:#E1E4E8;">:  </span><span style="color:#6A737D;">#亲和性设置</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nodeAffinity</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;">#设置node亲和性</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">preferredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;"># 软限制</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">weight</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">preference</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签(当前环境没有)</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nodeenv</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;xxx&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;yyy&quot;</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod-nodeaffinity-preferred</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">affinity</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;">#亲和性设置</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nodeAffinity</span><span style="color:#24292E;">: </span><span style="color:#6A737D;">#设置node亲和性</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">preferredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 软限制</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">weight</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">preference</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签(当前环境没有)</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nodeenv</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">values</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;xxx&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;yyy&quot;</span><span style="color:#24292E;">]</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 创建pod</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@k8s-master01 ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl create -f pod-nodeaffinity-preferred.yaml</span></span>
<span class="line"><span style="color:#9ECBFF;">pod/pod-nodeaffinity-preferred created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看pod状态 （运行成功）</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@k8s-master01 ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl get pod pod-nodeaffinity-preferred -n dev</span></span>
<span class="line"><span style="color:#9ECBFF;">NAME                         READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#9ECBFF;">pod-nodeaffinity-preferred   1/1     Running   0          40s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 创建pod</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@k8s-master01 ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl create -f pod-nodeaffinity-preferred.yaml</span></span>
<span class="line"><span style="color:#032F62;">pod/pod-nodeaffinity-preferred created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看pod状态 （运行成功）</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@k8s-master01 ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl get pod pod-nodeaffinity-preferred -n dev</span></span>
<span class="line"><span style="color:#032F62;">NAME                         READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#032F62;">pod-nodeaffinity-preferred   1/1     Running   0          40s</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">💡 说明</p><p>NodeAffinity规则设置的注意事项：</p><p>​ 1.如果同时定义了nodeSelector和nodeAffinity，那么必须两个条件都得到满足，Pod才能运行在指定的Node上</p><p>​ 2.如果nodeAffinity指定了多个nodeSelectorTerms，那么只需要其中一个能够匹配成功即可</p><p>​ 3.如果一个nodeSelectorTerms中有多个matchExpressions ，则一个节点必须满足所有的才能匹配成功</p><p>​ 4.如果一个pod所在的Node在Pod运行期间其标签发生了改变，不再符合该Pod的节点亲和性需求，则系统将忽略此变化</p></div><h2 id="_1-4-节点亲和操作符" tabindex="-1">1.4 节点亲和操作符 <a class="header-anchor" href="#_1-4-节点亲和操作符" aria-label="Permalink to &quot;1.4 节点亲和操作符&quot;">​</a></h2><p>可以使用 <code>operator</code> 字段来为 Kubernetes 设置在解释规则时要使用的逻辑操作符</p><table><thead><tr><th>操作符</th><th>含义</th></tr></thead><tbody><tr><td>In</td><td>匹配节点标签对应的值是否在列表中,如果在则条件成立；</td></tr><tr><td>NotIn</td><td>匹配节点标签值是否不在列表中，如果不在则条件成立；</td></tr><tr><td>Exists</td><td>匹配节点的标签名称只要存在，则条件成立；key必须存在，value可以是任意的</td></tr><tr><td>DoesNotExist</td><td>匹配不到对应标签名称，则条件成立；key不能存在</td></tr><tr><td>Gt</td><td>匹配到的标签值，如果大于则条件成立；比如CPU核心数大于2，则...</td></tr><tr><td>Lt</td><td>匹配到的标签值，如果小于则条件成立；比如CPU核心数小于1，则...</td></tr></tbody></table><p><code>NodeAffinity</code>的可配置项：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">pod.spec.affinity.nodeAffinity</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">requiredDuringSchedulingIgnoredDuringExecution  Node节点必须满足指定的所有规则才可以，相当于硬限制</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">nodeSelectorTerms  节点选择列表</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">matchFields   按节点字段列出的节点选择器要求列表</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">matchExpressions   按节点标签列出的节点选择器要求列表(推荐)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">key    键</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">values 值</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">operat or 关系符 支持Exists, DoesNotExist, In, NotIn, Gt, Lt</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">preferredDuringSchedulingIgnoredDuringExecution 优先调度到满足指定的规则的Node，相当于软限制 (倾向)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">preference   一个节点选择器项，与相应的权重相关联</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">matchFields   按节点字段列出的节点选择器要求列表</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">matchExpressions   按节点标签列出的节点选择器要求列表(推荐)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">key    键</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">values 值</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">operator 关系符 支持In, NotIn, Exists, DoesNotExist, Gt, Lt</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">weight 倾向权重，在范围1-100。</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">pod.spec.affinity.nodeAffinity</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">requiredDuringSchedulingIgnoredDuringExecution  Node节点必须满足指定的所有规则才可以，相当于硬限制</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">nodeSelectorTerms  节点选择列表</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">matchFields   按节点字段列出的节点选择器要求列表</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">matchExpressions   按节点标签列出的节点选择器要求列表(推荐)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">key    键</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">values 值</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">operat or 关系符 支持Exists, DoesNotExist, In, NotIn, Gt, Lt</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">preferredDuringSchedulingIgnoredDuringExecution 优先调度到满足指定的规则的Node，相当于软限制 (倾向)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">preference   一个节点选择器项，与相应的权重相关联</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">matchFields   按节点字段列出的节点选择器要求列表</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#032F62;">matchExpressions   按节点标签列出的节点选择器要求列表(推荐)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">key    键</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">values 值</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">operator 关系符 支持In, NotIn, Exists, DoesNotExist, Gt, Lt</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">weight 倾向权重，在范围1-100。</span></span></code></pre></div><h2 id="_1-5-表达式" tabindex="-1">1.5 表达式 <a class="header-anchor" href="#_1-5-表达式" aria-label="Permalink to &quot;1.5 表达式&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">关系符的使用说明</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nodeenv</span><span style="color:#E1E4E8;">              </span><span style="color:#6A737D;"># 匹配存在标签的key为nodeenv的节点</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Exists</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nodeenv</span><span style="color:#E1E4E8;">              </span><span style="color:#6A737D;"># 匹配标签的key为nodeenv,且value是&quot;xxx&quot;或&quot;yyy&quot;的节点</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;xxx&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;yyy&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nodeenv</span><span style="color:#E1E4E8;">              </span><span style="color:#6A737D;"># 匹配标签的key为nodeenv,且value大于&quot;xxx&quot;的节点</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Gt</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;xxx&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">关系符的使用说明</span><span style="color:#24292E;">:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nodeenv</span><span style="color:#24292E;">              </span><span style="color:#6A737D;"># 匹配存在标签的key为nodeenv的节点</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Exists</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nodeenv</span><span style="color:#24292E;">              </span><span style="color:#6A737D;"># 匹配标签的key为nodeenv,且value是&quot;xxx&quot;或&quot;yyy&quot;的节点</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">values</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;xxx&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;yyy&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nodeenv</span><span style="color:#24292E;">              </span><span style="color:#6A737D;"># 匹配标签的key为nodeenv,且value大于&quot;xxx&quot;的节点</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Gt</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">values</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;xxx&quot;</span></span></code></pre></div><h3 id="多个matchexpressions" tabindex="-1">多个matchExpressions <a class="header-anchor" href="#多个matchexpressions" aria-label="Permalink to &quot;多个matchExpressions&quot;">​</a></h3><p>如果在<code>nodeSelectorTerms</code>中指定了<code>多</code>个<code>matchExpressions</code>的话，只要有一个条件满足，Pod就可以被调度到对应的节点上。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">affinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nodeAffinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">nodeSelectorTerms</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes.io/os</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#9ECBFF;">linux</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes.io/arch</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#9ECBFF;">amd64</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">affinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nodeAffinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">nodeSelectorTerms</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes.io/os</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#032F62;">linux</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes.io/arch</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#032F62;">amd64</span></span></code></pre></div><p>案例：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">athena</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">athena</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">athena</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">athena</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">athena:2.0.0</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">affinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">nodeAffinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">preferredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;"># 满足条件的节点会加分，值支持（1-100），分数越高，优先级越高</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;"># 不加的话，满足条件的节点权重也为0，不能保证其优先级。</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">weight</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">preference</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                  - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">hardware-type</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                      - </span><span style="color:#9ECBFF;">gpu</span></span>
<span class="line"><span style="color:#E1E4E8;">                  - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes.io/zone</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                      - </span><span style="color:#9ECBFF;">cn-shenzhen-1</span></span>
<span class="line"><span style="color:#E1E4E8;">                      - </span><span style="color:#9ECBFF;">cn-shenzhen-2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">athena</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">athena</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">athena</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">athena</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">athena:2.0.0</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">affinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">nodeAffinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">preferredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;"># 满足条件的节点会加分，值支持（1-100），分数越高，优先级越高</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;"># 不加的话，满足条件的节点权重也为0，不能保证其优先级。</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">weight</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">preference</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                  - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">hardware-type</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                      - </span><span style="color:#032F62;">gpu</span></span>
<span class="line"><span style="color:#24292E;">                  - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes.io/zone</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                      - </span><span style="color:#032F62;">cn-shenzhen-1</span></span>
<span class="line"><span style="color:#24292E;">                      - </span><span style="color:#032F62;">cn-shenzhen-2</span></span></code></pre></div><h3 id="多个条件-key" tabindex="-1">多个条件(key) <a class="header-anchor" href="#多个条件-key" aria-label="Permalink to &quot;多个条件(key)&quot;">​</a></h3><p>如果在<code>matchExpressions</code>中指定了多个条件，则<code>matchExpressions</code>所有条件都满足时，Pod才可以被调度到节点上。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">affinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nodeAffinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">nodeSelectorTerms</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes.io/os</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#9ECBFF;">linux</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes.io/arch</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#9ECBFF;">amd64</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">affinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nodeAffinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">nodeSelectorTerms</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes.io/os</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#032F62;">linux</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes.io/arch</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#032F62;">amd64</span></span></code></pre></div><h3 id="同时指定nodeselector-和-nodeaffinity" tabindex="-1">同时指定nodeSelector 和 nodeAffinity <a class="header-anchor" href="#同时指定nodeselector-和-nodeaffinity" aria-label="Permalink to &quot;同时指定nodeSelector 和 nodeAffinity&quot;">​</a></h3><p>如果你同时指定了<code>nodeSelector和nodeAffinity</code>，两者必须都要满足，才能将Pod调度到候选节点上。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#节点为linux，同时arch必须为amd64，并且disktype为hdd</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">nodeSelector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">kubernetes.io/os</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">linux</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">affinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nodeAffinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">nodeSelectorTerms</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes.io/arch</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#9ECBFF;">amd64</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">disktype</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#9ECBFF;">hdd</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#节点为linux，同时arch必须为amd64，并且disktype为hdd</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">nodeSelector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kubernetes.io/os</span><span style="color:#24292E;">: </span><span style="color:#032F62;">linux</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">affinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nodeAffinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">nodeSelectorTerms</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes.io/arch</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#032F62;">amd64</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">disktype</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#032F62;">hdd</span></span></code></pre></div><h1 id="_2-pod亲和性与反亲和性调度" tabindex="-1">2. Pod亲和性与反亲和性调度 <a class="header-anchor" href="#_2-pod亲和性与反亲和性调度" aria-label="Permalink to &quot;2. Pod亲和性与反亲和性调度&quot;">​</a></h1><p><a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/" target="_blank" rel="noreferrer">https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/</a></p><p><a href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/assign-pods-nodes-using-node-affinity/" target="_blank" rel="noreferrer">https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/assign-pods-nodes-using-node-affinity/</a></p><p><a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/?spm=a2c4g.11186623.2.34.7f4d38f6C1WPWj#affinity-and-anti-affinity" target="_blank" rel="noreferrer">https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/?spm=a2c4g.11186623.2.34.7f4d38f6C1WPWj#affinity-and-anti-affinity</a></p><h2 id="_2-1-什么是pod亲和与反亲和" tabindex="-1">2.1 什么是Pod亲和与反亲和 <a class="header-anchor" href="#_2-1-什么是pod亲和与反亲和" aria-label="Permalink to &quot;2.1 什么是Pod亲和与反亲和&quot;">​</a></h2><p><a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity" target="_blank" rel="noreferrer">文档</a></p><p>介绍了两种定向调度的方式，使用起来非常方便，但是也有一定的问题，那就是如果没有满足条件的Node，那么Pod将不会被运行，即使在集群中还有可用Node列表也不行，这就限制了它的使用场景。</p><p>基于上面的问题，kubernetes还提供了一种亲和性调度（Affinity）。它在NodeSelector的基础之上的进行了扩展，可以通过配置的形式，实现优先选择满足条件的Node进行调度，如果没有，也可以调度到不满足条件的节点上，使调度更加灵活。</p><p>Affinity主要分为三类：</p><ul><li>nodeAffinity(node亲和性）: 以node为目标，解决pod可以调度到哪些node的问题</li><li>podAffinity(pod亲和性) : 以pod为目标，解决pod可以和哪些已存在的pod部署在同一个拓扑域中的问题</li><li>podAntiAffinity(pod反亲和性) : 以pod为目标，解决pod不能和哪些已存在pod部署在同一个拓扑域中的问题</li></ul><div class="warning custom-block"><p class="custom-block-title">💡 说明</p><p>关于亲和性(反亲和性)使用场景的说明：</p><p><strong>亲和性</strong>：如果两个应用频繁交互，那就有必要利用亲和性让两个应用的尽可能的靠近，这样可以减少因网络通信而带来的性能损耗。</p><p><strong>反亲和性</strong>：当应用的采用多副本部署时，有必要采用反亲和性让各个应用实例打散分布在各个node上，这样可以提高服务的高可用性。</p></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl explain pod.spec.affinity</span></span>
<span class="line"><span style="color:#B392F0;">KIND:</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#B392F0;">VERSION:</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">RESOURCE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">affinity</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">Objec</span><span style="color:#E1E4E8;">t</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">DESCRIPTION:</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">If</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">specified,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod&#39;s scheduling constraints</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">     Affinity is a group of affinity scheduling rules.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">FIELDS:</span></span>
<span class="line"><span style="color:#9ECBFF;">   nodeAffinity	&lt;Object&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">     Describes node affinity scheduling rules for the pod.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">   podAffinity	&lt;Object&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">     Describes pod affinity scheduling rules (e.g. co-locate this pod in the</span></span>
<span class="line"><span style="color:#9ECBFF;">     same node, zone, etc. as some other pod(s)).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">   podAntiAffinity	&lt;Object&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">     Describes pod anti-affinity scheduling rules (e.g. avoid putting this pod</span></span>
<span class="line"><span style="color:#9ECBFF;">     in the same node, zone, etc. as some other pod(s)).</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl explain pod.spec.affinity</span></span>
<span class="line"><span style="color:#6F42C1;">KIND:</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#6F42C1;">VERSION:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">v1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">RESOURCE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">affinity</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">Objec</span><span style="color:#24292E;">t</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">DESCRIPTION:</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#6F42C1;">If</span><span style="color:#24292E;"> </span><span style="color:#032F62;">specified,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod&#39;s scheduling constraints</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">     Affinity is a group of affinity scheduling rules.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">FIELDS:</span></span>
<span class="line"><span style="color:#032F62;">   nodeAffinity	&lt;Object&gt;</span></span>
<span class="line"><span style="color:#032F62;">     Describes node affinity scheduling rules for the pod.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">   podAffinity	&lt;Object&gt;</span></span>
<span class="line"><span style="color:#032F62;">     Describes pod affinity scheduling rules (e.g. co-locate this pod in the</span></span>
<span class="line"><span style="color:#032F62;">     same node, zone, etc. as some other pod(s)).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">   podAntiAffinity	&lt;Object&gt;</span></span>
<span class="line"><span style="color:#032F62;">     Describes pod anti-affinity scheduling rules (e.g. avoid putting this pod</span></span>
<span class="line"><span style="color:#032F62;">     in the same node, zone, etc. as some other pod(s)).</span></span></code></pre></div><h3 id="podaffinity" tabindex="-1">PodAffinity <a class="header-anchor" href="#podaffinity" aria-label="Permalink to &quot;PodAffinity&quot;">​</a></h3><p>PodAffinity主要实现以运行的Pod为参照，实现让新创建的Pod跟参照pod在一个区域的功能。</p><p>看一下<code>PodAffinity</code>的可配置项：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">pod.spec.affinity.podAffinity</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">affinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">podAntiAffinity</span><span style="color:#E1E4E8;">:   </span><span style="color:#6A737D;">#Pod反亲和配置与亲和配置一致，可以与Pod亲和一起存在</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">podAffinity</span><span style="color:#E1E4E8;">:       </span><span style="color:#6A737D;">#Pod亲和配置，可以与Pod反亲和一起存在</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">:  </span><span style="color:#6A737D;">#硬亲和，与软亲和只能选择其中一种</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">labelSelector</span><span style="color:#E1E4E8;">:               </span><span style="color:#6A737D;">#Pod标签选择器</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">:   </span><span style="color:#6A737D;">#和节点亲和力配置一致，只能配置1个</span></span>
<span class="line"><span style="color:#E1E4E8;">              - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">name</span><span style="color:#E1E4E8;">         </span><span style="color:#6A737D;">#pod的标签设置可以设置多个，多个key必须存在于1个Pod</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">#配置和节点亲和力一致，但是没有Gt和Lt</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#9ECBFF;">&quot;blackbox&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#9ECBFF;">&quot;blackbox-1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">namespaces</span><span style="color:#E1E4E8;">:     </span><span style="color:#6A737D;"># 和哪个命名空间的Pod进行匹配，为空为当前命名空间</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#9ECBFF;">helm</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">topologyKey</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes.io/hostname</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#匹配的拓扑域的key，也就是节点上label的key，key和value相同的为同一个域，可以用于标注不同的机房和地区</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">preferredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">:  </span><span style="color:#6A737D;">#软亲和，与硬亲和只能选择其中一种</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">weight</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">#权重1-100</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">podAffinityTerm</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">labelSelector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">security</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                  - </span><span style="color:#9ECBFF;">S2</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">namespaces</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              - </span><span style="color:#9ECBFF;">default</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">topologyKey</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">failure-domain.beta.kubernetes.io/zone</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#根据实际情况修改</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">pod.spec.affinity.podAffinity</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">affinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">podAntiAffinity</span><span style="color:#24292E;">:   </span><span style="color:#6A737D;">#Pod反亲和配置与亲和配置一致，可以与Pod亲和一起存在</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">podAffinity</span><span style="color:#24292E;">:       </span><span style="color:#6A737D;">#Pod亲和配置，可以与Pod反亲和一起存在</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;">#硬亲和，与软亲和只能选择其中一种</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">labelSelector</span><span style="color:#24292E;">:               </span><span style="color:#6A737D;">#Pod标签选择器</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">:   </span><span style="color:#6A737D;">#和节点亲和力配置一致，只能配置1个</span></span>
<span class="line"><span style="color:#24292E;">              - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">name</span><span style="color:#24292E;">         </span><span style="color:#6A737D;">#pod的标签设置可以设置多个，多个key必须存在于1个Pod</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span><span style="color:#24292E;">      </span><span style="color:#6A737D;">#配置和节点亲和力一致，但是没有Gt和Lt</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#032F62;">&quot;blackbox&quot;</span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#032F62;">&quot;blackbox-1&quot;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">namespaces</span><span style="color:#24292E;">:     </span><span style="color:#6A737D;"># 和哪个命名空间的Pod进行匹配，为空为当前命名空间</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#032F62;">helm</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">topologyKey</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes.io/hostname</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">#匹配的拓扑域的key，也就是节点上label的key，key和value相同的为同一个域，可以用于标注不同的机房和地区</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">preferredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;">#软亲和，与硬亲和只能选择其中一种</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">weight</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">    </span><span style="color:#6A737D;">#权重1-100</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">podAffinityTerm</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">labelSelector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">security</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                  - </span><span style="color:#032F62;">S2</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">namespaces</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              - </span><span style="color:#032F62;">default</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">topologyKey</span><span style="color:#24292E;">: </span><span style="color:#032F62;">failure-domain.beta.kubernetes.io/zone</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#根据实际情况修改</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">topologyKey用于指定调度时作用域,例如</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">如果指定为kubernetes.io/hostname，那就是以Node节点为区分范围</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">如果指定为beta.kubernetes.io/os,则以Node节点的操作系统类型来区分</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">topologyKey用于指定调度时作用域,例如</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">如果指定为kubernetes.io/hostname，那就是以Node节点为区分范围</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">如果指定为beta.kubernetes.io/os,则以Node节点的操作系统类型来区分</span></span></code></pre></div><p><strong>operator：标签匹配的方式</strong>：</p><ul><li>In：相当于key = value的形式</li><li>NotIn：相当于key != value的形式</li><li>Exists：节点存在label的key为指定的值即可，不能配置values字段</li><li>DoesNotExist：节点不存在label的key为指定的值即可，不能配置values字段</li></ul><h4 id="案例" tabindex="-1">案例 <a class="header-anchor" href="#案例" aria-label="Permalink to &quot;案例&quot;">​</a></h4><p>演示下<code>requiredDuringSchedulingIgnoredDuringExecution</code>,</p><p>1）首先创建一个参照Pod，pod-podaffinity-target.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod-podaffinity-target</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dev</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">podenv</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pro</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#设置标签</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">nodeName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node1</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 将目标pod名确指定到node1上</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod-podaffinity-target</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">podenv</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pro</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#设置标签</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">nodeName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node1</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 将目标pod名确指定到node1上</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 启动目标pod</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl create -f pod-podaffinity-target.yaml</span></span>
<span class="line"><span style="color:#B392F0;">pod/pod-podaffinity-target</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看pod状况</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get pods  pod-podaffinity-target -n dev</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                     </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">pod-podaffinity-target</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 启动目标pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f pod-podaffinity-target.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">pod/pod-podaffinity-target</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看pod状况</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods  pod-podaffinity-target -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                     </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pod-podaffinity-target</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">s</span></span></code></pre></div><p>2）创建pod-podaffinity-required.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod-podaffinity-required</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dev</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">affinity</span><span style="color:#E1E4E8;">:  </span><span style="color:#6A737D;">#亲和性设置</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">podAffinity</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;">#设置pod亲和性</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;"># 硬限制</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">labelSelector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">podenv</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;xxx&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;yyy&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">topologyKey</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes.io/hostname</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod-podaffinity-required</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">affinity</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;">#亲和性设置</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">podAffinity</span><span style="color:#24292E;">: </span><span style="color:#6A737D;">#设置pod亲和性</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 硬限制</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">labelSelector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">podenv</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">values</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;xxx&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;yyy&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">topologyKey</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes.io/hostname</span></span></code></pre></div><p>上面配置表达的意思是：新Pod必须要与拥有标签nodeenv=xxx或者nodeenv=yyy的pod在同一Node上，显然现在没有这样pod</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 启动pod</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl create -f pod-podaffinity-required.yaml</span></span>
<span class="line"><span style="color:#B392F0;">pod/pod-podaffinity-required</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看pod状态，发现未运行</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get pods pod-podaffinity-required -n dev</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                       </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">pod-podaffinity-required</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Pending</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">9</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看详细信息</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl describe pods pod-podaffinity-required  -n dev</span></span>
<span class="line"><span style="color:#79B8FF;">......</span></span>
<span class="line"><span style="color:#B392F0;">Events:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Type</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Reason</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">Age</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">From</span><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">Message</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">----</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">------</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">----</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">----</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">-------</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">Warning</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">FailedScheduling</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">unknow</span><span style="color:#E1E4E8;">n</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">default-scheduler</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">are</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">available:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">s</span><span style="color:#E1E4E8;">) </span><span style="color:#9ECBFF;">didn&#39;t match pod affinity rules, 1 node(s) had taints that the pod didn&#39;t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tolerate.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 接下来修改  values: [&quot;xxx&quot;,&quot;yyy&quot;]-----&gt;values:[&quot;pro&quot;,&quot;yyy&quot;]</span></span>
<span class="line"><span style="color:#6A737D;"># 意思是：新Pod必须要与拥有标签nodeenv=xxx或者nodeenv=yyy的pod在同一Node上</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# vim pod-podaffinity-required.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 然后重新创建pod，查看效果</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl delete -f  pod-podaffinity-required.yaml</span></span>
<span class="line"><span style="color:#B392F0;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;pod-podaffinity-required&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">de</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">leted</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl create -f pod-podaffinity-required.yaml</span></span>
<span class="line"><span style="color:#B392F0;">pod/pod-podaffinity-required</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 发现此时Pod运行正常</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get pods pod-podaffinity-required -n dev</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                       </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">LABELS</span></span>
<span class="line"><span style="color:#B392F0;">pod-podaffinity-required</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">6</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 启动pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f pod-podaffinity-required.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">pod/pod-podaffinity-required</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看pod状态，发现未运行</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods pod-podaffinity-required -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                       </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pod-podaffinity-required</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">9</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看详细信息</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl describe pods pod-podaffinity-required  -n dev</span></span>
<span class="line"><span style="color:#005CC5;">......</span></span>
<span class="line"><span style="color:#6F42C1;">Events:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Type</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Reason</span><span style="color:#24292E;">            </span><span style="color:#032F62;">Age</span><span style="color:#24292E;">        </span><span style="color:#032F62;">From</span><span style="color:#24292E;">               </span><span style="color:#032F62;">Message</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">----</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">------</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">----</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">----</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">-------</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">Warning</span><span style="color:#24292E;">  </span><span style="color:#032F62;">FailedScheduling</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">unknow</span><span style="color:#24292E;">n</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">  </span><span style="color:#032F62;">default-scheduler</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">are</span><span style="color:#24292E;"> </span><span style="color:#032F62;">available:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">s</span><span style="color:#24292E;">) </span><span style="color:#032F62;">didn&#39;t match pod affinity rules, 1 node(s) had taints that the pod didn&#39;t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tolerate.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 接下来修改  values: [&quot;xxx&quot;,&quot;yyy&quot;]-----&gt;values:[&quot;pro&quot;,&quot;yyy&quot;]</span></span>
<span class="line"><span style="color:#6A737D;"># 意思是：新Pod必须要与拥有标签nodeenv=xxx或者nodeenv=yyy的pod在同一Node上</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# vim pod-podaffinity-required.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 然后重新创建pod，查看效果</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl delete -f  pod-podaffinity-required.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pod-podaffinity-required&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">de</span><span style="color:#24292E;"> </span><span style="color:#032F62;">leted</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f pod-podaffinity-required.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">pod/pod-podaffinity-required</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 发现此时Pod运行正常</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods pod-podaffinity-required -n dev</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                       </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">LABELS</span></span>
<span class="line"><span style="color:#6F42C1;">pod-podaffinity-required</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">s</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><h3 id="podantiaffinity" tabindex="-1"><strong>PodAntiAffinity</strong> <a class="header-anchor" href="#podantiaffinity" aria-label="Permalink to &quot;**PodAntiAffinity**&quot;">​</a></h3><p>PodAntiAffinity主要实现以运行的Pod为参照，让新创建的Pod跟参照pod不在一个区域中的功能。</p><p>它的配置方式和选项跟PodAffinty是一样的</p><p>1）继续使用上个案例中目标pod</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get pods -n dev -o wide --show-labels</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                     </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">IP</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">LABELS</span></span>
<span class="line"><span style="color:#B392F0;">pod-podaffinity-required</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">m29s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.244</span><span style="color:#9ECBFF;">.1.38</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">node1</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">     </span></span>
<span class="line"><span style="color:#B392F0;">pod-podaffinity-target</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">9</span><span style="color:#9ECBFF;">m25s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.244</span><span style="color:#9ECBFF;">.1.37</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">node1</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">podenv=pro</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods -n dev -o wide --show-labels</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                     </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">     </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">            </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">    </span><span style="color:#032F62;">LABELS</span></span>
<span class="line"><span style="color:#6F42C1;">pod-podaffinity-required</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">m29s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.38</span><span style="color:#24292E;">   </span><span style="color:#032F62;">node1</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">     </span></span>
<span class="line"><span style="color:#6F42C1;">pod-podaffinity-target</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">9</span><span style="color:#032F62;">m25s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.37</span><span style="color:#24292E;">   </span><span style="color:#032F62;">node1</span><span style="color:#24292E;">   </span><span style="color:#032F62;">podenv=pro</span></span></code></pre></div><p>2）创建pod-podantiaffinity-required.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod-podantiaffinity-required</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dev</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">affinity</span><span style="color:#E1E4E8;">:  </span><span style="color:#6A737D;">#亲和性设置</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">podAntiAffinity</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;">#设置pod亲和性</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;"># 硬限制</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">labelSelector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;"># 匹配podenv的值在[&quot;pro&quot;]中的标签</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">podenv</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;pro&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">topologyKey</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes.io/hostname</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod-podantiaffinity-required</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">affinity</span><span style="color:#24292E;">:  </span><span style="color:#6A737D;">#亲和性设置</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">podAntiAffinity</span><span style="color:#24292E;">: </span><span style="color:#6A737D;">#设置pod亲和性</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 硬限制</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">labelSelector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 匹配podenv的值在[&quot;pro&quot;]中的标签</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">podenv</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">values</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;pro&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">topologyKey</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes.io/hostname</span></span></code></pre></div><p>上面新Pod必须要与拥有标签nodeenv=pro的pod不在同一Node上</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 创建pod</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl create -f pod-podantiaffinity-required.yaml</span></span>
<span class="line"><span style="color:#B392F0;">pod/pod-podantiaffinity-required</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看pod</span></span>
<span class="line"><span style="color:#6A737D;"># 发现调度到了node2上</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get pods pod-podantiaffinity-required -n dev -o wide</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                           </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">IP</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">..</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#B392F0;">pod-podantiaffinity-required</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">30</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.244</span><span style="color:#9ECBFF;">.1.96</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">node2</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">..</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 创建pod</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl create -f pod-podantiaffinity-required.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">pod/pod-podantiaffinity-required</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看pod</span></span>
<span class="line"><span style="color:#6A737D;"># 发现调度到了node2上</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods pod-podantiaffinity-required -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                           </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">            </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">..</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">pod-podantiaffinity-required</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">30</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.96</span><span style="color:#24292E;">   </span><span style="color:#032F62;">node2</span><span style="color:#24292E;">  </span><span style="color:#032F62;">..</span></span></code></pre></div><h2 id="_2-2-pod亲和与反亲和位置拓扑" tabindex="-1">2.2 Pod亲和与反亲和位置拓扑 <a class="header-anchor" href="#_2-2-pod亲和与反亲和位置拓扑" aria-label="Permalink to &quot;2.2 Pod亲和与反亲和位置拓扑&quot;">​</a></h2><p>定义位置的方法很简单，无外乎就是在节点上选定一个特定的节点标签，可以理解为拓扑标签/位置标签，当我们选择一个节点标签作为位置判定逻辑时，具有同一标签值的就是同一位置，具有不同标签值的就是不同位置。</p><h3 id="配置" tabindex="-1">配置 <a class="header-anchor" href="#配置" aria-label="Permalink to &quot;配置&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">example-pod</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 配置一个拓扑分布约束</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">topologySpreadConstraints</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">maxSkew</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&lt;integer&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 必须大于0，全局最小差值，就是各个拓扑域之间 Pod 的最大差值</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">minDomains</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&lt;integer&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 可选；自从 v1.25 开始成为 Beta</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">topologyKey</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&lt;string&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 是节点标签的键</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">whenUnsatisfiable</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&lt;string&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 不满足分布约束时如何处理</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labelSelector</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&lt;object&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 用于查找匹配的 Pod</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">matchLabelKeys</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&lt;list&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 可选；自从 v1.27 开始成为 Beta</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">nodeAffinityPolicy</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">Honor|Ignore</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;"># 可选；自从 v1.26 开始成为 Beta</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">nodeTaintsPolicy</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">Honor|Ignore</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;"># 可选；自从 v1.26 开始成为 Beta</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">### 其他 Pod 字段置于此处</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">example-pod</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 配置一个拓扑分布约束</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">topologySpreadConstraints</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">maxSkew</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&lt;integer&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 必须大于0，全局最小差值，就是各个拓扑域之间 Pod 的最大差值</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">minDomains</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&lt;integer&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 可选；自从 v1.25 开始成为 Beta</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">topologyKey</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&lt;string&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 是节点标签的键</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">whenUnsatisfiable</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&lt;string&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 不满足分布约束时如何处理</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labelSelector</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&lt;object&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 用于查找匹配的 Pod</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">matchLabelKeys</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&lt;list&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 可选；自从 v1.27 开始成为 Beta</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">nodeAffinityPolicy</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">Honor|Ignore</span><span style="color:#24292E;">] </span><span style="color:#6A737D;"># 可选；自从 v1.26 开始成为 Beta</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">nodeTaintsPolicy</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">Honor|Ignore</span><span style="color:#24292E;">] </span><span style="color:#6A737D;"># 可选；自从 v1.26 开始成为 Beta</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">### 其他 Pod 字段置于此处</span></span></code></pre></div><p>参数解释</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">maxSkew</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">描述这些</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">可能被均匀分布的程度。你必须指定此字段且该数值必须大于零。</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">例如，如果你有</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">个可用区，分别有</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">、2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">和</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">个匹配的</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Pod，则</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MaxSkew</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">设为</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">，</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">且全局最小值为</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">minDomains</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">表示符合条件的域的最小数量。此字段是可选的。域是拓扑的一个特定实例。</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">符合条件的域是其节点与节点选择器匹配的域。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">topologyKey</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">是节点标签的键。参考节点</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">亲和性。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">whenUnsatisfiable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">指示如果</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">不满足分布约束时如何处理：DoNotSchedule/ScheduleAnyway</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">labelSelector</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">用于查找匹配的</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">matchLabelKeys</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">是一个</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">标签键的列表，这些键值标签与</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">labelSelector</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">进行逻辑与运算。matchLabelKeys</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">和</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">labelSelector</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">中禁止存在相同的键。</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">未设置</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">labelSelector</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">时无法设置</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">matchLabelKeys。Pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">标签中不存在的键将被忽略。</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">或空列表意味着仅与</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">labelSelector</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">匹配。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">nodeAffinityPolicy</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">表示我们在计算</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">拓扑分布偏差时将如何处理</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">的</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodeAffinity/nodeSelector。</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">选项为：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Honor：只有与</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodeAffinity/nodeSelector</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">匹配的节点才会包括到计算中。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Ignore：nodeAffinity/nodeSelector</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">被忽略。所有节点均包括到计算中。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">如果此值为</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nil，此行为等同于</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Honor</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">策略。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">nodeTaintsPolicy</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">表示我们在计算</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">拓扑分布偏差时将如何处理节点污点。选项为：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Honor：包括不带污点的节点以及污点被新</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">所容忍的节点。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Ignore：节点污点被忽略。包括所有节点。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">如果此值为</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">null，此行为等同于</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Ignore</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">策略。</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">maxSkew</span><span style="color:#24292E;"> </span><span style="color:#032F62;">描述这些</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">可能被均匀分布的程度。你必须指定此字段且该数值必须大于零。</span><span style="color:#24292E;"> </span><span style="color:#032F62;">例如，如果你有</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">个可用区，分别有</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">、2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">和</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">个匹配的</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Pod，则</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MaxSkew</span><span style="color:#24292E;"> </span><span style="color:#032F62;">设为</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">，</span><span style="color:#24292E;"> </span><span style="color:#032F62;">且全局最小值为</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">minDomains</span><span style="color:#24292E;"> </span><span style="color:#032F62;">表示符合条件的域的最小数量。此字段是可选的。域是拓扑的一个特定实例。</span><span style="color:#24292E;"> </span><span style="color:#032F62;">符合条件的域是其节点与节点选择器匹配的域。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">topologyKey</span><span style="color:#24292E;"> </span><span style="color:#032F62;">是节点标签的键。参考节点</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">亲和性。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">whenUnsatisfiable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">指示如果</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">不满足分布约束时如何处理：DoNotSchedule/ScheduleAnyway</span><span style="color:#24292E;"> </span><span style="color:#032F62;">。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">labelSelector</span><span style="color:#24292E;"> </span><span style="color:#032F62;">用于查找匹配的</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Pod</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">matchLabelKeys</span><span style="color:#24292E;"> </span><span style="color:#032F62;">是一个</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">标签键的列表，这些键值标签与</span><span style="color:#24292E;"> </span><span style="color:#032F62;">labelSelector</span><span style="color:#24292E;"> </span><span style="color:#032F62;">进行逻辑与运算。matchLabelKeys</span><span style="color:#24292E;"> </span><span style="color:#032F62;">和</span><span style="color:#24292E;"> </span><span style="color:#032F62;">labelSelector</span><span style="color:#24292E;"> </span><span style="color:#032F62;">中禁止存在相同的键。</span><span style="color:#24292E;"> </span><span style="color:#032F62;">未设置</span><span style="color:#24292E;"> </span><span style="color:#032F62;">labelSelector</span><span style="color:#24292E;"> </span><span style="color:#032F62;">时无法设置</span><span style="color:#24292E;"> </span><span style="color:#032F62;">matchLabelKeys。Pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">标签中不存在的键将被忽略。</span><span style="color:#24292E;"> </span><span style="color:#032F62;">null</span><span style="color:#24292E;"> </span><span style="color:#032F62;">或空列表意味着仅与</span><span style="color:#24292E;"> </span><span style="color:#032F62;">labelSelector</span><span style="color:#24292E;"> </span><span style="color:#032F62;">匹配。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">nodeAffinityPolicy</span><span style="color:#24292E;"> </span><span style="color:#032F62;">表示我们在计算</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">拓扑分布偏差时将如何处理</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">的</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodeAffinity/nodeSelector。</span><span style="color:#24292E;"> </span><span style="color:#032F62;">选项为：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Honor：只有与</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodeAffinity/nodeSelector</span><span style="color:#24292E;"> </span><span style="color:#032F62;">匹配的节点才会包括到计算中。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Ignore：nodeAffinity/nodeSelector</span><span style="color:#24292E;"> </span><span style="color:#032F62;">被忽略。所有节点均包括到计算中。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">如果此值为</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nil，此行为等同于</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Honor</span><span style="color:#24292E;"> </span><span style="color:#032F62;">策略。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">nodeTaintsPolicy</span><span style="color:#24292E;"> </span><span style="color:#032F62;">表示我们在计算</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">拓扑分布偏差时将如何处理节点污点。选项为：</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Honor：包括不带污点的节点以及污点被新</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">所容忍的节点。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Ignore：节点污点被忽略。包括所有节点。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">如果此值为</span><span style="color:#24292E;"> </span><span style="color:#032F62;">null，此行为等同于</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Ignore</span><span style="color:#24292E;"> </span><span style="color:#032F62;">策略。</span></span></code></pre></div><h3 id="基于节点" tabindex="-1">基于节点 <a class="header-anchor" href="#基于节点" aria-label="Permalink to &quot;基于节点&quot;">​</a></h3><p>如果使用节点的 kubernetes.io/hostname 标签作为划分标准，由于每个节点的标签值都不同，所以他们有着不同的位置</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406251557016.png" alt="image-20240625155742257"></p><h3 id="基于区域划分" tabindex="-1">基于区域划分 <a class="header-anchor" href="#基于区域划分" aria-label="Permalink to &quot;基于区域划分&quot;">​</a></h3><p>如果基于区域标签划分节点位置，同一位置就表示节点在同一区域，而不同位置则表示在节点在不同的区域；下图node01和node02属于同一位置，而node03和node04属于另一个意义上的同一位置。</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406251601167.png" alt="image-20240625160146594"></p><p>假设PodA运行在beijing区域上，PodB与PodA有亲和关系，那么PodB则应该运行在beijing区域，反之则运行在shanghai区域。所以不管是亲和还是反亲和，它应该是有一个参照系，就是参考某个定义好的Pod，只要它在的地方我不在就是反亲和，或者我必须与它在同一位置，那就是亲和关系。</p><p>案例：</p><p>有两个微服务zeus和athena相互调用比较频繁，他们都有两个副本，出于提升效率和可用性考虑，我想将zeus和athena的副本打散到两个不同的可用区（zone），并让他们的副本必须部署到同一个节点上，假设zeus已经部署好了，那athena的部署可以这样实现</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">athena</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">athena</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">athena</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">athena</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">athena:2.0.0</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">affinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">podAffinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">labelSelector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">zeus</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">topologyKey</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes.io/hostname</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">podAntiAffinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">labelSelector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">athena</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">topologyKey</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">topology.kubernetes.io/zone</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">athena</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">athena</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">athena</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">athena</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">athena:2.0.0</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">affinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">podAffinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">labelSelector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">zeus</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">topologyKey</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes.io/hostname</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">podAntiAffinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">labelSelector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">athena</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">topologyKey</span><span style="color:#24292E;">: </span><span style="color:#032F62;">topology.kubernetes.io/zone</span></span></code></pre></div><h1 id="_3-污点和容忍" tabindex="-1">3. 污点和容忍 <a class="header-anchor" href="#_3-污点和容忍" aria-label="Permalink to &quot;3. 污点和容忍&quot;">​</a></h1><p><a href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/taint-and-toleration/" target="_blank" rel="noreferrer">文档</a></p><h2 id="_3-1-污点-taints" tabindex="-1">3.1 污点（Taints） <a class="header-anchor" href="#_3-1-污点-taints" aria-label="Permalink to &quot;3.1 污点（Taints）&quot;">​</a></h2><p>前面的调度方式都是站在Pod的角度上，通过在Pod上添加属性，来确定Pod是否要调度到指定的Node上，其实我们也可以站在Node的角度上，通过在Node上添加<strong>污点</strong>属性，来决定是否允许Pod调度过来。</p><p><code>污点是节点级的属性</code>，我们可以在一个节点上给它设定一组特殊的属性，为了能更加形象的描述这组属性，我们将其称为污点。一旦对应的节点拥有了污点，Pod则无法调度到该节点上，除非它能容忍这些节点的污点，则可以正常调度到拥有污点的节点上。(<code>污点</code>（Taint） 是应用在节点之上的，从这个名字就可以看出来，是为了排斥pod 所存在的)</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406232147620.png" alt="image-20240623214709906"></p><p>Node被设置上污点之后就和Pod之间存在了一种相斥的关系，进而拒绝Pod调度进来，甚至可以将已经存在的Pod驱逐出去。</p><p>污点的格式为：<code>key=value:effect</code>, key和value是污点的标签，effect描述污点的作用，支持如下三个选项：</p><ul><li>PreferNoSchedule：尽量不要调度，除非没有其他节点可调度</li><li>NoSchedule：一定不能被调度，但不会影响当前Node上已存在的Pod</li><li>NoExecute：不仅不会调度, 还会驱逐 Node 上已有的 Pod</li><li>无法匹配条件时，Pod对象将会被驱逐；属于强制约束关系；</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406211744938.png" alt="image-20240621174447129"></p><p>设置方式</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 设置污点</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">taint</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">key=value:effect</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">describe</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Taints</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-A</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 去除污点</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">taint</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">key:effect-</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 去除所有污点</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">taint</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">key-</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 设置污点</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">taint</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">key=value:effect</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">describe</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodename</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Taints</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-A</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 去除污点</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">taint</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">key:effect-</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 去除所有污点</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">taint</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">key-</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">## 设置污点并不允许 Pod 调度到该节点</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">taint</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-master</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">key1=value1:NoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## 设置污点尽量阻止污点调度到该节点</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">taint</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-master</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">key2=value2:PreferNoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## 设置污点，不允许普通 Pod 调度到该节点，且将该节点上已经存在的 Pod 进行驱逐</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">taint</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-master</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">key3=value3:NoExecute</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">## 设置污点并不允许 Pod 调度到该节点</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">taint</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-master</span><span style="color:#24292E;"> </span><span style="color:#032F62;">key1=value1:NoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## 设置污点尽量阻止污点调度到该节点</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">taint</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-master</span><span style="color:#24292E;"> </span><span style="color:#032F62;">key2=value2:PreferNoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## 设置污点，不允许普通 Pod 调度到该节点，且将该节点上已经存在的 Pod 进行驱逐</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">taint</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-master</span><span style="color:#24292E;"> </span><span style="color:#032F62;">key3=value3:NoExecute</span></span></code></pre></div><h4 id="案例-1" tabindex="-1">案例 <a class="header-anchor" href="#案例-1" aria-label="Permalink to &quot;案例&quot;">​</a></h4><ol><li>准备节点node1（为了演示效果更加明显，暂时停止node2-3节点）</li><li>为node1节点设置一个污点: <code>tag=heima:PreferNoSchedule</code>；然后创建pod1( pod1 可以 )</li><li>修改为node1节点设置一个污点: <code>tag=heima:NoSchedule</code>；然后创建pod2( pod1 正常 pod2 失败 )</li><li>修改为node1节点设置一个污点: <code>tag=heima:NoExecute</code>；然后创建pod3 ( 3个pod都失败 )</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 为node1设置污点(PreferNoSchedule)</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl taint nodes node1 tag=heima:PreferNoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 创建pod1</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl run taint1 --image=nginx:1.17.1 -n dev</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                      </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">IP</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#B392F0;">taint1-7665f7fd85-574h4</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">m24s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.244</span><span style="color:#9ECBFF;">.1.59</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">node1</span><span style="color:#E1E4E8;">    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 为node1设置污点(取消PreferNoSchedule，设置NoSchedule)</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl taint nodes node1 tag:PreferNoSchedule-</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl taint nodes node1 tag=heima:NoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 创建pod2</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl run taint2 --image=nginx:1.17.1 -n dev</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get pods taint2 -n dev -o wide</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                      </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">IP</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">NODE</span></span>
<span class="line"><span style="color:#B392F0;">taint1-7665f7fd85-574h4</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">m24s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.244</span><span style="color:#9ECBFF;">.1.59</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">node1</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#B392F0;">taint2-544694789-6zmlf</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Pending</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">21</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 为node1设置污点(取消NoSchedule，设置NoExecute)</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl taint nodes node1 tag:NoSchedule-</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl taint nodes node1 tag=heima:NoExecute</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 创建pod3</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl run taint3 --image=nginx:1.17.1 -n dev</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-master01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                      </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">IP</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">NOMINATED</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#B392F0;">taint1-7665f7fd85-htkmp</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Pending</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">35</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#B392F0;">taint2-544694789-bn7wb</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Pending</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">35</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">     </span></span>
<span class="line"><span style="color:#B392F0;">taint3-6d78dbd749-tktkq</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Pending</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">6</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 为node1设置污点(PreferNoSchedule)</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl taint nodes node1 tag=heima:PreferNoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 创建pod1</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl run taint1 --image=nginx:1.17.1 -n dev</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                      </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">     </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">           </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#6F42C1;">taint1-7665f7fd85-574h4</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m24s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.59</span><span style="color:#24292E;">   </span><span style="color:#032F62;">node1</span><span style="color:#24292E;">    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 为node1设置污点(取消PreferNoSchedule，设置NoSchedule)</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl taint nodes node1 tag:PreferNoSchedule-</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl taint nodes node1 tag=heima:NoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 创建pod2</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl run taint2 --image=nginx:1.17.1 -n dev</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods taint2 -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                      </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">     </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">            </span><span style="color:#032F62;">NODE</span></span>
<span class="line"><span style="color:#6F42C1;">taint1-7665f7fd85-574h4</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m24s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.244</span><span style="color:#032F62;">.1.59</span><span style="color:#24292E;">   </span><span style="color:#032F62;">node1</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">taint2-544694789-6zmlf</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">21</span><span style="color:#032F62;">s</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 为node1设置污点(取消NoSchedule，设置NoExecute)</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl taint nodes node1 tag:NoSchedule-</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl taint nodes node1 tag=heima:NoExecute</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 创建pod3</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl run taint3 --image=nginx:1.17.1 -n dev</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-master01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                      </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">       </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">     </span><span style="color:#032F62;">NOMINATED</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">taint1-7665f7fd85-htkmp</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">35</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#6F42C1;">taint2-544694789-bn7wb</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">35</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">     </span></span>
<span class="line"><span style="color:#6F42C1;">taint3-6d78dbd749-tktkq</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Pending</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">s</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">💡 说明</p><p>使用kubeadm搭建的集群，默认就会给master节点添加一个污点标记,所以pod就不会调度到master节点上.</p></div><h2 id="_3-2-容忍-toleration" tabindex="-1">3.2 容忍（Toleration） <a class="header-anchor" href="#_3-2-容忍-toleration" aria-label="Permalink to &quot;3.2 容忍（Toleration）&quot;">​</a></h2><p>容忍度（tolerations）是定义在Pod对象上的键值数据，用于配置该Pod可以容忍哪些节点的污点以及污点的效用标识，这样就可以将Pod调度到那些有污点的节点上。(<code>容忍度</code>（Toleration）是应用于 Pod 上的，允许（但并不要求）Pod 调度到带有与之匹配的污点的节点上。)</p><p><code>容忍作用</code>与Pod资源配置在<code>tolerations</code>字段，用于容忍配置在node节点的Taint污点，可以让Pod部署在有污点的node节点</p><p><strong>污点就是拒绝，容忍就是忽略，Node通过污点拒绝pod调度上去，Pod通过容忍忽略拒绝</strong></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406211812993.png" alt="image-20240621181204412"></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl explain pod.spec.tolerations</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl explain pod.spec.tolerations</span></span></code></pre></div><h4 id="pod-设置容忍" tabindex="-1">Pod 设置容忍 <a class="header-anchor" href="#pod-设置容忍" aria-label="Permalink to &quot;Pod 设置容忍&quot;">​</a></h4><p>为了使某些 <code>Pod</code> 禁止调度到某些特定节点上，就可以对节点设置污点 <code>taints</code>。当然，如果希望有些 <code>Pod</code> 能够忽略节点的污点，继续能够调度到该节点，就可以对 <code>Pod</code> 设置容忍，让 <code>Pod</code> 能够容忍节点上设置的污点</p><p><strong>对一个节点设置污点</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">taint</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-master</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">key=value:NoSchedule</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">taint</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-master</span><span style="color:#24292E;"> </span><span style="color:#032F62;">key=value:NoSchedule</span></span></code></pre></div><p><strong>对 Pod 设置容忍，以下两种方式都可：</strong></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">## 容忍的 key、value 和对应 effect 也必须和污点 taints 保持一致</span></span>
<span class="line"><span style="color:#B392F0;">...</span><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#85E89D;">tolerations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;key&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;value&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">effect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;NoSchedule&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## 容忍 tolerations 的 key 和要污点 taints 的 key 一致，且设置的 effect 也相同，不需要设置 value</span></span>
<span class="line"><span style="color:#B392F0;">...</span><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#85E89D;">tolerations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;key&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Exists&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">effect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;NoSchedule&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">## 容忍的 key、value 和对应 effect 也必须和污点 taints 保持一致</span></span>
<span class="line"><span style="color:#6F42C1;">...</span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#22863A;">tolerations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;key&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">value</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;value&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">effect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;NoSchedule&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## 容忍 tolerations 的 key 和要污点 taints 的 key 一致，且设置的 effect 也相同，不需要设置 value</span></span>
<span class="line"><span style="color:#6F42C1;">...</span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#22863A;">tolerations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;key&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Exists&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">effect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;NoSchedule&quot;</span></span></code></pre></div><h4 id="设置容忍时间" tabindex="-1">设置容忍时间 <a class="header-anchor" href="#设置容忍时间" aria-label="Permalink to &quot;设置容忍时间&quot;">​</a></h4><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">tolerations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;key&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;value&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">effect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;PreferNoSchedule&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tolerationSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3600</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">tolerations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;key&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">value</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;value&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">effect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;PreferNoSchedule&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tolerationSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3600</span></span></code></pre></div><blockquote><p>如果这个 Pod 已经在这个带污点且 effect 为 NoExecute 的 node 上。这个 pod 可以一直运行到 3600s 后再被踢掉。如果这时候 Node 的污点被移除了，这个 Pod 就不会被踢掉。</p></blockquote><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>存在两种特殊情况：</p><p>如果一个容忍度的 <code>key</code> 为空且 operator 为 <code>Exists</code>， 表示这个容忍度与任意的 key 、value 和 effect 都匹配，即这个容忍度能容忍任意 taint。</p><p>如果 <code>effect</code> 为空，则可以与所有键名 <code>key1</code> 的效果相匹配</p></div><h4 id="案例-2" tabindex="-1">案例 <a class="header-anchor" href="#案例-2" aria-label="Permalink to &quot;案例&quot;">​</a></h4><p><code>Operator</code> 默认是 <code>Equal</code>，可设置为 <code>Equal</code> 与 <code>Exists</code> 两种，按这两种进行示例：</p><h5 id="operator-是-exists" tabindex="-1">Operator 是 Exists <a class="header-anchor" href="#operator-是-exists" aria-label="Permalink to &quot;Operator 是 Exists&quot;">​</a></h5><p><strong>容忍任何污点</strong></p><p>例如一个空的key，将匹配所有的key、value、effect。即容忍任何污点。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">tolerations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Exists&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">tolerations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Exists&quot;</span></span></code></pre></div><p><strong>容忍某 key 值的污点</strong></p><p>例如一个空的 effect，并且 key 不为空，那么将匹配所有与 key 相同的 effect：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">tolerations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;key&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Exists&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">tolerations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;key&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Exists&quot;</span></span></code></pre></div><h5 id="operator-是-equal" tabindex="-1">Operator 是 Equal <a class="header-anchor" href="#operator-是-equal" aria-label="Permalink to &quot;Operator 是 Equal&quot;">​</a></h5><p><strong>Node 上有一个污点</strong></p><p>Node 和 Pod 的 key 为 key1、value1 与 effect 相同则能调度：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#污点</span></span>
<span class="line"><span style="color:#9ECBFF;">key1=value1:NoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#Pod设置</span></span>
<span class="line"><span style="color:#85E89D;">tolerations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;key1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;value1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">effect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;NoSchedule&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#污点</span></span>
<span class="line"><span style="color:#032F62;">key1=value1:NoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#Pod设置</span></span>
<span class="line"><span style="color:#22863A;">tolerations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;key1&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">value</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;value1&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">effect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;NoSchedule&quot;</span></span></code></pre></div><p><strong>Node 上有多个污点</strong></p><p>Node 的污点的 key、value、effect 和 Pod 容忍都相同则能调度：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 设置污点</span></span>
<span class="line"><span style="color:#9ECBFF;">key1=value1:NoSchedule</span></span>
<span class="line"><span style="color:#9ECBFF;">key2=value2:NoExecute</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Pod设置容忍</span></span>
<span class="line"><span style="color:#85E89D;">tolerations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;key1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;value1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">effect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;NoSchedule&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;key2&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;value2&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">effect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;NoExecute&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 设置污点</span></span>
<span class="line"><span style="color:#032F62;">key1=value1:NoSchedule</span></span>
<span class="line"><span style="color:#032F62;">key2=value2:NoExecute</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Pod设置容忍</span></span>
<span class="line"><span style="color:#22863A;">tolerations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;key1&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">value</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;value1&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">effect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;NoSchedule&quot;</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;key2&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">value</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;value2&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">effect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;NoExecute&quot;</span></span></code></pre></div><p>Node 的污点和 Pod 的大部分都相同，不同的是 Node 污点 effect 为 PreferNoSchedule 的，可能会调度：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 污点</span></span>
<span class="line"><span style="color:#9ECBFF;">key1=value1:NoSchedule</span></span>
<span class="line"><span style="color:#9ECBFF;">key2=value2:NoExecute</span></span>
<span class="line"><span style="color:#9ECBFF;">key3=value3:PreferNoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Pod设置容忍</span></span>
<span class="line"><span style="color:#85E89D;">tolerations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;key1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;value1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">effect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;NoSchedule&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;key3&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;value3&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">effect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;PreferNoSchedule&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 污点</span></span>
<span class="line"><span style="color:#032F62;">key1=value1:NoSchedule</span></span>
<span class="line"><span style="color:#032F62;">key2=value2:NoExecute</span></span>
<span class="line"><span style="color:#032F62;">key3=value3:PreferNoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Pod设置容忍</span></span>
<span class="line"><span style="color:#22863A;">tolerations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;key1&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">value</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;value1&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">effect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;NoSchedule&quot;</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;key3&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">value</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;value3&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">effect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;PreferNoSchedule&quot;</span></span></code></pre></div><p>Node 的污点和 Pod 的大部分都相同，不同的是 Node 污点 effect 为 NoSchedule 和 NoExecute 的，不会被调度：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 污点</span></span>
<span class="line"><span style="color:#9ECBFF;">key1=value1:NoSchedule</span></span>
<span class="line"><span style="color:#9ECBFF;">key2=value2:NoExecute</span></span>
<span class="line"><span style="color:#9ECBFF;">key3=value3:PreferNoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Pod设置容忍</span></span>
<span class="line"><span style="color:#85E89D;">tolerations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;key1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;value1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">effect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;NoSchedule&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;key2&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;value2&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">effect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;NoExecute&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 污点</span></span>
<span class="line"><span style="color:#032F62;">key1=value1:NoSchedule</span></span>
<span class="line"><span style="color:#032F62;">key2=value2:NoExecute</span></span>
<span class="line"><span style="color:#032F62;">key3=value3:PreferNoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Pod设置容忍</span></span>
<span class="line"><span style="color:#22863A;">tolerations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;key1&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">value</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;value1&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">effect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;NoSchedule&quot;</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;key2&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Equal&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">value</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;value2&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">effect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;NoExecute&quot;</span></span></code></pre></div><ol><li>上一小节，已经在node1节点上打上了<code>NoExecute</code>的污点，此时pod是调度不上去的</li><li>本小节，可以通过给pod添加容忍，然后将其调度上去</li></ol><p>创建pod-toleration.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pod-toleration</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dev</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tolerations</span><span style="color:#E1E4E8;">:      </span><span style="color:#6A737D;"># 添加容忍</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;tag&quot;</span><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># 要容忍的污点的key</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Equal&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 操作符</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;heima&quot;</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 容忍的污点的value</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">effect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;NoExecute&quot;</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;"># 添加容忍的规则，这里必须和标记的污点规则相同</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pod-toleration</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.17.1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tolerations</span><span style="color:#24292E;">:      </span><span style="color:#6A737D;"># 添加容忍</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;tag&quot;</span><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 要容忍的污点的key</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Equal&quot;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 操作符</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">value</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;heima&quot;</span><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 容忍的污点的value</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">effect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;NoExecute&quot;</span><span style="color:#24292E;">   </span><span style="color:#6A737D;"># 添加容忍的规则，这里必须和标记的污点规则相同</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 添加容忍之前的pod</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@k8s-master01 ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#9ECBFF;">NAME             READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#9ECBFF;">pod-toleration   0/1     Pending   0          3s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;</span><span style="color:#E1E4E8;">           </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 添加容忍之后的pod</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@k8s-master01 ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#9ECBFF;">NAME             READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED</span></span>
<span class="line"><span style="color:#9ECBFF;">pod-toleration   1/1     Running   0          3s    10.244.1.62   node1   &lt;none&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 添加容忍之前的pod</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@k8s-master01 ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#032F62;">NAME             READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#032F62;">pod-toleration   0/1     Pending   0          3s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;</span><span style="color:#24292E;">           </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 添加容忍之后的pod</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@k8s-master01 ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl get pods -n dev -o wide</span></span>
<span class="line"><span style="color:#032F62;">NAME             READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED</span></span>
<span class="line"><span style="color:#032F62;">pod-toleration   1/1     Running   0          3s    10.244.1.62   node1   &lt;none&gt;</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">💡 说明</p><p>内置以下污点:</p><ul><li>node.kubernetes.io/not-ready： 节点尚未准备好。这对应于 NodeCondition Ready 为 false。</li><li>node.kubernetes.io/unreachable： 无法从节点控制器访问节点。这对应于 NodeCondition Ready 为 Unknown。</li><li>node.kubernetes.io/out-of-disk： 节点磁盘不足。</li><li>node.kubernetes.io/memory-pressure： 节点有内存压力。</li><li>node.kubernetes.io/disk-pressure： 节点有磁盘压力。</li><li>node.kubernetes.io/network-unavailable： 节点的网络不可用。</li><li>node.kubernetes.io/unschedulable： 节点不可调度。</li></ul></div><h3 id="污点和容忍度的作用" tabindex="-1">污点和容忍度的作用 <a class="header-anchor" href="#污点和容忍度的作用" aria-label="Permalink to &quot;污点和容忍度的作用&quot;">​</a></h3><p>Taint（污点）和 Toleration（容忍）可以作用于node和 pod 上，其目的是优化pod在集群间的调度，这跟节点亲和性类似，只不过它们作用的方式相反，具有taint的node和pod是互斥关系，而具有节点亲和性关系的node和pod是相吸的。另外还有可以给node节点设置label，通过给pod设置nodeSelector将pod调度到具有匹配标签的节点上。</p><p>Taint 和 toleration 相互配合，可以用来避免pod被分配到不合适的节点上。每个节点上都可以应用一个或多个taint，这表示对于那些不能容忍这些taint的 pod，是不会被该节点接受的。如果将toleration应用于pod上，则表示这些pod可以（但不要求）被调度到具有相应taint的节点上。</p><h3 id="污点与标签区别" tabindex="-1">污点与标签区别 <a class="header-anchor" href="#污点与标签区别" aria-label="Permalink to &quot;污点与标签区别&quot;">​</a></h3><p>由于标签和污点工作原理的不同，他们的适用场景也不一样。</p><p>标签通常用于为 Pod 指定分组，规定了 Pod 只能调度到这些分组里的 node 中，这是一种强制的做法。</p><p>污点通常用于将 Node 设置为专用节点，默认情况下普通 Pod 是无法调度过来，仅当你在 Pod 中指定了对应的容忍度才能调度。</p><h3 id="容忍与nodeselector区别" tabindex="-1">容忍与nodeSelector区别 <a class="header-anchor" href="#容忍与nodeselector区别" aria-label="Permalink to &quot;容忍与nodeSelector区别&quot;">​</a></h3><p>污点在k8s中相当于给node设置了一个锁，容忍相当于这个锁的钥匙，调度到这个节点的Pod需要使用容忍来解开这个锁，但是污点与容忍并不会固定的把某些Pod调度到这个节点。如果Pod第一次调度被调度到了没有污点的节点，他就会被分配到这个节点，容忍的配置就无效了，如果这个Pod正好被调度到有污点的node，他的容忍配置会被解析，验证这个Pod是否可以容忍node的污点。</p><p>nodeSelector固定调度某些Pod到指定的一些节点，他的作用是强制性的，如果集群中没有符合的node，Pod会一直处于等待调度的阶段。</p><h2 id="_3-3-node添加污点" tabindex="-1">3.3 Node添加污点 <a class="header-anchor" href="#_3-3-node添加污点" aria-label="Permalink to &quot;3.3 Node添加污点&quot;">​</a></h2><h3 id="容忍配置" tabindex="-1">容忍配置 <a class="header-anchor" href="#容忍配置" aria-label="Permalink to &quot;容忍配置&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@k8s-master01 ~</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">kubectl explain pod.spec.tolerations</span></span>
<span class="line"><span style="color:#B392F0;">...</span><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#85E89D;">FIELDS</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">key</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;"># 对应着要容忍的污点的键，空意味着匹配所有的键</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">value</span><span style="color:#E1E4E8;">     </span><span style="color:#6A737D;"># 对应着要容忍的污点的值</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">operator</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># key-value的运算符，支持Equal和Exists（默认）</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">effect</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 对应污点的effect，空意味着匹配所有影响</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">tolerationSeconds</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;"># 容忍时间, 当effect为NoExecute时生效，表示pod在Node上的停留时间</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@k8s-master01 ~</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">kubectl explain pod.spec.tolerations</span></span>
<span class="line"><span style="color:#6F42C1;">...</span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#22863A;">FIELDS</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#032F62;">key</span><span style="color:#24292E;">       </span><span style="color:#6A737D;"># 对应着要容忍的污点的键，空意味着匹配所有的键</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#032F62;">value</span><span style="color:#24292E;">     </span><span style="color:#6A737D;"># 对应着要容忍的污点的值</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#032F62;">operator</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># key-value的运算符，支持Equal和Exists（默认）</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#032F62;">effect</span><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 对应污点的effect，空意味着匹配所有影响</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#032F62;">tolerationSeconds</span><span style="color:#24292E;">   </span><span style="color:#6A737D;"># 容忍时间, 当effect为NoExecute时生效，表示pod在Node上的停留时间</span></span></code></pre></div><p>在实际生产环境中，污点通常用于描述具体的部署规划，它们的键名如:<code>node-type、node-role、node-project</code>等。kubectltaint命令可以管理Node对象的污点信息，语法格式如下：</p><h3 id="语法" tabindex="-1">语法 <a class="header-anchor" href="#语法" aria-label="Permalink to &quot;语法&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">语法：kubectl taint nodes &lt;node-name&gt; &lt;key=value&gt;:&lt;effect&gt;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># 示例：kubectl taint nodes node01 node-type=prod:NoExecute</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">语法：kubectl taint nodes &lt;node-name&gt; &lt;key=value&gt;:&lt;effect&gt;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># 示例：kubectl taint nodes node01 node-type=prod:NoExecute</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#添加</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl taint nodes kube-node03 node-type=prod:NoSchedule</span></span>
<span class="line"><span style="color:#B392F0;">node/kube-node03</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tainted</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#添加</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl taint nodes kube-node03 node-type=prod:NoSchedule</span></span>
<span class="line"><span style="color:#6F42C1;">node/kube-node03</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tainted</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl describe nodes  kube-node03 </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Taints</span></span>
<span class="line"><span style="color:#B392F0;">Taints:</span><span style="color:#E1E4E8;">             </span><span style="color:#9ECBFF;">node-type=prod:NoSchedule</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl describe nodes  kube-node03 </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Taints</span></span>
<span class="line"><span style="color:#6F42C1;">Taints:</span><span style="color:#24292E;">             </span><span style="color:#032F62;">node-type=prod:NoSchedule</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#删除,只需在effect后面加上-号即可</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl taint nodes kube-node03 node-type=prod:NoSchedule-</span></span>
<span class="line"><span style="color:#B392F0;">node/kube-node03</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">untainted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl describe nodes  kube-node03 </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Taints</span></span>
<span class="line"><span style="color:#B392F0;">Taints:</span><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#删除,只需在effect后面加上-号即可</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl taint nodes kube-node03 node-type=prod:NoSchedule-</span></span>
<span class="line"><span style="color:#6F42C1;">node/kube-node03</span><span style="color:#24292E;"> </span><span style="color:#032F62;">untainted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl describe nodes  kube-node03 </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Taints</span></span>
<span class="line"><span style="color:#6F42C1;">Taints:</span><span style="color:#24292E;">             </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">## 设置污点并不允许 Pod 调度到该节点</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">taint</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-node03</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">key1=value1:NoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## 设置污点尽量阻止污点调度到该节点</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">taint</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-node03</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">key2=value2:PreferNoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## 设置污点，不允许普通 Pod 调度到该节点，且将该节点上已经存在的 Pod 进行驱逐</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">taint</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-node03</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">key3=value3:NoExecute</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">## 设置污点并不允许 Pod 调度到该节点</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">taint</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-node03</span><span style="color:#24292E;"> </span><span style="color:#032F62;">key1=value1:NoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## 设置污点尽量阻止污点调度到该节点</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">taint</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-node03</span><span style="color:#24292E;"> </span><span style="color:#032F62;">key2=value2:PreferNoSchedule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">## 设置污点，不允许普通 Pod 调度到该节点，且将该节点上已经存在的 Pod 进行驱逐</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">taint</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-node03</span><span style="color:#24292E;"> </span><span style="color:#032F62;">key3=value3:NoExecute</span></span></code></pre></div><h2 id="_3-4-pod添加容忍度" tabindex="-1">3.4 Pod添加容忍度 <a class="header-anchor" href="#_3-4-pod添加容忍度" aria-label="Permalink to &quot;3.4 Pod添加容忍度&quot;">​</a></h2><p>Pod 的容忍度在 PodSpec 中定义，根据使用的操作符不同，主要有两种可用形式：</p><ul><li>一种是与污点信息完全匹配的等值关系。将operator指定为<code>Equal</code>，则它们的勺<code>key、value、effect </code>应该相等;</li><li>一种是判断污点信息存在性的匹配方式。将operator指定为 <code>Exists</code>（此时容忍度无需指定value）;</li></ul><h1 id="_4-实践" tabindex="-1">4. 实践 <a class="header-anchor" href="#_4-实践" aria-label="Permalink to &quot;4. 实践&quot;">​</a></h1><h2 id="_4-1-pod亲和性" tabindex="-1">4.1 Pod亲和性 <a class="header-anchor" href="#_4-1-pod亲和性" aria-label="Permalink to &quot;4.1 Pod亲和性&quot;">​</a></h2><p>1.添加标签</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">label</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">your-node-nam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">key=value</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--show-labels</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#删除</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">label</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">your-node-nam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">key-</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">label</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">your-node-nam</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">key=value</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--show-labels</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#删除</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">label</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">your-node-nam</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">key-</span></span></code></pre></div><p>2.创建deployment</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">redis-cache</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">store</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">store</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">affinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">podAntiAffinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">labelSelector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#9ECBFF;">store</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">topologyKey</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;kubernetes.io/hostname&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">redis-server</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">redis:3.2-alpine</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">redis-cache</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">store</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">store</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">affinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">podAntiAffinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">labelSelector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#032F62;">store</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">topologyKey</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;kubernetes.io/hostname&quot;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">redis-server</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">redis:3.2-alpine</span></span></code></pre></div><h2 id="_4-2-node亲和性" tabindex="-1">4.2 node亲和性 <a class="header-anchor" href="#_4-2-node亲和性" aria-label="Permalink to &quot;4.2 node亲和性&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">redis-cache</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">store</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">store</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">affinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">nodeAffinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">nodeSelectorTerms</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">instance-type</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#9ECBFF;">memory</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">preferredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">weight</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">preference</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">disktype</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                - </span><span style="color:#9ECBFF;">ssd</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">redis-server</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">redis:3.2-alpine</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">redis-cache</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">store</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">store</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">affinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">nodeAffinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">nodeSelectorTerms</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">instance-type</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#032F62;">memory</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">preferredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">weight</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">preference</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">disktype</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                - </span><span style="color:#032F62;">ssd</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">redis-server</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">redis:3.2-alpine</span></span></code></pre></div>`,260),e=[o];function t(c,r,E,y,i,d){return n(),a("div",null,e)}const h=s(p,[["render",t]]);export{u as __pageData,h as default};
