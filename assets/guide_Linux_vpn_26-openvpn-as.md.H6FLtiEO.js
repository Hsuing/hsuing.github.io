import{_ as s,o as a,c as n,R as p}from"./chunks/framework.zUbWieqp.js";const h=JSON.parse('{"title":"1. openvpn-as","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Linux/vpn/26-openvpn-as.md","filePath":"guide/Linux/vpn/26-openvpn-as.md","lastUpdated":1744430950000}'),l={name:"guide/Linux/vpn/26-openvpn-as.md"},o=p(`<h1 id="_1-openvpn-as" tabindex="-1">1. openvpn-as <a class="header-anchor" href="#_1-openvpn-as" aria-label="Permalink to &quot;1. openvpn-as&quot;">​</a></h1><h2 id="_1-1-介绍" tabindex="-1">1.1 介绍 <a class="header-anchor" href="#_1-1-介绍" aria-label="Permalink to &quot;1.1 介绍&quot;">​</a></h2><p>OpenVPN 官网：<a href="https://openvpn.net/" target="_blank" rel="noreferrer">https://openvpn.net/</a></p><p>OpenVPN 提供了两种商业版的 VPN 服务：</p><ol><li><code>OpenVPN Cloud</code> ：一种 VPN 托管服务，连接 <code>OpenVPN</code> 提供的 VPN 服务，可免费提供 3 个连接；</li><li><code>OpenVPN Access Server</code>：一个商业版的 VPN 程序，简称（openvpn-as），相比于 <code>openvpn</code> 增加了 web 管理界面，可通过可视化对 VPN 服务和用户进行管理，可免费提供 2 个连接。</li></ol><p>商业版在 <code>OpenVPN</code> 官网有很多介绍，但是免费版的部署和讲解就比较少。本文主要描述的还是免费版的部署方法，不对 <code>openvpn-as</code> 的部署进行赘述，官网有很详细的部署文档，见如下链接：</p><ol><li>安装包下载：<a href="https://openvpn.net/download-open-vpn/" target="_blank" rel="noreferrer">https://openvpn.net/download-open-vpn/</a></li><li>入门手册：<a href="https://openvpn.net/vpn-server-resources/finishing-configuration-of-access-server/" target="_blank" rel="noreferrer">https://openvpn.net/vpn-server-resources/finishing-configuration-of-access-server/</a></li></ol><h1 id="_2-部署" tabindex="-1">2. 部署 <a class="header-anchor" href="#_2-部署" aria-label="Permalink to &quot;2. 部署&quot;">​</a></h1><h2 id="_2-1-下载" tabindex="-1">2.1 下载 <a class="header-anchor" href="#_2-1-下载" aria-label="Permalink to &quot;2.1 下载&quot;">​</a></h2><p>基于<code>rocklinux8</code>环境部署,openvpn-as-2.14, openvpn-as-bundled-clients-30-1</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://openvpn.net/downloads/openvpn-as-bundled-clients-latest.rpm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://openvpn.net/downloads/openvpn-as-latest-CentOS8.x86_64.rpm</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://openvpn.net/downloads/openvpn-as-bundled-clients-latest.rpm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://openvpn.net/downloads/openvpn-as-latest-CentOS8.x86_64.rpm</span></span></code></pre></div><h2 id="_2-2-安装" tabindex="-1">2.2 安装 <a class="header-anchor" href="#_2-2-安装" aria-label="Permalink to &quot;2.2 安装&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openvpn-as-bundled-clients-30-1.rpm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openvpn-as-2.14.0_b90cb316-1.el8.x86_64.rpm</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">To</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">reconfigure</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">manually,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/local/openvpn_as/bin/ovpn-init</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tool.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">+++++++++++++++++++++++++++++++++++++++++++++++</span></span>
<span class="line"><span style="color:#B392F0;">Access</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Server</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2.14</span><span style="color:#9ECBFF;">.0</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">has</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">been</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">successfully</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">installed</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/local/openvpn_as</span></span>
<span class="line"><span style="color:#B392F0;">Configuration</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">file</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">has</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">been</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">written</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/local/openvpn_as/init.log</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Access</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Web</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UIs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">are</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">available</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">here:</span></span>
<span class="line"><span style="color:#B392F0;">Admin</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">UI:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://10.103.236.199:943/admin</span></span>
<span class="line"><span style="color:#B392F0;">Client</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UI:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://10.103.236.199:943/</span></span>
<span class="line"><span style="color:#B392F0;">To</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">login</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">please</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;openvpn&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">account</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;KHWRj3aP9T0E&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">password.</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">password</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">can</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">changed</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Admin</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UI</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#B392F0;">+++++++++++++++++++++++++++++++++++++++++++++++</span></span>
<span class="line"><span style="color:#79B8FF;">......</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openvpn-as-bundled-clients-30-1.rpm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openvpn-as-2.14.0_b90cb316-1.el8.x86_64.rpm</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">To</span><span style="color:#24292E;"> </span><span style="color:#032F62;">reconfigure</span><span style="color:#24292E;"> </span><span style="color:#032F62;">manually,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">use</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/local/openvpn_as/bin/ovpn-init</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tool.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">+++++++++++++++++++++++++++++++++++++++++++++++</span></span>
<span class="line"><span style="color:#6F42C1;">Access</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Server</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2.14</span><span style="color:#032F62;">.0</span><span style="color:#24292E;"> </span><span style="color:#032F62;">has</span><span style="color:#24292E;"> </span><span style="color:#032F62;">been</span><span style="color:#24292E;"> </span><span style="color:#032F62;">successfully</span><span style="color:#24292E;"> </span><span style="color:#032F62;">installed</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/local/openvpn_as</span></span>
<span class="line"><span style="color:#6F42C1;">Configuration</span><span style="color:#24292E;"> </span><span style="color:#032F62;">log</span><span style="color:#24292E;"> </span><span style="color:#032F62;">file</span><span style="color:#24292E;"> </span><span style="color:#032F62;">has</span><span style="color:#24292E;"> </span><span style="color:#032F62;">been</span><span style="color:#24292E;"> </span><span style="color:#032F62;">written</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/local/openvpn_as/init.log</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Access</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Web</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UIs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">are</span><span style="color:#24292E;"> </span><span style="color:#032F62;">available</span><span style="color:#24292E;"> </span><span style="color:#032F62;">here:</span></span>
<span class="line"><span style="color:#6F42C1;">Admin</span><span style="color:#24292E;">  </span><span style="color:#032F62;">UI:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://10.103.236.199:943/admin</span></span>
<span class="line"><span style="color:#6F42C1;">Client</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UI:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://10.103.236.199:943/</span></span>
<span class="line"><span style="color:#6F42C1;">To</span><span style="color:#24292E;"> </span><span style="color:#032F62;">login</span><span style="color:#24292E;"> </span><span style="color:#032F62;">please</span><span style="color:#24292E;"> </span><span style="color:#032F62;">use</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;openvpn&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">account</span><span style="color:#24292E;"> </span><span style="color:#032F62;">with</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;KHWRj3aP9T0E&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">password.</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#6F42C1;">password</span><span style="color:#24292E;"> </span><span style="color:#032F62;">can</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">changed</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Admin</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UI</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6F42C1;">+++++++++++++++++++++++++++++++++++++++++++++++</span></span>
<span class="line"><span style="color:#005CC5;">......</span></span></code></pre></div><h2 id="_2-3-配置" tabindex="-1">2.3 配置 <a class="header-anchor" href="#_2-3-配置" aria-label="Permalink to &quot;2.3 配置&quot;">​</a></h2><p><a href="https://build.openvpn.net/man/openvpn-2.5/openvpn.8.html" target="_blank" rel="noreferrer">https://build.openvpn.net/man/openvpn-2.5/openvpn.8.html</a></p><h2 id="_2-4-登录" tabindex="-1">2.4 登录 <a class="header-anchor" href="#_2-4-登录" aria-label="Permalink to &quot;2.4 登录&quot;">​</a></h2><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408270954768.png" alt="image-20240826171406833"></p><h2 id="_2-4-破解" tabindex="-1">2.4 破解 <a class="header-anchor" href="#_2-4-破解" aria-label="Permalink to &quot;2.4 破解&quot;">​</a></h2><p>破解前的连接数</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408270954966.png" alt="image-20240826171503682"></p><blockquote><p>开始破解</p></blockquote><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>openvpn-as-bundled-clients 千万注意这个版本,否则版本不对应破解会失败</p><table><thead><tr><th>名字</th><th>版本</th></tr></thead><tbody><tr><td>openvpn-as-2.14.x</td><td>openvpn-as-bundled-clients-30-1</td></tr><tr><td>openvpn-as-2.13.x</td><td>openvpn-as-bundled-clients-30</td></tr><tr><td>openvpn-as-2.10.x</td><td>openvpn-as-bundled-clients-25</td></tr></tbody></table></div><p><strong><code>2.9.0</code> 以下版本破解的目标文件是 <code>/pyovpn/lic/uprop.pyo</code>, <code>2.9.0</code> 及以上是 <code>/pyovpn/lic/uprop.pyc</code>;</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#备份</span></span>
<span class="line"><span style="color:#B392F0;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/local/openvpn_as/lib/python/pyovpn-2.0-py3.11.egg{,.back}</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#复制解压</span></span>
<span class="line"><span style="color:#B392F0;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/local/openvpn_as/lib/python/pyovpn-2.0-py3.11.egg</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/root/openvpn-as</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#解压</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Rocky openvpn-as]# unzip -q pyovpn-2.0-py3.11.egg</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Rocky openvpn-as]# ls</span></span>
<span class="line"><span style="color:#B392F0;">common</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">EGG-INFO</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">pyovpn</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">pyovpn-2.0-py3.11.egg</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@Rocky openvpn-as]# cd pyovpn/lic</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Rocky lic]# pwd</span></span>
<span class="line"><span style="color:#B392F0;">/root/openvpn-as/pyovpn/lic</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#删除文件名字uprop.pyc</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Rocky lic]# rm uprop.pyc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#备份</span></span>
<span class="line"><span style="color:#6F42C1;">cp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/local/openvpn_as/lib/python/pyovpn-2.0-py3.11.egg{,.back}</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#复制解压</span></span>
<span class="line"><span style="color:#6F42C1;">cp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/local/openvpn_as/lib/python/pyovpn-2.0-py3.11.egg</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/root/openvpn-as</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#解压</span></span>
<span class="line"><span style="color:#24292E;">[root@Rocky openvpn-as]# unzip -q pyovpn-2.0-py3.11.egg</span></span>
<span class="line"><span style="color:#24292E;">[root@Rocky openvpn-as]# ls</span></span>
<span class="line"><span style="color:#6F42C1;">common</span><span style="color:#24292E;">  </span><span style="color:#032F62;">EGG-INFO</span><span style="color:#24292E;">  </span><span style="color:#032F62;">pyovpn</span><span style="color:#24292E;">  </span><span style="color:#032F62;">pyovpn-2.0-py3.11.egg</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@Rocky openvpn-as]# cd pyovpn/lic</span></span>
<span class="line"><span style="color:#24292E;">[root@Rocky lic]# pwd</span></span>
<span class="line"><span style="color:#6F42C1;">/root/openvpn-as/pyovpn/lic</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#删除文件名字uprop.pyc</span></span>
<span class="line"><span style="color:#24292E;">[root@Rocky lic]# rm uprop.pyc</span></span></code></pre></div><ul><li>创建uprop.py</li></ul><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pyovpn.lic </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> uprop2</span></span>
<span class="line"><span style="color:#E1E4E8;">old_figure </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">new_figure</span><span style="color:#E1E4E8;">(self, licdict):</span></span>
<span class="line"><span style="color:#E1E4E8;">    ret </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> old_figure(</span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">, licdict)</span></span>
<span class="line"><span style="color:#E1E4E8;">    ret[</span><span style="color:#9ECBFF;">&#39;concurrent_connections&#39;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1024</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> ret</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> x </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">dir</span><span style="color:#E1E4E8;">(uprop2):</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> x[:</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;__&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">continue</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> x </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;UsageProperties&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">exec</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;old_figure = uprop2.UsageProperties.figure&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">exec</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;uprop2.UsageProperties.figure = new_figure&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">exec</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">%s</span><span style="color:#9ECBFF;"> = uprop2.</span><span style="color:#79B8FF;">%s</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">%</span><span style="color:#E1E4E8;"> (x, x))</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pyovpn.lic </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> uprop2</span></span>
<span class="line"><span style="color:#24292E;">old_figure </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">new_figure</span><span style="color:#24292E;">(self, licdict):</span></span>
<span class="line"><span style="color:#24292E;">    ret </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> old_figure(</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">, licdict)</span></span>
<span class="line"><span style="color:#24292E;">    ret[</span><span style="color:#032F62;">&#39;concurrent_connections&#39;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1024</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> ret</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> x </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">dir</span><span style="color:#24292E;">(uprop2):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> x[:</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;__&#39;</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">continue</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> x </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;UsageProperties&#39;</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">exec</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;old_figure = uprop2.UsageProperties.figure&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">exec</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;uprop2.UsageProperties.figure = new_figure&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">exec</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;</span><span style="color:#005CC5;">%s</span><span style="color:#032F62;"> = uprop2.</span><span style="color:#005CC5;">%s</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">%</span><span style="color:#24292E;"> (x, x))</span></span></code></pre></div><ul><li>重新编译uprop.py</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># &lt;2.9.0</span></span>
<span class="line"><span style="color:#B392F0;">python2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-O</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-m</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">compileall</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">uprop.py</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># &gt;=2.9.0</span></span>
<span class="line"><span style="color:#B392F0;">python3</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-O</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-m</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">compileall</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">uprop.py</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">mv</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">__pycache__/uprop.</span><span style="color:#79B8FF;">*</span><span style="color:#9ECBFF;">.pyc</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">uprop.pyc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># &lt;2.9.0</span></span>
<span class="line"><span style="color:#6F42C1;">python2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-O</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-m</span><span style="color:#24292E;"> </span><span style="color:#032F62;">compileall</span><span style="color:#24292E;"> </span><span style="color:#032F62;">uprop.py</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># &gt;=2.9.0</span></span>
<span class="line"><span style="color:#6F42C1;">python3</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-O</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-m</span><span style="color:#24292E;"> </span><span style="color:#032F62;">compileall</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">uprop.py</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">__pycache__/uprop.</span><span style="color:#005CC5;">*</span><span style="color:#032F62;">.pyc</span><span style="color:#24292E;"> </span><span style="color:#032F62;">uprop.pyc</span></span></code></pre></div><ul><li>重新生成pyovpn-2.0-py3.11.egg</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Rocky openvpn-as]# zip -rq pyovpn-2.0-py3.11.egg ./pyovpn ./EGG-INFO ./common</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Rocky openvpn-as]# zip -rq pyovpn-2.0-py3.11.egg ./pyovpn ./EGG-INFO ./common</span></span></code></pre></div><ul><li>覆盖原来pyovpn-2.0-py3.11.egg文件</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#关闭openvpnas服务</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stop</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openvpnas</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#覆盖文件</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pyovpn-2.0-py3.11.egg</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/local/openvpn_as/lib/python/pyovpn-2.0-py3.11.egg</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#关闭openvpnas服务</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openvpnas</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#覆盖文件</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pyovpn-2.0-py3.11.egg</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/local/openvpn_as/lib/python/pyovpn-2.0-py3.11.egg</span></span></code></pre></div><ul><li>破解之后</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408271413349.png" alt="image-20240827141329398"></p><p>参考文档:</p><p><a href="https://openvpn.net/as-docs/release-notes.html#access-server-release-notes" target="_blank" rel="noreferrer">https://openvpn.net/as-docs/release-notes.html#access-server-release-notes</a></p><h1 id="_3-配置" tabindex="-1">3. 配置 <a class="header-anchor" href="#_3-配置" aria-label="Permalink to &quot;3. 配置&quot;">​</a></h1><p>配置基本上都是存在数据库中,默认使用sqlite</p><p>参考文档,</p><p><a href="https://openvpn.net/as-docs/plugins.html#plugins" target="_blank" rel="noreferrer">https://openvpn.net/as-docs/plugins.html#plugins</a></p><p><a href="https://openvpn.net/as-docs/configuration.html#create-a-new-ca" target="_blank" rel="noreferrer">https://openvpn.net/as-docs/configuration.html#create-a-new-ca</a></p><h2 id="_3-1-全局配置" tabindex="-1">3.1 全局配置 <a class="header-anchor" href="#_3-1-全局配置" aria-label="Permalink to &quot;3.1 全局配置&quot;">​</a></h2><p>允许vpn客户端可以相互访问</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408271821303.png" alt="image-20240827182144495"></p><h2 id="_3-1-流量分流" tabindex="-1">3.1 流量分流 <a class="header-anchor" href="#_3-1-流量分流" aria-label="Permalink to &quot;3.1 流量分流&quot;">​</a></h2><h3 id="_1-部署dns" tabindex="-1">1.部署dns <a class="header-anchor" href="#_1-部署dns" aria-label="Permalink to &quot;1.部署dns&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#安装</span></span>
<span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dnsmasq</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#创建日志目录</span></span>
<span class="line"><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/log/dnsmasq</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#安装</span></span>
<span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dnsmasq</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#创建日志目录</span></span>
<span class="line"><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/log/dnsmasq</span></span></code></pre></div><h3 id="_2-修改配置文件" tabindex="-1">2.修改配置文件 <a class="header-anchor" href="#_2-修改配置文件" aria-label="Permalink to &quot;2.修改配置文件&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">no-poll</span></span>
<span class="line"><span style="color:#B392F0;">clear-on-reload</span></span>
<span class="line"><span style="color:#B392F0;">no-negcache</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">resolv-file</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/resolv.dnsmasq.conf</span></span>
<span class="line"><span style="color:#B392F0;">strict-order</span></span>
<span class="line"><span style="color:#E1E4E8;">server</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">100.100</span><span style="color:#9ECBFF;">.2.136</span></span>
<span class="line"><span style="color:#E1E4E8;">listen-address</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10.8</span><span style="color:#9ECBFF;">.0.1,172.18.0.24,127.0.0.1</span></span>
<span class="line"><span style="color:#E1E4E8;">addn-hosts</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/dnsmasq.hosts</span></span>
<span class="line"><span style="color:#E1E4E8;">cache-size</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1024</span></span>
<span class="line"><span style="color:#E1E4E8;">bogus-nxdomain</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">100.100</span><span style="color:#9ECBFF;">.2.136</span></span>
<span class="line"><span style="color:#B392F0;">log-queries</span></span>
<span class="line"><span style="color:#E1E4E8;">log-facility</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/var/log/dnsmasq/dnsmasq.log</span></span>
<span class="line"><span style="color:#E1E4E8;">conf-dir</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/dnsmasq.d</span></span>
<span class="line"><span style="color:#E1E4E8;">conf-dir</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/dnsmasq.d,.bak</span></span>
<span class="line"><span style="color:#E1E4E8;">conf-dir</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/dnsmasq.d/,</span><span style="color:#79B8FF;">*</span><span style="color:#9ECBFF;">.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">conf-dir</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/dnsmasq.d,.rpmnew,.rpmsave,.rpmorig</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">no-poll</span></span>
<span class="line"><span style="color:#6F42C1;">clear-on-reload</span></span>
<span class="line"><span style="color:#6F42C1;">no-negcache</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">resolv-file</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/resolv.dnsmasq.conf</span></span>
<span class="line"><span style="color:#6F42C1;">strict-order</span></span>
<span class="line"><span style="color:#24292E;">server</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">100.100</span><span style="color:#032F62;">.2.136</span></span>
<span class="line"><span style="color:#24292E;">listen-address</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10.8</span><span style="color:#032F62;">.0.1,172.18.0.24,127.0.0.1</span></span>
<span class="line"><span style="color:#24292E;">addn-hosts</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/dnsmasq.hosts</span></span>
<span class="line"><span style="color:#24292E;">cache-size</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1024</span></span>
<span class="line"><span style="color:#24292E;">bogus-nxdomain</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">100.100</span><span style="color:#032F62;">.2.136</span></span>
<span class="line"><span style="color:#6F42C1;">log-queries</span></span>
<span class="line"><span style="color:#24292E;">log-facility</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/var/log/dnsmasq/dnsmasq.log</span></span>
<span class="line"><span style="color:#24292E;">conf-dir</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/dnsmasq.d</span></span>
<span class="line"><span style="color:#24292E;">conf-dir</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/dnsmasq.d,.bak</span></span>
<span class="line"><span style="color:#24292E;">conf-dir</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/dnsmasq.d/,</span><span style="color:#005CC5;">*</span><span style="color:#032F62;">.conf</span></span>
<span class="line"><span style="color:#24292E;">conf-dir</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/dnsmasq.d,.rpmnew,.rpmsave,.rpmorig</span></span></code></pre></div><p>100.100.2.136 ---&gt; 公共dns地址</p><p>10.8.0.1 ---&gt; vpn地址</p><p>172.18.0.24 ---&gt; eth0地址</p><h3 id="_3-配置域名" tabindex="-1">3.配置域名 <a class="header-anchor" href="#_3-配置域名" aria-label="Permalink to &quot;3.配置域名&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@iZ0xic7at6gaa3chq9xhy7Z </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# cat /etc/dnsmasq.hosts</span></span>
<span class="line"><span style="color:#B392F0;">172.18.0.24</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bot.freehan.ink</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@iZ0xic7at6gaa3chq9xhy7Z </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# cat /etc/dnsmasq.hosts</span></span>
<span class="line"><span style="color:#6F42C1;">172.18.0.24</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bot.freehan.ink</span></span></code></pre></div><h3 id="_4-重启服务" tabindex="-1">4.重启服务 <a class="header-anchor" href="#_4-重启服务" aria-label="Permalink to &quot;4.重启服务&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#dns</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dnsmasq.service</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#vpn</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openvpnas.service</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#dns</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dnsmasq.service</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#vpn</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openvpnas.service</span></span></code></pre></div><h3 id="_5-vpn服务端配置" tabindex="-1">5.vpn服务端配置 <a class="header-anchor" href="#_5-vpn服务端配置" aria-label="Permalink to &quot;5.vpn服务端配置&quot;">​</a></h3><p><strong>禁用“推送所有流量”选项：</strong> 在 OpenVPN Access Server 中禁用“推送所有流量”功能：</p><ul><li>登录到管理界面 (<a href="https://server-ip:943/admin" target="_blank" rel="noreferrer">https://server-ip:943/admin</a>)</li><li>进入 <strong>Configuration</strong> &gt; <strong>VPN Settings</strong>。</li><li>找到 <strong>Should VPN clients have access to private subnets?</strong> 这一项。</li><li>选择 <strong>No</strong> 或者在高级选项中勾选 &quot;Allow Access To Only The Following Networks&quot; 并手动添加你希望通过 VPN 路由的子网，其他流量将不通过 VPN。</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408271815276.png" alt="image-20240827181546722"></p><h4 id="_5-1-配置dns" tabindex="-1">5.1 配置dns <a class="header-anchor" href="#_5-1-配置dns" aria-label="Permalink to &quot;5.1 配置dns&quot;">​</a></h4><p>进入 <strong>Configuration</strong> &gt; <strong>VPN Settings</strong>,保存重启服务</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408282142051.png" alt="image-20240828214220255"></p><h3 id="_6-验证" tabindex="-1">6.验证 <a class="header-anchor" href="#_6-验证" aria-label="Permalink to &quot;6.验证&quot;">​</a></h3><p>创建用户省略...</p><p>启动vpn客户端</p><ul><li>验证域名解析</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408282144235.png" alt="image-20240828214455442"></p><ul><li>浏览器访问</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408282148078.png" alt="image-20240828214819992"></p><h2 id="_3-2-全局流量" tabindex="-1">3.2 全局流量 <a class="header-anchor" href="#_3-2-全局流量" aria-label="Permalink to &quot;3.2 全局流量&quot;">​</a></h2><p>Should client Internet traffic be routed through the VPN? 这个来控制全局流量走vpn</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408272230327.png" alt="image-20240827223019937"></p><p>全部设置成<code>Yes</code></p><h2 id="_3-3-备份" tabindex="-1">3.3 备份 <a class="header-anchor" href="#_3-3-备份" aria-label="Permalink to &quot;3.3 备份&quot;">​</a></h2><p><a href="https://openvpn.net/as-docs/tutorials/tutorial--configuration-backup.html" target="_blank" rel="noreferrer">https://openvpn.net/as-docs/tutorials/tutorial--configuration-backup.html</a></p><h3 id="_3-3-1-单节点配置文件" tabindex="-1">3.3.1 单节点配置文件 <a class="header-anchor" href="#_3-3-1-单节点配置文件" aria-label="Permalink to &quot;3.3.1 单节点配置文件&quot;">​</a></h3><ul><li><strong>Global server configuration</strong>: /usr/local/openvpn_as/etc/db/config.db</li><li><strong>Server and client certificates</strong>: /usr/local/openvpn_as/etc/db/certs.db</li><li><strong>User and group properties</strong>: /usr/local/openvpn_as/etc/db/userprop.db</li><li><strong>Log database</strong>: /usr/local/openvpn_as/etc/db/log.db</li><li><strong>Debug and low level settings</strong>: /usr/local/openvpn_as/etc/as.conf</li></ul><h3 id="_3-3-2-集群配置文件" tabindex="-1">3.3.2 集群配置文件 <a class="header-anchor" href="#_3-3-2-集群配置文件" aria-label="Permalink to &quot;3.3.2 集群配置文件&quot;">​</a></h3><ul><li><strong>Local server node configuration</strong>: /usr/local/openvpn_as/etc/db/config_local.db</li><li><strong>Cluster configuration</strong>: /usr/local/openvpn_as/etc/db/cluster.db</li><li><strong>Cluster notification system</strong>: /usr/local/openvpn_as/etc/db/notification.db</li></ul><h3 id="_3-3-3-安装备份工具" tabindex="-1">3.3.3 安装备份工具 <a class="header-anchor" href="#_3-3-3-安装备份工具" aria-label="Permalink to &quot;3.3.3 安装备份工具&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#ubuntu</span></span>
<span class="line"><span style="color:#79B8FF;">which</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apt</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;&amp;1</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">apt</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sqlite3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#centos</span></span>
<span class="line"><span style="color:#79B8FF;">which</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/dev/null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">2&gt;&amp;1</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sqlite</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#ubuntu</span></span>
<span class="line"><span style="color:#005CC5;">which</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apt</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;&amp;1</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">apt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sqlite3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#centos</span></span>
<span class="line"><span style="color:#005CC5;">which</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yum</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/dev/null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">2&gt;&amp;1</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sqlite</span></span></code></pre></div><ul><li>备份配置文件</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/local/openvpn_as/etc/db</span></span>
<span class="line"><span style="color:#E1E4E8;">[ </span><span style="color:#F97583;">-e</span><span style="color:#E1E4E8;"> config.db ]&amp;&amp;</span><span style="color:#B392F0;">sqlite3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">config.db</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.dum</span><span style="color:#E1E4E8;">p</span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">../../config.db.bak</span></span>
<span class="line"><span style="color:#E1E4E8;">[ </span><span style="color:#F97583;">-e</span><span style="color:#E1E4E8;"> certs.db ]&amp;&amp;</span><span style="color:#B392F0;">sqlite3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">certs.db</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.dum</span><span style="color:#E1E4E8;">p</span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">../../certs.db.bak</span></span>
<span class="line"><span style="color:#E1E4E8;">[ </span><span style="color:#F97583;">-e</span><span style="color:#E1E4E8;"> userprop.db ]&amp;&amp;</span><span style="color:#B392F0;">sqlite3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">userprop.db</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.dum</span><span style="color:#E1E4E8;">p</span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">../../userprop.db.bak</span></span>
<span class="line"><span style="color:#E1E4E8;">[ </span><span style="color:#F97583;">-e</span><span style="color:#E1E4E8;"> log.db ]&amp;&amp;</span><span style="color:#B392F0;">sqlite3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">log.db</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.dum</span><span style="color:#E1E4E8;">p</span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">../../log.db.bak</span></span>
<span class="line"><span style="color:#E1E4E8;">[ </span><span style="color:#F97583;">-e</span><span style="color:#E1E4E8;"> config_local.db ]&amp;&amp;</span><span style="color:#B392F0;">sqlite3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">config_local.db</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.dum</span><span style="color:#E1E4E8;">p</span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">../../config_local.db.bak</span></span>
<span class="line"><span style="color:#E1E4E8;">[ </span><span style="color:#F97583;">-e</span><span style="color:#E1E4E8;"> cluster.db ]&amp;&amp;</span><span style="color:#B392F0;">sqlite3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster.db</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.dum</span><span style="color:#E1E4E8;">p</span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">../../cluster.db.bak</span></span>
<span class="line"><span style="color:#E1E4E8;">[ </span><span style="color:#F97583;">-e</span><span style="color:#E1E4E8;"> notification.db ]&amp;&amp;</span><span style="color:#B392F0;">sqlite3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">notification.db</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">.dum</span><span style="color:#E1E4E8;">p</span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">../../notification.db.bak</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#B392F0;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">../as.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">../../as.conf.bak</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/local/openvpn_as/etc/db</span></span>
<span class="line"><span style="color:#24292E;">[ </span><span style="color:#D73A49;">-e</span><span style="color:#24292E;"> config.db ]&amp;&amp;</span><span style="color:#6F42C1;">sqlite3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">config.db</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.dum</span><span style="color:#24292E;">p</span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">../../config.db.bak</span></span>
<span class="line"><span style="color:#24292E;">[ </span><span style="color:#D73A49;">-e</span><span style="color:#24292E;"> certs.db ]&amp;&amp;</span><span style="color:#6F42C1;">sqlite3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">certs.db</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.dum</span><span style="color:#24292E;">p</span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">../../certs.db.bak</span></span>
<span class="line"><span style="color:#24292E;">[ </span><span style="color:#D73A49;">-e</span><span style="color:#24292E;"> userprop.db ]&amp;&amp;</span><span style="color:#6F42C1;">sqlite3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">userprop.db</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.dum</span><span style="color:#24292E;">p</span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">../../userprop.db.bak</span></span>
<span class="line"><span style="color:#24292E;">[ </span><span style="color:#D73A49;">-e</span><span style="color:#24292E;"> log.db ]&amp;&amp;</span><span style="color:#6F42C1;">sqlite3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">log.db</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.dum</span><span style="color:#24292E;">p</span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">../../log.db.bak</span></span>
<span class="line"><span style="color:#24292E;">[ </span><span style="color:#D73A49;">-e</span><span style="color:#24292E;"> config_local.db ]&amp;&amp;</span><span style="color:#6F42C1;">sqlite3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">config_local.db</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.dum</span><span style="color:#24292E;">p</span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">../../config_local.db.bak</span></span>
<span class="line"><span style="color:#24292E;">[ </span><span style="color:#D73A49;">-e</span><span style="color:#24292E;"> cluster.db ]&amp;&amp;</span><span style="color:#6F42C1;">sqlite3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster.db</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.dum</span><span style="color:#24292E;">p</span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">../../cluster.db.bak</span></span>
<span class="line"><span style="color:#24292E;">[ </span><span style="color:#D73A49;">-e</span><span style="color:#24292E;"> notification.db ]&amp;&amp;</span><span style="color:#6F42C1;">sqlite3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">notification.db</span><span style="color:#24292E;"> </span><span style="color:#032F62;">.dum</span><span style="color:#24292E;">p</span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">../../notification.db.bak</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">cp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">../as.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">../../as.conf.bak</span></span></code></pre></div><h2 id="_3-4-添加登录信息" tabindex="-1">3.4 添加登录信息 <a class="header-anchor" href="#_3-4-添加登录信息" aria-label="Permalink to &quot;3.4 添加登录信息&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">as.conf</span></span>
<span class="line"><span style="color:#B392F0;">sa.company_name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">HOO</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Inc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">as.conf</span></span>
<span class="line"><span style="color:#6F42C1;">sa.company_name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">HOO</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Inc</span></span></code></pre></div><ul><li>效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291457059.png" alt="image-20240829145658396"></p><h2 id="_3-5-修改公司logo" tabindex="-1">3.5 修改公司logo <a class="header-anchor" href="#_3-5-修改公司logo" aria-label="Permalink to &quot;3.5 修改公司logo&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">sa.logo_image_file</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/local/openvpn_as/companylogo.png</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">sa.logo_image_file</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/local/openvpn_as/companylogo.png</span></span></code></pre></div><p>图片要求</p><p>用具有透明背景,宽340像素,高50-300像素的PNG</p><h2 id="_3-6-隐藏页脚" tabindex="-1">3.6 隐藏页脚 <a class="header-anchor" href="#_3-6-隐藏页脚" aria-label="Permalink to &quot;3.6 隐藏页脚&quot;">​</a></h2><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291459886.png" alt="image-20240829145924551"></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">as.conf</span></span>
<span class="line"><span style="color:#B392F0;">cs.footer</span><span style="color:#E1E4E8;">=hide</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">as.conf</span></span>
<span class="line"><span style="color:#6F42C1;">cs.footer</span><span style="color:#24292E;">=hide</span></span></code></pre></div><ul><li>效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291500711.png" alt="image-20240829150026984"></p><h1 id="_4-用户管理" tabindex="-1">4. 用户管理 <a class="header-anchor" href="#_4-用户管理" aria-label="Permalink to &quot;4. 用户管理&quot;">​</a></h1><h2 id="_4-0-查看用户属性" tabindex="-1">4.0 查看用户属性 <a class="header-anchor" href="#_4-0-查看用户属性" aria-label="Permalink to &quot;4.0 查看用户属性&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Rocky scripts]# ./sacli --user </span><span style="color:#9ECBFF;">&quot;openvpn&quot;</span><span style="color:#E1E4E8;"> UserPropGet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Rocky scripts]# ./sacli --user </span><span style="color:#032F62;">&quot;openvpn&quot;</span><span style="color:#24292E;"> UserPropGet</span></span></code></pre></div><h2 id="_4-1-创建用户" tabindex="-1">4.1 创建用户 <a class="header-anchor" href="#_4-1-创建用户" aria-label="Permalink to &quot;4.1 创建用户&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Rocky scripts]# ./sacli --user </span><span style="color:#9ECBFF;">&quot;newuser&quot;</span><span style="color:#E1E4E8;"> --new_pass </span><span style="color:#9ECBFF;">&quot;password123&quot;</span><span style="color:#E1E4E8;"> SetLocalPassword</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Rocky scripts]# ./sacli --user </span><span style="color:#032F62;">&quot;newuser&quot;</span><span style="color:#24292E;"> --new_pass </span><span style="color:#032F62;">&quot;password123&quot;</span><span style="color:#24292E;"> SetLocalPassword</span></span></code></pre></div><ul><li>设置用户权限</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">./sacli</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--user</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;newuser&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;prop_superuser&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--value</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;true&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UserPropPut</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">./sacli</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--user</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;newuser&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;prop_superuser&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--value</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;true&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UserPropPut</span></span></code></pre></div><ul><li>配置认证</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#认证模式为本地</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Rocky scripts]# ./sacli --user </span><span style="color:#9ECBFF;">&quot;newuser&quot;</span><span style="color:#E1E4E8;"> --key </span><span style="color:#9ECBFF;">&quot;user_auth_type&quot;</span><span style="color:#E1E4E8;"> --value </span><span style="color:#9ECBFF;">&quot;local&quot;</span><span style="color:#E1E4E8;"> UserPropPut</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#认证模式为本地</span></span>
<span class="line"><span style="color:#24292E;">[root@Rocky scripts]# ./sacli --user </span><span style="color:#032F62;">&quot;newuser&quot;</span><span style="color:#24292E;"> --key </span><span style="color:#032F62;">&quot;user_auth_type&quot;</span><span style="color:#24292E;"> --value </span><span style="color:#032F62;">&quot;local&quot;</span><span style="color:#24292E;"> UserPropPut</span></span></code></pre></div><ul><li>应用配置并重启 OpenVPN Access Server</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Rocky scripts]# ./sacli start</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Rocky scripts]# ./sacli start</span></span></code></pre></div><h2 id="_4-2-删除用户" tabindex="-1">4.2 删除用户 <a class="header-anchor" href="#_4-2-删除用户" aria-label="Permalink to &quot;4.2 删除用户&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Rocky scripts]# ./sacli --user </span><span style="color:#9ECBFF;">&quot;newuser&quot;</span><span style="color:#E1E4E8;"> UserPropDel</span></span>
<span class="line"><span style="color:#B392F0;">UserPropPut</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">requires</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">specified</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Rocky scripts]# ./sacli --user </span><span style="color:#032F62;">&quot;newuser&quot;</span><span style="color:#24292E;"> UserPropDel</span></span>
<span class="line"><span style="color:#6F42C1;">UserPropPut</span><span style="color:#24292E;"> </span><span style="color:#032F62;">requires</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">specified</span></span></code></pre></div><h2 id="_4-3-查询用户" tabindex="-1">4.3 查询用户 <a class="header-anchor" href="#_4-3-查询用户" aria-label="Permalink to &quot;4.3 查询用户&quot;">​</a></h2><ul><li>查询指定用户,不加--pfilt显示所有</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@Rocky scripts]# ./sacli --pfilt </span><span style="color:#9ECBFF;">&quot;openvpn&quot;</span><span style="color:#E1E4E8;"> UserPropGet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@Rocky scripts]# ./sacli --pfilt </span><span style="color:#032F62;">&quot;openvpn&quot;</span><span style="color:#24292E;"> UserPropGet</span></span></code></pre></div><h2 id="_4-3-重置用户密码" tabindex="-1">4.3 重置用户密码 <a class="header-anchor" href="#_4-3-重置用户密码" aria-label="Permalink to &quot;4.3 重置用户密码&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#验证用户属性</span></span>
<span class="line"><span style="color:#B392F0;">./sacli</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--user</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;openvpn&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UserPropGet</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 设置成本地验证</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Rocky scripts]# ./sacli --user </span><span style="color:#9ECBFF;">&quot;openvpn&quot;</span><span style="color:#E1E4E8;"> --key </span><span style="color:#9ECBFF;">&quot;user_auth_type&quot;</span><span style="color:#E1E4E8;"> --value </span><span style="color:#9ECBFF;">&quot;local&quot;</span><span style="color:#E1E4E8;"> UserPropPut</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[True, {}]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#重置密码</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@Rocky scripts]# ./sacli --user </span><span style="color:#9ECBFF;">&quot;openvpn&quot;</span><span style="color:#E1E4E8;"> --new_pass </span><span style="color:#9ECBFF;">&quot;123456&quot;</span><span style="color:#E1E4E8;"> SetLocalPassword</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#验证用户属性</span></span>
<span class="line"><span style="color:#6F42C1;">./sacli</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--user</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;openvpn&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UserPropGet</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 设置成本地验证</span></span>
<span class="line"><span style="color:#24292E;">[root@Rocky scripts]# ./sacli --user </span><span style="color:#032F62;">&quot;openvpn&quot;</span><span style="color:#24292E;"> --key </span><span style="color:#032F62;">&quot;user_auth_type&quot;</span><span style="color:#24292E;"> --value </span><span style="color:#032F62;">&quot;local&quot;</span><span style="color:#24292E;"> UserPropPut</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[True, {}]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#重置密码</span></span>
<span class="line"><span style="color:#24292E;">[root@Rocky scripts]# ./sacli --user </span><span style="color:#032F62;">&quot;openvpn&quot;</span><span style="color:#24292E;"> --new_pass </span><span style="color:#032F62;">&quot;123456&quot;</span><span style="color:#24292E;"> SetLocalPassword</span></span></code></pre></div><h2 id="_4-4-允许多用户连接" tabindex="-1">4.4 允许多用户连接 <a class="header-anchor" href="#_4-4-允许多用户连接" aria-label="Permalink to &quot;4.4 允许多用户连接&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">/usr/local/openvpn_as/scripts/sacli</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;vpn.server.user.allow_multiple_sessions&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--value</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;true&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ConfigPut</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">/usr/local/openvpn_as/scripts/sacli</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">/usr/local/openvpn_as/scripts/sacli</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;vpn.server.user.allow_multiple_sessions&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--value</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;true&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ConfigPut</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">/usr/local/openvpn_as/scripts/sacli</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span></span></code></pre></div><h1 id="_5-web界面" tabindex="-1">5. web界面 <a class="header-anchor" href="#_5-web界面" aria-label="Permalink to &quot;5. web界面&quot;">​</a></h1><h2 id="_5-1-用户管理" tabindex="-1">5.1 用户管理 <a class="header-anchor" href="#_5-1-用户管理" aria-label="Permalink to &quot;5.1 用户管理&quot;">​</a></h2><h3 id="_5-1-1-重置密码" tabindex="-1">5.1.1 重置密码 <a class="header-anchor" href="#_5-1-1-重置密码" aria-label="Permalink to &quot;5.1.1 重置密码&quot;">​</a></h3><p>登录到 OpenVPN Access Server 的 Web 管理界面（通常是 <code>https://&lt;server-ip&gt;:943/admin</code>）。</p><p>在左侧导航栏中，点击 <strong>User Permissions</strong>。</p><p>找到你要重置密码的用户，点击 <strong>Edit</strong>。</p><p>在用户设置页面中，有一个 <strong>Set Password</strong> 选项，点击该选项并输入新密码。</p><p>保存更改。</p><h3 id="_5-1-2-创建用户" tabindex="-1">5.1.2 创建用户 <a class="header-anchor" href="#_5-1-2-创建用户" aria-label="Permalink to &quot;5.1.2 创建用户&quot;">​</a></h3><p><strong>登录 Web 管理界面</strong> 使用管理员账户登录到 OpenVPN Access Server 的 Web 管理界面，通常是通过以下 URL 访问： <code>https://&lt;server-ip&gt;:943/admin</code></p><p><strong>创建新用户</strong> 在左侧菜单中，点击 <strong>User Permissions</strong>。</p><p><strong>添加新用户</strong> 在页面的顶部，点击 <strong>Add User</strong>，并填写新用户的用户名和密码。</p><p><strong>设置权限</strong> 在权限设置页面，你可以为用户配置不同的权限，如是否允许 VPN 访问，是否赋予管理员权限等。</p><p><strong>保存更改</strong> 点击保存以创建新用户</p><h3 id="_5-1-3-查询用户" tabindex="-1">5.1.3 查询用户 <a class="header-anchor" href="#_5-1-3-查询用户" aria-label="Permalink to &quot;5.1.3 查询用户&quot;">​</a></h3><p><strong>登录 Web 管理界面</strong> 通过浏览器访问 OpenVPN Access Server 管理界面： <code>https://&lt;server-ip&gt;:943/admin</code></p><p><strong>查看用户列表</strong> 在管理界面中，点击 <strong>User Permissions</strong> 菜单，你将看到所有用户的列表，包括他们的访问权限状态等信息。</p><p><strong>查询特定用户</strong> 在 <strong>User Permissions</strong> 页面中，找到并点击用户的用户名，你可以查看该用户的详细信息和配置。</p><h1 id="_6-客户端下载" tabindex="-1">6. 客户端下载 <a class="header-anchor" href="#_6-客户端下载" aria-label="Permalink to &quot;6. 客户端下载&quot;">​</a></h1><h2 id="_6-1-win" tabindex="-1">6.1 win <a class="header-anchor" href="#_6-1-win" aria-label="Permalink to &quot;6.1 win&quot;">​</a></h2><p>直接访问,<a href="https://ip:943" target="_blank" rel="noreferrer">https://ip:943</a></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408272255790.png" alt="image-20240827225555195"></p><h2 id="_6-2-mac" tabindex="-1">6.2 mac <a class="header-anchor" href="#_6-2-mac" aria-label="Permalink to &quot;6.2 mac&quot;">​</a></h2><p>直接访问,<a href="https://ip:943" target="_blank" rel="noreferrer">https://ip:943</a></p><h1 id="_7-线上流量分流案例" tabindex="-1">7. 线上流量分流案例 <a class="header-anchor" href="#_7-线上流量分流案例" aria-label="Permalink to &quot;7. 线上流量分流案例&quot;">​</a></h1><h2 id="_7-1-configuration配置" tabindex="-1">7.1 Configuration配置 <a class="header-anchor" href="#_7-1-configuration配置" aria-label="Permalink to &quot;7.1 Configuration配置&quot;">​</a></h2><h3 id="_7-1-1-network-setting" tabindex="-1">7.1.1 Network setting <a class="header-anchor" href="#_7-1-1-network-setting" aria-label="Permalink to &quot;7.1.1 Network setting&quot;">​</a></h3><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291723927.png" alt="image-20240829172259381"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291725990.png" alt="image-20240829172502090"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291726983.png" alt="image-20240829172600576"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291728548.png" alt="image-20240829172846660"></p><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>点击 Save Settings,重启服务</p></div><h3 id="_7-1-2-vpn-settings配置" tabindex="-1">7.1.2 VPN Settings配置 <a class="header-anchor" href="#_7-1-2-vpn-settings配置" aria-label="Permalink to &quot;7.1.2 VPN Settings配置&quot;">​</a></h3><ul><li>客户端分配ip地址</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291731361.png" alt="image-20240829173130527"></p><ul><li>设置路由</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291733428.png" alt="image-20240829173345635"></p><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>如下保持不变</p></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291737104.png" alt="image-20240829173707094"></p><p>其他参考文档:<a href="https://openvpn.net/as-docs/configuration.html#create-a-new-ca" target="_blank" rel="noreferrer">https://openvpn.net/as-docs/configuration.html#create-a-new-ca</a></p><h2 id="_7-2-user-management" tabindex="-1">7.2 User ManageMent <a class="header-anchor" href="#_7-2-user-management" aria-label="Permalink to &quot;7.2 User ManageMent&quot;">​</a></h2><h3 id="_7-2-1-user-permissions" tabindex="-1">7.2.1 user permissions <a class="header-anchor" href="#_7-2-1-user-permissions" aria-label="Permalink to &quot;7.2.1 user permissions&quot;">​</a></h3><ul><li>创建用户</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291739497.png" alt="image-20240829173906896"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291741056.png" alt="image-20240829174154503"></p><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>只设置这两处,其他保持默认, 点击保存重启服务</p></div><h3 id="_7-2-2-user-profiels-ovpn文件" tabindex="-1">7.2.2 user Profiels(ovpn文件) <a class="header-anchor" href="#_7-2-2-user-profiels-ovpn文件" aria-label="Permalink to &quot;7.2.2 user Profiels(ovpn文件)&quot;">​</a></h3><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291810529.png" alt="image-20240829181011867"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291811047.png" alt="image-20240829181058499"></p><h2 id="_7-3-dns设置" tabindex="-1">7.3 DNS设置 <a class="header-anchor" href="#_7-3-dns设置" aria-label="Permalink to &quot;7.3 DNS设置&quot;">​</a></h2><h3 id="_7-3-1-configuration" tabindex="-1">7.3.1 Configuration <a class="header-anchor" href="#_7-3-1-configuration" aria-label="Permalink to &quot;7.3.1 Configuration&quot;">​</a></h3><p>只配置这三处,其他保持默认</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291750239.png" alt="image-20240829174955974"></p><h3 id="_7-3-2-部署dns服务" tabindex="-1">7.3.2 部署dns服务 <a class="header-anchor" href="#_7-3-2-部署dns服务" aria-label="Permalink to &quot;7.3.2 部署dns服务&quot;">​</a></h3><p>1.安装</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#centos系列</span></span>
<span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dnsmasq</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#创建日志目录</span></span>
<span class="line"><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/log/dnsmasq/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#centos系列</span></span>
<span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dnsmasq</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#创建日志目录</span></span>
<span class="line"><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/log/dnsmasq/</span></span></code></pre></div><p>2.配置</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#备份原始文件</span></span>
<span class="line"><span style="color:#B392F0;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/dnsmasq.conf{,.back}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#修改之后的样子</span></span>
<span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/dnsmasq.conf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">no-poll</span></span>
<span class="line"><span style="color:#B392F0;">clear-on-reload</span></span>
<span class="line"><span style="color:#B392F0;">no-negcache</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">resolv-file</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/resolv.dnsmasq.conf</span></span>
<span class="line"><span style="color:#B392F0;">strict-order</span></span>
<span class="line"><span style="color:#E1E4E8;">server</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">114.114</span><span style="color:#9ECBFF;">.114.114</span></span>
<span class="line"><span style="color:#E1E4E8;">listen-address</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10.8</span><span style="color:#9ECBFF;">.0.1,127.0.0.1,172.18.0.24</span></span>
<span class="line"><span style="color:#E1E4E8;">addn-hosts</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/dnsmasq.hosts</span></span>
<span class="line"><span style="color:#E1E4E8;">cache-size</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1024</span></span>
<span class="line"><span style="color:#E1E4E8;">bogus-nxdomain</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">114.114</span><span style="color:#9ECBFF;">.114.114</span></span>
<span class="line"><span style="color:#B392F0;">log-queries</span></span>
<span class="line"><span style="color:#E1E4E8;">log-facility</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/var/log/dnsmasq/dnsmasq.log</span></span>
<span class="line"><span style="color:#E1E4E8;">conf-dir</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/dnsmasq.d</span></span>
<span class="line"><span style="color:#E1E4E8;">conf-dir</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/dnsmasq.d,.bak</span></span>
<span class="line"><span style="color:#E1E4E8;">conf-dir</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/dnsmasq.d/,</span><span style="color:#79B8FF;">*</span><span style="color:#9ECBFF;">.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">conf-dir</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/dnsmasq.d,.rpmnew,.rpmsave,.rpmorig</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#备份原始文件</span></span>
<span class="line"><span style="color:#6F42C1;">cp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/dnsmasq.conf{,.back}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#修改之后的样子</span></span>
<span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/dnsmasq.conf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">no-poll</span></span>
<span class="line"><span style="color:#6F42C1;">clear-on-reload</span></span>
<span class="line"><span style="color:#6F42C1;">no-negcache</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">resolv-file</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/resolv.dnsmasq.conf</span></span>
<span class="line"><span style="color:#6F42C1;">strict-order</span></span>
<span class="line"><span style="color:#24292E;">server</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">114.114</span><span style="color:#032F62;">.114.114</span></span>
<span class="line"><span style="color:#24292E;">listen-address</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10.8</span><span style="color:#032F62;">.0.1,127.0.0.1,172.18.0.24</span></span>
<span class="line"><span style="color:#24292E;">addn-hosts</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/dnsmasq.hosts</span></span>
<span class="line"><span style="color:#24292E;">cache-size</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1024</span></span>
<span class="line"><span style="color:#24292E;">bogus-nxdomain</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">114.114</span><span style="color:#032F62;">.114.114</span></span>
<span class="line"><span style="color:#6F42C1;">log-queries</span></span>
<span class="line"><span style="color:#24292E;">log-facility</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/var/log/dnsmasq/dnsmasq.log</span></span>
<span class="line"><span style="color:#24292E;">conf-dir</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/dnsmasq.d</span></span>
<span class="line"><span style="color:#24292E;">conf-dir</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/dnsmasq.d,.bak</span></span>
<span class="line"><span style="color:#24292E;">conf-dir</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/dnsmasq.d/,</span><span style="color:#005CC5;">*</span><span style="color:#032F62;">.conf</span></span>
<span class="line"><span style="color:#24292E;">conf-dir</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/dnsmasq.d,.rpmnew,.rpmsave,.rpmorig</span></span></code></pre></div><p>100.100.2.136 ---&gt; 公共dns地址</p><p>10.8.0.1 ---&gt; vpn地址</p><p>172.18.0.24 ---&gt; eth0地址</p><p>3.重启所有服务</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dnsmasq.service</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openvpnas.service</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dnsmasq.service</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openvpnas.service</span></span></code></pre></div><p>4.配置hosts文件</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@xxx </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# cat /etc/dnsmasq.hosts</span></span>
<span class="line"><span style="color:#B392F0;">47.92.165.146</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">log.freehan.ink</span></span>
<span class="line"><span style="color:#B392F0;">172.18.0.24</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bot.freehan.ink</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@xxx </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# cat /etc/dnsmasq.hosts</span></span>
<span class="line"><span style="color:#6F42C1;">47.92.165.146</span><span style="color:#24292E;"> </span><span style="color:#032F62;">log.freehan.ink</span></span>
<span class="line"><span style="color:#6F42C1;">172.18.0.24</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bot.freehan.ink</span></span></code></pre></div><blockquote><p>47.92.165.146 非相同vpc下网络</p><p>172.18.0.24 相同vpc网络</p></blockquote><h2 id="_7-4-客户端安装" tabindex="-1">7.4 客户端安装 <a class="header-anchor" href="#_7-4-客户端安装" aria-label="Permalink to &quot;7.4 客户端安装&quot;">​</a></h2><p>根据自己的环境进行下载</p><p><a href="https://ip:11943" target="_blank" rel="noreferrer">https://ip:11943</a></p><p>输入先前创建的用户</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291804039.png" alt="image-20240829180446043"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291806255.png" alt="image-20240829180614720"></p><p>安装省略...</p><h3 id="_7-4-1-导入ovpn文件" tabindex="-1">7.4.1 导入ovpn文件 <a class="header-anchor" href="#_7-4-1-导入ovpn文件" aria-label="Permalink to &quot;7.4.1 导入ovpn文件&quot;">​</a></h3><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291812840.png" alt="image-20240829181227028"></p><h3 id="_7-4-2-运行" tabindex="-1">7.4.2 运行 <a class="header-anchor" href="#_7-4-2-运行" aria-label="Permalink to &quot;7.4.2 运行&quot;">​</a></h3><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291813564.png" alt="image-20240829181319240"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291815894.png" alt="image-20240829181537813"></p><p><code>代表启动成功</code></p><h3 id="_7-4-3-验证" tabindex="-1">7.4.3 验证 <a class="header-anchor" href="#_7-4-3-验证" aria-label="Permalink to &quot;7.4.3 验证&quot;">​</a></h3><ul><li>没有开启vpn</li></ul><p><code>非相同vpc下</code></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291816242.png" alt="image-20240829181646192"></p><p><code>相同vpc网络下</code></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291818837.png" alt="image-20240829181854176"></p><ul><li>开启之后</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291817935.png" alt="image-20240829181725826"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408291820728.png" alt="image-20240829182034442"></p><h1 id="_8-faq" tabindex="-1">8.FAQ <a class="header-anchor" href="#_8-faq" aria-label="Permalink to &quot;8.FAQ&quot;">​</a></h1><h2 id="_8-1-mac客户端" tabindex="-1">8.1 mac客户端 <a class="header-anchor" href="#_8-1-mac客户端" aria-label="Permalink to &quot;8.1 mac客户端&quot;">​</a></h2><p>在一部分Mac上使用OpenVPN进行连接公司网络，出现错误：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Transport</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Error:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">socket_protect</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">error</span><span style="color:#E1E4E8;"> (UDP)</span></span>
<span class="line"><span style="color:#B392F0;">Client</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">terminated,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restarting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2000</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ms...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Transport</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Error:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">socket_protect</span><span style="color:#24292E;"> </span><span style="color:#032F62;">error</span><span style="color:#24292E;"> (UDP)</span></span>
<span class="line"><span style="color:#6F42C1;">Client</span><span style="color:#24292E;"> </span><span style="color:#032F62;">terminated,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restarting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2000</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ms...</span></span></code></pre></div><p>出现原因：</p><p>在启动这个OpenVPN时，不知道什么原因导致<code>/var/run/agent_ovpnconnect.sock</code>服务没有正常启动</p><p>解决办法二：</p><p>设置自动加载命令，加载并启动相关服务，重启电脑后不用重新手动启用</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">launchctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">load</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-w</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/Library/LaunchDaemons/org.openvpn.client.plist</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">launchctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">load</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-w</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/Library/LaunchDaemons/org.openvpn.client.plist</span></span></code></pre></div><p>参考：</p><p><a href="https://docs.netgate.com/pfsense/en/latest/recipes/openvpn-ra.html#tunnel-settings" target="_blank" rel="noreferrer">https://docs.netgate.com/pfsense/en/latest/recipes/openvpn-ra.html#tunnel-settings</a></p><p><a href="https://openvpn.net/as-docs/configuration.html##" target="_blank" rel="noreferrer">https://openvpn.net/as-docs/configuration.html##</a></p>`,217),e=[o];function t(c,r,i,y,E,d){return a(),n("div",null,e)}const u=s(l,[["render",t]]);export{h as __pageData,u as default};
