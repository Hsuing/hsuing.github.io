import{_ as s,o as n,c as a,R as p}from"./chunks/framework.zUbWieqp.js";const g=JSON.parse('{"title":"1. Ingress基于URL实现路由","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/Ingress/ingress_nginx/3-使用.md","filePath":"guide/container/k8s/Ingress/ingress_nginx/3-使用.md","lastUpdated":1734344767000}'),l={name:"guide/container/k8s/Ingress/ingress_nginx/3-使用.md"},o=p(`<div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Ingres官方文档:</span></span>
<span class="line"><span style="color:#B392F0;">　　　　https://kubernetes.io/docs/concepts/services-networking/ingress/</span></span>
<span class="line"><span style="color:#B392F0;">　　　　</span></span>
<span class="line"><span style="color:#B392F0;">Ingress-Nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">github</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">地址：https://github.com/kubernetes/ingress-nginx</span></span>
<span class="line"><span style="color:#B392F0;">Ingress-Nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">官方网站：https://kubernetes.github.io/ingress-nginx/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Ingres官方文档:</span></span>
<span class="line"><span style="color:#6F42C1;">　　　　https://kubernetes.io/docs/concepts/services-networking/ingress/</span></span>
<span class="line"><span style="color:#6F42C1;">　　　　</span></span>
<span class="line"><span style="color:#6F42C1;">Ingress-Nginx</span><span style="color:#24292E;"> </span><span style="color:#032F62;">github</span><span style="color:#24292E;"> </span><span style="color:#032F62;">地址：https://github.com/kubernetes/ingress-nginx</span></span>
<span class="line"><span style="color:#6F42C1;">Ingress-Nginx</span><span style="color:#24292E;"> </span><span style="color:#032F62;">官方网站：https://kubernetes.github.io/ingress-nginx/</span></span></code></pre></div><h1 id="_1-ingress基于url实现路由" tabindex="-1">1. Ingress基于URL实现路由 <a class="header-anchor" href="#_1-ingress基于url实现路由" aria-label="Permalink to &quot;1. Ingress基于URL实现路由&quot;">​</a></h1><h2 id="_1-1-部署demo" tabindex="-1">1.1 部署demo <a class="header-anchor" href="#_1-1-部署demo" aria-label="Permalink to &quot;1.1 部署demo&quot;">​</a></h2><ul><li>创建deploy yaml文件</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat app-deploy-service.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-role</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-role</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#6A737D;">#Service</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-service</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NodePort</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-role</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat app-deploy-service.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-role</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-role</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#6A737D;">#Service</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-service</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NodePort</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-role</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><ul><li>执行apply</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[root@kube-master ingress]# kubectl apply  -f app-deploy-service.yaml</span></span>
<span class="line"><span style="color:#e1e4e8;">deployment.apps/app-prod created</span></span>
<span class="line"><span style="color:#e1e4e8;">service/app-prod-service created</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[root@kube-master ingress]# kubectl apply  -f app-deploy-service.yaml</span></span>
<span class="line"><span style="color:#24292e;">deployment.apps/app-prod created</span></span>
<span class="line"><span style="color:#24292e;">service/app-prod-service created</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get svc</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get svc</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">CLUSTER-IP</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">EXTERNAL-IP</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">PORT</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">S</span><span style="color:#E1E4E8;">)        </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">app-prod-service</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">NodePort</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.172.245</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">:32532/TCP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">m38s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get svc</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get svc</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">               </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">        </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">        </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)        </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">app-prod-service</span><span style="color:#24292E;">   </span><span style="color:#032F62;">NodePort</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.172.245</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">:32532/TCP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">m38s</span></span></code></pre></div><h2 id="_1-2-部署tomcat" tabindex="-1">1.2 部署tomcat <a class="header-anchor" href="#_1-2-部署tomcat" aria-label="Permalink to &quot;1.2 部署tomcat&quot;">​</a></h2><ul><li>创建yaml文件</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat java-deploy-service.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat:9.0.63</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">limits</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">100m</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">128Mi</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">requests</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">50m</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">64Mi</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">lifecycle</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">postStart</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">exec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;sh&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;-c&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;cp -rf /usr/local/tomcat/webapps.dist/* /usr/local/tomcat/webapps/&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NodePort</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat java-deploy-service.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat:9.0.63</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">limits</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">100m</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">128Mi</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">50m</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">64Mi</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">lifecycle</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">postStart</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">exec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;sh&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;-c&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;cp -rf /usr/local/tomcat/webapps.dist/* /usr/local/tomcat/webapps/&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NodePort</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span></code></pre></div><ul><li>执行</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">java-deploy-service.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">java-deploy-service.yaml</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get svc</span></span>
<span class="line"><span style="color:#B392F0;">tomcat-prod-service</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">NodePort</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.204.162</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">:30763/TCP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">7</span><span style="color:#9ECBFF;">m11s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get svc</span></span>
<span class="line"><span style="color:#6F42C1;">tomcat-prod-service</span><span style="color:#24292E;">   </span><span style="color:#032F62;">NodePort</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.204.162</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">:30763/TCP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">7</span><span style="color:#032F62;">m11s</span></span></code></pre></div><h2 id="_1-3-配置ingress" tabindex="-1">1.3 配置Ingress <a class="header-anchor" href="#_1-3-配置ingress" aria-label="Permalink to &quot;1.3 配置Ingress&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat ingress-app-java.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">foo-ingress</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/proxy-read-timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;600&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/proxy-send-timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;600&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/$2</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 配置Rewrite规则</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">foo.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/java(/|$)(.*)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/app(/|$)(.*)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-service</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat ingress-app-java.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">foo-ingress</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/proxy-read-timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;600&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/proxy-send-timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;600&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/$2</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 配置Rewrite规则</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">foo.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/java(/|$)(.*)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/app(/|$)(.*)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-service</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><ul><li>查看ingress</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get ingress</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">CLASS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">HOSTS</span><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">ADDRESS</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">PORTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">foo-ingress</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">nginx</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">foo.host.com</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.104.132</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">29</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">my-ingress</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">nginx</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">my.host.com</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.104.132</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">17</span><span style="color:#9ECBFF;">h</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get ingress</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">          </span><span style="color:#032F62;">CLASS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">HOSTS</span><span style="color:#24292E;">          </span><span style="color:#032F62;">ADDRESS</span><span style="color:#24292E;">           </span><span style="color:#032F62;">PORTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">foo-ingress</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">   </span><span style="color:#032F62;">foo.host.com</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.104.132</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">29</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">my-ingress</span><span style="color:#24292E;">    </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">   </span><span style="color:#032F62;">my.host.com</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.104.132</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">17</span><span style="color:#032F62;">h</span></span></code></pre></div><ul><li>解析域名</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405211132899.png" alt="image-20240521113217906"></p><ul><li>验证结果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405211130695.png" alt="image-20240521112937741"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405211131742.png" alt="image-20240521113113860"></p><h1 id="_2-ingress基于名称虚拟主机" tabindex="-1">2. Ingress基于名称虚拟主机 <a class="header-anchor" href="#_2-ingress基于名称虚拟主机" aria-label="Permalink to &quot;2. Ingress基于名称虚拟主机&quot;">​</a></h1><p>场景：将来⾃不同的域名的请求调度到不同Service</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405211251805.png" alt="image-20240521114742782"></p><h2 id="_2-1-部署demo" tabindex="-1">2.1 部署demo <a class="header-anchor" href="#_2-1-部署demo" aria-label="Permalink to &quot;2.1 部署demo&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat app-deploy-service.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-role</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-role</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#6A737D;">#Service</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-service</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-role</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat app-deploy-service.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-role</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-role</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/demoapp:v1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#6A737D;">#Service</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-service</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-role</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><h2 id="_2-2-部署tomcat" tabindex="-1">2.2 部署tomcat <a class="header-anchor" href="#_2-2-部署tomcat" aria-label="Permalink to &quot;2.2 部署tomcat&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat java-deploy-service.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat:9.0.63</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">limits</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">200m</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">200Mi</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">requests</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">100m</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">100Mi</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">lifecycle</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">postStart</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">exec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;/bin/bash&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;-c&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;cp -rf /usr/local/tomcat/webapps.dist/* /usr/local/tomcat/webapps&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NodePort</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">role</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat java-deploy-service.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat:9.0.63</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">limits</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">200m</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">200Mi</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">100m</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">100Mi</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">lifecycle</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">postStart</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">exec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;/bin/bash&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;-c&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;cp -rf /usr/local/tomcat/webapps.dist/* /usr/local/tomcat/webapps&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NodePort</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">role</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span></code></pre></div><h2 id="_2-3-创建ingress" tabindex="-1">2.3 创建ingress <a class="header-anchor" href="#_2-3-创建ingress" aria-label="Permalink to &quot;2.3 创建ingress&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat ingress-domain.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-domain</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app-prod-service</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat ingress-domain.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-domain</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">app-prod-service</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><ul><li>执行apply</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ingress-domain.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ingress-domain.yaml</span></span></code></pre></div><ul><li>查看ingress</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get ingress</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">             </span><span style="color:#9ECBFF;">CLASS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">HOSTS</span><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">ADDRESS</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">PORTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">ingress-domain</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">nginx</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">app.host.com,java.host.com</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.104.132</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">m55s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get ingress</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">             </span><span style="color:#032F62;">CLASS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">HOSTS</span><span style="color:#24292E;">                        </span><span style="color:#032F62;">ADDRESS</span><span style="color:#24292E;">           </span><span style="color:#032F62;">PORTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-domain</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">   </span><span style="color:#032F62;">app.host.com,java.host.com</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.104.132</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m55s</span></span></code></pre></div><ul><li>验证效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405211424020.png" alt="image-20240521142359404"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405211424659.png" alt="image-20240521142420260"></p><h1 id="_3-ingress实现https" tabindex="-1">3. Ingress实现HTTPS <a class="header-anchor" href="#_3-ingress实现https" aria-label="Permalink to &quot;3. Ingress实现HTTPS&quot;">​</a></h1><p>在 Ingress 中引⽤ Secret资源，然后告诉 Ingress 控制器使⽤TLS 加密从客户端到负载均衡器的通道</p><p><code>默认是强制http-https</code></p><h2 id="_3-1-创建tls证书" tabindex="-1">3.1 创建TLS证书 <a class="header-anchor" href="#_3-1-创建tls证书" aria-label="Permalink to &quot;3.1 创建TLS证书&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#创建key</span></span>
<span class="line"><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">genrsa</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-out</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">java.key</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2048</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#生成crt</span></span>
<span class="line"><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">req</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-new</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-x509</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">java.key</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-out</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">java.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-subj</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/C=CN/ST=Beijing/L=Beijing/O=host/CN=java.host.com&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#时间为一年</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">req</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-x509</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-nodes</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-days</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">365</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-newkey</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rsa:2048</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-keyout</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tls.key</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-out</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tls.crt</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-subj</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/CN=java.host.com&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#创建key</span></span>
<span class="line"><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;">  </span><span style="color:#032F62;">genrsa</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">java.key</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2048</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#生成crt</span></span>
<span class="line"><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">req</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-new</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">java.key</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">java.crt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-subj</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/C=CN/ST=Beijing/L=Beijing/O=host/CN=java.host.com&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#时间为一年</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">req</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-nodes</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-days</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">365</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-newkey</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rsa:2048</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-keyout</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tls.key</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-out</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tls.crt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-subj</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/CN=java.host.com&quot;</span></span></code></pre></div><h2 id="_3-2-创建secrets" tabindex="-1">3.2 创建Secrets <a class="header-anchor" href="#_3-2-创建secrets" aria-label="Permalink to &quot;3.2 创建Secrets&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl create secret tls java-host-com-tls --key=java.key --cert=java.crt</span></span>
<span class="line"><span style="color:#B392F0;">secret/java-host-com-tls</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl create secret tls java-host-com-tls --key=java.key --cert=java.crt</span></span>
<span class="line"><span style="color:#6F42C1;">secret/java-host-com-tls</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span></code></pre></div><h2 id="_3-3-配置ingress" tabindex="-1">3.3 配置Ingress <a class="header-anchor" href="#_3-3-配置ingress" aria-label="Permalink to &quot;3.3 配置Ingress&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat java-ingress-tls.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-domain</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tls</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">secretName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java-host-com-tls</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat java-ingress-tls.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-domain</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tls</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">secretName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java-host-com-tls</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><p>或者</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> kubectl create -f -</span></span>
<span class="line"><span style="color:#9ECBFF;">apiVersion: networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#9ECBFF;">kind: Ingress</span></span>
<span class="line"><span style="color:#9ECBFF;">metadata:</span></span>
<span class="line"><span style="color:#9ECBFF;">  name: ingress-domain</span></span>
<span class="line"><span style="color:#9ECBFF;">spec:</span></span>
<span class="line"><span style="color:#9ECBFF;">  ingressClassName: nginx</span></span>
<span class="line"><span style="color:#9ECBFF;">  tls:</span></span>
<span class="line"><span style="color:#9ECBFF;">  - hosts:</span></span>
<span class="line"><span style="color:#9ECBFF;">    - java.host.com</span></span>
<span class="line"><span style="color:#9ECBFF;">    secretName: java-host-com-tls # secrets资源名称</span></span>
<span class="line"><span style="color:#9ECBFF;">  rules:</span></span>
<span class="line"><span style="color:#9ECBFF;">  - host: java.host.com</span></span>
<span class="line"><span style="color:#9ECBFF;">    http:</span></span>
<span class="line"><span style="color:#9ECBFF;">      paths:</span></span>
<span class="line"><span style="color:#9ECBFF;">      - path: /</span></span>
<span class="line"><span style="color:#9ECBFF;">        pathType: Prefix</span></span>
<span class="line"><span style="color:#9ECBFF;">        backend:</span></span>
<span class="line"><span style="color:#9ECBFF;">          service:</span></span>
<span class="line"><span style="color:#9ECBFF;">            name: tomcat-prod-service</span></span>
<span class="line"><span style="color:#9ECBFF;">            port:</span></span>
<span class="line"><span style="color:#9ECBFF;">              number: 80</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> kubectl create -f -</span></span>
<span class="line"><span style="color:#032F62;">apiVersion: networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#032F62;">kind: Ingress</span></span>
<span class="line"><span style="color:#032F62;">metadata:</span></span>
<span class="line"><span style="color:#032F62;">  name: ingress-domain</span></span>
<span class="line"><span style="color:#032F62;">spec:</span></span>
<span class="line"><span style="color:#032F62;">  ingressClassName: nginx</span></span>
<span class="line"><span style="color:#032F62;">  tls:</span></span>
<span class="line"><span style="color:#032F62;">  - hosts:</span></span>
<span class="line"><span style="color:#032F62;">    - java.host.com</span></span>
<span class="line"><span style="color:#032F62;">    secretName: java-host-com-tls # secrets资源名称</span></span>
<span class="line"><span style="color:#032F62;">  rules:</span></span>
<span class="line"><span style="color:#032F62;">  - host: java.host.com</span></span>
<span class="line"><span style="color:#032F62;">    http:</span></span>
<span class="line"><span style="color:#032F62;">      paths:</span></span>
<span class="line"><span style="color:#032F62;">      - path: /</span></span>
<span class="line"><span style="color:#032F62;">        pathType: Prefix</span></span>
<span class="line"><span style="color:#032F62;">        backend:</span></span>
<span class="line"><span style="color:#032F62;">          service:</span></span>
<span class="line"><span style="color:#032F62;">            name: tomcat-prod-service</span></span>
<span class="line"><span style="color:#032F62;">            port:</span></span>
<span class="line"><span style="color:#032F62;">              number: 80</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span></code></pre></div><ul><li>执行apply</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">java-ingress-tls.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">java-ingress-tls.yaml</span></span></code></pre></div><ul><li>查看ingress</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get ingress</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">             </span><span style="color:#9ECBFF;">CLASS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">HOSTS</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">ADDRESS</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">PORTS</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">ingress-domain</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">nginx</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">java.host.com</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.104.132</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">443</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">m5s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get ingress</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">             </span><span style="color:#032F62;">CLASS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">HOSTS</span><span style="color:#24292E;">           </span><span style="color:#032F62;">ADDRESS</span><span style="color:#24292E;">           </span><span style="color:#032F62;">PORTS</span><span style="color:#24292E;">     </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-domain</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">   </span><span style="color:#032F62;">java.host.com</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.104.132</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">443</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">m5s</span></span></code></pre></div><ul><li>验证效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405211437377.png" alt="image-20240521143740530"></p><h2 id="_3-4-更新证书" tabindex="-1">3.4 更新证书 <a class="header-anchor" href="#_3-4-更新证书" aria-label="Permalink to &quot;3.4 更新证书&quot;">​</a></h2><h3 id="查看证书名字" tabindex="-1">查看证书名字 <a class="header-anchor" href="#查看证书名字" aria-label="Permalink to &quot;查看证书名字&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get secrets</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                  </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">                                  </span><span style="color:#9ECBFF;">DATA</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">java-host-com-tls</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">kubernetes.io/tls</span><span style="color:#E1E4E8;">                     </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">20</span><span style="color:#9ECBFF;">m</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get secrets</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">                                  </span><span style="color:#032F62;">DATA</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">java-host-com-tls</span><span style="color:#24292E;">     </span><span style="color:#032F62;">kubernetes.io/tls</span><span style="color:#24292E;">                     </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">20</span><span style="color:#032F62;">m</span></span></code></pre></div><h3 id="查看过期时间" tabindex="-1">查看过期时间 <a class="header-anchor" href="#查看过期时间" aria-label="Permalink to &quot;查看过期时间&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# openssl x509 -in java.crt -noout -dates</span></span>
<span class="line"><span style="color:#E1E4E8;">notBefore</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">May</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">21</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">06</span><span style="color:#9ECBFF;">:42:13</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2024</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GMT</span></span>
<span class="line"><span style="color:#E1E4E8;">notAfter</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">Jun</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">06</span><span style="color:#9ECBFF;">:42:13</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2024</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GMT</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# openssl x509 -in java.crt -noout -dates</span></span>
<span class="line"><span style="color:#24292E;">notBefore</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">May</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">21</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">06</span><span style="color:#032F62;">:42:13</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2024</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GMT</span></span>
<span class="line"><span style="color:#24292E;">notAfter</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">Jun</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">06</span><span style="color:#032F62;">:42:13</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2024</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GMT</span></span></code></pre></div><p>或者</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#检查ingress里的配置证书的过期时间</span></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get ingress </span><span style="color:#79B8FF;">-o</span><span style="color:#9ECBFF;"> yaml</span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#9ECBFF;"> secretName:</span><span style="color:#F97583;">|</span><span style="color:#B392F0;">awk</span><span style="color:#9ECBFF;"> &#39;{print $2}&#39;</span><span style="color:#F97583;">|</span><span style="color:#B392F0;">sort</span><span style="color:#F97583;">|</span><span style="color:#B392F0;">uniq</span><span style="color:#9ECBFF;">)</span><span style="color:#E1E4E8;">;</span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> echo -n </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$i</span><span style="color:#9ECBFF;"> - &quot;</span><span style="color:#E1E4E8;">; </span><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">secret</span><span style="color:#E1E4E8;"> $i </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;jsonpath={.data[&#39;tls\\.crt&#39;]}&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">base64</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">x509</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-enddate</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-noout</span><span style="color:#E1E4E8;">;</span><span style="color:#F97583;">done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#检查所有创建的tls证书的过期时间</span></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get secret</span><span style="color:#F97583;">|</span><span style="color:#B392F0;">awk</span><span style="color:#9ECBFF;"> &#39;/tls/{print $1}&#39;)</span><span style="color:#E1E4E8;">;</span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> echo -n </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$i</span><span style="color:#9ECBFF;"> - &quot;</span><span style="color:#E1E4E8;">; </span><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">secret</span><span style="color:#E1E4E8;"> $i </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;jsonpath={.data[&#39;tls\\.crt&#39;]}&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">base64</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">openssl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">x509</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-enddate</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-noout</span><span style="color:#E1E4E8;">;</span><span style="color:#F97583;">done</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#检查ingress里的配置证书的过期时间</span></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">kubectl</span><span style="color:#032F62;"> get ingress </span><span style="color:#005CC5;">-o</span><span style="color:#032F62;"> yaml</span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#032F62;"> secretName:</span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">awk</span><span style="color:#032F62;"> &#39;{print $2}&#39;</span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">sort</span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">uniq</span><span style="color:#032F62;">)</span><span style="color:#24292E;">;</span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> echo -n </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$i</span><span style="color:#032F62;"> - &quot;</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">secret</span><span style="color:#24292E;"> $i </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;jsonpath={.data[&#39;tls\\.crt&#39;]}&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">base64</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-enddate</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-noout</span><span style="color:#24292E;">;</span><span style="color:#D73A49;">done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#检查所有创建的tls证书的过期时间</span></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">kubectl</span><span style="color:#032F62;"> get secret</span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">awk</span><span style="color:#032F62;"> &#39;/tls/{print $1}&#39;)</span><span style="color:#24292E;">;</span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> echo -n </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$i</span><span style="color:#032F62;"> - &quot;</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">secret</span><span style="color:#24292E;"> $i </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;jsonpath={.data[&#39;tls\\.crt&#39;]}&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">base64</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">openssl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">x509</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-enddate</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-noout</span><span style="color:#24292E;">;</span><span style="color:#D73A49;">done</span></span></code></pre></div><h3 id="备份" tabindex="-1">备份 <a class="header-anchor" href="#备份" aria-label="Permalink to &quot;备份&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">secret</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">java-host-com-tls</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">secret-herlly-cn-https.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">secret</span><span style="color:#24292E;"> </span><span style="color:#032F62;">java-host-com-tls</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yaml</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">secret-herlly-cn-https.yaml</span></span></code></pre></div><h3 id="更新新的证书" tabindex="-1">更新新的证书 <a class="header-anchor" href="#更新新的证书" aria-label="Permalink to &quot;更新新的证书&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#第一种，优雅替换</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl apply -f  </span><span style="color:#9ECBFF;">&lt;(</span><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> create secret tls java-host-com-tls  </span><span style="color:#79B8FF;">--dry-run=client</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">--key=java.key</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">--cert=java.crt</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-oyaml</span><span style="color:#9ECBFF;">)</span></span>
<span class="line"><span style="color:#B392F0;">secret/java-host-com-tls</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">configured</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&lt;(</span><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> create secret tls java-host-com-tls  </span><span style="color:#79B8FF;">--save-config</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">--dry-run=client</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">--key=java.key</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">--cert=java.crt</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-oyaml</span><span style="color:#9ECBFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#第二种</span></span>
<span class="line"><span style="color:#E1E4E8;">TLS_KEY</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">base64</span><span style="color:#9ECBFF;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;"> &quot;./tls.key&quot; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">tr</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#9ECBFF;"> &#39;\\n&#39;)</span></span>
<span class="line"><span style="color:#E1E4E8;">TLS_CRT</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">base64</span><span style="color:#9ECBFF;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;"> &quot;./tls.crt&quot; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">tr</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#9ECBFF;"> &#39;\\n&#39;)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">secrets</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tls-rancher-ingress</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">json</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">jq</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;.data[&quot;tls.key&quot;] |= &quot;$TLS_KEY&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">jq</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;.data[&quot;tls.crt&quot;] |= &quot;$TLS_CRT&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#第一种，优雅替换</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl apply -f  </span><span style="color:#032F62;">&lt;(</span><span style="color:#6F42C1;">kubectl</span><span style="color:#032F62;"> create secret tls java-host-com-tls  </span><span style="color:#005CC5;">--dry-run=client</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">--key=java.key</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">--cert=java.crt</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-oyaml</span><span style="color:#032F62;">)</span></span>
<span class="line"><span style="color:#6F42C1;">secret/java-host-com-tls</span><span style="color:#24292E;"> </span><span style="color:#032F62;">configured</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;">  </span><span style="color:#032F62;">&lt;(</span><span style="color:#6F42C1;">kubectl</span><span style="color:#032F62;"> create secret tls java-host-com-tls  </span><span style="color:#005CC5;">--save-config</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">--dry-run=client</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">--key=java.key</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">--cert=java.crt</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-oyaml</span><span style="color:#032F62;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#第二种</span></span>
<span class="line"><span style="color:#24292E;">TLS_KEY</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">base64</span><span style="color:#032F62;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;"> &quot;./tls.key&quot; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">tr</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-d</span><span style="color:#032F62;"> &#39;\\n&#39;)</span></span>
<span class="line"><span style="color:#24292E;">TLS_CRT</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">base64</span><span style="color:#032F62;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;"> &quot;./tls.crt&quot; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">tr</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-d</span><span style="color:#032F62;"> &#39;\\n&#39;)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">secrets</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tls-rancher-ingress</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">json</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">jq</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;.data[&quot;tls.key&quot;] |= &quot;$TLS_KEY&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">jq</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;.data[&quot;tls.crt&quot;] |= &quot;$TLS_CRT&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span></span></code></pre></div><h3 id="回滚" tabindex="-1">回滚 <a class="header-anchor" href="#回滚" aria-label="Permalink to &quot;回滚&quot;">​</a></h3><p>验证有问题，先恢复旧证书，问题解决后，再重新执行替换操作，重新验证。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">secret-herlly-cn-https.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">secret-herlly-cn-https.yaml</span></span></code></pre></div><h2 id="_3-5-配置ssl" tabindex="-1">3.5 配置ssl <a class="header-anchor" href="#_3-5-配置ssl" aria-label="Permalink to &quot;3.5 配置ssl&quot;">​</a></h2><p><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#ssl-protocols" target="_blank" rel="noreferrer">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#ssl-protocols</a></p><blockquote><p>ingress-nginx 默认使用 <code>TLSv1.2 TLSv1.3</code></p></blockquote><h1 id="_4-ingress-rewrite" tabindex="-1">4. Ingress Rewrite <a class="header-anchor" href="#_4-ingress-rewrite" aria-label="Permalink to &quot;4. Ingress Rewrite&quot;">​</a></h1><p><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/" target="_blank" rel="noreferrer">官方文档nginx-config</a></p><p>官方案例，<a href="https://kubernetes.github.io/ingress-nginx/examples/rewrite/" target="_blank" rel="noreferrer">https://kubernetes.github.io/ingress-nginx/examples/rewrite/</a></p><p><strong>rewrite</strong> 可以使用下面的 <strong>anntations</strong> 进行控制：</p><table><thead><tr><th>名称</th><th>描述</th><th>值</th></tr></thead><tbody><tr><td>nginx.ingress.kubernetes.io/rewrite-target</td><td>将匹配到的url重定向到rewrite-target 注解指定路径</td><td>string</td></tr><tr><td>nginx.ingress.kubernetes.io/ssl-redirect</td><td>表示位置部分是否可访问SSL(当lngress包含证书时默认为True)</td><td>bool</td></tr><tr><td>nginx.ingress.kubernetes.io/force-ssl-redirect</td><td>强制重定向到HTTPS，即使入口没有启用TLS</td><td>bool</td></tr><tr><td>nginx.ingress.kubernetes.io/app-root</td><td>访问主域名的时候会自动跳转到app-root 注解指定的路径</td><td>string</td></tr><tr><td>nginx.ingress.kubernetes.io/use-regex</td><td>表示Ingress上定义的路径是否使用正则表达式bool</td><td>bool</td></tr></tbody></table><h2 id="_4-1-匹配-java" tabindex="-1">4.1 匹配/java <a class="header-anchor" href="#_4-1-匹配-java" aria-label="Permalink to &quot;4.1 匹配/java&quot;">​</a></h2><p>类似和nginx中proxy_pass</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat ingress-app-java.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">foo-ingress</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/proxy-read-timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;600&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/proxy-send-timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;600&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/$2</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 配置Rewrite规则</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">foo.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/java(/|$)(.*)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat ingress-app-java.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">foo-ingress</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/proxy-read-timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;600&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/proxy-send-timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;600&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/$2</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 配置Rewrite规则</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">foo.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/java(/|$)(.*)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><h2 id="_4-2-自定义跳转" tabindex="-1">4.2 自定义跳转 <a class="header-anchor" href="#_4-2-自定义跳转" aria-label="Permalink to &quot;4.2 自定义跳转&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-domain</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/$2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/manager/(.*)$ /java/manager/$1 redirect;</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/host-manager/(.*)$ /java/host-manager/$1 redirect;</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/docs/(.*)$ /java/docs/$1 redirect;</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tls</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">secretName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java-host-com-tls</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/java(/|$)(.*)&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-domain</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/$2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/manager/(.*)$ /java/manager/$1 redirect;</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/host-manager/(.*)$ /java/host-manager/$1 redirect;</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/docs/(.*)$ /java/docs/$1 redirect;</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tls</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">secretName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java-host-com-tls</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/java(/|$)(.*)&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><h2 id="_4-3-新老域名交替" tabindex="-1">4.3 新老域名交替 <a class="header-anchor" href="#_4-3-新老域名交替" aria-label="Permalink to &quot;4.3 新老域名交替&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat ingress-nginx-whitelist.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-domain</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/permanent-redirect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;https://www.baidu.com&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/use-regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/$2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/manager/(.*)$ /java/manager/$1 redirect;</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/host-manager/(.*)$ /java/host-manager/$1 redirect;</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/docs/(.*)$ /java/docs/$1 redirect;</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tls</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">secretName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java-host-com-tls</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/java(/|$)(.*)&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat ingress-nginx-whitelist.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-domain</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/permanent-redirect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;https://www.baidu.com&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/use-regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/$2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/manager/(.*)$ /java/manager/$1 redirect;</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/host-manager/(.*)$ /java/host-manager/$1 redirect;</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/docs/(.*)$ /java/docs/$1 redirect;</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tls</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">secretName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java-host-com-tls</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/java(/|$)(.*)&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">💡 说明</p><p>nginx.ingress.kubernetes.io/permanent-redirect: &quot;<a href="https://www.baidu.com" target="_blank" rel="noreferrer">https://www.baidu.com</a>&quot;</p><p>的上协议，否则会出现重定向次数过多（因域名如果也做了跳转）</p></div><h1 id="_5-ingress自定义页面" tabindex="-1">5. Ingress自定义页面 <a class="header-anchor" href="#_5-ingress自定义页面" aria-label="Permalink to &quot;5. Ingress自定义页面&quot;">​</a></h1><h2 id="_5-1-默认自带" tabindex="-1">5.1 默认自带 <a class="header-anchor" href="#_5-1-默认自带" aria-label="Permalink to &quot;5.1 默认自带&quot;">​</a></h2><h3 id="创建yaml文件" tabindex="-1">创建yaml文件 <a class="header-anchor" href="#创建yaml文件" aria-label="Permalink to &quot;创建yaml文件&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat nginx-error.yaml</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-errors</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app.kubernetes.io/name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-errors</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app.kubernetes.io/part-of</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app.kubernetes.io/name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-errors</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app.kubernetes.io/part-of</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-errors</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app.kubernetes.io/name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-errors</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app.kubernetes.io/part-of</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app.kubernetes.io/name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-errors</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app.kubernetes.io/part-of</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app.kubernetes.io/name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-errors</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app.kubernetes.io/part-of</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-error-server</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/nginx-error:v1</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># Setting the environment variable DEBUG we can see the headers sent</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># by the ingress controller to the backend in the client response.</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># env:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># - name: DEBUG</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">#   value: &quot;true&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat nginx-error.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-errors</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app.kubernetes.io/name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-errors</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app.kubernetes.io/part-of</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app.kubernetes.io/name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-errors</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app.kubernetes.io/part-of</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-errors</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app.kubernetes.io/name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-errors</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app.kubernetes.io/part-of</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app.kubernetes.io/name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-errors</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app.kubernetes.io/part-of</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app.kubernetes.io/name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-errors</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app.kubernetes.io/part-of</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-error-server</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/nginx-error:v1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># Setting the environment variable DEBUG we can see the headers sent</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># by the ingress controller to the backend in the client response.</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># env:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># - name: DEBUG</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">#   value: &quot;true&quot;</span></span></code></pre></div><h3 id="执行" tabindex="-1">执行 <a class="header-anchor" href="#执行" aria-label="Permalink to &quot;执行&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nginx-error.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx-error.yaml</span></span></code></pre></div><h3 id="查看" tabindex="-1">查看 <a class="header-anchor" href="#查看" aria-label="Permalink to &quot;查看&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get pod,svc -n ingress-nginx</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                       </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">pod/nginx-errors-7b878fb7fb-9kjrm</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">24</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                         </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">CLUSTER-IP</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">EXTERNAL-IP</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">PORT</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">S</span><span style="color:#E1E4E8;">)                      </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#E1E4E8;">                     </span><span style="color:#B392F0;">45h</span></span>
<span class="line"><span style="color:#B392F0;">service/nginx-errors</span><span style="color:#E1E4E8;">                         </span><span style="color:#9ECBFF;">ClusterIP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.207.125</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">/TCP</span><span style="color:#E1E4E8;">                       </span><span style="color:#79B8FF;">24</span><span style="color:#9ECBFF;">m</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get pod,svc -n ingress-nginx</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                       </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">      </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pod/nginx-errors-7b878fb7fb-9kjrm</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">24</span><span style="color:#032F62;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                         </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">        </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">        </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)                      </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#24292E;">                     </span><span style="color:#6F42C1;">45h</span></span>
<span class="line"><span style="color:#6F42C1;">service/nginx-errors</span><span style="color:#24292E;">                         </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.207.125</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">                       </span><span style="color:#005CC5;">24</span><span style="color:#032F62;">m</span></span></code></pre></div><h3 id="修改configmap" tabindex="-1">修改configmap <a class="header-anchor" href="#修改configmap" aria-label="Permalink to &quot;修改configmap&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看有哪些configmap</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get configmaps  -n ingress-nginx</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                       </span><span style="color:#9ECBFF;">DATA</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">ingress-nginx-controller</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">45</span><span style="color:#9ECBFF;">h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl edit configmaps ingress-nginx-controller -n ingress-nginx</span></span>
<span class="line"><span style="color:#B392F0;">apiVersion:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#B392F0;">data:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">allow-snippet-annotations:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">custom-http-errors:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;403,404,500,503&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#添加此行</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看有哪些configmap</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get configmaps  -n ingress-nginx</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                       </span><span style="color:#032F62;">DATA</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-nginx-controller</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">45</span><span style="color:#032F62;">h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl edit configmaps ingress-nginx-controller -n ingress-nginx</span></span>
<span class="line"><span style="color:#6F42C1;">apiVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#6F42C1;">data:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">allow-snippet-annotations:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">custom-http-errors:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;403,404,500,503&quot;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#添加此行</span></span></code></pre></div><h3 id="配置启动参数" tabindex="-1">配置启动参数 <a class="header-anchor" href="#配置启动参数" aria-label="Permalink to &quot;配置启动参数&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl edit ds ingress-nginx-controller  -n ingress-nginx</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">spec:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">containers:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">args:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/nginx-ingress-controller</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--publish-service=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">POD_NAMESPACE</span><span style="color:#9ECBFF;">)</span><span style="color:#79B8FF;">/ingress-nginx-controller</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--election-id=ingress-controller-leader</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--controller-class=k8s.io/ingress-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--ingress-class=nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--configmap=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">POD_NAMESPACE</span><span style="color:#9ECBFF;">)</span><span style="color:#79B8FF;">/ingress-nginx-controller</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--validating-webhook=:8443</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--validating-webhook-certificate=/usr/local/certificates/cert</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--validating-webhook-key=/usr/local/certificates/key</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--default-backend-service=ingress-nginx/nginx-errors</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 添加此行</span></span>
<span class="line"><span style="color:#79B8FF;">...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl edit ds ingress-nginx-controller  -n ingress-nginx</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">spec:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">containers:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">args:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/nginx-ingress-controller</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--publish-service=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">POD_NAMESPACE</span><span style="color:#032F62;">)</span><span style="color:#005CC5;">/ingress-nginx-controller</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--election-id=ingress-controller-leader</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--controller-class=k8s.io/ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--ingress-class=nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--configmap=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">POD_NAMESPACE</span><span style="color:#032F62;">)</span><span style="color:#005CC5;">/ingress-nginx-controller</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--validating-webhook=:8443</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--validating-webhook-certificate=/usr/local/certificates/cert</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--validating-webhook-key=/usr/local/certificates/key</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--default-backend-service=ingress-nginx/nginx-errors</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 添加此行</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span></code></pre></div><ul><li>测试效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405221411088.png" alt="image-20240522141059026"></p><h2 id="_5-2-定制自定义错误页面" tabindex="-1">5.2 定制自定义错误页面 <a class="header-anchor" href="#_5-2-定制自定义错误页面" aria-label="Permalink to &quot;5.2 定制自定义错误页面&quot;">​</a></h2><h3 id="创建yaml" tabindex="-1">创建yaml <a class="header-anchor" href="#创建yaml" aria-label="Permalink to &quot;创建yaml&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat custom-nginx-error.yaml</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">custom-nginx-errors</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app.kubernetes.io/name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">custom-nginx-errors</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app.kubernetes.io/part-of</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app.kubernetes.io/name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">custom-nginx-errors</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app.kubernetes.io/part-of</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">custom-nginx-errors</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app.kubernetes.io/name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">custom-nginx-errors</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app.kubernetes.io/part-of</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app.kubernetes.io/name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">custom-nginx-errors</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app.kubernetes.io/part-of</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app.kubernetes.io/name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">custom-nginx-errors</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app.kubernetes.io/part-of</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">custom-nginx-errors</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/nginx-error:v2</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># Setting the environment variable DEBUG we can see the headers sent</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># by the ingress controller to the backend in the client response.</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># env:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># - name: DEBUG</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">#   value: &quot;true&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat custom-nginx-error.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">custom-nginx-errors</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app.kubernetes.io/name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">custom-nginx-errors</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app.kubernetes.io/part-of</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app.kubernetes.io/name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">custom-nginx-errors</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app.kubernetes.io/part-of</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">custom-nginx-errors</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app.kubernetes.io/name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">custom-nginx-errors</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app.kubernetes.io/part-of</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app.kubernetes.io/name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">custom-nginx-errors</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app.kubernetes.io/part-of</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app.kubernetes.io/name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">custom-nginx-errors</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app.kubernetes.io/part-of</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">custom-nginx-errors</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/nginx-error:v2</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># Setting the environment variable DEBUG we can see the headers sent</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># by the ingress controller to the backend in the client response.</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># env:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># - name: DEBUG</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">#   value: &quot;true&quot;</span></span></code></pre></div><h3 id="执行-1" tabindex="-1">执行 <a class="header-anchor" href="#执行-1" aria-label="Permalink to &quot;执行&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">custom-nginx-error.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">custom-nginx-error.yaml</span></span></code></pre></div><h3 id="查看-1" tabindex="-1">查看 <a class="header-anchor" href="#查看-1" aria-label="Permalink to &quot;查看&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get pod,svc,ds -n ingress-nginx</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                       </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">pod/custom-nginx-errors-6df8ddcc64-tprjh</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">18</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                         </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">CLUSTER-IP</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">EXTERNAL-IP</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">PORT</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">S</span><span style="color:#E1E4E8;">)                      </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">service/custom-nginx-errors</span><span style="color:#E1E4E8;">                  </span><span style="color:#9ECBFF;">ClusterIP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.139.222</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">/TCP</span><span style="color:#E1E4E8;">                       </span><span style="color:#79B8FF;">18</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                      </span><span style="color:#9ECBFF;">DESIRED</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">CURRENT</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">UP-TO-DATE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AVAILABLE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">SELECTOR</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">daemonset.apps/ingress-nginx-controller</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">kubernetes.io/os=linux,node-role=ingress</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">45</span><span style="color:#9ECBFF;">h</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get pod,svc,ds -n ingress-nginx</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                       </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">      </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pod/custom-nginx-errors-6df8ddcc64-tprjh</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">18</span><span style="color:#032F62;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                         </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">        </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">        </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)                      </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">service/custom-nginx-errors</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.139.222</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">                       </span><span style="color:#005CC5;">18</span><span style="color:#032F62;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                      </span><span style="color:#032F62;">DESIRED</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CURRENT</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">UP-TO-DATE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AVAILABLE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">SELECTOR</span><span style="color:#24292E;">    </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">daemonset.apps/ingress-nginx-controller</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">           </span><span style="color:#032F62;">kubernetes.io/os=linux,node-role=ingress</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">45</span><span style="color:#032F62;">h</span></span></code></pre></div><h3 id="修改configmap-1" tabindex="-1">修改configmap <a class="header-anchor" href="#修改configmap-1" aria-label="Permalink to &quot;修改configmap&quot;">​</a></h3><p>参考5.1</p><h3 id="配置启动参数-1" tabindex="-1">配置启动参数 <a class="header-anchor" href="#配置启动参数-1" aria-label="Permalink to &quot;配置启动参数&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]#  kubectl edit ds ingress-nginx-controller  -n ingress-nginx</span></span>
<span class="line"><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">args:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/nginx-ingress-controller</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--publish-service=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">POD_NAMESPACE</span><span style="color:#9ECBFF;">)</span><span style="color:#79B8FF;">/ingress-nginx-controller</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--election-id=ingress-controller-leader</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--controller-class=k8s.io/ingress-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--ingress-class=nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--configmap=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">POD_NAMESPACE</span><span style="color:#9ECBFF;">)</span><span style="color:#79B8FF;">/ingress-nginx-controller</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--validating-webhook=:8443</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--validating-webhook-certificate=/usr/local/certificates/cert</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--validating-webhook-key=/usr/local/certificates/key</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--default-backend-service=ingress-nginx/custom-nginx-errors</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#修改此处</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]#  kubectl edit ds ingress-nginx-controller  -n ingress-nginx</span></span>
<span class="line"><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">args:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/nginx-ingress-controller</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--publish-service=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">POD_NAMESPACE</span><span style="color:#032F62;">)</span><span style="color:#005CC5;">/ingress-nginx-controller</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--election-id=ingress-controller-leader</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--controller-class=k8s.io/ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--ingress-class=nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--configmap=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">POD_NAMESPACE</span><span style="color:#032F62;">)</span><span style="color:#005CC5;">/ingress-nginx-controller</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--validating-webhook=:8443</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--validating-webhook-certificate=/usr/local/certificates/cert</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--validating-webhook-key=/usr/local/certificates/key</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--default-backend-service=ingress-nginx/custom-nginx-errors</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#修改此处</span></span></code></pre></div><ul><li>测试效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405221448715.png" alt="image-20240522144812526"></p><h1 id="_6-ingress自定义日志格式" tabindex="-1">6. Ingress自定义日志格式 <a class="header-anchor" href="#_6-ingress自定义日志格式" aria-label="Permalink to &quot;6. Ingress自定义日志格式&quot;">​</a></h1><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">my-ingress</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/enable-access-log</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/access-log-format</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; $status $body_bytes_sent &quot;$http_referer&quot; &quot;$http_user_agent&quot;&#39;</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">my-ingress</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/enable-access-log</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/access-log-format</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; $status $body_bytes_sent &quot;$http_referer&quot; &quot;$http_user_agent&quot;&#39;</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span></code></pre></div><h1 id="_7-ingress客户端真实ip" tabindex="-1">7. Ingress客户端真实IP <a class="header-anchor" href="#_7-ingress客户端真实ip" aria-label="Permalink to &quot;7. Ingress客户端真实IP&quot;">​</a></h1><ul><li>第一种</li></ul><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">edit</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">configmaps</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ingress-nginx-controller</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">apiVersion:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#B392F0;">data:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">use-forwarded-headers:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">compute-full-forwarded-for:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">edit</span><span style="color:#24292E;"> </span><span style="color:#032F62;">configmaps</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ingress-nginx-controller</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">apiVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#6F42C1;">data:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">use-forwarded-headers:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">compute-full-forwarded-for:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;true&quot;</span></span></code></pre></div><ul><li>第二种</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">apiVersion:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#B392F0;">data:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">http-snippet:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">real_ip_header</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">X-Forwarded-For</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">apiVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#6F42C1;">data:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">http-snippet:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">real_ip_header</span><span style="color:#24292E;"> </span><span style="color:#032F62;">X-Forwarded-For</span><span style="color:#24292E;">;</span></span></code></pre></div><ul><li>创建yaml</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat echoserver-ingress.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">echoserver</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">echoserver</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">echoserver</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">echoserver</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">echoserver</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/echoserver:latest</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">env</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NODE_NAME</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">valueFrom</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">fieldRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">fieldPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">spec.nodeName</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">POD_NAME</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">valueFrom</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">fieldRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">fieldPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metadata.name</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">POD_NAMESPACE</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">valueFrom</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">fieldRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">fieldPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metadata.namespace</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">POD_IP</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">valueFrom</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">fieldRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">fieldPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">status.podIP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">echoserver</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">echoserver</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">8080</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">echoserver</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">echoserver</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">echo.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">echoserver</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat echoserver-ingress.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">echoserver</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">echoserver</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">echoserver</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">echoserver</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">echoserver</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/echoserver:latest</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">env</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NODE_NAME</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">valueFrom</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">fieldRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">fieldPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">spec.nodeName</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">POD_NAME</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">valueFrom</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">fieldRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">fieldPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metadata.name</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">POD_NAMESPACE</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">valueFrom</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">fieldRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">fieldPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metadata.namespace</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">POD_IP</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">valueFrom</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">fieldRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">fieldPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">status.podIP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">echoserver</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">echoserver</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">8080</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">echoserver</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">echoserver</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">echo.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">echoserver</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><h2 id="_7-1-配置" tabindex="-1">7.1 配置 <a class="header-anchor" href="#_7-1-配置" aria-label="Permalink to &quot;7.1 配置&quot;">​</a></h2><p><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#proxy-real-ip-cidr" target="_blank" rel="noreferrer">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#proxy-real-ip-cidr</a></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">data</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#realip</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">compute-full-forwarded-for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;true&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">enable-real-ip</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;true&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">enable-underscores-in-headers</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;true&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">forwarded-for-header</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">X_FORWARDED_FOR</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">proxy-real-ip-cidr</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">192.168.10.1/24,10.41.40.21/28,172.20.0.0/16</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#根据自己的网络进行修改</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">proxy-set-headers</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">X_FORWARDED_FOR</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">use-forwarded-headers</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;true&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">data</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">#realip</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">compute-full-forwarded-for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;true&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">enable-real-ip</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;true&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">enable-underscores-in-headers</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;true&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">forwarded-for-header</span><span style="color:#24292E;">: </span><span style="color:#032F62;">X_FORWARDED_FOR</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">proxy-real-ip-cidr</span><span style="color:#24292E;">: </span><span style="color:#032F62;">192.168.10.1/24,10.41.40.21/28,172.20.0.0/16</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#根据自己的网络进行修改</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">proxy-set-headers</span><span style="color:#24292E;">: </span><span style="color:#032F62;">X_FORWARDED_FOR</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">use-forwarded-headers</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;true&#39;</span></span></code></pre></div><p><strong>参数解析:</strong></p><ol><li><code>enable-underscores-in-headers</code>: 是否在标题名称中启用下划线, 缺省默认为off，表示如果请求中<code>header name</code> 中包含下划线，则忽略掉不会传递到后端代理或者应用程序，即获取不到该Header，所以此处为了不丢弃A10传递过来的 <code>X_FORWARDED_FOR</code> Header 需要将该参数设置为True。</li><li><code>use-forwarded-headers</code>: 如果设置为True时，则将设定的<code>X-Forwarded-*</code> Header传递给后端, 当Ingress在<code>L7 代理/负载均衡器</code>之后使用此选项。 如果设置为 false 时，则会忽略传入的<code>X-Forwarded-*</code>Header, 当 Ingress 直接暴露在互联网或者 L3/数据包的<a href="https://cloud.tencent.com/product/clb?from_column=20065&amp;from=20065" target="_blank" rel="noreferrer">负载均衡器</a>后面,并且不会更改数据包中的源 IP请使用此选项。</li><li><code>forwarded-for-header</code>: 设置用于标识客户端的原始 IP 地址的 Header 字段。默认值<code>X-Forwarded-For</code>，此处由于A10带入的是自定义记录IP的Header,所以此处填入是<code>X_FORWARDED_FOR</code>.</li><li><code>compute-full-forwarded-for</code>: 将 remote address 附加到 X-Forwarded-For Header而不是替换它。当启用此选项后端应用程序负责根据自己的受信任代理列表排除并提取客户端 IP。</li><li><code>proxy-real-ip-cidr</code>: 如果启用 <code>use-forwarded-headers</code> 或 <code>use-proxy-protocol</code>，则可以使用该参数其定义了外部负载衡器 、网络代理、CDN等地址，多个地址可以以逗号分隔的 CIDR 。默认值: “0.0.0.0/0”</li></ol><p>上述参数配置后在<code>ingress-nginx-control</code>中的<code>/etc/nginx/nginx.conf</code>结果如下:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># use-forwarded-headers 参数设置后</span></span>
<span class="line"><span style="color:#B392F0;">real_ip_header</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">X_FORWARDED_FOR</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#B392F0;">real_ip_recursive</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#B392F0;">set_real_ip_from</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.10.11</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#B392F0;">set_real_ip_from</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.4.11</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># We can&#39;t use $proxy_add_x_forwarded_for because the realip module replaces the remote_addr too soon</span></span>
<span class="line"><span style="color:#6A737D;"># 我们不能使用 \`$proxy_add_x_forwarded_for\`, 因为 realip 模块过早地替换了远程 remote_addr。</span></span>
<span class="line"><span style="color:#B392F0;">map</span><span style="color:#E1E4E8;"> $http_x_forwarded_for $full_x_forwarded_for </span><span style="color:#9ECBFF;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">default</span><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$http_x_forwarded_for</span><span style="color:#9ECBFF;">, </span><span style="color:#E1E4E8;">$realip_remote_addr</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">&#39;&#39;</span><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">$realip_remote_addr</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># use-forwarded-headers 参数设置后</span></span>
<span class="line"><span style="color:#6F42C1;">real_ip_header</span><span style="color:#24292E;">      </span><span style="color:#032F62;">X_FORWARDED_FOR</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#6F42C1;">real_ip_recursive</span><span style="color:#24292E;">   </span><span style="color:#032F62;">on</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#6F42C1;">set_real_ip_from</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.10.11</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#6F42C1;">set_real_ip_from</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.4.11</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># We can&#39;t use $proxy_add_x_forwarded_for because the realip module replaces the remote_addr too soon</span></span>
<span class="line"><span style="color:#6A737D;"># 我们不能使用 \`$proxy_add_x_forwarded_for\`, 因为 realip 模块过早地替换了远程 remote_addr。</span></span>
<span class="line"><span style="color:#6F42C1;">map</span><span style="color:#24292E;"> $http_x_forwarded_for $full_x_forwarded_for </span><span style="color:#032F62;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">default</span><span style="color:#24292E;">          </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$http_x_forwarded_for</span><span style="color:#032F62;">, </span><span style="color:#24292E;">$realip_remote_addr</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">&#39;&#39;</span><span style="color:#24292E;">               </span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">$realip_remote_addr</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li>logformat配置</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># /etc/nginx/nginx.conf</span></span>
<span class="line"><span style="color:#B392F0;">log_format</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">main</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; - &quot;$http_X_FORWARDED_FOR&quot; - &quot;$http_X_Real_IP&quot;&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#6A737D;"># 输出结果 &quot;10.41.40.22&quot; -- &quot;10.41.40.22&quot; --  &quot;10.20.172.103&quot;  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">proxy_set_header</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">X-Real-IP</span><span style="color:#E1E4E8;">              $remote_addr;   </span><span style="color:#6A737D;"># realip 模块 已经将 X_FORWARDED_FOR 字段赋值给 $remote_addr, 所以该字段也记录了真实IP.</span></span>
<span class="line"><span style="color:#B392F0;">proxy_set_header</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">X-Forwarded-For</span><span style="color:#E1E4E8;">        $full_x_forwarded_for;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># /etc/nginx/nginx.conf</span></span>
<span class="line"><span style="color:#6F42C1;">log_format</span><span style="color:#24292E;">  </span><span style="color:#032F62;">main</span><span style="color:#24292E;">  </span><span style="color:#032F62;">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; - &quot;$http_X_FORWARDED_FOR&quot; - &quot;$http_X_Real_IP&quot;&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#6A737D;"># 输出结果 &quot;10.41.40.22&quot; -- &quot;10.41.40.22&quot; --  &quot;10.20.172.103&quot;  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">proxy_set_header</span><span style="color:#24292E;"> </span><span style="color:#032F62;">X-Real-IP</span><span style="color:#24292E;">              $remote_addr;   </span><span style="color:#6A737D;"># realip 模块 已经将 X_FORWARDED_FOR 字段赋值给 $remote_addr, 所以该字段也记录了真实IP.</span></span>
<span class="line"><span style="color:#6F42C1;">proxy_set_header</span><span style="color:#24292E;"> </span><span style="color:#032F62;">X-Forwarded-For</span><span style="color:#24292E;">        $full_x_forwarded_for;</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">tcpdump</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-nnX</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">port</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-vv</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-w</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">test.pcap</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">tcpdump</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-nnX</span><span style="color:#24292E;"> </span><span style="color:#032F62;">port</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-vv</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-w</span><span style="color:#24292E;"> </span><span style="color:#032F62;">test.pcap</span></span></code></pre></div><h1 id="_8-ingress黑白名单" tabindex="-1">8. Ingress黑白名单 <a class="header-anchor" href="#_8-ingress黑白名单" aria-label="Permalink to &quot;8. Ingress黑白名单&quot;">​</a></h1><div class="warning custom-block"><p class="custom-block-title">💡 说明</p><p>Annotations：只对指定svc的lngress生效;</p><p>ConfigMap：全局生效;</p><p>黑名单可以使用ConfigMap去配置，白名单建议使用Annotations去配置。</p><ul><li>名单是默认是拒绝所有，只允许一个地址去访问;</li><li>黑名单是不允许该地址去访问所有;</li></ul><p>若是同时配置了Annotations和configmap，一般都是annotations生效,configmap不生效，因为annotations优先级比configmap高;</p></div><p>官方文档，<a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#whitelist-source-range" target="_blank" rel="noreferrer">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#whitelist-source-range</a></p><h2 id="_8-1-白名单" tabindex="-1">8.1 白名单 <a class="header-anchor" href="#_8-1-白名单" aria-label="Permalink to &quot;8.1 白名单&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat ingress-nginx-whitelist.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-domain</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/ssl-redirect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;false&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/use-regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/$2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/manager/(.*)$ /java/manager/$1 redirect;</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/host-manager/(.*)$ /java/host-manager/$1 redirect;</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/docs/(.*)$ /java/docs/$1 redirect;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/whitelist-source-range</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10.103.236.204</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tls</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">secretName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java-host-com-tls</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/java(/|$)(.*)&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat ingress-nginx-whitelist.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-domain</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/ssl-redirect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;false&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/use-regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/$2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/manager/(.*)$ /java/manager/$1 redirect;</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/host-manager/(.*)$ /java/host-manager/$1 redirect;</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/docs/(.*)$ /java/docs/$1 redirect;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/whitelist-source-range</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10.103.236.204</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tls</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">secretName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java-host-com-tls</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/java(/|$)(.*)&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><blockquote><p>多个ip用逗号隔开</p></blockquote><ul><li>测试效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405231504470.png" alt="image-20240523144533008"></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#其他机器</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# curl -I -k -H </span><span style="color:#9ECBFF;">&quot;Host:java.host.com&quot;</span><span style="color:#E1E4E8;"> 10.103.236.202/java/index.jsp</span></span>
<span class="line"><span style="color:#B392F0;">HTTP/1.1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">403</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Forbidden</span></span>
<span class="line"><span style="color:#B392F0;">Date:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Thu,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">23</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">May</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2024</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">06</span><span style="color:#9ECBFF;">:46:07</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GMT</span></span>
<span class="line"><span style="color:#B392F0;">Content-Type:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">text/html</span></span>
<span class="line"><span style="color:#B392F0;">Content-Length:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">107786</span></span>
<span class="line"><span style="color:#B392F0;">Connection:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">keep-alive</span></span>
<span class="line"><span style="color:#B392F0;">Vary:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Accept-Encoding</span></span>
<span class="line"><span style="color:#B392F0;">ETag:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;5fd9999d-1a50a&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#其他机器</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master ingress]# curl -I -k -H </span><span style="color:#032F62;">&quot;Host:java.host.com&quot;</span><span style="color:#24292E;"> 10.103.236.202/java/index.jsp</span></span>
<span class="line"><span style="color:#6F42C1;">HTTP/1.1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">403</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Forbidden</span></span>
<span class="line"><span style="color:#6F42C1;">Date:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Thu,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">23</span><span style="color:#24292E;"> </span><span style="color:#032F62;">May</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2024</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">06</span><span style="color:#032F62;">:46:07</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GMT</span></span>
<span class="line"><span style="color:#6F42C1;">Content-Type:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">text/html</span></span>
<span class="line"><span style="color:#6F42C1;">Content-Length:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">107786</span></span>
<span class="line"><span style="color:#6F42C1;">Connection:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">keep-alive</span></span>
<span class="line"><span style="color:#6F42C1;">Vary:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Accept-Encoding</span></span>
<span class="line"><span style="color:#6F42C1;">ETag:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;5fd9999d-1a50a&quot;</span></span></code></pre></div><h2 id="_8-2-黑名单" tabindex="-1">8.2 黑名单 <a class="header-anchor" href="#_8-2-黑名单" aria-label="Permalink to &quot;8.2 黑名单&quot;">​</a></h2><h3 id="全局上面配置" tabindex="-1">全局上面配置 <a class="header-anchor" href="#全局上面配置" aria-label="Permalink to &quot;全局上面配置&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get configmaps -n ingress-nginx</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                       </span><span style="color:#9ECBFF;">DATA</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">ingress-nginx-controller</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">d21h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#编辑</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl edit configmaps ingress-nginx-controller -n ingress-nginx</span></span>
<span class="line"><span style="color:#B392F0;">apiVersion:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#B392F0;">data:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">block-cidrs:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.1.11</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get configmaps -n ingress-nginx</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                       </span><span style="color:#032F62;">DATA</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-nginx-controller</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">d21h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#编辑</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl edit configmaps ingress-nginx-controller -n ingress-nginx</span></span>
<span class="line"><span style="color:#6F42C1;">apiVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#6F42C1;">data:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">block-cidrs:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.1.11</span></span></code></pre></div><h3 id="annotations" tabindex="-1">annotations <a class="header-anchor" href="#annotations" aria-label="Permalink to &quot;annotations&quot;">​</a></h3><ul><li>创建</li></ul><p>nginx.ingress.kubernetes.io/server-snippet:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat ingress-nginx-blackList.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-domain</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/ssl-redirect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;false&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/use-regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/$2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/manager/(.*)$ /java/manager/$1 redirect;</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/host-manager/(.*)$ /java/host-manager/$1 redirect;</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/docs/(.*)$ /java/docs/$1 redirect;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/server-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">      deny 10.103.236.203;</span></span>
<span class="line"><span style="color:#9ECBFF;">      allow all;</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tls</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">secretName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java-host-com-tls</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/java(/|$)(.*)&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat ingress-nginx-blackList.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-domain</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/ssl-redirect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;false&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/use-regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/$2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/manager/(.*)$ /java/manager/$1 redirect;</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/host-manager/(.*)$ /java/host-manager/$1 redirect;</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/docs/(.*)$ /java/docs/$1 redirect;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/server-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">      deny 10.103.236.203;</span></span>
<span class="line"><span style="color:#032F62;">      allow all;</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tls</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">secretName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java-host-com-tls</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/java(/|$)(.*)&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><ul><li><p>执行apply</p></li><li><p>验证效果</p></li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405231455040.png" alt="image-20240523145537815"></p><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>同理annotations也能在白名单上面配置</p></div><h1 id="_9-ingress基本认证" tabindex="-1">9. Ingress基本认证 <a class="header-anchor" href="#_9-ingress基本认证" aria-label="Permalink to &quot;9. Ingress基本认证&quot;">​</a></h1><h2 id="_9-1-创建nginx认证用户" tabindex="-1">9.1 创建nginx认证用户 <a class="header-anchor" href="#_9-1-创建nginx认证用户" aria-label="Permalink to &quot;9.1 创建nginx认证用户&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">## 用http的命令工具来生成</span></span>
<span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">httpd-tools</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#创建用户</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# htpasswd -c auth admin</span></span>
<span class="line"><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">password:</span></span>
<span class="line"><span style="color:#B392F0;">Re-type</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">password:</span></span>
<span class="line"><span style="color:#B392F0;">Adding</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">password</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">user</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">admin</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看密文</span></span>
<span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">auth</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">## 用http的命令工具来生成</span></span>
<span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">httpd-tools</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#创建用户</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master ingress]# htpasswd -c auth admin</span></span>
<span class="line"><span style="color:#6F42C1;">New</span><span style="color:#24292E;"> </span><span style="color:#032F62;">password:</span></span>
<span class="line"><span style="color:#6F42C1;">Re-type</span><span style="color:#24292E;"> </span><span style="color:#032F62;">new</span><span style="color:#24292E;"> </span><span style="color:#032F62;">password:</span></span>
<span class="line"><span style="color:#6F42C1;">Adding</span><span style="color:#24292E;"> </span><span style="color:#032F62;">password</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">user</span><span style="color:#24292E;"> </span><span style="color:#032F62;">admin</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 查看密文</span></span>
<span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">auth</span></span></code></pre></div><h3 id="新增用户" tabindex="-1">新增用户 <a class="header-anchor" href="#新增用户" aria-label="Permalink to &quot;新增用户&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# htpasswd -b auth username password</span></span>
<span class="line"><span style="color:#B392F0;">Adding</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">password</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">user</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">admin</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# htpasswd -b auth username password</span></span>
<span class="line"><span style="color:#6F42C1;">Adding</span><span style="color:#24292E;"> </span><span style="color:#032F62;">password</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">user</span><span style="color:#24292E;"> </span><span style="color:#032F62;">admin</span></span></code></pre></div><h2 id="_9-2-创建的密码文件用secrets资源存储" tabindex="-1">9.2 创建的密码文件用secrets资源存储 <a class="header-anchor" href="#_9-2-创建的密码文件用secrets资源存储" aria-label="Permalink to &quot;9.2 创建的密码文件用secrets资源存储&quot;">​</a></h2><p>需要将<code>secret认证文件</code>和<code>业务pod</code>放在同一个 <strong>名称空间</strong>下，否则出现错误</p><ul><li>创建名字nginx-basic-auth</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">secret</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">generic</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nginx-basic-auth</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--from-file=auth</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">secret</span><span style="color:#24292E;"> </span><span style="color:#032F62;">generic</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx-basic-auth</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--from-file=auth</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get secrets </span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                  </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">                                  </span><span style="color:#9ECBFF;">DATA</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">nginx-basic-auth</span><span style="color:#E1E4E8;">                      </span><span style="color:#9ECBFF;">Opaque</span><span style="color:#E1E4E8;">                                </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">39</span><span style="color:#9ECBFF;">s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get secrets </span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                  </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">                                  </span><span style="color:#032F62;">DATA</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-basic-auth</span><span style="color:#24292E;">                      </span><span style="color:#032F62;">Opaque</span><span style="color:#24292E;">                                </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">39</span><span style="color:#032F62;">s</span></span></code></pre></div><ul><li>创建yaml配置文件</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-domain</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 指定认证类型</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/auth-type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">basic</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 登录的提示信息</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/auth-realm</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Please Input Your Username and Passowrd</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 对应认证信息，也就是我们创建的secrets资源名称，里面保存了我们创建的有效用户</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/auth-secret</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-basic-auth</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/use-regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/$2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/manager/(.*)$ /java/manager/$1 redirect;</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/host-manager/(.*)$ /java/host-manager/$1 redirect;</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/docs/(.*)$ /java/docs/$1 redirect;</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tls</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">secretName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java-host-com-tls</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/java(/|$)(.*)&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-domain</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 指定认证类型</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/auth-type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">basic</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 登录的提示信息</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/auth-realm</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Please Input Your Username and Passowrd</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 对应认证信息，也就是我们创建的secrets资源名称，里面保存了我们创建的有效用户</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/auth-secret</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-basic-auth</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/use-regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/$2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/manager/(.*)$ /java/manager/$1 redirect;</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/host-manager/(.*)$ /java/host-manager/$1 redirect;</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/docs/(.*)$ /java/docs/$1 redirect;</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tls</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">secretName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java-host-com-tls</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/java(/|$)(.*)&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><ul><li>验证效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405231323181.png" alt="image-20240523132336640"></p><h3 id="更新secret" tabindex="-1">更新secret <a class="header-anchor" href="#更新secret" aria-label="Permalink to &quot;更新secret&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#新添加用户之后，更新secret</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;(</span><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> create secret generic nginx-basic-auth </span><span style="color:#79B8FF;">--dry-run=client</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">--from-file=auth</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-oyaml</span><span style="color:#9ECBFF;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#新添加用户之后，更新secret</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;(</span><span style="color:#6F42C1;">kubectl</span><span style="color:#032F62;"> create secret generic nginx-basic-auth </span><span style="color:#005CC5;">--dry-run=client</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">--from-file=auth</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-oyaml</span><span style="color:#032F62;">)</span></span></code></pre></div><h1 id="_10-跨域" tabindex="-1">10. 跨域 <a class="header-anchor" href="#_10-跨域" aria-label="Permalink to &quot;10. 跨域&quot;">​</a></h1><p>文档，<a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#enable-cors" target="_blank" rel="noreferrer">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#enable-cors</a></p><ul><li>参数</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">nginx.ingress.kubernetes.io/cors-allow-headers</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|-</span></span>
<span class="line"><span style="color:#9ECBFF;">       DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/cors-allow-methods</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;GET, POST, OPTIONS&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/cors-allow-origin</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;*&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/enable-cors</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;true&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">nginx.ingress.kubernetes.io/cors-allow-headers</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|-</span></span>
<span class="line"><span style="color:#032F62;">       DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/cors-allow-methods</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;GET, POST, OPTIONS&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/cors-allow-origin</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;*&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/enable-cors</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;true&#39;</span></span></code></pre></div><ul><li>案例</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat  ingress-nginx-pc.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-domain</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/ssl-redirect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;false&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/use-regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/$2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/manager/(.*)$ /java/manager/$1 redirect;</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/host-manager/(.*)$ /java/host-manager/$1 redirect;</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/docs/(.*)$ /java/docs/$1 redirect;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/server-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|-</span></span>
<span class="line"><span style="color:#9ECBFF;">      set $agentflag 0;</span></span>
<span class="line"><span style="color:#9ECBFF;">      if ($http_user_agent ~* &quot;(iPhone|iPod|android)&quot; ){</span></span>
<span class="line"><span style="color:#9ECBFF;">         set $agentflag 1;</span></span>
<span class="line"><span style="color:#9ECBFF;">      }</span></span>
<span class="line"><span style="color:#9ECBFF;">      if ( $agentflag = 1 ) {</span></span>
<span class="line"><span style="color:#9ECBFF;">        return 302 https://m.baidu.com;</span></span>
<span class="line"><span style="color:#9ECBFF;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/cors-allow-headers</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|-</span></span>
<span class="line"><span style="color:#9ECBFF;">       DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/cors-allow-methods</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;GET, POST, OPTIONS&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/cors-allow-origin</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;*&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/enable-cors</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;true&#39;</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tls</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">secretName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java-host-com-tls</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/java(/|$)(.*)&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat  ingress-nginx-pc.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-domain</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/ssl-redirect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;false&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/use-regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/$2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/manager/(.*)$ /java/manager/$1 redirect;</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/host-manager/(.*)$ /java/host-manager/$1 redirect;</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/docs/(.*)$ /java/docs/$1 redirect;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/server-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|-</span></span>
<span class="line"><span style="color:#032F62;">      set $agentflag 0;</span></span>
<span class="line"><span style="color:#032F62;">      if ($http_user_agent ~* &quot;(iPhone|iPod|android)&quot; ){</span></span>
<span class="line"><span style="color:#032F62;">         set $agentflag 1;</span></span>
<span class="line"><span style="color:#032F62;">      }</span></span>
<span class="line"><span style="color:#032F62;">      if ( $agentflag = 1 ) {</span></span>
<span class="line"><span style="color:#032F62;">        return 302 https://m.baidu.com;</span></span>
<span class="line"><span style="color:#032F62;">      }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/cors-allow-headers</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|-</span></span>
<span class="line"><span style="color:#032F62;">       DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/cors-allow-methods</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;GET, POST, OPTIONS&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/cors-allow-origin</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;*&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/enable-cors</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;true&#39;</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tls</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">secretName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java-host-com-tls</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/java(/|$)(.*)&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><ul><li>验证效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202405231629330.png" alt="image-20240523162922570"></p><h1 id="_11-http和https共存" tabindex="-1">11. http和https共存 <a class="header-anchor" href="#_11-http和https共存" aria-label="Permalink to &quot;11. http和https共存&quot;">​</a></h1><p>参数，nginx.ingress.kubernetes.io/ssl-redirect: &quot;false&quot;</p><ul><li>创建</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat ingress-nginx-whitelist.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-domain</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/ssl-redirect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;false&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/use-regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/$2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/manager/(.*)$ /java/manager/$1 redirect;</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/host-manager/(.*)$ /java/host-manager/$1 redirect;</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/docs/(.*)$ /java/docs/$1 redirect;</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tls</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">secretName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java-host-com-tls</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/java(/|$)(.*)&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat ingress-nginx-whitelist.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-domain</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/ssl-redirect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;false&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/use-regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/$2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/manager/(.*)$ /java/manager/$1 redirect;</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/host-manager/(.*)$ /java/host-manager/$1 redirect;</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/docs/(.*)$ /java/docs/$1 redirect;</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tls</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">secretName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java-host-com-tls</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/java(/|$)(.*)&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><ul><li><p>执行apply</p></li><li><p>查看</p></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get ingress</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">             </span><span style="color:#9ECBFF;">CLASS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">HOSTS</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">ADDRESS</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">PORTS</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">ingress-domain</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">nginx</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">java.host.com</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.104.132</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">443</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl describe ingress ingress-domain</span></span>
<span class="line"><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#B392F0;">Annotations:</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">nginx.ingress.kubernetes.io/configuration-snippet:</span></span>
<span class="line"><span style="color:#E1E4E8;">                   </span><span style="color:#B392F0;">rewrite</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">^/manager/</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">.</span><span style="color:#E1E4E8;">*)$ </span><span style="color:#9ECBFF;">/java/manager/</span><span style="color:#FFAB70;">$1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">redirect</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                   </span><span style="color:#B392F0;">rewrite</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">^/host-manager/</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">.</span><span style="color:#E1E4E8;">*)$ </span><span style="color:#9ECBFF;">/java/host-manager/</span><span style="color:#FFAB70;">$1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">redirect</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                   </span><span style="color:#B392F0;">rewrite</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">^/docs/</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">.</span><span style="color:#E1E4E8;">*)$ </span><span style="color:#9ECBFF;">/java/docs/</span><span style="color:#FFAB70;">$1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">redirect</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">                 </span><span style="color:#B392F0;">nginx.ingress.kubernetes.io/rewrite-target:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/</span><span style="color:#FFAB70;">$2</span></span>
<span class="line"><span style="color:#E1E4E8;">                 </span><span style="color:#B392F0;">nginx.ingress.kubernetes.io/ssl-redirect:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">                 </span><span style="color:#B392F0;">nginx.ingress.kubernetes.io/use-regex:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#79B8FF;">...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get ingress</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">             </span><span style="color:#032F62;">CLASS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">HOSTS</span><span style="color:#24292E;">           </span><span style="color:#032F62;">ADDRESS</span><span style="color:#24292E;">           </span><span style="color:#032F62;">PORTS</span><span style="color:#24292E;">     </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-domain</span><span style="color:#24292E;">   </span><span style="color:#032F62;">nginx</span><span style="color:#24292E;">   </span><span style="color:#032F62;">java.host.com</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.104.132</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">443</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">m</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl describe ingress ingress-domain</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#6F42C1;">Annotations:</span><span style="color:#24292E;">     </span><span style="color:#032F62;">nginx.ingress.kubernetes.io/configuration-snippet:</span></span>
<span class="line"><span style="color:#24292E;">                   </span><span style="color:#6F42C1;">rewrite</span><span style="color:#24292E;"> </span><span style="color:#032F62;">^/manager/</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">.</span><span style="color:#24292E;">*)$ </span><span style="color:#032F62;">/java/manager/</span><span style="color:#E36209;">$1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">redirect</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                   </span><span style="color:#6F42C1;">rewrite</span><span style="color:#24292E;"> </span><span style="color:#032F62;">^/host-manager/</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">.</span><span style="color:#24292E;">*)$ </span><span style="color:#032F62;">/java/host-manager/</span><span style="color:#E36209;">$1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">redirect</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                   </span><span style="color:#6F42C1;">rewrite</span><span style="color:#24292E;"> </span><span style="color:#032F62;">^/docs/</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">.</span><span style="color:#24292E;">*)$ </span><span style="color:#032F62;">/java/docs/</span><span style="color:#E36209;">$1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">redirect</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">                 </span><span style="color:#6F42C1;">nginx.ingress.kubernetes.io/rewrite-target:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/</span><span style="color:#E36209;">$2</span></span>
<span class="line"><span style="color:#24292E;">                 </span><span style="color:#6F42C1;">nginx.ingress.kubernetes.io/ssl-redirect:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">                 </span><span style="color:#6F42C1;">nginx.ingress.kubernetes.io/use-regex:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span></code></pre></div><h1 id="_12-ingress重定向307跳转-https无法切换回http访问" tabindex="-1">12. ingress重定向307跳转，https无法切换回http访问 <a class="header-anchor" href="#_12-ingress重定向307跳转-https无法切换回http访问" aria-label="Permalink to &quot;12.  ingress重定向307跳转，https无法切换回http访问&quot;">​</a></h1><p>K8S官网：<a href="https://kubernetes.io/" target="_blank" rel="noreferrer">https://kubernetes.io/</a></p><p>ingress官方文档：<a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#hsts" target="_blank" rel="noreferrer">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#hsts</a></p><p>出现这个的原因是hsts</p><ul><li>检查是否关闭强制SSL转跳</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">在对应pod的ingress配置文件中检查是否关闭强制SSL跳转</span></span>
<span class="line"><span style="color:#B392F0;">nginx.ingress.kubernetes.io/ssl-redirect:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">“</span><span style="color:#79B8FF;">false</span><span style="color:#9ECBFF;">”</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">在对应pod的ingress配置文件中检查是否关闭强制SSL跳转</span></span>
<span class="line"><span style="color:#6F42C1;">nginx.ingress.kubernetes.io/ssl-redirect:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">“</span><span style="color:#005CC5;">false</span><span style="color:#032F62;">”</span></span></code></pre></div><ul><li>检查nginx-ingress的configmap配置文件禁用HSTS</li></ul><blockquote><p>当出现307状态码时，就是HSTS保护策略拒绝了HTTP请求，这种情况单纯清理缓存无法处理，需要使用无痕窗口测试，当第一次访问http正常，访问过https再切换http出现307时就是HSTS策略问题</p></blockquote><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 在data里面添加hsts: &quot;false&quot;</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">data</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">hsts</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;false&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 在data里面添加hsts: &quot;false&quot;</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">data</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">hsts</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;false&quot;</span></span></code></pre></div><ul><li>重启ingress-controller</li></ul><blockquote><p>找到对应的nginx-ingress服务pod，进行无配置文件更新</p></blockquote><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看pod</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get pod -n ingress-nginx</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                   </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">ingress-nginx-admission-create-c799q</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Completed</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">d21h</span></span>
<span class="line"><span style="color:#B392F0;">ingress-nginx-admission-patch-wzm82</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Completed</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">d21h</span></span>
<span class="line"><span style="color:#B392F0;">ingress-nginx-controller-gcv4v</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> (4h45m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   24h</span></span>
<span class="line"><span style="color:#B392F0;">ingress-nginx-controller-hs58n</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> (4h45m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   24h</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 重启ingrss服务，分别将所有ingress的pod都执行一边即可</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{podname}</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{namespace}</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replace</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--force</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看pod</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get pod -n ingress-nginx</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                   </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">      </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">        </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-nginx-admission-create-c799q</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">d21h</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-nginx-admission-patch-wzm82</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">d21h</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-nginx-controller-gcv4v</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> (4h45m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   24h</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-nginx-controller-hs58n</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> (4h45m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   24h</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 重启ingrss服务，分别将所有ingress的pod都执行一边即可</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{podname}</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{namespace}</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yaml</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replace</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--force</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span></span></code></pre></div><h1 id="_13-ingress图片文件上传-返回413错误码" tabindex="-1">13. ingress图片文件上传 返回413错误码 <a class="header-anchor" href="#_13-ingress图片文件上传-返回413错误码" aria-label="Permalink to &quot;13. ingress图片文件上传 返回413错误码&quot;">​</a></h1><p>K8S官网：<a href="https://kubernetes.io/" target="_blank" rel="noreferrer">https://kubernetes.io/</a></p><p>ingress官方文档：<a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#proxy-body-size" target="_blank" rel="noreferrer">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#proxy-body-size</a></p><ul><li>修改configmap配置文件</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get configmap -n ingress-nginx</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                       </span><span style="color:#9ECBFF;">DATA</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">ingress-nginx-controller</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">d21h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl edit configmap ingress-nginx-controller -n ingress-nginx</span></span>
<span class="line"><span style="color:#6A737D;"># 在metadata:---annotations:添加</span></span>
<span class="line"><span style="color:#B392F0;">nginx.ingress.kubernetes.io/proxy-body-size:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">metadata:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">annotations:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">nginx.ingress.kubernetes.io/proxy-body-size:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#9ECBFF;">m</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get configmap -n ingress-nginx</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                       </span><span style="color:#032F62;">DATA</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-nginx-controller</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">d21h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl edit configmap ingress-nginx-controller -n ingress-nginx</span></span>
<span class="line"><span style="color:#6A737D;"># 在metadata:---annotations:添加</span></span>
<span class="line"><span style="color:#6F42C1;">nginx.ingress.kubernetes.io/proxy-body-size:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#032F62;">m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">metadata:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">annotations:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">nginx.ingress.kubernetes.io/proxy-body-size:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#032F62;">m</span></span></code></pre></div><ul><li>重启ingress-controller</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看pod</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master ingress]# kubectl get pod -n ingress-nginx</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                   </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">ingress-nginx-admission-create-c799q</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Completed</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">d21h</span></span>
<span class="line"><span style="color:#B392F0;">ingress-nginx-admission-patch-wzm82</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Completed</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">               </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">d21h</span></span>
<span class="line"><span style="color:#B392F0;">ingress-nginx-controller-gcv4v</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> (4h45m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   24h</span></span>
<span class="line"><span style="color:#B392F0;">ingress-nginx-controller-hs58n</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> (4h45m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   24h</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 重启ingrss服务，分别将所有ingress的pod都执行一边即可</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{podname}</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{namespace}</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replace</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--force</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看pod</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master ingress]# kubectl get pod -n ingress-nginx</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                   </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">      </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">        </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-nginx-admission-create-c799q</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">d21h</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-nginx-admission-patch-wzm82</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">               </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">d21h</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-nginx-controller-gcv4v</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> (4h45m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   24h</span></span>
<span class="line"><span style="color:#6F42C1;">ingress-nginx-controller-hs58n</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> (4h45m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   24h</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 重启ingrss服务，分别将所有ingress的pod都执行一边即可</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{podname}</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{namespace}</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yaml</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replace</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--force</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span></span></code></pre></div><h1 id="_14-ingress-pc端和手机端区分" tabindex="-1">14. ingress pc端和手机端区分 <a class="header-anchor" href="#_14-ingress-pc端和手机端区分" aria-label="Permalink to &quot;14. ingress pc端和手机端区分&quot;">​</a></h1><p>参数，nginx.ingress.kubernetes.io/server-snippet</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master ingress</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat ingress-nginx-pc.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-domain</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/ssl-redirect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;false&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/use-regex</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/$2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/manager/(.*)$ /java/manager/$1 redirect;</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/host-manager/(.*)$ /java/host-manager/$1 redirect;</span></span>
<span class="line"><span style="color:#9ECBFF;">      rewrite ^/docs/(.*)$ /java/docs/$1 redirect;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/server-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|-</span></span>
<span class="line"><span style="color:#9ECBFF;">      set $agentflag 0;</span></span>
<span class="line"><span style="color:#9ECBFF;">      if ($http_user_agent ~* &quot;(iPhone|iPod|android)&quot; ){</span></span>
<span class="line"><span style="color:#9ECBFF;">         set $agentflag 1;</span></span>
<span class="line"><span style="color:#9ECBFF;">      }</span></span>
<span class="line"><span style="color:#9ECBFF;">      if ( $agentflag = 1 ) {</span></span>
<span class="line"><span style="color:#9ECBFF;">        return 302 https://m.baidu.com;</span></span>
<span class="line"><span style="color:#9ECBFF;">      }</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tls</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">secretName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java-host-com-tls</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/java(/|$)(.*)&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master ingress</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat ingress-nginx-pc.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-domain</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/ssl-redirect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;false&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/use-regex</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/$2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/manager/(.*)$ /java/manager/$1 redirect;</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/host-manager/(.*)$ /java/host-manager/$1 redirect;</span></span>
<span class="line"><span style="color:#032F62;">      rewrite ^/docs/(.*)$ /java/docs/$1 redirect;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/server-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|-</span></span>
<span class="line"><span style="color:#032F62;">      set $agentflag 0;</span></span>
<span class="line"><span style="color:#032F62;">      if ($http_user_agent ~* &quot;(iPhone|iPod|android)&quot; ){</span></span>
<span class="line"><span style="color:#032F62;">         set $agentflag 1;</span></span>
<span class="line"><span style="color:#032F62;">      }</span></span>
<span class="line"><span style="color:#032F62;">      if ( $agentflag = 1 ) {</span></span>
<span class="line"><span style="color:#032F62;">        return 302 https://m.baidu.com;</span></span>
<span class="line"><span style="color:#032F62;">      }</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tls</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">secretName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java-host-com-tls</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># secrets资源名称</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/java(/|$)(.*)&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tomcat-prod-service</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><h1 id="_15-开始brotli压缩" tabindex="-1">15. 开始brotli压缩 <a class="header-anchor" href="#_15-开始brotli压缩" aria-label="Permalink to &quot;15. 开始brotli压缩&quot;">​</a></h1><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">data</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">enable-brotli</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;true&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">brotli-level</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;6&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">brotli-types</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;text/xml image/svg+xml application/x-font-ttf image/vnd.microsoft.icon application/x-font-opentype application/json font/eot application/vnd.ms-fontobject application/javascript font/otf application/xml application/xhtml+xml text/javascript application/x-javascript text/plain application/x-font-truetype application/xml+rss image/x-icon font/opentype text/css image/x-win-bitmap&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">data</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">enable-brotli</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;true&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">brotli-level</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;6&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">brotli-types</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;text/xml image/svg+xml application/x-font-ttf image/vnd.microsoft.icon application/x-font-opentype application/json font/eot application/vnd.ms-fontobject application/javascript font/otf application/xml application/xhtml+xml text/javascript application/x-javascript text/plain application/x-font-truetype application/xml+rss image/x-icon font/opentype text/css image/x-win-bitmap&#39;</span></span></code></pre></div><h1 id="_16-开启http2" tabindex="-1">16. 开启http2 <a class="header-anchor" href="#_16-开启http2" aria-label="Permalink to &quot;16. 开启http2&quot;">​</a></h1><p>默认是开启的</p><h1 id="_17-速率限制" tabindex="-1">17. 速率限制 <a class="header-anchor" href="#_17-速率限制" aria-label="Permalink to &quot;17. 速率限制&quot;">​</a></h1><h2 id="_17-1-参数" tabindex="-1">17.1 参数 <a class="header-anchor" href="#_17-1-参数" aria-label="Permalink to &quot;17.1 参数&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 配置映射-ConfigMap</span></span>
<span class="line"><span style="color:#9ECBFF;">$ kubectl get cm -n ingress-nginx ingress-nginx-controller -o yaml</span></span>
<span class="line"><span style="color:#85E89D;">data</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">http-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">    limit_req_zone $http_authorization zone=my-zone:20m rate=5r/s;</span></span>
<span class="line"><span style="color:#9ECBFF;">    limit_req_zone $binary_remote_addr zone=my-zone:20m rate=10r/s;</span></span>
<span class="line"><span style="color:#9ECBFF;">    limit_req_zone $http_someheader zone=my-zone:20m rate=20r/s;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 配置注释-annotations</span></span>
<span class="line"><span style="color:#6A737D;"># - 入口资源中的注释：</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">      limit_req zone=my-zone-1 burst=10 nodelay;</span></span>
<span class="line"><span style="color:#9ECBFF;">      limit_req_log_level notice;</span></span>
<span class="line"><span style="color:#9ECBFF;">      limit_req_status 429;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># - 一个入口定义的不同位置的不同节流示例：</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/server-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">      location content/images/ {</span></span>
<span class="line"><span style="color:#9ECBFF;">        limit_req zone=my-zone-2 burst=50 nodelay;</span></span>
<span class="line"><span style="color:#9ECBFF;">      }</span></span>
<span class="line"><span style="color:#9ECBFF;">      location content/texts/ {</span></span>
<span class="line"><span style="color:#9ECBFF;">        limit_req zone=my-zone-3 burst=50 nodelay;</span></span>
<span class="line"><span style="color:#9ECBFF;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">      limit_req zone=my-zone-1 burst=10 nodelay;</span></span>
<span class="line"><span style="color:#9ECBFF;">      limit_req_log_level notice;</span></span>
<span class="line"><span style="color:#9ECBFF;">      limit_req_status 429;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 配置映射-ConfigMap</span></span>
<span class="line"><span style="color:#032F62;">$ kubectl get cm -n ingress-nginx ingress-nginx-controller -o yaml</span></span>
<span class="line"><span style="color:#22863A;">data</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">http-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    limit_req_zone $http_authorization zone=my-zone:20m rate=5r/s;</span></span>
<span class="line"><span style="color:#032F62;">    limit_req_zone $binary_remote_addr zone=my-zone:20m rate=10r/s;</span></span>
<span class="line"><span style="color:#032F62;">    limit_req_zone $http_someheader zone=my-zone:20m rate=20r/s;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 配置注释-annotations</span></span>
<span class="line"><span style="color:#6A737D;"># - 入口资源中的注释：</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">      limit_req zone=my-zone-1 burst=10 nodelay;</span></span>
<span class="line"><span style="color:#032F62;">      limit_req_log_level notice;</span></span>
<span class="line"><span style="color:#032F62;">      limit_req_status 429;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># - 一个入口定义的不同位置的不同节流示例：</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/server-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">      location content/images/ {</span></span>
<span class="line"><span style="color:#032F62;">        limit_req zone=my-zone-2 burst=50 nodelay;</span></span>
<span class="line"><span style="color:#032F62;">      }</span></span>
<span class="line"><span style="color:#032F62;">      location content/texts/ {</span></span>
<span class="line"><span style="color:#032F62;">        limit_req zone=my-zone-3 burst=50 nodelay;</span></span>
<span class="line"><span style="color:#032F62;">      }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">      limit_req zone=my-zone-1 burst=10 nodelay;</span></span>
<span class="line"><span style="color:#032F62;">      limit_req_log_level notice;</span></span>
<span class="line"><span style="color:#032F62;">      limit_req_status 429;</span></span></code></pre></div><h1 id="_18-日志格式" tabindex="-1">18. 日志格式 <a class="header-anchor" href="#_18-日志格式" aria-label="Permalink to &quot;18. 日志格式&quot;">​</a></h1><p><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/log-format/" target="_blank" rel="noreferrer">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/log-format/</a></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">#默认</span></span>
<span class="line"><span style="color:#e1e4e8;">pod name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">#默认</span></span>
<span class="line"><span style="color:#24292e;">pod name</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ingress-nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">edit</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">configmap</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ingress-nginx-controller</span></span>
<span class="line"><span style="color:#6A737D;"># 在 data 字段添加下面内容</span></span>
<span class="line"><span style="color:#B392F0;">data:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">log-format-upstream:</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">&#39;{&quot;time&quot;: &quot;$time_iso8601&quot;, &quot;namespace&quot;: &quot;$namespace&quot;, &quot;service_name&quot;: &quot;$service_name&quot;,</span></span>
<span class="line"><span style="color:#B392F0;">      &quot;service_port&quot;: $service_port, &quot;domain&quot;: &quot; $host&quot;, &quot;path&quot;: &quot;$uri&quot;, &quot;request_id&quot;: &quot;$req_id&quot;,</span></span>
<span class="line"><span style="color:#B392F0;">      &quot;remote_user&quot;: &quot;$remote_user&quot;, &quot;request_query&quot;: &quot;$args&quot;, &quot;bytes_sent&quot;: $bytes_sent, </span></span>
<span class="line"><span style="color:#B392F0;">      &quot;status&quot;: $status, &quot;request_time&quot;: $request_time, &quot;request_proto&quot;: &quot;$server_protocol&quot;, </span></span>
<span class="line"><span style="color:#B392F0;">      &quot;request_length&quot;: $request_length, &quot;duration&quot;: $request_time, &quot;method&quot;: &quot;$request_method&quot;, </span></span>
<span class="line"><span style="color:#B392F0;">      &quot;http_referrer&quot;: &quot;$http_referer&quot;, &quot;remote_addr&quot;:&quot;$remote_addr&quot;, &quot;remote_port&quot;: &quot;$remote_port&quot;,</span></span>
<span class="line"><span style="color:#B392F0;">      &quot;proxy_protocol_addr&quot;: &quot;$proxy_protocol_addr&quot;, &quot;proxy_add_x_forwarded_for&quot;: &quot;$proxy_add_x_forwarded_for&quot;,</span></span>
<span class="line"><span style="color:#B392F0;">      &quot;x_forwarded_for&quot;: &quot;$http_x_forwarded_for&quot;, &quot;http_user_agent&quot;: &quot;$http_user_agent&quot;</span></span>
<span class="line"><span style="color:#B392F0;">    }&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ingress-nginx</span><span style="color:#24292E;"> </span><span style="color:#032F62;">edit</span><span style="color:#24292E;"> </span><span style="color:#032F62;">configmap</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ingress-nginx-controller</span></span>
<span class="line"><span style="color:#6A737D;"># 在 data 字段添加下面内容</span></span>
<span class="line"><span style="color:#6F42C1;">data:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">log-format-upstream:</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">&#39;{&quot;time&quot;: &quot;$time_iso8601&quot;, &quot;namespace&quot;: &quot;$namespace&quot;, &quot;service_name&quot;: &quot;$service_name&quot;,</span></span>
<span class="line"><span style="color:#6F42C1;">      &quot;service_port&quot;: $service_port, &quot;domain&quot;: &quot; $host&quot;, &quot;path&quot;: &quot;$uri&quot;, &quot;request_id&quot;: &quot;$req_id&quot;,</span></span>
<span class="line"><span style="color:#6F42C1;">      &quot;remote_user&quot;: &quot;$remote_user&quot;, &quot;request_query&quot;: &quot;$args&quot;, &quot;bytes_sent&quot;: $bytes_sent, </span></span>
<span class="line"><span style="color:#6F42C1;">      &quot;status&quot;: $status, &quot;request_time&quot;: $request_time, &quot;request_proto&quot;: &quot;$server_protocol&quot;, </span></span>
<span class="line"><span style="color:#6F42C1;">      &quot;request_length&quot;: $request_length, &quot;duration&quot;: $request_time, &quot;method&quot;: &quot;$request_method&quot;, </span></span>
<span class="line"><span style="color:#6F42C1;">      &quot;http_referrer&quot;: &quot;$http_referer&quot;, &quot;remote_addr&quot;:&quot;$remote_addr&quot;, &quot;remote_port&quot;: &quot;$remote_port&quot;,</span></span>
<span class="line"><span style="color:#6F42C1;">      &quot;proxy_protocol_addr&quot;: &quot;$proxy_protocol_addr&quot;, &quot;proxy_add_x_forwarded_for&quot;: &quot;$proxy_add_x_forwarded_for&quot;,</span></span>
<span class="line"><span style="color:#6F42C1;">      &quot;x_forwarded_for&quot;: &quot;$http_x_forwarded_for&quot;, &quot;http_user_agent&quot;: &quot;$http_user_agent&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">    }&#39;</span></span></code></pre></div><h1 id="_19-header头" tabindex="-1">19. header头 <a class="header-anchor" href="#_19-header头" aria-label="Permalink to &quot;19. header头&quot;">​</a></h1><p>当header头中有关键字（foo 或 new）字段的时候，自动将流量转发至new-demo；</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">root@kube-master cannary</span><span style="color:#E1E4E8;">]# </span><span style="color:#9ECBFF;">cat header-ingress.yaml</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">header-demo-ingress</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">      if ($http_name ~ &quot;^.*foo$|^.*new$&quot;) {</span></span>
<span class="line"><span style="color:#9ECBFF;">        proxy_pass http://new-demo.default:80;</span></span>
<span class="line"><span style="color:#9ECBFF;">        break;</span></span>
<span class="line"><span style="color:#9ECBFF;">      }</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">java.host.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">old-demo</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">#必须是old 在前面，否则new，在前面，会覆盖old，导致不能访问到old</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">new-demo</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#032F62;">root@kube-master cannary</span><span style="color:#24292E;">]# </span><span style="color:#032F62;">cat header-ingress.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">header-demo-ingress</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">      if ($http_name ~ &quot;^.*foo$|^.*new$&quot;) {</span></span>
<span class="line"><span style="color:#032F62;">        proxy_pass http://new-demo.default:80;</span></span>
<span class="line"><span style="color:#032F62;">        break;</span></span>
<span class="line"><span style="color:#032F62;">      }</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">java.host.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">old-demo</span><span style="color:#24292E;">    </span><span style="color:#6A737D;">#必须是old 在前面，否则new，在前面，会覆盖old，导致不能访问到old</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">new-demo</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><ul><li>测试效果</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">➜</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-H</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;name:new&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://java.host.com</span></span>
<span class="line"><span style="color:#B392F0;">hsuing</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demoapp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1.2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">!!</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ClientIP:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.103</span><span style="color:#9ECBFF;">.236.202,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PodName:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">new-demo-5d96dfb47d-s4v8j,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PodIP:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.30</span><span style="color:#9ECBFF;">.0.180!</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">➜</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-H</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Host:java.host.com&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://java.host.com</span></span>
<span class="line"><span style="color:#B392F0;">hsuing</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demoapp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1.1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">!!</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ClientIP:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.30</span><span style="color:#9ECBFF;">.0.128,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PodName:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">old-demo-687c6ccd99-mf7ks,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PodIP:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.23</span><span style="color:#9ECBFF;">.127.96!</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">➜</span><span style="color:#24292E;"> </span><span style="color:#032F62;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-H</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;name:new&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://java.host.com</span></span>
<span class="line"><span style="color:#6F42C1;">hsuing</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demoapp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1.2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">!!</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ClientIP:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.103</span><span style="color:#032F62;">.236.202,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PodName:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">new-demo-5d96dfb47d-s4v8j,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PodIP:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.30</span><span style="color:#032F62;">.0.180!</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">➜</span><span style="color:#24292E;"> </span><span style="color:#032F62;">curl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-H</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Host:java.host.com&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://java.host.com</span></span>
<span class="line"><span style="color:#6F42C1;">hsuing</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demoapp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1.1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">!!</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ClientIP:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.30</span><span style="color:#032F62;">.0.128,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PodName:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">old-demo-687c6ccd99-mf7ks,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PodIP:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.23</span><span style="color:#032F62;">.127.96!</span></span></code></pre></div><h1 id="_20-传递用户真实ip" tabindex="-1">20. 传递用户真实IP <a class="header-anchor" href="#_20-传递用户真实ip" aria-label="Permalink to &quot;20. 传递用户真实IP&quot;">​</a></h1><p>文档, <a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration" target="_blank" rel="noreferrer">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration</a></p><p>在data配置块下添加</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">$ kubectl -n ingress-nginx edit configmap ingress-nginx-controller</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;"># 在 data 字段添加下面几行</span></span>
<span class="line"><span style="color:#85E89D;">data</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 源地址附加到 X-Forwarded-For 标头，而不是替换它</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">compute-full-forwarded-for</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 标头允许下划线，默认是关闭</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">enable-underscores-in-headers</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 设置用于标识客户端的原始 IP 地址的标头字段。 默认值：X-Forwarded-For</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">forwarded-for-header</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">X-Forwarded-For</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 当期望将 X-Forwarded-* 的标头信息传递给后端服务时，需要设置为true</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">use-forwarded-headers</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 启用或禁用 PROXY 协议以接收通过代理服务器和负载均衡器传递的客户端连接（真实 IP 地址）信息</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">use-proxy-protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 重启 ingress-nginx-controller 容器</span></span>
<span class="line"><span style="color:#9ECBFF;">$ kubectl -n ingress-nginx delete pod -l app.kubernetes.io/component=controller</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">$ kubectl -n ingress-nginx edit configmap ingress-nginx-controller</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;"># 在 data 字段添加下面几行</span></span>
<span class="line"><span style="color:#22863A;">data</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 源地址附加到 X-Forwarded-For 标头，而不是替换它</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">compute-full-forwarded-for</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 标头允许下划线，默认是关闭</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">enable-underscores-in-headers</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 设置用于标识客户端的原始 IP 地址的标头字段。 默认值：X-Forwarded-For</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">forwarded-for-header</span><span style="color:#24292E;">: </span><span style="color:#032F62;">X-Forwarded-For</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 当期望将 X-Forwarded-* 的标头信息传递给后端服务时，需要设置为true</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">use-forwarded-headers</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 启用或禁用 PROXY 协议以接收通过代理服务器和负载均衡器传递的客户端连接（真实 IP 地址）信息</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">use-proxy-protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;true&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 重启 ingress-nginx-controller 容器</span></span>
<span class="line"><span style="color:#032F62;">$ kubectl -n ingress-nginx delete pod -l app.kubernetes.io/component=controller</span></span></code></pre></div><h1 id="_21-modsecurity" tabindex="-1">21. ModSecurity <a class="header-anchor" href="#_21-modsecurity" aria-label="Permalink to &quot;21. ModSecurity&quot;">​</a></h1><ul><li>启动服务</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deployment</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">modsecurity</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--image=httpd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--port=80</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">expose</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deployment</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">modsecurity</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ingress</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ingress-localhost</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--class=nginx</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--rule=</span><span style="color:#9ECBFF;">&#39;modsecurity/*=modsecurity:80&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">modsecurity</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--image=httpd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--port=80</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">expose</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">modsecurity</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ingress</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ingress-localhost</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--class=nginx</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--rule=</span><span style="color:#032F62;">&#39;modsecurity/*=modsecurity:80&#39;</span></span></code></pre></div><ul><li>配置</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl edit configmaps --namespace ingress-nginx ingress-nginx-controller</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl edit configmaps --namespace ingress-nginx ingress-nginx-controller</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">data:</span></span>
<span class="line"><span style="color:#e1e4e8;">  allow-snippet-annotations: &quot;true&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">  enable-modsecurity: &quot;true&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">  enable-owasp-modsecurity-crs: &quot;true&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">data:</span></span>
<span class="line"><span style="color:#24292e;">  allow-snippet-annotations: &quot;true&quot;</span></span>
<span class="line"><span style="color:#24292e;">  enable-modsecurity: &quot;true&quot;</span></span>
<span class="line"><span style="color:#24292e;">  enable-owasp-modsecurity-crs: &quot;true&quot;</span></span></code></pre></div><h2 id="_1-配置规则" tabindex="-1">1. 配置规则 <a class="header-anchor" href="#_1-配置规则" aria-label="Permalink to &quot;1. 配置规则&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">data:</span></span>
<span class="line"><span style="color:#e1e4e8;">  allow-snippet-annotations: &quot;true&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">  enable-modsecurity: &quot;true&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">  enable-owasp-modsecurity-crs: &quot;true&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">  modsecurity-snippet: |-</span></span>
<span class="line"><span style="color:#e1e4e8;">    SecRuleEngine On</span></span>
<span class="line"><span style="color:#e1e4e8;">    SecRequestBodyAccess On</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">data:</span></span>
<span class="line"><span style="color:#24292e;">  allow-snippet-annotations: &quot;true&quot;</span></span>
<span class="line"><span style="color:#24292e;">  enable-modsecurity: &quot;true&quot;</span></span>
<span class="line"><span style="color:#24292e;">  enable-owasp-modsecurity-crs: &quot;true&quot;</span></span>
<span class="line"><span style="color:#24292e;">  modsecurity-snippet: |-</span></span>
<span class="line"><span style="color:#24292e;">    SecRuleEngine On</span></span>
<span class="line"><span style="color:#24292e;">    SecRequestBodyAccess On</span></span></code></pre></div><ul><li>验证</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;http://modsecurity:8080/?param=&quot;&gt;&lt;script&gt;alert(1);&lt;/script&gt;&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;http://modsecurity:8080/?param=&quot;&gt;&lt;script&gt;alert(1);&lt;/script&gt;&#39;</span></span></code></pre></div><h1 id="_22-cache" tabindex="-1">22. Cache <a class="header-anchor" href="#_22-cache" aria-label="Permalink to &quot;22. Cache&quot;">​</a></h1><h2 id="_1-创建证书" tabindex="-1">1. 创建证书 <a class="header-anchor" href="#_1-创建证书" aria-label="Permalink to &quot;1. 创建证书&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl create secret tls tls-certificate --namespace default --key certificate-key.key --cert cetificate.crt</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl create secret tls tls-certificate --namespace default --key certificate-key.key --cert cetificate.crt</span></span></code></pre></div><h2 id="_2-创建cache-yaml" tabindex="-1">2. 创建cache.yaml <a class="header-anchor" href="#_2-创建cache-yaml" aria-label="Permalink to &quot;2. 创建cache.yaml&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ConfigMap</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx-controller</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">default</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app.kubernetes.io/name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app.kubernetes.io/part-of</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-nginx</span></span>
<span class="line"><span style="color:#85E89D;">data</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">proxy-connect-timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;10&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">proxy-read-timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;120&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">proxy-send-timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;120&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">http-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;proxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=static-cache:10m max_size=4g inactive=120m use_temp_path=off;&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ConfigMap</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx-controller</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">default</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app.kubernetes.io/name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app.kubernetes.io/part-of</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-nginx</span></span>
<span class="line"><span style="color:#22863A;">data</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">proxy-connect-timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;10&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">proxy-read-timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;120&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">proxy-send-timeout</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;120&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">http-snippet</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;proxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=static-cache:10m max_size=4g inactive=120m use_temp_path=off;&quot;</span></span></code></pre></div><ul><li>执行</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">.configmap_cache.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">.configmap_cache.yaml</span></span></code></pre></div><h2 id="_3-配置public-ip" tabindex="-1">3. 配置Public ip <a class="header-anchor" href="#_3-配置public-ip" aria-label="Permalink to &quot;3. 配置Public ip&quot;">​</a></h2><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ConfigMap</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cdn-config</span></span>
<span class="line"><span style="color:#85E89D;">data</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">default.conf</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">    server {</span></span>
<span class="line"><span style="color:#9ECBFF;">      listen                  80;</span></span>
<span class="line"><span style="color:#9ECBFF;">      server_name             _;</span></span>
<span class="line"><span style="color:#9ECBFF;">      root                    /usr/share/nginx/html;</span></span>
<span class="line"><span style="color:#9ECBFF;">      location / {</span></span>
<span class="line"><span style="color:#9ECBFF;">      proxy_read_timeout 150;</span></span>
<span class="line"><span style="color:#9ECBFF;">     }</span></span>
<span class="line"><span style="color:#9ECBFF;">    }</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cdn</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cdn</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cdn</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx:latest</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cdn-config</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/nginx/conf.d/default.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">subPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">default.conf</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cdn-images</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/usr/share/nginx/html/&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cdn-config</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">configMap</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cdn-config</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cdn-images</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">persistentVolumeClaim</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">claimName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cdn-images</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cdn</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cdn</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">externalIPs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">YOUR public ip</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress-cdn</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">kubernetes.io/ingress.class</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;nginx&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/proxy-body-size</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">8m</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/proxy-buffering</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;on&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">      proxy_cache static-cache;</span></span>
<span class="line"><span style="color:#9ECBFF;">      proxy_cache_valid any 120m;</span></span>
<span class="line"><span style="color:#9ECBFF;">      add_header X-Cache-Status $upstream_cache_status;</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">tls</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">cdn.example.com</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">secretName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">tls-certificate</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cdn.example.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cdn</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">PersistentVolume</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cdn-images</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">storageClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">manual</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">capacity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">storage</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">4Gi</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">accessModes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">ReadWriteOnce</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">hostPath</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/home/root2/cdn-images/</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cdn-images</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">storageClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">manual</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">accessModes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">ReadWriteOnce</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">requests</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">storage</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">4Gi</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ConfigMap</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cdn-config</span></span>
<span class="line"><span style="color:#22863A;">data</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">default.conf</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    server {</span></span>
<span class="line"><span style="color:#032F62;">      listen                  80;</span></span>
<span class="line"><span style="color:#032F62;">      server_name             _;</span></span>
<span class="line"><span style="color:#032F62;">      root                    /usr/share/nginx/html;</span></span>
<span class="line"><span style="color:#032F62;">      location / {</span></span>
<span class="line"><span style="color:#032F62;">      proxy_read_timeout 150;</span></span>
<span class="line"><span style="color:#032F62;">     }</span></span>
<span class="line"><span style="color:#032F62;">    }</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cdn</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cdn</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cdn</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:latest</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cdn-config</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/nginx/conf.d/default.conf</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">subPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">default.conf</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cdn-images</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/usr/share/nginx/html/&quot;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cdn-config</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">configMap</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cdn-config</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cdn-images</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">persistentVolumeClaim</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">claimName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cdn-images</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cdn</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cdn</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">externalIPs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">YOUR public ip</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress-cdn</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">kubernetes.io/ingress.class</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;nginx&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/proxy-body-size</span><span style="color:#24292E;">: </span><span style="color:#032F62;">8m</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/proxy-buffering</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;on&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/configuration-snippet</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">      proxy_cache static-cache;</span></span>
<span class="line"><span style="color:#032F62;">      proxy_cache_valid any 120m;</span></span>
<span class="line"><span style="color:#032F62;">      add_header X-Cache-Status $upstream_cache_status;</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">tls</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">cdn.example.com</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">secretName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">tls-certificate</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cdn.example.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cdn</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">PersistentVolume</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cdn-images</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">storageClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">manual</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">capacity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">storage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">4Gi</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">accessModes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">ReadWriteOnce</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">hostPath</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/home/root2/cdn-images/</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cdn-images</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">storageClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">manual</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">accessModes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">ReadWriteOnce</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">storage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">4Gi</span></span></code></pre></div><ul><li>执行</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl apply -f 2.cdn.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl apply -f 2.cdn.yaml</span></span></code></pre></div><h1 id="_23-基于path" tabindex="-1">23.基于path <a class="header-anchor" href="#_23-基于path" aria-label="Permalink to &quot;23.基于path&quot;">​</a></h1><h2 id="_1-创建控制器" tabindex="-1">1.创建控制器 <a class="header-anchor" href="#_1-创建控制器" aria-label="Permalink to &quot;1.创建控制器&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"> kubectl create deployment myapp-v1 --image myapp:v1 --dry-run=client -o yaml &gt; myapp-v1.yaml</span></span>
<span class="line"><span style="color:#e1e4e8;"> </span></span>
<span class="line"><span style="color:#e1e4e8;"> kubectl create deployment myapp-v2 --image myapp:v2 --dry-run=client -o yaml &gt; myapp-v2.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"> kubectl create deployment myapp-v1 --image myapp:v1 --dry-run=client -o yaml &gt; myapp-v1.yaml</span></span>
<span class="line"><span style="color:#24292e;"> </span></span>
<span class="line"><span style="color:#24292e;"> kubectl create deployment myapp-v2 --image myapp:v2 --dry-run=client -o yaml &gt; myapp-v2.yaml</span></span></code></pre></div><p>vim myapp-v1.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-v1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-v1</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-v1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">strategy</span><span style="color:#E1E4E8;">: {}</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-v1</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp:v1</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-v1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-v1</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-v1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-v1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-v1</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-v1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">strategy</span><span style="color:#24292E;">: {}</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-v1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp:v1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-v1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-v1</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-v1</span></span></code></pre></div><p>vim myapp-v2.yaml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-v2</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-v2</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-v2</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-v2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp:v2</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-v2</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-v2</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-v2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-v2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-v2</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-v2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-v2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp:v2</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-v2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-v2</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-v2</span></span></code></pre></div><ul><li>执行apply</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl apply -f myapp-v1.yaml</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">kubectl apply -f myapp-v2.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl apply -f myapp-v1.yaml</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">kubectl apply -f myapp-v2.yaml</span></span></code></pre></div><h2 id="_2-暴露端口" tabindex="-1">2.暴露端口 <a class="header-anchor" href="#_2-暴露端口" aria-label="Permalink to &quot;2.暴露端口&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">expose</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deployment</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">myapp-v1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--port</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--target-port</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--dry-run=client</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">myapp-v1.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">expose</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deployment</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">myapp-v2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--port</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--target-port</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--dry-run=client</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">myapp-v2.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看service</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">services</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#测试</span></span>
<span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">serviceIP</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">expose</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">myapp-v1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--port</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--target-port</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--dry-run=client</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yaml</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">myapp-v1.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">expose</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployment</span><span style="color:#24292E;"> </span><span style="color:#032F62;">myapp-v2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--port</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--target-port</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--dry-run=client</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yaml</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">myapp-v2.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看service</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">services</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#测试</span></span>
<span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">serviceIP</span></span></code></pre></div><h2 id="_3-创建ingres" tabindex="-1">3.创建ingres <a class="header-anchor" href="#_3-创建ingres" aria-label="Permalink to &quot;3.创建ingres&quot;">​</a></h2><p>vim ingress1.yml</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">annotations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">#访问路径后加任何内容都被定向到/</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ingress1</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ingressClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">www.xxx.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">paths</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-v1</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/v1</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">backend</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">service</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myapp-v2</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">number</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/v2</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">pathType</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Prefix</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Ingress</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">annotations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nginx.ingress.kubernetes.io/rewrite-target</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/</span><span style="color:#24292E;">		</span><span style="color:#6A737D;">#访问路径后加任何内容都被定向到/</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ingress1</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ingressClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">www.xxx.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">paths</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-v1</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/v1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">backend</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">service</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myapp-v2</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">port</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">number</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/v2</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">pathType</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Prefix</span></span></code></pre></div><ul><li>添加hosts</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">#如果没有slb，方便测试在/etc/hosts添加ip</span></span>
<span class="line"><span style="color:#e1e4e8;">[root@k8s-master ~]# vim /etc/hosts</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">[root@k8s-master ~]# kubectl apply -f ingress1.yml</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">ingress.networking.k8s.io/ingress1 created</span></span>
<span class="line"><span style="color:#e1e4e8;"> </span></span>
<span class="line"><span style="color:#e1e4e8;">[root@k8s-master ~]# kubectl describe ingress ingress1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">#如果没有slb，方便测试在/etc/hosts添加ip</span></span>
<span class="line"><span style="color:#24292e;">[root@k8s-master ~]# vim /etc/hosts</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">[root@k8s-master ~]# kubectl apply -f ingress1.yml</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">ingress.networking.k8s.io/ingress1 created</span></span>
<span class="line"><span style="color:#24292e;"> </span></span>
<span class="line"><span style="color:#24292e;">[root@k8s-master ~]# kubectl describe ingress ingress1</span></span></code></pre></div><ul><li>测试</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#测试：</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-node1 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# echo 172.25.254.50 www.xxx.com </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> /etc/hosts</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-node1 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# curl www.exam.com/v1</span></span>
<span class="line"><span style="color:#B392F0;">Hello</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MyApp</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Version:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">a</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">href=&quot;hostname.html&quot;</span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">Pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Name</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">a</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-node1 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# curl www.xxx.com/v2</span></span>
<span class="line"><span style="color:#B392F0;">Hello</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MyApp</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Version:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">a</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">href=&quot;hostname.html&quot;</span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">Pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Name</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">a</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#nginx.ingress.kubernetes.io/rewrite-target: / 的功能实现</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@k8s-node1 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# curl www.xxx.com/v1/aaaa</span></span>
<span class="line"><span style="color:#B392F0;">Hello</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MyApp</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Version:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#B392F0;">a</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">href=&quot;hostname.html&quot;</span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">Pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Name</span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">a</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#测试：</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-node1 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# echo 172.25.254.50 www.xxx.com </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> /etc/hosts</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-node1 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# curl www.exam.com/v1</span></span>
<span class="line"><span style="color:#6F42C1;">Hello</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MyApp</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Version:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#6F42C1;">a</span><span style="color:#24292E;"> </span><span style="color:#032F62;">href=&quot;hostname.html&quot;</span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">Pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Name</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">/</span><span style="color:#24292E;">a</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-node1 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# curl www.xxx.com/v2</span></span>
<span class="line"><span style="color:#6F42C1;">Hello</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MyApp</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Version:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#6F42C1;">a</span><span style="color:#24292E;"> </span><span style="color:#032F62;">href=&quot;hostname.html&quot;</span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">Pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Name</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">/</span><span style="color:#24292E;">a</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#nginx.ingress.kubernetes.io/rewrite-target: / 的功能实现</span></span>
<span class="line"><span style="color:#24292E;">[root@k8s-node1 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# curl www.xxx.com/v1/aaaa</span></span>
<span class="line"><span style="color:#6F42C1;">Hello</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MyApp</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Version:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#6F42C1;">a</span><span style="color:#24292E;"> </span><span style="color:#032F62;">href=&quot;hostname.html&quot;</span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">Pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Name</span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">/</span><span style="color:#24292E;">a</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><p>方壶外史</p><p>龙潜虎跃</p><p>意拳站桩</p><p>。。</p><p>晃海</p>`,270),e=[o];function t(c,r,E,y,i,F){return n(),a("div",null,e)}const u=s(l,[["render",t]]);export{g as __pageData,u as default};
