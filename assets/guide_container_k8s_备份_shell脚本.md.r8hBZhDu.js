import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const A=JSON.parse('{"title":"备份资源类型列表","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/备份/shell脚本.md","filePath":"guide/container/k8s/备份/shell脚本.md","lastUpdated":1720533756000}'),p={name:"guide/container/k8s/备份/shell脚本.md"},o=l(`<h1 id="备份资源类型列表" tabindex="-1">备份资源类型列表 <a class="header-anchor" href="#备份资源类型列表" aria-label="Permalink to &quot;备份资源类型列表&quot;">​</a></h1><p>RESOURCES=(</p><p>&quot;pods&quot;</p><p>&quot;services&quot;</p><p>&quot;deployments&quot;</p><p>&quot;configmaps&quot;</p><p>&quot;secrets&quot;</p><p>&quot;persistentvolumeclaims&quot;</p><p>&quot;statefulsets&quot;</p><p>&quot;daemonsets&quot;</p><p>&quot;replicasets&quot;)</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="color:#6A737D;">###</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># @Description: 一键备份K8s集群YAML文件脚本</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># @Author: hanxiong</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># @Mail: nnaigos@gmail.com</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># @Date: 2022-05-27 10:54:24</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># @LastEditTime: 2023-05-27 10:54:24</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># @LastEditors: hanxiong</span></span>
<span class="line"><span style="color:#6A737D;">###</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 定时任务示例</span></span>
<span class="line"><span style="color:#6A737D;"># 0 0 */1 * * /usr/bin/bash /data/scritps/k8s-yaml-all-bak/k8s_yaml_backup.sh &gt; /data/scritps/k8s-yaml-all-bak/yaml_bak.logs 2&gt;&amp;1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nounset</span><span style="color:#E1E4E8;">                              </span><span style="color:#6A737D;"># Treat unset variables as an error</span></span>
<span class="line"><span style="color:#6A737D;"># 当前时间</span></span>
<span class="line"><span style="color:#E1E4E8;">DATE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">date</span><span style="color:#9ECBFF;"> +%Y-%m-%d--%H-%M-%S)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 备份路径</span></span>
<span class="line"><span style="color:#E1E4E8;">K8S_YAML_BACKUP_DIR</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;/data/backup/k8s_yaml_bak&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 脚本存放目录</span></span>
<span class="line"><span style="color:#E1E4E8;">K8S_YAML_SHELL_DIR</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;/data/scritps/k8s-yaml-all-bak&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 创建备份目录</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [ </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-d</span><span style="color:#E1E4E8;"> $K8S_YAML_BACKUP_DIR ];</span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> $K8S_YAML_BACKUP_DIR</span></span>
<span class="line"><span style="color:#F97583;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 资源类型列表</span></span>
<span class="line"><span style="color:#E1E4E8;">RESOURCES</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;pods&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;services&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;deployments&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;configmaps&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;secrets&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;persistentvolumeclaims&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;statefulsets&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;daemonsets&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;replicasets&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 每次备份单独创建一个家目录+时间</span></span>
<span class="line"><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> \${K8S_YAML_BACKUP_DIR}</span><span style="color:#9ECBFF;">/k8s-</span><span style="color:#E1E4E8;">\${DATE}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 获取家目录</span></span>
<span class="line"><span style="color:#E1E4E8;">GET_HOME_DIR</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">ls</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-l</span><span style="color:#9ECBFF;"> \${</span><span style="color:#E1E4E8;">K8S_YAML_BACKUP_DIR</span><span style="color:#9ECBFF;">} </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">tail</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;"> </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">awk</span><span style="color:#9ECBFF;"> &#39;{print $9}&#39;)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;备份路径：</span><span style="color:#E1E4E8;">$K8S_YAML_BACKUP_DIR</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">$GET_HOME_DIR</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 获取k8s名称空间</span></span>
<span class="line"><span style="color:#E1E4E8;">NAMESPACE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get ns </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">awk</span><span style="color:#9ECBFF;"> &#39;{print $1}&#39; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">tail</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#9ECBFF;"> +2)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">DumpYaml</span><span style="color:#E1E4E8;">(){</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># 遍历NS</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> NS </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> $NAMESPACE ;</span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#6A737D;"># 创建NS备份目录</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> \${K8S_YAML_BACKUP_DIR}</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">\${GET_HOME_DIR}</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">\${NS}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#6A737D;"># 过滤NS(kube-public、kube-system)</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ $NS </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;kube-public&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> $NS </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;kube-system&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> $NS </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;csdr&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> $NS </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;kube-node-lease&quot;</span><span style="color:#E1E4E8;"> ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#6A737D;"># 遍历k8s资源</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> RESOURCE </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> \${RESOURCES[@]}; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#6A737D;"># 创建资源目录</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> \${K8S_YAML_BACKUP_DIR}</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">\${GET_HOME_DIR}</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">\${NS}</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">\${RESOURCE}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#6A737D;"># 遍历对应资源名称</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> RESOURCE_NAME </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get </span><span style="color:#E1E4E8;">$RESOURCE</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#9ECBFF;"> </span><span style="color:#E1E4E8;">$NS</span><span style="color:#9ECBFF;"> </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">awk</span><span style="color:#9ECBFF;"> &#39;{print $1}&#39; </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">tail</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#9ECBFF;"> +2)</span><span style="color:#E1E4E8;">;</span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">                  DATE_YAML</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">date</span><span style="color:#9ECBFF;"> +%Y-%m-%d--%H:%M:%S)</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;\${</span><span style="color:#E1E4E8;">DATE_YAML</span><span style="color:#9ECBFF;">} 导出YAML: \${</span><span style="color:#E1E4E8;">NS</span><span style="color:#9ECBFF;">} \${</span><span style="color:#E1E4E8;">RESOURCE</span><span style="color:#9ECBFF;">} \${</span><span style="color:#E1E4E8;">RESOURCE_NAME</span><span style="color:#9ECBFF;">} &quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#6A737D;"># 导出对应名称空间下对应资源的yaml</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> \${RESOURCE} \${RESOURCE_NAME} </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> \${NS} </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> \${K8S_YAML_BACKUP_DIR}</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">\${GET_HOME_DIR}</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">\${NS}</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">\${RESOURCE}</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">\${RESOURCE_NAME}</span><span style="color:#9ECBFF;">.yaml</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#F97583;">done</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">done</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">done</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">DelYaml</span><span style="color:#E1E4E8;">(){</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> DIR_NAME </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">find</span><span style="color:#9ECBFF;"> \${</span><span style="color:#E1E4E8;">K8S_YAML_BACKUP_DIR</span><span style="color:#9ECBFF;">} </span><span style="color:#79B8FF;">-type</span><span style="color:#9ECBFF;"> d </span><span style="color:#79B8FF;">-mtime</span><span style="color:#9ECBFF;"> +7)</span><span style="color:#E1E4E8;">;</span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">          DATE_YAML</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">date</span><span style="color:#9ECBFF;"> +%Y-%m-%d--%H:%M:%S)</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;\${</span><span style="color:#E1E4E8;">DATE_YAML</span><span style="color:#9ECBFF;">} 删除：</span><span style="color:#E1E4E8;">$DIR_NAME</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> \${K8S_YAML_SHELL_DIR}</span><span style="color:#9ECBFF;">/del-yaml.logs</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-rf</span><span style="color:#E1E4E8;"> \${DIR_NAME}  </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> \${K8S_YAML_SHELL_DIR}</span><span style="color:#9ECBFF;">/del-yaml.logs</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> \${K8S_YAML_SHELL_DIR}</span><span style="color:#9ECBFF;">/del-yaml.logs</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">done</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">DumpYaml</span></span>
<span class="line"><span style="color:#B392F0;">DelYaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="color:#6A737D;">###</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;"># @Description: 一键备份K8s集群YAML文件脚本</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;"># @Author: hanxiong</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;"># @Mail: nnaigos@gmail.com</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;"># @Date: 2022-05-27 10:54:24</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;"># @LastEditTime: 2023-05-27 10:54:24</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;"># @LastEditors: hanxiong</span></span>
<span class="line"><span style="color:#6A737D;">###</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 定时任务示例</span></span>
<span class="line"><span style="color:#6A737D;"># 0 0 */1 * * /usr/bin/bash /data/scritps/k8s-yaml-all-bak/k8s_yaml_backup.sh &gt; /data/scritps/k8s-yaml-all-bak/yaml_bak.logs 2&gt;&amp;1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">set</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nounset</span><span style="color:#24292E;">                              </span><span style="color:#6A737D;"># Treat unset variables as an error</span></span>
<span class="line"><span style="color:#6A737D;"># 当前时间</span></span>
<span class="line"><span style="color:#24292E;">DATE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">date</span><span style="color:#032F62;"> +%Y-%m-%d--%H-%M-%S)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 备份路径</span></span>
<span class="line"><span style="color:#24292E;">K8S_YAML_BACKUP_DIR</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;/data/backup/k8s_yaml_bak&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 脚本存放目录</span></span>
<span class="line"><span style="color:#24292E;">K8S_YAML_SHELL_DIR</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;/data/scritps/k8s-yaml-all-bak&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 创建备份目录</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [ </span><span style="color:#D73A49;">!</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-d</span><span style="color:#24292E;"> $K8S_YAML_BACKUP_DIR ];</span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> $K8S_YAML_BACKUP_DIR</span></span>
<span class="line"><span style="color:#D73A49;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 资源类型列表</span></span>
<span class="line"><span style="color:#24292E;">RESOURCES</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;pods&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;services&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;deployments&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;configmaps&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;secrets&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;persistentvolumeclaims&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;statefulsets&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;daemonsets&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;replicasets&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 每次备份单独创建一个家目录+时间</span></span>
<span class="line"><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> \${K8S_YAML_BACKUP_DIR}</span><span style="color:#032F62;">/k8s-</span><span style="color:#24292E;">\${DATE}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 获取家目录</span></span>
<span class="line"><span style="color:#24292E;">GET_HOME_DIR</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">ls</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-l</span><span style="color:#032F62;"> \${</span><span style="color:#24292E;">K8S_YAML_BACKUP_DIR</span><span style="color:#032F62;">} </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">tail</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-n</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;"> </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">awk</span><span style="color:#032F62;"> &#39;{print $9}&#39;)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;备份路径：</span><span style="color:#24292E;">$K8S_YAML_BACKUP_DIR</span><span style="color:#032F62;">/</span><span style="color:#24292E;">$GET_HOME_DIR</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 获取k8s名称空间</span></span>
<span class="line"><span style="color:#24292E;">NAMESPACE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">kubectl</span><span style="color:#032F62;"> get ns </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">awk</span><span style="color:#032F62;"> &#39;{print $1}&#39; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">tail</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-n</span><span style="color:#032F62;"> +2)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">DumpYaml</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># 遍历NS</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> NS </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> $NAMESPACE ;</span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6A737D;"># 创建NS备份目录</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> \${K8S_YAML_BACKUP_DIR}</span><span style="color:#032F62;">/</span><span style="color:#24292E;">\${GET_HOME_DIR}</span><span style="color:#032F62;">/</span><span style="color:#24292E;">\${NS}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6A737D;"># 过滤NS(kube-public、kube-system)</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ $NS </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;kube-public&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> $NS </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;kube-system&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> $NS </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;csdr&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> $NS </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;kube-node-lease&quot;</span><span style="color:#24292E;"> ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#6A737D;"># 遍历k8s资源</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> RESOURCE </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> \${RESOURCES[@]}; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#6A737D;"># 创建资源目录</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> \${K8S_YAML_BACKUP_DIR}</span><span style="color:#032F62;">/</span><span style="color:#24292E;">\${GET_HOME_DIR}</span><span style="color:#032F62;">/</span><span style="color:#24292E;">\${NS}</span><span style="color:#032F62;">/</span><span style="color:#24292E;">\${RESOURCE}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#6A737D;"># 遍历对应资源名称</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> RESOURCE_NAME </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">kubectl</span><span style="color:#032F62;"> get </span><span style="color:#24292E;">$RESOURCE</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-n</span><span style="color:#032F62;"> </span><span style="color:#24292E;">$NS</span><span style="color:#032F62;"> </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">awk</span><span style="color:#032F62;"> &#39;{print $1}&#39; </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#6F42C1;">tail</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-n</span><span style="color:#032F62;"> +2)</span><span style="color:#24292E;">;</span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">                  DATE_YAML</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">date</span><span style="color:#032F62;"> +%Y-%m-%d--%H:%M:%S)</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;\${</span><span style="color:#24292E;">DATE_YAML</span><span style="color:#032F62;">} 导出YAML: \${</span><span style="color:#24292E;">NS</span><span style="color:#032F62;">} \${</span><span style="color:#24292E;">RESOURCE</span><span style="color:#032F62;">} \${</span><span style="color:#24292E;">RESOURCE_NAME</span><span style="color:#032F62;">} &quot;</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#6A737D;"># 导出对应名称空间下对应资源的yaml</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> \${RESOURCE} \${RESOURCE_NAME} </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> \${NS} </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yaml</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> \${K8S_YAML_BACKUP_DIR}</span><span style="color:#032F62;">/</span><span style="color:#24292E;">\${GET_HOME_DIR}</span><span style="color:#032F62;">/</span><span style="color:#24292E;">\${NS}</span><span style="color:#032F62;">/</span><span style="color:#24292E;">\${RESOURCE}</span><span style="color:#032F62;">/</span><span style="color:#24292E;">\${RESOURCE_NAME}</span><span style="color:#032F62;">.yaml</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#D73A49;">done</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">done</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">done</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">DelYaml</span><span style="color:#24292E;">(){</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> DIR_NAME </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">find</span><span style="color:#032F62;"> \${</span><span style="color:#24292E;">K8S_YAML_BACKUP_DIR</span><span style="color:#032F62;">} </span><span style="color:#005CC5;">-type</span><span style="color:#032F62;"> d </span><span style="color:#005CC5;">-mtime</span><span style="color:#032F62;"> +7)</span><span style="color:#24292E;">;</span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">          DATE_YAML</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">date</span><span style="color:#032F62;"> +%Y-%m-%d--%H:%M:%S)</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;\${</span><span style="color:#24292E;">DATE_YAML</span><span style="color:#032F62;">} 删除：</span><span style="color:#24292E;">$DIR_NAME</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> \${K8S_YAML_SHELL_DIR}</span><span style="color:#032F62;">/del-yaml.logs</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-rf</span><span style="color:#24292E;"> \${DIR_NAME}  </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> \${K8S_YAML_SHELL_DIR}</span><span style="color:#032F62;">/del-yaml.logs</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> \${K8S_YAML_SHELL_DIR}</span><span style="color:#032F62;">/del-yaml.logs</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">done</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">DumpYaml</span></span>
<span class="line"><span style="color:#6F42C1;">DelYaml</span></span></code></pre></div>`,12),e=[o];function t(c,r,E,y,F,i){return n(),a("div",null,e)}const D=s(p,[["render",t]]);export{A as __pageData,D as default};
