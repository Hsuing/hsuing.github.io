import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const C=JSON.parse('{"title":"2，日常清理","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/pgSql/base/11-dba.md","filePath":"guide/Database/pgSql/base/11-dba.md","lastUpdated":1721309786000}'),p={name:"guide/Database/pgSql/base/11-dba.md"},o=l(`<p>1,查看正在执行的sql</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pid,usename,</span><span style="color:#79B8FF;">substring</span><span style="color:#E1E4E8;">(query </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;">),</span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">query_start </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">time</span><span style="color:#E1E4E8;">,wait_event,</span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;active&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;"> pid  | usename  |                     substring                     |   </span><span style="color:#F97583;">time</span><span style="color:#E1E4E8;">   | wait_event | </span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#6A737D;">------+----------+---------------------------------------------------+----------+------------+--------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7962</span><span style="color:#E1E4E8;"> | postgres | </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pid,usename,</span><span style="color:#79B8FF;">substring</span><span style="color:#E1E4E8;">(query </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;">) | </span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">:</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;"> |            | active</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pid,usename,</span><span style="color:#005CC5;">substring</span><span style="color:#24292E;">(query </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">50</span><span style="color:#24292E;">),</span><span style="color:#D73A49;">now</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">query_start </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">time</span><span style="color:#24292E;">,wait_event,</span><span style="color:#D73A49;">state</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">state</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;active&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;"> pid  | usename  |                     substring                     |   </span><span style="color:#D73A49;">time</span><span style="color:#24292E;">   | wait_event | </span><span style="color:#D73A49;">state</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#6A737D;">------+----------+---------------------------------------------------+----------+------------+--------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">7962</span><span style="color:#24292E;"> | postgres | </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pid,usename,</span><span style="color:#005CC5;">substring</span><span style="color:#24292E;">(query </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">50</span><span style="color:#24292E;">) | </span><span style="color:#005CC5;">00</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">:</span><span style="color:#005CC5;">00</span><span style="color:#24292E;"> |            | active</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span></code></pre></div><h2 id="_1-1查看执行超过2秒的sql" tabindex="-1">1.1查看执行超过2秒的sql <a class="header-anchor" href="#_1-1查看执行超过2秒的sql" aria-label="Permalink to &quot;1.1查看执行超过2秒的sql&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pid,</span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;">,query_start,xact_start,</span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">query_start,wait_event_type,wait_event,</span><span style="color:#79B8FF;">substring</span><span style="color:#E1E4E8;">(query </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">query_start </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;2 s&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> query_start;</span></span>
<span class="line"><span style="color:#E1E4E8;"> pid | </span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;"> | query_start | xact_start | ?column? | wait_event_type | wait_event | substring </span></span>
<span class="line"><span style="color:#6A737D;">-----+-------+-------------+------------+----------+-----------------+------------+-----------</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pid,</span><span style="color:#D73A49;">state</span><span style="color:#24292E;">,query_start,xact_start,</span><span style="color:#D73A49;">now</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">query_start,wait_event_type,wait_event,</span><span style="color:#005CC5;">substring</span><span style="color:#24292E;">(query </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">50</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">now</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">query_start </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;2 s&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> query_start;</span></span>
<span class="line"><span style="color:#24292E;"> pid | </span><span style="color:#D73A49;">state</span><span style="color:#24292E;"> | query_start | xact_start | ?column? | wait_event_type | wait_event | substring </span></span>
<span class="line"><span style="color:#6A737D;">-----+-------+-------------+------------+----------+-----------------+------------+-----------</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span></code></pre></div><h2 id="_1-2根据pid杀会话" tabindex="-1">1.2根据PID杀会话 <a class="header-anchor" href="#_1-2根据pid杀会话" aria-label="Permalink to &quot;1.2根据PID杀会话&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">select pg_cancel_backend(pid);  </span></span>
<span class="line"><span style="color:#e1e4e8;">或者</span></span>
<span class="line"><span style="color:#e1e4e8;">select pg_terminate_backend(pid);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">select pg_cancel_backend(pid);  </span></span>
<span class="line"><span style="color:#24292e;">或者</span></span>
<span class="line"><span style="color:#24292e;">select pg_terminate_backend(pid);</span></span></code></pre></div><p>这两个函数区别如下：</p><h3 id="pg-cancel-backend" tabindex="-1"><code>pg_cancel_backend()</code> <a class="header-anchor" href="#pg-cancel-backend" aria-label="Permalink to &quot;\`pg_cancel_backend()\`&quot;">​</a></h3><ol><li>只能关闭当前用户下的后台进程</li><li>向后台发送SIGINT信号，用于关闭事务，此时session还在，并且事务回滚</li></ol><h3 id="pg-terminate-backend" tabindex="-1"><code>pg_terminate_backend()</code> <a class="header-anchor" href="#pg-terminate-backend" aria-label="Permalink to &quot;\`pg_terminate_backend()\`&quot;">​</a></h3><ol><li>需要superuser权限，可以关闭所有的后台进程</li><li>向后台发送SIGTERM信号，用于关闭事务，此时session也会被关闭，并且事务回滚</li></ol><h2 id="_1-3查看锁问题" tabindex="-1">1.3查看锁问题 <a class="header-anchor" href="#_1-3查看锁问题" aria-label="Permalink to &quot;1.3查看锁问题&quot;">​</a></h2><p>创建为视图</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">view</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">v_locks_monitor</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#F97583;">with</span><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">t_wait </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">(    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mode</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">locktype</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relation</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tuple</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">classid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">granted</span><span style="color:#E1E4E8;">,   </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objsubid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">virtualtransaction</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">virtualxid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transactionid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fastpath</span><span style="color:#E1E4E8;">,    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">state</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xact_start</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_start</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">usename</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">datname</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">client_addr</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">client_port</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">application_name</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_locks a,pg_stat_activity b </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">granted</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">),   </span></span>
<span class="line"><span style="color:#E1E4E8;">t_run </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">(   </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mode</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">locktype</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relation</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tuple</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">classid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">granted</span><span style="color:#E1E4E8;">,   </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objsubid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">virtualtransaction</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">virtualxid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transactionid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fastpath</span><span style="color:#E1E4E8;">,   </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">state</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xact_start</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_start</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">usename</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">datname</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">client_addr</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">client_port</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">application_name</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_locks a,pg_stat_activity b </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">granted</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">),   </span></span>
<span class="line"><span style="color:#E1E4E8;">t_overlap </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">(   </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> r.</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> t_wait w </span><span style="color:#F97583;">join</span><span style="color:#E1E4E8;"> t_run r </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">  (   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">locktype</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">locktype</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relation</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relation</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tuple</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tuple</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">virtualxid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">virtualxid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transactionid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transactionid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">classid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">classid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objsubid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objsubid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">  )    </span></span>
<span class="line"><span style="color:#E1E4E8;">),    </span></span>
<span class="line"><span style="color:#E1E4E8;">t_unionall </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">(    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> r.</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> t_overlap r    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">union all</span><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> w.</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> t_wait w    </span></span>
<span class="line"><span style="color:#E1E4E8;">)    </span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> locktype,datname,relation::regclass,</span><span style="color:#F97583;">page</span><span style="color:#E1E4E8;">,tuple,virtualxid,transactionid::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">,classid::regclass,</span><span style="color:#F97583;">objid</span><span style="color:#E1E4E8;">,objsubid,   </span></span>
<span class="line"><span style="color:#79B8FF;">string_agg</span><span style="color:#E1E4E8;">(   </span></span>
<span class="line"><span style="color:#9ECBFF;">&#39;Pid: &#39;</span><span style="color:#F97583;">||case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> pid </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NULL&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> pid::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end||</span><span style="color:#E1E4E8;">chr(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#9ECBFF;">&#39;Lock_Granted: &#39;</span><span style="color:#F97583;">||case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> granted </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NULL&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> granted::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end||</span><span style="color:#9ECBFF;">&#39; , Mode: &#39;</span><span style="color:#F97583;">||case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> mode </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NULL&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> mode::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end||</span><span style="color:#9ECBFF;">&#39; , FastPath: &#39;</span><span style="color:#F97583;">||case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> fastpath </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NULL&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> fastpath::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end||</span><span style="color:#9ECBFF;">&#39; , VirtualTransaction: &#39;</span><span style="color:#F97583;">||case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> virtualtransaction </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NULL&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> virtualtransaction::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end||</span><span style="color:#9ECBFF;">&#39; , Session_State: &#39;</span><span style="color:#F97583;">||case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NULL&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end||</span><span style="color:#E1E4E8;">chr(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#9ECBFF;">&#39;Username: &#39;</span><span style="color:#F97583;">||case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> usename </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NULL&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> usename::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end||</span><span style="color:#9ECBFF;">&#39; , Database: &#39;</span><span style="color:#F97583;">||case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> datname </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NULL&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> datname::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end||</span><span style="color:#9ECBFF;">&#39; , Client_Addr: &#39;</span><span style="color:#F97583;">||case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> client_addr </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NULL&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> client_addr::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end||</span><span style="color:#9ECBFF;">&#39; , Client_Port: &#39;</span><span style="color:#F97583;">||case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> client_port </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NULL&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> client_port::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end||</span><span style="color:#9ECBFF;">&#39; , Application_Name: &#39;</span><span style="color:#F97583;">||case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> application_name </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NULL&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> application_name::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end||</span><span style="color:#E1E4E8;">chr(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#9ECBFF;">&#39;Xact_Start: &#39;</span><span style="color:#F97583;">||case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> xact_start </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NULL&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> xact_start::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end||</span><span style="color:#9ECBFF;">&#39; , Query_Start: &#39;</span><span style="color:#F97583;">||case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> query_start </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NULL&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> query_start::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end||</span><span style="color:#9ECBFF;">&#39; , Xact_Elapse: &#39;</span><span style="color:#F97583;">||case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">xact_start) </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NULL&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">xact_start)::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end||</span><span style="color:#9ECBFF;">&#39; , Query_Elapse: &#39;</span><span style="color:#F97583;">||case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">query_start) </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NULL&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">query_start)::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end||</span><span style="color:#E1E4E8;">chr(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#9ECBFF;">&#39;SQL (Current SQL in Transaction): &#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">chr(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> query </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NULL&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> query::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">,    </span></span>
<span class="line"><span style="color:#E1E4E8;">chr(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;">&#39;--------&#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">chr(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">)    </span></span>
<span class="line"><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">  (  </span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> mode    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;INVALID&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;AccessShareLock&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;RowShareLock&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;RowExclusiveLock&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ShareUpdateExclusiveLock&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ShareLock&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ShareRowExclusiveLock&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ExclusiveLock&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;AccessExclusiveLock&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">  ) </span><span style="color:#F97583;">desc</span><span style="color:#E1E4E8;">,   </span></span>
<span class="line"><span style="color:#E1E4E8;">  (</span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> granted </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">)  </span></span>
<span class="line"><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> lock_conflict  </span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> t_unionall   </span></span>
<span class="line"><span style="color:#F97583;">group by</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">locktype,datname,relation,</span><span style="color:#F97583;">page</span><span style="color:#E1E4E8;">,tuple,virtualxid,transactionid::</span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">,classid,</span><span style="color:#F97583;">objid</span><span style="color:#E1E4E8;">,objsubid ;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">view</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">v_locks_monitor</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#D73A49;">with</span><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">t_wait </span><span style="color:#D73A49;">as</span><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">(    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mode</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">locktype</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relation</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tuple</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">classid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">granted</span><span style="color:#24292E;">,   </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objsubid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">virtualtransaction</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">virtualxid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transactionid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fastpath</span><span style="color:#24292E;">,    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">state</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xact_start</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_start</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">usename</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">datname</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">client_addr</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">client_port</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">application_name</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_locks a,pg_stat_activity b </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">granted</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">),   </span></span>
<span class="line"><span style="color:#24292E;">t_run </span><span style="color:#D73A49;">as</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">(   </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mode</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">locktype</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relation</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tuple</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">classid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">granted</span><span style="color:#24292E;">,   </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objsubid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">virtualtransaction</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">virtualxid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transactionid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fastpath</span><span style="color:#24292E;">,   </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">state</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xact_start</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_start</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">usename</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">datname</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">client_addr</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">client_port</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">application_name</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_locks a,pg_stat_activity b </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">granted</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">),   </span></span>
<span class="line"><span style="color:#24292E;">t_overlap </span><span style="color:#D73A49;">as</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">(   </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> r.</span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> t_wait w </span><span style="color:#D73A49;">join</span><span style="color:#24292E;"> t_run r </span><span style="color:#D73A49;">on</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">  (   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">locktype</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">locktype</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relation</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relation</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tuple</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tuple</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">virtualxid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">virtualxid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transactionid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transactionid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">classid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">classid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objsubid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objsubid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">  )    </span></span>
<span class="line"><span style="color:#24292E;">),    </span></span>
<span class="line"><span style="color:#24292E;">t_unionall </span><span style="color:#D73A49;">as</span><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">(    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> r.</span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> t_overlap r    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">union all</span><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> w.</span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> t_wait w    </span></span>
<span class="line"><span style="color:#24292E;">)    </span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> locktype,datname,relation::regclass,</span><span style="color:#D73A49;">page</span><span style="color:#24292E;">,tuple,virtualxid,transactionid::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">,classid::regclass,</span><span style="color:#D73A49;">objid</span><span style="color:#24292E;">,objsubid,   </span></span>
<span class="line"><span style="color:#005CC5;">string_agg</span><span style="color:#24292E;">(   </span></span>
<span class="line"><span style="color:#032F62;">&#39;Pid: &#39;</span><span style="color:#D73A49;">||case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> pid </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NULL&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> pid::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end||</span><span style="color:#24292E;">chr(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">||</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#032F62;">&#39;Lock_Granted: &#39;</span><span style="color:#D73A49;">||case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> granted </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NULL&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> granted::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end||</span><span style="color:#032F62;">&#39; , Mode: &#39;</span><span style="color:#D73A49;">||case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> mode </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NULL&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> mode::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end||</span><span style="color:#032F62;">&#39; , FastPath: &#39;</span><span style="color:#D73A49;">||case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> fastpath </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NULL&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> fastpath::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end||</span><span style="color:#032F62;">&#39; , VirtualTransaction: &#39;</span><span style="color:#D73A49;">||case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> virtualtransaction </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NULL&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> virtualtransaction::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end||</span><span style="color:#032F62;">&#39; , Session_State: &#39;</span><span style="color:#D73A49;">||case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">state</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NULL&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">state</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end||</span><span style="color:#24292E;">chr(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">||</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#032F62;">&#39;Username: &#39;</span><span style="color:#D73A49;">||case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> usename </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NULL&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> usename::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end||</span><span style="color:#032F62;">&#39; , Database: &#39;</span><span style="color:#D73A49;">||case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> datname </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NULL&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> datname::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end||</span><span style="color:#032F62;">&#39; , Client_Addr: &#39;</span><span style="color:#D73A49;">||case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> client_addr </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NULL&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> client_addr::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end||</span><span style="color:#032F62;">&#39; , Client_Port: &#39;</span><span style="color:#D73A49;">||case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> client_port </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NULL&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> client_port::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end||</span><span style="color:#032F62;">&#39; , Application_Name: &#39;</span><span style="color:#D73A49;">||case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> application_name </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NULL&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> application_name::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end||</span><span style="color:#24292E;">chr(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">||</span><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#032F62;">&#39;Xact_Start: &#39;</span><span style="color:#D73A49;">||case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> xact_start </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NULL&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> xact_start::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end||</span><span style="color:#032F62;">&#39; , Query_Start: &#39;</span><span style="color:#D73A49;">||case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> query_start </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NULL&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> query_start::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end||</span><span style="color:#032F62;">&#39; , Xact_Elapse: &#39;</span><span style="color:#D73A49;">||case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">now</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">xact_start) </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NULL&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">now</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">xact_start)::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end||</span><span style="color:#032F62;">&#39; , Query_Elapse: &#39;</span><span style="color:#D73A49;">||case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">now</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">query_start) </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NULL&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">now</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">query_start)::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end||</span><span style="color:#24292E;">chr(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">||</span><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#032F62;">&#39;SQL (Current SQL in Transaction): &#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;">chr(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">||</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> query </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NULL&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> query::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">,    </span></span>
<span class="line"><span style="color:#24292E;">chr(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">||</span><span style="color:#032F62;">&#39;--------&#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;">chr(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">)    </span></span>
<span class="line"><span style="color:#D73A49;">order by</span><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">  (  </span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> mode    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;INVALID&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;AccessShareLock&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;RowShareLock&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;RowExclusiveLock&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ShareUpdateExclusiveLock&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ShareLock&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ShareRowExclusiveLock&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ExclusiveLock&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;AccessExclusiveLock&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">  ) </span><span style="color:#D73A49;">desc</span><span style="color:#24292E;">,   </span></span>
<span class="line"><span style="color:#24292E;">  (</span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> granted </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">)  </span></span>
<span class="line"><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> lock_conflict  </span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> t_unionall   </span></span>
<span class="line"><span style="color:#D73A49;">group by</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">locktype,datname,relation,</span><span style="color:#D73A49;">page</span><span style="color:#24292E;">,tuple,virtualxid,transactionid::</span><span style="color:#D73A49;">text</span><span style="color:#24292E;">,classid,</span><span style="color:#D73A49;">objid</span><span style="color:#24292E;">,objsubid ;</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">#   \\x  </span></span>
<span class="line"><span style="color:#E1E4E8;">Expanded display </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;">.  </span></span>
<span class="line"><span style="color:#E1E4E8;">pos</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> v_locks_monitor ;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">#   \\x  </span></span>
<span class="line"><span style="color:#24292E;">Expanded display </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">on</span><span style="color:#24292E;">.  </span></span>
<span class="line"><span style="color:#24292E;">pos</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> v_locks_monitor ;</span></span></code></pre></div><h2 id="_1-4查看当前连接数" tabindex="-1">1.4查看当前连接数 <a class="header-anchor" href="#_1-4查看当前连接数" aria-label="Permalink to &quot;1.4查看当前连接数&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">#查看配置文件大小</span></span>
<span class="line"><span style="color:#E1E4E8;">show max_connections;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">count</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">), usename </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity </span><span style="color:#F97583;">group by</span><span style="color:#E1E4E8;"> usename;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#或者</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> pg_stat_activity;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">COUNT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> min_val, max_val </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_settings </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name=</span><span style="color:#9ECBFF;">&#39;max_connections&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">#查看配置文件大小</span></span>
<span class="line"><span style="color:#24292E;">show max_connections;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">count</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">), usename </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity </span><span style="color:#D73A49;">group by</span><span style="color:#24292E;"> usename;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#或者</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> pg_stat_activity;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">COUNT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> min_val, max_val </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_settings </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name=</span><span style="color:#032F62;">&#39;max_connections&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="查询空闲连接" tabindex="-1">查询空闲连接 <a class="header-anchor" href="#查询空闲连接" aria-label="Permalink to &quot;查询空闲连接&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pid, </span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity ;</span></span>
<span class="line"><span style="color:#E1E4E8;">  pid  | </span><span style="color:#F97583;">state</span></span>
<span class="line"><span style="color:#6A737D;">-------+--------</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">7229</span><span style="color:#E1E4E8;"> |</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">7232</span><span style="color:#E1E4E8;"> |</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">13307</span><span style="color:#E1E4E8;"> | idle</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">15853</span><span style="color:#E1E4E8;"> | idle</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16566</span><span style="color:#E1E4E8;"> | active</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">30648</span><span style="color:#E1E4E8;"> | idle</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18090</span><span style="color:#E1E4E8;"> | idle</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10438</span><span style="color:#E1E4E8;"> | idle</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">17360</span><span style="color:#E1E4E8;"> | idle</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">24003</span><span style="color:#E1E4E8;"> | idle</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#E1E4E8;">#查询下</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_settings </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;idle_in_transaction_session_timeout&#39;</span><span style="color:#E1E4E8;"> \\gx</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">----设置释放空闲事务退出时间</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">alter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">system</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> idle_in_transaction_session_timeout</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">30000</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pid, </span><span style="color:#D73A49;">state</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity ;</span></span>
<span class="line"><span style="color:#24292E;">  pid  | </span><span style="color:#D73A49;">state</span></span>
<span class="line"><span style="color:#6A737D;">-------+--------</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">7229</span><span style="color:#24292E;"> |</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">7232</span><span style="color:#24292E;"> |</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">13307</span><span style="color:#24292E;"> | idle</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">15853</span><span style="color:#24292E;"> | idle</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">16566</span><span style="color:#24292E;"> | active</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">30648</span><span style="color:#24292E;"> | idle</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">18090</span><span style="color:#24292E;"> | idle</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">10438</span><span style="color:#24292E;"> | idle</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">17360</span><span style="color:#24292E;"> | idle</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">24003</span><span style="color:#24292E;"> | idle</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#24292E;">#查询下</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_settings </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;idle_in_transaction_session_timeout&#39;</span><span style="color:#24292E;"> \\gx</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">----设置释放空闲事务退出时间</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">alter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">system</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> idle_in_transaction_session_timeout</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">30000</span></span></code></pre></div><h1 id="_2-日常清理" tabindex="-1">2，日常清理 <a class="header-anchor" href="#_2-日常清理" aria-label="Permalink to &quot;2，日常清理&quot;">​</a></h1><p><a href="https://www.modb.pro/db/7855" target="_blank" rel="noreferrer">https://www.modb.pro/db/7855</a></p><h2 id="_2-1日常清理-vacuum" tabindex="-1">2.1日常清理（VACUUM） <a class="header-anchor" href="#_2-1日常清理-vacuum" aria-label="Permalink to &quot;2.1日常清理（VACUUM）&quot;">​</a></h2><p>在PostgreSQL中，使用delete和update语句删除或更新的数据行并没有被实际删除，而只是在旧版本数据行的物理地址上将该行的状态置为已删除或已过期。因此当数据表中的数据变化极为频繁时，那么在一段时间之后该表所占用的空间将会变得很大，然而数据量却可能变化不大。要解决该问题，需要定期对数据变化频繁的数据表执行VACUUM操作</p><p>VACUUM的变体：标准VACUUM和VACUUM FULL。</p><p>VACUUM FULL可以收回更多磁盘空间但是运行起来更慢。VACUUM FULL要求在其工作的表上得到一个排他锁，因此无法和对此表的其他使用并行。 标准形式的VACUUM可以和生产数据库操作并行运行（SELECT、INSERT、UPDATE和DELETE等命令将继续正常工作，但在清理期间你无法使ALTER TABLE。</p><p>VACUUM[( { FULL | FREEZE | VERBOSE | ANALYZE| DISABLE_ PAGE_ SKIPPING }[,..] )][ table_ name [ (column_ name [,..] ) ]]</p><p>VACUUM[ FULL ][ FREEZE ] [ VERBOSE ] [ table_ name ]</p><p>VACUUM [ FULL][ FREEZE ][ VERBOSE ] ANALYZE [ table name [ (column name[...])]]</p><p>FULL ------选择&quot;完全&quot;清理，这样可以恢复更多的空间， 但是花的时间更多并且在表上施加了排它锁。</p><p>FREEZE ---------选择激进的元组&quot;冻结&quot;。</p><p>VERBOSE --------- 为每个表打印一份详细的清理工作报告。</p><p>ANALYZE --------- 更新用于优化器的统计信息，以决定执行查询的最有效方法。</p><p>table ------- 要清理的表的名称（可以有模式修饰）。缺省时是当前数据库中的所有表。</p><p>column ---------要分析的具体的列/字段名称。缺省是所有列/字段</p><h3 id="使用客户端vacuumdb命令" tabindex="-1">使用客户端vacuumdb命令 <a class="header-anchor" href="#使用客户端vacuumdb命令" aria-label="Permalink to &quot;使用客户端vacuumdb命令&quot;">​</a></h3><p>完全清理与统计更新postgres数据库。</p><p>[postgres@Redhat7 ~]$ vacuumdb --full --verbose --analyze postgres;</p><p>标准清理与统计更新postgres数据库。</p><p>[postgres@Redhat7 ~]$ vacuumdb --verbose --analyze postgres;</p><p>统计更新postgres数据库。</p><p>[postgres@Redhat7 ~]$ vacuumdb --verbose --analyze-only postgres;</p><p>完全清理与统计更新postgres数据库中的test1表。</p><p>[postgres@Redhat7 ~]$ vacuumdb --full --verbose --analyze test1;</p><p>vacuumdb: could not connect to database test1: FATAL: database &quot;test1&quot; does not exist</p><p>[postgres@Redhat7 ~]$ vacuumdb --full --verbose --analyze --table test1 postgres;</p><p>vacuumdb: vacuuming database &quot;postgres&quot;</p><p>INFO: vacuuming &quot;public.test1&quot;</p><p>INFO: &quot;test1&quot;: found 0 removable, 4194816 nonremovable row versions in 28343 pages</p><p>DETAIL: 0 dead row versions cannot be removed yet.</p><p>CPU: user: 0.74 s, system: 0.47 s, elapsed: 2.08 s.</p><p>INFO: analyzing &quot;public.test1&quot;</p><p>INFO: &quot;test1&quot;: scanned 22675 of 22675 pages, containing 4194816 live rows and 0 dead rows; 30000 rows in sample, 4194816 estimated total rows</p><p>[postgres@Redhat7 ~]$ vacuumdb --verbose --analyze-only --table test1 postgres;</p><p>vacuumdb: vacuuming database &quot;postgres&quot;</p><p>INFO: analyzing &quot;public.test1&quot;</p><p>INFO: &quot;test1&quot;: scanned 22675 of 22675 pages, containing 4194816 live rows and 0 dead rows; 30000 rows in sample, 4194816 estimated total rows</p><p>标准清理与统计更新postgres数据库中的test1表。</p><p>[postgres@Redhat7 ~]$ vacuumdb --verbose --analyze --table test1 postgres;</p><p>统计更新postgres数据库中的test1表。</p><p>[postgres@Redhat7 ~]$ vacuumdb --verbose --analyze-only --table test1 postgres;</p><p>vacuumdb: vacuuming database &quot;postgres&quot;</p><p>INFO: analyzing &quot;public.test1&quot;</p><p>INFO: &quot;test1&quot;: scanned 22675 of 22675 pages, containing 4194816 live rows and 0 dead rows; 30000 rows in sample, 4194816 estimated total rows</p><h3 id="psql-vacuum-命令" tabindex="-1">psql vacuum 命令 <a class="header-anchor" href="#psql-vacuum-命令" aria-label="Permalink to &quot;psql vacuum 命令&quot;">​</a></h3><p>完全清理并统计更新数据库</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# vacuum full verbose  analyze;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# vacuum full verbose  analyze;</span></span></code></pre></div><p>标准清理并统计更新数据库</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# vacuum  verbose  analyze;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# vacuum  verbose  analyze;</span></span></code></pre></div><p>统计更新数据库</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# analyze;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# analyze;</span></span></code></pre></div><p>ANALYZE</p><p>完全清理并统计更新表test1</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# vacuum full verbose  analyze  test1;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# vacuum full verbose  analyze  test1;</span></span></code></pre></div><p>标准清理并统计更新表test1</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# vacuum verbose  analyze  test1;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# vacuum verbose  analyze  test1;</span></span></code></pre></div><p>统计更新表</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# analyze test1;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">ANALYZE</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# analyze test1;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">ANALYZE</span></span></code></pre></div><h3 id="checkpoint" tabindex="-1">checkpoint <a class="header-anchor" href="#checkpoint" aria-label="Permalink to &quot;checkpoint&quot;">​</a></h3><p>checkpoint执行控制:</p><p>1,数据量达到checkpoint_segments*16M时，系统自动触发；</p><p>2,时间间隔达到checkpoint_timeout参数值时；</p><p>3,用户发出checkpoint命令时</p><h1 id="_3-查看postgresql数据库表大小及物理位置" tabindex="-1">3,查看Postgresql数据库表大小及物理位置 <a class="header-anchor" href="#_3-查看postgresql数据库表大小及物理位置" aria-label="Permalink to &quot;3,查看Postgresql数据库表大小及物理位置&quot;">​</a></h1><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">use_db=# create table emp1(id int,name char(10));</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">use_db=# insert into emp1 values (generate_series(1,100000),&#39;test&#39;);</span></span>
<span class="line"><span style="color:#e1e4e8;">INSERT 0 100000</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#查看单个表大小</span></span>
<span class="line"><span style="color:#e1e4e8;">use_db=# select pg_size_pretty(pg_relation_size(&#39;表名字&#39;));</span></span>
<span class="line"><span style="color:#e1e4e8;"> pg_size_pretty </span></span>
<span class="line"><span style="color:#e1e4e8;">----------------</span></span>
<span class="line"><span style="color:#e1e4e8;"> 43 MB</span></span>
<span class="line"><span style="color:#e1e4e8;">(1 row)</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#查看单个表位置</span></span>
<span class="line"><span style="color:#e1e4e8;">d_qe=# select pg_relation_filepath(&#39;表名字&#39;);</span></span>
<span class="line"><span style="color:#e1e4e8;"> pg_relation_filepath </span></span>
<span class="line"><span style="color:#e1e4e8;">----------------------</span></span>
<span class="line"><span style="color:#e1e4e8;"> base/16385/19800</span></span>
<span class="line"><span style="color:#e1e4e8;">(1 row)</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#查看物理位置</span></span>
<span class="line"><span style="color:#e1e4e8;">use_db=# \\! du -sh /usr/local/pg12/data/base/16384/25386</span></span>
<span class="line"><span style="color:#e1e4e8;">43M /usr/local/pg9.5.2/data/base/16384/25386</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#清空表</span></span>
<span class="line"><span style="color:#e1e4e8;">use_db=# truncate table 表名字;</span></span>
<span class="line"><span style="color:#e1e4e8;">TRUNCATE TABLE</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">use_db=# create table emp1(id int,name char(10));</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">use_db=# insert into emp1 values (generate_series(1,100000),&#39;test&#39;);</span></span>
<span class="line"><span style="color:#24292e;">INSERT 0 100000</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#查看单个表大小</span></span>
<span class="line"><span style="color:#24292e;">use_db=# select pg_size_pretty(pg_relation_size(&#39;表名字&#39;));</span></span>
<span class="line"><span style="color:#24292e;"> pg_size_pretty </span></span>
<span class="line"><span style="color:#24292e;">----------------</span></span>
<span class="line"><span style="color:#24292e;"> 43 MB</span></span>
<span class="line"><span style="color:#24292e;">(1 row)</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#查看单个表位置</span></span>
<span class="line"><span style="color:#24292e;">d_qe=# select pg_relation_filepath(&#39;表名字&#39;);</span></span>
<span class="line"><span style="color:#24292e;"> pg_relation_filepath </span></span>
<span class="line"><span style="color:#24292e;">----------------------</span></span>
<span class="line"><span style="color:#24292e;"> base/16385/19800</span></span>
<span class="line"><span style="color:#24292e;">(1 row)</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#查看物理位置</span></span>
<span class="line"><span style="color:#24292e;">use_db=# \\! du -sh /usr/local/pg12/data/base/16384/25386</span></span>
<span class="line"><span style="color:#24292e;">43M /usr/local/pg9.5.2/data/base/16384/25386</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#清空表</span></span>
<span class="line"><span style="color:#24292e;">use_db=# truncate table 表名字;</span></span>
<span class="line"><span style="color:#24292e;">TRUNCATE TABLE</span></span></code></pre></div><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--当前数据库服务器ip和port</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> inet_server_addr(),inet_server_port();</span></span>
<span class="line"><span style="color:#E1E4E8;"> inet_server_addr | inet_server_port </span></span>
<span class="line"><span style="color:#6A737D;">------------------+------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">127</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">        |             </span><span style="color:#79B8FF;">5532</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--当前数据库服务器ip和port</span></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> inet_server_addr(),inet_server_port();</span></span>
<span class="line"><span style="color:#24292E;"> inet_server_addr | inet_server_port </span></span>
<span class="line"><span style="color:#6A737D;">------------------+------------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">127</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">        |             </span><span style="color:#005CC5;">5532</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span></code></pre></div><h1 id="_4-postgresql数据库统计对象大小" tabindex="-1">4.postgresql数据库统计对象大小 <a class="header-anchor" href="#_4-postgresql数据库统计对象大小" aria-label="Permalink to &quot;4.postgresql数据库统计对象大小&quot;">​</a></h1><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--查看数据库大小，不计算索引</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_size_pretty(pg_database_size(</span><span style="color:#9ECBFF;">&#39;mydb&#39;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看数据库大小，包含索引</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_size_pretty(pg_total_size(</span><span style="color:#9ECBFF;">&#39;mydb&#39;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看表中索引大小</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_size_pretty(pg_indexes_size(</span><span style="color:#9ECBFF;">&#39;table_name&#39;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看表大小,不包括索引</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_size_pretty(pg_relation_size(</span><span style="color:#9ECBFF;">&#39;test_1&#39;</span><span style="color:#E1E4E8;">));  </span></span>
<span class="line"><span style="color:#6A737D;">--or</span></span>
<span class="line"><span style="color:#E1E4E8;">\\dt</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> test_1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看表大小,包括索引</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_size_pretty(pg_total_relation_size(</span><span style="color:#9ECBFF;">&#39;test_1&#39;</span><span style="color:#E1E4E8;">));  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看某个模式大小，包括索引。不包括索引可用pg_relation_size</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> schemaname,</span><span style="color:#79B8FF;">round</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sum</span><span style="color:#E1E4E8;">(pg_total_relation_size(schemaname</span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">tablename))</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1024</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">) </span><span style="color:#9ECBFF;">&quot;Mb&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_tables </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> schemaname</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;mysch&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">group by</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看表空间大小</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_size_pretty(pg_tablespace_size(</span><span style="color:#9ECBFF;">&#39;pg_global&#39;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看表对应的数据文件</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_relation_filepath(</span><span style="color:#9ECBFF;">&#39;test_1&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--切换log日志文件到下一个</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_rotate_logfile();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--切换日志</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_switch_xlog();</span></span>
<span class="line"><span style="color:#F97583;">checkpoint</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--查看数据库大小，不计算索引</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_size_pretty(pg_database_size(</span><span style="color:#032F62;">&#39;mydb&#39;</span><span style="color:#24292E;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看数据库大小，包含索引</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_size_pretty(pg_total_size(</span><span style="color:#032F62;">&#39;mydb&#39;</span><span style="color:#24292E;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看表中索引大小</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_size_pretty(pg_indexes_size(</span><span style="color:#032F62;">&#39;table_name&#39;</span><span style="color:#24292E;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看表大小,不包括索引</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_size_pretty(pg_relation_size(</span><span style="color:#032F62;">&#39;test_1&#39;</span><span style="color:#24292E;">));  </span></span>
<span class="line"><span style="color:#6A737D;">--or</span></span>
<span class="line"><span style="color:#24292E;">\\dt</span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> test_1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看表大小,包括索引</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_size_pretty(pg_total_relation_size(</span><span style="color:#032F62;">&#39;test_1&#39;</span><span style="color:#24292E;">));  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看某个模式大小，包括索引。不包括索引可用pg_relation_size</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> schemaname,</span><span style="color:#005CC5;">round</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sum</span><span style="color:#24292E;">(pg_total_relation_size(schemaname</span><span style="color:#D73A49;">||</span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;">tablename))</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1024</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">) </span><span style="color:#032F62;">&quot;Mb&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_tables </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> schemaname</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;mysch&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">group by</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看表空间大小</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_size_pretty(pg_tablespace_size(</span><span style="color:#032F62;">&#39;pg_global&#39;</span><span style="color:#24292E;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看表对应的数据文件</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_relation_filepath(</span><span style="color:#032F62;">&#39;test_1&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--切换log日志文件到下一个</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_rotate_logfile();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--切换日志</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_switch_xlog();</span></span>
<span class="line"><span style="color:#D73A49;">checkpoint</span></span></code></pre></div><table><thead><tr><th><strong>函数名</strong></th><th><strong>返回类型</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td>pg_column_size(any)</td><td>int</td><td>存储一个指定的数值需要的字节数（可能压缩过）</td></tr><tr><td>pg_database_size(oid)</td><td>bigint</td><td>指定OID的数据库使用的磁盘空间</td></tr><tr><td>pg_database_size(name)</td><td>bigint</td><td>指定名称的数据库使用的磁盘空间</td></tr><tr><td>pg_indexes_size(regclass)</td><td>bigint</td><td>关联指定表OID或表名的表索引的使用总磁盘空间</td></tr><tr><td>pg_relation_size(relation regclass, fork text)</td><td>bigint</td><td>指定OID或名的表或索引，通过指定fork(&#39;main&#39;, &#39;fsm&#39; 或&#39;vm&#39;)所使用的磁盘空间</td></tr><tr><td>pg_relation_size(relation regclass)</td><td>bigint</td><td><code>pg_relation_size(..., &#39;main&#39;)的缩写</code></td></tr><tr><td>pg_size_pretty(bigint)</td><td>text</td><td>Converts a size in bytes expressed as a 64-bit integer into a human-readable format with size units</td></tr><tr><td>pg_size_pretty(numeric)</td><td>text</td><td>把以字节计算的数值转换成一个人类易读的尺寸单位</td></tr><tr><td>pg_table_size(regclass)</td><td>bigint</td><td>指定表OID或表名的表使用的磁盘空间，除去索引（但是包含TOAST，自由空间映射和可视映射）</td></tr><tr><td>pg_tablespace_size(oid)</td><td>bigint</td><td>指定OID的表空间使用的磁盘空间</td></tr><tr><td>pg_tablespace_size(name)</td><td>bigint</td><td>指定名称的表空间使用的磁盘空间</td></tr><tr><td>pg_total_relation_size(regclass)</td><td>bigint</td><td>指定表OID或表名使用的总磁盘空间，包括所有索引和TOAST数据</td></tr></tbody></table><h2 id="_4-1-查询数据库大小" tabindex="-1">4.1 查询数据库大小 <a class="header-anchor" href="#_4-1-查询数据库大小" aria-label="Permalink to &quot;4.1 查询数据库大小&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--查询数据库大小</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> datname,pg_size_pretty(pg_database_size(datname)) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_database;</span></span>
<span class="line"><span style="color:#E1E4E8;">  datname  | pg_size_pretty </span></span>
<span class="line"><span style="color:#6A737D;">-----------+----------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> postgres  | </span><span style="color:#79B8FF;">8033</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> han_db    | </span><span style="color:#79B8FF;">7993</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> template1 | </span><span style="color:#79B8FF;">7825</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> template0 | </span><span style="color:#79B8FF;">7825</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> test      | </span><span style="color:#79B8FF;">7993</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;"> test01    | </span><span style="color:#79B8FF;">7993</span><span style="color:#E1E4E8;"> kB</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--或者</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">datname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Name</span><span style="color:#E1E4E8;">,  </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_get_userbyid</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">datdba</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Owner</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">has_database_privilege</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">datname</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;CONNECT&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_size_pretty</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_database_size</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">datname</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;No Access&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SIZE</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_database</span><span style="color:#E1E4E8;"> d</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">ORDER BY</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">has_database_privilege</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">datname</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;CONNECT&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_database_size</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">datname</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- nulls first</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">LIMIT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;"> ;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--查询数据库大小</span></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> datname,pg_size_pretty(pg_database_size(datname)) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_database;</span></span>
<span class="line"><span style="color:#24292E;">  datname  | pg_size_pretty </span></span>
<span class="line"><span style="color:#6A737D;">-----------+----------------</span></span>
<span class="line"><span style="color:#24292E;"> postgres  | </span><span style="color:#005CC5;">8033</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> han_db    | </span><span style="color:#005CC5;">7993</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> template1 | </span><span style="color:#005CC5;">7825</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> template0 | </span><span style="color:#005CC5;">7825</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> test      | </span><span style="color:#005CC5;">7993</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;"> test01    | </span><span style="color:#005CC5;">7993</span><span style="color:#24292E;"> kB</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--或者</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">datname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Name</span><span style="color:#24292E;">,  </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_get_userbyid</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">datdba</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Owner</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">has_database_privilege</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">datname</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;CONNECT&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_size_pretty</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_database_size</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">datname</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;No Access&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">SIZE</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_database</span><span style="color:#24292E;"> d</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">ORDER BY</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">has_database_privilege</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">datname</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;CONNECT&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_database_size</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">datname</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NULL</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- nulls first</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">LIMIT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span><span style="color:#24292E;"> ;</span></span></code></pre></div><h2 id="_4-2-查看表大小" tabindex="-1">4.2 查看表大小 <a class="header-anchor" href="#_4-2-查看表大小" aria-label="Permalink to &quot;4.2 查看表大小&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--默认只列出当前模式下的表</span></span>
<span class="line"><span style="color:#E1E4E8;">\\d</span></span>
<span class="line"><span style="color:#6A737D;">--列出常用模式</span></span>
<span class="line"><span style="color:#E1E4E8;">\\dn</span></span>
<span class="line"><span style="color:#6A737D;">--列出所有模式</span></span>
<span class="line"><span style="color:#E1E4E8;">\\dnS</span></span>
<span class="line"><span style="color:#6A737D;">--查看表的大小</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">test01</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_size_pretty(pg_relation_size(</span><span style="color:#9ECBFF;">&#39;table_name&#39;</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;"> pg_size_pretty </span></span>
<span class="line"><span style="color:#6A737D;">----------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8192</span><span style="color:#E1E4E8;"> bytes</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--或者</span></span>
<span class="line"><span style="color:#E1E4E8;">test01</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># \\dt</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                      List of relations</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Schema</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">Name</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">Type</span><span style="color:#E1E4E8;">  |  </span><span style="color:#F97583;">Owner</span><span style="color:#E1E4E8;">   |    </span><span style="color:#F97583;">Size</span><span style="color:#E1E4E8;">    | </span><span style="color:#F97583;">Description</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">--------+------+-------+----------+------------+-------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> public | adg  | </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> | postgres | </span><span style="color:#79B8FF;">8192</span><span style="color:#E1E4E8;"> bytes | </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--info</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">n</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nspname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Schema&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Name&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relkind</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;r&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;table&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;v&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;view&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;m&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;materialized view&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;i&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;index&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;S&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;sequence&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;s&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;special&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;f&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;foreign table&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;p&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;table&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Type&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_get_userbyid</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relowner</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Owner&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_size_pretty</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_table_size</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Size&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">obj_description</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;pg_class&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Description&quot;</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_class</span><span style="color:#E1E4E8;"> c</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_namespace</span><span style="color:#E1E4E8;"> n </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">n</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relnamespace</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relkind</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;r&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;p&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;s&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">n</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nspname</span><span style="color:#E1E4E8;"> !~ </span><span style="color:#9ECBFF;">&#39;^pg_toast&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relname</span><span style="color:#E1E4E8;"> OPERATOR(pg_catalog.~) </span><span style="color:#9ECBFF;">&#39;^(test)$&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_table_is_visible</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--默认只列出当前模式下的表</span></span>
<span class="line"><span style="color:#24292E;">\\d</span></span>
<span class="line"><span style="color:#6A737D;">--列出常用模式</span></span>
<span class="line"><span style="color:#24292E;">\\dn</span></span>
<span class="line"><span style="color:#6A737D;">--列出所有模式</span></span>
<span class="line"><span style="color:#24292E;">\\dnS</span></span>
<span class="line"><span style="color:#6A737D;">--查看表的大小</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">test01</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_size_pretty(pg_relation_size(</span><span style="color:#032F62;">&#39;table_name&#39;</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;"> pg_size_pretty </span></span>
<span class="line"><span style="color:#6A737D;">----------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">8192</span><span style="color:#24292E;"> bytes</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--或者</span></span>
<span class="line"><span style="color:#24292E;">test01</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># \\dt</span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                      List of relations</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">Schema</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">Name</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">Type</span><span style="color:#24292E;">  |  </span><span style="color:#D73A49;">Owner</span><span style="color:#24292E;">   |    </span><span style="color:#D73A49;">Size</span><span style="color:#24292E;">    | </span><span style="color:#D73A49;">Description</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">--------+------+-------+----------+------------+-------------</span></span>
<span class="line"><span style="color:#24292E;"> public | adg  | </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> | postgres | </span><span style="color:#005CC5;">8192</span><span style="color:#24292E;"> bytes | </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--info</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">n</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nspname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Schema&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Name&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relkind</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;r&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;table&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;v&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;view&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;m&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;materialized view&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;i&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;index&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;S&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;sequence&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;s&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;special&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;f&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;foreign table&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;p&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;table&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Type&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_get_userbyid</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relowner</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Owner&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_size_pretty</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_table_size</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Size&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">obj_description</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;pg_class&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Description&quot;</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_class</span><span style="color:#24292E;"> c</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_namespace</span><span style="color:#24292E;"> n </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">n</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relnamespace</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relkind</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;r&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;p&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;s&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">n</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nspname</span><span style="color:#24292E;"> !~ </span><span style="color:#032F62;">&#39;^pg_toast&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relname</span><span style="color:#24292E;"> OPERATOR(pg_catalog.~) </span><span style="color:#032F62;">&#39;^(test)$&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_table_is_visible</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">;</span></span></code></pre></div><p><strong>-- 查看当前库sehcma大小,并按schema大小排序</strong></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> schema_name, </span></span>
<span class="line"><span style="color:#E1E4E8;">    pg_size_pretty(</span><span style="color:#79B8FF;">sum</span><span style="color:#E1E4E8;">(table_size)::</span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;disk space&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">round</span><span style="color:#E1E4E8;">((</span><span style="color:#79B8FF;">sum</span><span style="color:#E1E4E8;">(table_size) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> pg_database_size(current_database())) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;percent(%)&quot;</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_namespace</span><span style="color:#E1E4E8;">.nspname </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> schema_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">         pg_total_relation_size(</span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_class</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> table_size</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_class</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_namespace</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> relnamespace </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_namespace</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">oid</span></span>
<span class="line"><span style="color:#E1E4E8;">) t</span></span>
<span class="line"><span style="color:#F97583;">GROUP BY</span><span style="color:#E1E4E8;"> schema_name</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;percent(%)&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">desc</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> schema_name, </span></span>
<span class="line"><span style="color:#24292E;">    pg_size_pretty(</span><span style="color:#005CC5;">sum</span><span style="color:#24292E;">(table_size)::</span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;disk space&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">round</span><span style="color:#24292E;">((</span><span style="color:#005CC5;">sum</span><span style="color:#24292E;">(table_size) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> pg_database_size(current_database())) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;percent(%)&quot;</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_namespace</span><span style="color:#24292E;">.nspname </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> schema_name,</span></span>
<span class="line"><span style="color:#24292E;">         pg_total_relation_size(</span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_class</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> table_size</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_class</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_namespace</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> relnamespace </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_namespace</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">oid</span></span>
<span class="line"><span style="color:#24292E;">) t</span></span>
<span class="line"><span style="color:#D73A49;">GROUP BY</span><span style="color:#24292E;"> schema_name</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;percent(%)&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">desc</span><span style="color:#24292E;">;</span></span></code></pre></div><p><strong>-- 查看当前库中所有表大小,并按降序排列</strong></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">    table_catalog </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database_name</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    table_schema </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> schema_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">    table_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">    pg_size_pretty(relation_size) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> table_size</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">        table_catalog,</span></span>
<span class="line"><span style="color:#E1E4E8;">        table_schema,</span></span>
<span class="line"><span style="color:#E1E4E8;">        table_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">        pg_total_relation_size((</span><span style="color:#9ECBFF;">&#39;&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> table_schema </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&quot;.&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> table_name </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&quot;&#39;</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> relation_size</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">information_schema</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tables</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> table_schema </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;pg_catalog&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;public&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;public_rb&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;topology&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;tiger&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;tiger_data&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;information_schema&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> relation_size </span><span style="color:#F97583;">DESC</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> all_tables</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> relation_size </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1073741824</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">    table_catalog </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database_name</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    table_schema </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> schema_name,</span></span>
<span class="line"><span style="color:#24292E;">    table_name,</span></span>
<span class="line"><span style="color:#24292E;">    pg_size_pretty(relation_size) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> table_size</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">        table_catalog,</span></span>
<span class="line"><span style="color:#24292E;">        table_schema,</span></span>
<span class="line"><span style="color:#24292E;">        table_name,</span></span>
<span class="line"><span style="color:#24292E;">        pg_total_relation_size((</span><span style="color:#032F62;">&#39;&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> table_schema </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&quot;.&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> table_name </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&quot;&#39;</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> relation_size</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">information_schema</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tables</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> table_schema </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;pg_catalog&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;public&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;public_rb&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;topology&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;tiger&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;tiger_data&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;information_schema&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> relation_size </span><span style="color:#D73A49;">DESC</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> all_tables</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> relation_size </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1073741824</span><span style="color:#24292E;">;</span></span></code></pre></div><p>或者</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 查看当前库中所有表大小</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">    table_schema </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> table_name </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> table_full_name,</span></span>
<span class="line"><span style="color:#E1E4E8;">    pg_size_pretty(pg_total_relation_size(</span><span style="color:#9ECBFF;">&#39;&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> table_schema </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&quot;.&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> table_name </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&quot;&#39;</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">size</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">information_schema</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tables</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span></span>
<span class="line"><span style="color:#E1E4E8;">    pg_total_relation_size(</span><span style="color:#9ECBFF;">&#39;&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> table_schema </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&quot;.&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> table_name </span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&quot;&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;"> ;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 查看当前库中所有表大小</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">    table_schema </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> table_name </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> table_full_name,</span></span>
<span class="line"><span style="color:#24292E;">    pg_size_pretty(pg_total_relation_size(</span><span style="color:#032F62;">&#39;&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> table_schema </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&quot;.&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> table_name </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&quot;&#39;</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">size</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">information_schema</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tables</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span></span>
<span class="line"><span style="color:#24292E;">    pg_total_relation_size(</span><span style="color:#032F62;">&#39;&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> table_schema </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&quot;.&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> table_name </span><span style="color:#D73A49;">||</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&quot;&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;"> ;</span></span></code></pre></div><h2 id="_4-3-查看模式大小-表-索引" tabindex="-1">4.3 查看模式大小,表，索引 <a class="header-anchor" href="#_4-3-查看模式大小-表-索引" aria-label="Permalink to &quot;4.3 查看模式大小,表，索引&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--查看模式大小,表，索引</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> schemaname ,</span><span style="color:#79B8FF;">round</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sum</span><span style="color:#E1E4E8;">(pg_total_relation_size(schemaname</span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">tablename))</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1024</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">) </span><span style="color:#9ECBFF;">&quot;Size_MB&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_tables </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> schemaname</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;public&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">group by</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> schemaname ,</span><span style="color:#79B8FF;">round</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sum</span><span style="color:#E1E4E8;">(pg_total_relation_size(schemaname</span><span style="color:#F97583;">||</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">indexname))</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1024</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">) </span><span style="color:#9ECBFF;">&quot;Size_MB&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_indexes </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> schemaname</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;public&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">group by</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--查看模式大小,表，索引</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> schemaname ,</span><span style="color:#005CC5;">round</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sum</span><span style="color:#24292E;">(pg_total_relation_size(schemaname</span><span style="color:#D73A49;">||</span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;">tablename))</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1024</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">) </span><span style="color:#032F62;">&quot;Size_MB&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_tables </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> schemaname</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;public&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">group by</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> schemaname ,</span><span style="color:#005CC5;">round</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sum</span><span style="color:#24292E;">(pg_total_relation_size(schemaname</span><span style="color:#D73A49;">||</span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#D73A49;">||</span><span style="color:#24292E;">indexname))</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1024</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">) </span><span style="color:#032F62;">&quot;Size_MB&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_indexes </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> schemaname</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;public&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">group by</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span></code></pre></div><h2 id="_4-4修改表名字" tabindex="-1">4.4修改表名字 <a class="header-anchor" href="#_4-4修改表名字" aria-label="Permalink to &quot;4.4修改表名字&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">alter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;">  old_test rename </span><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> test_new;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">alter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;">  old_test rename </span><span style="color:#D73A49;">to</span><span style="color:#24292E;"> test_new;</span></span></code></pre></div><h2 id="_4-5查看oid" tabindex="-1">4.5查看oid <a class="header-anchor" href="#_4-5查看oid" aria-label="Permalink to &quot;4.5查看oid&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">han</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_relation_filepath(</span><span style="color:#9ECBFF;">&#39;test&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;"> pg_relation_filepath </span></span>
<span class="line"><span style="color:#6A737D;">----------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> base</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">16388</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">16393</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">han</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_relation_filepath(</span><span style="color:#032F62;">&#39;test&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;"> pg_relation_filepath </span></span>
<span class="line"><span style="color:#6A737D;">----------------------</span></span>
<span class="line"><span style="color:#24292E;"> base</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">16388</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">16393</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span></code></pre></div><h1 id="_5-数据库管理相关" tabindex="-1">5，数据库管理相关 <a class="header-anchor" href="#_5-数据库管理相关" aria-label="Permalink to &quot;5，数据库管理相关&quot;">​</a></h1><p>--单用户启动 postgres --single -D /pgdata/10/data postgres</p><p>--单用户作用</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">当多用户模式不接收所有命令时，可以使用单用户连接到数据库</span></span>
<span class="line"><span style="color:#e1e4e8;">initdb的阶段</span></span>
<span class="line"><span style="color:#e1e4e8;">修复系统表</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">当多用户模式不接收所有命令时，可以使用单用户连接到数据库</span></span>
<span class="line"><span style="color:#24292e;">initdb的阶段</span></span>
<span class="line"><span style="color:#24292e;">修复系统表</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">--相关参数设置</span></span>
<span class="line"><span style="color:#e1e4e8;">select * from pg_settings;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--相关参数描述,单位</span></span>
<span class="line"><span style="color:#e1e4e8;">select name,short_desc,unit from pg_settings limit 4;</span></span>
<span class="line"><span style="color:#e1e4e8;">--参数类别</span></span>
<span class="line"><span style="color:#e1e4e8;">--internal:这些参数是只读参数，其中有些参数是postgres程序写死的。</span></span>
<span class="line"><span style="color:#e1e4e8;">--postmaster:改变这些参数值需要重启实例。</span></span>
<span class="line"><span style="color:#e1e4e8;">--sighup:在postgresql.conf文件中改变这些参数值，无需重启数据库，只需向postmater进程发送SIGHUP信号，让其重启装载配置新的参数值就可以了。</span></span>
<span class="line"><span style="color:#e1e4e8;">--backend:跟sighup类似，改变生效只适用于新的链接，已有连接中无效.select pg_reload_conf();</span></span>
<span class="line"><span style="color:#e1e4e8;">--superuser:这类参数可以由超级用户使用set改变，session级别。</span></span>
<span class="line"><span style="color:#e1e4e8;">--user:同supperuser类似。</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--查看参数修改是否需要重启</span></span>
<span class="line"><span style="color:#e1e4e8;">select name,context from pg_settings where name like &#39;wal_buffers&#39;;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--连接数据库的相关参数</span></span>
<span class="line"><span style="color:#e1e4e8;">max_connections:默认100，允许和数据库连接的最大并发连接数</span></span>
<span class="line"><span style="color:#e1e4e8;">superuser_reserved_connections:默认3，防止普通用户消耗掉所有连接，确保超级用户可以连接数据库。</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--空闲180秒后尝试连接，每隔10秒连接一次，最多连接三次，尝试失败后关闭连接</span></span>
<span class="line"><span style="color:#e1e4e8;">tcp_keepalives_idle=180</span></span>
<span class="line"><span style="color:#e1e4e8;">tcp_keepalives_interval=10</span></span>
<span class="line"><span style="color:#e1e4e8;">tcp_keepalives_count=3</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--内存配置</span></span>
<span class="line"><span style="color:#e1e4e8;">shared_buffers:通常设置系统内存的25%，max_connections(MB) 数值的两倍</span></span>
<span class="line"><span style="color:#e1e4e8;">temp_buffers:用于临时表</span></span>
<span class="line"><span style="color:#e1e4e8;">work_mem:排序、hash</span></span>
<span class="line"><span style="color:#e1e4e8;">maintenance_work_mem:维护操作中使用的最大内存</span></span>
<span class="line"><span style="color:#e1e4e8;">synchronous_commit:提交事务是否需要等wal日志写入磁盘再返回。默认on</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--日志相关</span></span>
<span class="line"><span style="color:#e1e4e8;">logging_collector=on --打开日志</span></span>
<span class="line"><span style="color:#e1e4e8;">log_min_duration_statement --如果如果某个sql运行大于多少毫秒，记录到日志</span></span>
<span class="line"><span style="color:#e1e4e8;">log_min_error_statement -- sql错误信息可以记录到日志中</span></span>
<span class="line"><span style="color:#e1e4e8;">log_statement  -- 是否记录ddl、dml等操作</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">--相关参数设置</span></span>
<span class="line"><span style="color:#24292e;">select * from pg_settings;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--相关参数描述,单位</span></span>
<span class="line"><span style="color:#24292e;">select name,short_desc,unit from pg_settings limit 4;</span></span>
<span class="line"><span style="color:#24292e;">--参数类别</span></span>
<span class="line"><span style="color:#24292e;">--internal:这些参数是只读参数，其中有些参数是postgres程序写死的。</span></span>
<span class="line"><span style="color:#24292e;">--postmaster:改变这些参数值需要重启实例。</span></span>
<span class="line"><span style="color:#24292e;">--sighup:在postgresql.conf文件中改变这些参数值，无需重启数据库，只需向postmater进程发送SIGHUP信号，让其重启装载配置新的参数值就可以了。</span></span>
<span class="line"><span style="color:#24292e;">--backend:跟sighup类似，改变生效只适用于新的链接，已有连接中无效.select pg_reload_conf();</span></span>
<span class="line"><span style="color:#24292e;">--superuser:这类参数可以由超级用户使用set改变，session级别。</span></span>
<span class="line"><span style="color:#24292e;">--user:同supperuser类似。</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--查看参数修改是否需要重启</span></span>
<span class="line"><span style="color:#24292e;">select name,context from pg_settings where name like &#39;wal_buffers&#39;;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--连接数据库的相关参数</span></span>
<span class="line"><span style="color:#24292e;">max_connections:默认100，允许和数据库连接的最大并发连接数</span></span>
<span class="line"><span style="color:#24292e;">superuser_reserved_connections:默认3，防止普通用户消耗掉所有连接，确保超级用户可以连接数据库。</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--空闲180秒后尝试连接，每隔10秒连接一次，最多连接三次，尝试失败后关闭连接</span></span>
<span class="line"><span style="color:#24292e;">tcp_keepalives_idle=180</span></span>
<span class="line"><span style="color:#24292e;">tcp_keepalives_interval=10</span></span>
<span class="line"><span style="color:#24292e;">tcp_keepalives_count=3</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--内存配置</span></span>
<span class="line"><span style="color:#24292e;">shared_buffers:通常设置系统内存的25%，max_connections(MB) 数值的两倍</span></span>
<span class="line"><span style="color:#24292e;">temp_buffers:用于临时表</span></span>
<span class="line"><span style="color:#24292e;">work_mem:排序、hash</span></span>
<span class="line"><span style="color:#24292e;">maintenance_work_mem:维护操作中使用的最大内存</span></span>
<span class="line"><span style="color:#24292e;">synchronous_commit:提交事务是否需要等wal日志写入磁盘再返回。默认on</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--日志相关</span></span>
<span class="line"><span style="color:#24292e;">logging_collector=on --打开日志</span></span>
<span class="line"><span style="color:#24292e;">log_min_duration_statement --如果如果某个sql运行大于多少毫秒，记录到日志</span></span>
<span class="line"><span style="color:#24292e;">log_min_error_statement -- sql错误信息可以记录到日志中</span></span>
<span class="line"><span style="color:#24292e;">log_statement  -- 是否记录ddl、dml等操作</span></span></code></pre></div><h2 id="常用管理命令" tabindex="-1">--常用管理命令 <a class="header-anchor" href="#常用管理命令" aria-label="Permalink to &quot;--常用管理命令&quot;">​</a></h2><p>select version();</p><h2 id="数据库启动时间" tabindex="-1">--数据库启动时间 <a class="header-anchor" href="#数据库启动时间" aria-label="Permalink to &quot;--数据库启动时间&quot;">​</a></h2><p>select pg_postmater_start_time();</p><h2 id="查看最后load配置文件时间" tabindex="-1">--查看最后load配置文件时间 <a class="header-anchor" href="#查看最后load配置文件时间" aria-label="Permalink to &quot;--查看最后load配置文件时间&quot;">​</a></h2><p>select pg_conf_load_time();</p><h2 id="查看参数配置" tabindex="-1">--查看参数配置 <a class="header-anchor" href="#查看参数配置" aria-label="Permalink to &quot;--查看参数配置&quot;">​</a></h2><p>select current_settlings(&#39;shared_buffers&#39;); show shared_buffers;</p><h2 id="查看当前正在写的wal" tabindex="-1">--查看当前正在写的wal <a class="header-anchor" href="#查看当前正在写的wal" aria-label="Permalink to &quot;--查看当前正在写的wal&quot;">​</a></h2><p>select pg_xlogfile_name(pg_current_xlog_location());</p><h2 id="查看当前wal的buffer中有多少字节没有写入到磁盘中" tabindex="-1">--查看当前wal的buffer中有多少字节没有写入到磁盘中 <a class="header-anchor" href="#查看当前wal的buffer中有多少字节没有写入到磁盘中" aria-label="Permalink to &quot;--查看当前wal的buffer中有多少字节没有写入到磁盘中&quot;">​</a></h2><p>select pg_xlog_location_diff(pg_current_xlog_insert_location(),pg_current_xlog_location());</p><h2 id="查看数据库状态" tabindex="-1">--查看数据库状态 <a class="header-anchor" href="#查看数据库状态" aria-label="Permalink to &quot;--查看数据库状态&quot;">​</a></h2><p>select pg_is_in_recovery();</p><h2 id="查看数据库大小" tabindex="-1">--查看数据库大小 <a class="header-anchor" href="#查看数据库大小" aria-label="Permalink to &quot;--查看数据库大小&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_size_pretty(pg_relation_size(</span><span style="color:#9ECBFF;">&#39;ipdb2&#39;</span><span style="color:#E1E4E8;">));  </span><span style="color:#6A737D;">--表大小</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_size_pretty(pg_total_relation_size(</span><span style="color:#9ECBFF;">&#39;ipdb2&#39;</span><span style="color:#E1E4E8;">));  </span><span style="color:#6A737D;">--总大小</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_size_pretty(pg_relation_size(</span><span style="color:#032F62;">&#39;ipdb2&#39;</span><span style="color:#24292E;">));  </span><span style="color:#6A737D;">--表大小</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_size_pretty(pg_total_relation_size(</span><span style="color:#032F62;">&#39;ipdb2&#39;</span><span style="color:#24292E;">));  </span><span style="color:#6A737D;">--总大小</span></span></code></pre></div><h2 id="查看表空间大小" tabindex="-1">--查看表空间大小 <a class="header-anchor" href="#查看表空间大小" aria-label="Permalink to &quot;--查看表空间大小&quot;">​</a></h2><p>select pg_size_pretty(pg_tablespace_size(&#39;pg_global&#39;));</p><h2 id="kill长时间运行sql-id" tabindex="-1">--kill长时间运行sql id <a class="header-anchor" href="#kill长时间运行sql-id" aria-label="Permalink to &quot;--kill长时间运行sql  id&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">select pid,usename,query_start,query from pg_stat_activity;</span></span>
<span class="line"><span style="color:#e1e4e8;">select pg_cancel_backend(567);</span></span>
<span class="line"><span style="color:#e1e4e8;">select pg_terminate_backend(567);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">select pid,usename,query_start,query from pg_stat_activity;</span></span>
<span class="line"><span style="color:#24292e;">select pg_cancel_backend(567);</span></span>
<span class="line"><span style="color:#24292e;">select pg_terminate_backend(567);</span></span></code></pre></div><h1 id="_6-自定义postgresql登录提示符" tabindex="-1">6,自定义PostgreSQL登录提示符 <a class="header-anchor" href="#_6-自定义postgresql登录提示符" aria-label="Permalink to &quot;6,自定义PostgreSQL登录提示符&quot;">​</a></h1><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres@postgres=&gt;\\du</span></span>
<span class="line"><span style="color:#e1e4e8;">                                   List of roles</span></span>
<span class="line"><span style="color:#e1e4e8;"> Role name |                         Attributes                         | Member of </span></span>
<span class="line"><span style="color:#e1e4e8;">-----------+------------------------------------------------------------+-----------</span></span>
<span class="line"><span style="color:#e1e4e8;"> postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres@postgres=&gt;\\du</span></span>
<span class="line"><span style="color:#24292e;">                                   List of roles</span></span>
<span class="line"><span style="color:#24292e;"> Role name |                         Attributes                         | Member of </span></span>
<span class="line"><span style="color:#24292e;">-----------+------------------------------------------------------------+-----------</span></span>
<span class="line"><span style="color:#24292e;"> postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}</span></span></code></pre></div><p>需要在postgres 用户下，在 postgres 家目录下编辑隐藏文件 .psqlrc</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[ptgres@pg01 ~]$ cat .psqlrc </span></span>
<span class="line"><span style="color:#e1e4e8;"> \\set PROMPT1 &#39;%/(ConnAs[%n]:PID[%p])%R# &#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[ptgres@pg01 ~]$ cat .psqlrc </span></span>
<span class="line"><span style="color:#24292e;"> \\set PROMPT1 &#39;%/(ConnAs[%n]:PID[%p])%R# &#39;</span></span></code></pre></div><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>%n</td><td>当前登陆用户名</td></tr><tr><td>%/</td><td>当前登陆数据库</td></tr><tr><td>%M</td><td>服务器主机名称</td></tr><tr><td>%&gt;</td><td>数据库监听port</td></tr><tr><td>%#</td><td>超级用户显示符(#超级用户，&gt; 普通用户)</td></tr><tr><td>%p</td><td>当前连接的后台进程编号</td></tr></tbody></table><h1 id="_7-锁表" tabindex="-1">7,锁表 <a class="header-anchor" href="#_7-锁表" aria-label="Permalink to &quot;7,锁表&quot;">​</a></h1><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--查询是否锁表了</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_class </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> relname</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;可能锁表了的表&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pid </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_locks </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> relation</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;上面查出的oid&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--如果查询到了结果，表示该表被锁 则需要释放锁定</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_cancel_backend(上面查到的pid)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看所表信息</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pid,mode,locktype,relation,</span><span style="color:#F97583;">page</span><span style="color:#E1E4E8;">,tuple,transactionid </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_locks </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> pid </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> pg_backend_pid();</span></span>
<span class="line"><span style="color:#E1E4E8;">或者</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@han_db</span><span style="color:#F97583;">=&gt;select</span><span style="color:#E1E4E8;"> pid,usename,pg_blocking_pids(pid) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> blocked_by,query </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> blocked_query </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> cardinality(pg_blocking_pids(pid))</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;"> pid | usename | blocked_by | blocked_query </span></span>
<span class="line"><span style="color:#6A737D;">-----+---------+------------+---------------</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">\\i </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">pathA</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">xxx</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--执行外部sql文件</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--查询是否锁表了</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">oid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_class </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> relname</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;可能锁表了的表&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pid </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_locks </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> relation</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;上面查出的oid&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--如果查询到了结果，表示该表被锁 则需要释放锁定</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_cancel_backend(上面查到的pid)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看所表信息</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pid,mode,locktype,relation,</span><span style="color:#D73A49;">page</span><span style="color:#24292E;">,tuple,transactionid </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_locks </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> pid </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> pg_backend_pid();</span></span>
<span class="line"><span style="color:#24292E;">或者</span></span>
<span class="line"><span style="color:#24292E;">postgres@han_db</span><span style="color:#D73A49;">=&gt;select</span><span style="color:#24292E;"> pid,usename,pg_blocking_pids(pid) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> blocked_by,query </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> blocked_query </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> cardinality(pg_blocking_pids(pid))</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;"> pid | usename | blocked_by | blocked_query </span></span>
<span class="line"><span style="color:#6A737D;">-----+---------+------------+---------------</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">\\i </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">pathA</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">xxx</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">--执行外部sql文件</span></span></code></pre></div><h2 id="_7-1-查看锁表" tabindex="-1">7.1 查看锁表 <a class="header-anchor" href="#_7-1-查看锁表" aria-label="Permalink to &quot;7.1 查看锁表&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocked_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> blocked_pid,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">blocked_activity</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">usename</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> blocked_user,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">blocking_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> blocking_pid,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">blocking_activity</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">usename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> blocking_user,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">blocked_activity</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> blocked_statement,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">blocking_activity</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> current_statement_in_blocking_process</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_locks</span><span style="color:#E1E4E8;">         blocked_locks</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_stat_activity</span><span style="color:#E1E4E8;"> blocked_activity  </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocked_activity</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocked_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_locks</span><span style="color:#E1E4E8;">         blocking_locks </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocking_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">locktype</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocked_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">locktype</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocking_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DATABASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISTINCT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocked_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DATABASE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocking_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relation</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISTINCT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocked_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocking_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISTINCT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocked_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocking_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tuple</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISTINCT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocked_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tuple</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocking_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">virtualxid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISTINCT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocked_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">virtualxid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocking_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transactionid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISTINCT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocked_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transactionid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocking_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">classid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISTINCT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocked_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">classid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocking_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISTINCT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocked_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocking_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objsubid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISTINCT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocked_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objsubid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocking_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocked_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pg_stat_activity</span><span style="color:#E1E4E8;"> blocking_activity </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocking_activity</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocking_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">blocked_locks</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">GRANTED</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    blocked_pid | blocked_user | blocking_pid | blocking_user | blocked_statement | current_statement_in_blocking_process </span></span>
<span class="line"><span style="color:#6A737D;">-------------+--------------+--------------+---------------+-------------------+---------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocked_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> blocked_pid,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">blocked_activity</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">usename</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> blocked_user,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">blocking_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> blocking_pid,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">blocking_activity</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">usename</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> blocking_user,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">blocked_activity</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> blocked_statement,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">blocking_activity</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> current_statement_in_blocking_process</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_locks</span><span style="color:#24292E;">         blocked_locks</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_stat_activity</span><span style="color:#24292E;"> blocked_activity  </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocked_activity</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocked_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_locks</span><span style="color:#24292E;">         blocking_locks </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocking_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">locktype</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocked_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">locktype</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocking_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DATABASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISTINCT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocked_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DATABASE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocking_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relation</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISTINCT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocked_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocking_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISTINCT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocked_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocking_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tuple</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISTINCT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocked_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tuple</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocking_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">virtualxid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISTINCT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocked_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">virtualxid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocking_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transactionid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISTINCT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocked_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transactionid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocking_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">classid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISTINCT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocked_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">classid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocking_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISTINCT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocked_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocking_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objsubid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISTINCT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocked_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objsubid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocking_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocked_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pg_stat_activity</span><span style="color:#24292E;"> blocking_activity </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocking_activity</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocking_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">blocked_locks</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">GRANTED</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    blocked_pid | blocked_user | blocking_pid | blocking_user | blocked_statement | current_statement_in_blocking_process </span></span>
<span class="line"><span style="color:#6A737D;">-------------+--------------+--------------+---------------+-------------------+---------------------------------------</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span></code></pre></div><h2 id="_7-2-杀死锁表" tabindex="-1">7.2 杀死锁表 <a class="header-anchor" href="#_7-2-杀死锁表" aria-label="Permalink to &quot;7.2 杀死锁表&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">#查看锁表</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_locks a </span><span style="color:#F97583;">join</span><span style="color:#E1E4E8;"> pg_class b </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relation</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">join</span><span style="color:#E1E4E8;"> pg_stat_activity c </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mode</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">like</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;%ExclusiveLock%&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">查的是排它锁，也可以精确到行排它锁或者共享锁之类的。</span></span>
<span class="line"><span style="color:#E1E4E8;">这里有几个重要的column：</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid是进程id</span><span style="color:#E1E4E8;">，</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relname是表名</span><span style="color:#E1E4E8;">、约束名或者索引名，</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mode是锁类型</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">#查看锁表</span></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_locks a </span><span style="color:#D73A49;">join</span><span style="color:#24292E;"> pg_class b </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relation</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">join</span><span style="color:#24292E;"> pg_stat_activity c </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mode</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">like</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;%ExclusiveLock%&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">查的是排它锁，也可以精确到行排它锁或者共享锁之类的。</span></span>
<span class="line"><span style="color:#24292E;">这里有几个重要的column：</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid是进程id</span><span style="color:#24292E;">，</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relname是表名</span><span style="color:#24292E;">、约束名或者索引名，</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mode是锁类型</span></span></code></pre></div><h3 id="杀掉指定表指定锁的进程" tabindex="-1">杀掉指定表指定锁的进程 <a class="header-anchor" href="#杀掉指定表指定锁的进程" aria-label="Permalink to &quot;杀掉指定表指定锁的进程&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">select pg_cancel_backend(a.pid) from pg_locks a</span></span>
<span class="line"><span style="color:#e1e4e8;">join pg_class b on a.relation = b.oid</span></span>
<span class="line"><span style="color:#e1e4e8;">join pg_stat_activity c on a.pid = c.pid</span></span>
<span class="line"><span style="color:#e1e4e8;">where b.relname ilike &#39;表名&#39; </span></span>
<span class="line"><span style="color:#e1e4e8;">and a.mode like &#39;%ExclusiveLock%&#39;;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">--或者使用更加霸道的pg_terminate_backend()：</span></span>
<span class="line"><span style="color:#e1e4e8;">select pg_terminate_backend(a.pid) from pg_locks a</span></span>
<span class="line"><span style="color:#e1e4e8;">join pg_class b on a.relation = b.oid</span></span>
<span class="line"><span style="color:#e1e4e8;">join pg_stat_activity c on a.pid = c.pid</span></span>
<span class="line"><span style="color:#e1e4e8;">where b.relname ilike &#39;表名&#39; </span></span>
<span class="line"><span style="color:#e1e4e8;">and a.mode like &#39;%ExclusiveLock%&#39;;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">另外需要注意的是，pg_terminate_backend()会把session也关闭，此时sessionId会失效，可能会导致系统账号退出登录，需要清除掉浏览器的缓存cookie</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">select pg_cancel_backend(a.pid) from pg_locks a</span></span>
<span class="line"><span style="color:#24292e;">join pg_class b on a.relation = b.oid</span></span>
<span class="line"><span style="color:#24292e;">join pg_stat_activity c on a.pid = c.pid</span></span>
<span class="line"><span style="color:#24292e;">where b.relname ilike &#39;表名&#39; </span></span>
<span class="line"><span style="color:#24292e;">and a.mode like &#39;%ExclusiveLock%&#39;;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">--或者使用更加霸道的pg_terminate_backend()：</span></span>
<span class="line"><span style="color:#24292e;">select pg_terminate_backend(a.pid) from pg_locks a</span></span>
<span class="line"><span style="color:#24292e;">join pg_class b on a.relation = b.oid</span></span>
<span class="line"><span style="color:#24292e;">join pg_stat_activity c on a.pid = c.pid</span></span>
<span class="line"><span style="color:#24292e;">where b.relname ilike &#39;表名&#39; </span></span>
<span class="line"><span style="color:#24292e;">and a.mode like &#39;%ExclusiveLock%&#39;;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">另外需要注意的是，pg_terminate_backend()会把session也关闭，此时sessionId会失效，可能会导致系统账号退出登录，需要清除掉浏览器的缓存cookie</span></span></code></pre></div><h2 id="_7-3使用视图查看锁表" tabindex="-1">7.3使用视图查看锁表 <a class="header-anchor" href="#_7-3使用视图查看锁表" aria-label="Permalink to &quot;7.3使用视图查看锁表&quot;">​</a></h2><ul><li>创建</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--  用一个函数来将锁转换为数字，</span></span>
<span class="line"><span style="color:#F97583;">create or replace</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">f_lock_level</span><span style="color:#E1E4E8;">(i_mode </span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">returns</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span></span>
<span class="line"><span style="color:#E1E4E8;">$$</span></span>
<span class="line"><span style="color:#F97583;">declare</span></span>
<span class="line"><span style="color:#F97583;">begin</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> i_mode</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;INVALID&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;AccessShareLock&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;RowShareLock&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;RowExclusiveLock&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ShareUpdateExclusiveLock&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ShareLock&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ShareRowExclusiveLock&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ExclusiveLock&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;AccessExclusiveLock&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">$$</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">language</span><span style="color:#E1E4E8;"> plpgsql strict;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--  用一个函数来将锁转换为数字，</span></span>
<span class="line"><span style="color:#D73A49;">create or replace</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">f_lock_level</span><span style="color:#24292E;">(i_mode </span><span style="color:#D73A49;">text</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">returns</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span></span>
<span class="line"><span style="color:#24292E;">$$</span></span>
<span class="line"><span style="color:#D73A49;">declare</span></span>
<span class="line"><span style="color:#D73A49;">begin</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> i_mode</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;INVALID&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;AccessShareLock&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;RowShareLock&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;RowExclusiveLock&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ShareUpdateExclusiveLock&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ShareLock&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ShareRowExclusiveLock&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ExclusiveLock&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;AccessExclusiveLock&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">case</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">end</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">$$</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">language</span><span style="color:#24292E;"> plpgsql strict;</span></span></code></pre></div><ul><li>查询</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 修改查询语句，按锁级别排序：</span></span>
<span class="line"><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> t_wait </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;">                    </span></span>
<span class="line"><span style="color:#E1E4E8;">(   </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mode</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">locktype</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relation</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tuple</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">classid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objsubid</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">virtualtransaction</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">virtualxid</span><span style="color:#E1E4E8;">,a,transactionid,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xact_start</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_start</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">usename</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">datname</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_locks a,pg_stat_activity b</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">granted</span></span>
<span class="line"><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">t_run </span><span style="color:#F97583;">as</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mode</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">locktype</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relation</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tuple</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">classid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objsubid</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">virtualtransaction</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">virtualxid</span><span style="color:#E1E4E8;">,a,transactionid,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xact_start</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_start</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">usename</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">datname</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_locks a,pg_stat_activity b</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">granted</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">locktype</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mode</span><span style="color:#E1E4E8;"> r_mode,</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">usename</span><span style="color:#E1E4E8;"> r_user,</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">datname</span><span style="color:#E1E4E8;"> r_db,</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relation</span><span style="color:#E1E4E8;">::regclass,</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> r_pid,</span></span>
<span class="line"><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page</span><span style="color:#E1E4E8;"> r_page,</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tuple</span><span style="color:#E1E4E8;"> r_tuple,</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xact_start</span><span style="color:#E1E4E8;"> r_xact_start,</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_start</span><span style="color:#E1E4E8;"> r_query_start,</span></span>
<span class="line"><span style="color:#F97583;">now</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_start</span><span style="color:#E1E4E8;"> r_locktime,</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query</span><span style="color:#E1E4E8;"> r_query,</span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mode</span><span style="color:#E1E4E8;"> w_mode,</span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> w_pid,</span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page</span><span style="color:#E1E4E8;"> w_page,</span></span>
<span class="line"><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tuple</span><span style="color:#E1E4E8;"> w_tuple,</span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xact_start</span><span style="color:#E1E4E8;"> w_xact_start,</span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_start</span><span style="color:#E1E4E8;"> w_query_start,</span></span>
<span class="line"><span style="color:#F97583;">now</span><span style="color:#E1E4E8;">()</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_start</span><span style="color:#E1E4E8;"> w_locktime,</span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query</span><span style="color:#E1E4E8;"> w_query </span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> t_wait w,t_run r</span></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">locktype</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">locktype</span></span>
<span class="line"><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database</span></span>
<span class="line"><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relation</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relation</span></span>
<span class="line"><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page</span></span>
<span class="line"><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tuple</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tuple</span></span>
<span class="line"><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">classid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">classid</span></span>
<span class="line"><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objid</span></span>
<span class="line"><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objsubid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objsubid</span></span>
<span class="line"><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transactionid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">distinct</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transactionid</span></span>
<span class="line"><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span></span>
<span class="line"><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> f_lock_level(</span><span style="color:#79B8FF;">w</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mode</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">f_lock_level(</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mode</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">desc</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">r</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xact_start</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 修改查询语句，按锁级别排序：</span></span>
<span class="line"><span style="color:#D73A49;">with</span><span style="color:#24292E;"> t_wait </span><span style="color:#D73A49;">as</span><span style="color:#24292E;">                    </span></span>
<span class="line"><span style="color:#24292E;">(   </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mode</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">locktype</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relation</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tuple</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">classid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objsubid</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">virtualtransaction</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">virtualxid</span><span style="color:#24292E;">,a,transactionid,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xact_start</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_start</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">usename</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">datname</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_locks a,pg_stat_activity b</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">granted</span></span>
<span class="line"><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">t_run </span><span style="color:#D73A49;">as</span></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mode</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">locktype</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relation</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tuple</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">classid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objsubid</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">virtualtransaction</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">virtualxid</span><span style="color:#24292E;">,a,transactionid,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xact_start</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_start</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">usename</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">datname</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_locks a,pg_stat_activity b</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">granted</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">locktype</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mode</span><span style="color:#24292E;"> r_mode,</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">usename</span><span style="color:#24292E;"> r_user,</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">datname</span><span style="color:#24292E;"> r_db,</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relation</span><span style="color:#24292E;">::regclass,</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> r_pid,</span></span>
<span class="line"><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page</span><span style="color:#24292E;"> r_page,</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tuple</span><span style="color:#24292E;"> r_tuple,</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xact_start</span><span style="color:#24292E;"> r_xact_start,</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_start</span><span style="color:#24292E;"> r_query_start,</span></span>
<span class="line"><span style="color:#D73A49;">now</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_start</span><span style="color:#24292E;"> r_locktime,</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query</span><span style="color:#24292E;"> r_query,</span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mode</span><span style="color:#24292E;"> w_mode,</span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> w_pid,</span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page</span><span style="color:#24292E;"> w_page,</span></span>
<span class="line"><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tuple</span><span style="color:#24292E;"> w_tuple,</span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xact_start</span><span style="color:#24292E;"> w_xact_start,</span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_start</span><span style="color:#24292E;"> w_query_start,</span></span>
<span class="line"><span style="color:#D73A49;">now</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_start</span><span style="color:#24292E;"> w_locktime,</span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query</span><span style="color:#24292E;"> w_query </span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> t_wait w,t_run r</span></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">locktype</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">locktype</span></span>
<span class="line"><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database</span></span>
<span class="line"><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relation</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relation</span></span>
<span class="line"><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page</span></span>
<span class="line"><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tuple</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tuple</span></span>
<span class="line"><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">classid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">classid</span></span>
<span class="line"><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objid</span></span>
<span class="line"><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objsubid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objsubid</span></span>
<span class="line"><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transactionid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">distinct</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transactionid</span></span>
<span class="line"><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span></span>
<span class="line"><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> f_lock_level(</span><span style="color:#005CC5;">w</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mode</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">f_lock_level(</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mode</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">desc</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">r</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xact_start</span><span style="color:#24292E;">;</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202404011524896.png" alt="image-20240401152345669"></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">--现在可以排在前面的就是锁级别高的等待，优先干掉这个。</span></span>
<span class="line"><span style="color:#e1e4e8;">-[ RECORD 1 ]-+---------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#e1e4e8;">locktype      | relation  -- 冲突类型</span></span>
<span class="line"><span style="color:#e1e4e8;">r_mode        | ShareUpdateExclusiveLock  -- 持锁模式</span></span>
<span class="line"><span style="color:#e1e4e8;">r_user        | postgres  -- 持锁用户</span></span>
<span class="line"><span style="color:#e1e4e8;">r_db          | postgres  -- 持锁数据库</span></span>
<span class="line"><span style="color:#e1e4e8;">relation      | tbl  -- 持锁对象</span></span>
<span class="line"><span style="color:#e1e4e8;">r_pid         | 25656  -- 持锁进程</span></span>
<span class="line"><span style="color:#e1e4e8;">r_xact_start  | 2015-05-10 14:11:16.08318+08  -- 持锁事务开始时间</span></span>
<span class="line"><span style="color:#e1e4e8;">r_query_start | 2015-05-10 14:11:16.08318+08  -- 持锁SQL开始时间</span></span>
<span class="line"><span style="color:#e1e4e8;">r_locktime    | 00:01:49.460779  -- 持锁时长</span></span>
<span class="line"><span style="color:#e1e4e8;">r_query       | vacuum freeze tbl;  --  持锁SQL,注意不一定是这个SQL带来的锁,也有可能是这个事务在之前执行的SQL加的锁</span></span>
<span class="line"><span style="color:#e1e4e8;">w_mode        | AccessExclusiveLock  -- 等待锁模式</span></span>
<span class="line"><span style="color:#e1e4e8;">w_pid         | 26731  -- 等待锁进程</span></span>
<span class="line"><span style="color:#e1e4e8;">w_xact_start  | 2015-05-10 14:11:17.987362+08  --  等待锁事务开始时间</span></span>
<span class="line"><span style="color:#e1e4e8;">w_query_start | 2015-05-10 14:11:17.987362+08  --  等待锁SQL开始时间</span></span>
<span class="line"><span style="color:#e1e4e8;">w_locktime    | 00:01:47.556597  --  等待锁时长</span></span>
<span class="line"><span style="color:#e1e4e8;">w_query       | truncate tbl;  -- 等待锁SQL</span></span>
<span class="line"><span style="color:#e1e4e8;">-[ RECORD 2 ]-+---------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#e1e4e8;">locktype      | relation</span></span>
<span class="line"><span style="color:#e1e4e8;">r_mode        | ShareUpdateExclusiveLock</span></span>
<span class="line"><span style="color:#e1e4e8;">r_user        | postgres</span></span>
<span class="line"><span style="color:#e1e4e8;">r_db          | postgres</span></span>
<span class="line"><span style="color:#e1e4e8;">relation      | tbl</span></span>
<span class="line"><span style="color:#e1e4e8;">r_pid         | 25656</span></span>
<span class="line"><span style="color:#e1e4e8;">r_xact_start  | 2015-05-10 14:11:16.08318+08</span></span>
<span class="line"><span style="color:#e1e4e8;">r_query_start | 2015-05-10 14:11:16.08318+08</span></span>
<span class="line"><span style="color:#e1e4e8;">r_locktime    | 00:01:49.460779</span></span>
<span class="line"><span style="color:#e1e4e8;">r_query       | vacuum freeze tbl;</span></span>
<span class="line"><span style="color:#e1e4e8;">w_mode        | RowExclusiveLock</span></span>
<span class="line"><span style="color:#e1e4e8;">w_pid         | 25582</span></span>
<span class="line"><span style="color:#e1e4e8;">w_xact_start  | 2015-05-10 14:11:22.845+08</span></span>
<span class="line"><span style="color:#e1e4e8;">w_query_start | 2015-05-10 14:11:22.845+08</span></span>
<span class="line"><span style="color:#e1e4e8;">w_locktime    | 00:01:42.698959</span></span>
<span class="line"><span style="color:#e1e4e8;">w_query       | insert into tbl(crt_time) select now() from generate_series(1,1000);  -- 这个SQL其实等待的是truncate tbl的锁;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">--现在可以排在前面的就是锁级别高的等待，优先干掉这个。</span></span>
<span class="line"><span style="color:#24292e;">-[ RECORD 1 ]-+---------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292e;">locktype      | relation  -- 冲突类型</span></span>
<span class="line"><span style="color:#24292e;">r_mode        | ShareUpdateExclusiveLock  -- 持锁模式</span></span>
<span class="line"><span style="color:#24292e;">r_user        | postgres  -- 持锁用户</span></span>
<span class="line"><span style="color:#24292e;">r_db          | postgres  -- 持锁数据库</span></span>
<span class="line"><span style="color:#24292e;">relation      | tbl  -- 持锁对象</span></span>
<span class="line"><span style="color:#24292e;">r_pid         | 25656  -- 持锁进程</span></span>
<span class="line"><span style="color:#24292e;">r_xact_start  | 2015-05-10 14:11:16.08318+08  -- 持锁事务开始时间</span></span>
<span class="line"><span style="color:#24292e;">r_query_start | 2015-05-10 14:11:16.08318+08  -- 持锁SQL开始时间</span></span>
<span class="line"><span style="color:#24292e;">r_locktime    | 00:01:49.460779  -- 持锁时长</span></span>
<span class="line"><span style="color:#24292e;">r_query       | vacuum freeze tbl;  --  持锁SQL,注意不一定是这个SQL带来的锁,也有可能是这个事务在之前执行的SQL加的锁</span></span>
<span class="line"><span style="color:#24292e;">w_mode        | AccessExclusiveLock  -- 等待锁模式</span></span>
<span class="line"><span style="color:#24292e;">w_pid         | 26731  -- 等待锁进程</span></span>
<span class="line"><span style="color:#24292e;">w_xact_start  | 2015-05-10 14:11:17.987362+08  --  等待锁事务开始时间</span></span>
<span class="line"><span style="color:#24292e;">w_query_start | 2015-05-10 14:11:17.987362+08  --  等待锁SQL开始时间</span></span>
<span class="line"><span style="color:#24292e;">w_locktime    | 00:01:47.556597  --  等待锁时长</span></span>
<span class="line"><span style="color:#24292e;">w_query       | truncate tbl;  -- 等待锁SQL</span></span>
<span class="line"><span style="color:#24292e;">-[ RECORD 2 ]-+---------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292e;">locktype      | relation</span></span>
<span class="line"><span style="color:#24292e;">r_mode        | ShareUpdateExclusiveLock</span></span>
<span class="line"><span style="color:#24292e;">r_user        | postgres</span></span>
<span class="line"><span style="color:#24292e;">r_db          | postgres</span></span>
<span class="line"><span style="color:#24292e;">relation      | tbl</span></span>
<span class="line"><span style="color:#24292e;">r_pid         | 25656</span></span>
<span class="line"><span style="color:#24292e;">r_xact_start  | 2015-05-10 14:11:16.08318+08</span></span>
<span class="line"><span style="color:#24292e;">r_query_start | 2015-05-10 14:11:16.08318+08</span></span>
<span class="line"><span style="color:#24292e;">r_locktime    | 00:01:49.460779</span></span>
<span class="line"><span style="color:#24292e;">r_query       | vacuum freeze tbl;</span></span>
<span class="line"><span style="color:#24292e;">w_mode        | RowExclusiveLock</span></span>
<span class="line"><span style="color:#24292e;">w_pid         | 25582</span></span>
<span class="line"><span style="color:#24292e;">w_xact_start  | 2015-05-10 14:11:22.845+08</span></span>
<span class="line"><span style="color:#24292e;">w_query_start | 2015-05-10 14:11:22.845+08</span></span>
<span class="line"><span style="color:#24292e;">w_locktime    | 00:01:42.698959</span></span>
<span class="line"><span style="color:#24292e;">w_query       | insert into tbl(crt_time) select now() from generate_series(1,1000);  -- 这个SQL其实等待的是truncate tbl的锁;</span></span></code></pre></div><h1 id="_8-查看进程阻塞" tabindex="-1">8,查看进程阻塞 <a class="header-anchor" href="#_8-查看进程阻塞" aria-label="Permalink to &quot;8,查看进程阻塞&quot;">​</a></h1><p>函数pg_blocking_pids,该函数用于获取哪些进程(输出参数)阻塞了某个进程(输入参数)</p><p>在执行某些操作时,console可能会挂起没有输出,这时候你没有办法判断是因为执行很慢还是因为被阻塞了,通过pg_blocking_pids可以判断是否存在阻塞</p><p>借助中的pg_stat_activity视图</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> datname,pid,usename,wait_event_type,wait_event,</span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;">,query </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> backend_type </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;client backend&#39;</span></span>
<span class="line"><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> pid </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> pg_backend_pid();</span></span>
<span class="line"><span style="color:#E1E4E8;"> datname  | pid  | usename  | wait_event_type | wait_event |        </span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;">        |                query</span></span>
<span class="line"><span style="color:#6A737D;">----------+------+----------+-----------------+------------+---------------------+--------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> postgres | </span><span style="color:#79B8FF;">3231</span><span style="color:#E1E4E8;"> | postgres | Client          | ClientRead | idle </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">transaction</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">alter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> t1 </span><span style="color:#F97583;">add</span><span style="color:#E1E4E8;"> column </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;"> postgres | </span><span style="color:#79B8FF;">3386</span><span style="color:#E1E4E8;"> | postgres | Lock            | relation   | active              | </span><span style="color:#F97583;">insert into</span><span style="color:#E1E4E8;"> t1(id) </span><span style="color:#F97583;">values</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> datname,pid,usename,wait_event_type,wait_event,</span><span style="color:#D73A49;">state</span><span style="color:#24292E;">,query </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> backend_type </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;client backend&#39;</span></span>
<span class="line"><span style="color:#D73A49;">and</span><span style="color:#24292E;"> pid </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> pg_backend_pid();</span></span>
<span class="line"><span style="color:#24292E;"> datname  | pid  | usename  | wait_event_type | wait_event |        </span><span style="color:#D73A49;">state</span><span style="color:#24292E;">        |                query</span></span>
<span class="line"><span style="color:#6A737D;">----------+------+----------+-----------------+------------+---------------------+--------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> postgres | </span><span style="color:#005CC5;">3231</span><span style="color:#24292E;"> | postgres | Client          | ClientRead | idle </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">transaction</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">alter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> t1 </span><span style="color:#D73A49;">add</span><span style="color:#24292E;"> column </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">text</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;"> postgres | </span><span style="color:#005CC5;">3386</span><span style="color:#24292E;"> | postgres | Lock            | relation   | active              | </span><span style="color:#D73A49;">insert into</span><span style="color:#24292E;"> t1(id) </span><span style="color:#D73A49;">values</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span></code></pre></div><p>知道PostgreSQL中当前持有或者是授权那些锁的时候，可以查看pg_locks，主要看RowExclusiveLock和AccessExclusiveLock</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># \\d pg_locks</span></span>
<span class="line"><span style="color:#E1E4E8;">                   View </span><span style="color:#9ECBFF;">&quot;pg_catalog.pg_locks&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">       Column       |   </span><span style="color:#F97583;">Type</span><span style="color:#E1E4E8;">   | Collation | Nullable | </span><span style="color:#F97583;">Default</span></span>
<span class="line"><span style="color:#6A737D;">--------------------+----------+-----------+----------+---------</span></span>
<span class="line"><span style="color:#E1E4E8;"> locktype           | </span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">     |           |          |</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;">           | </span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">      |           |          |</span></span>
<span class="line"><span style="color:#E1E4E8;"> relation           | </span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">      |           |          |</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">page</span><span style="color:#E1E4E8;">               | </span><span style="color:#F97583;">integer</span><span style="color:#E1E4E8;">  |           |          |</span></span>
<span class="line"><span style="color:#E1E4E8;"> tuple              | </span><span style="color:#F97583;">smallint</span><span style="color:#E1E4E8;"> |           |          |</span></span>
<span class="line"><span style="color:#E1E4E8;"> virtualxid         | </span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">     |           |          |</span></span>
<span class="line"><span style="color:#E1E4E8;"> transactionid      | xid      |           |          |</span></span>
<span class="line"><span style="color:#E1E4E8;"> classid            | </span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">      |           |          |</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">objid</span><span style="color:#E1E4E8;">              | </span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;">      |           |          |</span></span>
<span class="line"><span style="color:#E1E4E8;"> objsubid           | </span><span style="color:#F97583;">smallint</span><span style="color:#E1E4E8;"> |           |          |</span></span>
<span class="line"><span style="color:#E1E4E8;"> virtualtransaction | </span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">     |           |          |</span></span>
<span class="line"><span style="color:#E1E4E8;"> pid                | </span><span style="color:#F97583;">integer</span><span style="color:#E1E4E8;">  |           |          |</span></span>
<span class="line"><span style="color:#E1E4E8;"> mode               | </span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">     |           |          |</span></span>
<span class="line"><span style="color:#E1E4E8;"> granted            | </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;">  |           |          |</span></span>
<span class="line"><span style="color:#E1E4E8;"> fastpath           | </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;">  |           |          |</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> locktype,</span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;">,relation,pid,mode,granted </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_locks </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> pid </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> pg_backend_pid();</span></span>
<span class="line"><span style="color:#E1E4E8;">   locktype    | </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> | relation | pid  |        mode         | granted</span></span>
<span class="line"><span style="color:#6A737D;">---------------+----------+----------+------+---------------------+---------</span></span>
<span class="line"><span style="color:#E1E4E8;"> virtualxid    |          |          | </span><span style="color:#79B8FF;">3386</span><span style="color:#E1E4E8;"> | ExclusiveLock       | t</span></span>
<span class="line"><span style="color:#E1E4E8;"> virtualxid    |          |          | </span><span style="color:#79B8FF;">3231</span><span style="color:#E1E4E8;"> | ExclusiveLock       | t</span></span>
<span class="line"><span style="color:#E1E4E8;"> relation      |    </span><span style="color:#79B8FF;">13806</span><span style="color:#E1E4E8;"> |    </span><span style="color:#79B8FF;">16434</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">3231</span><span style="color:#E1E4E8;"> | AccessExclusiveLock | t</span></span>
<span class="line"><span style="color:#E1E4E8;"> transactionid |          |          | </span><span style="color:#79B8FF;">3231</span><span style="color:#E1E4E8;"> | ExclusiveLock       | t</span></span>
<span class="line"><span style="color:#E1E4E8;"> relation      |    </span><span style="color:#79B8FF;">13806</span><span style="color:#E1E4E8;"> |    </span><span style="color:#79B8FF;">16434</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">3386</span><span style="color:#E1E4E8;"> | RowExclusiveLock    | f</span></span>
<span class="line"><span style="color:#E1E4E8;"> relation      |    </span><span style="color:#79B8FF;">13806</span><span style="color:#E1E4E8;"> |    </span><span style="color:#79B8FF;">16439</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">3231</span><span style="color:#E1E4E8;"> | AccessExclusiveLock | t</span></span>
<span class="line"><span style="color:#E1E4E8;"> relation      |    </span><span style="color:#79B8FF;">13806</span><span style="color:#E1E4E8;"> |    </span><span style="color:#79B8FF;">16437</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">3231</span><span style="color:#E1E4E8;"> | ShareLock           | t</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 直接结果，把pg_locks与pg_database和pg_class，通过加入pid来获取更多的信息</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">locktype</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">datname</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relname</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mode</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_locks b,pg_database d,pg_class c </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">3386</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">3231</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relation</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;"> locktype | datname  | relname | pid  |        mode</span></span>
<span class="line"><span style="color:#6A737D;">----------+----------+---------+------+---------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> relation | postgres | t1      | </span><span style="color:#79B8FF;">3231</span><span style="color:#E1E4E8;"> | AccessExclusiveLock</span></span>
<span class="line"><span style="color:#E1E4E8;"> relation | postgres | t1      | </span><span style="color:#79B8FF;">3386</span><span style="color:#E1E4E8;"> | RowExclusiveLock</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># \\d pg_locks</span></span>
<span class="line"><span style="color:#24292E;">                   View </span><span style="color:#032F62;">&quot;pg_catalog.pg_locks&quot;</span></span>
<span class="line"><span style="color:#24292E;">       Column       |   </span><span style="color:#D73A49;">Type</span><span style="color:#24292E;">   | Collation | Nullable | </span><span style="color:#D73A49;">Default</span></span>
<span class="line"><span style="color:#6A737D;">--------------------+----------+-----------+----------+---------</span></span>
<span class="line"><span style="color:#24292E;"> locktype           | </span><span style="color:#D73A49;">text</span><span style="color:#24292E;">     |           |          |</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;">           | </span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">      |           |          |</span></span>
<span class="line"><span style="color:#24292E;"> relation           | </span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">      |           |          |</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">page</span><span style="color:#24292E;">               | </span><span style="color:#D73A49;">integer</span><span style="color:#24292E;">  |           |          |</span></span>
<span class="line"><span style="color:#24292E;"> tuple              | </span><span style="color:#D73A49;">smallint</span><span style="color:#24292E;"> |           |          |</span></span>
<span class="line"><span style="color:#24292E;"> virtualxid         | </span><span style="color:#D73A49;">text</span><span style="color:#24292E;">     |           |          |</span></span>
<span class="line"><span style="color:#24292E;"> transactionid      | xid      |           |          |</span></span>
<span class="line"><span style="color:#24292E;"> classid            | </span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">      |           |          |</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">objid</span><span style="color:#24292E;">              | </span><span style="color:#D73A49;">oid</span><span style="color:#24292E;">      |           |          |</span></span>
<span class="line"><span style="color:#24292E;"> objsubid           | </span><span style="color:#D73A49;">smallint</span><span style="color:#24292E;"> |           |          |</span></span>
<span class="line"><span style="color:#24292E;"> virtualtransaction | </span><span style="color:#D73A49;">text</span><span style="color:#24292E;">     |           |          |</span></span>
<span class="line"><span style="color:#24292E;"> pid                | </span><span style="color:#D73A49;">integer</span><span style="color:#24292E;">  |           |          |</span></span>
<span class="line"><span style="color:#24292E;"> mode               | </span><span style="color:#D73A49;">text</span><span style="color:#24292E;">     |           |          |</span></span>
<span class="line"><span style="color:#24292E;"> granted            | </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;">  |           |          |</span></span>
<span class="line"><span style="color:#24292E;"> fastpath           | </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;">  |           |          |</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> locktype,</span><span style="color:#D73A49;">database</span><span style="color:#24292E;">,relation,pid,mode,granted </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_locks </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> pid </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> pg_backend_pid();</span></span>
<span class="line"><span style="color:#24292E;">   locktype    | </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> | relation | pid  |        mode         | granted</span></span>
<span class="line"><span style="color:#6A737D;">---------------+----------+----------+------+---------------------+---------</span></span>
<span class="line"><span style="color:#24292E;"> virtualxid    |          |          | </span><span style="color:#005CC5;">3386</span><span style="color:#24292E;"> | ExclusiveLock       | t</span></span>
<span class="line"><span style="color:#24292E;"> virtualxid    |          |          | </span><span style="color:#005CC5;">3231</span><span style="color:#24292E;"> | ExclusiveLock       | t</span></span>
<span class="line"><span style="color:#24292E;"> relation      |    </span><span style="color:#005CC5;">13806</span><span style="color:#24292E;"> |    </span><span style="color:#005CC5;">16434</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">3231</span><span style="color:#24292E;"> | AccessExclusiveLock | t</span></span>
<span class="line"><span style="color:#24292E;"> transactionid |          |          | </span><span style="color:#005CC5;">3231</span><span style="color:#24292E;"> | ExclusiveLock       | t</span></span>
<span class="line"><span style="color:#24292E;"> relation      |    </span><span style="color:#005CC5;">13806</span><span style="color:#24292E;"> |    </span><span style="color:#005CC5;">16434</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">3386</span><span style="color:#24292E;"> | RowExclusiveLock    | f</span></span>
<span class="line"><span style="color:#24292E;"> relation      |    </span><span style="color:#005CC5;">13806</span><span style="color:#24292E;"> |    </span><span style="color:#005CC5;">16439</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">3231</span><span style="color:#24292E;"> | AccessExclusiveLock | t</span></span>
<span class="line"><span style="color:#24292E;"> relation      |    </span><span style="color:#005CC5;">13806</span><span style="color:#24292E;"> |    </span><span style="color:#005CC5;">16437</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">3231</span><span style="color:#24292E;"> | ShareLock           | t</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">7</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 直接结果，把pg_locks与pg_database和pg_class，通过加入pid来获取更多的信息</span></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">locktype</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">datname</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relname</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mode</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_locks b,pg_database d,pg_class c </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">3386</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">3231</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relation</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;"> locktype | datname  | relname | pid  |        mode</span></span>
<span class="line"><span style="color:#6A737D;">----------+----------+---------+------+---------------------</span></span>
<span class="line"><span style="color:#24292E;"> relation | postgres | t1      | </span><span style="color:#005CC5;">3231</span><span style="color:#24292E;"> | AccessExclusiveLock</span></span>
<span class="line"><span style="color:#24292E;"> relation | postgres | t1      | </span><span style="color:#005CC5;">3386</span><span style="color:#24292E;"> | RowExclusiveLock</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span></code></pre></div><h2 id="查看阻塞着" tabindex="-1">查看阻塞着 <a class="header-anchor" href="#查看阻塞着" aria-label="Permalink to &quot;查看阻塞着&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 使用pg_blocking_pids函数传递被堵塞的会话,就可以看到阻塞者</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_blocking_pids(</span><span style="color:#79B8FF;">3386</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;"> pg_blocking_pids </span></span>
<span class="line"><span style="color:#6A737D;">------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> {</span><span style="color:#79B8FF;">3231</span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">row</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 使用pg_blocking_pids函数传递被堵塞的会话,就可以看到阻塞者</span></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_blocking_pids(</span><span style="color:#005CC5;">3386</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;"> pg_blocking_pids </span></span>
<span class="line"><span style="color:#6A737D;">------------------</span></span>
<span class="line"><span style="color:#24292E;"> {</span><span style="color:#005CC5;">3231</span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">row</span><span style="color:#24292E;">)</span></span></code></pre></div><h2 id="kill" tabindex="-1">kill <a class="header-anchor" href="#kill" aria-label="Permalink to &quot;kill&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_terminate_backend(</span><span style="color:#79B8FF;">3231</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;"> pg_terminate_backend </span></span>
<span class="line"><span style="color:#6A737D;">----------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> t</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_terminate_backend(</span><span style="color:#005CC5;">3231</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;"> pg_terminate_backend </span></span>
<span class="line"><span style="color:#6A737D;">----------------------</span></span>
<span class="line"><span style="color:#24292E;"> t</span></span></code></pre></div><h1 id="_9-忘记密码" tabindex="-1">9.忘记密码 <a class="header-anchor" href="#_9-忘记密码" aria-label="Permalink to &quot;9.忘记密码&quot;">​</a></h1><p>PG的超级用户密码忘记</p><h2 id="_1-postgresql数据库的两种访问方式" tabindex="-1">1. PostgreSQL数据库的两种访问方式 <a class="header-anchor" href="#_1-postgresql数据库的两种访问方式" aria-label="Permalink to &quot;1. PostgreSQL数据库的两种访问方式&quot;">​</a></h2><ul><li>socket方式</li><li>host方式</li></ul><p>socket方式比host方式访问效率高，服务器端操作访问推荐采用socket方式</p><h2 id="_2-socket方式" tabindex="-1">2. socket方式 <a class="header-anchor" href="#_2-socket方式" aria-label="Permalink to &quot;2. socket方式&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">语法：</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">psql</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h/path/socket_dir</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-Upostgres</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">port</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[ptgres@pg01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]$ psql -h/tmp/ -Upostgres -p 5532</span></span>
<span class="line"><span style="color:#B392F0;">psql</span><span style="color:#E1E4E8;"> (12.2)</span></span>
<span class="line"><span style="color:#B392F0;">Type</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;help&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">help.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">postgres@postgres</span><span style="color:#E1E4E8;">=&gt;\\conninfo</span></span>
<span class="line"><span style="color:#B392F0;">You</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">are</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connected</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">user</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">via</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">socket</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/tmp/&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">at</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">port</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;5532&quot;.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">语法：</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">psql</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h/path/socket_dir</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-Upostgres</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">port</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[ptgres@pg01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]$ psql -h/tmp/ -Upostgres -p 5532</span></span>
<span class="line"><span style="color:#6F42C1;">psql</span><span style="color:#24292E;"> (12.2)</span></span>
<span class="line"><span style="color:#6F42C1;">Type</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;help&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">help.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">postgres@postgres</span><span style="color:#24292E;">=&gt;\\conninfo</span></span>
<span class="line"><span style="color:#6F42C1;">You</span><span style="color:#24292E;"> </span><span style="color:#032F62;">are</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connected</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">user</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">via</span><span style="color:#24292E;"> </span><span style="color:#032F62;">socket</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/tmp/&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">at</span><span style="color:#24292E;"> </span><span style="color:#032F62;">port</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;5532&quot;.</span></span></code></pre></div><h2 id="_3-host方式" tabindex="-1">3. host方式 <a class="header-anchor" href="#_3-host方式" aria-label="Permalink to &quot;3. host方式&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[ptgres@pg01 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]$ psql -h127.0.0.1 -Upostgres -p 5532</span></span>
<span class="line"><span style="color:#B392F0;">psql</span><span style="color:#E1E4E8;"> (12.2)</span></span>
<span class="line"><span style="color:#B392F0;">Type</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;help&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">help.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">postgres@postgres</span><span style="color:#E1E4E8;">=&gt;\\conninfo</span></span>
<span class="line"><span style="color:#B392F0;">You</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">are</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connected</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">user</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">host</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;127.0.0.1&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">at</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">port</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;5532&quot;.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[ptgres@pg01 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]$ psql -h127.0.0.1 -Upostgres -p 5532</span></span>
<span class="line"><span style="color:#6F42C1;">psql</span><span style="color:#24292E;"> (12.2)</span></span>
<span class="line"><span style="color:#6F42C1;">Type</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;help&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">help.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">postgres@postgres</span><span style="color:#24292E;">=&gt;\\conninfo</span></span>
<span class="line"><span style="color:#6F42C1;">You</span><span style="color:#24292E;"> </span><span style="color:#032F62;">are</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connected</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">user</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">host</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;127.0.0.1&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">at</span><span style="color:#24292E;"> </span><span style="color:#032F62;">port</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;5532&quot;.</span></span></code></pre></div><h1 id="_10-postgresql中模板数据库" tabindex="-1">10,PostgreSQL中模板数据库 <a class="header-anchor" href="#_10-postgresql中模板数据库" aria-label="Permalink to &quot;10,PostgreSQL中模板数据库&quot;">​</a></h1><ol><li>template0与template1是否都可以连接</li></ol><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># \\</span><span style="color:#F97583;">connect</span><span style="color:#E1E4E8;"> template0</span></span>
<span class="line"><span style="color:#E1E4E8;">致命错误:  数据库 </span><span style="color:#9ECBFF;">&quot;template0&quot;</span><span style="color:#E1E4E8;"> 当前不接受联接</span></span>
<span class="line"><span style="color:#E1E4E8;">保留上一次连接</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># \\</span><span style="color:#F97583;">connect</span><span style="color:#E1E4E8;"> template1</span></span>
<span class="line"><span style="color:#E1E4E8;">您现在已经连接到数据库 </span><span style="color:#9ECBFF;">&quot;template1&quot;</span><span style="color:#E1E4E8;">,用户 </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;">.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># \\</span><span style="color:#D73A49;">connect</span><span style="color:#24292E;"> template0</span></span>
<span class="line"><span style="color:#24292E;">致命错误:  数据库 </span><span style="color:#032F62;">&quot;template0&quot;</span><span style="color:#24292E;"> 当前不接受联接</span></span>
<span class="line"><span style="color:#24292E;">保留上一次连接</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># \\</span><span style="color:#D73A49;">connect</span><span style="color:#24292E;"> template1</span></span>
<span class="line"><span style="color:#24292E;">您现在已经连接到数据库 </span><span style="color:#032F62;">&quot;template1&quot;</span><span style="color:#24292E;">,用户 </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;">.</span></span></code></pre></div><p>template0是不能直接连接使用的；</p><p>template1则可以，出于安全考虑，一般会删除默认的postgres数据库，但我们想连到一个库，却不知道或不记得数据库名称了，这时可以连接template1，进去后在使用\\l查看数据库列表</p><ol start="2"><li>template0与template1是否可以修改</li></ol><p>template0是一个干净的模板库，不能修改；</p><p>template1可以定制修改，比如创建extension或者oracle相关的兼容视图及函数等，后续再创建database时，默认以template1为模板将继承过来</p><ol start="3"><li>template0与template1是否可以删除</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# drop database template1;</span></span>
<span class="line"><span style="color:#e1e4e8;">错误:  无法删除模板数据库</span></span>
<span class="line"><span style="color:#e1e4e8;">postgres=# alter database template1 is_template false;</span></span>
<span class="line"><span style="color:#e1e4e8;">ALTER DATABASE</span></span>
<span class="line"><span style="color:#e1e4e8;">postgres=# drop database template1;</span></span>
<span class="line"><span style="color:#e1e4e8;">DROP DATABASE</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# drop database template1;</span></span>
<span class="line"><span style="color:#24292e;">错误:  无法删除模板数据库</span></span>
<span class="line"><span style="color:#24292e;">postgres=# alter database template1 is_template false;</span></span>
<span class="line"><span style="color:#24292e;">ALTER DATABASE</span></span>
<span class="line"><span style="color:#24292e;">postgres=# drop database template1;</span></span>
<span class="line"><span style="color:#24292e;">DROP DATABASE</span></span></code></pre></div><p>都可以删除，只要把is_template属性设置为false，即可删除</p><p>关于is_template属性：如果设置了这个标志，那么该数据库可以被任何有 CREATEDB权限的用户作为模板库使用（克隆复制）；如果没有被设置，那么只有超级用户和该数据库的拥有者可以克隆复制</p><ol start="4"><li>template0与template1是否可以指定新的编码</li></ol><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> clocaledb </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ENCODING</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&#39;SQL_ASCII&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    LC_COLLATE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;C&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    LC_CTYPE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;C&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    TEMPLATE</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">template1;</span></span>
<span class="line"><span style="color:#E1E4E8;">错误:  新的编码(SQL_ASCII)与模板数据库(UTF8)的编码不兼容</span></span>
<span class="line"><span style="color:#E1E4E8;">提示:  在模版数据库中使用同一编码，或者使用template0作为模版.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># </span><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> clocaledb</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ENCODING</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&#39;SQL_ASCII&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">     LC_COLLATE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;C&#39;</span><span style="color:#E1E4E8;"> LC_CTYPE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;C&#39;</span><span style="color:#E1E4E8;"> TEMPLATE</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">template0;</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--其他例子</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">englishdb</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ENCODING</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&#39;UTF8&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    LC_COLLATE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;en_GB.UTF8&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    LC_CTYPE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;en_GB.UTF8&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    TEMPLATE</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">template0;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">--简体中文字符集</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">chinadb</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ENCODING</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&#39;EUC_CN&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    LC_COLLATE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;C&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    LC_CTYPE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;C&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    TEMPLATE</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">template0;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#6A737D;">--简体中文字符集    </span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">chinadb2</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ENCODING</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&#39;EUC_CN&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    LC_COLLATE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;zh_CN&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    LC_CTYPE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;zh_CN&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    TEMPLATE</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">template0;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> clocaledb </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ENCODING</span><span style="color:#24292E;">  </span><span style="color:#032F62;">&#39;SQL_ASCII&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    LC_COLLATE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;C&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    LC_CTYPE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;C&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    TEMPLATE</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">template1;</span></span>
<span class="line"><span style="color:#24292E;">错误:  新的编码(SQL_ASCII)与模板数据库(UTF8)的编码不兼容</span></span>
<span class="line"><span style="color:#24292E;">提示:  在模版数据库中使用同一编码，或者使用template0作为模版.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># </span><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> clocaledb</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ENCODING</span><span style="color:#24292E;">  </span><span style="color:#032F62;">&#39;SQL_ASCII&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">     LC_COLLATE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;C&#39;</span><span style="color:#24292E;"> LC_CTYPE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;C&#39;</span><span style="color:#24292E;"> TEMPLATE</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">template0;</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--其他例子</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">englishdb</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ENCODING</span><span style="color:#24292E;">  </span><span style="color:#032F62;">&#39;UTF8&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    LC_COLLATE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;en_GB.UTF8&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    LC_CTYPE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;en_GB.UTF8&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    TEMPLATE</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">template0;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#6A737D;">--简体中文字符集</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">chinadb</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ENCODING</span><span style="color:#24292E;">  </span><span style="color:#032F62;">&#39;EUC_CN&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    LC_COLLATE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;C&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    LC_CTYPE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;C&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    TEMPLATE</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">template0;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#6A737D;">--简体中文字符集    </span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">chinadb2</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ENCODING</span><span style="color:#24292E;">  </span><span style="color:#032F62;">&#39;EUC_CN&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    LC_COLLATE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;zh_CN&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    LC_CTYPE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;zh_CN&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    TEMPLATE</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">template0;</span></span></code></pre></div><p>当且仅当用template0作为模板数据库时可指定新的编码（这里指server_encoding） PG被支持的字符集参考<a href="http://www.postgres.cn/docs/10/multibyte.html#MULTIBYTE-CHARSET-SUPPORTED" target="_blank" rel="noreferrer">http://www.postgres.cn/docs/10/multibyte.html#MULTIBYTE-CHARSET-SUPPORTED</a></p><p>注意：新的编码和区域设置要对应，否则会报错： ERROR: encoding “XXX” does not match locale “XXX”</p><h2 id="默认数据库模板" tabindex="-1">默认数据库模板 <a class="header-anchor" href="#默认数据库模板" aria-label="Permalink to &quot;默认数据库模板&quot;">​</a></h2><ul><li>默认模板库为 template1</li></ul><p>备注：建库时如果不指定 TEMPLATE 属性，默认用的是 template1 模板库.</p><ul><li>手工指定模板库</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# create database db2 template template0;</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE DATABASE</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# create database db2 template template0;</span></span>
<span class="line"><span style="color:#24292e;">CREATE DATABASE</span></span></code></pre></div><p>备注：也可以指定模板库为 template1</p><h2 id="template1-和-template0-的区别" tabindex="-1">Template1 和 Template0 的区别 <a class="header-anchor" href="#template1-和-template0-的区别" aria-label="Permalink to &quot;Template1 和 Template0 的区别&quot;">​</a></h2><ol><li>template1 可以连接并创建对象，template0 不可以连接</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres@127.0.0.1 ~=#\\c template1</span></span>
<span class="line"><span style="color:#e1e4e8;">You are now connected to database &quot;template1&quot; as user &quot;postgres&quot;.</span></span>
<span class="line"><span style="color:#e1e4e8;">postgres@127.0.0.1 template1=#</span></span>
<span class="line"><span style="color:#e1e4e8;">postgres@127.0.0.1 template1=#\\c template0</span></span>
<span class="line"><span style="color:#e1e4e8;">FATAL:  database &quot;template0&quot; is not currently accepting connections</span></span>
<span class="line"><span style="color:#e1e4e8;">Previous connection kept</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres@127.0.0.1 ~=#\\c template1</span></span>
<span class="line"><span style="color:#24292e;">You are now connected to database &quot;template1&quot; as user &quot;postgres&quot;.</span></span>
<span class="line"><span style="color:#24292e;">postgres@127.0.0.1 template1=#</span></span>
<span class="line"><span style="color:#24292e;">postgres@127.0.0.1 template1=#\\c template0</span></span>
<span class="line"><span style="color:#24292e;">FATAL:  database &quot;template0&quot; is not currently accepting connections</span></span>
<span class="line"><span style="color:#24292e;">Previous connection kept</span></span></code></pre></div><ol start="2"><li>使用 template1 模板库建库时不可指定新的 encoding 和 locale，而 template0 可以</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">template1=# create database db3 TEMPLATE template0 ENCODING &#39;SQL_ASCII&#39; ;</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE DATABASE</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">template1=# create database db4 TEMPLATE template1 ENCODING &#39;SQL_ASCII&#39; ;</span></span>
<span class="line"><span style="color:#e1e4e8;">ERROR:  new encoding (SQL_ASCII) is incompatible with the encoding of the template database (UTF8)</span></span>
<span class="line"><span style="color:#e1e4e8;">HINT:  Use the same encoding as in the template database, or use template0 as template.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">template1=# create database db3 TEMPLATE template0 ENCODING &#39;SQL_ASCII&#39; ;</span></span>
<span class="line"><span style="color:#24292e;">CREATE DATABASE</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">template1=# create database db4 TEMPLATE template1 ENCODING &#39;SQL_ASCII&#39; ;</span></span>
<span class="line"><span style="color:#24292e;">ERROR:  new encoding (SQL_ASCII) is incompatible with the encoding of the template database (UTF8)</span></span>
<span class="line"><span style="color:#24292e;">HINT:  Use the same encoding as in the template database, or use template0 as template.</span></span></code></pre></div><ol start="3"><li>Template0、Template1 库都不可删除</li></ol><p>备注：当然有方法删除 template1 库，而且这个操作并不危险，需要修改系统表</p><ol start="4"><li>克隆数据库</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres@127.0.0.1 db2=#create database db4 TEMPLATE db3 ;</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE DATABASE</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres@127.0.0.1 db2=#create database db4 TEMPLATE db3 ;</span></span>
<span class="line"><span style="color:#24292e;">CREATE DATABASE</span></span></code></pre></div><p>备注：这种方法在复制数据库时提供了方便, 也可以定制自己的数据库模板， 但是这么操作有个前提，复制时源库不可以连接， 复制过程中也不允许连接源库,</p><h1 id="_11-conninfo" tabindex="-1">11，conninfo <a class="header-anchor" href="#_11-conninfo" aria-label="Permalink to &quot;11，conninfo&quot;">​</a></h1><h2 id="_1-常见psql连接数据库" tabindex="-1">1. 常见psql连接数据库 <a class="header-anchor" href="#_1-常见psql连接数据库" aria-label="Permalink to &quot;1. 常见psql连接数据库&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">$ psql -h127.0.0.1 -Upostgres postgres</span></span>
<span class="line"><span style="color:#e1e4e8;">psql (12.1)</span></span>
<span class="line"><span style="color:#e1e4e8;">Type &quot;help&quot; for help.</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">postgres=# \\conninfo</span></span>
<span class="line"><span style="color:#e1e4e8;">You are connected to database &quot;postgres&quot; as user &quot;postgres&quot; on host &quot;127.0.0.1&quot; at port &quot;5432&quot;.</span></span>
<span class="line"><span style="color:#e1e4e8;">postgres=#</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">$ psql -h127.0.0.1 -Upostgres postgres</span></span>
<span class="line"><span style="color:#24292e;">psql (12.1)</span></span>
<span class="line"><span style="color:#24292e;">Type &quot;help&quot; for help.</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">postgres=# \\conninfo</span></span>
<span class="line"><span style="color:#24292e;">You are connected to database &quot;postgres&quot; as user &quot;postgres&quot; on host &quot;127.0.0.1&quot; at port &quot;5432&quot;.</span></span>
<span class="line"><span style="color:#24292e;">postgres=#</span></span></code></pre></div><p>使用元命令\\conninfo可以查看数据库连接信息，包括主机、端口、数据库名称、数据库用户</p><h2 id="_2-同一用户切换到其他数据库" tabindex="-1">2.同一用户切换到其他数据库 <a class="header-anchor" href="#_2-同一用户切换到其他数据库" aria-label="Permalink to &quot;2.同一用户切换到其他数据库&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">test=# \\connect test</span></span>
<span class="line"><span style="color:#e1e4e8;">You are now connected to database &quot;test&quot; as user &quot;postgres&quot;.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">test=# \\connect test</span></span>
<span class="line"><span style="color:#24292e;">You are now connected to database &quot;test&quot; as user &quot;postgres&quot;.</span></span></code></pre></div><h2 id="_3-同一库切换登录用户" tabindex="-1">3. 同一库切换登录用户 <a class="header-anchor" href="#_3-同一库切换登录用户" aria-label="Permalink to &quot;3. 同一库切换登录用户&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># \\</span><span style="color:#F97583;">connect</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> test</span></span>
<span class="line"><span style="color:#F97583;">Password</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> user test: </span></span>
<span class="line"><span style="color:#E1E4E8;">You are </span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;"> connected </span><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;test&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> user </span><span style="color:#9ECBFF;">&quot;test&quot;</span><span style="color:#E1E4E8;">.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># \\</span><span style="color:#D73A49;">connect</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> test</span></span>
<span class="line"><span style="color:#D73A49;">Password</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> user test: </span></span>
<span class="line"><span style="color:#24292E;">You are </span><span style="color:#D73A49;">now</span><span style="color:#24292E;"> connected </span><span style="color:#D73A49;">to</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> user </span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;">.</span></span></code></pre></div><p>当前数据库为test，数据库不变，登录用户由postgres切换到test 单独切换用户，需要加 “-”</p><h2 id="_4-当前实例同时切换数据库和登录用户" tabindex="-1">4.当前实例同时切换数据库和登录用户 <a class="header-anchor" href="#_4-当前实例同时切换数据库和登录用户" aria-label="Permalink to &quot;4.当前实例同时切换数据库和登录用户&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> \\conninfo</span></span>
<span class="line"><span style="color:#E1E4E8;">You are connected </span><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;test&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> user </span><span style="color:#9ECBFF;">&quot;test&quot;</span><span style="color:#E1E4E8;"> via socket </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/var/run/postgresql&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">at</span><span style="color:#E1E4E8;"> port </span><span style="color:#9ECBFF;">&quot;5432&quot;</span><span style="color:#E1E4E8;">.</span></span>
<span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> \\</span><span style="color:#F97583;">connect</span><span style="color:#E1E4E8;"> postgres postgres</span></span>
<span class="line"><span style="color:#E1E4E8;">You are </span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;"> connected </span><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> user </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;">.</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> \\conninfo</span></span>
<span class="line"><span style="color:#24292E;">You are connected </span><span style="color:#D73A49;">to</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> user </span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;"> via socket </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/var/run/postgresql&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">at</span><span style="color:#24292E;"> port </span><span style="color:#032F62;">&quot;5432&quot;</span><span style="color:#24292E;">.</span></span>
<span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> \\</span><span style="color:#D73A49;">connect</span><span style="color:#24292E;"> postgres postgres</span></span>
<span class="line"><span style="color:#24292E;">You are </span><span style="color:#D73A49;">now</span><span style="color:#24292E;"> connected </span><span style="color:#D73A49;">to</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> user </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;">.</span></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=&gt;</span></span></code></pre></div><p>当前数据库为test，登录用户为test，切换数据库为postgres，且切换登录用户为postgres</p><h2 id="_5-切换主机和数据库" tabindex="-1">5.切换主机和数据库 <a class="header-anchor" href="#_5-切换主机和数据库" aria-label="Permalink to &quot;5.切换主机和数据库&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ psql </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Upostgres</span></span>
<span class="line"><span style="color:#E1E4E8;">psql (</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">Type</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;help&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> help.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># \\conninfo</span></span>
<span class="line"><span style="color:#E1E4E8;">You are connected </span><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> user </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;"> via socket </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/var/run/postgresql&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">at</span><span style="color:#E1E4E8;"> port </span><span style="color:#9ECBFF;">&quot;5432&quot;</span><span style="color:#E1E4E8;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># \\</span><span style="color:#F97583;">connect</span><span style="color:#E1E4E8;"> test </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">168</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">99</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">200</span></span>
<span class="line"><span style="color:#E1E4E8;">You are </span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;"> connected </span><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;test&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> user </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> host </span><span style="color:#9ECBFF;">&quot;192.168.99.200&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">at</span><span style="color:#E1E4E8;"> port </span><span style="color:#9ECBFF;">&quot;5432&quot;</span><span style="color:#E1E4E8;">.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ psql </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Upostgres</span></span>
<span class="line"><span style="color:#24292E;">psql (</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">Type</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;help&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> help.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># \\conninfo</span></span>
<span class="line"><span style="color:#24292E;">You are connected </span><span style="color:#D73A49;">to</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> user </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;"> via socket </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/var/run/postgresql&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">at</span><span style="color:#24292E;"> port </span><span style="color:#032F62;">&quot;5432&quot;</span><span style="color:#24292E;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># \\</span><span style="color:#D73A49;">connect</span><span style="color:#24292E;"> test </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">168</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">99</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">200</span></span>
<span class="line"><span style="color:#24292E;">You are </span><span style="color:#D73A49;">now</span><span style="color:#24292E;"> connected </span><span style="color:#D73A49;">to</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> user </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> host </span><span style="color:#032F62;">&quot;192.168.99.200&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">at</span><span style="color:#24292E;"> port </span><span style="color:#032F62;">&quot;5432&quot;</span><span style="color:#24292E;">.</span></span></code></pre></div><p>主机参数前面需要加 “-”</p><h2 id="_6-切换主机、数据库和登录用户-端口为默认" tabindex="-1">6.切换主机、数据库和登录用户(端口为默认) <a class="header-anchor" href="#_6-切换主机、数据库和登录用户-端口为默认" aria-label="Permalink to &quot;6.切换主机、数据库和登录用户(端口为默认)&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ psql </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Upostgres</span></span>
<span class="line"><span style="color:#E1E4E8;">psql (</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">Type</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;help&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> help.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># \\conninfo</span></span>
<span class="line"><span style="color:#E1E4E8;">You are connected </span><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> user </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;"> via socket </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/var/run/postgresql&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">at</span><span style="color:#E1E4E8;"> port </span><span style="color:#9ECBFF;">&quot;5432&quot;</span><span style="color:#E1E4E8;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># \\</span><span style="color:#F97583;">connect</span><span style="color:#E1E4E8;"> test test </span><span style="color:#79B8FF;">192</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">168</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">99</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">200</span></span>
<span class="line"><span style="color:#F97583;">Password</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> user test: </span></span>
<span class="line"><span style="color:#E1E4E8;">You are </span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;"> connected </span><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;test&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> user </span><span style="color:#9ECBFF;">&quot;test&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> host </span><span style="color:#9ECBFF;">&quot;192.168.99.200&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">at</span><span style="color:#E1E4E8;"> port </span><span style="color:#9ECBFF;">&quot;5432&quot;</span><span style="color:#E1E4E8;">.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ psql </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Upostgres</span></span>
<span class="line"><span style="color:#24292E;">psql (</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">Type</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;help&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> help.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># \\conninfo</span></span>
<span class="line"><span style="color:#24292E;">You are connected </span><span style="color:#D73A49;">to</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> user </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;"> via socket </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/var/run/postgresql&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">at</span><span style="color:#24292E;"> port </span><span style="color:#032F62;">&quot;5432&quot;</span><span style="color:#24292E;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># \\</span><span style="color:#D73A49;">connect</span><span style="color:#24292E;"> test test </span><span style="color:#005CC5;">192</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">168</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">99</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">200</span></span>
<span class="line"><span style="color:#D73A49;">Password</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> user test: </span></span>
<span class="line"><span style="color:#24292E;">You are </span><span style="color:#D73A49;">now</span><span style="color:#24292E;"> connected </span><span style="color:#D73A49;">to</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> user </span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> host </span><span style="color:#032F62;">&quot;192.168.99.200&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">at</span><span style="color:#24292E;"> port </span><span style="color:#032F62;">&quot;5432&quot;</span><span style="color:#24292E;">.</span></span></code></pre></div><h2 id="_7-切换主机、数据库和登录用户以及端口" tabindex="-1">7.切换主机、数据库和登录用户以及端口 <a class="header-anchor" href="#_7-切换主机、数据库和登录用户以及端口" aria-label="Permalink to &quot;7.切换主机、数据库和登录用户以及端口&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ psql </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Upostgres</span></span>
<span class="line"><span style="color:#E1E4E8;">psql (</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">Type</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;help&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> help.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># \\conninfo</span></span>
<span class="line"><span style="color:#E1E4E8;">You are connected </span><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> user </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;"> via socket </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/var/run/postgresql&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">at</span><span style="color:#E1E4E8;"> port </span><span style="color:#9ECBFF;">&quot;5432&quot;</span><span style="color:#E1E4E8;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># \\</span><span style="color:#F97583;">connect</span><span style="color:#E1E4E8;"> postgres test </span><span style="color:#79B8FF;">192</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">168</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">99</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5432</span></span>
<span class="line"><span style="color:#F97583;">Password</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> user test: </span></span>
<span class="line"><span style="color:#E1E4E8;">You are </span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;"> connected </span><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> user </span><span style="color:#9ECBFF;">&quot;test&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> host </span><span style="color:#9ECBFF;">&quot;192.168.99.200&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">at</span><span style="color:#E1E4E8;"> port </span><span style="color:#9ECBFF;">&quot;5432&quot;</span><span style="color:#E1E4E8;">.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ psql </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Upostgres</span></span>
<span class="line"><span style="color:#24292E;">psql (</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">Type</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;help&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> help.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># \\conninfo</span></span>
<span class="line"><span style="color:#24292E;">You are connected </span><span style="color:#D73A49;">to</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> user </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;"> via socket </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/var/run/postgresql&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">at</span><span style="color:#24292E;"> port </span><span style="color:#032F62;">&quot;5432&quot;</span><span style="color:#24292E;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># \\</span><span style="color:#D73A49;">connect</span><span style="color:#24292E;"> postgres test </span><span style="color:#005CC5;">192</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">168</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">99</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5432</span></span>
<span class="line"><span style="color:#D73A49;">Password</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> user test: </span></span>
<span class="line"><span style="color:#24292E;">You are </span><span style="color:#D73A49;">now</span><span style="color:#24292E;"> connected </span><span style="color:#D73A49;">to</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> user </span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> host </span><span style="color:#032F62;">&quot;192.168.99.200&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">at</span><span style="color:#24292E;"> port </span><span style="color:#032F62;">&quot;5432&quot;</span><span style="color:#24292E;">.</span></span></code></pre></div><h2 id="_8-使用conninfo" tabindex="-1">8. 使用conninfo <a class="header-anchor" href="#_8-使用conninfo" aria-label="Permalink to &quot;8. 使用conninfo&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ psql </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Upostgres</span></span>
<span class="line"><span style="color:#E1E4E8;">psql (</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">Type</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;help&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> help.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># \\c </span><span style="color:#9ECBFF;">&quot;hostaddr=127.0.0.1 port=5432 user=test password=123456 dbname=test&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">You are </span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;"> connected </span><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;test&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> user </span><span style="color:#9ECBFF;">&quot;test&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> host </span><span style="color:#9ECBFF;">&quot;127.0.0.1&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">at</span><span style="color:#E1E4E8;"> port </span><span style="color:#9ECBFF;">&quot;5432&quot;</span><span style="color:#E1E4E8;">.</span></span>
<span class="line"><span style="color:#E1E4E8;">test</span><span style="color:#F97583;">=&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ psql </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Upostgres</span></span>
<span class="line"><span style="color:#24292E;">psql (</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">Type</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;help&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> help.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># \\c </span><span style="color:#032F62;">&quot;hostaddr=127.0.0.1 port=5432 user=test password=123456 dbname=test&quot;</span></span>
<span class="line"><span style="color:#24292E;">You are </span><span style="color:#D73A49;">now</span><span style="color:#24292E;"> connected </span><span style="color:#D73A49;">to</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> user </span><span style="color:#032F62;">&quot;test&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> host </span><span style="color:#032F62;">&quot;127.0.0.1&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">at</span><span style="color:#24292E;"> port </span><span style="color:#032F62;">&quot;5432&quot;</span><span style="color:#24292E;">.</span></span>
<span class="line"><span style="color:#24292E;">test</span><span style="color:#D73A49;">=&gt;</span></span></code></pre></div><h1 id="_12-psqlrc" tabindex="-1">12.psqlrc <a class="header-anchor" href="#_12-psqlrc" aria-label="Permalink to &quot;12.psqlrc&quot;">​</a></h1><p>.psqlrc 写好的脚本支持 Tab 补全</p><p>psqlrc 文件用来定制 psql 客户端特性的配置文件，定制后对当前客户端全局生效，在 linux 环境下位于 ~/.psqlrc， windows 平台位于 %APPDATA%\\postgresql\\psqlrc.conf</p><ul><li>查询连接数</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[ptgres@k8s1 </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]$ cat .psqlrc </span></span>
<span class="line"><span style="color:#B392F0;">\\set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">con</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;select datname,usename,client_addr,count(*) from pg_stat_activity where pid &lt;&gt; pg_backend_pid() group by 1,2,3 order by 1,2,4 desc ;&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[ptgres@k8s1 </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]$ cat .psqlrc </span></span>
<span class="line"><span style="color:#6F42C1;">\\set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">con</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;select datname,usename,client_addr,count(*) from pg_stat_activity where pid &lt;&gt; pg_backend_pid() group by 1,2,3 order by 1,2,4 desc ;&#39;</span></span></code></pre></div><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">#查看</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"># :con</span></span>
<span class="line"><span style="color:#E1E4E8;"> datname | usename  | client_addr | count </span></span>
<span class="line"><span style="color:#6A737D;">---------+----------+-------------+-------</span></span>
<span class="line"><span style="color:#E1E4E8;">         | postgres |             |     </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">         |          |             |     </span><span style="color:#79B8FF;">4</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">#查看</span></span>
<span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;"># :con</span></span>
<span class="line"><span style="color:#24292E;"> datname | usename  | client_addr | count </span></span>
<span class="line"><span style="color:#6A737D;">---------+----------+-------------+-------</span></span>
<span class="line"><span style="color:#24292E;">         | postgres |             |     </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">         |          |             |     </span><span style="color:#005CC5;">4</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span></code></pre></div><ul><li>查询用来查询当前活动会话</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">\\set active_session &#39;select pid, datname, usename, query_start, client_addr, query from pg_stat_activity where state=\\&#39;active\\&#39; and pid &lt;&gt; pg_backend_pid() order by query;&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">\\set active_session &#39;select pid, datname, usename, query_start, client_addr, query from pg_stat_activity where state=\\&#39;active\\&#39; and pid &lt;&gt; pg_backend_pid() order by query;&#39;</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# :active_session</span></span>
<span class="line"><span style="color:#e1e4e8;"> pid | datname | usename | query_start | client_addr | query </span></span>
<span class="line"><span style="color:#e1e4e8;">-----+---------+---------+-------------+-------------+-------</span></span>
<span class="line"><span style="color:#e1e4e8;">(0 rows)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# :active_session</span></span>
<span class="line"><span style="color:#24292e;"> pid | datname | usename | query_start | client_addr | query </span></span>
<span class="line"><span style="color:#24292e;">-----+---------+---------+-------------+-------------+-------</span></span>
<span class="line"><span style="color:#24292e;">(0 rows)</span></span></code></pre></div><ul><li>表空间占用</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">\\set top10_ts_table &#39;select relname, relkind, relpages,pg_size_pretty(pg_relation_size(a.oid)),reltablespace,relowner from pg_class a, pg_tablespace tb where a.relkind in (\\&#39;r\\&#39;, \\&#39;i\\&#39;) and a.reltablespace=tb.oid and tb.spcname=\\&#39;:v_spcname\\&#39; order by a.relpages desc limit 10;&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">\\set top10_ts_table &#39;select relname, relkind, relpages,pg_size_pretty(pg_relation_size(a.oid)),reltablespace,relowner from pg_class a, pg_tablespace tb where a.relkind in (\\&#39;r\\&#39;, \\&#39;i\\&#39;) and a.reltablespace=tb.oid and tb.spcname=\\&#39;:v_spcname\\&#39; order by a.relpages desc limit 10;&#39;</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# :top10_ts_table </span></span>
<span class="line"><span style="color:#e1e4e8;"> relname | relkind | relpages | pg_size_pretty | reltablespace | relowner </span></span>
<span class="line"><span style="color:#e1e4e8;">---------+---------+----------+----------------+---------------+----------</span></span>
<span class="line"><span style="color:#e1e4e8;">(0 rows)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# :top10_ts_table </span></span>
<span class="line"><span style="color:#24292e;"> relname | relkind | relpages | pg_size_pretty | reltablespace | relowner </span></span>
<span class="line"><span style="color:#24292e;">---------+---------+----------+----------------+---------------+----------</span></span>
<span class="line"><span style="color:#24292e;">(0 rows)</span></span></code></pre></div><h1 id="_13-prompting" tabindex="-1">13.Prompting <a class="header-anchor" href="#_13-prompting" aria-label="Permalink to &quot;13.Prompting&quot;">​</a></h1><p>Prompting 参数以百分号 % 打头，主要有如下：</p><table><thead><tr><th style="text-align:center;">Prompting 参数</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:center;">%M</td><td style="text-align:left;">数据库主机全名，如果通过 UNIX Socket 连接则显示为 [local]</td></tr><tr><td style="text-align:center;">%m</td><td style="text-align:left;">也表示数据库主机名，会截断第一个 . 后的内容</td></tr><tr><td style="text-align:center;">%&gt;</td><td style="text-align:left;">数据库端口号</td></tr><tr><td style="text-align:center;">%n</td><td style="text-align:left;">会话的用户名</td></tr><tr><td style="text-align:center;">%/</td><td style="text-align:left;">当前数据库名</td></tr><tr><td style="text-align:center;">%#</td><td style="text-align:left;">如果是超级用户显示为 #，否则显示为 &gt;</td></tr><tr><td style="text-align:center;">%R</td><td style="text-align:left;">在prompt 1中，通常显示 = ，单用户模式显示为 ^，如果会话被断开显示为 !, 等等。</td></tr></tbody></table><p>备注： 默认的 prompt 的设置为 &#39;%/%R%# &#39;</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# set PROMPT1 &#39;%n@%M %~%R%# &#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">postgres@192.168.1.36 ~=#</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# set PROMPT1 &#39;%n@%M %~%R%# &#39;</span></span>
<span class="line"><span style="color:#24292e;">postgres@192.168.1.36 ~=#</span></span></code></pre></div><h1 id="_14-索引膨胀评估" tabindex="-1">14.索引膨胀评估 <a class="header-anchor" href="#_14-索引膨胀评估" aria-label="Permalink to &quot;14.索引膨胀评估&quot;">​</a></h1><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> current_database(), nspname </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> schemaname, </span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> tablename, indexname, bs</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relpages</span><span style="color:#E1E4E8;">)::</span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> real_size,</span></span>
<span class="line"><span style="color:#E1E4E8;"> bs</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">otta::</span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> estimated_size,</span></span>
<span class="line"><span style="color:#E1E4E8;"> bs</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relpages</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">otta)::</span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;">                   </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> bloat_size,</span></span>
<span class="line"><span style="color:#E1E4E8;"> bs</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relpages</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">otta)::</span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">  (bs</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relpages</span><span style="color:#E1E4E8;">)::</span><span style="color:#F97583;">bigint</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> bloat_ratio</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--  , index_tuple_hdr_bm, maxalign, pagehdr, nulldatawidth, nulldatahdrwidth, datawidth,  sub.reltuples,  sub.relpages --  (DEBUG INFO)</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> bs, nspname, table_oid, indexname, relpages, </span><span style="color:#79B8FF;">coalesce</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">   ceil((reltuples</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">4</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">nulldatahdrwidth))</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">(bs</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">pagehdr::</span><span style="color:#F97583;">float</span><span style="color:#E1E4E8;">))  </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--  ItemIdData size + computed avg size of a tuple (nulldatahdrwidth)</span></span>
<span class="line"><span style="color:#E1E4E8;"> ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> otta</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--  , index_tuple_hdr_bm, maxalign, pagehdr, nulldatawidth, nulldatahdrwidth, datawidth, reltuples --  (DEBUG INFO)</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> maxalign, bs, nspname, relname </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> indexname, reltuples, relpages, relam, table_oid,</span></span>
<span class="line"><span style="color:#E1E4E8;"> ( index_tuple_hdr_bm </span><span style="color:#F97583;">+</span></span>
<span class="line"><span style="color:#E1E4E8;">maxalign </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--  Add padding to the index tuple header to align on MAXALIGN</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> index_tuple_hdr_bm%maxalign </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> maxalign</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> index_tuple_hdr_bm%maxalign</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> nulldatawidth </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> maxalign </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--  Add padding to the data to align on MAXALIGN</span></span>
<span class="line"><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> nulldatawidth </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> nulldatawidth::</span><span style="color:#F97583;">integer</span><span style="color:#E1E4E8;">%maxalign </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> maxalign</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> nulldatawidth::</span><span style="color:#F97583;">integer</span><span style="color:#E1E4E8;">%maxalign</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#E1E4E8;"> )::</span><span style="color:#F97583;">numeric</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> nulldatahdrwidth, pagehdr</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--  , index_tuple_hdr_bm, nulldatawidth, datawidth --  (DEBUG INFO)</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nspname</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relname</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">reltuples</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relpages</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relam</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">starelid</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">attrelid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> table_oid,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">cluster_version</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">v</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">7</span></span>
<span class="line"><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> true </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> current_setting(</span><span style="color:#9ECBFF;">&#39;block_size&#39;</span><span style="color:#E1E4E8;">)::</span><span style="color:#F97583;">numeric</span></span>
<span class="line"><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8192</span><span style="color:#E1E4E8;">::</span><span style="color:#F97583;">numeric</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> bs,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- MAXALIGN:  4 on 32bits,  8 on 64bits  (and mingw32 ?)</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">version</span><span style="color:#E1E4E8;">()  ~  </span><span style="color:#9ECBFF;">&#39;mingw32&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">version</span><span style="color:#E1E4E8;">()  ~  </span><span style="color:#9ECBFF;">&#39;64-bit|x86_64|ppc64|ia64|amd64&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span></span>
<span class="line"><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> maxalign,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">/* per page header, fixed size: 20 for 7.X, 24 for others */</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">cluster_version</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">v</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">7</span></span>
<span class="line"><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">24</span></span>
<span class="line"><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> pagehdr,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">/* per tuple header: add IndexAttributeBitMapData if some cols are null-able */</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">max</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">coalesce</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">stanullfrac</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">))  </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--  IndexTupleData size</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">  ((  </span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">  )  </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">)  </span><span style="color:#6A737D;">--  IndexTupleData size +  IndexAttributeBitMapData size ( max num filed per index +  8  -  1  /8)</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> index_tuple_hdr_bm,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">/* data len: we remove null values save space using it fractionnal part from stats */</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sum</span><span style="color:#E1E4E8;">(  (</span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">coalesce</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">stanullfrac</span><span style="color:#E1E4E8;">,  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">))  </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">coalesce</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">stawidth</span><span style="color:#E1E4E8;">,  </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">)  ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> nulldatawidth</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--  , sum( s.stawidth ) AS datawidth --  (DEBUG INFO)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> pg_attribute </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> a</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> pg_statistic </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">starelid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">attrelid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">staattnum</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">attnum</span></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> nspname, relname, reltuples, relpages, indrelid, relam,</span></span>
<span class="line"><span style="color:#E1E4E8;">      string_to_array(</span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">textin</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">pg_catalog</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">int2vectorout</span><span style="color:#E1E4E8;">(indkey)),  </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;">)::</span><span style="color:#F97583;">smallint</span><span style="color:#E1E4E8;">[] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> attnum</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> pg_index</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> pg_class </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_class</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">pg_index</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexrelid</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> pg_namespace </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_namespace</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pg_class</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relnamespace</span></span>
<span class="line"><span style="color:#E1E4E8;"> ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indrelid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">attrelid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">attnum</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ANY (</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">attnum</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">substring</span><span style="color:#E1E4E8;">(current_setting(</span><span style="color:#9ECBFF;">&#39;server_version&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;#&quot;[0-9]+#&quot;%&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;#&#39;</span><span style="color:#E1E4E8;">)::</span><span style="color:#F97583;">integer</span><span style="color:#E1E4E8;"> ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> cluster_version(v)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">attnum</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">GROUP BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,  </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">,  </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">,  </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">,  </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">,  </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">,  </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">,  </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">,  </span><span style="color:#79B8FF;">9</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">cluster_version</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">v</span></span>
<span class="line"><span style="color:#E1E4E8;"> ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> s1</span></span>
<span class="line"><span style="color:#E1E4E8;"> ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> s2</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> pg_am am </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relam</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">am</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">am</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">amname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&#39;btree&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">)  </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> sub</span></span>
<span class="line"><span style="color:#F97583;">JOIN</span><span style="color:#E1E4E8;"> pg_class c </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">oid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">table_oid</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sub</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">relpages</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> current_database(), nspname </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> schemaname, </span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> tablename, indexname, bs</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relpages</span><span style="color:#24292E;">)::</span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> real_size,</span></span>
<span class="line"><span style="color:#24292E;"> bs</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">otta::</span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> estimated_size,</span></span>
<span class="line"><span style="color:#24292E;"> bs</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relpages</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">otta)::</span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;">                   </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> bloat_size,</span></span>
<span class="line"><span style="color:#24292E;"> bs</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relpages</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">otta)::</span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">  (bs</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relpages</span><span style="color:#24292E;">)::</span><span style="color:#D73A49;">bigint</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> bloat_ratio</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">--  , index_tuple_hdr_bm, maxalign, pagehdr, nulldatawidth, nulldatahdrwidth, datawidth,  sub.reltuples,  sub.relpages --  (DEBUG INFO)</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> bs, nspname, table_oid, indexname, relpages, </span><span style="color:#005CC5;">coalesce</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">   ceil((reltuples</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">4</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">nulldatahdrwidth))</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">(bs</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">pagehdr::</span><span style="color:#D73A49;">float</span><span style="color:#24292E;">))  </span><span style="color:#D73A49;">+</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">--  ItemIdData size + computed avg size of a tuple (nulldatahdrwidth)</span></span>
<span class="line"><span style="color:#24292E;"> ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> otta</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">--  , index_tuple_hdr_bm, maxalign, pagehdr, nulldatawidth, nulldatahdrwidth, datawidth, reltuples --  (DEBUG INFO)</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> maxalign, bs, nspname, relname </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> indexname, reltuples, relpages, relam, table_oid,</span></span>
<span class="line"><span style="color:#24292E;"> ( index_tuple_hdr_bm </span><span style="color:#D73A49;">+</span></span>
<span class="line"><span style="color:#24292E;">maxalign </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">--  Add padding to the index tuple header to align on MAXALIGN</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> index_tuple_hdr_bm%maxalign </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> maxalign</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> index_tuple_hdr_bm%maxalign</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> nulldatawidth </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> maxalign </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">--  Add padding to the data to align on MAXALIGN</span></span>
<span class="line"><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> nulldatawidth </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> nulldatawidth::</span><span style="color:#D73A49;">integer</span><span style="color:#24292E;">%maxalign </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> maxalign</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> nulldatawidth::</span><span style="color:#D73A49;">integer</span><span style="color:#24292E;">%maxalign</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#24292E;"> )::</span><span style="color:#D73A49;">numeric</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> nulldatahdrwidth, pagehdr</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">--  , index_tuple_hdr_bm, nulldatawidth, datawidth --  (DEBUG INFO)</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nspname</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relname</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">reltuples</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relpages</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relam</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">starelid</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">attrelid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> table_oid,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">cluster_version</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">v</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">7</span></span>
<span class="line"><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> true </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> current_setting(</span><span style="color:#032F62;">&#39;block_size&#39;</span><span style="color:#24292E;">)::</span><span style="color:#D73A49;">numeric</span></span>
<span class="line"><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8192</span><span style="color:#24292E;">::</span><span style="color:#D73A49;">numeric</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> bs,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- MAXALIGN:  4 on 32bits,  8 on 64bits  (and mingw32 ?)</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">version</span><span style="color:#24292E;">()  ~  </span><span style="color:#032F62;">&#39;mingw32&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">version</span><span style="color:#24292E;">()  ~  </span><span style="color:#032F62;">&#39;64-bit|x86_64|ppc64|ia64|amd64&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span></span>
<span class="line"><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> maxalign,</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">/* per page header, fixed size: 20 for 7.X, 24 for others */</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">cluster_version</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">v</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">7</span></span>
<span class="line"><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">24</span></span>
<span class="line"><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> pagehdr,</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">/* per tuple header: add IndexAttributeBitMapData if some cols are null-able */</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">max</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">coalesce</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">stanullfrac</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">))  </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">--  IndexTupleData size</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">+</span><span style="color:#24292E;">  ((  </span><span style="color:#005CC5;">32</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">+</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">  )  </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">)  </span><span style="color:#6A737D;">--  IndexTupleData size +  IndexAttributeBitMapData size ( max num filed per index +  8  -  1  /8)</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> index_tuple_hdr_bm,</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">/* data len: we remove null values save space using it fractionnal part from stats */</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sum</span><span style="color:#24292E;">(  (</span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">coalesce</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">stanullfrac</span><span style="color:#24292E;">,  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">))  </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">coalesce</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">stawidth</span><span style="color:#24292E;">,  </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">)  ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> nulldatawidth</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">--  , sum( s.stawidth ) AS datawidth --  (DEBUG INFO)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> pg_attribute </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> a</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> pg_statistic </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">starelid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">attrelid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">staattnum</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">attnum</span></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> nspname, relname, reltuples, relpages, indrelid, relam,</span></span>
<span class="line"><span style="color:#24292E;">      string_to_array(</span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">textin</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">pg_catalog</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">int2vectorout</span><span style="color:#24292E;">(indkey)),  </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;">)::</span><span style="color:#D73A49;">smallint</span><span style="color:#24292E;">[] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> attnum</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> pg_index</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> pg_class </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_class</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">pg_index</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexrelid</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> pg_namespace </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_namespace</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pg_class</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relnamespace</span></span>
<span class="line"><span style="color:#24292E;"> ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indrelid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">attrelid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">attnum</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ANY (</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">attnum</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">substring</span><span style="color:#24292E;">(current_setting(</span><span style="color:#032F62;">&#39;server_version&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;#&quot;[0-9]+#&quot;%&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;#&#39;</span><span style="color:#24292E;">)::</span><span style="color:#D73A49;">integer</span><span style="color:#24292E;"> ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> cluster_version(v)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">attnum</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">GROUP BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,  </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">,  </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">,  </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">,  </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">,  </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">,  </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">,  </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">,  </span><span style="color:#005CC5;">9</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">cluster_version</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">v</span></span>
<span class="line"><span style="color:#24292E;"> ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> s1</span></span>
<span class="line"><span style="color:#24292E;"> ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> s2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> pg_am am </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relam</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">am</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">am</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">amname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span><span style="color:#032F62;">&#39;btree&#39;</span></span>
<span class="line"><span style="color:#24292E;">)  </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> sub</span></span>
<span class="line"><span style="color:#D73A49;">JOIN</span><span style="color:#24292E;"> pg_class c </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">oid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">table_oid</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sub</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">relpages</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">;</span></span></code></pre></div><h1 id="_15-查看编译后参数" tabindex="-1">15.查看编译后参数 <a class="header-anchor" href="#_15-查看编译后参数" aria-label="Permalink to &quot;15.查看编译后参数&quot;">​</a></h1><p>[ptgres@k8s1 ~]$ pg_config --configure</p><h1 id="_16-查询数据库ip来源" tabindex="-1">16.查询数据库ip来源 <a class="header-anchor" href="#_16-查询数据库ip来源" aria-label="Permalink to &quot;16.查询数据库ip来源&quot;">​</a></h1><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> datname,usename ,client_addr,client_port </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> datname</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;db2&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> datname,usename ,client_addr,client_port </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> datname</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;db2&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h1 id="_17-免密码登录" tabindex="-1">17.免密码登录 <a class="header-anchor" href="#_17-免密码登录" aria-label="Permalink to &quot;17.免密码登录&quot;">​</a></h1><h2 id="_1-设置环境变量-pgpassword" tabindex="-1">1.设置环境变量 PGPASSWORD <a class="header-anchor" href="#_1-设置环境变量-pgpassword" aria-label="Permalink to &quot;1.设置环境变量 PGPASSWORD&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres@127.0.0.1 ~=#export PGPASSWORD=skytf</span></span>
<span class="line"><span style="color:#e1e4e8;">#psql -h 192.168.1.25 -p 1921 skytf skytf</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres@127.0.0.1 ~=#export PGPASSWORD=skytf</span></span>
<span class="line"><span style="color:#24292e;">#psql -h 192.168.1.25 -p 1921 skytf skytf</span></span></code></pre></div><h2 id="_2-设置-pgpass-密码文件" tabindex="-1">2.设置 .pgpass 密码文件 <a class="header-anchor" href="#_2-设置-pgpass-密码文件" aria-label="Permalink to &quot;2.设置 .pgpass 密码文件&quot;">​</a></h2><p>修改 /home/postgres/.pgpass 文件，增加以下</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">hostname:port:database:username:password</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">Chmod 600 .pgpass</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">hostname:port:database:username:password</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">Chmod 600 .pgpass</span></span></code></pre></div><h2 id="_3-修改-pg-hba-conf" tabindex="-1">3.修改 pg_hba.conf <a class="header-anchor" href="#_3-修改-pg-hba-conf" aria-label="Permalink to &quot;3.修改 pg_hba.conf&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">host skytf skytf 172.16.3.174/32 trust</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">host skytf skytf 172.16.3.174/32 trust</span></span></code></pre></div><h1 id="_18-修改时区" tabindex="-1">18.修改时区 <a class="header-anchor" href="#_18-修改时区" aria-label="Permalink to &quot;18.修改时区&quot;">​</a></h1><h2 id="查看数据库的时区与时间" tabindex="-1">查看数据库的时区与时间 <a class="header-anchor" href="#查看数据库的时区与时间" aria-label="Permalink to &quot;查看数据库的时区与时间&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# select now();  </span></span>
<span class="line"><span style="color:#e1e4e8;">             now              </span></span>
<span class="line"><span style="color:#e1e4e8;">------------------------------</span></span>
<span class="line"><span style="color:#e1e4e8;"> 2022-03-18 11:39:04.04916+08</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# select now();  </span></span>
<span class="line"><span style="color:#24292e;">             now              </span></span>
<span class="line"><span style="color:#24292e;">------------------------------</span></span>
<span class="line"><span style="color:#24292e;"> 2022-03-18 11:39:04.04916+08</span></span></code></pre></div><h2 id="查看时区" tabindex="-1">查看时区 <a class="header-anchor" href="#查看时区" aria-label="Permalink to &quot;查看时区&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# show time zone;</span></span>
<span class="line"><span style="color:#e1e4e8;">   TimeZone    </span></span>
<span class="line"><span style="color:#e1e4e8;">---------------</span></span>
<span class="line"><span style="color:#e1e4e8;"> RPC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# show time zone;</span></span>
<span class="line"><span style="color:#24292e;">   TimeZone    </span></span>
<span class="line"><span style="color:#24292e;">---------------</span></span>
<span class="line"><span style="color:#24292e;"> RPC</span></span></code></pre></div><h2 id="选择的时区" tabindex="-1">选择的时区 <a class="header-anchor" href="#选择的时区" aria-label="Permalink to &quot;选择的时区&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">select * from pg_timezone_names;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">select * from pg_timezone_names;</span></span></code></pre></div><h3 id="会话级别" tabindex="-1">会话级别 <a class="header-anchor" href="#会话级别" aria-label="Permalink to &quot;会话级别&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# set time zone &quot;Asia/Shanghai&quot;;</span></span>
<span class="line"><span style="color:#e1e4e8;">SET</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# set time zone &quot;Asia/Shanghai&quot;;</span></span>
<span class="line"><span style="color:#24292e;">SET</span></span></code></pre></div><h3 id="永久修改" tabindex="-1">永久修改 <a class="header-anchor" href="#永久修改" aria-label="Permalink to &quot;永久修改&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">catpostgresql.conf|grep timezone</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">log_timezone = &#39;PRC&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">timezone = &#39;PRC&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">PRC指：People&#39;s Republic of China</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">catpostgresql.conf|grep timezone</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">log_timezone = &#39;PRC&#39;</span></span>
<span class="line"><span style="color:#24292e;">timezone = &#39;PRC&#39;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">PRC指：People&#39;s Republic of China</span></span></code></pre></div><h3 id="数据库级别修改" tabindex="-1">数据库级别修改 <a class="header-anchor" href="#数据库级别修改" aria-label="Permalink to &quot;数据库级别修改&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">alter database dbname set timezone=&#39;UTC&#39;;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">pipeline=# select * from pg_db_role_setting ;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">alter database dbname set timezone=&#39;UTC&#39;;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">pipeline=# select * from pg_db_role_setting ;</span></span></code></pre></div><h3 id="用户级别" tabindex="-1">用户级别 <a class="header-anchor" href="#用户级别" aria-label="Permalink to &quot;用户级别&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">alter role rolname set timezone=&#39;UTC&#39;;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">或者</span></span>
<span class="line"><span style="color:#e1e4e8;">alter role all set timezone=&#39;UTC&#39;;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">pipeline=# select * from pg_db_role_setting ;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">alter role rolname set timezone=&#39;UTC&#39;;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">或者</span></span>
<span class="line"><span style="color:#24292e;">alter role all set timezone=&#39;UTC&#39;;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">pipeline=# select * from pg_db_role_setting ;</span></span></code></pre></div><p>重新加载数据库</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">select pg_reload_conf();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">select pg_reload_conf();</span></span></code></pre></div><h1 id="_19-idle-in-transaction" tabindex="-1">19.idle in transaction <a class="header-anchor" href="#_19-idle-in-transaction" aria-label="Permalink to &quot;19.idle in transaction&quot;">​</a></h1><p><a href="https://www.postgresql.org/docs/12/runtime-config-client.html" target="_blank" rel="noreferrer">https://www.postgresql.org/docs/12/runtime-config-client.html</a></p><p>pg_stat_activity 是一张postgresql的系统视图，它的每一行都表示一个系统进程，显示与当前会话的活动进程的一些信息，比如当前会话的状态和查询等。它的state字段表示当前进程的状态，一共有六种：</p><p>1、Active(活动): 进程正在执行某个语句</p><p>2、Idle(空闲): 进程正在等待客户端的指令</p><p>3、idle in transaction(事务空闲):进程在处理事务的过程中，但当前没有执行任何语句</p><p>4、idle in transaction (aborted)(事务空闲-退出):除了事务中声明一个错误外，其余情况与idle in transaction相同</p><p>5、fastpath function call(快速通道函数调用): 后台正在执行某个快速通道函数</p><p>6、Disabled(禁用): 报告状态被禁用</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">pid</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">datname</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">usename</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">client_port</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backend_start</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_start</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">state_change</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;">,query, </span><span style="color:#79B8FF;">COUNT</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">over</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">partition</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">by</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">datname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> cntnum </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity p;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- *</span></span>
<span class="line"><span style="color:#E1E4E8;">pid</span><span style="color:#6A737D;">----&gt;连接pid</span></span>
<span class="line"><span style="color:#E1E4E8;">backend_start</span><span style="color:#6A737D;">---&gt; 客户端连接数据库时间（初始连接建立时间）</span></span>
<span class="line"><span style="color:#E1E4E8;">query_start </span><span style="color:#6A737D;">---&gt; 查询开始运行时间</span></span>
<span class="line"><span style="color:#E1E4E8;">state_change </span><span style="color:#6A737D;">---&gt;状态变化时间</span></span>
<span class="line"><span style="color:#E1E4E8;">query</span><span style="color:#6A737D;">-----》 当前连接执行的语句</span></span>
<span class="line"><span style="color:#6A737D;">--</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">pid</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">datname</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">usename</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">client_port</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backend_start</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_start</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">state_change</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">state</span><span style="color:#24292E;">,query, </span><span style="color:#005CC5;">COUNT</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">over</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">partition</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">by</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">datname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> cntnum </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity p;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- *</span></span>
<span class="line"><span style="color:#24292E;">pid</span><span style="color:#6A737D;">----&gt;连接pid</span></span>
<span class="line"><span style="color:#24292E;">backend_start</span><span style="color:#6A737D;">---&gt; 客户端连接数据库时间（初始连接建立时间）</span></span>
<span class="line"><span style="color:#24292E;">query_start </span><span style="color:#6A737D;">---&gt; 查询开始运行时间</span></span>
<span class="line"><span style="color:#24292E;">state_change </span><span style="color:#6A737D;">---&gt;状态变化时间</span></span>
<span class="line"><span style="color:#24292E;">query</span><span style="color:#6A737D;">-----》 当前连接执行的语句</span></span>
<span class="line"><span style="color:#6A737D;">--</span></span></code></pre></div><h1 id="_20-数据库连接数查询" tabindex="-1">20.数据库连接数查询 <a class="header-anchor" href="#_20-数据库连接数查询" aria-label="Permalink to &quot;20.数据库连接数查询&quot;">​</a></h1><h2 id="查询当前所有连接的状态" tabindex="-1">查询当前所有连接的状态 <a class="header-anchor" href="#查询当前所有连接的状态" aria-label="Permalink to &quot;查询当前所有连接的状态&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">select datname,pid,application_name,state from pg_stat_activity;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">select datname,pid,application_name,state from pg_stat_activity;</span></span></code></pre></div><h2 id="关闭当前-state-为-idle-空闲状态的连接" tabindex="-1">关闭当前 state 为 idle 空闲状态的连接 <a class="header-anchor" href="#关闭当前-state-为-idle-空闲状态的连接" aria-label="Permalink to &quot;关闭当前 state 为 idle 空闲状态的连接&quot;">​</a></h2><p>查看数据库剩余连接数：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">select max_conn-now_conn as resi_conn from (select setting::int8 as max_conn,(select count(*) from pg_stat_activity) as now_conn from pg_settings where name = &#39;max_connections&#39;) t;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">select max_conn-now_conn as resi_conn from (select setting::int8 as max_conn,(select count(*) from pg_stat_activity) as now_conn from pg_settings where name = &#39;max_connections&#39;) t;</span></span></code></pre></div><p>查看为超级用户保留的连接数:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">show superuser_reserved_connections;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">show superuser_reserved_connections;</span></span></code></pre></div><h3 id="关闭空闲连接" tabindex="-1">关闭空闲连接 <a class="header-anchor" href="#关闭空闲连接" aria-label="Permalink to &quot;关闭空闲连接&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">#查询</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> datname,pid,application_name,</span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#关闭具体连接</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> pg_terminate_backend(pid);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#杀死所有 idle 的进程</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_terminate_backend(pid) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">state=</span><span style="color:#9ECBFF;">&#39;idle&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">#查询</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> datname,pid,application_name,</span><span style="color:#D73A49;">state</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#关闭具体连接</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> pg_terminate_backend(pid);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#杀死所有 idle 的进程</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_terminate_backend(pid) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">state=</span><span style="color:#032F62;">&#39;idle&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h1 id="_21-cpu占满100-性能分析" tabindex="-1">21.cpu占满100%性能分析 <a class="header-anchor" href="#_21-cpu占满100-性能分析" aria-label="Permalink to &quot;21.cpu占满100%性能分析&quot;">​</a></h1><h2 id="查看连接数变化" tabindex="-1">查看连接数变化 <a class="header-anchor" href="#查看连接数变化" aria-label="Permalink to &quot;查看连接数变化&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">count</span><span style="color:#E1E4E8;">( </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> ) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">like</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;%idle&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">count</span><span style="color:#24292E;">( </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> ) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">state</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">like</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;%idle&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h2 id="追踪慢sql" tabindex="-1">追踪慢SQL <a class="header-anchor" href="#追踪慢sql" aria-label="Permalink to &quot;追踪慢SQL&quot;">​</a></h2><h3 id="_1-第1种方式" tabindex="-1">1.第1种方式 <a class="header-anchor" href="#_1-第1种方式" aria-label="Permalink to &quot;1.第1种方式&quot;">​</a></h3><p>通过pg_stat_statements插件来定位慢sql</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;">\\c db_name</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;create</span><span style="color:#E1E4E8;"> extension pg_stat_statements;</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;select</span><span style="color:#E1E4E8;"> pg_stat_reset();</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;select</span><span style="color:#E1E4E8;"> pg_stat_statements_reset();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#等待1min左右</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;">\\c db_name</span></span>
<span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;create</span><span style="color:#24292E;"> extension pg_stat_statements;</span></span>
<span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;select</span><span style="color:#24292E;"> pg_stat_reset();</span></span>
<span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;select</span><span style="color:#24292E;"> pg_stat_statements_reset();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#等待1min左右</span></span></code></pre></div><ul><li>查询最耗时的SQL</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_statements </span><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> total_time </span><span style="color:#F97583;">desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">limit</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_statements </span><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> total_time </span><span style="color:#D73A49;">desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">limit</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">;</span></span></code></pre></div><ul><li>查询读取Buffer次数最多的SQL</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">#查询读取Buffer次数最多的SQL，这些SQL可能由于所查询的数据没有索引，而导致了过多的Buffer读，也同时大量消耗了CPU</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_statements </span><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> shared_blks_hit</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">shared_blks_read </span><span style="color:#F97583;">desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">limit</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">#查询读取Buffer次数最多的SQL，这些SQL可能由于所查询的数据没有索引，而导致了过多的Buffer读，也同时大量消耗了CPU</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_statements </span><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> shared_blks_hit</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">shared_blks_read </span><span style="color:#D73A49;">desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">limit</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="_2-第2种方式" tabindex="-1">2.第2种方式 <a class="header-anchor" href="#_2-第2种方式" aria-label="Permalink to &quot;2.第2种方式&quot;">​</a></h3><ul><li>通过pg_stat_activity视图</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> datname, usename, client_addr, application_name, </span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;">, backend_start, xact_start, xact_stay, query_start, query_stay, </span><span style="color:#79B8FF;">replace</span><span style="color:#E1E4E8;">(query, chr(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> query </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pgsa</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">datname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> datname, </span><span style="color:#79B8FF;">pgsa</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">usename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> usename, </span><span style="color:#79B8FF;">pgsa</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">client_addr</span><span style="color:#E1E4E8;"> client_addr, </span><span style="color:#79B8FF;">pgsa</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">application_name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> application_name, </span><span style="color:#79B8FF;">pgsa</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">state</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">pgsa</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backend_start</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> backend_start, </span><span style="color:#79B8FF;">pgsa</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xact_start</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> xact_start, extract(epoch </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pgsa</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xact_start</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> xact_stay, </span><span style="color:#79B8FF;">pgsa</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_start</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> query_start, extract(epoch </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pgsa</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query_start</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> query_stay , </span><span style="color:#79B8FF;">pgsa</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">query</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> query </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> pgsa </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pgsa</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">state</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;idle&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pgsa</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">state</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;idle in transaction&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">pgsa</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">state</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;idle in transaction (aborted)&#39;</span><span style="color:#E1E4E8;">) idleconnections </span><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> query_stay </span><span style="color:#F97583;">desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">limit</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> datname, usename, client_addr, application_name, </span><span style="color:#D73A49;">state</span><span style="color:#24292E;">, backend_start, xact_start, xact_stay, query_start, query_stay, </span><span style="color:#005CC5;">replace</span><span style="color:#24292E;">(query, chr(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">), </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> query </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pgsa</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">datname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> datname, </span><span style="color:#005CC5;">pgsa</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">usename</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> usename, </span><span style="color:#005CC5;">pgsa</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">client_addr</span><span style="color:#24292E;"> client_addr, </span><span style="color:#005CC5;">pgsa</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">application_name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> application_name, </span><span style="color:#005CC5;">pgsa</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">state</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">state</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">pgsa</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backend_start</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> backend_start, </span><span style="color:#005CC5;">pgsa</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xact_start</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> xact_start, extract(epoch </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">now</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pgsa</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xact_start</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> xact_stay, </span><span style="color:#005CC5;">pgsa</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_start</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> query_start, extract(epoch </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">now</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pgsa</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query_start</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> query_stay , </span><span style="color:#005CC5;">pgsa</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">query</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> query </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> pgsa </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pgsa</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">state</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;idle&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pgsa</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">state</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;idle in transaction&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">pgsa</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">state</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;idle in transaction (aborted)&#39;</span><span style="color:#24292E;">) idleconnections </span><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> query_stay </span><span style="color:#D73A49;">desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">limit</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="_3-第3种方式" tabindex="-1">3.第3种方式 <a class="header-anchor" href="#_3-第3种方式" aria-label="Permalink to &quot;3.第3种方式&quot;">​</a></h3><ul><li>Table Scan</li></ul><p>是从数据表上表扫描（Table Scan）的信息开始查起，查找缺失索引的表。数据表如果缺失索引，大部分热数据又都在内存时（例如内存8G，热数据6G），此时数据库只能使用表扫描，并需要处理已在内存中的大量的无关记录，而耗费大量CPU。特别是对于表记录数超100的表，一次表扫描占用大量CPU（基本把一个CPU占满），多个连接并发（例如上百连接），把所有CPU占满</p><ul><li>查出使用表扫描最多的表</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_user_tables </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> n_live_tup </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> seq_scan </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> seq_tup_read </span><span style="color:#F97583;">desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">limit</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_user_tables </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> n_live_tup </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> seq_scan </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> seq_tup_read </span><span style="color:#D73A49;">desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">limit</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">;</span></span></code></pre></div><ul><li>查询当前正在运行的访问到上述表的慢查询</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> query ilike </span><span style="color:#9ECBFF;">&#39;%&lt;table name&gt;%&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> query_start </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">now</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> interval </span><span style="color:#9ECBFF;">&#39;10 seconds&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> query ilike </span><span style="color:#032F62;">&#39;%&lt;table name&gt;%&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> query_start </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">now</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> interval </span><span style="color:#032F62;">&#39;10 seconds&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><ul><li>也通过pg_stat_statements插件定位涉及到这些表的查询</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_statements </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> query ilike </span><span style="color:#9ECBFF;">&#39;%&lt;table&gt;%&#39;</span><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> shared_blks_hit</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">shared_blks_read </span><span style="color:#F97583;">desc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">limit</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_statements </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> query ilike </span><span style="color:#032F62;">&#39;%&lt;table&gt;%&#39;</span><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> shared_blks_hit</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">shared_blks_read </span><span style="color:#D73A49;">desc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">limit</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="_4-kill-sql" tabindex="-1">4.kill SQL <a class="header-anchor" href="#_4-kill-sql" aria-label="Permalink to &quot;4.kill SQL&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_cancel_backend(pid) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;">  query </span><span style="color:#F97583;">like</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;%&lt;query text&gt;%&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> pid </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> pg_backend_pid();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">#或者</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> pg_terminate_backend(pid) </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_stat_activity </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;">  query </span><span style="color:#F97583;">like</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;%&lt;query text&gt;%&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> pid </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> pg_backend_pid();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_cancel_backend(pid) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity </span><span style="color:#D73A49;">where</span><span style="color:#24292E;">  query </span><span style="color:#D73A49;">like</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;%&lt;query text&gt;%&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> pid </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> pg_backend_pid();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">#或者</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> pg_terminate_backend(pid) </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_stat_activity </span><span style="color:#D73A49;">where</span><span style="color:#24292E;">  query </span><span style="color:#D73A49;">like</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;%&lt;query text&gt;%&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> pid </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> pg_backend_pid();</span></span></code></pre></div><p>如果这些SQL确实是业务上必需的，则需要对他们做优化。这方面有“三板斧”：</p><blockquote><p>1、对查询涉及的表，执行ANALYZE table或VACUUM ANZLYZE table，更新表的统计信息，使查询计划更准确。注意，为避免对业务影响，最好在业务低峰执行。</p><p>2、执行explain (query text)或explain (buffers true, analyze true, verbose true) (query text)命令，查看SQL的执行计划（注意，前者不会实际执行SQL，后者会实际执行而且能得到详细的执行信息），对其中的Table Scan涉及的表，建立索引。</p><p>3、重新编写SQL，去除掉不必要的子查询、改写UNION ALL、使用JOIN CLAUSE固定连接顺序等到</p></blockquote><h1 id="_22-防止误删库" tabindex="-1">22.防止误删库 <a class="header-anchor" href="#_22-防止误删库" aria-label="Permalink to &quot;22.防止误删库&quot;">​</a></h1><p>template1和template0是PostgreSQL的模板数据库。所谓模板数据库就是创建新database时，PostgreSQL会基于模板数据库制作一份副本，其中会包含所有的数据库设置和数据文件。PostgreSQL安装好以后会默认附带两个模板数据库：template0和template1</p><ul><li>设置模板库属性</li></ul><p>pg_database的datistemplate字段可以表明该库是否是模板库</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pg_database;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">oid</span><span style="color:#E1E4E8;"> |  datname  | datdba | </span><span style="color:#F97583;">encoding</span><span style="color:#E1E4E8;"> | datlocprovider | datistemplate | datallowconn | datconnlimit | datfrozenxid | datminmxid | dattablespace | datcollate </span></span>
<span class="line"><span style="color:#E1E4E8;">|  datctype  | daticulocale | daticurules | datcollversion |               datacl                </span></span>
<span class="line"><span style="color:#6A737D;">-----+-----------+--------+----------+----------------+---------------+--------------+--------------+--------------+------------+---------------+------------</span></span>
<span class="line"><span style="color:#F97583;">+</span><span style="color:#6A737D;">------------+--------------+-------------+----------------+-------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> | postgres  |     </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> |        </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> | c              | f             | t            |           </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> |          </span><span style="color:#79B8FF;">722</span><span style="color:#E1E4E8;"> |          </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> |          </span><span style="color:#79B8FF;">1663</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">en_US</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">UTF8</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">| </span><span style="color:#79B8FF;">en_US</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">UTF8</span><span style="color:#E1E4E8;"> |              |             | </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">26</span><span style="color:#E1E4E8;">           | </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> | template1 |     </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> |        </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> | c              | t             | t            |           </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> |          </span><span style="color:#79B8FF;">722</span><span style="color:#E1E4E8;"> |          </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> |          </span><span style="color:#79B8FF;">1663</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">en_US</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">UTF8</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">| </span><span style="color:#79B8FF;">en_US</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">UTF8</span><span style="color:#E1E4E8;"> |              |             | </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">26</span><span style="color:#E1E4E8;">           | {</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">c</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">postgres,postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">CTc</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">postgres}</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> | template0 |     </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> |        </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> | c              | t             | f            |           </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> |          </span><span style="color:#79B8FF;">722</span><span style="color:#E1E4E8;"> |          </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> |          </span><span style="color:#79B8FF;">1663</span><span style="color:#E1E4E8;"> | </span><span style="color:#79B8FF;">en_US</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">UTF8</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">| </span><span style="color:#79B8FF;">en_US</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">UTF8</span><span style="color:#E1E4E8;"> |              |             |                | {</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">c</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">postgres,postgres</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">CTc</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">postgres}</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pg_database;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">oid</span><span style="color:#24292E;"> |  datname  | datdba | </span><span style="color:#D73A49;">encoding</span><span style="color:#24292E;"> | datlocprovider | datistemplate | datallowconn | datconnlimit | datfrozenxid | datminmxid | dattablespace | datcollate </span></span>
<span class="line"><span style="color:#24292E;">|  datctype  | daticulocale | daticurules | datcollversion |               datacl                </span></span>
<span class="line"><span style="color:#6A737D;">-----+-----------+--------+----------+----------------+---------------+--------------+--------------+--------------+------------+---------------+------------</span></span>
<span class="line"><span style="color:#D73A49;">+</span><span style="color:#6A737D;">------------+--------------+-------------+----------------+-------------------------------------</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> | postgres  |     </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> |        </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> | c              | f             | t            |           </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> |          </span><span style="color:#005CC5;">722</span><span style="color:#24292E;"> |          </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> |          </span><span style="color:#005CC5;">1663</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">en_US</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">UTF8</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">| </span><span style="color:#005CC5;">en_US</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">UTF8</span><span style="color:#24292E;"> |              |             | </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">26</span><span style="color:#24292E;">           | </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> | template1 |     </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> |        </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> | c              | t             | t            |           </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> |          </span><span style="color:#005CC5;">722</span><span style="color:#24292E;"> |          </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> |          </span><span style="color:#005CC5;">1663</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">en_US</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">UTF8</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">| </span><span style="color:#005CC5;">en_US</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">UTF8</span><span style="color:#24292E;"> |              |             | </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">26</span><span style="color:#24292E;">           | {</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">c</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">postgres,postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">CTc</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">postgres}</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> | template0 |     </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> |        </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> | c              | t             | f            |           </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> |          </span><span style="color:#005CC5;">722</span><span style="color:#24292E;"> |          </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> |          </span><span style="color:#005CC5;">1663</span><span style="color:#24292E;"> | </span><span style="color:#005CC5;">en_US</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">UTF8</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">| </span><span style="color:#005CC5;">en_US</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">UTF8</span><span style="color:#24292E;"> |              |             |                | {</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">c</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">postgres,postgres</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">CTc</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">postgres}</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">)</span></span></code></pre></div><ul><li>模板库防止误删</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">#pg中是无法删除模板数据库的，改一下pg_database的datistemplate字段即可防止误删数据库的情况发生</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;update</span><span style="color:#E1E4E8;"> pg_database </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> datistemplate </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;true&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> datname </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;mydb&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">UPDATE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;drop</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> mydb;</span></span>
<span class="line"><span style="color:#E1E4E8;">ERROR:  cannot </span><span style="color:#F97583;">drop</span><span style="color:#E1E4E8;"> a template </span><span style="color:#F97583;">database</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">#pg中是无法删除模板数据库的，改一下pg_database的datistemplate字段即可防止误删数据库的情况发生</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;update</span><span style="color:#24292E;"> pg_database </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> datistemplate </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;true&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> datname </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;mydb&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">UPDATE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;drop</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> mydb;</span></span>
<span class="line"><span style="color:#24292E;">ERROR:  cannot </span><span style="color:#D73A49;">drop</span><span style="color:#24292E;"> a template </span><span style="color:#D73A49;">database</span></span></code></pre></div><ul><li>误删保护解除</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;update</span><span style="color:#E1E4E8;"> pg_database </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> datistemplate </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;false&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> datname </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;mydb&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">UPDATE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">postgres@postgres</span><span style="color:#F97583;">=&gt;drop</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> mydb;</span></span>
<span class="line"><span style="color:#F97583;">DROP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;update</span><span style="color:#24292E;"> pg_database </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> datistemplate </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;false&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> datname </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;mydb&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">UPDATE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">postgres@postgres</span><span style="color:#D73A49;">=&gt;drop</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> mydb;</span></span>
<span class="line"><span style="color:#D73A49;">DROP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span></span></code></pre></div>`,327),e=[o];function t(c,r,y,E,i,F){return a(),n("div",null,e)}const g=s(p,[["render",t]]);export{C as __pageData,g as default};
