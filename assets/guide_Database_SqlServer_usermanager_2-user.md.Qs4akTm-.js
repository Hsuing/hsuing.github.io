import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const F=JSON.parse('{"title":"1. 创建超级管理员","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/SqlServer/usermanager/2-user.md","filePath":"guide/Database/SqlServer/usermanager/2-user.md","lastUpdated":1739182369000}'),p={name:"guide/Database/SqlServer/usermanager/2-user.md"},o=l(`<h1 id="_1-创建超级管理员" tabindex="-1">1. 创建超级管理员 <a class="header-anchor" href="#_1-创建超级管理员" aria-label="Permalink to &quot;1. 创建超级管理员&quot;">​</a></h1><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [master]</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LOGIN</span><span style="color:#E1E4E8;"> [admin] </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PASSWORD=</span><span style="color:#9ECBFF;">N&#39;admin&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">DEFAULT_DATABASE=</span><span style="color:#E1E4E8;">[master], </span><span style="color:#F97583;">CHECK_EXPIRATION=OFF</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">CHECK_POLICY=OFF</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SERVER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ROLE</span><span style="color:#E1E4E8;"> [sysadmin] </span><span style="color:#F97583;">ADD</span><span style="color:#E1E4E8;"> MEMBER [admin]</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [master]</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LOGIN</span><span style="color:#24292E;"> [admin] </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PASSWORD=</span><span style="color:#032F62;">N&#39;admin&#39;</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">DEFAULT_DATABASE=</span><span style="color:#24292E;">[master], </span><span style="color:#D73A49;">CHECK_EXPIRATION=OFF</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">CHECK_POLICY=OFF</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">SERVER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ROLE</span><span style="color:#24292E;"> [sysadmin] </span><span style="color:#D73A49;">ADD</span><span style="color:#24292E;"> MEMBER [admin]</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><h1 id="_2-创建只读账户" tabindex="-1">2. 创建只读账户 <a class="header-anchor" href="#_2-创建只读账户" aria-label="Permalink to &quot;2. 创建只读账户&quot;">​</a></h1><h2 id="_2-1-创建登录服务器账户" tabindex="-1">2.1 创建登录服务器账户 <a class="header-anchor" href="#_2-1-创建登录服务器账户" aria-label="Permalink to &quot;2.1 创建登录服务器账户&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> MyDatabase;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LOGIN</span><span style="color:#E1E4E8;"> MyUser </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PASSWORD</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;han123&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">CHECK_POLICY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OFF</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">CHECK_EXPIRATION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OFF</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 创建数据库用户</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">USER</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">MyUser</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LOGIN</span><span style="color:#E1E4E8;"> MyUser;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> MyDatabase;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LOGIN</span><span style="color:#24292E;"> MyUser </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PASSWORD</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;han123&#39;</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">CHECK_POLICY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OFF</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">CHECK_EXPIRATION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OFF</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 创建数据库用户</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">USER</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MyUser</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LOGIN</span><span style="color:#24292E;"> MyUser;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><ul><li><code>CREATE LOGIN</code> 命令用于在 SQL Server 实例级别创建登录账户</li><li><code>CREATE USER</code> 命令则用于在特定数据库中创建用户账户</li></ul><h2 id="_2-2-授权" tabindex="-1">2.2 授权 <a class="header-anchor" href="#_2-2-授权" aria-label="Permalink to &quot;2.2 授权&quot;">​</a></h2><h3 id="_1-role授权" tabindex="-1">1.role授权 <a class="header-anchor" href="#_1-role授权" aria-label="Permalink to &quot;1.role授权&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_addrolemember </span><span style="color:#9ECBFF;">&#39;db_datareader&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;MyUser&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [YourDatabaseName];</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ROLE</span><span style="color:#E1E4E8;"> db_datareader </span><span style="color:#F97583;">ADD</span><span style="color:#E1E4E8;"> MEMBER MyUser;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_addrolemember </span><span style="color:#032F62;">&#39;db_datareader&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;MyUser&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [YourDatabaseName];</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ROLE</span><span style="color:#24292E;"> db_datareader </span><span style="color:#D73A49;">ADD</span><span style="color:#24292E;"> MEMBER MyUser;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><h3 id="_2-限制访问特定对象" tabindex="-1">2.限制访问特定对象 <a class="header-anchor" href="#_2-限制访问特定对象" aria-label="Permalink to &quot;2.限制访问特定对象&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [YourDatabaseName];</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">GRANT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> [YourSchema].[YourTable] </span><span style="color:#F97583;">TO</span><span style="color:#E1E4E8;"> [ReadOnlyUser];</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [YourDatabaseName];</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">GRANT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> [YourSchema].[YourTable] </span><span style="color:#D73A49;">TO</span><span style="color:#24292E;"> [ReadOnlyUser];</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><h1 id="_3-alwayson从库用户权限" tabindex="-1">3. AlwaysOn从库用户权限 <a class="header-anchor" href="#_3-alwayson从库用户权限" aria-label="Permalink to &quot;3. AlwaysOn从库用户权限&quot;">​</a></h1><p>现象：</p><p>现有SQL SERVER服务器A和B，两个环境都提前创建好用户，设置好权限，然后搭建的AlwaysOn,主副本为A，辅助副本为B，客户端连接正常。切换主库为B后，客户端无法连接。查看A与B中的用户权限可以发现，用户名密码都是一样的，但在数据库映射这一项，A中用户有映射到相应库，B中却没有。于是添加映射，保存，这时提示：用户已存在！（这是B为主库时才能做的操作，若A为主库，在B上执行此操作会提示B为只读。。。）</p><h2 id="_3-1-查看主库sid" tabindex="-1">3.1 查看主库sid <a class="header-anchor" href="#_3-1-查看主库sid" aria-label="Permalink to &quot;3.1 查看主库sid&quot;">​</a></h2><p>查看主库上该账号的sid：</p><ul><li>查看所有</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> [dbName]..sysusers;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> [dbName]..sysusers;</span></span></code></pre></div><ul><li>指定查看</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> [sid] </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">syslogins</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name=</span><span style="color:#9ECBFF;">&#39;hanuser&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> [sid] </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">syslogins</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name=</span><span style="color:#032F62;">&#39;hanuser&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><h2 id="_3-2-创建对应账号" tabindex="-1">3.2 创建对应账号 <a class="header-anchor" href="#_3-2-创建对应账号" aria-label="Permalink to &quot;3.2 创建对应账号&quot;">​</a></h2><p>在副本上面操作</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LOGIN</span><span style="color:#E1E4E8;"> bradUser </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PASSWORD</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;?&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#F97583;">SID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ?, </span><span style="color:#6A737D;">--从上面的查询从获取</span></span>
<span class="line"><span style="color:#F97583;">DEFAULT_DATABASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [数据库名称], </span><span style="color:#6A737D;">--默认数据库</span></span>
<span class="line"><span style="color:#F97583;">CHECK_EXPIRATION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OFF</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">--强制密码过期 关闭</span></span>
<span class="line"><span style="color:#F97583;">CHECK_POLICY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OFF</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--强制密码策略 关闭</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LOGIN</span><span style="color:#24292E;"> bradUser </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PASSWORD</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;?&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#D73A49;">SID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ?, </span><span style="color:#6A737D;">--从上面的查询从获取</span></span>
<span class="line"><span style="color:#D73A49;">DEFAULT_DATABASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [数据库名称], </span><span style="color:#6A737D;">--默认数据库</span></span>
<span class="line"><span style="color:#D73A49;">CHECK_EXPIRATION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OFF</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">--强制密码过期 关闭</span></span>
<span class="line"><span style="color:#D73A49;">CHECK_POLICY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OFF</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">--强制密码策略 关闭</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>如果数据库想搬迁到其他环境，或AlwaysOn的从库中运行，都需要用相同的SID来创建用户</p><p>或者，只是搬迁数据库，可以解除孤立用户，重新设置权限：</p><p>USE 数据库名</p><p>GO</p><p>sp_change_users_login &#39;update_one&#39;,&#39;用户名&#39;,&#39;用户名&#39;</p></div><p>文档，<a href="https://learn.microsoft.com/en-us/sql/t-sql/statements/drop-user-transact-sql?view=sql-server-2017" target="_blank" rel="noreferrer">https://learn.microsoft.com/en-us/sql/t-sql/statements/drop-user-transact-sql?view=sql-server-2017</a></p><h1 id="_4-查看权限" tabindex="-1">4. 查看权限 <a class="header-anchor" href="#_4-查看权限" aria-label="Permalink to &quot;4. 查看权限&quot;">​</a></h1><h2 id="_4-1-查看用户权限是否冲突" tabindex="-1">4.1 查看用户权限是否冲突 <a class="header-anchor" href="#_4-1-查看用户权限是否冲突" aria-label="Permalink to &quot;4.1 查看用户权限是否冲突&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_permissions</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> grantee_principal_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">USER_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;[user_name]&#39;</span><span style="color:#E1E4E8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_permissions</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> grantee_principal_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">USER_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;[user_name]&#39;</span><span style="color:#24292E;">);</span></span></code></pre></div>`,28),e=[o];function c(r,t,E,y,i,d){return a(),n("div",null,e)}const h=s(p,[["render",c]]);export{F as __pageData,h as default};
