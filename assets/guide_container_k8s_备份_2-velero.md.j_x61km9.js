import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const d=JSON.parse('{"title":"1. 版本兼容","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/备份/2-velero.md","filePath":"guide/container/k8s/备份/2-velero.md","lastUpdated":1723447064000}'),p={name:"guide/container/k8s/备份/2-velero.md"},o=l(`<p><a href="https://velero.io/docs/v1.11/" target="_blank" rel="noreferrer">官当</a></p><p><a href="https://github.com/vmware-tanzu/velero" target="_blank" rel="noreferrer">github</a></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202408081453841.svg" alt=""></p><h1 id="_1-版本兼容" tabindex="-1">1. 版本兼容 <a class="header-anchor" href="#_1-版本兼容" aria-label="Permalink to &quot;1. 版本兼容&quot;">​</a></h1><table><thead><tr><th>Velero version</th><th>Expected Kubernetes version compatibility</th><th>Tested on Kubernetes version</th></tr></thead><tbody><tr><td>1.14</td><td>1.18-latest</td><td>1.27.9, 1.28.9, and 1.29.4</td></tr><tr><td>1.13</td><td>1.18-latest</td><td>1.26.5, 1.27.3, 1.27.8, and 1.28.3</td></tr><tr><td>1.12</td><td>1.18-latest</td><td>1.25.7, 1.26.5, 1.26.7, and 1.27.3</td></tr><tr><td>1.11</td><td>1.18-latest</td><td>1.23.10, 1.24.9, 1.25.5, and 1.26.1</td></tr><tr><td>1.10</td><td>1.18-latest</td><td>1.22.5, 1.23.8, 1.24.6 and 1.25.1</td></tr></tbody></table><h1 id="_2-velero部署" tabindex="-1">2. velero部署 <a class="header-anchor" href="#_2-velero部署" aria-label="Permalink to &quot;2. velero部署&quot;">​</a></h1><h2 id="_2-0-存储提供商" tabindex="-1">2.0 存储提供商 <a class="header-anchor" href="#_2-0-存储提供商" aria-label="Permalink to &quot;2.0 存储提供商&quot;">​</a></h2><h3 id="velero支持的提供商" tabindex="-1"><strong>Velero支持的提供商</strong> <a class="header-anchor" href="#velero支持的提供商" aria-label="Permalink to &quot;**Velero支持的提供商**&quot;">​</a></h3><table><thead><tr><th style="text-align:left;">提供商</th><th style="text-align:left;">对象存储</th><th style="text-align:left;">卷快照</th><th style="text-align:left;">插件提供商Repo</th><th style="text-align:left;">安装说明</th></tr></thead><tbody><tr><td style="text-align:left;">Amazon Web Services (AWS)</td><td style="text-align:left;">AWS S3</td><td style="text-align:left;">AWS EBS</td><td style="text-align:left;">Velero plugin for AWS</td><td style="text-align:left;">AWS Plugin Setup</td></tr><tr><td style="text-align:left;">Google Cloud Platform (GCP)</td><td style="text-align:left;">Google Cloud Storage</td><td style="text-align:left;">Google Compute Engine Disks</td><td style="text-align:left;">Velero plugin for GCP</td><td style="text-align:left;">GCP Plugin Setup</td></tr><tr><td style="text-align:left;">Microsoft Azure</td><td style="text-align:left;">Azure Blob Storage</td><td style="text-align:left;">Azure Managed Disks</td><td style="text-align:left;">Velero plugin for Microsoft Azure</td><td style="text-align:left;">Azure Plugin Setup</td></tr><tr><td style="text-align:left;">VMware vSphere</td><td style="text-align:left;">🚫</td><td style="text-align:left;">vSphere Volumes</td><td style="text-align:left;">VMware vSphere</td><td style="text-align:left;">vSphere Plugin Setup</td></tr><tr><td style="text-align:left;">Container Storage Interface (CSI)</td><td style="text-align:left;">🚫</td><td style="text-align:left;">CSI Volumes</td><td style="text-align:left;">Velero plugin for CSI</td><td style="text-align:left;">CSI Plugin Setup</td></tr></tbody></table><h3 id="社区支持的提供商" tabindex="-1"><strong>社区支持的提供商</strong> <a class="header-anchor" href="#社区支持的提供商" aria-label="Permalink to &quot;**社区支持的提供商**&quot;">​</a></h3><table><thead><tr><th style="text-align:left;">Provider</th><th style="text-align:left;">Object Store</th><th style="text-align:left;">Volume Snapshotter</th><th style="text-align:left;">Plugin Documentation</th><th style="text-align:left;">Contact</th></tr></thead><tbody><tr><td style="text-align:left;">AlibabaCloud</td><td style="text-align:left;">Alibaba Cloud OSS</td><td style="text-align:left;">Alibaba Cloud</td><td style="text-align:left;">AlibabaCloud</td><td style="text-align:left;">GitHub Issue</td></tr><tr><td style="text-align:left;">DigitalOcean</td><td style="text-align:left;">DigitalOcean Object Storage</td><td style="text-align:left;">DigitalOcean Volumes Block Storage</td><td style="text-align:left;">StackPointCloud</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Hewlett Packard</td><td style="text-align:left;">🚫</td><td style="text-align:left;">HPE Storage</td><td style="text-align:left;">Hewlett Packard</td><td style="text-align:left;">Slack, GitHub Issue</td></tr><tr><td style="text-align:left;">OpenEBS</td><td style="text-align:left;">🚫</td><td style="text-align:left;">OpenEBS CStor Volume</td><td style="text-align:left;">OpenEBS</td><td style="text-align:left;">Slack, GitHub Issue</td></tr><tr><td style="text-align:left;">Portworx</td><td style="text-align:left;">🚫</td><td style="text-align:left;">Portworx Volume</td><td style="text-align:left;">Portworx</td><td style="text-align:left;">Slack, GitHub Issue</td></tr><tr><td style="text-align:left;">Storj</td><td style="text-align:left;">Storj Object Storage</td><td style="text-align:left;">🚫</td><td style="text-align:left;">Storj</td><td style="text-align:left;">GitHub Issue</td></tr></tbody></table><h2 id="_2-1-存储方式" tabindex="-1">2.1 存储方式 <a class="header-anchor" href="#_2-1-存储方式" aria-label="Permalink to &quot;2.1 存储方式&quot;">​</a></h2><h3 id="_2-1-1-存储方式" tabindex="-1">2.1.1 存储方式 <a class="header-anchor" href="#_2-1-1-存储方式" aria-label="Permalink to &quot;2.1.1 存储方式&quot;">​</a></h3><h4 id="minio" tabindex="-1">minio <a class="header-anchor" href="#minio" aria-label="Permalink to &quot;minio&quot;">​</a></h4><h5 id="minio容器方式" tabindex="-1">minio容器方式 <a class="header-anchor" href="#minio容器方式" aria-label="Permalink to &quot;minio容器方式&quot;">​</a></h5><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-dit</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">minio</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-u</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">minio</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--net</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">host</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">always</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MINIO_ROOT_USER=&quot;minio&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MINIO_ROOT_PASSWORD=&quot;miniow2p0w2r4&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-v</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/minio:/data</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-w</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/minio:RELEASE.2022-11-29T23-40-49Z </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">minio</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--console-address</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;0.0.0.0:9001&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--address=</span><span style="color:#9ECBFF;">&quot;0.0.0.0:9000&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#解释</span></span>
<span class="line"><span style="color:#B392F0;">9001</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">---</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">UI访问界面</span></span>
<span class="line"><span style="color:#B392F0;">9000</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">---</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">api地址</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#创建bucket velero</span></span>
<span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-it</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">minio</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bash</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-c</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;mc mb velero; mc ls&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#minio储存地址 http://minio-ip:9000</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-dit</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">minio</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-u</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">-h</span><span style="color:#24292E;"> </span><span style="color:#032F62;">minio</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--net</span><span style="color:#24292E;"> </span><span style="color:#032F62;">host</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">always</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MINIO_ROOT_USER=&quot;minio&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MINIO_ROOT_PASSWORD=&quot;miniow2p0w2r4&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">-v</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/minio:/data</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-w</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/minio:RELEASE.2022-11-29T23-40-49Z </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">minio</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--console-address</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;0.0.0.0:9001&#39;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--address=</span><span style="color:#032F62;">&quot;0.0.0.0:9000&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#解释</span></span>
<span class="line"><span style="color:#6F42C1;">9001</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">---</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">UI访问界面</span></span>
<span class="line"><span style="color:#6F42C1;">9000</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">---</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">api地址</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#创建bucket velero</span></span>
<span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-it</span><span style="color:#24292E;"> </span><span style="color:#032F62;">minio</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bash</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-c</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;mc mb velero; mc ls&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#minio储存地址 http://minio-ip:9000</span></span></code></pre></div><h5 id="minio-k8s方式" tabindex="-1">minio k8s方式 <a class="header-anchor" href="#minio-k8s方式" aria-label="Permalink to &quot;minio k8s方式&quot;">​</a></h5><ul><li>创建minio-dp.yaml</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Namespace</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">velero</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">velero</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">minio</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">component</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">minio</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">strategy</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Recreate</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">component</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">minio</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">component</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">minio</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">nodeSelector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">kubernetes.io/hostname</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">k8smaster1</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">hostPath</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/data/minio</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">DirectoryOrCreate</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">storage</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">config</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">emptyDir</span><span style="color:#E1E4E8;">: {}</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">minio</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/minio:RELEASE.2022-11-29T23-40-49Z</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">imagePullPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">args</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">server</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">/data</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">--config-dir=/config</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">--console-address=:9001</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">env</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">MINIO_ROOT_USER</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;admin&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">MINIO_ROOT_PASSWORD</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;minio123&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9000</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9001</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">storage</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/data</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">config</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/config&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">limits</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">2Gi</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">requests</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">2Gi</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">velero</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">minio</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">component</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">minio</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">sessionAffinity</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">None</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NodePort</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">api</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9000</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9000</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nodePort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">30080</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">console</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9001</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">9001</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nodePort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">30081</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">component</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">minio</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">batch/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Job</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">velero</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">minio-setup</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">component</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">minio</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">minio-setup</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">nodeSelector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">kubernetes.io/hostname</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">k8s-master01</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#根据自己的环境修改</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">restartPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">OnFailure</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">config</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">emptyDir</span><span style="color:#E1E4E8;">: {}</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">mc</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">airbyte/mc:latest</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">imagePullPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">/bin/sh</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">-c</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">&quot;mc --config-dir=/config config host add velero http://minio.velero.svc.cluster.local:9000 admin minio123 &amp;&amp; mc --config-dir=/config mb -p velero/velero&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">config</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;/config&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Namespace</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">velero</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">velero</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">minio</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">component</span><span style="color:#24292E;">: </span><span style="color:#032F62;">minio</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">strategy</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Recreate</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">component</span><span style="color:#24292E;">: </span><span style="color:#032F62;">minio</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">component</span><span style="color:#24292E;">: </span><span style="color:#032F62;">minio</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">nodeSelector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">kubernetes.io/hostname</span><span style="color:#24292E;">: </span><span style="color:#032F62;">k8smaster1</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">hostPath</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/data/minio</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">DirectoryOrCreate</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">storage</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">config</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">emptyDir</span><span style="color:#24292E;">: {}</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">minio</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/minio:RELEASE.2022-11-29T23-40-49Z</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">imagePullPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">args</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">server</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">/data</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">--config-dir=/config</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">--console-address=:9001</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">env</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">MINIO_ROOT_USER</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">value</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;admin&quot;</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">MINIO_ROOT_PASSWORD</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">value</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;minio123&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9000</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9001</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">storage</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/data</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">config</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/config&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">limits</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;1&quot;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">2Gi</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;1&quot;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">2Gi</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">velero</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">minio</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">component</span><span style="color:#24292E;">: </span><span style="color:#032F62;">minio</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">sessionAffinity</span><span style="color:#24292E;">: </span><span style="color:#032F62;">None</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NodePort</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">api</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9000</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9000</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nodePort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">30080</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">console</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9001</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">9001</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nodePort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">30081</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">component</span><span style="color:#24292E;">: </span><span style="color:#032F62;">minio</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">batch/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Job</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">velero</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">minio-setup</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">component</span><span style="color:#24292E;">: </span><span style="color:#032F62;">minio</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">minio-setup</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">nodeSelector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">kubernetes.io/hostname</span><span style="color:#24292E;">: </span><span style="color:#032F62;">k8s-master01</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#根据自己的环境修改</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">restartPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">OnFailure</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">config</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">emptyDir</span><span style="color:#24292E;">: {}</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">mc</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">airbyte/mc:latest</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">imagePullPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">command</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">/bin/sh</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">-c</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">&quot;mc --config-dir=/config config host add velero http://minio.velero.svc.cluster.local:9000 admin minio123 &amp;&amp; mc --config-dir=/config mb -p velero/velero&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">config</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;/config&quot;</span></span></code></pre></div><ul><li>执行apply</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl apply -f minio-dp.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl apply -f minio-dp.yaml</span></span></code></pre></div><ul><li>查看</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">kubectl get all -n velero</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">kubectl get all -n velero</span></span></code></pre></div><h4 id="oss" tabindex="-1">oss <a class="header-anchor" href="#oss" aria-label="Permalink to &quot;oss&quot;">​</a></h4><p>在阿里云oss创建bucket bucket名称k8s-hsuing region为oss-cn-shanghai</p><p>oss的region和访问域名 <a href="https://help.aliyun.com/zh/oss/user-guide/regions-and-endpoints" target="_blank" rel="noreferrer">https://help.aliyun.com/zh/oss/user-guide/regions-and-endpoints</a></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#创建凭证 create auth</span></span>
<span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">/root/velero/auth-oss.txt</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#9ECBFF;">[default]</span></span>
<span class="line"><span style="color:#9ECBFF;">aws_access_key_id = LTAI4FoDtp4y7ENqv9X4emSE</span></span>
<span class="line"><span style="color:#9ECBFF;">aws_secret_access_key = lVNCxCVGciaJqUa5axxx</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#install</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--image</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/velero:v1.13.2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--plugins</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/velero-plugin-for-aws:v1.9.2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--provider</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">aws</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--use-volume-snapshots=false</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--bucket</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-hsuing</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--secret-file</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/k8s/velero/auth-oss.txt</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--backup-location-config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">region=oss-cn-shanghai,s3ForcePathStyle=&quot;false&quot;,s3Url=http://oss-cn-shanghai.aliyuncs.com</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#oss使用virtual hosting访问方式,配置s3ForcePathStyle=&quot;false&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">version</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#创建凭证 create auth</span></span>
<span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">/root/velero/auth-oss.txt</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#032F62;">[default]</span></span>
<span class="line"><span style="color:#032F62;">aws_access_key_id = LTAI4FoDtp4y7ENqv9X4emSE</span></span>
<span class="line"><span style="color:#032F62;">aws_secret_access_key = lVNCxCVGciaJqUa5axxx</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#install</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--image</span><span style="color:#24292E;"> </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/velero:v1.13.2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--plugins</span><span style="color:#24292E;">  </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/velero-plugin-for-aws:v1.9.2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--provider</span><span style="color:#24292E;"> </span><span style="color:#032F62;">aws</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--use-volume-snapshots=false</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--bucket</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-hsuing</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--secret-file</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/k8s/velero/auth-oss.txt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--backup-location-config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">region=oss-cn-shanghai,s3ForcePathStyle=&quot;false&quot;,s3Url=http://oss-cn-shanghai.aliyuncs.com</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#oss使用virtual hosting访问方式,配置s3ForcePathStyle=&quot;false&quot;</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">version</span></span></code></pre></div><h4 id="七牛云" tabindex="-1">七牛云 <a class="header-anchor" href="#七牛云" aria-label="Permalink to &quot;七牛云&quot;">​</a></h4><p>在七牛云创建储存<a href="https://portal.qiniu.com/kodo/bucket" target="_blank" rel="noreferrer">https://portal.qiniu.com/kodo/bucket</a></p><p>获取S3空间域名,打开创建的储存,空间概述,<code>S3 域名</code>,点击查询</p><p>七牛云储存region和访问域名 <a href="https://developer.qiniu.com/kodo/4088/s3-access-domainname" target="_blank" rel="noreferrer">https://developer.qiniu.com/kodo/4088/s3-access-domainname</a></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#创建凭证 create auth</span></span>
<span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">/root/velero/auth-qiniu.txt</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#9ECBFF;">[default]</span></span>
<span class="line"><span style="color:#9ECBFF;">aws_access_key_id = foqsLZBJSr7yF59_3sB5RguezMh0l223s2NcC9Kz</span></span>
<span class="line"><span style="color:#9ECBFF;">aws_secret_access_key = BTBwrrCE7TLKjztpsBZX2GA45Cb3yR9Fxxxx</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#install</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--image</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/velero:v1.13.2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--plugins</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/velero-plugin-for-aws:v1.9.2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--provider</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">aws</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--use-volume-snapshots=false</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--bucket</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">817</span><span style="color:#9ECBFF;">nb3</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--secret-file</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/root/velero/auth-qiniu.txt</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--backup-location-config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">region=cn-east-1,s3ForcePathStyle=&quot;false&quot;,s3Url=http://s3.cn-east-1.qiniucs.com</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#七牛云bucket使用S3空间域名前部分</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">version</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#创建凭证 create auth</span></span>
<span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">/root/velero/auth-qiniu.txt</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#032F62;">[default]</span></span>
<span class="line"><span style="color:#032F62;">aws_access_key_id = foqsLZBJSr7yF59_3sB5RguezMh0l223s2NcC9Kz</span></span>
<span class="line"><span style="color:#032F62;">aws_secret_access_key = BTBwrrCE7TLKjztpsBZX2GA45Cb3yR9Fxxxx</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#install</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--image</span><span style="color:#24292E;"> </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/velero:v1.13.2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--plugins</span><span style="color:#24292E;">  </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/velero-plugin-for-aws:v1.9.2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--provider</span><span style="color:#24292E;"> </span><span style="color:#032F62;">aws</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--use-volume-snapshots=false</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--bucket</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">817</span><span style="color:#032F62;">nb3</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--secret-file</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/root/velero/auth-qiniu.txt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--backup-location-config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">region=cn-east-1,s3ForcePathStyle=&quot;false&quot;,s3Url=http://s3.cn-east-1.qiniucs.com</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#七牛云bucket使用S3空间域名前部分</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">version</span></span></code></pre></div><h3 id="_2-1-2-restic方式" tabindex="-1">2.1.2 restic方式 <a class="header-anchor" href="#_2-1-2-restic方式" aria-label="Permalink to &quot;2.1.2 restic方式&quot;">​</a></h3><p>Restic 是一款 GO 语言开发的开源免费且快速、高效和安全的跨平台备份工具。它是文件系统级别备份持久卷数据并将其发送到 Velero 的对象存储。执行速度取决于本地 IO 能力，网络带宽和对象存储性能，相对快照方式备份慢。但如果当前集群或者存储出现问题，由于所有资源和数据都存储在远端的对象存储上，用 Restic 方式备份可以很容易的将应用恢复。 <strong>Tips：</strong> 使用 Restic 来对 PV 进行备份会有一些限制：</p><ul><li>不支持备份 hostPath，支持 EFS、AzureFile、NFS、emptyDir、local 或其他没有本地快照概念的卷类型</li><li>备份数据标志只能通过 Pod 来识别</li><li>单线程操作大量文件比较慢</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--provider </span><span style="color:#9ECBFF;">aws</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--bucket </span><span style="color:#9ECBFF;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--image </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/velero:v1.13.2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--plugins  </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/velero-plugin-for-aws:v1.9.2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--namespace </span><span style="color:#9ECBFF;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--secret-file </span><span style="color:#9ECBFF;">/home/qm/velero/velero-v1.8.1-linux-amd64/credentials-velero</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--use-volume-snapshots=false </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--default-volumes-to-restic=true </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--kubeconfig=/root/.kube/config </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--use-restic </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">--backup-location-config </span><span style="color:#9ECBFF;">region=minio,s3ForcePathStyle=&quot;true&quot;,s3Url=http://10.103.236.199:9000</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--provider </span><span style="color:#032F62;">aws</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--bucket </span><span style="color:#032F62;">velero</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--image </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/velero:v1.13.2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--plugins  </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/velero-plugin-for-aws:v1.9.2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--namespace </span><span style="color:#032F62;">velero</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--secret-file </span><span style="color:#032F62;">/home/qm/velero/velero-v1.8.1-linux-amd64/credentials-velero</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--use-volume-snapshots=false </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--default-volumes-to-restic=true </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--kubeconfig=/root/.kube/config </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--use-restic </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">--backup-location-config </span><span style="color:#032F62;">region=minio,s3ForcePathStyle=&quot;true&quot;,s3Url=http://10.103.236.199:9000</span></span></code></pre></div><p>解释：</p><ul><li>--use-restic 表示使用开源免费备份工具 restic 备份和还原持久卷数据，启用该参数后会部署一个名为 restic 的 DaemonSet 对象</li></ul><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>注意的是启动需要修改 Restic DaemonSet spec 配置，调整为实际环境中 Kubernetes 指定 pod 保存路径的 hostPath</p></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 根据实际Kubernetes 部署环境修改hostPath路径</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patch</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemonset</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restic</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;volumes&quot;:[{&quot;name&quot;:&quot;host-pods&quot;,&quot;hostPath&quot;:{&quot;path&quot;:&quot;/apps/data/kubelet/pods&quot;}}]}}}}&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看服务</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">all</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">velero</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 根据实际Kubernetes 部署环境修改hostPath路径</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patch</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemonset</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restic</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;volumes&quot;:[{&quot;name&quot;:&quot;host-pods&quot;,&quot;hostPath&quot;:{&quot;path&quot;:&quot;/apps/data/kubelet/pods&quot;}}]}}}}&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看服务</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">all</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">velero</span></span></code></pre></div><h2 id="_2-2-服务端安装" tabindex="-1">2.2 服务端安装 <a class="header-anchor" href="#_2-2-服务端安装" aria-label="Permalink to &quot;2.2 服务端安装&quot;">​</a></h2><p>官档,<a href="https://velero.io/docs/v1.8/customize-installation/" target="_blank" rel="noreferrer">https://velero.io/docs/v1.8/customize-installation/</a></p><h3 id="_2-2-1-k8s-minio方式" tabindex="-1">2.2.1 k8s-minio方式 <a class="header-anchor" href="#_2-2-1-k8s-minio方式" aria-label="Permalink to &quot;2.2.1 k8s-minio方式&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#创建凭证 create auth</span></span>
<span class="line"><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/k8s/velero</span></span>
<span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">~/k8s/velero/auth-minio.txt</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#9ECBFF;">[default]</span></span>
<span class="line"><span style="color:#9ECBFF;">aws_access_key_id = minio</span></span>
<span class="line"><span style="color:#9ECBFF;">aws_secret_access_key = miniow2p0w2r4</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#velero install</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--image</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/velero:v1.13.2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--plugins</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/velero-plugin-for-aws:v1.9.2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--provider</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">aws</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--bucket</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--use-volume-snapshots=false</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--secret-file</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/k8s/velero/auth-minio.txt</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--backup-location-config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">region=minio,s3ForcePathStyle=&quot;true&quot;,s3Url=http://minio.kube-public.svc:9000</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#自定义镜像地址 --image --plugins</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看版本</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master velero]# velero version</span></span>
<span class="line"><span style="color:#B392F0;">Client:</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">Version:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1.13.2</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">Git</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">commit:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">d961fb6fec384ed7f3c1b7c65c818106107f5a6</span></span>
<span class="line"><span style="color:#B392F0;">Server:</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">Version:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1.13.2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master velero]# kubectl api-versions </span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">velero</span></span>
<span class="line"><span style="color:#B392F0;">velero.io/v1</span></span>
<span class="line"><span style="color:#B392F0;">velero.io/v2alpha1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看pod</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master velero]# kubectl get pod -n velero</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                      </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">velero-5cdfb5ccc4-xphcj</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">h25m</span></span>
<span class="line"><span style="color:#6A737D;">#查看crd</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">crds</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-l</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">component=velero</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#创建凭证 create auth</span></span>
<span class="line"><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/k8s/velero</span></span>
<span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">~/k8s/velero/auth-minio.txt</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#032F62;">[default]</span></span>
<span class="line"><span style="color:#032F62;">aws_access_key_id = minio</span></span>
<span class="line"><span style="color:#032F62;">aws_secret_access_key = miniow2p0w2r4</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#velero install</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--image</span><span style="color:#24292E;"> </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/velero:v1.13.2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--plugins</span><span style="color:#24292E;"> </span><span style="color:#032F62;">registry.cn-zhangjiakou.aliyuncs.com/hsuing/velero-plugin-for-aws:v1.9.2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--provider</span><span style="color:#24292E;"> </span><span style="color:#032F62;">aws</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--bucket</span><span style="color:#24292E;"> </span><span style="color:#032F62;">velero</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--use-volume-snapshots=false</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--secret-file</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/k8s/velero/auth-minio.txt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--backup-location-config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">region=minio,s3ForcePathStyle=&quot;true&quot;,s3Url=http://minio.kube-public.svc:9000</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#自定义镜像地址 --image --plugins</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看版本</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master velero]# velero version</span></span>
<span class="line"><span style="color:#6F42C1;">Client:</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">Version:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1.13.2</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">Git</span><span style="color:#24292E;"> </span><span style="color:#032F62;">commit:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">d961fb6fec384ed7f3c1b7c65c818106107f5a6</span></span>
<span class="line"><span style="color:#6F42C1;">Server:</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">Version:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1.13.2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master velero]# kubectl api-versions </span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">velero</span></span>
<span class="line"><span style="color:#6F42C1;">velero.io/v1</span></span>
<span class="line"><span style="color:#6F42C1;">velero.io/v2alpha1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看pod</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master velero]# kubectl get pod -n velero</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                      </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">velero-5cdfb5ccc4-xphcj</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">h25m</span></span>
<span class="line"><span style="color:#6A737D;">#查看crd</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">crds</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-l</span><span style="color:#24292E;"> </span><span style="color:#032F62;">component=velero</span></span></code></pre></div><h3 id="_2-2-2-容器方式" tabindex="-1">2.2.2 容器方式 <a class="header-anchor" href="#_2-2-2-容器方式" aria-label="Permalink to &quot;2.2.2 容器方式&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--image</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">registry.aliyuncs.com/elvin/velero:v1.13.2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--plugins</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">registry.aliyuncs.com/elvin/velero-plugin-for-aws:v1.9.2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--provider</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">aws</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--bucket</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--use-volume-snapshots=false</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--secret-file</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/root/velero/auth-minio.txt</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--backup-location-config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">region=minio,s3ForcePathStyle=&quot;true&quot;,s3Url=http://10.103.236.199:9001</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--image</span><span style="color:#24292E;"> </span><span style="color:#032F62;">registry.aliyuncs.com/elvin/velero:v1.13.2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--plugins</span><span style="color:#24292E;"> </span><span style="color:#032F62;">registry.aliyuncs.com/elvin/velero-plugin-for-aws:v1.9.2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--provider</span><span style="color:#24292E;"> </span><span style="color:#032F62;">aws</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--bucket</span><span style="color:#24292E;"> </span><span style="color:#032F62;">velero</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--use-volume-snapshots=false</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--secret-file</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/root/velero/auth-minio.txt</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--backup-location-config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">region=minio,s3ForcePathStyle=&quot;true&quot;,s3Url=http://10.103.236.199:9001</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">## 查看服务启动情况</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master velero]# kubectl get all -n velero</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                          </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">pod/velero-5cdfb5ccc4-kmwbs</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">m8s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                     </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">UP-TO-DATE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AVAILABLE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">deployment.apps/velero</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">           </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">m8s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                </span><span style="color:#9ECBFF;">DESIRED</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">CURRENT</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">replicaset.apps/velero-5cdfb5ccc4</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">m8s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">## 查看服务启动情况</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master velero]# kubectl get all -n velero</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                          </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pod/velero-5cdfb5ccc4-kmwbs</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">m8s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                     </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">UP-TO-DATE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AVAILABLE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/velero</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">m8s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                </span><span style="color:#032F62;">DESIRED</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CURRENT</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">replicaset.apps/velero-5cdfb5ccc4</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">m8s</span></span></code></pre></div><h2 id="_2-3-客户端安装" tabindex="-1">2.3 客户端安装 <a class="header-anchor" href="#_2-3-客户端安装" aria-label="Permalink to &quot;2.3 客户端安装&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#下载</span></span>
<span class="line"><span style="color:#B392F0;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://github.com/vmware-tanzu/velero/releases/download/v1.13.2/velero-v1.13.2-linux-amd64.tar.gz</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#解压，由于是二进制包，直接解压使用</span></span>
<span class="line"><span style="color:#B392F0;">tar</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">zxvf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">velero-v1.13.2-linux-amd64.tar.gz</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">mv</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">velero-v1.13.2-linux-amd64/velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/local/bin/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#验证</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master velero-v1.13.2-linux-amd64]# velero version</span></span>
<span class="line"><span style="color:#B392F0;">Client:</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">Version:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1.13.2</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">Git</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">commit:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">d961fb6fec384ed7f3c1b7c65c818106107f5a6</span></span>
<span class="line"><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">error getting server version: no matches </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> kind </span><span style="color:#9ECBFF;">&quot;ServerStatusRequest&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> version </span><span style="color:#9ECBFF;">&quot;velero.io/v1&quot;</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#出现上面的原因，服务端还没有安装</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#下载</span></span>
<span class="line"><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://github.com/vmware-tanzu/velero/releases/download/v1.13.2/velero-v1.13.2-linux-amd64.tar.gz</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#解压，由于是二进制包，直接解压使用</span></span>
<span class="line"><span style="color:#6F42C1;">tar</span><span style="color:#24292E;"> </span><span style="color:#032F62;">zxvf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">velero-v1.13.2-linux-amd64.tar.gz</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">velero-v1.13.2-linux-amd64/velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/local/bin/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#验证</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master velero-v1.13.2-linux-amd64]# velero version</span></span>
<span class="line"><span style="color:#6F42C1;">Client:</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">Version:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1.13.2</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">Git</span><span style="color:#24292E;"> </span><span style="color:#032F62;">commit:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">d961fb6fec384ed7f3c1b7c65c818106107f5a6</span></span>
<span class="line"><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">error getting server version: no matches </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> kind </span><span style="color:#032F62;">&quot;ServerStatusRequest&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> version </span><span style="color:#032F62;">&quot;velero.io/v1&quot;</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#出现上面的原因，服务端还没有安装</span></span></code></pre></div><ul><li>启用命令补全</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#启用命令补全</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">completion</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bash</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/bash_completion.d/velero</span></span>
<span class="line"><span style="color:#79B8FF;">.</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/bash_completion.d/velero</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#查看帮助</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#启用命令补全</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">completion</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bash</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/bash_completion.d/velero</span></span>
<span class="line"><span style="color:#005CC5;">.</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/bash_completion.d/velero</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#查看帮助</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span></span></code></pre></div><h1 id="_3-velero常用操作" tabindex="-1">3. velero常用操作 <a class="header-anchor" href="#_3-velero常用操作" aria-label="Permalink to &quot;3. velero常用操作&quot;">​</a></h1><h2 id="_3-0-基本命令" tabindex="-1">3.0 基本命令 <a class="header-anchor" href="#_3-0-基本命令" aria-label="Permalink to &quot;3.0 基本命令&quot;">​</a></h2><p><code>帮助</code>：velero --help</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#velero基本命令</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#查看备份</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">schedule</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#查看定时备份</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restore</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#查看已有的恢复</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">plugins</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#查看插件</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#备份所有</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-bakcup-all</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--ttl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">72</span><span style="color:#9ECBFF;">h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#恢复集群所有备份,对已经存在的服务不会覆盖</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restore</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--from-backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-bakcup-all</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#仅恢复default的namespace,包括集群资源</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restore</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--from-backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-bakcup-all</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--include-namespaces</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">default</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--include-cluster-resources=true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#恢复储存pv,pvc</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restore</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pvc</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--from-backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-bakcup-all</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--include-resources</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">persistentvolumeclaims,persistentvolumes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#恢复指定资源deployments,configmaps </span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restore</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deploy-test</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--from-backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-bakcup-all</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--include-resources</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deployments,configmaps</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#筛选备份name=nginx-demo -l, --selector：通过指定label来匹配要backup的资源</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nginx-demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--from-backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-bakcup-all</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--selector</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name=nginx-demo</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#筛选备份恢复对象</span></span>
<span class="line"><span style="color:#B392F0;">--include-namespaces</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">筛选命名空间所有资源,不包括集群资源</span></span>
<span class="line"><span style="color:#B392F0;">--include-resources</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">筛选的资源类型</span></span>
<span class="line"><span style="color:#B392F0;">--exclude-resources</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">排除的资源类型</span></span>
<span class="line"><span style="color:#E1E4E8;">--include-cluster-resources</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">包括集群资源</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#将test1命名空间资源恢复到test2  </span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restore</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">test1-test2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--from-backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-bakcup-all</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--namespace-mappings</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">test1:test2</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#备份hooks</span></span>
<span class="line"><span style="color:#6A737D;">#Velero支持在备份任务执行之前和执行后在容器中执行一些预先设定好的命令</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#velero基本命令</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#查看备份</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">schedule</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#查看定时备份</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restore</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#查看已有的恢复</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">plugins</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#查看插件</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#备份所有</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-bakcup-all</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--ttl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">72</span><span style="color:#032F62;">h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#恢复集群所有备份,对已经存在的服务不会覆盖</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restore</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--from-backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-bakcup-all</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#仅恢复default的namespace,包括集群资源</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restore</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--from-backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-bakcup-all</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--include-namespaces</span><span style="color:#24292E;"> </span><span style="color:#032F62;">default</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--include-cluster-resources=true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#恢复储存pv,pvc</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restore</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pvc</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--from-backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-bakcup-all</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--include-resources</span><span style="color:#24292E;"> </span><span style="color:#032F62;">persistentvolumeclaims,persistentvolumes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#恢复指定资源deployments,configmaps </span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restore</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deploy-test</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--from-backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-bakcup-all</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--include-resources</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deployments,configmaps</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#筛选备份name=nginx-demo -l, --selector：通过指定label来匹配要backup的资源</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx-demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--from-backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-bakcup-all</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--selector</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name=nginx-demo</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#筛选备份恢复对象</span></span>
<span class="line"><span style="color:#6F42C1;">--include-namespaces</span><span style="color:#24292E;">  </span><span style="color:#032F62;">筛选命名空间所有资源,不包括集群资源</span></span>
<span class="line"><span style="color:#6F42C1;">--include-resources</span><span style="color:#24292E;">   </span><span style="color:#032F62;">筛选的资源类型</span></span>
<span class="line"><span style="color:#6F42C1;">--exclude-resources</span><span style="color:#24292E;">   </span><span style="color:#032F62;">排除的资源类型</span></span>
<span class="line"><span style="color:#24292E;">--include-cluster-resources</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">true</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">包括集群资源</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#将test1命名空间资源恢复到test2  </span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restore</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">test1-test2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--from-backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-bakcup-all</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--namespace-mappings</span><span style="color:#24292E;"> </span><span style="color:#032F62;">test1:test2</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#备份hooks</span></span>
<span class="line"><span style="color:#6A737D;">#Velero支持在备份任务执行之前和执行后在容器中执行一些预先设定好的命令</span></span></code></pre></div><h2 id="_3-1-备份" tabindex="-1">3.1 备份 <a class="header-anchor" href="#_3-1-备份" aria-label="Permalink to &quot;3.1 备份&quot;">​</a></h2><ul><li>创建bucketname</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#创建bucket velero</span></span>
<span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-it</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">minio</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bash</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-c</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;mc mb velero; mc ls&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#创建bucket velero</span></span>
<span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-it</span><span style="color:#24292E;"> </span><span style="color:#032F62;">minio</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bash</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-c</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;mc mb velero; mc ls&#39;</span></span></code></pre></div><ul><li>创建</li></ul><p>语法：velero backup create backname --include-namespaces namespace</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[root@kube-master velero]# velero backup create k8s-backup-test --include-namespaces default</span></span>
<span class="line"><span style="color:#e1e4e8;">Backup request &quot;k8s-backup-test&quot; submitted successfully.</span></span>
<span class="line"><span style="color:#e1e4e8;">Run \`velero backup describe k8s-backup-test\` or \`velero backup logs k8s-backup-test\` for more details.</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[root@kube-master velero]# velero backup create k8s-backup-test --include-namespaces default</span></span>
<span class="line"><span style="color:#24292e;">Backup request &quot;k8s-backup-test&quot; submitted successfully.</span></span>
<span class="line"><span style="color:#24292e;">Run \`velero backup describe k8s-backup-test\` or \`velero backup logs k8s-backup-test\` for more details.</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看default空间下的资源</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master velero]# kubectl get pod</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                      </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">app-prod-97dfb4bf-h59vq</span><span style="color:#E1E4E8;">                   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">25</span><span style="color:#E1E4E8;"> (35m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   23d</span></span>
<span class="line"><span style="color:#B392F0;">app-prod-tcp-7bdfd5577c-tb8ls</span><span style="color:#E1E4E8;">             </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">25</span><span style="color:#E1E4E8;"> (35m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   23d</span></span>
<span class="line"><span style="color:#B392F0;">custom-nginx-errors-6df8ddcc64-ztqnz</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> (35m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   23d</span></span>
<span class="line"><span style="color:#B392F0;">demo-6d4fc77748-dmg94</span><span style="color:#E1E4E8;">                     </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> (35m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)    8d</span></span>
<span class="line"><span style="color:#B392F0;">demo-6d4fc77748-fbvg6</span><span style="color:#E1E4E8;">                     </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> (35m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)    8d</span></span>
<span class="line"><span style="color:#B392F0;">nfs-client-provisioner-7f5bc48c68-8wld4</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;"> (35m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   23d</span></span>
<span class="line"><span style="color:#B392F0;">old-demo-687c6ccd99-2rzwr</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">17</span><span style="color:#E1E4E8;"> (35m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   18d</span></span>
<span class="line"><span style="color:#B392F0;">old-demo-687c6ccd99-rv9fz</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">53</span><span style="color:#E1E4E8;"> (35m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   59d</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master velero]# velero backup get</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">ERRORS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">WARNINGS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">CREATED</span><span style="color:#E1E4E8;">                         </span><span style="color:#9ECBFF;">EXPIRES</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STORAGE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">LOCATION</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">SELECTOR</span></span>
<span class="line"><span style="color:#B392F0;">k8s-backup-test</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Completed</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">2024</span><span style="color:#9ECBFF;">-07-25</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">:12:23</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+0800</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">29</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">default</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看default空间下的资源</span></span>
<span class="line"><span style="color:#24292E;">[root@kube-master velero]# kubectl get pod</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                      </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">       </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">app-prod-97dfb4bf-h59vq</span><span style="color:#24292E;">                   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">25</span><span style="color:#24292E;"> (35m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   23d</span></span>
<span class="line"><span style="color:#6F42C1;">app-prod-tcp-7bdfd5577c-tb8ls</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">25</span><span style="color:#24292E;"> (35m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   23d</span></span>
<span class="line"><span style="color:#6F42C1;">custom-nginx-errors-6df8ddcc64-ztqnz</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> (35m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   23d</span></span>
<span class="line"><span style="color:#6F42C1;">demo-6d4fc77748-dmg94</span><span style="color:#24292E;">                     </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> (35m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)    8d</span></span>
<span class="line"><span style="color:#6F42C1;">demo-6d4fc77748-fbvg6</span><span style="color:#24292E;">                     </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> (35m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)    8d</span></span>
<span class="line"><span style="color:#6F42C1;">nfs-client-provisioner-7f5bc48c68-8wld4</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">32</span><span style="color:#24292E;"> (35m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   23d</span></span>
<span class="line"><span style="color:#6F42C1;">old-demo-687c6ccd99-2rzwr</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">17</span><span style="color:#24292E;"> (35m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   18d</span></span>
<span class="line"><span style="color:#6F42C1;">old-demo-687c6ccd99-rv9fz</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">53</span><span style="color:#24292E;"> (35m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   59d</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master velero]# velero backup get</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">              </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">      </span><span style="color:#032F62;">ERRORS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">WARNINGS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CREATED</span><span style="color:#24292E;">                         </span><span style="color:#032F62;">EXPIRES</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STORAGE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">LOCATION</span><span style="color:#24292E;">   </span><span style="color:#032F62;">SELECTOR</span></span>
<span class="line"><span style="color:#6F42C1;">k8s-backup-test</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2024</span><span style="color:#032F62;">-07-25</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">:12:23</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+0800</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">29</span><span style="color:#032F62;">d</span><span style="color:#24292E;">       </span><span style="color:#032F62;">default</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><table><thead><tr><th>列表名字</th><th>描述</th></tr></thead><tbody><tr><td>NAME</td><td>velero备份名字</td></tr><tr><td>STATUS</td><td>备份状态</td></tr><tr><td>ERRORS</td><td></td></tr><tr><td>WARNINGS</td><td></td></tr><tr><td>CREATED</td><td>创建时间</td></tr><tr><td>EXPIRES</td><td>过期时间</td></tr><tr><td>STORAGE LOCATION</td><td>备份存储空间名字</td></tr><tr><td>SELECTOR</td><td></td></tr></tbody></table><ul><li>效果</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202407251013913.png" alt="image-20240725101325377"></p><h2 id="_3-2-还原" tabindex="-1">3.2 还原 <a class="header-anchor" href="#_3-2-还原" aria-label="Permalink to &quot;3.2 还原&quot;">​</a></h2><ul><li>删除其中的pod</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master velero]# helm list</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">NAMESPACE</span><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">REVISION</span><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">UPDATED</span><span style="color:#E1E4E8;">                                	</span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">  	</span><span style="color:#9ECBFF;">CHART</span><span style="color:#E1E4E8;">     	</span><span style="color:#9ECBFF;">APP</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">VERSION</span></span>
<span class="line"><span style="color:#B392F0;">demo</span><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">default</span><span style="color:#E1E4E8;">  	</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">       	</span><span style="color:#79B8FF;">2024</span><span style="color:#9ECBFF;">-07-16</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18</span><span style="color:#9ECBFF;">:06:26.685169771</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+0800</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">deployed</span><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">demo-1.0.0</span><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master velero]# helm uninstall demo</span></span>
<span class="line"><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;demo&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">uninstalled</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master velero]# kubectl get pod</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                      </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">app-prod-97dfb4bf-h59vq</span><span style="color:#E1E4E8;">                   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">25</span><span style="color:#E1E4E8;"> (36m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   23d</span></span>
<span class="line"><span style="color:#B392F0;">app-prod-tcp-7bdfd5577c-tb8ls</span><span style="color:#E1E4E8;">             </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">25</span><span style="color:#E1E4E8;"> (36m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   23d</span></span>
<span class="line"><span style="color:#B392F0;">custom-nginx-errors-6df8ddcc64-ztqnz</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;"> (36m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   23d</span></span>
<span class="line"><span style="color:#B392F0;">nfs-client-provisioner-7f5bc48c68-8wld4</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;"> (36m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   23d</span></span>
<span class="line"><span style="color:#B392F0;">old-demo-687c6ccd99-2rzwr</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">17</span><span style="color:#E1E4E8;"> (36m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   18d</span></span>
<span class="line"><span style="color:#B392F0;">old-demo-687c6ccd99-rv9fz</span><span style="color:#E1E4E8;">                 </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">53</span><span style="color:#E1E4E8;"> (36m </span><span style="color:#9ECBFF;">ago</span><span style="color:#E1E4E8;">)   59d</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master velero]# helm list</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">	</span><span style="color:#032F62;">NAMESPACE</span><span style="color:#24292E;">	</span><span style="color:#032F62;">REVISION</span><span style="color:#24292E;">	</span><span style="color:#032F62;">UPDATED</span><span style="color:#24292E;">                                	</span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">  	</span><span style="color:#032F62;">CHART</span><span style="color:#24292E;">     	</span><span style="color:#032F62;">APP</span><span style="color:#24292E;"> </span><span style="color:#032F62;">VERSION</span></span>
<span class="line"><span style="color:#6F42C1;">demo</span><span style="color:#24292E;">	</span><span style="color:#032F62;">default</span><span style="color:#24292E;">  	</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">       	</span><span style="color:#005CC5;">2024</span><span style="color:#032F62;">-07-16</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18</span><span style="color:#032F62;">:06:26.685169771</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+0800</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;">	</span><span style="color:#032F62;">deployed</span><span style="color:#24292E;">	</span><span style="color:#032F62;">demo-1.0.0</span><span style="color:#24292E;">	</span><span style="color:#032F62;">v1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master velero]# helm uninstall demo</span></span>
<span class="line"><span style="color:#6F42C1;">release</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;demo&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">uninstalled</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master velero]# kubectl get pod</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                      </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">       </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">app-prod-97dfb4bf-h59vq</span><span style="color:#24292E;">                   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">25</span><span style="color:#24292E;"> (36m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   23d</span></span>
<span class="line"><span style="color:#6F42C1;">app-prod-tcp-7bdfd5577c-tb8ls</span><span style="color:#24292E;">             </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">25</span><span style="color:#24292E;"> (36m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   23d</span></span>
<span class="line"><span style="color:#6F42C1;">custom-nginx-errors-6df8ddcc64-ztqnz</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">24</span><span style="color:#24292E;"> (36m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   23d</span></span>
<span class="line"><span style="color:#6F42C1;">nfs-client-provisioner-7f5bc48c68-8wld4</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">32</span><span style="color:#24292E;"> (36m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   23d</span></span>
<span class="line"><span style="color:#6F42C1;">old-demo-687c6ccd99-2rzwr</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">17</span><span style="color:#24292E;"> (36m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   18d</span></span>
<span class="line"><span style="color:#6F42C1;">old-demo-687c6ccd99-rv9fz</span><span style="color:#24292E;">                 </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">53</span><span style="color:#24292E;"> (36m </span><span style="color:#032F62;">ago</span><span style="color:#24292E;">)   59d</span></span></code></pre></div><ul><li>还原</li></ul><p>语法：</p><p>velero restore create pod_name --from-backup k8s-backup-test --include-namespaces default</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master velero]#  velero restore create demo --from-backup k8s-backup-test  --include-namespaces default</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#解释</span></span>
<span class="line"><span style="color:#B392F0;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">----</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Pod_name</span></span>
<span class="line"><span style="color:#B392F0;">k8s-backup-test</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">---</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">velero备份名字</span></span>
<span class="line"><span style="color:#B392F0;">default</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">---</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">namespace</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master velero]#  velero restore create demo --from-backup k8s-backup-test  --include-namespaces default</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#解释</span></span>
<span class="line"><span style="color:#6F42C1;">demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">----</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Pod_name</span></span>
<span class="line"><span style="color:#6F42C1;">k8s-backup-test</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">---</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">velero备份名字</span></span>
<span class="line"><span style="color:#6F42C1;">default</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">---</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">namespace</span></span></code></pre></div><ul><li>查看</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master velero]# kubectl get pod</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                      </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">demo-6d4fc77748-dmg94</span><span style="color:#E1E4E8;">                     </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">              </span><span style="color:#79B8FF;">5</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">demo-6d4fc77748-fbvg6</span><span style="color:#E1E4E8;">                     </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">              </span><span style="color:#79B8FF;">5</span><span style="color:#9ECBFF;">s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master velero]# kubectl get pod</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                      </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">       </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">demo-6d4fc77748-dmg94</span><span style="color:#24292E;">                     </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">              </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">demo-6d4fc77748-fbvg6</span><span style="color:#24292E;">                     </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">              </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">s</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><ul><li>在velero备份的时候，备份过程中创建的对象是不会被备份的。</li><li><code>velero restore</code> 恢复不会覆盖<code>已有的资源</code>，只恢复当前集群中<code>不存在的资源</code>。已有的资源不会回滚到之前的版本，如需要回滚，需在restore之前提前删除现有的资源</li></ul></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master velero]# velero restore get</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">BACKUP</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">STARTED</span><span style="color:#E1E4E8;">                         </span><span style="color:#9ECBFF;">COMPLETED</span><span style="color:#E1E4E8;">                       </span><span style="color:#9ECBFF;">ERRORS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">WARNINGS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">CREATED</span><span style="color:#E1E4E8;">                   </span><span style="color:#9ECBFF;">SELECTOR</span></span>
<span class="line"><span style="color:#B392F0;">demo</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">k8s-backup-test</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Completed</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">2024</span><span style="color:#9ECBFF;">-07-25</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">:21:21</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+0800</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">2024</span><span style="color:#9ECBFF;">-07-25</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">:21:25</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+0800</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">2024</span><span style="color:#9ECBFF;">-07-25</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">:21:21</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+0800</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master velero]# velero restore get</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">   </span><span style="color:#032F62;">BACKUP</span><span style="color:#24292E;">            </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">      </span><span style="color:#032F62;">STARTED</span><span style="color:#24292E;">                         </span><span style="color:#032F62;">COMPLETED</span><span style="color:#24292E;">                       </span><span style="color:#032F62;">ERRORS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">WARNINGS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CREATED</span><span style="color:#24292E;">                   </span><span style="color:#032F62;">SELECTOR</span></span>
<span class="line"><span style="color:#6F42C1;">demo</span><span style="color:#24292E;">   </span><span style="color:#032F62;">k8s-backup-test</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2024</span><span style="color:#032F62;">-07-25</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">:21:21</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+0800</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2024</span><span style="color:#032F62;">-07-25</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">:21:25</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+0800</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">12</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">2024</span><span style="color:#032F62;">-07-25</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">:21:21</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+0800</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><h2 id="_3-3-查看" tabindex="-1">3.3 查看 <a class="header-anchor" href="#_3-3-查看" aria-label="Permalink to &quot;3.3 查看&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master velero]# velero backup get</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">ERRORS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">WARNINGS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">CREATED</span><span style="color:#E1E4E8;">                         </span><span style="color:#9ECBFF;">EXPIRES</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STORAGE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">LOCATION</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">SELECTOR</span></span>
<span class="line"><span style="color:#B392F0;">k8s-backup-test</span><span style="color:#E1E4E8;">             </span><span style="color:#9ECBFF;">Completed</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">2024</span><span style="color:#9ECBFF;">-07-25</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">:12:23</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+0800</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">29</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">default</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">k8s-bakcup-all-2024-07-25</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Completed</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">2024</span><span style="color:#9ECBFF;">-07-25</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">:43:26</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+0800</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">default</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看备份结果</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">describe</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-backup-test</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">logs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-backup-test</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master velero]# velero backup get</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                        </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">      </span><span style="color:#032F62;">ERRORS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">WARNINGS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">CREATED</span><span style="color:#24292E;">                         </span><span style="color:#032F62;">EXPIRES</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STORAGE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">LOCATION</span><span style="color:#24292E;">   </span><span style="color:#032F62;">SELECTOR</span></span>
<span class="line"><span style="color:#6F42C1;">k8s-backup-test</span><span style="color:#24292E;">             </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2024</span><span style="color:#032F62;">-07-25</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">:12:23</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+0800</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">29</span><span style="color:#032F62;">d</span><span style="color:#24292E;">       </span><span style="color:#032F62;">default</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">k8s-bakcup-all-2024-07-25</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Completed</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">2024</span><span style="color:#032F62;">-07-25</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">:43:26</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+0800</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">d</span><span style="color:#24292E;">        </span><span style="color:#032F62;">default</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看备份结果</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">describe</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-backup-test</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">logs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-backup-test</span></span></code></pre></div><h2 id="_3-4-删除" tabindex="-1">3.4 删除 <a class="header-anchor" href="#_3-4-删除" aria-label="Permalink to &quot;3.4 删除&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[root@kube-master velero]# velero delete backup k8s-bakcup-all-2024-07-25</span></span>
<span class="line"><span style="color:#B392F0;">Are</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sure</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">want</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">continue</span><span style="color:#E1E4E8;"> (Y/N)</span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> Y</span></span>
<span class="line"><span style="color:#B392F0;">Request</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;k8s-bakcup-all-2024-07-25&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">submitted</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">successfully.</span></span>
<span class="line"><span style="color:#B392F0;">The</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">will</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">fully</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deleted</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">after</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">all</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">associated</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">data</span><span style="color:#E1E4E8;"> (disk </span><span style="color:#9ECBFF;">snapshots,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">files,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restores</span><span style="color:#E1E4E8;">) are removed.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#直接不用输入Y</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-bakcup-all-2024-07-25</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--confirm</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[root@kube-master velero]# velero delete backup k8s-bakcup-all-2024-07-25</span></span>
<span class="line"><span style="color:#6F42C1;">Are</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sure</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">want</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">continue</span><span style="color:#24292E;"> (Y/N)</span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> Y</span></span>
<span class="line"><span style="color:#6F42C1;">Request</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;k8s-bakcup-all-2024-07-25&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">submitted</span><span style="color:#24292E;"> </span><span style="color:#032F62;">successfully.</span></span>
<span class="line"><span style="color:#6F42C1;">The</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">will</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">fully</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deleted</span><span style="color:#24292E;"> </span><span style="color:#032F62;">after</span><span style="color:#24292E;"> </span><span style="color:#032F62;">all</span><span style="color:#24292E;"> </span><span style="color:#032F62;">associated</span><span style="color:#24292E;"> </span><span style="color:#032F62;">data</span><span style="color:#24292E;"> (disk </span><span style="color:#032F62;">snapshots,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">files,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restores</span><span style="color:#24292E;">) are removed.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#直接不用输入Y</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-bakcup-all-2024-07-25</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--confirm</span></span></code></pre></div><h2 id="_3-5-卸载velero" tabindex="-1">3.5 卸载velero <a class="header-anchor" href="#_3-5-卸载velero" aria-label="Permalink to &quot;3.5 卸载velero&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">uninstall</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#卸载velero，注意这里的uninstall不会删除namespace：</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">namespace/velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clusterrolebinding/velero</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">delete</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">crds</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-l</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">component=velero</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">uninstall</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#卸载velero，注意这里的uninstall不会删除namespace：</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#032F62;">namespace/velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clusterrolebinding/velero</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">delete</span><span style="color:#24292E;"> </span><span style="color:#032F62;">crds</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-l</span><span style="color:#24292E;"> </span><span style="color:#032F62;">component=velero</span></span></code></pre></div><h2 id="_3-6-任务" tabindex="-1">3.6 任务 <a class="header-anchor" href="#_3-6-任务" aria-label="Permalink to &quot;3.6 任务&quot;">​</a></h2><h3 id="定时任务" tabindex="-1">定时任务 <a class="header-anchor" href="#定时任务" aria-label="Permalink to &quot;定时任务&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#备份所有资源保留72小时</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-bakcup-all-$(</span><span style="color:#B392F0;">date</span><span style="color:#9ECBFF;"> +%F)</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--ttl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">72</span><span style="color:#9ECBFF;">h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看备份</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#备份所有资源保留72小时</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-bakcup-all-$(</span><span style="color:#6F42C1;">date</span><span style="color:#032F62;"> +%F)</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--ttl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">72</span><span style="color:#032F62;">h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看备份</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span></span></code></pre></div><h3 id="周期性任务crongjob" tabindex="-1">周期性任务crongJob <a class="header-anchor" href="#周期性任务crongjob" aria-label="Permalink to &quot;周期性任务crongJob&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#周期性任务</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">schedule</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#定时任务,每天16点(UTC时区)备份，保留7天(168h)</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">schedule</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-bakcup-all</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--schedule=</span><span style="color:#9ECBFF;">&quot;0 16 * * *&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--ttl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">168</span><span style="color:#9ECBFF;">h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Create a backup every 6 hours</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">schedule</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">NAME</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--schedule=</span><span style="color:#9ECBFF;">&quot;0 */6 * * *&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Create a backup every 6 hours with the @every notation</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">schedule</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">NAME</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--schedule=</span><span style="color:#9ECBFF;">&quot;@every 6h&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Create a daily backup of the web namespace</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">schedule</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">NAME</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--schedule=</span><span style="color:#9ECBFF;">&quot;@every 24h&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--include-namespaces</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">web</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Create a weekly backup, each living for 90 days (2160 hours)</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">schedule</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">NAME</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--schedule=</span><span style="color:#9ECBFF;">&quot;@every 168h&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--ttl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2160</span><span style="color:#9ECBFF;">h0m0s</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 每日对anchnet-devops-dev/anchnet-devops-test/anchnet-devops-prod/anchnet-devops-common-test 名称空间进行备份</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">schedule</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">anchnet-devops-dev</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--schedule=</span><span style="color:#9ECBFF;">&quot;@every 24h&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--include-namespaces</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">anchnet-devops-dev</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">schedule</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">anchnet-devops-test</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--schedule=</span><span style="color:#9ECBFF;">&quot;@every 24h&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--include-namespaces</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">anchnet-devops-test</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">schedule</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">anchnet-devops-prod</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--schedule=</span><span style="color:#9ECBFF;">&quot;@every 24h&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--include-namespaces</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">anchnet-devops-prod</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">schedule</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">anchnet-devops-common-test</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--schedule=</span><span style="color:#9ECBFF;">&quot;@every 24h&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--include-namespaces</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">anchnet-devops-common-test</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看定时任务</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">schedule</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#周期性任务</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">schedule</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#定时任务,每天16点(UTC时区)备份，保留7天(168h)</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">schedule</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-bakcup-all</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--schedule=</span><span style="color:#032F62;">&quot;0 16 * * *&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--ttl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">168</span><span style="color:#032F62;">h</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Create a backup every 6 hours</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">schedule</span><span style="color:#24292E;"> </span><span style="color:#032F62;">NAME</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--schedule=</span><span style="color:#032F62;">&quot;0 */6 * * *&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Create a backup every 6 hours with the @every notation</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">schedule</span><span style="color:#24292E;"> </span><span style="color:#032F62;">NAME</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--schedule=</span><span style="color:#032F62;">&quot;@every 6h&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Create a daily backup of the web namespace</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">schedule</span><span style="color:#24292E;"> </span><span style="color:#032F62;">NAME</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--schedule=</span><span style="color:#032F62;">&quot;@every 24h&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--include-namespaces</span><span style="color:#24292E;"> </span><span style="color:#032F62;">web</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Create a weekly backup, each living for 90 days (2160 hours)</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">schedule</span><span style="color:#24292E;"> </span><span style="color:#032F62;">NAME</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--schedule=</span><span style="color:#032F62;">&quot;@every 168h&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--ttl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2160</span><span style="color:#032F62;">h0m0s</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 每日对anchnet-devops-dev/anchnet-devops-test/anchnet-devops-prod/anchnet-devops-common-test 名称空间进行备份</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">schedule</span><span style="color:#24292E;"> </span><span style="color:#032F62;">anchnet-devops-dev</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--schedule=</span><span style="color:#032F62;">&quot;@every 24h&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--include-namespaces</span><span style="color:#24292E;"> </span><span style="color:#032F62;">anchnet-devops-dev</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">schedule</span><span style="color:#24292E;"> </span><span style="color:#032F62;">anchnet-devops-test</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--schedule=</span><span style="color:#032F62;">&quot;@every 24h&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--include-namespaces</span><span style="color:#24292E;"> </span><span style="color:#032F62;">anchnet-devops-test</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">schedule</span><span style="color:#24292E;"> </span><span style="color:#032F62;">anchnet-devops-prod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--schedule=</span><span style="color:#032F62;">&quot;@every 24h&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--include-namespaces</span><span style="color:#24292E;"> </span><span style="color:#032F62;">anchnet-devops-prod</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">schedule</span><span style="color:#24292E;"> </span><span style="color:#032F62;">anchnet-devops-common-test</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--schedule=</span><span style="color:#032F62;">&quot;@every 24h&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--include-namespaces</span><span style="color:#24292E;"> </span><span style="color:#032F62;">anchnet-devops-common-test</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看定时任务</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">schedule</span></span></code></pre></div><h2 id="_3-7-迁移" tabindex="-1">3.7 迁移 <a class="header-anchor" href="#_3-7-迁移" aria-label="Permalink to &quot;3.7 迁移&quot;">​</a></h2><ul><li>创建velero使用的储存</li><li>在k8s-A集群安装velero并备份</li><li>在k8s-B集群安装velero并恢复,即完成k8s迁移</li></ul><h1 id="_4-velero其它案例" tabindex="-1">4. velero其它案例 <a class="header-anchor" href="#_4-velero其它案例" aria-label="Permalink to &quot;4. velero其它案例&quot;">​</a></h1><h2 id="_4-1-同集群" tabindex="-1">4.1 同集群 <a class="header-anchor" href="#_4-1-同集群" aria-label="Permalink to &quot;4.1 同集群&quot;">​</a></h2><p>同集群下，手动从完整备份中恢复其中一个namespace到指定namespace</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#从test namespace到 test10000 namespace</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restore</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">k8s-jf-test-all-restore</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--from-backup</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">k8s-jf-test-all</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--include-namespaces</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">test</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--namespace-mappings</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">test:test10000</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看恢复状态</span></span>
<span class="line"><span style="color:#B392F0;">velero</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restore</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">describe</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">k8s-jf-test-all-restore</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#从test namespace到 test10000 namespace</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restore</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;">  </span><span style="color:#032F62;">k8s-jf-test-all-restore</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--from-backup</span><span style="color:#24292E;">  </span><span style="color:#032F62;">k8s-jf-test-all</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--include-namespaces</span><span style="color:#24292E;"> </span><span style="color:#032F62;">test</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--namespace-mappings</span><span style="color:#24292E;">  </span><span style="color:#032F62;">test:test10000</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看恢复状态</span></span>
<span class="line"><span style="color:#6F42C1;">velero</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restore</span><span style="color:#24292E;"> </span><span style="color:#032F62;">describe</span><span style="color:#24292E;"> </span><span style="color:#032F62;">k8s-jf-test-all-restore</span></span></code></pre></div><h2 id="_4-2-跨集群" tabindex="-1">4.2 跨集群 <a class="header-anchor" href="#_4-2-跨集群" aria-label="Permalink to &quot;4.2 跨集群&quot;">​</a></h2><p>对于velero，跨集群需要保持2个集群使用的是同一个云厂商持久卷方案</p><p>两边环境保持一致即可。</p>`,98),e=[o];function t(c,r,E,y,i,F){return n(),a("div",null,e)}const u=s(p,[["render",t]]);export{d as __pageData,u as default};
