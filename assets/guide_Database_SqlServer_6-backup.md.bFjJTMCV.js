import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const h=JSON.parse('{"title":"4.自动备份","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/SqlServer/6-backup.md","filePath":"guide/Database/SqlServer/6-backup.md","lastUpdated":1720606881000}'),p={name:"guide/Database/SqlServer/6-backup.md"},o=l(`<ul><li>官方文档，<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/backup-restore/quickstart-backup-restore-database?view=sql-server-2017" target="_blank" rel="noreferrer">https://docs.microsoft.com/zh-cn/sql/relational-databases/backup-restore/quickstart-backup-restore-database?view=sql-server-2017</a></li></ul><h2 id="_1-查看备份记录" tabindex="-1">1.查看备份记录 <a class="header-anchor" href="#_1-查看备份记录" aria-label="Permalink to &quot;1.查看备份记录&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 查看备份记录</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">CHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">SERVERPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;Servername&#39;</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">Server</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backupset</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_name</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backupset</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backup_start_date</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backupset</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backup_finish_date</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backupset</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">expiration_date</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> msdb..</span><span style="color:#79B8FF;">backupset</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;D&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;FULL Backup&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;I&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;DIFF Backup&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;L&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Log Backup&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> backup_type, </span></span>
<span class="line"><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backupset</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backup_size</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backupmediafamily</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">logical_device_name</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backupmediafamily</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">physical_device_name</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backupset</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> backupset_name, </span></span>
<span class="line"><span style="color:#E1E4E8;">family_sequence_number </span><span style="color:#9ECBFF;">&#39;介质簇位置&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backupset</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">description</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.backupmediafamily </span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.backupset </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backupmediafamily</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">media_set_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backupset</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">media_set_id</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">datetime</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backupset</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backup_start_date</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">102</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backupset</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_name</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backupset</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">backup_finish_date</span></span>
<span class="line"><span style="color:#6A737D;">---</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 查看备份记录</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">CHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">SERVERPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;Servername&#39;</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">Server</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backupset</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_name</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backupset</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backup_start_date</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backupset</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backup_finish_date</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backupset</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">expiration_date</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> msdb..</span><span style="color:#005CC5;">backupset</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;D&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;FULL Backup&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;I&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;DIFF Backup&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;L&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Log Backup&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> backup_type, </span></span>
<span class="line"><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backupset</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backup_size</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backupmediafamily</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">logical_device_name</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backupmediafamily</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">physical_device_name</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backupset</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> backupset_name, </span></span>
<span class="line"><span style="color:#24292E;">family_sequence_number </span><span style="color:#032F62;">&#39;介质簇位置&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backupset</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">description</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.backupmediafamily </span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.backupset </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backupmediafamily</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">media_set_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backupset</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">media_set_id</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">datetime</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backupset</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backup_start_date</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">102</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backupset</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_name</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backupset</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">backup_finish_date</span></span>
<span class="line"><span style="color:#6A737D;">---</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141015905.jpg" alt=""></p><h3 id="查询当前数据库备份进度" tabindex="-1">查询当前数据库备份进度 <a class="header-anchor" href="#查询当前数据库备份进度" aria-label="Permalink to &quot;查询当前数据库备份进度&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--查询当前数据库备份进度</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(er.[database_id]) [DatabaseName],er.[command] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [CommandType],er.[percent_complete]</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">start_time</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DECIMAL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) , er.[percent_complete]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Complete_Percent]</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DECIMAL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">38</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">), er.[total_elapsed_time] </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [ElapsedTime_m]  </span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DECIMAL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">38</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">), er.[estimated_completion_time] </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60000</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [EstimatedCompletionTime_m]  </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> er  </span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> er.[command] </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> ( </span><span style="color:#9ECBFF;">&#39;RESTORE DATABASE&#39;</span><span style="color:#E1E4E8;"> ,</span><span style="color:#9ECBFF;">&#39;BACKUP DATABASE&#39;</span><span style="color:#E1E4E8;">)  </span><span style="color:#6A737D;">-- DB_NAME(er.[database_id]) in (&#39;ky2011&#39;) and</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--查询当前数据库备份进度</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(er.[database_id]) [DatabaseName],er.[command] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [CommandType],er.[percent_complete]</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">start_time</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DECIMAL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">5</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) , er.[percent_complete]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Complete_Percent]</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DECIMAL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">38</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">), er.[total_elapsed_time] </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [ElapsedTime_m]  </span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DECIMAL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">38</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">), er.[estimated_completion_time] </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60000</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [EstimatedCompletionTime_m]  </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> er  </span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> er.[command] </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> ( </span><span style="color:#032F62;">&#39;RESTORE DATABASE&#39;</span><span style="color:#24292E;"> ,</span><span style="color:#032F62;">&#39;BACKUP DATABASE&#39;</span><span style="color:#24292E;">)  </span><span style="color:#6A737D;">-- DB_NAME(er.[database_id]) in (&#39;ky2011&#39;) and</span></span></code></pre></div><h2 id="_2-备份日志" tabindex="-1">2.备份日志 <a class="header-anchor" href="#_2-备份日志" aria-label="Permalink to &quot;2.备份日志&quot;">​</a></h2><h3 id="_2-1备份事物日志" tabindex="-1">2.1备份事物日志 <a class="header-anchor" href="#_2-1备份事物日志" aria-label="Permalink to &quot;2.1备份事物日志&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 前提的是FULL 类型</span></span>
<span class="line"><span style="color:#F97583;">ALTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> hantest </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">RECOVERY</span><span style="color:#E1E4E8;"> FULL</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 的有数据库完整备份</span></span>
<span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [master]</span></span>
<span class="line"><span style="color:#F97583;">BACKUP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> [hantest] </span><span style="color:#F97583;">TO</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISK</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;D:\\hanback\\hanTestDB.bak&#39;</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOFORMAT</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">NOINIT</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">NAME</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;hantestTestDB-Full Database Backup&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">SKIP</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">NOREWIND</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">NOUNLOAD</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">STATS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">BACKUP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LOG</span><span style="color:#E1E4E8;"> [hantest] </span><span style="color:#F97583;">TO</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISK=</span><span style="color:#9ECBFF;">&#39;NUL:&#39;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">-- 备份事务日志，备份成NUL，就不用占硬盘空间</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 前提的是FULL 类型</span></span>
<span class="line"><span style="color:#D73A49;">ALTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> hantest </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">RECOVERY</span><span style="color:#24292E;"> FULL</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 的有数据库完整备份</span></span>
<span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [master]</span></span>
<span class="line"><span style="color:#D73A49;">BACKUP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> [hantest] </span><span style="color:#D73A49;">TO</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISK</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;D:\\hanback\\hanTestDB.bak&#39;</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOFORMAT</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">NOINIT</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">NAME</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;hantestTestDB-Full Database Backup&#39;</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">SKIP</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">NOREWIND</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">NOUNLOAD</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">STATS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">BACKUP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LOG</span><span style="color:#24292E;"> [hantest] </span><span style="color:#D73A49;">TO</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISK=</span><span style="color:#032F62;">&#39;NUL:&#39;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">-- 备份事务日志，备份成NUL，就不用占硬盘空间</span></span></code></pre></div><h2 id="_3-备份类型" tabindex="-1">3.备份类型 <a class="header-anchor" href="#_3-备份类型" aria-label="Permalink to &quot;3.备份类型&quot;">​</a></h2><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141016633.jpg" alt=""></p><h3 id="_3-1完整备份" tabindex="-1">3.1完整备份 <a class="header-anchor" href="#_3-1完整备份" aria-label="Permalink to &quot;3.1完整备份&quot;">​</a></h3><p>文档，<a href="https://learn.microsoft.com/zh-cn/sql/t-sql/statements/backup-transact-sql?view=sql-server-ver16" target="_blank" rel="noreferrer">https://learn.microsoft.com/zh-cn/sql/t-sql/statements/backup-transact-sql?view=sql-server-ver16</a></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">#完全备份</span></span>
<span class="line"><span style="color:#F97583;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> db_name </span><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">disk</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;E:\\backup\\db_name.bak&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">stats</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">retaindays=</span><span style="color:#79B8FF;">9</span><span style="color:#E1E4E8;">,format,</span><span style="color:#F97583;">init</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">skip</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- stats 显示每 1% 后的统计信息的选项</span></span>
<span class="line"><span style="color:#6A737D;">-- format[noformat] ,覆盖任何现有的介质标头和备份集</span></span>
<span class="line"><span style="color:#6A737D;">-- init 覆盖备份介质中的现有备份集,默认为追加到介质中最新的备份集 (NOINIT)</span></span>
<span class="line"><span style="color:#6A737D;">-- retaindays=9 表示必须经过多少天才可以覆盖该备份集</span></span>
<span class="line"><span style="color:#6A737D;">-- PASSWORD = &#39;Q!W@E#R$&#39; 设置密码</span></span>
<span class="line"><span style="color:#6A737D;">-- skip 禁用备份集的过期和名称检查</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">#完全备份</span></span>
<span class="line"><span style="color:#D73A49;">backup</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> db_name </span><span style="color:#D73A49;">to</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">disk</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;E:\\backup\\db_name.bak&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">stats</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">retaindays=</span><span style="color:#005CC5;">9</span><span style="color:#24292E;">,format,</span><span style="color:#D73A49;">init</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">skip</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- stats 显示每 1% 后的统计信息的选项</span></span>
<span class="line"><span style="color:#6A737D;">-- format[noformat] ,覆盖任何现有的介质标头和备份集</span></span>
<span class="line"><span style="color:#6A737D;">-- init 覆盖备份介质中的现有备份集,默认为追加到介质中最新的备份集 (NOINIT)</span></span>
<span class="line"><span style="color:#6A737D;">-- retaindays=9 表示必须经过多少天才可以覆盖该备份集</span></span>
<span class="line"><span style="color:#6A737D;">-- PASSWORD = &#39;Q!W@E#R$&#39; 设置密码</span></span>
<span class="line"><span style="color:#6A737D;">-- skip 禁用备份集的过期和名称检查</span></span></code></pre></div><blockquote><p>E:\\backup，保证路径提前创建好</p></blockquote><p><a href="https://edu.51cto.com/center/course/lesson/index?id=18190" target="_blank" rel="noreferrer">https://edu.51cto.com/center/course/lesson/index?id=18190</a></p><h3 id="_3-2差异备份" tabindex="-1">3.2差异备份 <a class="header-anchor" href="#_3-2差异备份" aria-label="Permalink to &quot;3.2差异备份&quot;">​</a></h3><ul><li>语法</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">BACKUP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LOG</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database_name</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">TO</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISK</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&#39;physical_device_name&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">[ </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> { </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">COPY_ONLY</span></span>
<span class="line"><span style="color:#E1E4E8;">| { </span><span style="color:#F97583;">COMPRESSION</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">NO_COMPRESSION</span><span style="color:#E1E4E8;"> } </span></span>
<span class="line"><span style="color:#E1E4E8;">| { </span><span style="color:#F97583;">NOINIT</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">INIT</span><span style="color:#E1E4E8;"> } </span></span>
<span class="line"><span style="color:#E1E4E8;">| { </span><span style="color:#F97583;">NOSKIP</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">SKIP</span><span style="color:#E1E4E8;"> } </span></span>
<span class="line"><span style="color:#E1E4E8;">| { </span><span style="color:#F97583;">NOFORMAT</span><span style="color:#E1E4E8;"> | FORMAT } </span></span>
<span class="line"><span style="color:#E1E4E8;">| </span><span style="color:#F97583;">STATS</span><span style="color:#E1E4E8;"> [ = percentage ] </span></span>
<span class="line"><span style="color:#E1E4E8;">| { </span><span style="color:#F97583;">NORECOVERY</span><span style="color:#E1E4E8;"> | </span><span style="color:#F97583;">STANDBY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> undo_file_name }</span></span>
<span class="line"><span style="color:#E1E4E8;">| </span><span style="color:#F97583;">NO_TRUNCATE</span><span style="color:#E1E4E8;"> }]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- NORECOVERY 选项，指定备份事务日志的尾部，并使数据库处于RESTORING状态</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">BACKUP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LOG</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database_name</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">TO</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISK</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span><span style="color:#032F62;">&#39;physical_device_name&#39;</span></span>
<span class="line"><span style="color:#24292E;">[ </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> { </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">COPY_ONLY</span></span>
<span class="line"><span style="color:#24292E;">| { </span><span style="color:#D73A49;">COMPRESSION</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">NO_COMPRESSION</span><span style="color:#24292E;"> } </span></span>
<span class="line"><span style="color:#24292E;">| { </span><span style="color:#D73A49;">NOINIT</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">INIT</span><span style="color:#24292E;"> } </span></span>
<span class="line"><span style="color:#24292E;">| { </span><span style="color:#D73A49;">NOSKIP</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">SKIP</span><span style="color:#24292E;"> } </span></span>
<span class="line"><span style="color:#24292E;">| { </span><span style="color:#D73A49;">NOFORMAT</span><span style="color:#24292E;"> | FORMAT } </span></span>
<span class="line"><span style="color:#24292E;">| </span><span style="color:#D73A49;">STATS</span><span style="color:#24292E;"> [ = percentage ] </span></span>
<span class="line"><span style="color:#24292E;">| { </span><span style="color:#D73A49;">NORECOVERY</span><span style="color:#24292E;"> | </span><span style="color:#D73A49;">STANDBY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> undo_file_name }</span></span>
<span class="line"><span style="color:#24292E;">| </span><span style="color:#D73A49;">NO_TRUNCATE</span><span style="color:#24292E;"> }]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- NORECOVERY 选项，指定备份事务日志的尾部，并使数据库处于RESTORING状态</span></span></code></pre></div><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark has-diff vp-code-dark"><code><span class="line"><span style="color:#F97583;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> db_name </span><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">disk=</span><span style="color:#9ECBFF;">&#39;E:\\backup\\db_name.bak&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">differential</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">retaindays=</span><span style="color:#79B8FF;">9</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">noformat</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">noinit</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">compression</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light has-diff vp-code-light"><code><span class="line"><span style="color:#D73A49;">backup</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> db_name </span><span style="color:#D73A49;">to</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">disk=</span><span style="color:#032F62;">&#39;E:\\backup\\db_name.bak&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">differential</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">retaindays=</span><span style="color:#005CC5;">9</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">noformat</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">noinit</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">compression</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="_3-3事务日志备份" tabindex="-1">3.3事务日志备份 <a class="header-anchor" href="#_3-3事务日志备份" aria-label="Permalink to &quot;3.3事务日志备份&quot;">​</a></h3><blockquote><p>要执行事务日志的备份，数据库的恢复模式（Recovery Mode）必须是FULL，并且数据库必须执行过一次数据库的完整备份操作，否则，事务日志将处于自动截断（Auto-Truncate）状态，无法进行事务日志备份</p></blockquote><h4 id="尾日志备份" tabindex="-1"><strong>尾日志备份</strong> <a class="header-anchor" href="#尾日志备份" aria-label="Permalink to &quot;**尾日志备份**&quot;">​</a></h4><p>NORECOVERY 选项，指定备份事务日志的尾部，并使数据库处于RESTORING状态</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">log</span><span style="color:#E1E4E8;"> db_name</span></span>
<span class="line"><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">disk</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;D:\\backup\\db_name.trn&#39;</span></span>
<span class="line"><span style="color:#F97583;">with</span></span>
<span class="line"><span style="color:#F97583;">compression</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">format,</span></span>
<span class="line"><span style="color:#F97583;">init</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#F97583;">skip</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#F97583;">stats=</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">，</span></span>
<span class="line"><span style="color:#F97583;">norecovery</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">backup</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">log</span><span style="color:#24292E;"> db_name</span></span>
<span class="line"><span style="color:#D73A49;">to</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">disk</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;D:\\backup\\db_name.trn&#39;</span></span>
<span class="line"><span style="color:#D73A49;">with</span></span>
<span class="line"><span style="color:#D73A49;">compression</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">format,</span></span>
<span class="line"><span style="color:#D73A49;">init</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#D73A49;">skip</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#D73A49;">stats=</span><span style="color:#005CC5;">5</span><span style="color:#24292E;">，</span></span>
<span class="line"><span style="color:#D73A49;">norecovery</span></span></code></pre></div><h4 id="日志截断" tabindex="-1"><strong>日志截断</strong> <a class="header-anchor" href="#日志截断" aria-label="Permalink to &quot;**日志截断**&quot;">​</a></h4><p>正常情况下，数据库处于Online状态，在进行事务日志备份时，如果不指定 NO_TRUNCATE 选项，那么数据库将已备份的事务日志文件截断，避免事务日志过大，耗尽disk空间；如果指定 NO_TRUNCATE 选项，表示日志备份不会将事务日志文件截断，该选项一般在数据库处于异常状态时使用</p><h4 id="自动截断模式" tabindex="-1"><strong>自动截断模式</strong> <a class="header-anchor" href="#自动截断模式" aria-label="Permalink to &quot;**自动截断模式**&quot;">​</a></h4><p>如果数据库符合以下两种条件之一，那么Database就处于自动截断模式：</p><ul><li>数据库的恢复模式是simple；</li><li>数据库的恢复模式是full 或 bulk_Logged，并且没有做过数据库完整备份；</li></ul><p>自动截断模式是指数据库引擎把处于可还原状态（recoverable）状态的事务日志自动截断，使日志文件能够重复使用，避免日志文件无限增长。如果事务日志不是自动截断模式，那么事务日志会保存到日志文件中，导致日志文件持续增长。只有做日志备份时，日志文件才会被截断；如果没有定期的日志备份，那么日志文件会持续地增长，直到耗尽磁盘的所有空间，因此，必须制定一个日志备份计划，把事务日志截断，才能使数据库的事务日志文件的大小保持在一个可以管理的水平上</p><ul><li>查看数据截断模式</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">db_name</span><span style="color:#E1E4E8;">(database_id) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> DBName,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> last_log_backup_lsn </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Auto&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Manul&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> TruncateMode</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_recovery_status</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">db_name</span><span style="color:#24292E;">(database_id) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> DBName,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> last_log_backup_lsn </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Auto&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Manul&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> TruncateMode</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_recovery_status</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141016251.jpg" alt=""></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">backup</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">log</span><span style="color:#E1E4E8;"> db_name</span></span>
<span class="line"><span style="color:#F97583;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">disk</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;D:\\TestDBBackupFolder\\Sitedb_bak3.trn&#39;</span></span>
<span class="line"><span style="color:#F97583;">with</span></span>
<span class="line"><span style="color:#F97583;">compression</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">format,</span></span>
<span class="line"><span style="color:#F97583;">init</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#F97583;">skip</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#F97583;">stats=</span><span style="color:#79B8FF;">5</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">backup</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">log</span><span style="color:#24292E;"> db_name</span></span>
<span class="line"><span style="color:#D73A49;">to</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">disk</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;D:\\TestDBBackupFolder\\Sitedb_bak3.trn&#39;</span></span>
<span class="line"><span style="color:#D73A49;">with</span></span>
<span class="line"><span style="color:#D73A49;">compression</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">format,</span></span>
<span class="line"><span style="color:#D73A49;">init</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#D73A49;">skip</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#D73A49;">stats=</span><span style="color:#005CC5;">5</span></span></code></pre></div><h2 id="_4-恢复" tabindex="-1">4.恢复 <a class="header-anchor" href="#_4-恢复" aria-label="Permalink to &quot;4.恢复&quot;">​</a></h2><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141016322.jpg" alt=""></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [master];</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">RESTORE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> [DBTest]</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DISK</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> N</span><span style="color:#9ECBFF;">&#39;C:</span><span style="color:#79B8FF;">\\P</span><span style="color:#9ECBFF;">rogram Files</span><span style="color:#79B8FF;">\\M</span><span style="color:#9ECBFF;">icrosoft SQL</span></span>
<span class="line"><span style="color:#9ECBFF;">Server</span><span style="color:#79B8FF;">\\M</span><span style="color:#9ECBFF;">SSQL15.MSSQLSERVER</span><span style="color:#79B8FF;">\\M</span><span style="color:#9ECBFF;">SSQL</span><span style="color:#79B8FF;">\\B</span><span style="color:#9ECBFF;">ackup</span><span style="color:#79B8FF;">\\b</span><span style="color:#9ECBFF;">c</span><span style="color:#79B8FF;">\\D</span><span style="color:#9ECBFF;">BTest.bak&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FILE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">NOUNLOAD</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">STATS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [master];</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">RESTORE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> [DBTest]</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DISK</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> N</span><span style="color:#032F62;">&#39;C:</span><span style="color:#005CC5;">\\P</span><span style="color:#032F62;">rogram Files</span><span style="color:#005CC5;">\\M</span><span style="color:#032F62;">icrosoft SQL</span></span>
<span class="line"><span style="color:#032F62;">Server</span><span style="color:#005CC5;">\\M</span><span style="color:#032F62;">SSQL15.MSSQLSERVER</span><span style="color:#005CC5;">\\M</span><span style="color:#032F62;">SSQL</span><span style="color:#005CC5;">\\B</span><span style="color:#032F62;">ackup</span><span style="color:#005CC5;">\\b</span><span style="color:#032F62;">c</span><span style="color:#005CC5;">\\D</span><span style="color:#032F62;">BTest.bak&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FILE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">NOUNLOAD</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">STATS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><h1 id="_4-自动备份" tabindex="-1">4.自动备份 <a class="header-anchor" href="#_4-自动备份" aria-label="Permalink to &quot;4.自动备份&quot;">​</a></h1><p>==前提是开启代理服务==</p><p>去启动服务，在桌面找到计算机，右键点击【管理】，找到【服务和应用程序】，点击【服务】，找到Sql Server 代理(MSQLSERVER)，点击右键，启动</p><h2 id="_1-维护计划向导" tabindex="-1">1.维护计划向导 <a class="header-anchor" href="#_1-维护计划向导" aria-label="Permalink to &quot;1.维护计划向导&quot;">​</a></h2><ul><li>第一步：登录数据库—&gt;管理—&gt;维护计划—&gt;维护计划向导</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141016699.jpg" alt=""></p><h2 id="_2-输入维护计划" tabindex="-1">2.输入维护计划 <a class="header-anchor" href="#_2-输入维护计划" aria-label="Permalink to &quot;2.输入维护计划&quot;">​</a></h2><ul><li>第二步：输入维护计划“名称”及“说明”，点击“更改”按钮</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141016841.jpg" alt=""></p><h2 id="_3-新建作业计划" tabindex="-1">3.新建作业计划 <a class="header-anchor" href="#_3-新建作业计划" aria-label="Permalink to &quot;3.新建作业计划&quot;">​</a></h2><ul><li>第三步：在“新建作业计划”界面进行相关的设置</li></ul><p>计划类型：重复执行;</p><p>​ 频率执行：每周、每天、每月（这里我选择每天进行备份）</p><p>​ 每天频率：时间自行选择;（这里我选择每天备份一次）</p><p>​ 持续时间：开始时间默认当前时间（<strong>这里建议改成凌晨或者数据开销相对较小的时间段</strong>），结束时间可以不填;</p><p>以上设置完成后点击“确定”</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141016930.jpg" alt=""></p><h2 id="_4-选择维护任务" tabindex="-1">4.选择维护任务 <a class="header-anchor" href="#_4-选择维护任务" aria-label="Permalink to &quot;4.选择维护任务&quot;">​</a></h2><ul><li>第四步：点击下一步，“选择维护任务”，这里我选择“备份数据库完整”及“清楚维护任务”，定期清除备份的数据，避免磁盘空间被备份数据占满，造成数据宕机</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141016845.jpg" alt=""></p><h2 id="_5-选择维护任务顺序" tabindex="-1">5.选择维护任务顺序 <a class="header-anchor" href="#_5-选择维护任务顺序" aria-label="Permalink to &quot;5.选择维护任务顺序&quot;">​</a></h2><ul><li>第五步：“选择维护任务顺序”，这里是先备份后删除</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141016154.jpg" alt=""></p><h2 id="_6-备份的数据库" tabindex="-1">6.备份的数据库 <a class="header-anchor" href="#_6-备份的数据库" aria-label="Permalink to &quot;6.备份的数据库&quot;">​</a></h2><ul><li>第六步：选择要备份的数据库，可以根据需要备份的数据库进行选择，可以选择备份到哪个位置。，最好放在磁盘空间比较充足的盘符，扩展名默认bak就可以</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141016753.jpg" alt=""></p><h2 id="_7-定义清除维护任务" tabindex="-1">7.定义清除维护任务 <a class="header-anchor" href="#_7-定义清除维护任务" aria-label="Permalink to &quot;7.定义清除维护任务&quot;">​</a></h2><ul><li>第七步：设置“定义清除维护任务”，选择备份时所设置的文件夹，文件扩展名bak，文件保留时间，根据自己的需求选择，备份保留时间</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141016260.jpg" alt=""></p><h2 id="_8-保存地址" tabindex="-1">8.保存地址 <a class="header-anchor" href="#_8-保存地址" aria-label="Permalink to &quot;8.保存地址&quot;">​</a></h2><p>第八步：选择报告选项的保存地址，自己根据需要选择</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141016506.jpg" alt=""></p><ul><li>第九步：点击“完成”设置，此处可以看到前面的设置情况</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141016095.jpg" alt=""></p><ul><li>第十步：设置成功</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141016555.jpg" alt=""></p><h2 id="_11-维护计划" tabindex="-1">11.维护计划 <a class="header-anchor" href="#_11-维护计划" aria-label="Permalink to &quot;11.维护计划&quot;">​</a></h2><ul><li>第十一步：设置完成后，可以看到“维护计划”内和“作业”内会生成一个作业计划</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141016167.jpg" alt=""></p><h2 id="_12-修改计划" tabindex="-1">12.修改计划 <a class="header-anchor" href="#_12-修改计划" aria-label="Permalink to &quot;12.修改计划&quot;">​</a></h2><p>第十二步：维护计划右键“修改”可查看计划任务，右键可以再次设置相关参数</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141016834.jpg" alt=""></p><h2 id="_13-执行此作业" tabindex="-1">13.执行此作业 <a class="header-anchor" href="#_13-执行此作业" aria-label="Permalink to &quot;13.执行此作业&quot;">​</a></h2><p>第十三步：作业右键“作业开始步骤”可直接执行此作业，验证作业是否生效</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141017973.jpg" alt=""></p><h1 id="_5-脚本备份" tabindex="-1">5.脚本备份 <a class="header-anchor" href="#_5-脚本备份" aria-label="Permalink to &quot;5.脚本备份&quot;">​</a></h1><p><a href="https://www.xin3721.com/Articletsql/sql3795.html" target="_blank" rel="noreferrer">https://www.xin3721.com/Articletsql/sql3795.html</a></p><h1 id="_6-数据文件迁移" tabindex="-1">6.数据文件迁移 <a class="header-anchor" href="#_6-数据文件迁移" aria-label="Permalink to &quot;6.数据文件迁移&quot;">​</a></h1><h2 id="_6-1已有数据文件迁移" tabindex="-1">6.1已有数据文件迁移 <a class="header-anchor" href="#_6-1已有数据文件迁移" aria-label="Permalink to &quot;6.1已有数据文件迁移&quot;">​</a></h2><p>由于线上环境磁盘不足，需要迁移部分数据文件</p><p>对数据进行全备，完整全备</p><p>通过ssm工具</p><p>1.打开数据库，登录进去</p><p>2.选择数据库右键点击——&gt;任务——&gt;备份——&gt;数据库</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141017848.png" alt=""></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141017463.png" alt=""></p><p>备份完之后，对数据库的路径进行确认，点击数据库右击——&gt;属性，文件——&gt;路径</p><p>2.选择需要迁移数据库，右键依次选择”任务”--&gt; ”分离”</p><p>勾选“删除链接”——&gt;-勾选“更新统计信息”</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141017820.png" alt=""></p><p>3.将数据库目录下所需数据文件，将数据库文件复制到D盘新建的数据库目录</p><p>4.数据库 右键 ”附加”，“添加”——&gt;选择刚才剪切过去的数据库.mdf文件——&gt;确定</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141017841.png" alt=""></p><p>“添加”——&gt;选择前面选择的磁盘并且刚才剪切过去的数据库.mdf文件——&gt;确定</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141017599.png" alt=""></p><p>确认：</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141017825.png" alt=""></p><p>完成后刷新就可以查看数据库文件位置变了，且权限，文件任何都完整的迁移过来</p><p>5.登陆</p><p>然后登录SQL SERVER,继续使用windwos身份验证，（因为用SA用户去附加数据库的时候，会让数据库成为只读状态，所以能用windwos身份验证就用本地账户，因为权限的问题）</p><ul><li>命令行</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--查看当前的存放位置</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> database_id,</span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">,physical_name </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> CurrentLocation,state_desc,</span><span style="color:#F97583;">size</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">master_files</span></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> database_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">db_id</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">N&#39;数据库名&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--修改文件的存放位置下次启动生效</span></span>
<span class="line"><span style="color:#6A737D;">--testDb为数据库名，</span></span>
<span class="line"><span style="color:#F97583;">alter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> 数据库名 </span><span style="color:#F97583;">modify</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">file</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> 文件名(不包含后缀), </span><span style="color:#F97583;">filename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;文件存储路径&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">alter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> 数据库名 </span><span style="color:#F97583;">modify</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">file</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> 文件名(不包含后缀), </span><span style="color:#F97583;">filename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;文件存储路径&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">eg.</span></span>
<span class="line"><span style="color:#F97583;">alter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> testDb </span><span style="color:#F97583;">modify</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">file</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> testDb, </span><span style="color:#F97583;">filename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;G:\\SQL_DATA\\testDb\\testDb.mdf&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">alter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">database</span><span style="color:#E1E4E8;"> testDb </span><span style="color:#F97583;">modify</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">file</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> testDb_log, </span><span style="color:#F97583;">filename</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;G:\\SQL_DATA\\testDb\\testdb_log.ldf&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--修改默认的数据库文件存放位置（即时生效）</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> xp_instance_regwrite</span></span>
<span class="line"><span style="color:#E1E4E8;">@rootkey</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;HKEY_LOCAL_MACHINE&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">@key</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;Software\\Microsoft\\MSSQLServer\\MSSQLServer&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">@value_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;DefaultData&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">@type</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">REG_SZ,</span></span>
<span class="line"><span style="color:#E1E4E8;">@value</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;E:\\MSSQL_MDF\\data&#39;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--修改默认的日志文件存放位置（即时生效）</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span><span style="color:#E1E4E8;">..xp_instance_regwrite</span></span>
<span class="line"><span style="color:#E1E4E8;">@rootkey</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;HKEY_LOCAL_MACHINE&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">@key</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;Software\\Microsoft\\MSSQLServer\\MSSQLServer&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">@value_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;DefaultLog&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">@type</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">REG_SZ,</span></span>
<span class="line"><span style="color:#E1E4E8;">@value</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;E:\\MSSQL_MDF\\log&#39;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--查看当前的存放位置</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> database_id,</span><span style="color:#D73A49;">name</span><span style="color:#24292E;">,physical_name </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> CurrentLocation,state_desc,</span><span style="color:#D73A49;">size</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">master_files</span></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> database_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">db_id</span><span style="color:#24292E;">(</span><span style="color:#032F62;">N&#39;数据库名&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--修改文件的存放位置下次启动生效</span></span>
<span class="line"><span style="color:#6A737D;">--testDb为数据库名，</span></span>
<span class="line"><span style="color:#D73A49;">alter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> 数据库名 </span><span style="color:#D73A49;">modify</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">file</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> 文件名(不包含后缀), </span><span style="color:#D73A49;">filename</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;文件存储路径&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">alter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> 数据库名 </span><span style="color:#D73A49;">modify</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">file</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> 文件名(不包含后缀), </span><span style="color:#D73A49;">filename</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;文件存储路径&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">eg.</span></span>
<span class="line"><span style="color:#D73A49;">alter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> testDb </span><span style="color:#D73A49;">modify</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">file</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> testDb, </span><span style="color:#D73A49;">filename</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;G:\\SQL_DATA\\testDb\\testDb.mdf&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">alter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">database</span><span style="color:#24292E;"> testDb </span><span style="color:#D73A49;">modify</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">file</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> testDb_log, </span><span style="color:#D73A49;">filename</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;G:\\SQL_DATA\\testDb\\testdb_log.ldf&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--修改默认的数据库文件存放位置（即时生效）</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> xp_instance_regwrite</span></span>
<span class="line"><span style="color:#24292E;">@rootkey</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;HKEY_LOCAL_MACHINE&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">@key</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;Software\\Microsoft\\MSSQLServer\\MSSQLServer&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">@value_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;DefaultData&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">@type</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">REG_SZ,</span></span>
<span class="line"><span style="color:#24292E;">@value</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;E:\\MSSQL_MDF\\data&#39;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--修改默认的日志文件存放位置（即时生效）</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span><span style="color:#24292E;">..xp_instance_regwrite</span></span>
<span class="line"><span style="color:#24292E;">@rootkey</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;HKEY_LOCAL_MACHINE&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">@key</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;Software\\Microsoft\\MSSQLServer\\MSSQLServer&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">@value_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;DefaultLog&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">@type</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">REG_SZ,</span></span>
<span class="line"><span style="color:#24292E;">@value</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;E:\\MSSQL_MDF\\log&#39;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><h2 id="_6-2更改数据库默认存储路径" tabindex="-1">6.2更改数据库默认存储路径 <a class="header-anchor" href="#_6-2更改数据库默认存储路径" aria-label="Permalink to &quot;6.2更改数据库默认存储路径&quot;">​</a></h2><p>1、打开数据库，登录进去，选择服务器 “属性”。</p><p>2、选择”数据库设置”，如图直接修改数据和日志的存储路径</p><p>这样新建数据库默认的存储路径就变为手动设置的路径了</p><h1 id="_7-ssm数据库还原" tabindex="-1">7.ssm数据库还原 <a class="header-anchor" href="#_7-ssm数据库还原" aria-label="Permalink to &quot;7.ssm数据库还原&quot;">​</a></h1><h2 id="_7-1不同数据库名字还原" tabindex="-1">7.1不同数据库名字还原 <a class="header-anchor" href="#_7-1不同数据库名字还原" aria-label="Permalink to &quot;7.1不同数据库名字还原&quot;">​</a></h2><p><strong>eg：从test_new还原至test</strong> 步骤1：选中要还原的数据库，右击-》任务-》还原-》数据库</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141017232.jpg" alt=""></p><p>步骤2：选择设备-》添加备份介质</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141017231.jpg" alt=""></p><p>步骤3：选择目标数据test</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202407092207900.jpg" alt="back3"></p><p>步骤4：点击左边选择页【文件】-》选中将所以文件重新定位到文件夹-》选择目标数据库的mdf和ldf文件，即test.mdf和test_log.ldf</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141017908.jpg" alt=""></p><p>步骤5：点击左边选择页【选项】-》取消已勾选的还原前进行结尾日志备份-》选中覆盖现有数据库</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141017300.jpg" alt=""></p><p>如下图，成功还原数据库test</p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141017063.jpg" alt=""></p>`,128),e=[o];function t(c,r,E,y,i,F){return a(),n("div",null,e)}const m=s(p,[["render",t]]);export{h as __pageData,m as default};
