import{_ as s,o as a,c as n,R as l}from"./chunks/framework.zUbWieqp.js";const d=JSON.parse('{"title":"1. Fail2ban介绍","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Linux/service/13-Fail2ban.md","filePath":"guide/Linux/service/13-Fail2ban.md","lastUpdated":1735640291000}'),p={name:"guide/Linux/service/13-Fail2ban.md"},o=l(`<h1 id="_1-fail2ban介绍" tabindex="-1">1. Fail2ban介绍 <a class="header-anchor" href="#_1-fail2ban介绍" aria-label="Permalink to &quot;1. Fail2ban介绍&quot;">​</a></h1><p>Fail2Ban 是一个 Linux 系统的应用软件，用来防止系统入侵，主要是防止暴力破解系统密码。它是用 Python 开发的。</p><p>它主要通过监控日志文件（比如<code>/var/log/auth.log</code>、<code>/var/log/apache/access.log</code>等）来生效。一旦发现恶意攻击的登录请求，它会封锁对方的 IP 地址，使得对方无法再发起请求。</p><p>Fail2Ban 可以防止有人反复尝试 SSH 密码登录，但是如果 SSH 采用的是密钥登录，禁止了密码登录，就不需要 Fail2Ban 来保护。</p><p><a href="https://github.com/fail2ban/fail2ban" target="_blank" rel="noreferrer">https://github.com/fail2ban/fail2ban</a></p><h1 id="_2-faile2ban部署" tabindex="-1">2. Faile2ban部署 <a class="header-anchor" href="#_2-faile2ban部署" aria-label="Permalink to &quot;2. Faile2ban部署&quot;">​</a></h1><h2 id="_2-1-安装" tabindex="-1">2.1 安装 <a class="header-anchor" href="#_2-1-安装" aria-label="Permalink to &quot;2.1 安装&quot;">​</a></h2><p><code>基于rocklinux8</code></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#centos8</span></span>
<span class="line"><span style="color:#B392F0;">dnf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">epel-release</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#centos7</span></span>
<span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">epel-release</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">fail2ban</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">iptables</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#centos8</span></span>
<span class="line"><span style="color:#6F42C1;">dnf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">epel-release</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#centos7</span></span>
<span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">epel-release</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">fail2ban</span><span style="color:#24292E;"> </span><span style="color:#032F62;">iptables</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span></code></pre></div><p>也可以通过源码进行安装</p><h2 id="_2-2-目录介绍" tabindex="-1">2.2 目录介绍 <a class="header-anchor" href="#_2-2-目录介绍" aria-label="Permalink to &quot;2.2 目录介绍&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tree</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-L</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/fail2ban</span></span>
<span class="line"><span style="color:#B392F0;">/etc/fail2ban</span></span>
<span class="line"><span style="color:#B392F0;">├──</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">action.d</span></span>
<span class="line"><span style="color:#B392F0;">├──</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">fail2ban.conf</span></span>
<span class="line"><span style="color:#B392F0;">├──</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">fail2ban.d</span></span>
<span class="line"><span style="color:#B392F0;">├──</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">filter.d</span></span>
<span class="line"><span style="color:#B392F0;">├──</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">jail.conf</span></span>
<span class="line"><span style="color:#B392F0;">├──</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">jail.d</span></span>
<span class="line"><span style="color:#B392F0;">├──</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">paths-common.conf</span></span>
<span class="line"><span style="color:#B392F0;">└──</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">paths-fedora.conf</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tree</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-L</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/fail2ban</span></span>
<span class="line"><span style="color:#6F42C1;">/etc/fail2ban</span></span>
<span class="line"><span style="color:#6F42C1;">├──</span><span style="color:#24292E;"> </span><span style="color:#032F62;">action.d</span></span>
<span class="line"><span style="color:#6F42C1;">├──</span><span style="color:#24292E;"> </span><span style="color:#032F62;">fail2ban.conf</span></span>
<span class="line"><span style="color:#6F42C1;">├──</span><span style="color:#24292E;"> </span><span style="color:#032F62;">fail2ban.d</span></span>
<span class="line"><span style="color:#6F42C1;">├──</span><span style="color:#24292E;"> </span><span style="color:#032F62;">filter.d</span></span>
<span class="line"><span style="color:#6F42C1;">├──</span><span style="color:#24292E;"> </span><span style="color:#032F62;">jail.conf</span></span>
<span class="line"><span style="color:#6F42C1;">├──</span><span style="color:#24292E;"> </span><span style="color:#032F62;">jail.d</span></span>
<span class="line"><span style="color:#6F42C1;">├──</span><span style="color:#24292E;"> </span><span style="color:#032F62;">paths-common.conf</span></span>
<span class="line"><span style="color:#6F42C1;">└──</span><span style="color:#24292E;"> </span><span style="color:#032F62;">paths-fedora.conf</span></span></code></pre></div><h2 id="_2-3-配置" tabindex="-1">2.3 配置 <a class="header-anchor" href="#_2-3-配置" aria-label="Permalink to &quot;2.3 配置&quot;">​</a></h2><p>根据 <a href="https://github.com/fail2ban/fail2ban/wiki/Proper-fail2ban-configuration" target="_blank" rel="noreferrer">fail2ban 官网 wiki</a> 建议，在配置 fail2ban 的时候应该避免直接更改由 fail2ban 安装创建的<code>.conf</code> 文件（例如 <code>fail2ban.conf</code> 和 <code>jail.conf</code>），相反，应该创建扩展名为<code>.local</code> 的新文件（例如 <code>jail.local</code>）来进行自定义配置。<code>.local</code> 文件将覆盖<code>.conf</code> 文件相同部分的参数</p><ul><li>修改配置</li></ul><p>vim /etc/fail2ban/jail.conf.local</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[DEFAULT]</span></span>
<span class="line"><span style="color:#6A737D;"># 忽略 IP，IP 白名单，这些 IP 永远不会被禁</span></span>
<span class="line"><span style="color:#B392F0;">ignoreip</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1/8</span></span>
<span class="line"><span style="color:#6A737D;">#IP 被封禁的时间，单位秒</span></span>
<span class="line"><span style="color:#B392F0;">bantime</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">600</span></span>
<span class="line"><span style="color:#6A737D;">#日志文件中，在 findtime 时间段内，ip 出现超过 maxretry 次数，就会封禁该 IP</span></span>
<span class="line"><span style="color:#B392F0;">findtime</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">600</span></span>
<span class="line"><span style="color:#B392F0;">maxretry</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#6A737D;"># &quot;backend&quot; 指获取日志文件的方法，分为&quot;pyinotify&quot;, &quot;gamin&quot;, &quot;polling&quot;， &quot;auto&quot;四种</span></span>
<span class="line"><span style="color:#6A737D;"># auto 值得是哪种可用就用哪种，默认 polling 可用</span></span>
<span class="line"><span style="color:#B392F0;">backend</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">auto</span></span>
<span class="line"><span style="color:#6A737D;"># &quot;usedns&quot; specifies if jails should trust hostnames in logs,</span></span>
<span class="line"><span style="color:#B392F0;">usedns</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">warn</span></span>
<span class="line"><span style="color:#6A737D;">#接受邮件地址</span></span>
<span class="line"><span style="color:#B392F0;">destemail</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">xxxxxx@gmail.com</span></span>
<span class="line"><span style="color:#6A737D;"># Name of the sender for mta actions</span></span>
<span class="line"><span style="color:#B392F0;">sendername</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Fail2Ban</span></span>
<span class="line"><span style="color:#6A737D;">#默认的动作执行行为，在 action.d 目录下有各种行为策略，默认是 iptables-multiport</span></span>
<span class="line"><span style="color:#B392F0;">banaction</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">iptables-multiport</span></span>
<span class="line"><span style="color:#6A737D;"># email action. Since 0.8.1 upstream fail2ban uses sendmail</span></span>
<span class="line"><span style="color:#B392F0;">mta</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sendmail</span></span>
<span class="line"><span style="color:#6A737D;"># Default protocol</span></span>
<span class="line"><span style="color:#B392F0;">protocol</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tcp</span></span>
<span class="line"><span style="color:#6A737D;"># Specify chain where jumps would need to be added in iptables-* actions</span></span>
<span class="line"><span style="color:#B392F0;">chain</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">INPUT</span></span>
<span class="line"><span style="color:#6A737D;">#定义各种行为参数</span></span>
<span class="line"><span style="color:#6A737D;">#只禁 IP</span></span>
<span class="line"><span style="color:#B392F0;">action_</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">%</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">banaction</span><span style="color:#E1E4E8;">)</span><span style="color:#9ECBFF;">s[name=%</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">__name__</span><span style="color:#E1E4E8;">)</span><span style="color:#9ECBFF;">s,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">port=&quot;%(port)s&quot;,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">protocol=&quot;%(protocol)s&quot;,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">chain=&quot;%(chain)s&quot;]</span></span>
<span class="line"><span style="color:#6A737D;">#禁 IP+邮件通知</span></span>
<span class="line"><span style="color:#B392F0;">action_mw</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">%</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">banaction</span><span style="color:#E1E4E8;">)</span><span style="color:#9ECBFF;">s[name=%</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">__name__</span><span style="color:#E1E4E8;">)</span><span style="color:#9ECBFF;">s,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">port=&quot;%(port)s&quot;,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">protocol=&quot;%(protocol)s&quot;,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">chain=&quot;%(chain)s&quot;]</span></span>
<span class="line"><span style="color:#B392F0;">%(mta</span><span style="color:#E1E4E8;">)s-whois[name</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">%(__name__)s, dest</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;%(destemail)s&quot;</span><span style="color:#E1E4E8;">, protocol</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;%(protocol)s&quot;</span><span style="color:#E1E4E8;">, chain</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;%(chain)s&quot;</span><span style="color:#E1E4E8;">, sendername</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;%(sendername)s&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#6A737D;"># 禁 IP+邮件通知+报告相关日志</span></span>
<span class="line"><span style="color:#B392F0;">action_mwl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">%</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">banaction</span><span style="color:#E1E4E8;">)</span><span style="color:#9ECBFF;">s[name=%</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">__name__</span><span style="color:#E1E4E8;">)</span><span style="color:#9ECBFF;">s,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">port=&quot;%(port)s&quot;,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">protocol=&quot;%(protocol)s&quot;,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">chain=&quot;%(chain)s&quot;]</span></span>
<span class="line"><span style="color:#B392F0;">%(mta</span><span style="color:#E1E4E8;">)s-whois-lines[name</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">%(__name__)s, dest</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;%(destemail)s&quot;</span><span style="color:#E1E4E8;">, logpath</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">%(logpath)s, chain</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;%(chain)s&quot;</span><span style="color:#E1E4E8;">, sendername</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;%(sendername)s&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#6A737D;"># 选择行为</span></span>
<span class="line"><span style="color:#B392F0;">action</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">%</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">action_</span><span style="color:#E1E4E8;">)</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#6A737D;">#以下是各种应用监控日志的配置，以 ssh 日志为例说明一下配置原理</span></span>
<span class="line"><span style="color:#E1E4E8;">[ssh]</span></span>
<span class="line"><span style="color:#B392F0;">enabled</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#B392F0;">port</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">22</span></span>
<span class="line"><span style="color:#B392F0;">filter</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sshd</span></span>
<span class="line"><span style="color:#B392F0;">logpath</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/log/secure</span></span>
<span class="line"><span style="color:#B392F0;">bantime</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">mon</span></span>
<span class="line"><span style="color:#B392F0;">findtime</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#9ECBFF;">m</span></span>
<span class="line"><span style="color:#B392F0;">maxretry</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#B392F0;">action</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">%</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">action_mw</span><span style="color:#E1E4E8;">)</span><span style="color:#9ECBFF;">s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[DEFAULT]</span></span>
<span class="line"><span style="color:#6A737D;"># 忽略 IP，IP 白名单，这些 IP 永远不会被禁</span></span>
<span class="line"><span style="color:#6F42C1;">ignoreip</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1/8</span></span>
<span class="line"><span style="color:#6A737D;">#IP 被封禁的时间，单位秒</span></span>
<span class="line"><span style="color:#6F42C1;">bantime</span><span style="color:#24292E;">  </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">600</span></span>
<span class="line"><span style="color:#6A737D;">#日志文件中，在 findtime 时间段内，ip 出现超过 maxretry 次数，就会封禁该 IP</span></span>
<span class="line"><span style="color:#6F42C1;">findtime</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">600</span></span>
<span class="line"><span style="color:#6F42C1;">maxretry</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#6A737D;"># &quot;backend&quot; 指获取日志文件的方法，分为&quot;pyinotify&quot;, &quot;gamin&quot;, &quot;polling&quot;， &quot;auto&quot;四种</span></span>
<span class="line"><span style="color:#6A737D;"># auto 值得是哪种可用就用哪种，默认 polling 可用</span></span>
<span class="line"><span style="color:#6F42C1;">backend</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">auto</span></span>
<span class="line"><span style="color:#6A737D;"># &quot;usedns&quot; specifies if jails should trust hostnames in logs,</span></span>
<span class="line"><span style="color:#6F42C1;">usedns</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">warn</span></span>
<span class="line"><span style="color:#6A737D;">#接受邮件地址</span></span>
<span class="line"><span style="color:#6F42C1;">destemail</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">xxxxxx@gmail.com</span></span>
<span class="line"><span style="color:#6A737D;"># Name of the sender for mta actions</span></span>
<span class="line"><span style="color:#6F42C1;">sendername</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Fail2Ban</span></span>
<span class="line"><span style="color:#6A737D;">#默认的动作执行行为，在 action.d 目录下有各种行为策略，默认是 iptables-multiport</span></span>
<span class="line"><span style="color:#6F42C1;">banaction</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">iptables-multiport</span></span>
<span class="line"><span style="color:#6A737D;"># email action. Since 0.8.1 upstream fail2ban uses sendmail</span></span>
<span class="line"><span style="color:#6F42C1;">mta</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sendmail</span></span>
<span class="line"><span style="color:#6A737D;"># Default protocol</span></span>
<span class="line"><span style="color:#6F42C1;">protocol</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tcp</span></span>
<span class="line"><span style="color:#6A737D;"># Specify chain where jumps would need to be added in iptables-* actions</span></span>
<span class="line"><span style="color:#6F42C1;">chain</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">INPUT</span></span>
<span class="line"><span style="color:#6A737D;">#定义各种行为参数</span></span>
<span class="line"><span style="color:#6A737D;">#只禁 IP</span></span>
<span class="line"><span style="color:#6F42C1;">action_</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">%</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">banaction</span><span style="color:#24292E;">)</span><span style="color:#032F62;">s[name=%</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">__name__</span><span style="color:#24292E;">)</span><span style="color:#032F62;">s,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">port=&quot;%(port)s&quot;,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">protocol=&quot;%(protocol)s&quot;,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">chain=&quot;%(chain)s&quot;]</span></span>
<span class="line"><span style="color:#6A737D;">#禁 IP+邮件通知</span></span>
<span class="line"><span style="color:#6F42C1;">action_mw</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">%</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">banaction</span><span style="color:#24292E;">)</span><span style="color:#032F62;">s[name=%</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">__name__</span><span style="color:#24292E;">)</span><span style="color:#032F62;">s,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">port=&quot;%(port)s&quot;,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">protocol=&quot;%(protocol)s&quot;,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">chain=&quot;%(chain)s&quot;]</span></span>
<span class="line"><span style="color:#6F42C1;">%(mta</span><span style="color:#24292E;">)s-whois[name</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">%(__name__)s, dest</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;%(destemail)s&quot;</span><span style="color:#24292E;">, protocol</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;%(protocol)s&quot;</span><span style="color:#24292E;">, chain</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;%(chain)s&quot;</span><span style="color:#24292E;">, sendername</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;%(sendername)s&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#6A737D;"># 禁 IP+邮件通知+报告相关日志</span></span>
<span class="line"><span style="color:#6F42C1;">action_mwl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">%</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">banaction</span><span style="color:#24292E;">)</span><span style="color:#032F62;">s[name=%</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">__name__</span><span style="color:#24292E;">)</span><span style="color:#032F62;">s,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">port=&quot;%(port)s&quot;,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">protocol=&quot;%(protocol)s&quot;,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">chain=&quot;%(chain)s&quot;]</span></span>
<span class="line"><span style="color:#6F42C1;">%(mta</span><span style="color:#24292E;">)s-whois-lines[name</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">%(__name__)s, dest</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;%(destemail)s&quot;</span><span style="color:#24292E;">, logpath</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">%(logpath)s, chain</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;%(chain)s&quot;</span><span style="color:#24292E;">, sendername</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;%(sendername)s&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#6A737D;"># 选择行为</span></span>
<span class="line"><span style="color:#6F42C1;">action</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">%</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">action_</span><span style="color:#24292E;">)</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6A737D;">#以下是各种应用监控日志的配置，以 ssh 日志为例说明一下配置原理</span></span>
<span class="line"><span style="color:#24292E;">[ssh]</span></span>
<span class="line"><span style="color:#6F42C1;">enabled</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#6F42C1;">port</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">22</span></span>
<span class="line"><span style="color:#6F42C1;">filter</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sshd</span></span>
<span class="line"><span style="color:#6F42C1;">logpath</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/log/secure</span></span>
<span class="line"><span style="color:#6F42C1;">bantime</span><span style="color:#24292E;">  </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">mon</span></span>
<span class="line"><span style="color:#6F42C1;">findtime</span><span style="color:#24292E;">  </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">m</span></span>
<span class="line"><span style="color:#6F42C1;">maxretry</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#6F42C1;">action</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">%</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">action_mw</span><span style="color:#24292E;">)</span><span style="color:#032F62;">s</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">❌ 注意</p><p>参数说明:</p><p><strong>ignoreip</strong>：配置忽略检测的 IP (段)，如有多个用空格隔开</p><p><strong>enabled</strong>：配置是否启用此 section 的的扫描监控</p><p><strong>port</strong>：配置服务端口，如果 SSH 使用非默认端口 22，要修改为实际使用端口</p><p><strong>filter</strong>：配置使用的匹配规则文件（位于 <code>/etc/fail2ban/filter.d</code> 目录中）</p><p><strong>logpath</strong>：配置要扫描的日志文件路径</p><p><strong>bantime</strong>：配置 IP 封禁的持续时间（秒或时间缩写格</p><p>式:years/months/weeks/days/hours/minutes/seconds）</p><p><strong>findtime</strong>：配置从当前时间的多久之前开始计算失败次数（秒或时间缩写格式:years/months/weeks/days/hours/minutes/seconds）</p><p><strong>maxretry</strong>：配置在 findtime 时间内发生多少次失败登录然后将 IP 封禁。</p></div><h1 id="_3-faile2ban管理" tabindex="-1">3. Faile2ban管理 <a class="header-anchor" href="#_3-faile2ban管理" aria-label="Permalink to &quot;3. Faile2ban管理&quot;">​</a></h1><h2 id="_3-1-常用命令" tabindex="-1">3.1 常用命令 <a class="header-anchor" href="#_3-1-常用命令" aria-label="Permalink to &quot;3.1 常用命令&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#查看 fail2ban 状态</span></span>
<span class="line"><span style="color:#B392F0;">fail2ban-client</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">status</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看日志监控状态</span></span>
<span class="line"><span style="color:#B392F0;">fail2ban-client</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">status</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看 iptables 禁 ip 情况</span></span>
<span class="line"><span style="color:#B392F0;">iptables</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-nvL</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#手动解除限制(使用unban解除封锁的IP)</span></span>
<span class="line"><span style="color:#B392F0;">fail2ban-client</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unban</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.1.16</span></span>
<span class="line"><span style="color:#B392F0;">fail2ban-client</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">unban</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--all</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#解除所有</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#查看 fail2ban 状态</span></span>
<span class="line"><span style="color:#6F42C1;">fail2ban-client</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看日志监控状态</span></span>
<span class="line"><span style="color:#6F42C1;">fail2ban-client</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#查看 iptables 禁 ip 情况</span></span>
<span class="line"><span style="color:#6F42C1;">iptables</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-nvL</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#手动解除限制(使用unban解除封锁的IP)</span></span>
<span class="line"><span style="color:#6F42C1;">fail2ban-client</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unban</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.1.16</span></span>
<span class="line"><span style="color:#6F42C1;">fail2ban-client</span><span style="color:#24292E;"> </span><span style="color:#032F62;">unban</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--all</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">#解除所有</span></span></code></pre></div>`,21),e=[o];function t(c,r,y,E,i,F){return a(),n("div",null,e)}const C=s(p,[["render",t]]);export{d as __pageData,C as default};
