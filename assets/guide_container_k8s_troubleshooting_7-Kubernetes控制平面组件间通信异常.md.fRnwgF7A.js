import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const u=JSON.parse('{"title":"1.Kubernetes 控制平面组件间通信异常","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/troubleshooting/7-Kubernetes控制平面组件间通信异常.md","filePath":"guide/container/k8s/troubleshooting/7-Kubernetes控制平面组件间通信异常.md","lastUpdated":1713263180000}'),o={name:"guide/container/k8s/troubleshooting/7-Kubernetes控制平面组件间通信异常.md"},p=l(`<h1 id="_1-kubernetes-控制平面组件间通信异常" tabindex="-1">1.<strong>Kubernetes 控制平面组件间通信异常</strong> <a class="header-anchor" href="#_1-kubernetes-控制平面组件间通信异常" aria-label="Permalink to &quot;1.**Kubernetes 控制平面组件间通信异常**&quot;">​</a></h1><h2 id="_1-1-问题" tabindex="-1">1.1 问题 <a class="header-anchor" href="#_1-1-问题" aria-label="Permalink to &quot;1.1 问题&quot;">​</a></h2><p>Kubernetes 控制平面组件（如 API 服务器、etcd、控制器管理器、调度器等）之间通信异常，导致集群管理功能受限或失效</p><p><strong>影响范围：</strong></p><ul><li>直接影响：集群管理功能受限，如无法创建/更新资源、Pod 无法调度、状态更新延迟等。</li><li>间接影响：可能导致整个集群的稳定性下降，应用无法正常部署、扩展或恢复，数据一致性问题，严重的甚至可能导致集群完全不可用</li></ul><h2 id="_1-2-排查方案" tabindex="-1">1.2 排查方案 <a class="header-anchor" href="#_1-2-排查方案" aria-label="Permalink to &quot;1.2 排查方案&quot;">​</a></h2><ol><li><strong>检查控制平面组件状态</strong>：使用 <code>kubectl get componentstatuses|cs</code> 查看控制平面各组件的状态，关注是否有 <code>Unhealthy</code> 或 <code>Unknown</code> 的组件。</li><li><strong>查看控制平面日志</strong>：分别检查 API 服务器、etcd、控制器管理器、调度器等组件的日志，查找与通信异常相关的错误或警告。</li><li><strong>检查 etcd 集群健康状况</strong>：使用 <code>etcdctl</code> 工具检查 etcd 集群的健康状况、成员列表、领导者选举状态等，确认各成员间通信是否正常。</li><li><strong>检查控制平面网络连接</strong>：使用 <code>netstat</code>、<code>ss</code> 或 <code>telnet</code> 等工具检查控制平面组件之间的网络连接，确认端口是否可达、TCP 连接是否正常。</li><li><strong>审查控制平面配置</strong>：检查控制平面组件的配置文件（如 <code>/etc/kubernetes/manifests</code> 下的静态 Pod 清单），确认 API 服务器的 <code>--etcd-servers</code>、控制器管理器和调度器的 <code>--master</code> 参数等是否正确。</li></ol><h1 id="_2-案例" tabindex="-1">2.案例 <a class="header-anchor" href="#_2-案例" aria-label="Permalink to &quot;2.案例&quot;">​</a></h1><p>比如kubeadmn安装的k8s，默认是没开启，导致出现Unhealthy，但是由于本身服务是正常的，只是健康检查的端口没启，所以不影响正常使用</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cs</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                 </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">MESSAGE</span><span style="color:#E1E4E8;">                                                                                     </span><span style="color:#9ECBFF;">ERROR</span></span>
<span class="line"><span style="color:#B392F0;">controller-manager</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Unhealthy</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://127.0.0.1:10252/healthz:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dial</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tcp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1:10252:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connect:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connection</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">refused</span></span>
<span class="line"><span style="color:#B392F0;">scheduler</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">Unhealthy</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">http://127.0.0.1:10251/healthz:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dial</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tcp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1:10251:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connect:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connection</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">refused</span></span>
<span class="line"><span style="color:#B392F0;">etcd-0</span><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">Healthy</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">{&quot;health&quot;:&quot;true&quot;}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cs</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">      </span><span style="color:#032F62;">MESSAGE</span><span style="color:#24292E;">                                                                                     </span><span style="color:#032F62;">ERROR</span></span>
<span class="line"><span style="color:#6F42C1;">controller-manager</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Unhealthy</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://127.0.0.1:10252/healthz:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dial</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tcp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1:10252:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connect:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connection</span><span style="color:#24292E;"> </span><span style="color:#032F62;">refused</span></span>
<span class="line"><span style="color:#6F42C1;">scheduler</span><span style="color:#24292E;">            </span><span style="color:#032F62;">Unhealthy</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">http://127.0.0.1:10251/healthz:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dial</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tcp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1:10251:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connect:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connection</span><span style="color:#24292E;"> </span><span style="color:#032F62;">refused</span></span>
<span class="line"><span style="color:#6F42C1;">etcd-0</span><span style="color:#24292E;">               </span><span style="color:#032F62;">Healthy</span><span style="color:#24292E;">     </span><span style="color:#032F62;">{&quot;health&quot;:&quot;true&quot;}</span></span></code></pre></div><ul><li>解决</li></ul><p>路径，/etc/kubernetes/manifests，把port=0那行注释</p><p><code>注意这里修改的任何东西，不需要重启，k8会自动生效</code></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">vi</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-controller-manager.yaml</span></span>
<span class="line"><span style="color:#B392F0;">vi</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-scheduler.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#该 --port=0表示禁止使用非安全的http接口</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[root@kube-master manifests]# kubectl get cs</span></span>
<span class="line"><span style="color:#B392F0;">Warning:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ComponentStatus</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deprecated</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1.19+</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                 </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">MESSAGE</span><span style="color:#E1E4E8;">                         </span><span style="color:#9ECBFF;">ERROR</span></span>
<span class="line"><span style="color:#B392F0;">scheduler</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">Healthy</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">ok</span></span>
<span class="line"><span style="color:#B392F0;">controller-manager</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Healthy</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">ok</span></span>
<span class="line"><span style="color:#B392F0;">etcd-0</span><span style="color:#E1E4E8;">               </span><span style="color:#9ECBFF;">Healthy</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">{&quot;health&quot;:&quot;true&quot;,&quot;reason&quot;:&quot;&quot;}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">vi</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-controller-manager.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">vi</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-scheduler.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">#该 --port=0表示禁止使用非安全的http接口</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[root@kube-master manifests]# kubectl get cs</span></span>
<span class="line"><span style="color:#6F42C1;">Warning:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ComponentStatus</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deprecated</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1.19+</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                 </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">MESSAGE</span><span style="color:#24292E;">                         </span><span style="color:#032F62;">ERROR</span></span>
<span class="line"><span style="color:#6F42C1;">scheduler</span><span style="color:#24292E;">            </span><span style="color:#032F62;">Healthy</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ok</span></span>
<span class="line"><span style="color:#6F42C1;">controller-manager</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Healthy</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ok</span></span>
<span class="line"><span style="color:#6F42C1;">etcd-0</span><span style="color:#24292E;">               </span><span style="color:#032F62;">Healthy</span><span style="color:#24292E;">   </span><span style="color:#032F62;">{&quot;health&quot;:&quot;true&quot;,&quot;reason&quot;:&quot;&quot;}</span></span></code></pre></div>`,14),e=[p];function t(c,r,E,y,F,i){return n(),a("div",null,e)}const h=s(o,[["render",t]]);export{u as __pageData,h as default};
