import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const A=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/SqlServer/15-scripts.md","filePath":"guide/Database/SqlServer/15-scripts.md","lastUpdated":1720533756000}'),p={name:"guide/Database/SqlServer/15-scripts.md"},o=l(`<h2 id="_1-当前正在运行进程会话的请求信息" tabindex="-1">1.当前正在运行进程会话的请求信息 <a class="header-anchor" href="#_1-当前正在运行进程会话的请求信息" aria-label="Permalink to &quot;1.当前正在运行进程会话的请求信息&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_NAME</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">nocount</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">on</span></span>
<span class="line"><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">transaction</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">isolation</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">level</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">read</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">uncommitted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">;</span><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> cte </span><span style="color:#F97583;">as</span></span>
<span class="line"><span style="color:#E1E4E8;">( </span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> spid,</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">status</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> blocked</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">program_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">str</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_elapsed_time</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> duration_s</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">str</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">cpu_time</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">wait_time</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> inter_duration_s</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">str</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">cpu_time</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> cpu_time_s</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">str</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">wait_time</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> wait_time_s</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">granted_query_memory</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">8</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> mb,</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">logical_reads</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">reads</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">writes</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">start_time</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">login_time</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">command</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">wait_type</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">wait_resource</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">status</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">program_name</span></span>
<span class="line"><span style="color:#E1E4E8;">            ,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">command</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span></span>
<span class="line"><span style="color:#E1E4E8;">            ,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">cpu_time</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">wait_time</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_elapsed_time</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">granted_query_memory</span></span>
<span class="line"><span style="color:#E1E4E8;">            ,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">start_time</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">login_time</span></span>
<span class="line"><span style="color:#E1E4E8;">            ,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">logical_reads</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">reads</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">writes</span></span>
<span class="line"><span style="color:#E1E4E8;">            ,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">wait_type</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">wait_resource</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">inner join</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sessions</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">program_name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is not null</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> @@spid</span></span>
<span class="line"><span style="color:#E1E4E8;">    ) t </span><span style="color:#F97583;">cross</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">) s </span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">exists</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> cte b </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">spid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">spid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocked</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">spid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> blocked </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> cte c))) </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;yes&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> is_blocker</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> cte a</span></span>
<span class="line"><span style="color:#F97583;">where</span></span>
<span class="line"><span style="color:#E1E4E8;">    (blocked</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">or</span></span>
<span class="line"><span style="color:#E1E4E8;">    (spid </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> blocked </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> cte)) </span><span style="color:#F97583;">or</span></span>
<span class="line"><span style="color:#E1E4E8;">    duration_s</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> blocked,program_name,spid</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_NAME</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">set</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">nocount</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">on</span></span>
<span class="line"><span style="color:#D73A49;">set</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">transaction</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">isolation</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">level</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">read</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">uncommitted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">;</span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> cte </span><span style="color:#D73A49;">as</span></span>
<span class="line"><span style="color:#24292E;">( </span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> spid,</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">status</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> blocked</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">program_name</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_elapsed_time</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> duration_s</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">cpu_time</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">wait_time</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> inter_duration_s</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">cpu_time</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> cpu_time_s</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">wait_time</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> wait_time_s</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">granted_query_memory</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">8</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1024</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> mb,</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">logical_reads</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">reads</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">writes</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">start_time</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">login_time</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">command</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">wait_type</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">wait_resource</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    (</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">status</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">program_name</span></span>
<span class="line"><span style="color:#24292E;">            ,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">command</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span></span>
<span class="line"><span style="color:#24292E;">            ,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">cpu_time</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">wait_time</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_elapsed_time</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">granted_query_memory</span></span>
<span class="line"><span style="color:#24292E;">            ,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">start_time</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">login_time</span></span>
<span class="line"><span style="color:#24292E;">            ,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">logical_reads</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">reads</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">writes</span></span>
<span class="line"><span style="color:#24292E;">            ,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">wait_type</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">wait_resource</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">inner join</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sessions</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">program_name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is not null</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> @@spid</span></span>
<span class="line"><span style="color:#24292E;">    ) t </span><span style="color:#D73A49;">cross</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">) s </span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    (</span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">exists</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> cte b </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">spid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">spid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocked</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">spid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> blocked </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> cte c))) </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;yes&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> is_blocker</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> cte a</span></span>
<span class="line"><span style="color:#D73A49;">where</span></span>
<span class="line"><span style="color:#24292E;">    (blocked</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">or</span></span>
<span class="line"><span style="color:#24292E;">    (spid </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> blocked </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> cte)) </span><span style="color:#D73A49;">or</span></span>
<span class="line"><span style="color:#24292E;">    duration_s</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">5</span></span>
<span class="line"><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> blocked,program_name,spid</span></span></code></pre></div><ul><li>查看当前正在执行的sql</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  [Spid] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> session_id , ecid ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            [Database] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;">) ,[User] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nt_username ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            [Status] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">status</span><span style="color:#E1E4E8;"> , [Wait] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> wait_type ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            [Individual Query] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                                           </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                                           ( </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                  </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">LEN</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX), </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                       </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                                                  </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                                             </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                                           </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            [Parent Query] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;"> , Program </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> program_name ,hostname ,  nt_domain , start_time</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> er</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sysprocesses</span><span style="color:#E1E4E8;"> sp </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">spid</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> qt</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   session_id </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- Ignore system spids.</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> session_id </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> ( @@SPID ) </span><span style="color:#6A737D;">-- Ignore this current statement.</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  [Spid] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> session_id , ecid ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            [Database] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;">) ,[User] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nt_username ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            [Status] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">status</span><span style="color:#24292E;"> , [Wait] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> wait_type ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            [Individual Query] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                                           </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                                           ( </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                                                  </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">LEN</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX), </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                                                       </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                                                  </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                                             </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#24292E;"> )</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                                           </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            [Parent Query] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;"> , Program </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> program_name ,hostname ,  nt_domain , start_time</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> er</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sysprocesses</span><span style="color:#24292E;"> sp </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">spid</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> qt</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   session_id </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- Ignore system spids.</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> session_id </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> ( @@SPID ) </span><span style="color:#6A737D;">-- Ignore this current statement.</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">2</span></span></code></pre></div><h2 id="_2-查看索引碎片" tabindex="-1">2.查看索引碎片 <a class="header-anchor" href="#_2-查看索引碎片" aria-label="Permalink to &quot;2.查看索引碎片&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_NAME</span></span>
<span class="line"><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">nocount</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">on</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">print</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">db_name</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @tab_name </span><span style="color:#F97583;">sysname</span></span>
<span class="line"><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @tab_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;wfpuser_a0113&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--内部碎片</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;【内部】碎片&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> frag_type</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ob</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> object_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ix</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">ix</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> index_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_level</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">partition_number</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">record_count</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page_count</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fragment_count</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">str</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">avg_fragmentation_in_percent</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> [avg_frag(%)]</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">str</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">avg_fragment_size_in_pages</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> [avg_frag_pages]</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">forwarded_record_count</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">avg_record_size_in_bytes</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">str</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">avg_page_space_used_in_percent</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> [avg_page_space_used(%)]</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_index_physical_stats</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">db_id</span><span style="color:#E1E4E8;">(),</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">(@tab_name),</span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;detailed&#39;</span><span style="color:#E1E4E8;">) ps</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">inner join</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> ix </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ix</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ix</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">inner join</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objects</span><span style="color:#E1E4E8;"> ob </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ob</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">ix</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ob</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_ms_shipped</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">union all</span></span>
<span class="line"><span style="color:#6A737D;">--外部碎片</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;外部碎片&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> frag_type</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ob</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> object_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ix</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">ix</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> index_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_level</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">partition_number</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">record_count</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">page_count</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fragment_count</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">str</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">avg_fragmentation_in_percent</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> [avg_frag(%)]</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">str</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">avg_fragment_size_in_pages</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> [avg_frag_pages]</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">forwarded_record_count</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">avg_record_size_in_bytes</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">str</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">avg_page_space_used_in_percent</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> [avg_page_space_used(%)]</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_index_physical_stats</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">db_id</span><span style="color:#E1E4E8;">(),</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">(@tab_name),</span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;limited&#39;</span><span style="color:#E1E4E8;">) ps</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">inner join</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> ix </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ix</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ix</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">inner join</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objects</span><span style="color:#E1E4E8;"> ob </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ob</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">ix</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ob</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_ms_shipped</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> object_name,index_id,frag_type</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_NAME</span></span>
<span class="line"><span style="color:#D73A49;">set</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">nocount</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">on</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">print</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">db_name</span><span style="color:#24292E;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @tab_name </span><span style="color:#D73A49;">sysname</span></span>
<span class="line"><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @tab_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;wfpuser_a0113&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--内部碎片</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;【内部】碎片&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> frag_type</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ob</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> object_name</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ix</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">ix</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> index_name</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_level</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">partition_number</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">record_count</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page_count</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fragment_count</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">avg_fragmentation_in_percent</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> [avg_frag(%)]</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">avg_fragment_size_in_pages</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> [avg_frag_pages]</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">forwarded_record_count</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">avg_record_size_in_bytes</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">avg_page_space_used_in_percent</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> [avg_page_space_used(%)]</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_index_physical_stats</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">db_id</span><span style="color:#24292E;">(),</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">(@tab_name),</span><span style="color:#D73A49;">default</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">default</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;detailed&#39;</span><span style="color:#24292E;">) ps</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">inner join</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> ix </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ix</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ix</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">inner join</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objects</span><span style="color:#24292E;"> ob </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ob</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">ix</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ob</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_ms_shipped</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">union all</span></span>
<span class="line"><span style="color:#6A737D;">--外部碎片</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;外部碎片&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> frag_type</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ob</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> object_name</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ix</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">ix</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> index_name</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_level</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">partition_number</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">record_count</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">page_count</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fragment_count</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">avg_fragmentation_in_percent</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> [avg_frag(%)]</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">avg_fragment_size_in_pages</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> [avg_frag_pages]</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">forwarded_record_count</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">avg_record_size_in_bytes</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">str</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">avg_page_space_used_in_percent</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> [avg_page_space_used(%)]</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_index_physical_stats</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">db_id</span><span style="color:#24292E;">(),</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">(@tab_name),</span><span style="color:#D73A49;">default</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">default</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;limited&#39;</span><span style="color:#24292E;">) ps</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">inner join</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> ix </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ix</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ix</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">inner join</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objects</span><span style="color:#24292E;"> ob </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ob</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">ix</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ob</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_ms_shipped</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> object_name,index_id,frag_type</span></span></code></pre></div><blockquote><p>外部索引碎片对性能影响不大</p></blockquote><h3 id="生成索引语句" tabindex="-1">生成索引语句 <a class="header-anchor" href="#生成索引语句" aria-label="Permalink to &quot;生成索引语句&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_NAME</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_SCHEMA_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">) 架构,</span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">) 表名,</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">NAME</span><span style="color:#E1E4E8;"> 索引名,</span><span style="color:#79B8FF;">ROUND</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) 碎片率,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;重新生成索引&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;重新组织索引&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> 处理方式,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&#39;ALTER INDEX &#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">NAME</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39; ON &#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">OBJECT_SCHEMA_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39; &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">+CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;REBUILD&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;REORGANIZE&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> 生成SQL语句</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_index_physical_stats</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">DB_ID</span><span style="color:#E1E4E8;">(),</span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">) A </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> B </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;Order&#39;</span><span style="color:#E1E4E8;">)    </span><span style="color:#6A737D;">--指定表</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;重新生成索引&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;重新组织索引&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">B</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">INDEX_ID</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_NAME</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_SCHEMA_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">) 架构,</span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">) 表名,</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">NAME</span><span style="color:#24292E;"> 索引名,</span><span style="color:#005CC5;">ROUND</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) 碎片率,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;重新生成索引&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;重新组织索引&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> 处理方式,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&#39;ALTER INDEX &#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">NAME</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39; ON &#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">OBJECT_SCHEMA_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39; &#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">+CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;REBUILD&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;REORGANIZE&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> 生成SQL语句</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_index_physical_stats</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">DB_ID</span><span style="color:#24292E;">(),</span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">) A </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> B </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;Order&#39;</span><span style="color:#24292E;">)    </span><span style="color:#6A737D;">--指定表</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">AVG_FRAGMENTATION_IN_PERCENT</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;重新生成索引&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;重新组织索引&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">B</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">INDEX_ID</span></span></code></pre></div><h3 id="索引缺失" tabindex="-1">索引缺失 <a class="header-anchor" href="#索引缺失" aria-label="Permalink to &quot;索引缺失&quot;">​</a></h3><ul><li>建议</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_NAME</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span></span>
<span class="line"><span style="color:#F97583;">statement</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> 表 ,</span></span>
<span class="line"><span style="color:#E1E4E8;">equality_columns </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> 相等列 ,</span></span>
<span class="line"><span style="color:#E1E4E8;">inequality_columns </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> 不相等列 ,</span></span>
<span class="line"><span style="color:#E1E4E8;">included_columns </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> 包含列 ,</span></span>
<span class="line"><span style="color:#E1E4E8;">user_scans </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> user_seeks </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> 总查询次数 ,</span></span>
<span class="line"><span style="color:#E1E4E8;">avg_user_impact </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> 平均百分比收益 ,</span></span>
<span class="line"><span style="color:#E1E4E8;">avg_total_user_cost </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> 平均成本 ,</span></span>
<span class="line"><span style="color:#E1E4E8;">avg_total_user_cost </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> avg_user_impact </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> ( user_scans </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> user_seeks ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> 可能改进 ,</span></span>
<span class="line"><span style="color:#9ECBFF;">&#39;CREATE INDEX [index_&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">obj</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;_&#39;</span></span>
<span class="line"><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">GS</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">group_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;_&#39;</span></span>
<span class="line"><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">D</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;]&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; ON &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> [statement]</span></span>
<span class="line"><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; (&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ISNULL</span><span style="color:#E1E4E8;">(equality_columns, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> equality_columns </span><span style="color:#F97583;">IS NOT NULL</span></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> inequality_columns </span><span style="color:#F97583;">IS NOT NULL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;,&#39;</span></span>
<span class="line"><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ISNULL</span><span style="color:#E1E4E8;">(inequality_columns, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;)&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ISNULL</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39; INCLUDE (&#39;</span></span>
<span class="line"><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> included_columns</span></span>
<span class="line"><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;)&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> Create_Index_Syntax</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_missing_index_details</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> D</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_missing_index_groups</span><span style="color:#E1E4E8;"> G </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">G</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_handle</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">D</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_handle</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_missing_index_group_stats</span><span style="color:#E1E4E8;"> GS </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">G</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_group_handle</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">GS</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">group_handle</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objects</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> obj </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">obj</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">([statement])</span></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">obj</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;U&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_NAME</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span></span>
<span class="line"><span style="color:#D73A49;">statement</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> 表 ,</span></span>
<span class="line"><span style="color:#24292E;">equality_columns </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> 相等列 ,</span></span>
<span class="line"><span style="color:#24292E;">inequality_columns </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> 不相等列 ,</span></span>
<span class="line"><span style="color:#24292E;">included_columns </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> 包含列 ,</span></span>
<span class="line"><span style="color:#24292E;">user_scans </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> user_seeks </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> 总查询次数 ,</span></span>
<span class="line"><span style="color:#24292E;">avg_user_impact </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> 平均百分比收益 ,</span></span>
<span class="line"><span style="color:#24292E;">avg_total_user_cost </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> 平均成本 ,</span></span>
<span class="line"><span style="color:#24292E;">avg_total_user_cost </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> avg_user_impact </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> ( user_scans </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> user_seeks ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> 可能改进 ,</span></span>
<span class="line"><span style="color:#032F62;">&#39;CREATE INDEX [index_&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">obj</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;_&#39;</span></span>
<span class="line"><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">32</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">GS</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">group_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;_&#39;</span></span>
<span class="line"><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">32</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">D</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;]&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; ON &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> [statement]</span></span>
<span class="line"><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; (&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ISNULL</span><span style="color:#24292E;">(equality_columns, </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> equality_columns </span><span style="color:#D73A49;">IS NOT NULL</span></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> inequality_columns </span><span style="color:#D73A49;">IS NOT NULL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;,&#39;</span></span>
<span class="line"><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ISNULL</span><span style="color:#24292E;">(inequality_columns, </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;)&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ISNULL</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39; INCLUDE (&#39;</span></span>
<span class="line"><span style="color:#D73A49;">+</span><span style="color:#24292E;"> included_columns</span></span>
<span class="line"><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;)&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> Create_Index_Syntax</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_missing_index_details</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> D</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_missing_index_groups</span><span style="color:#24292E;"> G </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">G</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_handle</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">D</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_handle</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_missing_index_group_stats</span><span style="color:#24292E;"> GS </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">G</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_group_handle</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">GS</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">group_handle</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objects</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> obj </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">obj</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">([statement])</span></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">obj</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">type</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;U&#39;</span></span></code></pre></div><h2 id="_3-无效的索引、高成本索引" tabindex="-1">3.无效的索引、高成本索引 <a class="header-anchor" href="#_3-无效的索引、高成本索引" aria-label="Permalink to &quot;3.无效的索引、高成本索引&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_NAME</span></span>
<span class="line"><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">nocount</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">on</span></span>
<span class="line"><span style="color:#F97583;">go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--无效索引排序</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">top</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">db_name</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> db_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">schema_name</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schema_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> schema_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> object_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> index_name,</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_unique_constraint</span><span style="color:#E1E4E8;">,(</span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;is_clustered&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> is_clustered</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ir</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">rowcnt</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_updates</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,(</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_lookups</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_scans</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_seeks</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> [retrieval usage] </span><span style="color:#6A737D;">--查询使用次数</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">system_seeks</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">system_scans</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">system_lookups</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> [system usage]</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#9ECBFF;">&#39;DROP INDEX &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">quotename</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">quotename</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> [ -- dsql]</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_index_usage_stats</span><span style="color:#E1E4E8;"> s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">inner join</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">db_id</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> s.[object_id] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> i.[object_id] </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">inner join</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objects</span><span style="color:#E1E4E8;"> o </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">inner join</span><span style="color:#E1E4E8;"> sysindexes ir </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ir</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ir</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">db_id</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_ms_shipped</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is not null</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--and s.user_seeks = 0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--and s.user_scans = 0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--and s.user_lookups = 0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_lookups</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_scans</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_seeks</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_updates</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">desc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 维护成本 排序</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">top</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">db_name</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> db_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">schema_name</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schema_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> schema_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> object_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> index_name,</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_unique_constraint</span><span style="color:#E1E4E8;">,(</span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;is_clustered&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> is_clustered</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">ir</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">rowcnt</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_updates</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- as [update usage] --更新成本</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,(</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_seeks</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_scans</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_lookups</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> [retrieval usage] </span><span style="color:#6A737D;">--查询使用次数</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,(</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_updates</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_seeks</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> user_scans </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_lookups</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> [maintenance cost] </span><span style="color:#6A737D;">--用户维护成本</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">system_seeks</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">system_scans</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">system_lookups</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> [system usage] </span><span style="color:#6A737D;">--系统内部维护次数，--内部维护成本</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">last_user_seek</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">last_user_scan</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">last_user_lookup</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#9ECBFF;">&#39;DROP INDEX &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">quotename</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">quotename</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> [ -- dsql]</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_index_usage_stats</span><span style="color:#E1E4E8;"> s</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">inner join</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">db_id</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> s.[object_id] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> i.[object_id] </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">inner join</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objects</span><span style="color:#E1E4E8;"> o </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">inner join</span><span style="color:#E1E4E8;"> sysindexes ir </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ir</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ir</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">db_id</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_ms_shipped</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is not null</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_seeks</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_scans</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_lookups</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> [maintenance cost] </span><span style="color:#F97583;">desc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_NAME</span></span>
<span class="line"><span style="color:#D73A49;">set</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">nocount</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">on</span></span>
<span class="line"><span style="color:#D73A49;">go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--无效索引排序</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">top</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">db_name</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> db_name</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">schema_name</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schema_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> schema_name</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> object_name</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> index_name,</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_unique_constraint</span><span style="color:#24292E;">,(</span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;is_clustered&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> is_clustered</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ir</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">rowcnt</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_updates</span></span>
<span class="line"><span style="color:#24292E;">    ,(</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_lookups</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_scans</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_seeks</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> [retrieval usage] </span><span style="color:#6A737D;">--查询使用次数</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">system_seeks</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">system_scans</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">system_lookups</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> [system usage]</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#032F62;">&#39;DROP INDEX &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">quotename</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">quotename</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> [ -- dsql]</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_index_usage_stats</span><span style="color:#24292E;"> s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">inner join</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">db_id</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> s.[object_id] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> i.[object_id] </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">inner join</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objects</span><span style="color:#24292E;"> o </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">inner join</span><span style="color:#24292E;"> sysindexes ir </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ir</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ir</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">db_id</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_ms_shipped</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is not null</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--and s.user_seeks = 0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--and s.user_scans = 0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">--and s.user_lookups = 0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_lookups</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_scans</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_seeks</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_updates</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">desc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 维护成本 排序</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">top</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">db_name</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> db_name</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">schema_name</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schema_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> schema_name</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> object_name</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> index_name,</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_unique_constraint</span><span style="color:#24292E;">,(</span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;is_clustered&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> is_clustered</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">ir</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">rowcnt</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_updates</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- as [update usage] --更新成本</span></span>
<span class="line"><span style="color:#24292E;">    ,(</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_seeks</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_scans</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_lookups</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> [retrieval usage] </span><span style="color:#6A737D;">--查询使用次数</span></span>
<span class="line"><span style="color:#24292E;">    ,(</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_updates</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_seeks</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> user_scans </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_lookups</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> [maintenance cost] </span><span style="color:#6A737D;">--用户维护成本</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">system_seeks</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">system_scans</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">system_lookups</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> [system usage] </span><span style="color:#6A737D;">--系统内部维护次数，--内部维护成本</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">last_user_seek</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">last_user_scan</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">last_user_lookup</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#032F62;">&#39;DROP INDEX &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">quotename</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">quotename</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> [ -- dsql]</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_index_usage_stats</span><span style="color:#24292E;"> s</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">inner join</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">db_id</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> s.[object_id] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> i.[object_id] </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">inner join</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objects</span><span style="color:#24292E;"> o </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">inner join</span><span style="color:#24292E;"> sysindexes ir </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ir</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ir</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">db_id</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_ms_shipped</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is not null</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_seeks</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_scans</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_lookups</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> [maintenance cost] </span><span style="color:#D73A49;">desc</span></span></code></pre></div><h2 id="_4-查看索引所占空间" tabindex="-1">4.查看索引所占空间 <a class="header-anchor" href="#_4-查看索引所占空间" aria-label="Permalink to &quot;4.查看索引所占空间&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> hantest</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">　　 </span><span style="color:#79B8FF;">db_name</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> DbName,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">NAME</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> TableName,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> SchemaName,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">rows</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> RowCounts,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_pages</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> TotalSpaceKB, </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">ROUND</span><span style="color:#E1E4E8;">(((</span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_pages</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NUMERIC</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">36</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> 总共占用空间MB,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">used_pages</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> 总使用空间KB, </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">ROUND</span><span style="color:#E1E4E8;">(((</span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">used_pages</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NUMERIC</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">36</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> 总使用空间MB, </span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_pages</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">used_pages</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> 碎片化空间KB,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">ROUND</span><span style="color:#E1E4E8;">(((</span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_pages</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">used_pages</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1024</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NUMERIC</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">36</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> 碎片化空间MB</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">tables</span><span style="color:#E1E4E8;"> t</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">partitions</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">allocation_units</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">partition_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">container_id</span></span>
<span class="line"><span style="color:#F97583;">LEFT OUTER JOIN</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schemas</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schema_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schema_id</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_ms_shipped</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">GROUP BY</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Name</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Name</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Rows</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    总共占用空间MB </span><span style="color:#F97583;">desc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> hantest</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">　　 </span><span style="color:#005CC5;">db_name</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> DbName,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">NAME</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> TableName,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> SchemaName,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">rows</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> RowCounts,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_pages</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> TotalSpaceKB, </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">ROUND</span><span style="color:#24292E;">(((</span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_pages</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NUMERIC</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">36</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> 总共占用空间MB,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">used_pages</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> 总使用空间KB, </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">ROUND</span><span style="color:#24292E;">(((</span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">used_pages</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NUMERIC</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">36</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> 总使用空间MB, </span></span>
<span class="line"><span style="color:#24292E;">    (</span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_pages</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">used_pages</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> 碎片化空间KB,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">ROUND</span><span style="color:#24292E;">(((</span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_pages</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">used_pages</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1024</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">00</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NUMERIC</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">36</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> 碎片化空间MB</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">tables</span><span style="color:#24292E;"> t</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;">      </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">partitions</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">allocation_units</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">partition_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">container_id</span></span>
<span class="line"><span style="color:#D73A49;">LEFT OUTER JOIN</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schemas</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schema_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schema_id</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_ms_shipped</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">GROUP BY</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Name</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Name</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Rows</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    总共占用空间MB </span><span style="color:#D73A49;">desc</span></span></code></pre></div><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202406141025397.jpg" alt=""></p><h3 id="重构数据库中所有表" tabindex="-1">重构数据库中所有表 <a class="header-anchor" href="#重构数据库中所有表" aria-label="Permalink to &quot;重构数据库中所有表&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> My_Database; </span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @name </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> authors_cursor </span><span style="color:#F97583;">CURSOR</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">Select</span><span style="color:#E1E4E8;"> [name]   </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> sysobjects </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> xtype</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;u&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">OPEN</span><span style="color:#E1E4E8;"> authors_cursor</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">FETCH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NEXT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> authors_cursor  </span><span style="color:#F97583;">INTO</span><span style="color:#E1E4E8;"> @name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">WHILE</span><span style="color:#E1E4E8;"> @@FETCH_STATUS </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;">    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">　DBCC DBREINDEX (@name, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">90</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FETCH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NEXT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> authors_cursor     </span><span style="color:#F97583;">INTO</span><span style="color:#E1E4E8;"> @name </span></span>
<span class="line"><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">deallocate</span><span style="color:#E1E4E8;"> authors_cursor</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> My_Database; </span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @name </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> authors_cursor </span><span style="color:#D73A49;">CURSOR</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">Select</span><span style="color:#24292E;"> [name]   </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> sysobjects </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> xtype</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;u&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">OPEN</span><span style="color:#24292E;"> authors_cursor</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">FETCH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NEXT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> authors_cursor  </span><span style="color:#D73A49;">INTO</span><span style="color:#24292E;"> @name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">WHILE</span><span style="color:#24292E;"> @@FETCH_STATUS </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;">    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">　DBCC DBREINDEX (@name, </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">90</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">FETCH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NEXT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> authors_cursor     </span><span style="color:#D73A49;">INTO</span><span style="color:#24292E;"> @name </span></span>
<span class="line"><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">deallocate</span><span style="color:#24292E;"> authors_cursor</span></span></code></pre></div><h3 id="查询未使用过的索引" tabindex="-1">查询未使用过的索引 <a class="header-anchor" href="#查询未使用过的索引" aria-label="Permalink to &quot;查询未使用过的索引&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> DB_NAME</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_id</span><span style="color:#E1E4E8;">)                  </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> DatabaseName ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">)            </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> TableName    ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> IndexID   ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">                                    </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> IndexName        ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_unique</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;UNIQUE INDEX&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;NOT UNIQUE INDEX&#39;</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> IS_UNIQUE,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_disabled</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;DISABLE&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ENABLE&#39;</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> IndexStatus,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">create_date</span><span style="color:#E1E4E8;">                             </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> IndexCreated,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">STATS_DATE</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;">)        </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> StatisticsUpdateDate,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_seeks</span><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> UserSeek ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_scans</span><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> UserScans ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_lookups</span><span style="color:#E1E4E8;">                          </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> UserLookups ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_updates</span><span style="color:#E1E4E8;">                          </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> UserUpdates ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">TableRows</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;DROP INDEX &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; ON &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">QUOTENAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Drop Index Statement&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_index_usage_stats</span><span style="color:#E1E4E8;"> diu</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                                    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objects</span><span style="color:#E1E4E8;"> o </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schemas</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schema_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">schema_id</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SUM</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">rows</span><span style="color:#E1E4E8;">) TableRows ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                     </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">partitions</span><span style="color:#E1E4E8;"> p</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                     </span><span style="color:#F97583;">GROUP BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                   ) p </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                          </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">OBJECTPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;IsUserTable&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_ID</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_primary_key</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">--排除主键索引</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">is_unique_constraint</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">         </span><span style="color:#6A737D;">--排除唯一索引</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_updates</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">              </span><span style="color:#6A737D;">--排除没有数据变化的索引</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_lookups</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_seeks</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_scans</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">i</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS NOT NULL</span><span style="color:#E1E4E8;">                 </span><span style="color:#6A737D;">--排除那些没有任何索引的堆表</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> ( </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_seeks</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_scans</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_lookups</span><span style="color:#E1E4E8;"> ) </span><span style="color:#F97583;">ASC</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">diu</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">user_updates</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> DB_NAME</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_id</span><span style="color:#24292E;">)                  </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> DatabaseName ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">)            </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> TableName    ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;">                                </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> IndexID   ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">                                    </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> IndexName        ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_unique</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;UNIQUE INDEX&#39;</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;NOT UNIQUE INDEX&#39;</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> IS_UNIQUE,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_disabled</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;DISABLE&#39;</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ENABLE&#39;</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> IndexStatus,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">create_date</span><span style="color:#24292E;">                             </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> IndexCreated,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">STATS_DATE</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;">)        </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> StatisticsUpdateDate,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_seeks</span><span style="color:#24292E;">                            </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> UserSeek ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_scans</span><span style="color:#24292E;">                            </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> UserScans ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_lookups</span><span style="color:#24292E;">                          </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> UserLookups ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_updates</span><span style="color:#24292E;">                          </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> UserUpdates ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">TableRows</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;DROP INDEX &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">) </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; ON &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;.&#39;</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">QUOTENAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Drop Index Statement&#39;</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_index_usage_stats</span><span style="color:#24292E;"> diu</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                                    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objects</span><span style="color:#24292E;"> o </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schemas</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schema_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">schema_id</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SUM</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">rows</span><span style="color:#24292E;">) TableRows ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                     </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">partitions</span><span style="color:#24292E;"> p</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                     </span><span style="color:#D73A49;">GROUP BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                   ) p </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                          </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">OBJECTPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;IsUserTable&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_ID</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_primary_key</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">        </span><span style="color:#6A737D;">--排除主键索引</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">is_unique_constraint</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">         </span><span style="color:#6A737D;">--排除唯一索引</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_updates</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">              </span><span style="color:#6A737D;">--排除没有数据变化的索引</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_lookups</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_seeks</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_scans</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">i</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS NOT NULL</span><span style="color:#24292E;">                 </span><span style="color:#6A737D;">--排除那些没有任何索引的堆表</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> ( </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_seeks</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_scans</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_lookups</span><span style="color:#24292E;"> ) </span><span style="color:#D73A49;">ASC</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">diu</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">user_updates</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">;</span></span></code></pre></div><h3 id="查询表下索引使用情况" tabindex="-1">查询表下索引使用情况 <a class="header-anchor" href="#查询表下索引使用情况" aria-label="Permalink to &quot;查询表下索引使用情况&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">db_name</span><span style="color:#E1E4E8;">(database_id) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;数据库名称&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">object_name</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;表名&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;索引名称&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">       user_seeks </span><span style="color:#9ECBFF;">N&#39;用户索引查找次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">       user_scans </span><span style="color:#9ECBFF;">N&#39;用户索引扫描次数&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">max</span><span style="color:#E1E4E8;">(last_user_seek) </span><span style="color:#9ECBFF;">N&#39;最后查找时间&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">max</span><span style="color:#E1E4E8;">(last_user_scan) </span><span style="color:#9ECBFF;">N&#39;最后扫描时间&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">max</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">rows</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;表中的行数&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_db_index_usage_stats</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">join</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">indexes</span><span style="color:#E1E4E8;"> b</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">index_id</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">join</span><span style="color:#E1E4E8;"> sysindexes c</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">c</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> database_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">db_id</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;数据库名称&#39;</span><span style="color:#E1E4E8;">)   </span><span style="color:#6A737D;">--指定数据库</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">object_name</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">like</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;sys%&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">object_name</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">like</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;表名&#39;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--指定索引表</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">is not null</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#6A737D;">--and b.name like &#39;索引名&#39; --指定索引名称 可以先使用 sp_help &#39;你的表名&#39; 查看表的结构和所有的索引信息</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">group by</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">db_name</span><span style="color:#E1E4E8;">(database_id) ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">object_name</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">       user_seeks ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">       user_scans </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> user_seeks,user_scans,</span><span style="color:#79B8FF;">object_name</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">object_id</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">db_name</span><span style="color:#24292E;">(database_id) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;数据库名称&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#005CC5;">object_name</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;表名&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;索引名称&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">       user_seeks </span><span style="color:#032F62;">N&#39;用户索引查找次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">       user_scans </span><span style="color:#032F62;">N&#39;用户索引扫描次数&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#005CC5;">max</span><span style="color:#24292E;">(last_user_seek) </span><span style="color:#032F62;">N&#39;最后查找时间&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#005CC5;">max</span><span style="color:#24292E;">(last_user_scan) </span><span style="color:#032F62;">N&#39;最后扫描时间&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#005CC5;">max</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">rows</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;表中的行数&#39;</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_db_index_usage_stats</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">join</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">indexes</span><span style="color:#24292E;"> b</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">index_id</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">join</span><span style="color:#24292E;"> sysindexes c</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">c</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">where</span><span style="color:#24292E;"> database_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">db_id</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;数据库名称&#39;</span><span style="color:#24292E;">)   </span><span style="color:#6A737D;">--指定数据库</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">object_name</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">like</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;sys%&#39;</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">object_name</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">like</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;表名&#39;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">--指定索引表</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">is not null</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#6A737D;">--and b.name like &#39;索引名&#39; --指定索引名称 可以先使用 sp_help &#39;你的表名&#39; 查看表的结构和所有的索引信息</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">group by</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">db_name</span><span style="color:#24292E;">(database_id) ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#005CC5;">object_name</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">       user_seeks ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">       user_scans </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> user_seeks,user_scans,</span><span style="color:#005CC5;">object_name</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">object_id</span><span style="color:#24292E;">)</span></span></code></pre></div><h3 id="针对所有库清理碎片" tabindex="-1">针对所有库清理碎片 <a class="header-anchor" href="#针对所有库清理碎片" aria-label="Permalink to &quot;针对所有库清理碎片&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @Database </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">)   </span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @Table </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">)  </span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @cmd </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">500</span><span style="color:#E1E4E8;">)  </span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @fillfactor </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @fillfactor </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">90</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> DatabaseCursor </span><span style="color:#F97583;">CURSOR</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">master</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sysdatabases   </span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;master&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;msdb&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;tempdb&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;model&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;distribution&#39;</span><span style="color:#E1E4E8;">)   </span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">OPEN</span><span style="color:#E1E4E8;"> DatabaseCursor  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">FETCH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NEXT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> DatabaseCursor </span><span style="color:#F97583;">INTO</span><span style="color:#E1E4E8;"> @Database  </span></span>
<span class="line"><span style="color:#F97583;">WHILE</span><span style="color:#E1E4E8;"> @@FETCH_STATUS </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @cmd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;DECLARE TableCursor CURSOR FOR SELECT &#39;&#39;[&#39;&#39; + table_catalog + &#39;&#39;].[&#39;&#39; + table_schema + &#39;&#39;].[&#39;&#39; + </span></span>
<span class="line"><span style="color:#9ECBFF;">  table_name + &#39;&#39;]&#39;&#39; as tableName FROM [&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @Database </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;].INFORMATION_SCHEMA.TABLES </span></span>
<span class="line"><span style="color:#9ECBFF;">  WHERE table_type = &#39;&#39;BASE TABLE&#39;&#39;&#39;</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">-- create table cursor  </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> (@cmd)  </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">OPEN</span><span style="color:#E1E4E8;"> TableCursor   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">FETCH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NEXT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> TableCursor </span><span style="color:#F97583;">INTO</span><span style="color:#E1E4E8;"> @Table   </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">WHILE</span><span style="color:#E1E4E8;"> @@FETCH_STATUS </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@MICROSOFTVERSION </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">POWER</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">24</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">9</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#6A737D;">-- SQL 2005 or higher command </span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @cmd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ALTER INDEX ALL ON &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @Table </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; REBUILD WITH (FILLFACTOR = &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">),@fillfactor) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;)&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> (@cmd) </span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">ELSE</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#6A737D;">-- SQL 2000 command </span></span>
<span class="line"><span style="color:#E1E4E8;">          DBCC DBREINDEX(@Table,</span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;">,@fillfactor)  </span></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">FETCH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NEXT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> TableCursor </span><span style="color:#F97583;">INTO</span><span style="color:#E1E4E8;"> @Table   </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">CLOSE</span><span style="color:#E1E4E8;"> TableCursor   </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">DEALLOCATE</span><span style="color:#E1E4E8;"> TableCursor  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">FETCH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NEXT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> DatabaseCursor </span><span style="color:#F97583;">INTO</span><span style="color:#E1E4E8;"> @Database  </span></span>
<span class="line"><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">CLOSE</span><span style="color:#E1E4E8;"> DatabaseCursor   </span></span>
<span class="line"><span style="color:#F97583;">DEALLOCATE</span><span style="color:#E1E4E8;"> DatabaseCursor</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @Database </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">255</span><span style="color:#24292E;">)   </span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @Table </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">255</span><span style="color:#24292E;">)  </span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @cmd </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">500</span><span style="color:#24292E;">)  </span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @fillfactor </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @fillfactor </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">90</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> DatabaseCursor </span><span style="color:#D73A49;">CURSOR</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">master</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sysdatabases   </span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;master&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;msdb&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;tempdb&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;model&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;distribution&#39;</span><span style="color:#24292E;">)   </span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">OPEN</span><span style="color:#24292E;"> DatabaseCursor  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">FETCH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NEXT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> DatabaseCursor </span><span style="color:#D73A49;">INTO</span><span style="color:#24292E;"> @Database  </span></span>
<span class="line"><span style="color:#D73A49;">WHILE</span><span style="color:#24292E;"> @@FETCH_STATUS </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;">  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @cmd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;DECLARE TableCursor CURSOR FOR SELECT &#39;&#39;[&#39;&#39; + table_catalog + &#39;&#39;].[&#39;&#39; + table_schema + &#39;&#39;].[&#39;&#39; + </span></span>
<span class="line"><span style="color:#032F62;">  table_name + &#39;&#39;]&#39;&#39; as tableName FROM [&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @Database </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;].INFORMATION_SCHEMA.TABLES </span></span>
<span class="line"><span style="color:#032F62;">  WHERE table_type = &#39;&#39;BASE TABLE&#39;&#39;&#39;</span><span style="color:#24292E;">   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6A737D;">-- create table cursor  </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> (@cmd)  </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">OPEN</span><span style="color:#24292E;"> TableCursor   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">FETCH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NEXT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> TableCursor </span><span style="color:#D73A49;">INTO</span><span style="color:#24292E;"> @Table   </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">WHILE</span><span style="color:#24292E;"> @@FETCH_STATUS </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;">   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@MICROSOFTVERSION </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">POWER</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">24</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#6A737D;">-- SQL 2005 or higher command </span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @cmd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ALTER INDEX ALL ON &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @Table </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; REBUILD WITH (FILLFACTOR = &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">),@fillfactor) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;)&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> (@cmd) </span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">ELSE</span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6A737D;">-- SQL 2000 command </span></span>
<span class="line"><span style="color:#24292E;">          DBCC DBREINDEX(@Table,</span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;">,@fillfactor)  </span></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       </span><span style="color:#D73A49;">FETCH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NEXT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> TableCursor </span><span style="color:#D73A49;">INTO</span><span style="color:#24292E;"> @Table   </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">   </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">CLOSE</span><span style="color:#24292E;"> TableCursor   </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">DEALLOCATE</span><span style="color:#24292E;"> TableCursor  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">FETCH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NEXT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> DatabaseCursor </span><span style="color:#D73A49;">INTO</span><span style="color:#24292E;"> @Database  </span></span>
<span class="line"><span style="color:#D73A49;">END</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">CLOSE</span><span style="color:#24292E;"> DatabaseCursor   </span></span>
<span class="line"><span style="color:#D73A49;">DEALLOCATE</span><span style="color:#24292E;"> DatabaseCursor</span></span></code></pre></div><h2 id="_5-查看死锁" tabindex="-1">5.查看死锁 <a class="header-anchor" href="#_5-查看死锁" aria-label="Permalink to &quot;5.查看死锁&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @SessionName </span><span style="color:#F97583;">SysName</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @SessionName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;system_health&#39;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;tempdb..#Events&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">IS NOT NULL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">DROP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> #Events</span></span>
<span class="line"><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @Target_File </span><span style="color:#F97583;">NVarChar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    , @Target_Dir </span><span style="color:#F97583;">NVarChar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    , @Target_File_WildCard </span><span style="color:#F97583;">NVarChar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @Target_File </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">target_data</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;">).</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;EventFileTarget[1]/File[1]/@name&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;NVARCHAR(256)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_xe_session_targets</span><span style="color:#E1E4E8;"> t</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_xe_sessions</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">address</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">event_session_address</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">s</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @SessionName</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">target_name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;event_file&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @Target_Dir </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">LEFT</span><span style="color:#E1E4E8;">(@Target_File, </span><span style="color:#79B8FF;">Len</span><span style="color:#E1E4E8;">(@Target_File) </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CHARINDEX</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;\\&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">REVERSE</span><span style="color:#E1E4E8;">(@Target_File))) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @Target_File_WildCard </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @Target_Dir </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;\\&#39;</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @SessionName </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;_*.xel&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--Keep this as a separate table because it&#39;s called twice in the next query.  You don&#39;t want this running twice.</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> DeadlockGraph </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(event_data </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    , DeadlockID </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Row_Number</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">OVER</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> file_name, file_offset)</span></span>
<span class="line"><span style="color:#F97583;">INTO</span><span style="color:#E1E4E8;"> #Events</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fn_xe_file_target_read_file</span><span style="color:#E1E4E8;">(@Target_File_WildCard, </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> F</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> event_data </span><span style="color:#F97583;">like</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;event name=&quot;xml_deadlock_report%&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">;</span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> Victims </span><span style="color:#F97583;">AS</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> VictimID </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Victims</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@id&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(50)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockID</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> #Events e</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockGraph</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nodes</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/event/data/value/deadlock/victim-list/victimProcess&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> Deadlock(Victims)</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">, DeadlockObjects </span><span style="color:#F97583;">AS</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT DISTINCT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockID</span></span>
<span class="line"><span style="color:#E1E4E8;">        , ObjectName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Resources</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@objectname&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;nvarchar(256)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> #Events e</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockGraph</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nodes</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/event/data/value/deadlock/resource-list/*&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> Deadlock(Resources)</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#F97583;">FROM</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockID</span></span>
<span class="line"><span style="color:#E1E4E8;">        , TransactionTime </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@lasttranstarted&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;datetime&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , DeadlockGraph</span></span>
<span class="line"><span style="color:#E1E4E8;">        , DeadlockObjects </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">substring</span><span style="color:#E1E4E8;">((</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;, &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">ObjectName</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> DeadlockObjects o</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockID</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">o</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">ObjectName</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">FOR</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PATH</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                            ), </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">4000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , Victim </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">v</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">VictimID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS NOT NULL</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#E1E4E8;">        , SPID </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@spid&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;int&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , ProcedureName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;executionStack[1]/frame[1]/@procname[1]&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(200)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , LockMode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@lockMode&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;char(1)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , Code </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;executionStack[1]/frame[1]&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(1000)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , ClientApp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">LEFT</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@clientapp&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(100)&#39;</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">29</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;SQLAgent - TSQL JobStep (Job &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;SQLAgent Job: &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> msdb..sysjobs sj </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">substring</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@clientapp&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(100)&#39;</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">substring</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fn_varbintohexstr</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sj</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">job_id</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">))) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; - &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@clientapp&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(100)&#39;</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">67</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@clientapp&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(100)&#39;</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">67</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@clientapp&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(100)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        , HostName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@hostname&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(20)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , LoginName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@loginname&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(20)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        , InputBuffer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;inputbuf[1]&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(1000)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> #Events e</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CROSS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockGraph</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nodes</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/event/data/value/deadlock/process-list/process&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> Deadlock(Process)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> Victims v </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">v</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">DeadlockID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">v</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">VictimID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Deadlock</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Process</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;@id&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;varchar(50)&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">) X</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> DeadlockID </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @SessionName </span><span style="color:#D73A49;">SysName</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @SessionName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;system_health&#39;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;tempdb..#Events&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">IS NOT NULL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">DROP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> #Events</span></span>
<span class="line"><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @Target_File </span><span style="color:#D73A49;">NVarChar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    , @Target_Dir </span><span style="color:#D73A49;">NVarChar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    , @Target_File_WildCard </span><span style="color:#D73A49;">NVarChar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @Target_File </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">target_data</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;">).</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;EventFileTarget[1]/File[1]/@name&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;NVARCHAR(256)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_xe_session_targets</span><span style="color:#24292E;"> t</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_xe_sessions</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">address</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">event_session_address</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">s</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @SessionName</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">target_name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;event_file&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @Target_Dir </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">LEFT</span><span style="color:#24292E;">(@Target_File, </span><span style="color:#005CC5;">Len</span><span style="color:#24292E;">(@Target_File) </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CHARINDEX</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;\\&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">REVERSE</span><span style="color:#24292E;">(@Target_File))) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @Target_File_WildCard </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @Target_Dir </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;\\&#39;</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @SessionName </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;_*.xel&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--Keep this as a separate table because it&#39;s called twice in the next query.  You don&#39;t want this running twice.</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> DeadlockGraph </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(event_data </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    , DeadlockID </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Row_Number</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">OVER</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> file_name, file_offset)</span></span>
<span class="line"><span style="color:#D73A49;">INTO</span><span style="color:#24292E;"> #Events</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fn_xe_file_target_read_file</span><span style="color:#24292E;">(@Target_File_WildCard, </span><span style="color:#D73A49;">null</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">null</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">null</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> F</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> event_data </span><span style="color:#D73A49;">like</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;event name=&quot;xml_deadlock_report%&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">;</span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> Victims </span><span style="color:#D73A49;">AS</span></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> VictimID </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Victims</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@id&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(50)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockID</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> #Events e</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockGraph</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nodes</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;/event/data/value/deadlock/victim-list/victimProcess&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> Deadlock(Victims)</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">, DeadlockObjects </span><span style="color:#D73A49;">AS</span></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT DISTINCT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockID</span></span>
<span class="line"><span style="color:#24292E;">        , ObjectName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Resources</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@objectname&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;nvarchar(256)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> #Events e</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockGraph</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nodes</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;/event/data/value/deadlock/resource-list/*&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> Deadlock(Resources)</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockID</span></span>
<span class="line"><span style="color:#24292E;">        , TransactionTime </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@lasttranstarted&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;datetime&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , DeadlockGraph</span></span>
<span class="line"><span style="color:#24292E;">        , DeadlockObjects </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">substring</span><span style="color:#24292E;">((</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;, &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">ObjectName</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> DeadlockObjects o</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockID</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">o</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">ObjectName</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">FOR</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PATH</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                            ), </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">4000</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , Victim </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">v</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">VictimID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS NOT NULL</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#24292E;">        , SPID </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@spid&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;int&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , ProcedureName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;executionStack[1]/frame[1]/@procname[1]&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(200)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , LockMode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@lockMode&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;char(1)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , Code </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;executionStack[1]/frame[1]&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(1000)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , ClientApp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">LEFT</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@clientapp&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(100)&#39;</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">29</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;SQLAgent - TSQL JobStep (Job &#39;</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;SQLAgent Job: &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> msdb..sysjobs sj </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">substring</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@clientapp&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(100)&#39;</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">32</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">32</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">substring</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fn_varbintohexstr</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sj</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">job_id</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">))) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; - &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@clientapp&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(100)&#39;</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">67</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">len</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@clientapp&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(100)&#39;</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">67</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@clientapp&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(100)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        , HostName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@hostname&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(20)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , LoginName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@loginname&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(20)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        , InputBuffer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;inputbuf[1]&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(1000)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> #Events e</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CROSS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockGraph</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nodes</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;/event/data/value/deadlock/process-list/process&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> Deadlock(Process)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> Victims v </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">v</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">DeadlockID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">v</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">VictimID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Deadlock</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Process</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;@id&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;varchar(50)&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">) X</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> DeadlockID </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><ul><li>另一个方式</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark has-diff vp-code-dark"><code><span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;">  @tab </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NAME</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">),</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> @tab </span><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;DBCC OPENTRAN WITH TABLERESULTS&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATETIME</span><span style="color:#E1E4E8;">) startDate,</span><span style="color:#79B8FF;">getdate</span><span style="color:#E1E4E8;">() currentDate</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">DATEDIFF</span><span style="color:#E1E4E8;">(s,</span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATETIME</span><span style="color:#E1E4E8;">),</span><span style="color:#79B8FF;">getdate</span><span style="color:#E1E4E8;">()) diffsecond </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> @tab </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;OLDACT_STARTTIME&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">   spid,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">         blocked,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">DB_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> DBName,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">         program_name,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">         waitresource,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">         lastwaittype,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">loginame</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">hostname</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">         a.[Text] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [TextData],</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">SUBSTRING</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">stmt_start</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">         (</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">stmt_end</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATALENGTH</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">A</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">stmt_end</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">stmt_start</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [current_cmd]</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sysprocesses</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> sp </span><span style="color:#F97583;">OUTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> A</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">  spid </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ISNUMERIC</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> @tab </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;OLDACT_SPID&#39;</span><span style="color:#E1E4E8;">) )</span></span></code></pre><pre class="shiki github-light has-diff vp-code-light"><code><span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;">  @tab </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NAME</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">),</span><span style="color:#D73A49;">value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> @tab </span><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;DBCC OPENTRAN WITH TABLERESULTS&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATETIME</span><span style="color:#24292E;">) startDate,</span><span style="color:#005CC5;">getdate</span><span style="color:#24292E;">() currentDate</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">DATEDIFF</span><span style="color:#24292E;">(s,</span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATETIME</span><span style="color:#24292E;">),</span><span style="color:#005CC5;">getdate</span><span style="color:#24292E;">()) diffsecond </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> @tab </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;OLDACT_STARTTIME&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">   spid,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">         blocked,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">DB_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> DBName,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">         program_name,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">         waitresource,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">         lastwaittype,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">loginame</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">hostname</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">         a.[Text] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [TextData],</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#005CC5;">SUBSTRING</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">stmt_start</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">         (</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">stmt_end</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATALENGTH</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">A</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">stmt_end</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">stmt_start</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [current_cmd]</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sysprocesses</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> sp </span><span style="color:#D73A49;">OUTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> A</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">  spid </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ISNUMERIC</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">value</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">end</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> @tab </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;OLDACT_SPID&#39;</span><span style="color:#24292E;">) )</span></span></code></pre></div><ul><li>创建死锁存储过程</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span></span>
<span class="line"><span style="color:#F97583;">go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">procedure</span><span style="color:#E1E4E8;"> sp_who_lock</span></span>
<span class="line"><span style="color:#F97583;">as</span></span>
<span class="line"><span style="color:#F97583;">begin</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @spid </span><span style="color:#F97583;">int</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @blk </span><span style="color:#F97583;">int</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @count </span><span style="color:#F97583;">int</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @index </span><span style="color:#F97583;">int</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @lock </span><span style="color:#F97583;">tinyint</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @lock</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> #temp_who_lock</span></span>
<span class="line"><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">  id </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">identity</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">  spid </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  blk </span><span style="color:#F97583;">int</span></span>
<span class="line"><span style="color:#E1E4E8;"> )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> @@error</span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> @@error</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">insert into</span><span style="color:#E1E4E8;"> #temp_who_lock(spid,blk)</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> ,blocked</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">master</span><span style="color:#E1E4E8;">..sysprocesses </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> blocked</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)a</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">exists</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">master</span><span style="color:#E1E4E8;">..sysprocesses </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocked</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">spid </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> blocked</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">union</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> spid,blocked </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">master</span><span style="color:#E1E4E8;">..sysprocesses </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> blocked</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> @@error</span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> @@error</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> @count</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">count</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">),@index</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> #temp_who_lock</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> @@error</span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> @@error</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> @count</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">begin</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;没有阻塞和死锁信息&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> @index</span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;">@count</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">begin</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">exists</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> #temp_who_lock a </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> id</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">@index </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">exists</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> #temp_who_lock</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> id</span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;">@index </span><span style="color:#F97583;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blk</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">spid))</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">begin</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @lock</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> @spid</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">spid,@blk</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">blk </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> #temp_who_lock </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> id</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">@index</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;引起数据库死锁的是: &#39;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(@spid </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;进程号,其执行的SQL语法如下&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;">  @spid, @blk</span></span>
<span class="line"><span style="color:#E1E4E8;">   dbcc inputbuffer(@spid)</span></span>
<span class="line"><span style="color:#E1E4E8;">   dbcc inputbuffer(@blk)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @index</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">@index</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> @lock</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">begin</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @index</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> @index</span><span style="color:#F97583;">&lt;=</span><span style="color:#E1E4E8;">@count</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">begin</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> @spid</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">spid,@blk</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">blk </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> #temp_who_lock </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> id</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">@index</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> @spid</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;引起阻塞的是:&#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">cast</span><span style="color:#E1E4E8;">(@blk </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;进程号,其执行的SQL语法如下&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;进程号SPID：&#39;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(@spid </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">))</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;被&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;进程号SPID：&#39;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(@blk </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;阻塞,其当前进程执行的SQL语法如下&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">   dbcc inputbuffer(@spid)</span></span>
<span class="line"><span style="color:#E1E4E8;">   dbcc inputbuffer(@blk)</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @index</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">@index</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">drop</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">table</span><span style="color:#E1E4E8;"> #temp_who_lock</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span></span>
<span class="line"><span style="color:#D73A49;">go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">procedure</span><span style="color:#24292E;"> sp_who_lock</span></span>
<span class="line"><span style="color:#D73A49;">as</span></span>
<span class="line"><span style="color:#D73A49;">begin</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @spid </span><span style="color:#D73A49;">int</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @blk </span><span style="color:#D73A49;">int</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @count </span><span style="color:#D73A49;">int</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @index </span><span style="color:#D73A49;">int</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @lock </span><span style="color:#D73A49;">tinyint</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @lock</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> #temp_who_lock</span></span>
<span class="line"><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">  id </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">identity</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">  spid </span><span style="color:#D73A49;">int</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  blk </span><span style="color:#D73A49;">int</span></span>
<span class="line"><span style="color:#24292E;"> )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> @@error</span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> @@error</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">insert into</span><span style="color:#24292E;"> #temp_who_lock(spid,blk)</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> ,blocked</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">master</span><span style="color:#24292E;">..sysprocesses </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> blocked</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)a</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">exists</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">master</span><span style="color:#24292E;">..sysprocesses </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocked</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">spid </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> blocked</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">union</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> spid,blocked </span><span style="color:#D73A49;">from</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">master</span><span style="color:#24292E;">..sysprocesses </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> blocked</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> @@error</span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> @@error</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> @count</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">count</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">),@index</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> #temp_who_lock</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> @@error</span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> @@error</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> @count</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">begin</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;没有阻塞和死锁信息&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> @index</span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;">@count</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">begin</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">exists</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> #temp_who_lock a </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> id</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">@index </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">exists</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> #temp_who_lock</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> id</span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;">@index </span><span style="color:#D73A49;">and</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blk</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">spid))</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">begin</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @lock</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> @spid</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">spid,@blk</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">blk </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> #temp_who_lock </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> id</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">@index</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;引起数据库死锁的是: &#39;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(@spid </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;进程号,其执行的SQL语法如下&#39;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">select</span><span style="color:#24292E;">  @spid, @blk</span></span>
<span class="line"><span style="color:#24292E;">   dbcc inputbuffer(@spid)</span></span>
<span class="line"><span style="color:#24292E;">   dbcc inputbuffer(@blk)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @index</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">@index</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> @lock</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">begin</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @index</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> @index</span><span style="color:#D73A49;">&lt;=</span><span style="color:#24292E;">@count</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">begin</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> @spid</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">spid,@blk</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">blk </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> #temp_who_lock </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> id</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">@index</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> @spid</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;引起阻塞的是:&#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">cast</span><span style="color:#24292E;">(@blk </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;进程号,其执行的SQL语法如下&#39;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;进程号SPID：&#39;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(@spid </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">))</span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;被&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;进程号SPID：&#39;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(@blk </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">           </span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;阻塞,其当前进程执行的SQL语法如下&#39;</span></span>
<span class="line"><span style="color:#24292E;">   dbcc inputbuffer(@spid)</span></span>
<span class="line"><span style="color:#24292E;">   dbcc inputbuffer(@blk)</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @index</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">@index</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">drop</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">table</span><span style="color:#24292E;"> #temp_who_lock</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><h2 id="_6-查询逻辑读取最高的sql" tabindex="-1">6.查询逻辑读取最高的sql <a class="header-anchor" href="#_6-查询逻辑读取最高的sql" aria-label="Permalink to &quot;6.查询逻辑读取最高的sql&quot;">​</a></h2><p>超过10w，则需要是否优化了</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> ( </span><span style="color:#79B8FF;">25</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">P</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [SP Name] ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">Deps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_logical_reads</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [TotalLogicalReads] ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">deps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_logical_reads</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">deps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_count</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [AvgLogicalReads] ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">deps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_count</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">ISNULL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">deps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_count</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEDIFF</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">SECOND</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">deps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">cached_time</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                                               </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()), </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [Calls/Second] ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">deps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_elapsed_time</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">deps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_elapsed_time</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">deps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_count</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [avg_elapsed_time] ,</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">deps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">cached_time</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">procedures</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> p</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_procedure_stats</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> deps </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> p.[Object_id] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> deps.[Object_id]</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">deps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">Database_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_ID</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">deps</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_logical_reads</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DESC</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> ( </span><span style="color:#005CC5;">25</span><span style="color:#24292E;"> )</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">P</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [SP Name] ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">Deps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_logical_reads</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [TotalLogicalReads] ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">deps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_logical_reads</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">deps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_count</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [AvgLogicalReads] ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">deps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_count</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">ISNULL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">deps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_count</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEDIFF</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">SECOND</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">deps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">cached_time</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                                               </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()), </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [Calls/Second] ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">deps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_elapsed_time</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">deps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_elapsed_time</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">deps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_count</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [avg_elapsed_time] ,</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">deps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">cached_time</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">procedures</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> p</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_procedure_stats</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> deps </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> p.[Object_id] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> deps.[Object_id]</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">deps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">Database_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_ID</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">deps</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_logical_reads</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DESC</span></span></code></pre></div><h2 id="_7-查询表结构" tabindex="-1">7.查询表结构 <a class="header-anchor" href="#_7-查询表结构" aria-label="Permalink to &quot;7.查询表结构&quot;">​</a></h2><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> db_name</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  表名 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">colorder</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span></span>
<span class="line"><span style="color:#E1E4E8;">                          </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                     </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                表说明 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">colorder</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ISNULL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">f</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">value</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                           </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                      </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                字段序号 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">colorder</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                字段名 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                标识 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">COLUMNPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;IsIdentity&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">                          </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;√&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                          </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                     </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                主键 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">EXISTS</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">                                        </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    sysobjects</span></span>
<span class="line"><span style="color:#E1E4E8;">                                        </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   xtype </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;PK&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> parent_obj </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">name</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    sysindexes</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   indid </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                        </span><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              indid</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                        </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">  sysindexkeys</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                        </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> colid </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">colid</span><span style="color:#E1E4E8;"> ) ) )</span></span>
<span class="line"><span style="color:#E1E4E8;">                          </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;√&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                          </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                     </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                类型 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                占用字节数 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                长度 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">COLUMNPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;PRECISION&#39;</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                小数位数 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ISNULL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">COLUMNPROPERTY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;Scale&#39;</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                允许空 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">isnullable</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;√&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                           </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                      </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                默认值 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ISNULL</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                字段说明 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ISNULL</span><span style="color:#E1E4E8;">(g.[value], </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    syscolumns a</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> systypes b </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xusertype</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">b</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xusertype</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">INNER JOIN</span><span style="color:#E1E4E8;"> sysobjects d </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span></span>
<span class="line"><span style="color:#E1E4E8;">                                           </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xtype</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;U&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                           </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;dtproperties&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> syscomments e </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">cdefault</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">e</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">extended_properties</span><span style="color:#E1E4E8;"> g </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">G</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">major_id</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                       </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">colid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">g</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">minor_id</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">extended_properties</span><span style="color:#E1E4E8;"> f </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">f</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">major_id</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                       </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">f</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">minor_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">d</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;tablename&#39;</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">--如果只查询指定表,加上此红色where条件，tablename是要查询的表名；去除红色where条件查询说有的表信息</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">id</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">a</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">colorder</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">use</span><span style="color:#24292E;"> db_name</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  表名 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">colorder</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span></span>
<span class="line"><span style="color:#24292E;">                          </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292E;">                     </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                表说明 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">colorder</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ISNULL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">f</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">value</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                           </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292E;">                      </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                字段序号 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">colorder</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                字段名 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                标识 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">COLUMNPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;IsIdentity&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">                          </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;√&#39;</span></span>
<span class="line"><span style="color:#24292E;">                          </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292E;">                     </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                主键 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">EXISTS</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">                                        </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    sysobjects</span></span>
<span class="line"><span style="color:#24292E;">                                        </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   xtype </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;PK&#39;</span></span>
<span class="line"><span style="color:#24292E;">                                                </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> parent_obj </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span></span>
<span class="line"><span style="color:#24292E;">                                                </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">                                                </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">name</span></span>
<span class="line"><span style="color:#24292E;">                                                </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    sysindexes</span></span>
<span class="line"><span style="color:#24292E;">                                                </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   indid </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">                                                        </span><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">                                                              indid</span></span>
<span class="line"><span style="color:#24292E;">                                                        </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">  sysindexkeys</span></span>
<span class="line"><span style="color:#24292E;">                                                        </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> colid </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">colid</span><span style="color:#24292E;"> ) ) )</span></span>
<span class="line"><span style="color:#24292E;">                          </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;√&#39;</span></span>
<span class="line"><span style="color:#24292E;">                          </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292E;">                     </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                类型 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                占用字节数 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">length</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                长度 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">COLUMNPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;PRECISION&#39;</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                小数位数 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ISNULL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">COLUMNPROPERTY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;Scale&#39;</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                允许空 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">isnullable</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;√&#39;</span></span>
<span class="line"><span style="color:#24292E;">                           </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292E;">                      </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                默认值 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ISNULL</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                字段说明 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ISNULL</span><span style="color:#24292E;">(g.[value], </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    syscolumns a</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> systypes b </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xusertype</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">b</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xusertype</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">INNER JOIN</span><span style="color:#24292E;"> sysobjects d </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span></span>
<span class="line"><span style="color:#24292E;">                                           </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xtype</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;U&#39;</span></span>
<span class="line"><span style="color:#24292E;">                                           </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;dtproperties&#39;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> syscomments e </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">cdefault</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">e</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">extended_properties</span><span style="color:#24292E;"> g </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">G</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">major_id</span></span>
<span class="line"><span style="color:#24292E;">                                                       </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">colid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">g</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">minor_id</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">extended_properties</span><span style="color:#24292E;"> f </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">f</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">major_id</span></span>
<span class="line"><span style="color:#24292E;">                                                       </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">f</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">minor_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">d</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;tablename&#39;</span><span style="color:#24292E;">    </span><span style="color:#6A737D;">--如果只查询指定表,加上此红色where条件，tablename是要查询的表名；去除红色where条件查询说有的表信息</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">id</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">a</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">colorder</span></span></code></pre></div>`,36),e=[o];function c(t,E,r,y,F,i){return n(),a("div",null,e)}const D=s(p,[["render",c]]);export{A as __pageData,D as default};
