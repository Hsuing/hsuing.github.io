import{_ as s,o as n,c as a,R as l}from"./chunks/framework.zUbWieqp.js";const D=JSON.parse('{"title":"1. QQ邮箱","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/SqlServer/8-mail.md","filePath":"guide/Database/SqlServer/8-mail.md","lastUpdated":1728701754000}'),p={name:"guide/Database/SqlServer/8-mail.md"},o=l(`<h1 id="_1-qq邮箱" tabindex="-1">1. QQ邮箱 <a class="header-anchor" href="#_1-qq邮箱" aria-label="Permalink to &quot;1. QQ邮箱&quot;">​</a></h1><h2 id="_1-1-进入qq邮箱点击设置" tabindex="-1">1.1 进入QQ邮箱点击设置 <a class="header-anchor" href="#_1-1-进入qq邮箱点击设置" aria-label="Permalink to &quot;1.1 进入QQ邮箱点击设置&quot;">​</a></h2><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410112052627.png" alt="image-20241011205229278"></p><p><strong>开启 POP3/SMTP服务和IMAP/SMTP服务</strong></p><p><code>开启服务后会生产授权码的，这个授权码要记下来，下面会用到</code></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410112053086.png" alt="image-20241011205347458"></p><h2 id="_1-2-sql配置" tabindex="-1">1.2 SQL配置 <a class="header-anchor" href="#_1-2-sql配置" aria-label="Permalink to &quot;1.2 SQL配置&quot;">​</a></h2><h3 id="_1-2-1-启用sql-server-邮件的功能" tabindex="-1">1.2.1 启用sql server 邮件的功能 <a class="header-anchor" href="#_1-2-1-启用sql-server-邮件的功能" aria-label="Permalink to &quot;1.2.1 启用sql server 邮件的功能&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 启用 sql server 邮件的功能</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_configure </span><span style="color:#9ECBFF;">&#39;show advanced options&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#F97583;">RECONFIGURE</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sp_configure </span><span style="color:#9ECBFF;">&#39;Database Mail XPs&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#F97583;">RECONFIGURE</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 启用 sql server 邮件的功能</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_configure </span><span style="color:#032F62;">&#39;show advanced options&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#D73A49;">RECONFIGURE</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sp_configure </span><span style="color:#032F62;">&#39;Database Mail XPs&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#D73A49;">RECONFIGURE</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><h3 id="_1-2-2-查看数据库邮件功能是否开启" tabindex="-1">1.2.2 查看数据库邮件功能是否开启 <a class="header-anchor" href="#_1-2-2-查看数据库邮件功能是否开启" aria-label="Permalink to &quot;1.2.2 查看数据库邮件功能是否开启&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 查询数据库的配置信息</span></span>
<span class="line"><span style="color:#6A737D;">--SELECT  *　FROM    sys.configurations;</span></span>
<span class="line"><span style="color:#6A737D;">-- 查看数据库邮件功能是否开启，value 值为1表示已开启，0为未开启</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">description</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        is_dynamic ,</span></span>
<span class="line"><span style="color:#E1E4E8;">        is_advanced</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">configurations</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LIKE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;%mail%&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看邮件服务器状态</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sysmail_help_status_sp;</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sysmail_mailitems</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sysmail_faileditems</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 查询数据库的配置信息</span></span>
<span class="line"><span style="color:#6A737D;">--SELECT  *　FROM    sys.configurations;</span></span>
<span class="line"><span style="color:#6A737D;">-- 查看数据库邮件功能是否开启，value 值为1表示已开启，0为未开启</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">value</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">description</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">        is_dynamic ,</span></span>
<span class="line"><span style="color:#24292E;">        is_advanced</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">configurations</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LIKE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;%mail%&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">-- 查看邮件服务器状态</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sysmail_help_status_sp;</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sysmail_mailitems</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sysmail_faileditems</span></span></code></pre></div><h3 id="_1-2-3-创建邮件账户" tabindex="-1">1.2.3 创建邮件账户 <a class="header-anchor" href="#_1-2-3-创建邮件账户" aria-label="Permalink to &quot;1.2.3 创建邮件账户&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--创建邮件账户</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">exists</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> msdb..sysmail_account </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NAME=</span><span style="color:#9ECBFF;">&#39;ITEPI_EOMS&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">--判断邮件账户名为 ITEPI_EOMS 的账户是否存在</span></span>
<span class="line"><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> msdb..sysmail_delete_account_sp @account_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;ITEPI_EOMS&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- 删除邮件账户名为 ITEPI_EOMS 的账户</span></span>
<span class="line"><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> msdb..sysmail_add_account_sp  </span><span style="color:#6A737D;">--创建邮件账户</span></span>
<span class="line"><span style="color:#E1E4E8;">    @account_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ITEPI_EOMS&#39;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">-- 邮件帐户名称</span></span>
<span class="line"><span style="color:#E1E4E8;">    @email_address </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;xxx&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">-- 发件人邮件地址 </span></span>
<span class="line"><span style="color:#E1E4E8;">    @display_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ITEPI_EOMS&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">-- 发件人姓名 </span></span>
<span class="line"><span style="color:#E1E4E8;">    @replyto_address </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">-- 回复地址</span></span>
<span class="line"><span style="color:#E1E4E8;">    @description </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">-- 邮件账户描述</span></span>
<span class="line"><span style="color:#E1E4E8;">    @mailserver_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;smtp.qq.com&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">-- 邮件服务器地址 </span></span>
<span class="line"><span style="color:#E1E4E8;">    @mailserver_type </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;SMTP&#39;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">-- 邮件协议</span></span>
<span class="line"><span style="color:#E1E4E8;">    @port </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">587</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">-- 邮件服务器端口（或是456）</span></span>
<span class="line"><span style="color:#E1E4E8;">    @username </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;xxx&#39;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">-- 用户名</span></span>
<span class="line"><span style="color:#E1E4E8;">    @password </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;xxx&#39;</span><span style="color:#E1E4E8;">,   </span><span style="color:#6A737D;">-- 密码（第三方用QQ密码是登录不了的）</span></span>
<span class="line"><span style="color:#E1E4E8;">    @use_default_credentials </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">-- 是否使用默认凭证，0为否，1为是</span></span>
<span class="line"><span style="color:#E1E4E8;">    @enable_ssl </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">-- 是否启用 ssl 加密，0为否，1为是（QQ邮箱这里必须为 1）</span></span>
<span class="line"><span style="color:#E1E4E8;">    @account_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">null</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">-- 输出参数，返回创建的邮件账户的ID</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--创建邮件账户</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">exists</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> msdb..sysmail_account </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NAME=</span><span style="color:#032F62;">&#39;ITEPI_EOMS&#39;</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">--判断邮件账户名为 ITEPI_EOMS 的账户是否存在</span></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> msdb..sysmail_delete_account_sp @account_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;ITEPI_EOMS&#39;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- 删除邮件账户名为 ITEPI_EOMS 的账户</span></span>
<span class="line"><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> msdb..sysmail_add_account_sp  </span><span style="color:#6A737D;">--创建邮件账户</span></span>
<span class="line"><span style="color:#24292E;">    @account_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ITEPI_EOMS&#39;</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;">-- 邮件帐户名称</span></span>
<span class="line"><span style="color:#24292E;">    @email_address </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;xxx&#39;</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">-- 发件人邮件地址 </span></span>
<span class="line"><span style="color:#24292E;">    @display_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ITEPI_EOMS&#39;</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">-- 发件人姓名 </span></span>
<span class="line"><span style="color:#24292E;">    @replyto_address </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;">-- 回复地址</span></span>
<span class="line"><span style="color:#24292E;">    @description </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">-- 邮件账户描述</span></span>
<span class="line"><span style="color:#24292E;">    @mailserver_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;smtp.qq.com&#39;</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">-- 邮件服务器地址 </span></span>
<span class="line"><span style="color:#24292E;">    @mailserver_type </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;SMTP&#39;</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;">-- 邮件协议</span></span>
<span class="line"><span style="color:#24292E;">    @port </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">587</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;">-- 邮件服务器端口（或是456）</span></span>
<span class="line"><span style="color:#24292E;">    @username </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;xxx&#39;</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;">-- 用户名</span></span>
<span class="line"><span style="color:#24292E;">    @password </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;xxx&#39;</span><span style="color:#24292E;">,   </span><span style="color:#6A737D;">-- 密码（第三方用QQ密码是登录不了的）</span></span>
<span class="line"><span style="color:#24292E;">    @use_default_credentials </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">-- 是否使用默认凭证，0为否，1为是</span></span>
<span class="line"><span style="color:#24292E;">    @enable_ssl </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">-- 是否启用 ssl 加密，0为否，1为是（QQ邮箱这里必须为 1）</span></span>
<span class="line"><span style="color:#24292E;">    @account_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">null</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">-- 输出参数，返回创建的邮件账户的ID</span></span></code></pre></div><h3 id="_1-2-4-生成邮件配置文件" tabindex="-1">1.2.4 生成邮件配置文件 <a class="header-anchor" href="#_1-2-4-生成邮件配置文件" aria-label="Permalink to &quot;1.2.4 生成邮件配置文件&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--生成邮件配置文件</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">exists</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> msdb..sysmail_profile </span><span style="color:#F97583;">where</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NAME</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;SendEmailProfile&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">--判断名为 SendEmailProfile 的邮件配置文件是否存在</span></span>
<span class="line"><span style="color:#F97583;">begin</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> msdb..sysmail_delete_profile_sp @profile_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;SendEmailProfile&#39;</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--删除名为 SendEmailProfile 的邮件配置文件</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> msdb..sysmail_add_profile_sp    </span><span style="color:#6A737D;">-- 添加邮件配置文件</span></span>
<span class="line"><span style="color:#E1E4E8;">     @profile_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;SendEmailProfile&#39;</span><span style="color:#E1E4E8;">,   </span><span style="color:#6A737D;">-- 配置文件名称    </span></span>
<span class="line"><span style="color:#E1E4E8;">     @description </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;数据库发送邮件配置文件&#39;</span><span style="color:#E1E4E8;">,    </span><span style="color:#6A737D;">-- 配置文件描述      </span></span>
<span class="line"><span style="color:#E1E4E8;">     @profile_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NULL</span><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">-- 输出参数，返回创建的邮件配置文件的ID</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--生成邮件配置文件</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">exists</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> msdb..sysmail_profile </span><span style="color:#D73A49;">where</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NAME</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;SendEmailProfile&#39;</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">--判断名为 SendEmailProfile 的邮件配置文件是否存在</span></span>
<span class="line"><span style="color:#D73A49;">begin</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> msdb..sysmail_delete_profile_sp @profile_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;SendEmailProfile&#39;</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">--删除名为 SendEmailProfile 的邮件配置文件</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> msdb..sysmail_add_profile_sp    </span><span style="color:#6A737D;">-- 添加邮件配置文件</span></span>
<span class="line"><span style="color:#24292E;">     @profile_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;SendEmailProfile&#39;</span><span style="color:#24292E;">,   </span><span style="color:#6A737D;">-- 配置文件名称    </span></span>
<span class="line"><span style="color:#24292E;">     @description </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;数据库发送邮件配置文件&#39;</span><span style="color:#24292E;">,    </span><span style="color:#6A737D;">-- 配置文件描述      </span></span>
<span class="line"><span style="color:#24292E;">     @profile_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NULL</span><span style="color:#24292E;">        </span><span style="color:#6A737D;">-- 输出参数，返回创建的邮件配置文件的ID</span></span></code></pre></div><h3 id="_1-2-5-邮件账户和邮件配置文件相关联" tabindex="-1">1.2.5 邮件账户和邮件配置文件相关联 <a class="header-anchor" href="#_1-2-5-邮件账户和邮件配置文件相关联" aria-label="Permalink to &quot;1.2.5 邮件账户和邮件配置文件相关联&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- 邮件账户和邮件配置文件相关联  </span></span>
<span class="line"><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> msdb..sysmail_add_profileaccount_sp   </span></span>
<span class="line"><span style="color:#E1E4E8;">     @profile_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;SendEmailProfile&#39;</span><span style="color:#E1E4E8;">,   </span><span style="color:#6A737D;">-- 邮件配置文件名称     </span></span>
<span class="line"><span style="color:#E1E4E8;">     @account_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ITEPI_EOMS&#39;</span><span style="color:#E1E4E8;">,    </span><span style="color:#6A737D;">-- 邮件账户名称       </span></span>
<span class="line"><span style="color:#E1E4E8;">     @sequence_number </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- account 在 profile 中的顺序，一个配置文件可以有多个不同的邮件账户</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- 邮件账户和邮件配置文件相关联  </span></span>
<span class="line"><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> msdb..sysmail_add_profileaccount_sp   </span></span>
<span class="line"><span style="color:#24292E;">     @profile_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;SendEmailProfile&#39;</span><span style="color:#24292E;">,   </span><span style="color:#6A737D;">-- 邮件配置文件名称     </span></span>
<span class="line"><span style="color:#24292E;">     @account_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ITEPI_EOMS&#39;</span><span style="color:#24292E;">,    </span><span style="color:#6A737D;">-- 邮件账户名称       </span></span>
<span class="line"><span style="color:#24292E;">     @sequence_number </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- account 在 profile 中的顺序，一个配置文件可以有多个不同的邮件账户</span></span></code></pre></div><h3 id="_1-2-6-测试数据库是否配置成功" tabindex="-1">1.2.6 测试数据库是否配置成功 <a class="header-anchor" href="#_1-2-6-测试数据库是否配置成功" aria-label="Permalink to &quot;1.2.6 测试数据库是否配置成功&quot;">​</a></h3><h4 id="图形" tabindex="-1">图形 <a class="header-anchor" href="#图形" aria-label="Permalink to &quot;图形&quot;">​</a></h4><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410121055484.png" alt="image-20241011210023474"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410112101015.png" alt="image-20241011210135754"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410112102062.png" alt="image-20241011210202219"></p><ul><li>查看邮箱验证</li></ul><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410112102209.png" alt="image-20241011210254569"></p><h4 id="sql语句" tabindex="-1">sql语句 <a class="header-anchor" href="#sql语句" aria-label="Permalink to &quot;sql语句&quot;">​</a></h4><p><em><strong>*创建触发器调用发送邮件功能*</strong></em></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--删除触发器</span></span>
<span class="line"><span style="color:#6A737D;">--Drop Trigger UserAdvise_Send_Mail</span></span>
<span class="line"><span style="color:#6A737D;">--创建一个 insert 类型的 after 触发器(用户建议)</span></span>
<span class="line"><span style="color:#F97583;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">trigger</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">UserAdvise_Send_Mail</span></span>
<span class="line"><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> UserAdvise</span></span>
<span class="line"><span style="color:#F97583;">after</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">insert</span></span>
<span class="line"><span style="color:#F97583;">as</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @UserName    </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @AdviseContent   </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @Content </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">300</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @CreateTime </span><span style="color:#F97583;">datetime</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">declare</span><span style="color:#E1E4E8;"> @UserMail </span><span style="color:#F97583;">varchar</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">25</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> @Content</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">AdviseContent,@UserMail</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">UserMail </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> inserted</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">set</span><span style="color:#E1E4E8;"> @AdviseContent</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;表哥，您收到一封来自一派科技用户建议邮件，内容如下：&#39;</span><span style="color:#F97583;">+char</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">@Content</span></span>
<span class="line"><span style="color:#E1E4E8;">					  </span><span style="color:#F97583;">+char</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;该用户联系邮箱为：&#39;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">@UserMail</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_send_dbmail @profile_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;SendEmailProfile&#39;</span><span style="color:#E1E4E8;">,    </span><span style="color:#6A737D;">-- 邮件配置文件名称</span></span>
<span class="line"><span style="color:#E1E4E8;">                                    @recipients</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;你想发给哪个邮箱，这里就填哪个邮箱地址&#39;</span><span style="color:#E1E4E8;">,        </span><span style="color:#6A737D;">-- 邮件发送地址</span></span>
<span class="line"><span style="color:#E1E4E8;">                                    @subject</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;用户建议&#39;</span><span style="color:#E1E4E8;">,        </span><span style="color:#6A737D;">-- 邮件标题</span></span>
<span class="line"><span style="color:#E1E4E8;">                                    @body</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">@AdviseContent,    </span><span style="color:#6A737D;">--邮件内容</span></span>
<span class="line"><span style="color:#E1E4E8;">                                    @body_format</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;text&#39;</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">-- 邮件内容的类型，text 为文本，还可以设置为 html </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#F97583;">go</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--删除触发器</span></span>
<span class="line"><span style="color:#6A737D;">--Drop Trigger UserAdvise_Send_Mail</span></span>
<span class="line"><span style="color:#6A737D;">--创建一个 insert 类型的 after 触发器(用户建议)</span></span>
<span class="line"><span style="color:#D73A49;">create</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">trigger</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">UserAdvise_Send_Mail</span></span>
<span class="line"><span style="color:#D73A49;">on</span><span style="color:#24292E;"> UserAdvise</span></span>
<span class="line"><span style="color:#D73A49;">after</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">insert</span></span>
<span class="line"><span style="color:#D73A49;">as</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @UserName    </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">20</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @AdviseContent   </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @Content </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">300</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @CreateTime </span><span style="color:#D73A49;">datetime</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">declare</span><span style="color:#24292E;"> @UserMail </span><span style="color:#D73A49;">varchar</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">25</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> @Content</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">AdviseContent,@UserMail</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">UserMail </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> inserted</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">set</span><span style="color:#24292E;"> @AdviseContent</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;表哥，您收到一封来自一派科技用户建议邮件，内容如下：&#39;</span><span style="color:#D73A49;">+char</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">@Content</span></span>
<span class="line"><span style="color:#24292E;">					  </span><span style="color:#D73A49;">+char</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;该用户联系邮箱为：&#39;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">@UserMail</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_send_dbmail @profile_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;SendEmailProfile&#39;</span><span style="color:#24292E;">,    </span><span style="color:#6A737D;">-- 邮件配置文件名称</span></span>
<span class="line"><span style="color:#24292E;">                                    @recipients</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;你想发给哪个邮箱，这里就填哪个邮箱地址&#39;</span><span style="color:#24292E;">,        </span><span style="color:#6A737D;">-- 邮件发送地址</span></span>
<span class="line"><span style="color:#24292E;">                                    @subject</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;用户建议&#39;</span><span style="color:#24292E;">,        </span><span style="color:#6A737D;">-- 邮件标题</span></span>
<span class="line"><span style="color:#24292E;">                                    @body</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">@AdviseContent,    </span><span style="color:#6A737D;">--邮件内容</span></span>
<span class="line"><span style="color:#24292E;">                                    @body_format</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;text&#39;</span><span style="color:#24292E;">    </span><span style="color:#6A737D;">-- 邮件内容的类型，text 为文本，还可以设置为 html </span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#D73A49;">go</span></span></code></pre></div><p><em><strong>*SQL脚本测试触发器能否成功发出邮件*</strong></em></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- 新添加一条数据，用以触发 insert 触发器</span></span>
<span class="line"><span style="color:#6A737D;">--delete UserAdvise</span></span>
<span class="line"><span style="color:#F97583;">insert into</span><span style="color:#E1E4E8;"> UserAdvise(UserName,AdviseContent,CreateTime,UserMail) </span></span>
<span class="line"><span style="color:#F97583;">values</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;SINCLAIR&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&#39;测试一下邮件能不能发送出去&#39;</span><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">(),</span><span style="color:#9ECBFF;">&#39;xxxxxxxx@163.com&#39;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- 新添加一条数据，用以触发 insert 触发器</span></span>
<span class="line"><span style="color:#6A737D;">--delete UserAdvise</span></span>
<span class="line"><span style="color:#D73A49;">insert into</span><span style="color:#24292E;"> UserAdvise(UserName,AdviseContent,CreateTime,UserMail) </span></span>
<span class="line"><span style="color:#D73A49;">values</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;SINCLAIR&#39;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&#39;测试一下邮件能不能发送出去&#39;</span><span style="color:#24292E;">,</span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">(),</span><span style="color:#032F62;">&#39;xxxxxxxx@163.com&#39;</span><span style="color:#24292E;">)</span></span></code></pre></div><p><strong>查看发送记录及日志脚本</strong></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">use</span><span style="color:#E1E4E8;"> msdb</span></span>
<span class="line"><span style="color:#F97583;">go</span></span>
<span class="line"><span style="color:#6A737D;">--delete sysmail_allitems</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> sysmail_allitems        </span><span style="color:#6A737D;">-- 邮件发送情况，可以用来查看邮件是否发送成功</span></span>
<span class="line"><span style="color:#6A737D;">--delete sysmail_mailitems</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> sysmail_mailitems        </span><span style="color:#6A737D;">-- 发送邮件的记录</span></span>
<span class="line"><span style="color:#6A737D;">--delete sysmail_event_log</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> sysmail_event_log            </span><span style="color:#6A737D;">-- 数据库邮件日志，可以用来查询是否报错</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">use</span><span style="color:#24292E;"> msdb</span></span>
<span class="line"><span style="color:#D73A49;">go</span></span>
<span class="line"><span style="color:#6A737D;">--delete sysmail_allitems</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> sysmail_allitems        </span><span style="color:#6A737D;">-- 邮件发送情况，可以用来查看邮件是否发送成功</span></span>
<span class="line"><span style="color:#6A737D;">--delete sysmail_mailitems</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> sysmail_mailitems        </span><span style="color:#6A737D;">-- 发送邮件的记录</span></span>
<span class="line"><span style="color:#6A737D;">--delete sysmail_event_log</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> sysmail_event_log            </span><span style="color:#6A737D;">-- 数据库邮件日志，可以用来查询是否报错</span></span></code></pre></div><h3 id="_1-2-7-其它脚本" tabindex="-1">1.2.7 其它脚本 <a class="header-anchor" href="#_1-2-7-其它脚本" aria-label="Permalink to &quot;1.2.7 其它脚本&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">--查看账号</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> msdb..sysmail_account</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看配置文件</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> msdb..[sysmail_profile]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看是否已启动数据库邮件激活</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sysmail_help_status_sp;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--启动数据库邮件激活</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sysmail_start_sp;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--检查邮件队列的状态</span></span>
<span class="line"><span style="color:#6A737D;">--如果邮件队列的状态不正常，</span></span>
<span class="line"><span style="color:#6A737D;">--请使用 sysmail_stop_sp 尝试停止队列，然后再使用 sysmail_start_sp 启动队列。</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sysmail_help_queue_sp @queue_type </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;mail&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">--查看最近的邮件发送情况</span></span>
<span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">top</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mailitem_id</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">profile_id</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> profileName</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">g</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">description</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [log_desc]</span><span style="color:#6A737D;">--邮件发送有异常，这里会有显示</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sent_status</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> sent_status </span><span style="color:#F97583;">when</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Successed&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Failed&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> sent_status_desc</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">subject</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">body</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">body_format</span></span>
<span class="line"><span style="color:#E1E4E8;">,</span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">send_request_date</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> msdb..[sysmail_mailitems] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> m </span></span>
<span class="line"><span style="color:#F97583;">left join</span><span style="color:#E1E4E8;"> msdb..sysmail_profile </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">profile_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">p</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">profile_id</span></span>
<span class="line"><span style="color:#F97583;">left join</span><span style="color:#E1E4E8;"> msdb..sysmail_log g </span><span style="color:#F97583;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">m</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mailitem_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">g</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mailitem_id</span></span>
<span class="line"><span style="color:#F97583;">order by</span><span style="color:#E1E4E8;"> mailitem_id </span><span style="color:#F97583;">desc</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">--清除30天前的邮件和日志</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @DeleteBeforeDate </span><span style="color:#F97583;">DateTime</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @DeleteBeforeDate </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEADD</span><span style="color:#E1E4E8;">(d,</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> msdb..sysmail_delete_mailitems_sp @sent_before </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @DeleteBeforeDate</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> msdb..sysmail_delete_log_sp @logged_before </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @DeleteBeforeDate</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">--查看账号</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> msdb..sysmail_account</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看配置文件</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> msdb..[sysmail_profile]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--查看是否已启动数据库邮件激活</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sysmail_help_status_sp;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--启动数据库邮件激活</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sysmail_start_sp;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--检查邮件队列的状态</span></span>
<span class="line"><span style="color:#6A737D;">--如果邮件队列的状态不正常，</span></span>
<span class="line"><span style="color:#6A737D;">--请使用 sysmail_stop_sp 尝试停止队列，然后再使用 sysmail_start_sp 启动队列。</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sysmail_help_queue_sp @queue_type </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;mail&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">--查看最近的邮件发送情况</span></span>
<span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">top</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mailitem_id</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">profile_id</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> profileName</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">g</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">description</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [log_desc]</span><span style="color:#6A737D;">--邮件发送有异常，这里会有显示</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sent_status</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> sent_status </span><span style="color:#D73A49;">when</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Successed&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Failed&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> sent_status_desc</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">subject</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">body</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">body_format</span></span>
<span class="line"><span style="color:#24292E;">,</span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">send_request_date</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> msdb..[sysmail_mailitems] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> m </span></span>
<span class="line"><span style="color:#D73A49;">left join</span><span style="color:#24292E;"> msdb..sysmail_profile </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">profile_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">p</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">profile_id</span></span>
<span class="line"><span style="color:#D73A49;">left join</span><span style="color:#24292E;"> msdb..sysmail_log g </span><span style="color:#D73A49;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">m</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mailitem_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">g</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mailitem_id</span></span>
<span class="line"><span style="color:#D73A49;">order by</span><span style="color:#24292E;"> mailitem_id </span><span style="color:#D73A49;">desc</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">--清除30天前的邮件和日志</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @DeleteBeforeDate </span><span style="color:#D73A49;">DateTime</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @DeleteBeforeDate </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEADD</span><span style="color:#24292E;">(d,</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">30</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">())</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> msdb..sysmail_delete_mailitems_sp @sent_before </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @DeleteBeforeDate</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> msdb..sysmail_delete_log_sp @logged_before </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @DeleteBeforeDate</span></span></code></pre></div><h2 id="_1-3-定时抓取发送邮件" tabindex="-1">1.3 定时抓取发送邮件 <a class="header-anchor" href="#_1-3-定时抓取发送邮件" aria-label="Permalink to &quot;1.3 定时抓取发送邮件&quot;">​</a></h2><h3 id="_1-3-1-建库建表" tabindex="-1">1.3.1 建库建表 <a class="header-anchor" href="#_1-3-1-建库建表" aria-label="Permalink to &quot;1.3.1 建库建表&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [master]</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DATABASE</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL]</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#6A737D;">--建表</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL]</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--1、表[SQLCountStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--抓取到的sql语句数量</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> [dbo].[SQLCountStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span></span>
<span class="line"><span style="color:#E1E4E8;">      id </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">IDENTITY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)  </span><span style="color:#F97583;">PRIMARY KEY</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [SQLCount] </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [gettime] </span><span style="color:#F97583;">DATETIME</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span><span style="color:#E1E4E8;"> [Idx_SQLCountStatisticsByDay_SQLCount] </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL].[dbo].[SQLCountStatisticsByDay]([SQLCount])</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span><span style="color:#E1E4E8;"> [Idx_SQLCountStatisticsByDay_gettime] </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL].[dbo].[SQLCountStatisticsByDay]([gettime])</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--2、表[MostElapsedStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--每条不同的sql耗时最多</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> [dbo].[MostElapsedStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span></span>
<span class="line"><span style="color:#E1E4E8;">      id </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">IDENTITY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">PRIMARY KEY</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [ElapsedMS] </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [IOReads] </span><span style="color:#F97583;">BIGINT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [IOWrites] </span><span style="color:#F97583;">BIGINT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [DBName] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [paramlist] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [planstmttext] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [stmttext] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [xmlplan] </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [gettime] </span><span style="color:#F97583;">DATETIME</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span><span style="color:#E1E4E8;"> [Idx_MostElapsedStatisticsByDay_ElapsedMS] </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL].[dbo].[MostElapsedStatisticsByDay]([ElapsedMS])</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span><span style="color:#E1E4E8;"> [Idx_MostElapsedStatisticsByDay_gettime] </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL].[dbo].[MostElapsedStatisticsByDay]([gettime])</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--3、表[MostIOReadStatisticsByDay]</span></span>
<span class="line"><span style="color:#6A737D;">--每条不同的sql的IOread最多</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> [dbo].[MostIOReadStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span></span>
<span class="line"><span style="color:#E1E4E8;">      id </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">IDENTITY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">PRIMARY KEY</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [IOReads] </span><span style="color:#F97583;">BIGINT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [DBName] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [paramlist] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [planstmttext] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [stmttext] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [xmlplan] </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [gettime] </span><span style="color:#F97583;">DATETIME</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span><span style="color:#E1E4E8;"> [Idx_MostIOReadStatisticsByDay_IOReads] </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL].[dbo].[MostIOReadStatisticsByDay]([IOReads])</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span><span style="color:#E1E4E8;"> [Idx_MostIOReadStatisticsByDay_gettime] </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL].[dbo].[MostIOReadStatisticsByDay]([gettime])</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--4、表[MostIOWriteStatisticsByDay]</span></span>
<span class="line"><span style="color:#6A737D;">--每条不同的sql的IOwrite最多</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> [dbo].[MostIOWriteStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span></span>
<span class="line"><span style="color:#E1E4E8;">      id </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">IDENTITY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">PRIMARY KEY</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [IOWrites] </span><span style="color:#F97583;">BIGINT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [DBName] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [paramlist] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [planstmttext] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [stmttext] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [xmlplan] </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [gettime] </span><span style="color:#F97583;">DATETIME</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span><span style="color:#E1E4E8;"> [Idx_MostIOWriteStatisticsByDay_IOWrites] </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL].[dbo].[MostIOWriteStatisticsByDay]([IOWrites])</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span><span style="color:#E1E4E8;"> [Idx_MostIOWriteStatisticsByDay_gettime] </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL].[dbo].[MostIOWriteStatisticsByDay]([gettime])</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">--5、表[sp_executesqlCountStatisticsByDay]</span></span>
<span class="line"><span style="color:#6A737D;">--使用sp_executesql的sql有多少条</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> [dbo].[sp_executesqlCountStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;">    (</span></span>
<span class="line"><span style="color:#E1E4E8;">      id </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">IDENTITY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">PRIMARY KEY</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [sp_executesqlCount] </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [DBName] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [planstmttext] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">      [gettime] </span><span style="color:#F97583;">DATETIME</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span><span style="color:#E1E4E8;"> [Idx_sp_executesqlCountStatisticsByDay_sp_executesqlCount] </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL].[dbo].[sp_executesqlCountStatisticsByDay]([sp_executesqlCount])</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span><span style="color:#E1E4E8;"> [Idx_sp_executesqlCountStatisticsByDay_gettime] </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL].[dbo].[sp_executesqlCountStatisticsByDay]([gettime])</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [master]</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DATABASE</span><span style="color:#24292E;"> [MonitorElapsedHighSQL]</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#6A737D;">--建表</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [MonitorElapsedHighSQL]</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">--1、表[SQLCountStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">--抓取到的sql语句数量</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> [dbo].[SQLCountStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;">    (</span></span>
<span class="line"><span style="color:#24292E;">      id </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">IDENTITY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)  </span><span style="color:#D73A49;">PRIMARY KEY</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      [SQLCount] </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      [gettime] </span><span style="color:#D73A49;">DATETIME</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span><span style="color:#24292E;"> [Idx_SQLCountStatisticsByDay_SQLCount] </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> [MonitorElapsedHighSQL].[dbo].[SQLCountStatisticsByDay]([SQLCount])</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span><span style="color:#24292E;"> [Idx_SQLCountStatisticsByDay_gettime] </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> [MonitorElapsedHighSQL].[dbo].[SQLCountStatisticsByDay]([gettime])</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">--2、表[MostElapsedStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">--每条不同的sql耗时最多</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> [dbo].[MostElapsedStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;">    (</span></span>
<span class="line"><span style="color:#24292E;">      id </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">IDENTITY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">PRIMARY KEY</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      [ElapsedMS] </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      [IOReads] </span><span style="color:#D73A49;">BIGINT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      [IOWrites] </span><span style="color:#D73A49;">BIGINT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      [DBName] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">      [paramlist] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX) ,</span></span>
<span class="line"><span style="color:#24292E;">      [planstmttext] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX) ,</span></span>
<span class="line"><span style="color:#24292E;">      [stmttext] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX) ,</span></span>
<span class="line"><span style="color:#24292E;">      [xmlplan] </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      [gettime] </span><span style="color:#D73A49;">DATETIME</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span><span style="color:#24292E;"> [Idx_MostElapsedStatisticsByDay_ElapsedMS] </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> [MonitorElapsedHighSQL].[dbo].[MostElapsedStatisticsByDay]([ElapsedMS])</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span><span style="color:#24292E;"> [Idx_MostElapsedStatisticsByDay_gettime] </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> [MonitorElapsedHighSQL].[dbo].[MostElapsedStatisticsByDay]([gettime])</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">--3、表[MostIOReadStatisticsByDay]</span></span>
<span class="line"><span style="color:#6A737D;">--每条不同的sql的IOread最多</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> [dbo].[MostIOReadStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;">    (</span></span>
<span class="line"><span style="color:#24292E;">      id </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">IDENTITY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">PRIMARY KEY</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      [IOReads] </span><span style="color:#D73A49;">BIGINT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      [DBName] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">      [paramlist] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX) ,</span></span>
<span class="line"><span style="color:#24292E;">      [planstmttext] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX) ,</span></span>
<span class="line"><span style="color:#24292E;">      [stmttext] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX) ,</span></span>
<span class="line"><span style="color:#24292E;">      [xmlplan] </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      [gettime] </span><span style="color:#D73A49;">DATETIME</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span><span style="color:#24292E;"> [Idx_MostIOReadStatisticsByDay_IOReads] </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> [MonitorElapsedHighSQL].[dbo].[MostIOReadStatisticsByDay]([IOReads])</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span><span style="color:#24292E;"> [Idx_MostIOReadStatisticsByDay_gettime] </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> [MonitorElapsedHighSQL].[dbo].[MostIOReadStatisticsByDay]([gettime])</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">--4、表[MostIOWriteStatisticsByDay]</span></span>
<span class="line"><span style="color:#6A737D;">--每条不同的sql的IOwrite最多</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> [dbo].[MostIOWriteStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;">    (</span></span>
<span class="line"><span style="color:#24292E;">      id </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">IDENTITY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">PRIMARY KEY</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      [IOWrites] </span><span style="color:#D73A49;">BIGINT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      [DBName] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">      [paramlist] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX) ,</span></span>
<span class="line"><span style="color:#24292E;">      [planstmttext] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX) ,</span></span>
<span class="line"><span style="color:#24292E;">      [stmttext] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX) ,</span></span>
<span class="line"><span style="color:#24292E;">      [xmlplan] </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      [gettime] </span><span style="color:#D73A49;">DATETIME</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span><span style="color:#24292E;"> [Idx_MostIOWriteStatisticsByDay_IOWrites] </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> [MonitorElapsedHighSQL].[dbo].[MostIOWriteStatisticsByDay]([IOWrites])</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span><span style="color:#24292E;"> [Idx_MostIOWriteStatisticsByDay_gettime] </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> [MonitorElapsedHighSQL].[dbo].[MostIOWriteStatisticsByDay]([gettime])</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6A737D;">--5、表[sp_executesqlCountStatisticsByDay]</span></span>
<span class="line"><span style="color:#6A737D;">--使用sp_executesql的sql有多少条</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> [dbo].[sp_executesqlCountStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;">    (</span></span>
<span class="line"><span style="color:#24292E;">      id </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">IDENTITY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">PRIMARY KEY</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      [sp_executesqlCount] </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">      [DBName] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">      [planstmttext] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX) ,</span></span>
<span class="line"><span style="color:#24292E;">      [gettime] </span><span style="color:#D73A49;">DATETIME</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span><span style="color:#24292E;"> [Idx_sp_executesqlCountStatisticsByDay_sp_executesqlCount] </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> [MonitorElapsedHighSQL].[dbo].[sp_executesqlCountStatisticsByDay]([sp_executesqlCount])</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span><span style="color:#24292E;"> [Idx_sp_executesqlCountStatisticsByDay_gettime] </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> [MonitorElapsedHighSQL].[dbo].[sp_executesqlCountStatisticsByDay]([gettime])</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span></code></pre></div><h3 id="_1-3-2-创建sp-who3存储过程" tabindex="-1">1.3.2 创建sp_who3存储过程 <a class="header-anchor" href="#_1-3-2-创建sp-who3存储过程" aria-label="Permalink to &quot;1.3.2 创建sp_who3存储过程&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- http://sqlserverplanet.com/dba/a-better-sp_who2-using-dmvs-sp_who3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL]</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PROCEDURE</span><span style="color:#E1E4E8;"> [dbo].[sp_who3] </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">AS</span></span>
<span class="line"><span style="color:#F97583;">BEGIN</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRANSACTION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ISOLATION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LEVEL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">READ</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">UNCOMMITTED</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">    SPID                </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,BlkBy              </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> lead_blocker </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,ElapsedMS          </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">total_elapsed_time</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,CPU                </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">cpu_time</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,IOReads            </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">logical_reads</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">reads</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,IOWrites           </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">writes</span><span style="color:#E1E4E8;">     </span></span>
<span class="line"><span style="color:#E1E4E8;">    ,Executions         </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ec</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">execution_count</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">    ,CommandType        </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">command</span><span style="color:#E1E4E8;">         </span></span>
<span class="line"><span style="color:#E1E4E8;">    ,LastWaitType       </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">last_wait_type</span><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    ,ObjectName         </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_SCHEMA_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objectid</span><span style="color:#E1E4E8;">,</span><span style="color:#F97583;">dbid</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_NAME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">objectid</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbid</span><span style="color:#E1E4E8;">)  </span></span>
<span class="line"><span style="color:#E1E4E8;">    ,SQLStatement       </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">        SUBSTRING</span></span>
<span class="line"><span style="color:#E1E4E8;">        (</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            (</span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">LEN</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">nvarchar</span><span style="color:#E1E4E8;">(MAX), </span><span style="color:#79B8FF;">qt</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">text</span><span style="color:#E1E4E8;">)) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_end_offset</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">statement_start_offset</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">        )        </span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#F97583;">STATUS</span><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ses</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">STATUS</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,[Login]            </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ses</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">login_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,Host               </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ses</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">host_name</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,DBName             </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_Name</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">database_id</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,StartTime          </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">start_time</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,Protocol           </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">con</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">net_transport</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,transaction_isolation </span><span style="color:#F97583;">=</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ses</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">transaction_isolation_level</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Unspecified&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Read Uncommitted&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Read Committed&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Repeatable&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Serializable&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Snapshot&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,ConnectionWrites   </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">con</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">num_writes</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,ConnectionReads    </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">con</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">num_reads</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,ClientAddress      </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">con</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">client_net_address</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,</span><span style="color:#F97583;">Authentication</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">con</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">auth_scheme</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,DatetimeSnapshot   </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    ,plan_handle        </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">plan_handle</span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_requests</span><span style="color:#E1E4E8;"> er</span></span>
<span class="line"><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sessions</span><span style="color:#E1E4E8;"> ses</span></span>
<span class="line"><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ses</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"><span style="color:#F97583;">LEFT JOIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_connections</span><span style="color:#E1E4E8;"> con</span></span>
<span class="line"><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">con</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ses</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"><span style="color:#F97583;">OUTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_sql_text</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> qt</span></span>
<span class="line"><span style="color:#F97583;">OUTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> execution_count </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">MAX</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">cp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">usecounts</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_cached_plans</span><span style="color:#E1E4E8;"> cp</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">cp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">plan_handle</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">plan_handle</span></span>
<span class="line"><span style="color:#E1E4E8;">) ec</span></span>
<span class="line"><span style="color:#F97583;">OUTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT</span></span>
<span class="line"><span style="color:#E1E4E8;">        lead_blocker </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">master</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sysprocesses sp</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">spid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> blocked </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">master</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sysprocesses)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocked</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sp</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">spid</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"><span style="color:#E1E4E8;">) lb</span></span>
<span class="line"><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sql_handle</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IS NOT NULL</span></span>
<span class="line"><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> @@SPID</span></span>
<span class="line"><span style="color:#F97583;">ORDER BY</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">CASE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHEN</span><span style="color:#E1E4E8;"> lead_blocker </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">THEN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ELSE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">blocking_session_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">logical_reads</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">reads</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">er</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">session_id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">END</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- http://sqlserverplanet.com/dba/a-better-sp_who2-using-dmvs-sp_who3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [MonitorElapsedHighSQL]</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PROCEDURE</span><span style="color:#24292E;"> [dbo].[sp_who3] </span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">AS</span></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRANSACTION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ISOLATION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LEVEL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">READ</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">UNCOMMITTED</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">    SPID                </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"><span style="color:#24292E;">    ,BlkBy              </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> lead_blocker </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#24292E;">    ,ElapsedMS          </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">total_elapsed_time</span></span>
<span class="line"><span style="color:#24292E;">    ,CPU                </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">cpu_time</span></span>
<span class="line"><span style="color:#24292E;">    ,IOReads            </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">logical_reads</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">reads</span></span>
<span class="line"><span style="color:#24292E;">    ,IOWrites           </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">writes</span><span style="color:#24292E;">     </span></span>
<span class="line"><span style="color:#24292E;">    ,Executions         </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ec</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">execution_count</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">    ,CommandType        </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">command</span><span style="color:#24292E;">         </span></span>
<span class="line"><span style="color:#24292E;">    ,LastWaitType       </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">last_wait_type</span><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    ,ObjectName         </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_SCHEMA_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objectid</span><span style="color:#24292E;">,</span><span style="color:#D73A49;">dbid</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_NAME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">objectid</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbid</span><span style="color:#24292E;">)  </span></span>
<span class="line"><span style="color:#24292E;">    ,SQLStatement       </span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">        SUBSTRING</span></span>
<span class="line"><span style="color:#24292E;">        (</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            (</span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">LEN</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">nvarchar</span><span style="color:#24292E;">(MAX), </span><span style="color:#005CC5;">qt</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">text</span><span style="color:#24292E;">)) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_end_offset</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">statement_start_offset</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">        )        </span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#D73A49;">STATUS</span><span style="color:#24292E;">             </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ses</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">STATUS</span></span>
<span class="line"><span style="color:#24292E;">    ,[Login]            </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ses</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">login_name</span></span>
<span class="line"><span style="color:#24292E;">    ,Host               </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ses</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">host_name</span></span>
<span class="line"><span style="color:#24292E;">    ,DBName             </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_Name</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">database_id</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    ,StartTime          </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">start_time</span></span>
<span class="line"><span style="color:#24292E;">    ,Protocol           </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">con</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">net_transport</span></span>
<span class="line"><span style="color:#24292E;">    ,transaction_isolation </span><span style="color:#D73A49;">=</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ses</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">transaction_isolation_level</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Unspecified&#39;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Read Uncommitted&#39;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Read Committed&#39;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Repeatable&#39;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Serializable&#39;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Snapshot&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#24292E;">    ,ConnectionWrites   </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">con</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">num_writes</span></span>
<span class="line"><span style="color:#24292E;">    ,ConnectionReads    </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">con</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">num_reads</span></span>
<span class="line"><span style="color:#24292E;">    ,ClientAddress      </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">con</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">client_net_address</span></span>
<span class="line"><span style="color:#24292E;">    ,</span><span style="color:#D73A49;">Authentication</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">con</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">auth_scheme</span></span>
<span class="line"><span style="color:#24292E;">    ,DatetimeSnapshot   </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    ,plan_handle        </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">plan_handle</span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_requests</span><span style="color:#24292E;"> er</span></span>
<span class="line"><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sessions</span><span style="color:#24292E;"> ses</span></span>
<span class="line"><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ses</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"><span style="color:#D73A49;">LEFT JOIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_connections</span><span style="color:#24292E;"> con</span></span>
<span class="line"><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">con</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ses</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"><span style="color:#D73A49;">OUTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_sql_text</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> qt</span></span>
<span class="line"><span style="color:#D73A49;">OUTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> execution_count </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">MAX</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">cp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">usecounts</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_cached_plans</span><span style="color:#24292E;"> cp</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">cp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">plan_handle</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">plan_handle</span></span>
<span class="line"><span style="color:#24292E;">) ec</span></span>
<span class="line"><span style="color:#D73A49;">OUTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span></span>
<span class="line"><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT</span></span>
<span class="line"><span style="color:#24292E;">        lead_blocker </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">master</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sysprocesses sp</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">spid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> blocked </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">master</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sysprocesses)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocked</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sp</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">spid</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"><span style="color:#24292E;">) lb</span></span>
<span class="line"><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sql_handle</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IS NOT NULL</span></span>
<span class="line"><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> @@SPID</span></span>
<span class="line"><span style="color:#D73A49;">ORDER BY</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">CASE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHEN</span><span style="color:#24292E;"> lead_blocker </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">THEN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ELSE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">END</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">blocking_session_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">logical_reads</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">reads</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">er</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">session_id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">END</span></span></code></pre></div><h3 id="_1-3-3-创建-usp-checkelapsedhighsql-存储过程" tabindex="-1">1.3.3 创建[usp_checkElapsedHighSQL]存储过程 <a class="header-anchor" href="#_1-3-3-创建-usp-checkelapsedhighsql-存储过程" aria-label="Permalink to &quot;1.3.3 创建[usp_checkElapsedHighSQL]存储过程&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL]</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#6A737D;">/****** Object:  StoredProcedure [dbo].[usp_checkElapsedHighSQL]    Script Date: 2015/6/23 17:16:56 ******/</span></span>
<span class="line"><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ANSI_NULLS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ON</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">QUOTED_IDENTIFIER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ON</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--创建存储过程</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">PROCEDURE</span><span style="color:#E1E4E8;"> [dbo].[usp_checkElapsedHighSQL] ( @SessionID </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"><span style="color:#F97583;">AS</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;">  ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;MonitorElapsedHighSQL.dbo.ElapsedHigh&#39;</span><span style="color:#E1E4E8;">) ) </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">                 </span><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL].[dbo].[ElapsedHigh]</span></span>
<span class="line"><span style="color:#E1E4E8;">                    (</span></span>
<span class="line"><span style="color:#E1E4E8;">                      id </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">IDENTITY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)   </span><span style="color:#F97583;">PRIMARY KEY</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [SPID] </span><span style="color:#F97583;">SMALLINT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [ElapsedMS] </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [IOReads] </span><span style="color:#F97583;">BIGINT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [IOWrites] </span><span style="color:#F97583;">BIGINT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [DBName] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [plan_handle] </span><span style="color:#F97583;">VARBINARY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">64</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [paramlist] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [planstmttext] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [stmttext] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [xmlplan] </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [gettime] </span><span style="color:#F97583;">DATETIME</span></span>
<span class="line"><span style="color:#E1E4E8;">                    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span><span style="color:#E1E4E8;"> [Idx_ElapsedHigh_ElapsedMS] </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL].[dbo].[ElapsedHigh]([ElapsedMS])</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span><span style="color:#E1E4E8;"> [Idx_ElapsedHigh_IOReads] </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL].[dbo].[ElapsedHigh]([IOReads])</span></span>
<span class="line"><span style="color:#E1E4E8;">                 </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;">  ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;MonitorElapsedHighSQL.dbo.ElapsedHigh&#39;</span><span style="color:#E1E4E8;">) ) </span><span style="color:#F97583;">IS NOT NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOCOUNT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRANSACTION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ISOLATION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">LEVEL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">READ</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">UNCOMMITTED</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @Duration </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">-- in milliseconds, 10000 = 10 sec</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @now </span><span style="color:#F97583;">DATETIME</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @plan_handle </span><span style="color:#F97583;">VARBINARY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">64</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @ElapsedMS </span><span style="color:#F97583;">INT</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @SPID </span><span style="color:#F97583;">INT</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @IOReads </span><span style="color:#F97583;">BIGINT</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @IOWrites </span><span style="color:#F97583;">BIGINT</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @DBName </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @planstmttext </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @stmttext </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @paramlist </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @plan_xml </span><span style="color:#F97583;">XML</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @paramtb </span><span style="color:#F97583;">TABLE</span></span>
<span class="line"><span style="color:#E1E4E8;">                    (</span></span>
<span class="line"><span style="color:#E1E4E8;">                      paramlist </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      planstmttext </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    )</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @paramtb2 </span><span style="color:#F97583;">TABLE</span></span>
<span class="line"><span style="color:#E1E4E8;">                    (</span></span>
<span class="line"><span style="color:#E1E4E8;">                      paramlist </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      planstmttext </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  @Duration </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10000</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">--★Do -- in milliseconds, 10000 = 10 sec</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;tempdb..#ElapsedHigh&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">IS NOT NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">DROP</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> [#ElapsedHigh]  </span><span style="color:#6A737D;">--删除临时表  </span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--建临时表</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> [#ElapsedHigh]</span></span>
<span class="line"><span style="color:#E1E4E8;">                    (</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [SPID] </span><span style="color:#F97583;">SMALLINT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [BlkBy] </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [ElapsedMS] </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [CPU] </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [IOReads] </span><span style="color:#F97583;">BIGINT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [IOWrites] </span><span style="color:#F97583;">BIGINT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [Executions] </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [CommandType] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">40</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [LastWaitType] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">60</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [ObjectName] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [SQLStatement] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [STATUS] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [Login] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [Host] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [DBName] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [StartTime] </span><span style="color:#F97583;">DATETIME</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [Protocol] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">40</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [transaction_isolation] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [ConnectionWrites] </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [ConnectionReads] </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [ClientAddress] </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">48</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [AUTHENTICATION] </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">40</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [DatetimeSnapshot] </span><span style="color:#F97583;">DATETIME</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [plan_handle] </span><span style="color:#F97583;">VARBINARY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">64</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    )</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--处理逻辑</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">INSERT  INTO</span><span style="color:#E1E4E8;"> [#ElapsedHigh]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        ( [SPID] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [BlkBy] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [ElapsedMS] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [CPU] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [IOReads] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [IOWrites] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [Executions] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [CommandType] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [LastWaitType] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [ObjectName] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [SQLStatement] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [STATUS] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [Login] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [Host] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [DBName] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [StartTime] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [Protocol] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [transaction_isolation] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [ConnectionWrites] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [ConnectionReads] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [ClientAddress] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [AUTHENTICATION] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [DatetimeSnapshot] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [plan_handle]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        )</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL].[dbo].[sp_who3]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">--如果传入的是会话ID 只显示所在会话ID的信息</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> ( @SessionID </span><span style="color:#F97583;">IS NOT NULL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> @SessionID </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @ElapsedMS </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [ElapsedMS] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @SPID </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [SPID] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @plan_handle </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [plan_handle] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @IOReads </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [IOReads] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @IOWrites </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [IOWrites] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @DBName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [DBName]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    [#ElapsedHigh]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   [#ElapsedHigh].[SPID] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @SessionID</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  @stmttext </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [text]  </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fn_get_sql</span><span style="color:#E1E4E8;">(@plan_handle)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRY</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">-- convert may fail due to exceeding 128 depth limit</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  @plan_xml </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;">, query_plan)</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_text_query_plan</span><span style="color:#E1E4E8;">(@plan_handle, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRY</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CATCH</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  @plan_xml </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CATCH</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> XMLNAMESPACES (</span><span style="color:#9ECBFF;">&#39;http://schemas.microsoft.com/sqlserver/2004/07/showplan&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> sp)</span></span>
<span class="line"><span style="color:#F97583;">INSERT</span><span style="color:#E1E4E8;"> @paramtb ( [paramlist], [planstmttext] )</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">parameter_list</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">param_node</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;(./@Column)[1]&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;nvarchar(128)&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;=&#39;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">parameter_list</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">param_node</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;(./@ParameterCompiledValue)[1]&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;nvarchar(max)&#39;</span><span style="color:#E1E4E8;">)  </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> paramlist,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">ISNULL</span><span style="color:#E1E4E8;">(@plan_xml.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;(//@StatementText)[1]&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;nvarchar(max)&#39;</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">N&#39;Unknown Statement&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> stmttext</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @plan_xml </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> xml_showplan) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> t</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">OUTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xml_showplan</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nodes</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;//sp:ParameterList/sp:ColumnReference&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> parameter_list (param_node)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @SPID spid ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @ElapsedMS ElapsedMS ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @IOReads IOReads ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @IOWrites IOReads ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @DBName DBName ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @plan_handle plan_handle ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @plan_xml planxml,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @stmttext stmttext ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [planstmttext] planstmttext ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">    [paramlist] </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;  &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">      @paramtb</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">     [planstmttext] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> A.[planstmttext]</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">FOR</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PATH</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                                ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [paramlist]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    @paramtb A</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">GROUP BY</span><span style="color:#E1E4E8;"> [planstmttext]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">ELSE</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">--如果没有对存储过程传入参数，那么显示耗时最多的那条SQL的信息</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @ElapsedMS </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [ElapsedMS] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @SPID </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [SPID] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @plan_handle </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [plan_handle] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @IOReads </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [IOReads] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @IOWrites </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [IOWrites] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                @DBName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [DBName]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    [#ElapsedHigh]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [ElapsedMS] </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  @stmttext </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [text]  </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">fn_get_sql</span><span style="color:#E1E4E8;">(@plan_handle)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--抓取占用时间长的SQL</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> ( @ElapsedMS </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> @Duration )</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  @now </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRY</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">-- convert may fail due to exceeding 128 depth limit</span></span>
<span class="line"><span style="color:#E1E4E8;">                                    </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  @plan_xml </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;">, query_plan)</span></span>
<span class="line"><span style="color:#E1E4E8;">                                    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_exec_text_query_plan</span><span style="color:#E1E4E8;">(@plan_handle,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRY</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CATCH</span></span>
<span class="line"><span style="color:#E1E4E8;">                                    </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  @plan_xml </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">CATCH</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> XMLNAMESPACES (</span><span style="color:#9ECBFF;">&#39;http://schemas.microsoft.com/sqlserver/2004/07/showplan&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> sp)</span></span>
<span class="line"><span style="color:#F97583;">INSERT</span><span style="color:#E1E4E8;"> @paramtb ( [paramlist], [planstmttext] )</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">parameter_list</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">param_node</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;(./@Column)[1]&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;nvarchar(128)&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#9ECBFF;">&#39;=&#39;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">parameter_list</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">param_node</span><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;(./@ParameterCompiledValue)[1]&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;nvarchar(max)&#39;</span><span style="color:#E1E4E8;">)  </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> paramlist,</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">ISNULL</span><span style="color:#E1E4E8;">(@plan_xml.</span><span style="color:#F97583;">value</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;(//@StatementText)[1]&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;nvarchar(max)&#39;</span><span style="color:#E1E4E8;">), </span><span style="color:#9ECBFF;">N&#39;Unknown Statement&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> stmttext</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @plan_xml </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> xml_showplan) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> t</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">OUTER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">APPLY</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">t</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">xml_showplan</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">nodes</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;//sp:ParameterList/sp:ColumnReference&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> parameter_list (param_node)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">INSERT</span><span style="color:#E1E4E8;">  @paramtb2( [planstmttext] , [paramlist])</span></span>
<span class="line"><span style="color:#E1E4E8;">                                        </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                [planstmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">    [paramlist] </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;  &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                  </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">      @paramtb</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                  </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">     [planstmttext] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> A.[planstmttext]</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                </span><span style="color:#F97583;">FOR</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                  </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PATH</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> [paramlist]</span></span>
<span class="line"><span style="color:#E1E4E8;">                                        </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    @paramtb A</span></span>
<span class="line"><span style="color:#E1E4E8;">                                        </span><span style="color:#F97583;">GROUP BY</span><span style="color:#E1E4E8;"> [planstmttext]</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">                                        @planstmttext </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [planstmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                        @paramlist </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [paramlist]</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    @paramtb2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">INSERT  INTO</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL].[dbo].[ElapsedHigh]</span></span>
<span class="line"><span style="color:#E1E4E8;">                                        ( [SPID] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          [ElapsedMS] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          [IOReads] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          [IOWrites] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          [DBName] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          [plan_handle] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          [paramlist] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          [stmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          [planstmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          [xmlplan],</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          [gettime]</span></span>
<span class="line"><span style="color:#E1E4E8;">                                        )</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;">  ( @SPID , </span><span style="color:#6A737D;">-- SPID - smallint</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          @ElapsedMS , </span><span style="color:#6A737D;">-- ElapsedMS - int</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          @IOReads , </span><span style="color:#6A737D;">-- IOReads - bigint</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          @IOWrites , </span><span style="color:#6A737D;">-- IOWrites - bigint</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          @DBName , </span><span style="color:#6A737D;">-- DBName - nvarchar(128)</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          @plan_handle , </span><span style="color:#6A737D;">-- plan_handle - varbinary(64)</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          @paramlist , </span><span style="color:#6A737D;">-- paramlist - nvarchar(max)</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          @stmttext , </span><span style="color:#6A737D;">-- stmttext - nvarchar(max)</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          @planstmttext , </span><span style="color:#6A737D;">-- planstmttext - nvarchar(max)</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          @plan_xml ,  </span><span style="color:#6A737D;">--plan_xml - xml</span></span>
<span class="line"><span style="color:#E1E4E8;">                                          @now  </span><span style="color:#6A737D;">-- gettime - datetime</span></span>
<span class="line"><span style="color:#E1E4E8;">                                        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">END</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [MonitorElapsedHighSQL]</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#6A737D;">/****** Object:  StoredProcedure [dbo].[usp_checkElapsedHighSQL]    Script Date: 2015/6/23 17:16:56 ******/</span></span>
<span class="line"><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ANSI_NULLS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ON</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">QUOTED_IDENTIFIER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ON</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--创建存储过程</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">PROCEDURE</span><span style="color:#24292E;"> [dbo].[usp_checkElapsedHighSQL] ( @SessionID </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> )</span></span>
<span class="line"><span style="color:#D73A49;">AS</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;">  ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;MonitorElapsedHighSQL.dbo.ElapsedHigh&#39;</span><span style="color:#24292E;">) ) </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NULL</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">                 </span><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> [MonitorElapsedHighSQL].[dbo].[ElapsedHigh]</span></span>
<span class="line"><span style="color:#24292E;">                    (</span></span>
<span class="line"><span style="color:#24292E;">                      id </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">IDENTITY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)   </span><span style="color:#D73A49;">PRIMARY KEY</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                      [SPID] </span><span style="color:#D73A49;">SMALLINT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                      [ElapsedMS] </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                      [IOReads] </span><span style="color:#D73A49;">BIGINT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                      [IOWrites] </span><span style="color:#D73A49;">BIGINT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                      [DBName] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [plan_handle] </span><span style="color:#D73A49;">VARBINARY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">64</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [paramlist] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [planstmttext] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [stmttext] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [xmlplan] </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                      [gettime] </span><span style="color:#D73A49;">DATETIME</span></span>
<span class="line"><span style="color:#24292E;">                    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span><span style="color:#24292E;"> [Idx_ElapsedHigh_ElapsedMS] </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> [MonitorElapsedHighSQL].[dbo].[ElapsedHigh]([ElapsedMS])</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span><span style="color:#24292E;"> [Idx_ElapsedHigh_IOReads] </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> [MonitorElapsedHighSQL].[dbo].[ElapsedHigh]([IOReads])</span></span>
<span class="line"><span style="color:#24292E;">                 </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;">  ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;MonitorElapsedHighSQL.dbo.ElapsedHigh&#39;</span><span style="color:#24292E;">) ) </span><span style="color:#D73A49;">IS NOT NULL</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOCOUNT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRANSACTION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ISOLATION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">LEVEL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">READ</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">UNCOMMITTED</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @Duration </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">-- in milliseconds, 10000 = 10 sec</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @now </span><span style="color:#D73A49;">DATETIME</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @plan_handle </span><span style="color:#D73A49;">VARBINARY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">64</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @ElapsedMS </span><span style="color:#D73A49;">INT</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @SPID </span><span style="color:#D73A49;">INT</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @IOReads </span><span style="color:#D73A49;">BIGINT</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @IOWrites </span><span style="color:#D73A49;">BIGINT</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @DBName </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @planstmttext </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @stmttext </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @paramlist </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @plan_xml </span><span style="color:#D73A49;">XML</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @paramtb </span><span style="color:#D73A49;">TABLE</span></span>
<span class="line"><span style="color:#24292E;">                    (</span></span>
<span class="line"><span style="color:#24292E;">                      paramlist </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX) ,</span></span>
<span class="line"><span style="color:#24292E;">                      planstmttext </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX)</span></span>
<span class="line"><span style="color:#24292E;">                    )</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @paramtb2 </span><span style="color:#D73A49;">TABLE</span></span>
<span class="line"><span style="color:#24292E;">                    (</span></span>
<span class="line"><span style="color:#24292E;">                      paramlist </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX) ,</span></span>
<span class="line"><span style="color:#24292E;">                      planstmttext </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX)</span></span>
<span class="line"><span style="color:#24292E;">                    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  @Duration </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10000</span><span style="color:#24292E;">  </span><span style="color:#6A737D;">--★Do -- in milliseconds, 10000 = 10 sec</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;tempdb..#ElapsedHigh&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">IS NOT NULL</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">DROP</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> [#ElapsedHigh]  </span><span style="color:#6A737D;">--删除临时表  </span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--建临时表</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> [#ElapsedHigh]</span></span>
<span class="line"><span style="color:#24292E;">                    (</span></span>
<span class="line"><span style="color:#24292E;">                      [SPID] </span><span style="color:#D73A49;">SMALLINT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                      [BlkBy] </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                      [ElapsedMS] </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                      [CPU] </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                      [IOReads] </span><span style="color:#D73A49;">BIGINT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                      [IOWrites] </span><span style="color:#D73A49;">BIGINT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                      [Executions] </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                      [CommandType] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">40</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [LastWaitType] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">60</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [ObjectName] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [SQLStatement] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [STATUS] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">30</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [Login] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [Host] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [DBName] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [StartTime] </span><span style="color:#D73A49;">DATETIME</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                      [Protocol] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">40</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [transaction_isolation] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [ConnectionWrites] </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                      [ConnectionReads] </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                      [ClientAddress] </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">48</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [AUTHENTICATION] </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">40</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [DatetimeSnapshot] </span><span style="color:#D73A49;">DATETIME</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                      [plan_handle] </span><span style="color:#D73A49;">VARBINARY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">64</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                    )</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--处理逻辑</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">INSERT  INTO</span><span style="color:#24292E;"> [#ElapsedHigh]</span></span>
<span class="line"><span style="color:#24292E;">                        ( [SPID] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [BlkBy] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [ElapsedMS] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [CPU] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [IOReads] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [IOWrites] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [Executions] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [CommandType] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [LastWaitType] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [ObjectName] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [SQLStatement] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [STATUS] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [Login] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [Host] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [DBName] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [StartTime] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [Protocol] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [transaction_isolation] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [ConnectionWrites] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [ConnectionReads] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [ClientAddress] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [AUTHENTICATION] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [DatetimeSnapshot] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [plan_handle]</span></span>
<span class="line"><span style="color:#24292E;">                        )</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> [MonitorElapsedHighSQL].[dbo].[sp_who3]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">--如果传入的是会话ID 只显示所在会话ID的信息</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> ( @SessionID </span><span style="color:#D73A49;">IS NOT NULL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> @SessionID </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> )</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">                                @ElapsedMS </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [ElapsedMS] ,</span></span>
<span class="line"><span style="color:#24292E;">                                @SPID </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [SPID] ,</span></span>
<span class="line"><span style="color:#24292E;">                                @plan_handle </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [plan_handle] ,</span></span>
<span class="line"><span style="color:#24292E;">                                @IOReads </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [IOReads] ,</span></span>
<span class="line"><span style="color:#24292E;">                                @IOWrites </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [IOWrites] ,</span></span>
<span class="line"><span style="color:#24292E;">                                @DBName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [DBName]</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    [#ElapsedHigh]</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   [#ElapsedHigh].[SPID] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @SessionID</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  @stmttext </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [text]  </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fn_get_sql</span><span style="color:#24292E;">(@plan_handle)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRY</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">-- convert may fail due to exceeding 128 depth limit</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  @plan_xml </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">XML</span><span style="color:#24292E;">, query_plan)</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_text_query_plan</span><span style="color:#24292E;">(@plan_handle, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRY</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CATCH</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  @plan_xml </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NULL</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CATCH</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> XMLNAMESPACES (</span><span style="color:#032F62;">&#39;http://schemas.microsoft.com/sqlserver/2004/07/showplan&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> sp)</span></span>
<span class="line"><span style="color:#D73A49;">INSERT</span><span style="color:#24292E;"> @paramtb ( [paramlist], [planstmttext] )</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">parameter_list</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">param_node</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;(./@Column)[1]&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;nvarchar(128)&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;=&#39;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">parameter_list</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">param_node</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;(./@ParameterCompiledValue)[1]&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;nvarchar(max)&#39;</span><span style="color:#24292E;">)  </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> paramlist,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">ISNULL</span><span style="color:#24292E;">(@plan_xml.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;(//@StatementText)[1]&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;nvarchar(max)&#39;</span><span style="color:#24292E;">), </span><span style="color:#032F62;">N&#39;Unknown Statement&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> stmttext</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @plan_xml </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> xml_showplan) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> t</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">OUTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xml_showplan</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nodes</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;//sp:ParameterList/sp:ColumnReference&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> parameter_list (param_node)</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">                                @SPID spid ,</span></span>
<span class="line"><span style="color:#24292E;">                                @ElapsedMS ElapsedMS ,</span></span>
<span class="line"><span style="color:#24292E;">                                @IOReads IOReads ,</span></span>
<span class="line"><span style="color:#24292E;">                                @IOWrites IOReads ,</span></span>
<span class="line"><span style="color:#24292E;">                                @DBName DBName ,</span></span>
<span class="line"><span style="color:#24292E;">                                @plan_handle plan_handle ,</span></span>
<span class="line"><span style="color:#24292E;">                                @plan_xml planxml,</span></span>
<span class="line"><span style="color:#24292E;">                                @stmttext stmttext ,</span></span>
<span class="line"><span style="color:#24292E;">                                [planstmttext] planstmttext ,</span></span>
<span class="line"><span style="color:#24292E;">                                ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">    [paramlist] </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;  &#39;</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">      @paramtb</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">     [planstmttext] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> A.[planstmttext]</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#D73A49;">FOR</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PATH</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                                ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [paramlist]</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    @paramtb A</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">GROUP BY</span><span style="color:#24292E;"> [planstmttext]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">ELSE</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">--如果没有对存储过程传入参数，那么显示耗时最多的那条SQL的信息</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">                                @ElapsedMS </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [ElapsedMS] ,</span></span>
<span class="line"><span style="color:#24292E;">                                @SPID </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [SPID] ,</span></span>
<span class="line"><span style="color:#24292E;">                                @plan_handle </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [plan_handle] ,</span></span>
<span class="line"><span style="color:#24292E;">                                @IOReads </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [IOReads] ,</span></span>
<span class="line"><span style="color:#24292E;">                                @IOWrites </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [IOWrites] ,</span></span>
<span class="line"><span style="color:#24292E;">                                @DBName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [DBName]</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    [#ElapsedHigh]</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [ElapsedMS] </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  @stmttext </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [text]  </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">fn_get_sql</span><span style="color:#24292E;">(@plan_handle)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--抓取占用时间长的SQL</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> ( @ElapsedMS </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> @Duration )</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  @now </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRY</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">-- convert may fail due to exceeding 128 depth limit</span></span>
<span class="line"><span style="color:#24292E;">                                    </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  @plan_xml </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">XML</span><span style="color:#24292E;">, query_plan)</span></span>
<span class="line"><span style="color:#24292E;">                                    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_exec_text_query_plan</span><span style="color:#24292E;">(@plan_handle,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRY</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CATCH</span></span>
<span class="line"><span style="color:#24292E;">                                    </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  @plan_xml </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NULL</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">CATCH</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> XMLNAMESPACES (</span><span style="color:#032F62;">&#39;http://schemas.microsoft.com/sqlserver/2004/07/showplan&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> sp)</span></span>
<span class="line"><span style="color:#D73A49;">INSERT</span><span style="color:#24292E;"> @paramtb ( [paramlist], [planstmttext] )</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">parameter_list</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">param_node</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;(./@Column)[1]&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;nvarchar(128)&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#032F62;">&#39;=&#39;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">parameter_list</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">param_node</span><span style="color:#24292E;">.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;(./@ParameterCompiledValue)[1]&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;nvarchar(max)&#39;</span><span style="color:#24292E;">)  </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> paramlist,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">ISNULL</span><span style="color:#24292E;">(@plan_xml.</span><span style="color:#D73A49;">value</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;(//@StatementText)[1]&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;nvarchar(max)&#39;</span><span style="color:#24292E;">), </span><span style="color:#032F62;">N&#39;Unknown Statement&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> stmttext</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @plan_xml </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> xml_showplan) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> t</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">OUTER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">APPLY</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">t</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">xml_showplan</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">nodes</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;//sp:ParameterList/sp:ColumnReference&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> parameter_list (param_node)</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#D73A49;">INSERT</span><span style="color:#24292E;">  @paramtb2( [planstmttext] , [paramlist])</span></span>
<span class="line"><span style="color:#24292E;">                                        </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">                                                [planstmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                                                ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">    [paramlist] </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;  &#39;</span></span>
<span class="line"><span style="color:#24292E;">                                                  </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">      @paramtb</span></span>
<span class="line"><span style="color:#24292E;">                                                  </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">     [planstmttext] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> A.[planstmttext]</span></span>
<span class="line"><span style="color:#24292E;">                                                </span><span style="color:#D73A49;">FOR</span></span>
<span class="line"><span style="color:#24292E;">                                                  </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PATH</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                                                ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> [paramlist]</span></span>
<span class="line"><span style="color:#24292E;">                                        </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    @paramtb A</span></span>
<span class="line"><span style="color:#24292E;">                                        </span><span style="color:#D73A49;">GROUP BY</span><span style="color:#24292E;"> [planstmttext]</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">                                        @planstmttext </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [planstmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                                        @paramlist </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [paramlist]</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    @paramtb2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#D73A49;">INSERT  INTO</span><span style="color:#24292E;"> [MonitorElapsedHighSQL].[dbo].[ElapsedHigh]</span></span>
<span class="line"><span style="color:#24292E;">                                        ( [SPID] ,</span></span>
<span class="line"><span style="color:#24292E;">                                          [ElapsedMS] ,</span></span>
<span class="line"><span style="color:#24292E;">                                          [IOReads] ,</span></span>
<span class="line"><span style="color:#24292E;">                                          [IOWrites] ,</span></span>
<span class="line"><span style="color:#24292E;">                                          [DBName] ,</span></span>
<span class="line"><span style="color:#24292E;">                                          [plan_handle] ,</span></span>
<span class="line"><span style="color:#24292E;">                                          [paramlist] ,</span></span>
<span class="line"><span style="color:#24292E;">                                          [stmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                                          [planstmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                                          [xmlplan],</span></span>
<span class="line"><span style="color:#24292E;">                                          [gettime]</span></span>
<span class="line"><span style="color:#24292E;">                                        )</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;">  ( @SPID , </span><span style="color:#6A737D;">-- SPID - smallint</span></span>
<span class="line"><span style="color:#24292E;">                                          @ElapsedMS , </span><span style="color:#6A737D;">-- ElapsedMS - int</span></span>
<span class="line"><span style="color:#24292E;">                                          @IOReads , </span><span style="color:#6A737D;">-- IOReads - bigint</span></span>
<span class="line"><span style="color:#24292E;">                                          @IOWrites , </span><span style="color:#6A737D;">-- IOWrites - bigint</span></span>
<span class="line"><span style="color:#24292E;">                                          @DBName , </span><span style="color:#6A737D;">-- DBName - nvarchar(128)</span></span>
<span class="line"><span style="color:#24292E;">                                          @plan_handle , </span><span style="color:#6A737D;">-- plan_handle - varbinary(64)</span></span>
<span class="line"><span style="color:#24292E;">                                          @paramlist , </span><span style="color:#6A737D;">-- paramlist - nvarchar(max)</span></span>
<span class="line"><span style="color:#24292E;">                                          @stmttext , </span><span style="color:#6A737D;">-- stmttext - nvarchar(max)</span></span>
<span class="line"><span style="color:#24292E;">                                          @planstmttext , </span><span style="color:#6A737D;">-- planstmttext - nvarchar(max)</span></span>
<span class="line"><span style="color:#24292E;">                                          @plan_xml ,  </span><span style="color:#6A737D;">--plan_xml - xml</span></span>
<span class="line"><span style="color:#24292E;">                                          @now  </span><span style="color:#6A737D;">-- gettime - datetime</span></span>
<span class="line"><span style="color:#24292E;">                                        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">END</span></span></code></pre></div><h3 id="_1-3-4-创建-usp-resettbname-存储过程" tabindex="-1">1.3.4 创建[usp_Resettbname]存储过程 <a class="header-anchor" href="#_1-3-4-创建-usp-resettbname-存储过程" aria-label="Permalink to &quot;1.3.4 创建[usp_Resettbname]存储过程&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL]</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#6A737D;">--重设ElapsedHigh表名，进行归档</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">PROCEDURE</span><span style="color:#E1E4E8;"> [dbo].[usp_Resettbname]</span></span>
<span class="line"><span style="color:#F97583;">AS</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span></span>
<span class="line"><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">EXISTS</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;MonitorElapsedHighSQL.dbo.ElapsedHigh&#39;</span><span style="color:#E1E4E8;">) )</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#6A737D;">--kill掉数据库所有连接</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @DBNAME </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @SPID </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @OwnSPID </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @TBNAME </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  @OwnSPID </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @@SPID</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @DBNAME </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;MonitorElapsedHighSQL&#39;</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> CurDBName </span><span style="color:#F97583;">CURSOR</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">FOR</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  [spid]</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">sysprocesses</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   [spid] </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">50</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DBID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DB_ID</span><span style="color:#E1E4E8;">(@DBNAME)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">OPEN</span><span style="color:#E1E4E8;"> CurDBName</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">FETCH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NEXT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> CurDBName </span><span style="color:#F97583;">INTO</span><span style="color:#E1E4E8;"> @SPID</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">WHILE</span><span style="color:#E1E4E8;"> @@FETCH_STATUS </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">--kill process 不kill掉本存储过程的spid</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> ( @SPID </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> @OwnSPID )</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;kill &#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @SPID</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> (@SQL)</span></span>
<span class="line"><span style="color:#E1E4E8;">                            </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">FETCH</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NEXT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> CurDBName </span><span style="color:#F97583;">INTO</span><span style="color:#E1E4E8;"> @SPID</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">CLOSE</span><span style="color:#E1E4E8;"> CurDBName</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DEALLOCATE</span><span style="color:#E1E4E8;"> CurDBName</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @TBNAME</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;ElapsedHigh&#39;</span><span style="color:#F97583;">+</span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">(), </span><span style="color:#79B8FF;">112</span><span style="color:#E1E4E8;">) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> sys.[sp_rename] @objname </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;ElapsedHigh&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">-- nvarchar(1035)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    @newname </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">@TBNAME    </span><span style="color:#6A737D;">-- sysname</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">END</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [MonitorElapsedHighSQL]</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#6A737D;">--重设ElapsedHigh表名，进行归档</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">PROCEDURE</span><span style="color:#24292E;"> [dbo].[usp_Resettbname]</span></span>
<span class="line"><span style="color:#D73A49;">AS</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">       </span></span>
<span class="line"><span style="color:#24292E;">         </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">EXISTS</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;MonitorElapsedHighSQL.dbo.ElapsedHigh&#39;</span><span style="color:#24292E;">) )</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#6A737D;">--kill掉数据库所有连接</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @DBNAME </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @SPID </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @OwnSPID </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">100</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @TBNAME </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1000</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  @OwnSPID </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @@SPID</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @DBNAME </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;MonitorElapsedHighSQL&#39;</span><span style="color:#24292E;">  </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> CurDBName </span><span style="color:#D73A49;">CURSOR</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">FOR</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  [spid]</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">sysprocesses</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   [spid] </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">50</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DBID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DB_ID</span><span style="color:#24292E;">(@DBNAME)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">OPEN</span><span style="color:#24292E;"> CurDBName</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">FETCH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NEXT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> CurDBName </span><span style="color:#D73A49;">INTO</span><span style="color:#24292E;"> @SPID</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">WHILE</span><span style="color:#24292E;"> @@FETCH_STATUS </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">--kill process 不kill掉本存储过程的spid</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> ( @SPID </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> @OwnSPID )</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;kill &#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @SPID</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> (@SQL)</span></span>
<span class="line"><span style="color:#24292E;">                            </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">FETCH</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NEXT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> CurDBName </span><span style="color:#D73A49;">INTO</span><span style="color:#24292E;"> @SPID</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">CLOSE</span><span style="color:#24292E;"> CurDBName</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DEALLOCATE</span><span style="color:#24292E;"> CurDBName</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @TBNAME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;ElapsedHigh&#39;</span><span style="color:#D73A49;">+</span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">(), </span><span style="color:#005CC5;">112</span><span style="color:#24292E;">) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> sys.[sp_rename] @objname </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;ElapsedHigh&#39;</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">-- nvarchar(1035)</span></span>
<span class="line"><span style="color:#24292E;">                    @newname </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">@TBNAME    </span><span style="color:#6A737D;">-- sysname</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">END</span></span></code></pre></div><h3 id="_1-3-5-创建-usp-statisticstask-存储过程" tabindex="-1">1.3.5 创建[usp_StatisticsTask]存储过程 <a class="header-anchor" href="#_1-3-5-创建-usp-statisticstask-存储过程" aria-label="Permalink to &quot;1.3.5 创建[usp_StatisticsTask]存储过程&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL]</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#6A737D;">/****** Object:  StoredProcedure [dbo].[usp_StatisticsTask]    Script Date: 2015/6/24 18:05:38 ******/</span></span>
<span class="line"><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ANSI_NULLS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ON</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">QUOTED_IDENTIFIER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ON</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--创建存储过程</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">PROCEDURE</span><span style="color:#E1E4E8;"> [dbo].[usp_StatisticsTask]</span></span>
<span class="line"><span style="color:#F97583;">AS</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> ( ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;MonitorElapsedHighSQL.dbo.SQLCountStatisticsByDay&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">             ) </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;MonitorElapsedHighSQL.dbo.MostElapsedStatisticsByDay&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                 ) </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;MonitorElapsedHighSQL.dbo.MostIOReadStatisticsByDay&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                 ) </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;MonitorElapsedHighSQL.dbo.MostIOWriteStatisticsByDay&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                 ) </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">OBJECT_ID</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;MonitorElapsedHighSQL.dbo.sp_executesqlCountStatisticsByDay&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                 ) </span><span style="color:#F97583;">IS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">           )</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">RETURN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">                 </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">END</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">ELSE</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">--最耗时SQL</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">INSERT  INTO</span><span style="color:#E1E4E8;"> [dbo].[MostElapsedStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        ( [ElapsedMS] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [IOReads] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [IOWrites] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [DBName] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [paramlist] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [planstmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [stmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [xmlplan] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [gettime]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        )</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  [ElapsedMS] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [IOReads] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [IOWrites] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [DBName] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [paramlist] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [planstmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [stmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [xmlplan] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">ROW_NUMBER</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">OVER</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">PARTITION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">BY</span><span style="color:#E1E4E8;"> spid </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [ElapsedMS] </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;"> ) rowid ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                            </span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">      [ElapsedHigh]</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">     [DBName] </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> ( </span><span style="color:#9ECBFF;">&#39;MASTER&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#9ECBFF;">&#39;MODEL&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;MSDB&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#9ECBFF;">&#39;ReportServer&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#9ECBFF;">&#39;ReportServerTempDB&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#9ECBFF;">&#39;distribution&#39;</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"><span style="color:#E1E4E8;">                                ) t</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   rowid </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--读IO最多SQL</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">INSERT  INTO</span><span style="color:#E1E4E8;"> [dbo].[MostIOReadStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        ( [IOReads] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [DBName] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [paramlist] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [planstmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [stmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [xmlplan] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [gettime]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        )</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  [IOReads] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [DBName] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [paramlist] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [planstmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [stmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [xmlplan] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">ROW_NUMBER</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">OVER</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">PARTITION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">BY</span><span style="color:#E1E4E8;"> spid </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [IOReads] </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;"> ) rowid ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                            </span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">      [ElapsedHigh]</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">     [DBName] </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> ( </span><span style="color:#9ECBFF;">&#39;MASTER&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#9ECBFF;">&#39;MODEL&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;MSDB&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#9ECBFF;">&#39;ReportServer&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#9ECBFF;">&#39;ReportServerTempDB&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#9ECBFF;">&#39;distribution&#39;</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"><span style="color:#E1E4E8;">                                ) t</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   rowid </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--写IO最多SQL</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">INSERT  INTO</span><span style="color:#E1E4E8;"> [dbo].[MostIOWriteStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        ( [IOWrites] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [DBName] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [paramlist] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [planstmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [stmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [xmlplan] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [gettime]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        )</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  [IOWrites] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [DBName] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [paramlist] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [planstmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [stmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [xmlplan] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">ROW_NUMBER</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">OVER</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">PARTITION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">BY</span><span style="color:#E1E4E8;"> spid </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [IOWrites] </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;"> ) rowid ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                            </span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">      [ElapsedHigh]</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">     [DBName] </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> ( </span><span style="color:#9ECBFF;">&#39;MASTER&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#9ECBFF;">&#39;MODEL&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;MSDB&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#9ECBFF;">&#39;ReportServer&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#9ECBFF;">&#39;ReportServerTempDB&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#9ECBFF;">&#39;distribution&#39;</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"><span style="color:#E1E4E8;">                                ) t</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   rowid </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--统计sp_executesql次数</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @tbsp_executesqlCountStatisticsByDay </span><span style="color:#F97583;">TABLE</span></span>
<span class="line"><span style="color:#E1E4E8;">                    (</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [DBName] [nvarchar](</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                      [planstmttext] [nvarchar](MAX)</span></span>
<span class="line"><span style="color:#E1E4E8;">                    )</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @sp_executesqlCount </span><span style="color:#F97583;">INT</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">INSERT  INTO</span><span style="color:#E1E4E8;"> @tbsp_executesqlCountStatisticsByDay</span></span>
<span class="line"><span style="color:#E1E4E8;">                        ( [DBName] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [planstmttext] </span></span>
<span class="line"><span style="color:#E1E4E8;">                        )</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  [DBName] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [planstmttext]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    ( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">ROW_NUMBER</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">OVER</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">PARTITION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">BY</span><span style="color:#E1E4E8;"> spid </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [IOWrites] </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;"> ) rowid ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                            </span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">      [ElapsedHigh]</span></span>
<span class="line"><span style="color:#E1E4E8;">                                  </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">     [planstmttext] </span><span style="color:#F97583;">LIKE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;(@%&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                                            </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> [DBName] </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> ( </span><span style="color:#9ECBFF;">&#39;MASTER&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#9ECBFF;">&#39;MODEL&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;MSDB&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#9ECBFF;">&#39;ReportServer&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#9ECBFF;">&#39;ReportServerTempDB&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                              </span><span style="color:#9ECBFF;">&#39;distribution&#39;</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"><span style="color:#E1E4E8;">                                ) t</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   rowid </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  @sp_executesqlCount </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">COUNT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    @tbsp_executesqlCountStatisticsByDay</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">INSERT  INTO</span><span style="color:#E1E4E8;"> [dbo].[sp_executesqlCountStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        ( [sp_executesqlCount] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [DBName] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [planstmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [gettime]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        )</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  @sp_executesqlCount ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [DBName] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                [planstmttext] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    @tbsp_executesqlCountStatisticsByDay</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--统计一共有多少SQL被抓取</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">INSERT  INTO</span><span style="color:#E1E4E8;"> [dbo].[SQLCountStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        ( [SQLCount] ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                          [gettime]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        )</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">COUNT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DISTINCT</span><span style="color:#E1E4E8;"> ( [planstmttext] )) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    [dbo].[ElapsedHigh]</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   [DBName] </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IN</span><span style="color:#E1E4E8;"> ( </span><span style="color:#9ECBFF;">&#39;MASTER&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;MODEL&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;MSDB&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                  </span><span style="color:#9ECBFF;">&#39;ReportServer&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                  </span><span style="color:#9ECBFF;">&#39;ReportServerTempDB&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                                  </span><span style="color:#9ECBFF;">&#39;distribution&#39;</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">   </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">END</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [MonitorElapsedHighSQL]</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#6A737D;">/****** Object:  StoredProcedure [dbo].[usp_StatisticsTask]    Script Date: 2015/6/24 18:05:38 ******/</span></span>
<span class="line"><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ANSI_NULLS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ON</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">QUOTED_IDENTIFIER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ON</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--创建存储过程</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">PROCEDURE</span><span style="color:#24292E;"> [dbo].[usp_StatisticsTask]</span></span>
<span class="line"><span style="color:#D73A49;">AS</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> ( ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;MonitorElapsedHighSQL.dbo.SQLCountStatisticsByDay&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">             ) </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NULL</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;MonitorElapsedHighSQL.dbo.MostElapsedStatisticsByDay&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                 ) </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NULL</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;MonitorElapsedHighSQL.dbo.MostIOReadStatisticsByDay&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                 ) </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NULL</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;MonitorElapsedHighSQL.dbo.MostIOWriteStatisticsByDay&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                 ) </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NULL</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">OBJECT_ID</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;MonitorElapsedHighSQL.dbo.sp_executesqlCountStatisticsByDay&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                 ) </span><span style="color:#D73A49;">IS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NULL</span></span>
<span class="line"><span style="color:#24292E;">           )</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">RETURN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">                 </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">END</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">ELSE</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">--最耗时SQL</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">INSERT  INTO</span><span style="color:#24292E;"> [dbo].[MostElapsedStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;">                        ( [ElapsedMS] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [IOReads] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [IOWrites] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [DBName] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [paramlist] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [planstmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [stmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [xmlplan] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [gettime]</span></span>
<span class="line"><span style="color:#24292E;">                        )</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  [ElapsedMS] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [IOReads] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [IOWrites] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [DBName] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [paramlist] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [planstmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [stmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [xmlplan] ,</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">ROW_NUMBER</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">OVER</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">PARTITION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">BY</span><span style="color:#24292E;"> spid </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [ElapsedMS] </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;"> ) rowid ,</span></span>
<span class="line"><span style="color:#24292E;">                                            </span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">      [ElapsedHigh]</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">     [DBName] </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> ( </span><span style="color:#032F62;">&#39;MASTER&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#032F62;">&#39;MODEL&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;MSDB&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#032F62;">&#39;ReportServer&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#032F62;">&#39;ReportServerTempDB&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#032F62;">&#39;distribution&#39;</span><span style="color:#24292E;"> )</span></span>
<span class="line"><span style="color:#24292E;">                                ) t</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   rowid </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--读IO最多SQL</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">INSERT  INTO</span><span style="color:#24292E;"> [dbo].[MostIOReadStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;">                        ( [IOReads] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [DBName] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [paramlist] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [planstmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [stmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [xmlplan] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [gettime]</span></span>
<span class="line"><span style="color:#24292E;">                        )</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  [IOReads] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [DBName] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [paramlist] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [planstmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [stmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [xmlplan] ,</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">ROW_NUMBER</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">OVER</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">PARTITION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">BY</span><span style="color:#24292E;"> spid </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [IOReads] </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;"> ) rowid ,</span></span>
<span class="line"><span style="color:#24292E;">                                            </span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">      [ElapsedHigh]</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">     [DBName] </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> ( </span><span style="color:#032F62;">&#39;MASTER&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#032F62;">&#39;MODEL&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;MSDB&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#032F62;">&#39;ReportServer&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#032F62;">&#39;ReportServerTempDB&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#032F62;">&#39;distribution&#39;</span><span style="color:#24292E;"> )</span></span>
<span class="line"><span style="color:#24292E;">                                ) t</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   rowid </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--写IO最多SQL</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">INSERT  INTO</span><span style="color:#24292E;"> [dbo].[MostIOWriteStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;">                        ( [IOWrites] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [DBName] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [paramlist] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [planstmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [stmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [xmlplan] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [gettime]</span></span>
<span class="line"><span style="color:#24292E;">                        )</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  [IOWrites] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [DBName] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [paramlist] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [planstmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [stmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [xmlplan] ,</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">ROW_NUMBER</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">OVER</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">PARTITION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">BY</span><span style="color:#24292E;"> spid </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [IOWrites] </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;"> ) rowid ,</span></span>
<span class="line"><span style="color:#24292E;">                                            </span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">      [ElapsedHigh]</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">     [DBName] </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> ( </span><span style="color:#032F62;">&#39;MASTER&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#032F62;">&#39;MODEL&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;MSDB&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#032F62;">&#39;ReportServer&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#032F62;">&#39;ReportServerTempDB&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#032F62;">&#39;distribution&#39;</span><span style="color:#24292E;"> )</span></span>
<span class="line"><span style="color:#24292E;">                                ) t</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   rowid </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--统计sp_executesql次数</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @tbsp_executesqlCountStatisticsByDay </span><span style="color:#D73A49;">TABLE</span></span>
<span class="line"><span style="color:#24292E;">                    (</span></span>
<span class="line"><span style="color:#24292E;">                      [DBName] [nvarchar](</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                      [planstmttext] [nvarchar](MAX)</span></span>
<span class="line"><span style="color:#24292E;">                    )</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @sp_executesqlCount </span><span style="color:#D73A49;">INT</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">INSERT  INTO</span><span style="color:#24292E;"> @tbsp_executesqlCountStatisticsByDay</span></span>
<span class="line"><span style="color:#24292E;">                        ( [DBName] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [planstmttext] </span></span>
<span class="line"><span style="color:#24292E;">                        )</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  [DBName] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [planstmttext]</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    ( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">ROW_NUMBER</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">OVER</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">PARTITION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">BY</span><span style="color:#24292E;"> spid </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [IOWrites] </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;"> ) rowid ,</span></span>
<span class="line"><span style="color:#24292E;">                                            </span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">      [ElapsedHigh]</span></span>
<span class="line"><span style="color:#24292E;">                                  </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">     [planstmttext] </span><span style="color:#D73A49;">LIKE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;(@%&#39;</span></span>
<span class="line"><span style="color:#24292E;">                                            </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> [DBName] </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> ( </span><span style="color:#032F62;">&#39;MASTER&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#032F62;">&#39;MODEL&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;MSDB&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#032F62;">&#39;ReportServer&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#032F62;">&#39;ReportServerTempDB&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                              </span><span style="color:#032F62;">&#39;distribution&#39;</span><span style="color:#24292E;"> )</span></span>
<span class="line"><span style="color:#24292E;">                                ) t</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   rowid </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  @sp_executesqlCount </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">COUNT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    @tbsp_executesqlCountStatisticsByDay</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">INSERT  INTO</span><span style="color:#24292E;"> [dbo].[sp_executesqlCountStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;">                        ( [sp_executesqlCount] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [DBName] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [planstmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [gettime]</span></span>
<span class="line"><span style="color:#24292E;">                        )</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  @sp_executesqlCount ,</span></span>
<span class="line"><span style="color:#24292E;">                                [DBName] ,</span></span>
<span class="line"><span style="color:#24292E;">                                [planstmttext] ,</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    @tbsp_executesqlCountStatisticsByDay</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--统计一共有多少SQL被抓取</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">INSERT  INTO</span><span style="color:#24292E;"> [dbo].[SQLCountStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;">                        ( [SQLCount] ,</span></span>
<span class="line"><span style="color:#24292E;">                          [gettime]</span></span>
<span class="line"><span style="color:#24292E;">                        )</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">COUNT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DISTINCT</span><span style="color:#24292E;"> ( [planstmttext] )) ,</span></span>
<span class="line"><span style="color:#24292E;">                                </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    [dbo].[ElapsedHigh]</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   [DBName] </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IN</span><span style="color:#24292E;"> ( </span><span style="color:#032F62;">&#39;MASTER&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;MODEL&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;MSDB&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                  </span><span style="color:#032F62;">&#39;ReportServer&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                  </span><span style="color:#032F62;">&#39;ReportServerTempDB&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                                                  </span><span style="color:#032F62;">&#39;distribution&#39;</span><span style="color:#24292E;"> )</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">   </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">END</span></span></code></pre></div><h3 id="_1-3-5-创建-usp-sendstatisticsmail-存储过程" tabindex="-1">1.3.5 创建[usp_SendStatisticsMail]存储过程 <a class="header-anchor" href="#_1-3-5-创建-usp-sendstatisticsmail-存储过程" aria-label="Permalink to &quot;1.3.5 创建[usp_SendStatisticsMail]存储过程&quot;">​</a></h3><p><code>注意修改收件人地址和profile_name</code></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [MonitorElapsedHighSQL]</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--对统计数据定时发邮件</span></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">PROCEDURE</span><span style="color:#E1E4E8;"> [dbo].[usp_SendStatisticsMail]</span></span>
<span class="line"><span style="color:#F97583;">AS</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">       </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">--定义变量</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @SQLConcat </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @infoConcat </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @finalSQL </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @DBID </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @servername </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @date </span><span style="color:#F97583;">DATETIME</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @sqlversion </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @uptime </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">--1.数据库版本信息</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  @sqlversion </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @@</span><span style="color:#F97583;">version</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">--2.数据库服务器已运行时间信息</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  @uptime </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">), </span><span style="color:#79B8FF;">DATEDIFF</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DAY</span><span style="color:#E1E4E8;">, sqlserver_start_time, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">sys</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dm_os_sys_info</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WITH</span><span style="color:#E1E4E8;"> ( </span><span style="color:#F97583;">NOLOCK</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">OPTION</span><span style="color:#E1E4E8;">  ( </span><span style="color:#F97583;">RECOMPILE</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">--3.查看数据库服务器名</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  @servername </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">LTRIM</span><span style="color:#E1E4E8;">(@@servername)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @date </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @SQLConcat </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @infoConcat </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39; &#39;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> ( @servername </span><span style="color:#F97583;">IS NOT NULL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> @servername </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @infoConcat </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;h3&gt;&lt;font color=&quot;#FF0000&quot;&gt;主机名：&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @ServerName </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;/font&gt;&lt;/h3&gt;&lt;/br&gt;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> ( @uptime </span><span style="color:#F97583;">IS NOT NULL</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> @uptime </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @infoConcat </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @infoConcat </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;h4&gt;数据库服务器已运行天数：&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @uptime  </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;天&lt;/h4&gt;&lt;/br&gt;&#39;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> ( @sqlversion </span><span style="color:#F97583;">IS NOT NULL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> @sqlversion </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> )</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @infoConcat </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @infoConcat </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;h4&gt;数据库版本信息：&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @sqlversion </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;/h4&gt;&lt;/br&gt;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">-----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;&lt;H3&gt;[&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @servername </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;]_前5条不同的最耗时SQL 表名：[MostElapsedStatisticsByDay] ------   邮件发出时间：&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">), @date, </span><span style="color:#79B8FF;">120</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;/H3&gt;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;table border=&quot;1&quot;&gt;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> N</span><span style="color:#9ECBFF;">&#39;&lt;tr&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[id]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[耗时]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[IO读次数]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[IO写次数]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[数据库名称]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[执行计划SQL]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[日期]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;/tr&gt;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#E1E4E8;">                        [id] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        [ElapsedMS] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        [IOReads] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        [IOWrites] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        [DBName] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#79B8FF;">LEFT</span><span style="color:#E1E4E8;">([planstmttext], </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DATE</span><span style="color:#E1E4E8;">, [gettime]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    [dbo].[MostElapsedStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DAY</span><span style="color:#E1E4E8;">, [gettime]) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DAY</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">MONTH</span><span style="color:#E1E4E8;"> , [gettime]) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">MONTH</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">YEAR</span><span style="color:#E1E4E8;">, [gettime]) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">YEAR</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [ElapsedMS] </span><span style="color:#F97583;">DESC</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#F97583;">FOR</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PATH</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;tr&#39;</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">ELEMENTS</span><span style="color:#6A737D;">-- TYPE </span></span>
<span class="line"><span style="color:#E1E4E8;">              ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX)) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;&lt;/table&gt;&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">PRINT</span><span style="color:#E1E4E8;"> @SQL</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> ( @SQL </span><span style="color:#F97583;">IS NOT NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">           )</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @SQLConcat </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @SQLConcat</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">--------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;&lt;H3&gt;[&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @servername </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;]_前5条I/O read最多的SQL 表名：[MostIOReadStatisticsByDay]------   邮件发出时间：&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">), @date, </span><span style="color:#79B8FF;">120</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;/H3&gt;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;table border=&quot;1&quot;&gt;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> N</span><span style="color:#9ECBFF;">&#39;&lt;tr&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[id]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[IO读次数]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[数据库名称]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[执行计划SQL]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[日期]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;/tr&gt;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#E1E4E8;">                        [id] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        [IOReads] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        [DBName] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#79B8FF;">LEFT</span><span style="color:#E1E4E8;">([planstmttext], </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DATE</span><span style="color:#E1E4E8;">, [gettime]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    [dbo].[MostIOReadStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DAY</span><span style="color:#E1E4E8;">, [gettime]) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DAY</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">MONTH</span><span style="color:#E1E4E8;"> , [gettime]) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">MONTH</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">YEAR</span><span style="color:#E1E4E8;">, [gettime]) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">YEAR</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [IOReads] </span><span style="color:#F97583;">DESC</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#F97583;">FOR</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PATH</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;tr&#39;</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">ELEMENTS</span><span style="color:#6A737D;">-- TYPE </span></span>
<span class="line"><span style="color:#E1E4E8;">              ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX)) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;&lt;/table&gt;&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">     </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> ( @SQL </span><span style="color:#F97583;">IS NOT NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">           )</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @SQLConcat </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @SQLConcat</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--      -----------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;&lt;H3&gt;[&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @servername </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;]_前5条I/O write最多的SQL 表名：[MostIOWriteStatisticsByDay]------   邮件发出时间：&#39;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">), @date, </span><span style="color:#79B8FF;">120</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;/H3&gt;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;table border=&quot;1&quot;&gt;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> N</span><span style="color:#9ECBFF;">&#39;&lt;tr&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[id]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[IO写次数]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[数据库名称]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[执行计划SQL]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[日期]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;/tr&gt;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#E1E4E8;">                        [id] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        [IOWrites] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        [DBName] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#79B8FF;">LEFT</span><span style="color:#E1E4E8;">([planstmttext], </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DATE</span><span style="color:#E1E4E8;">, [gettime]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    [dbo].[MostIOWriteStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DAY</span><span style="color:#E1E4E8;">, [gettime]) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DAY</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">MONTH</span><span style="color:#E1E4E8;"> , [gettime]) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">MONTH</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">YEAR</span><span style="color:#E1E4E8;">, [gettime]) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">YEAR</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [IOWrites] </span><span style="color:#F97583;">DESC</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#F97583;">FOR</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PATH</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;tr&#39;</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">ELEMENTS</span><span style="color:#6A737D;">-- TYPE </span></span>
<span class="line"><span style="color:#E1E4E8;">              ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX)) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;&lt;/table&gt;&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> ( @SQL </span><span style="color:#F97583;">IS NOT NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">           )</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @SQLConcat </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @SQLConcat</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--      -------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;&lt;H3&gt;[&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @servername </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;]_前5条使用sp_executesql执行的SQL 表名：[sp_executesqlCountStatisticsByDay]------   邮件发出时间：&#39;</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">), @date, </span><span style="color:#79B8FF;">120</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;/H3&gt;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;table border=&quot;1&quot;&gt;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> N</span><span style="color:#9ECBFF;">&#39;&lt;tr&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[id]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[sp_executesql调用次数]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[数据库名称]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[执行计划SQL]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[日期]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;/tr&gt;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TOP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#E1E4E8;">                        [id] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        [sp_executesqlCount] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        [DBName] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#79B8FF;">LEFT</span><span style="color:#E1E4E8;">([planstmttext], </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DATE</span><span style="color:#E1E4E8;">, [gettime]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    [dbo].[sp_executesqlCountStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DAY</span><span style="color:#E1E4E8;">, [gettime]) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DAY</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">MONTH</span><span style="color:#E1E4E8;"> , [gettime]) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">MONTH</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">YEAR</span><span style="color:#E1E4E8;">, [gettime]) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">YEAR</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> [sp_executesqlCount] </span><span style="color:#F97583;">DESC</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#F97583;">FOR</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PATH</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;tr&#39;</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">ELEMENTS</span><span style="color:#6A737D;">-- TYPE </span></span>
<span class="line"><span style="color:#E1E4E8;">              ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX)) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;&lt;/table&gt;&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">     </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> ( @SQL </span><span style="color:#F97583;">IS NOT NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">           )</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @SQLConcat </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @SQLConcat</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--      --------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;&lt;H3&gt;[&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @servername</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;]_SQL语句数量 表名：[SQLCountStatisticsByDay]------   邮件发出时间：&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">), @date, </span><span style="color:#79B8FF;">120</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;/H3&gt;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;table border=&quot;1&quot;&gt;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> N</span><span style="color:#9ECBFF;">&#39;&lt;tr&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[id]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[SQL数量]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;th&gt;[日期]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">&lt;/tr&gt;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(( </span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;">  [id] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        [SQLCount] </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#79B8FF;">CONVERT</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DATE</span><span style="color:#E1E4E8;">, [gettime]) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;td&#39;</span><span style="color:#E1E4E8;"> ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">    [dbo].[SQLCountStatisticsByDay]</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DAY</span><span style="color:#E1E4E8;">, [gettime]) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">DAY</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">MONTH</span><span style="color:#E1E4E8;"> , [gettime]) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">MONTH</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">()) </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">YEAR</span><span style="color:#E1E4E8;">, [gettime]) </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">DATEPART</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">YEAR</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">GETDATE</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#F97583;">FOR</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">XML</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">PATH</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;tr&#39;</span><span style="color:#E1E4E8;">) ,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">ELEMENTS</span><span style="color:#6A737D;">-- TYPE </span></span>
<span class="line"><span style="color:#E1E4E8;">              ) </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NVARCHAR</span><span style="color:#E1E4E8;">(MAX)) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;&lt;/table&gt;&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> ( @SQL </span><span style="color:#F97583;">IS NOT NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">           )</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @SQLConcat </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @SQL </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @SQLConcat</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">-----------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> ( @infoConcat </span><span style="color:#F97583;">IS NOT NULL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> @infoConcat </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> @SQLConcat </span><span style="color:#F97583;">IS NOT NULL</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> @SQLConcat </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">SET</span><span style="color:#E1E4E8;"> @finalSQL </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @infoConcat </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;&lt;/br&gt;&lt;/br&gt;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> @SQLConcat</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> [msdb].[dbo].[sp_send_dbmail] @profile_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;SQLServer&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    @recipients </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;dba@xx.com&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">-- varchar(max) --收件人</span></span>
<span class="line"><span style="color:#E1E4E8;">                    @subject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;SQL Server 实例SQL语句抓取统计信息&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">-- nvarchar(255) 标题</span></span>
<span class="line"><span style="color:#E1E4E8;">                    @body_format </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;HTML&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">-- varchar(20) 正文格式可选值：text html</span></span>
<span class="line"><span style="color:#E1E4E8;">                    @body </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @finalSQL</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">     </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">END</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [MonitorElapsedHighSQL]</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--对统计数据定时发邮件</span></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">PROCEDURE</span><span style="color:#24292E;"> [dbo].[usp_SendStatisticsMail]</span></span>
<span class="line"><span style="color:#D73A49;">AS</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">       </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">--定义变量</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @SQLConcat </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @infoConcat </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @finalSQL </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @DBID </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @servername </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @date </span><span style="color:#D73A49;">DATETIME</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @sqlversion </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @uptime </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">--1.数据库版本信息</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  @sqlversion </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @@</span><span style="color:#D73A49;">version</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">--2.数据库服务器已运行时间信息</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  @uptime </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">), </span><span style="color:#005CC5;">DATEDIFF</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DAY</span><span style="color:#24292E;">, sqlserver_start_time, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">sys</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dm_os_sys_info</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WITH</span><span style="color:#24292E;"> ( </span><span style="color:#D73A49;">NOLOCK</span><span style="color:#24292E;"> )</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">OPTION</span><span style="color:#24292E;">  ( </span><span style="color:#D73A49;">RECOMPILE</span><span style="color:#24292E;"> )</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">--3.查看数据库服务器名</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  @servername </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">LTRIM</span><span style="color:#24292E;">(@@servername)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @date </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @SQLConcat </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @infoConcat </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39; &#39;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> ( @servername </span><span style="color:#D73A49;">IS NOT NULL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> @servername </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> )</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @infoConcat </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;h3&gt;&lt;font color=&quot;#FF0000&quot;&gt;主机名：&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @ServerName </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;/font&gt;&lt;/h3&gt;&lt;/br&gt;&#39;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> ( @uptime </span><span style="color:#D73A49;">IS NOT NULL</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> @uptime </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> )</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @infoConcat </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @infoConcat </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;h4&gt;数据库服务器已运行天数：&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @uptime  </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;天&lt;/h4&gt;&lt;/br&gt;&#39;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> ( @sqlversion </span><span style="color:#D73A49;">IS NOT NULL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> @sqlversion </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> )</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @infoConcat </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @infoConcat </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;h4&gt;数据库版本信息：&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @sqlversion </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;/h4&gt;&lt;/br&gt;&#39;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">-----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;&lt;H3&gt;[&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @servername </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;]_前5条不同的最耗时SQL 表名：[MostElapsedStatisticsByDay] ------   邮件发出时间：&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">), @date, </span><span style="color:#005CC5;">120</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;/H3&gt;&#39;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;table border=&quot;1&quot;&gt;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> N</span><span style="color:#032F62;">&#39;&lt;tr&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[id]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[耗时]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[IO读次数]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[IO写次数]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[数据库名称]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[执行计划SQL]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[日期]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;/tr&gt;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span></span>
<span class="line"><span style="color:#24292E;">                        [id] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        [ElapsedMS] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        [IOReads] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        [IOWrites] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        [DBName] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#005CC5;">LEFT</span><span style="color:#24292E;">([planstmttext], </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DATE</span><span style="color:#24292E;">, [gettime]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    [dbo].[MostElapsedStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DAY</span><span style="color:#24292E;">, [gettime]) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DAY</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">MONTH</span><span style="color:#24292E;"> , [gettime]) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">MONTH</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">YEAR</span><span style="color:#24292E;">, [gettime]) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">YEAR</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">())</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [ElapsedMS] </span><span style="color:#D73A49;">DESC</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#D73A49;">FOR</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PATH</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;tr&#39;</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">ELEMENTS</span><span style="color:#6A737D;">-- TYPE </span></span>
<span class="line"><span style="color:#24292E;">              ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX)) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;&lt;/table&gt;&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">PRINT</span><span style="color:#24292E;"> @SQL</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> ( @SQL </span><span style="color:#D73A49;">IS NOT NULL</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292E;">           )</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @SQLConcat </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @SQLConcat</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">--------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;&lt;H3&gt;[&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @servername </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;]_前5条I/O read最多的SQL 表名：[MostIOReadStatisticsByDay]------   邮件发出时间：&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">), @date, </span><span style="color:#005CC5;">120</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;/H3&gt;&#39;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;table border=&quot;1&quot;&gt;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> N</span><span style="color:#032F62;">&#39;&lt;tr&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[id]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[IO读次数]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[数据库名称]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[执行计划SQL]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[日期]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;/tr&gt;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span></span>
<span class="line"><span style="color:#24292E;">                        [id] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        [IOReads] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        [DBName] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#005CC5;">LEFT</span><span style="color:#24292E;">([planstmttext], </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DATE</span><span style="color:#24292E;">, [gettime]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    [dbo].[MostIOReadStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DAY</span><span style="color:#24292E;">, [gettime]) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DAY</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">MONTH</span><span style="color:#24292E;"> , [gettime]) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">MONTH</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">YEAR</span><span style="color:#24292E;">, [gettime]) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">YEAR</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">())</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [IOReads] </span><span style="color:#D73A49;">DESC</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#D73A49;">FOR</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PATH</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;tr&#39;</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">ELEMENTS</span><span style="color:#6A737D;">-- TYPE </span></span>
<span class="line"><span style="color:#24292E;">              ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX)) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;&lt;/table&gt;&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">     </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> ( @SQL </span><span style="color:#D73A49;">IS NOT NULL</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292E;">           )</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @SQLConcat </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @SQLConcat</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--      -----------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;&lt;H3&gt;[&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @servername </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;]_前5条I/O write最多的SQL 表名：[MostIOWriteStatisticsByDay]------   邮件发出时间：&#39;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">), @date, </span><span style="color:#005CC5;">120</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;/H3&gt;&#39;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;table border=&quot;1&quot;&gt;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> N</span><span style="color:#032F62;">&#39;&lt;tr&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[id]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[IO写次数]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[数据库名称]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[执行计划SQL]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[日期]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;/tr&gt;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span></span>
<span class="line"><span style="color:#24292E;">                        [id] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        [IOWrites] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        [DBName] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#005CC5;">LEFT</span><span style="color:#24292E;">([planstmttext], </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DATE</span><span style="color:#24292E;">, [gettime]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    [dbo].[MostIOWriteStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DAY</span><span style="color:#24292E;">, [gettime]) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DAY</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">MONTH</span><span style="color:#24292E;"> , [gettime]) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">MONTH</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">YEAR</span><span style="color:#24292E;">, [gettime]) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">YEAR</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">())</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [IOWrites] </span><span style="color:#D73A49;">DESC</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#D73A49;">FOR</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PATH</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;tr&#39;</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">ELEMENTS</span><span style="color:#6A737D;">-- TYPE </span></span>
<span class="line"><span style="color:#24292E;">              ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX)) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;&lt;/table&gt;&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">      </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> ( @SQL </span><span style="color:#D73A49;">IS NOT NULL</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292E;">           )</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @SQLConcat </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @SQLConcat</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--      -------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;&lt;H3&gt;[&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @servername </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;]_前5条使用sp_executesql执行的SQL 表名：[sp_executesqlCountStatisticsByDay]------   邮件发出时间：&#39;</span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">), @date, </span><span style="color:#005CC5;">120</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;/H3&gt;&#39;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;table border=&quot;1&quot;&gt;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> N</span><span style="color:#032F62;">&#39;&lt;tr&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[id]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[sp_executesql调用次数]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[数据库名称]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[执行计划SQL]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[日期]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;/tr&gt;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TOP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span></span>
<span class="line"><span style="color:#24292E;">                        [id] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        [sp_executesqlCount] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        [DBName] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#005CC5;">LEFT</span><span style="color:#24292E;">([planstmttext], </span><span style="color:#005CC5;">100</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DATE</span><span style="color:#24292E;">, [gettime]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    [dbo].[sp_executesqlCountStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DAY</span><span style="color:#24292E;">, [gettime]) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DAY</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">MONTH</span><span style="color:#24292E;"> , [gettime]) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">MONTH</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">YEAR</span><span style="color:#24292E;">, [gettime]) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">YEAR</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">())</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> [sp_executesqlCount] </span><span style="color:#D73A49;">DESC</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#D73A49;">FOR</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PATH</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;tr&#39;</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">ELEMENTS</span><span style="color:#6A737D;">-- TYPE </span></span>
<span class="line"><span style="color:#24292E;">              ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX)) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;&lt;/table&gt;&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">     </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> ( @SQL </span><span style="color:#D73A49;">IS NOT NULL</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292E;">           )</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @SQLConcat </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @SQLConcat</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">--      --------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;&lt;H3&gt;[&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @servername</span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;]_SQL语句数量 表名：[SQLCountStatisticsByDay]------   邮件发出时间：&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">), @date, </span><span style="color:#005CC5;">120</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;/H3&gt;&#39;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;table border=&quot;1&quot;&gt;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> N</span><span style="color:#032F62;">&#39;&lt;tr&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[id]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[SQL数量]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;th&gt;[日期]&lt;/th&gt;</span></span>
<span class="line"><span style="color:#032F62;">&lt;/tr&gt;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(( </span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;">  [id] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        [SQLCount] </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#005CC5;">CONVERT</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DATE</span><span style="color:#24292E;">, [gettime]) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;td&#39;</span><span style="color:#24292E;"> ,</span></span>
<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">    [dbo].[SQLCountStatisticsByDay]</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DAY</span><span style="color:#24292E;">, [gettime]) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">DAY</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">MONTH</span><span style="color:#24292E;"> , [gettime]) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">MONTH</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">()) </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">YEAR</span><span style="color:#24292E;">, [gettime]) </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">DATEPART</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">YEAR</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">GETDATE</span><span style="color:#24292E;">())</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#D73A49;">FOR</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">XML</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">PATH</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;tr&#39;</span><span style="color:#24292E;">) ,</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#D73A49;">ELEMENTS</span><span style="color:#6A737D;">-- TYPE </span></span>
<span class="line"><span style="color:#24292E;">              ) </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NVARCHAR</span><span style="color:#24292E;">(MAX)) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;&lt;/table&gt;&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">      </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> ( @SQL </span><span style="color:#D73A49;">IS NOT NULL</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span></span>
<span class="line"><span style="color:#24292E;">           )</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @SQLConcat </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @SQL </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @SQLConcat</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">-----------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> ( @infoConcat </span><span style="color:#D73A49;">IS NOT NULL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> @infoConcat </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> @SQLConcat </span><span style="color:#D73A49;">IS NOT NULL</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> @SQLConcat </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">SET</span><span style="color:#24292E;"> @finalSQL </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @infoConcat </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;&lt;/br&gt;&lt;/br&gt;&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> @SQLConcat</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> [msdb].[dbo].[sp_send_dbmail] @profile_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;SQLServer&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                    @recipients </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;dba@xx.com&#39;</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">-- varchar(max) --收件人</span></span>
<span class="line"><span style="color:#24292E;">                    @subject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;SQL Server 实例SQL语句抓取统计信息&#39;</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">-- nvarchar(255) 标题</span></span>
<span class="line"><span style="color:#24292E;">                    @body_format </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;HTML&#39;</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">-- varchar(20) 正文格式可选值：text html</span></span>
<span class="line"><span style="color:#24292E;">                    @body </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @finalSQL</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">     </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">END</span></span></code></pre></div><h3 id="_1-3-6-创建autocaptureelapsedhighsql作业" tabindex="-1">1.3.6 创建AutocaptureElapsedHighSQL作业 <a class="header-anchor" href="#_1-3-6-创建autocaptureelapsedhighsql作业" aria-label="Permalink to &quot;1.3.6 创建AutocaptureElapsedHighSQL作业&quot;">​</a></h3><p><code>需要开启serverAgent</code></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [msdb]</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  Job [自动抓取耗时SQL]    脚本日期: 07/29/2014 15:44:57 ******/</span></span>
<span class="line"><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRANSACTION</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">INT</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  JobCategory [[Uncategorized (Local)]]]    脚本日期: 07/29/2014 15:44:57 ******/</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">EXISTS</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.syscategories </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name=</span><span style="color:#9ECBFF;">N&#39;[Uncategorized (Local)]&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> category_class</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_category @class</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;JOB&#39;</span><span style="color:#E1E4E8;">, @type</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;LOCAL&#39;</span><span style="color:#E1E4E8;">, @name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;[Uncategorized (Local)]&#39;</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @jobId </span><span style="color:#F97583;">BINARY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_job @job_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;AutocaptureElapsedHighSQL&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @enabled</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @notify_level_eventlog</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @notify_level_email</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @notify_level_netsend</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @notify_level_page</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @delete_level</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @description</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;自动抓取耗时SQL&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @category_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;[Uncategorized (Local)]&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @owner_login_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;sa&#39;</span><span style="color:#E1E4E8;">, @job_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @jobId </span><span style="color:#F97583;">OUTPUT</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  Step [execute usp_checkElapsedHighSQL script]    脚本日期: 07/29/2014 15:44:58 ******/</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_jobstep  @job_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;AutocaptureElapsedHighSQL&#39;</span><span style="color:#E1E4E8;">, @step_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;execute usp_checkElapsedHighSQL script&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @step_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @cmdexec_success_code</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @on_success_action</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @on_success_step_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @on_fail_action</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @on_fail_step_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @retry_attempts</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @retry_interval</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @os_run_priority</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, @subsystem</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;TSQL&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @command</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;exec [dbo].[usp_checkElapsedHighSQL] null&#39;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">--调用存储过程</span></span>
<span class="line"><span style="color:#E1E4E8;">        @database_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;MonitorElapsedHighSQL&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @flags</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_update_job @job_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @jobId, @start_step_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_jobschedule @job_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;AutocaptureElapsedHighSQL&#39;</span><span style="color:#E1E4E8;">, @name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;ScheduleAutocaptureCheck&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @enabled</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_type</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_interval</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_subday_type</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_subday_interval</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">--每一分钟抓取一次耗时SQL</span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_relative_interval</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_recurrence_factor</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @active_start_date</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">20110224</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @active_end_date</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">99991231</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @active_start_time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @active_end_time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">235959</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_jobserver @job_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;AutocaptureElapsedHighSQL&#39;</span><span style="color:#E1E4E8;">, @server_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;(local)&#39;</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#F97583;">COMMIT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRANSACTION</span></span>
<span class="line"><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> EndSave</span></span>
<span class="line"><span style="color:#E1E4E8;">QuitWithRollback:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@TRANCOUNT </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">ROLLBACK</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRANSACTION</span></span>
<span class="line"><span style="color:#E1E4E8;">EndSave:</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [msdb]</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  Job [自动抓取耗时SQL]    脚本日期: 07/29/2014 15:44:57 ******/</span></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRANSACTION</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">INT</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  JobCategory [[Uncategorized (Local)]]]    脚本日期: 07/29/2014 15:44:57 ******/</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">EXISTS</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.syscategories </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name=</span><span style="color:#032F62;">N&#39;[Uncategorized (Local)]&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> category_class</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_category @class</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;JOB&#39;</span><span style="color:#24292E;">, @type</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;LOCAL&#39;</span><span style="color:#24292E;">, @name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;[Uncategorized (Local)]&#39;</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @jobId </span><span style="color:#D73A49;">BINARY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_job @job_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;AutocaptureElapsedHighSQL&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @enabled</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @notify_level_eventlog</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @notify_level_email</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @notify_level_netsend</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @notify_level_page</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @delete_level</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @description</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;自动抓取耗时SQL&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @category_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;[Uncategorized (Local)]&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @owner_login_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;sa&#39;</span><span style="color:#24292E;">, @job_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @jobId </span><span style="color:#D73A49;">OUTPUT</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  Step [execute usp_checkElapsedHighSQL script]    脚本日期: 07/29/2014 15:44:58 ******/</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_jobstep  @job_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;AutocaptureElapsedHighSQL&#39;</span><span style="color:#24292E;">, @step_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;execute usp_checkElapsedHighSQL script&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @step_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @cmdexec_success_code</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @on_success_action</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @on_success_step_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @on_fail_action</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @on_fail_step_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @retry_attempts</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @retry_interval</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @os_run_priority</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, @subsystem</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;TSQL&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @command</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;exec [dbo].[usp_checkElapsedHighSQL] null&#39;</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;">--调用存储过程</span></span>
<span class="line"><span style="color:#24292E;">        @database_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;MonitorElapsedHighSQL&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @flags</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_update_job @job_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @jobId, @start_step_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_jobschedule @job_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;AutocaptureElapsedHighSQL&#39;</span><span style="color:#24292E;">, @name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;ScheduleAutocaptureCheck&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @enabled</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_type</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_interval</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_subday_type</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_subday_interval</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">--每一分钟抓取一次耗时SQL</span></span>
<span class="line"><span style="color:#24292E;">        @freq_relative_interval</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_recurrence_factor</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @active_start_date</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">20110224</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @active_end_date</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">99991231</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @active_start_time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @active_end_time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">235959</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_jobserver @job_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;AutocaptureElapsedHighSQL&#39;</span><span style="color:#24292E;">, @server_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;(local)&#39;</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#D73A49;">COMMIT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRANSACTION</span></span>
<span class="line"><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> EndSave</span></span>
<span class="line"><span style="color:#24292E;">QuitWithRollback:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@TRANCOUNT </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">ROLLBACK</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRANSACTION</span></span>
<span class="line"><span style="color:#24292E;">EndSave:</span></span></code></pre></div><h3 id="_1-3-7-创建resetcheckelapsedhighsqltbname作业" tabindex="-1">1.3.7 创建ResetcheckElapsedHighSQLtbname作业 <a class="header-anchor" href="#_1-3-7-创建resetcheckelapsedhighsqltbname作业" aria-label="Permalink to &quot;1.3.7 创建ResetcheckElapsedHighSQLtbname作业&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [msdb]</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  Job [定时改表名]    脚本日期: 07/29/2014 15:44:57 ******/</span></span>
<span class="line"><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRANSACTION</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">INT</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  JobCategory [[Uncategorized (Local)]]]    脚本日期: 07/29/2014 15:44:57 ******/</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">EXISTS</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.syscategories </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name=</span><span style="color:#9ECBFF;">N&#39;[Uncategorized (Local)]&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> category_class</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_category @class</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;JOB&#39;</span><span style="color:#E1E4E8;">, @type</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;LOCAL&#39;</span><span style="color:#E1E4E8;">, @name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;[Uncategorized (Local)]&#39;</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @jobId </span><span style="color:#F97583;">BINARY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_job @job_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;ResetcheckElapsedHighSQLtbname&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @enabled</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @notify_level_eventlog</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @notify_level_email</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @notify_level_netsend</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @notify_level_page</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @delete_level</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @description</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;修改抓取耗时SQL的表名&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @category_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;[Uncategorized (Local)]&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @owner_login_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;sa&#39;</span><span style="color:#E1E4E8;">, @job_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @jobId </span><span style="color:#F97583;">OUTPUT</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  Step [execute usp_checkElapsedHighSQL script]    脚本日期: 07/29/2014 15:44:58 ******/</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_jobstep  @job_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;ResetcheckElapsedHighSQLtbname&#39;</span><span style="color:#E1E4E8;">, @step_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;execute usp_Resettbname script&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @step_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @cmdexec_success_code</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @on_success_action</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @on_success_step_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @on_fail_action</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @on_fail_step_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @retry_attempts</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @retry_interval</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @os_run_priority</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, @subsystem</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;TSQL&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @command</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;exec [dbo].[usp_Resettbname] &#39;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">--调用存储过程</span></span>
<span class="line"><span style="color:#E1E4E8;">        @database_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;MonitorElapsedHighSQL&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @flags</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_update_job @job_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @jobId, @start_step_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_jobschedule @job_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;ResetcheckElapsedHighSQLtbname&#39;</span><span style="color:#E1E4E8;">, @name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;Scheduleusp_Resettbname&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">    @enabled</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_type</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_interval</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_subday_type</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_subday_interval</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_relative_interval</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_recurrence_factor</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @active_start_date</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">20110224</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @active_end_date</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">99991231</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @active_start_time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">235900</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @active_end_time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">235959</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_jobserver @job_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;ResetcheckElapsedHighSQLtbname&#39;</span><span style="color:#E1E4E8;">, @server_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;(local)&#39;</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#F97583;">COMMIT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRANSACTION</span></span>
<span class="line"><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> EndSave</span></span>
<span class="line"><span style="color:#E1E4E8;">QuitWithRollback:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@TRANCOUNT </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">ROLLBACK</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRANSACTION</span></span>
<span class="line"><span style="color:#E1E4E8;">EndSave:</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [msdb]</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  Job [定时改表名]    脚本日期: 07/29/2014 15:44:57 ******/</span></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRANSACTION</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">INT</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  JobCategory [[Uncategorized (Local)]]]    脚本日期: 07/29/2014 15:44:57 ******/</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">EXISTS</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.syscategories </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name=</span><span style="color:#032F62;">N&#39;[Uncategorized (Local)]&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> category_class</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_category @class</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;JOB&#39;</span><span style="color:#24292E;">, @type</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;LOCAL&#39;</span><span style="color:#24292E;">, @name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;[Uncategorized (Local)]&#39;</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @jobId </span><span style="color:#D73A49;">BINARY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_job @job_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;ResetcheckElapsedHighSQLtbname&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @enabled</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @notify_level_eventlog</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @notify_level_email</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @notify_level_netsend</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @notify_level_page</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @delete_level</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @description</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;修改抓取耗时SQL的表名&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @category_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;[Uncategorized (Local)]&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @owner_login_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;sa&#39;</span><span style="color:#24292E;">, @job_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @jobId </span><span style="color:#D73A49;">OUTPUT</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  Step [execute usp_checkElapsedHighSQL script]    脚本日期: 07/29/2014 15:44:58 ******/</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_jobstep  @job_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;ResetcheckElapsedHighSQLtbname&#39;</span><span style="color:#24292E;">, @step_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;execute usp_Resettbname script&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @step_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @cmdexec_success_code</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @on_success_action</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @on_success_step_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @on_fail_action</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @on_fail_step_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @retry_attempts</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @retry_interval</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @os_run_priority</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, @subsystem</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;TSQL&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @command</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;exec [dbo].[usp_Resettbname] &#39;</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;">--调用存储过程</span></span>
<span class="line"><span style="color:#24292E;">        @database_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;MonitorElapsedHighSQL&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @flags</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_update_job @job_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @jobId, @start_step_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_jobschedule @job_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;ResetcheckElapsedHighSQLtbname&#39;</span><span style="color:#24292E;">, @name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;Scheduleusp_Resettbname&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">    @enabled</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_type</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_interval</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_subday_type</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_subday_interval</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_relative_interval</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_recurrence_factor</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @active_start_date</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">20110224</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @active_end_date</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">99991231</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @active_start_time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">235900</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @active_end_time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">235959</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_jobserver @job_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;ResetcheckElapsedHighSQLtbname&#39;</span><span style="color:#24292E;">, @server_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;(local)&#39;</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#D73A49;">COMMIT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRANSACTION</span></span>
<span class="line"><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> EndSave</span></span>
<span class="line"><span style="color:#24292E;">QuitWithRollback:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@TRANCOUNT </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">ROLLBACK</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRANSACTION</span></span>
<span class="line"><span style="color:#24292E;">EndSave:</span></span></code></pre></div><h3 id="_1-3-9-创建statisticsforelapsedhigh作业" tabindex="-1">1.3.9 创建StatisticsforElapsedHigh作业 <a class="header-anchor" href="#_1-3-9-创建statisticsforelapsedhigh作业" aria-label="Permalink to &quot;1.3.9 创建StatisticsforElapsedHigh作业&quot;">​</a></h3><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [msdb]</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  Job [定时统计[ElapsedHigh]表数据]    脚本日期: 07/29/2014 15:44:57 ******/</span></span>
<span class="line"><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRANSACTION</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">INT</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  JobCategory [[Uncategorized (Local)]]]    脚本日期: 07/29/2014 15:44:57 ******/</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">EXISTS</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.syscategories </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name=</span><span style="color:#9ECBFF;">N&#39;[Uncategorized (Local)]&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> category_class</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_category @class</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;JOB&#39;</span><span style="color:#E1E4E8;">, @type</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;LOCAL&#39;</span><span style="color:#E1E4E8;">, @name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;[Uncategorized (Local)]&#39;</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @jobId </span><span style="color:#F97583;">BINARY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_job @job_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;StatisticsforElapsedHigh&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @enabled</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @notify_level_eventlog</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @notify_level_email</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @notify_level_netsend</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @notify_level_page</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @delete_level</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @description</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;统计[MonitorElapsedHighSQL]库里的[ElapsedHigh]表各项数据&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @category_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;[Uncategorized (Local)]&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @owner_login_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;sa&#39;</span><span style="color:#E1E4E8;">, @job_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @jobId </span><span style="color:#F97583;">OUTPUT</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  Step [execute usp_checkElapsedHighSQL script]    脚本日期: 07/29/2014 15:44:58 ******/</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_jobstep  @job_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;StatisticsforElapsedHigh&#39;</span><span style="color:#E1E4E8;">, @step_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;execute usp_StatisticsTask script&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @step_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @cmdexec_success_code</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @on_success_action</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @on_success_step_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @on_fail_action</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @on_fail_step_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @retry_attempts</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @retry_interval</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @os_run_priority</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, @subsystem</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;TSQL&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @command</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;exec [dbo].[usp_StatisticsTask] &#39;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">--调用存储过程</span></span>
<span class="line"><span style="color:#E1E4E8;">        @database_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;MonitorElapsedHighSQL&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @flags</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_update_job @job_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @jobId, @start_step_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_jobschedule @job_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;StatisticsforElapsedHigh&#39;</span><span style="color:#E1E4E8;">, @name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;Scheduleusp_StatisticsTask&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">    @enabled</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_type</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_interval</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_subday_type</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_subday_interval</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_relative_interval</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_recurrence_factor</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @active_start_date</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">20110224</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @active_end_date</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">99991231</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @active_start_time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">235000</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @active_end_time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">235959</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_jobserver @job_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;StatisticsforElapsedHigh&#39;</span><span style="color:#E1E4E8;">, @server_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;(local)&#39;</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#F97583;">COMMIT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRANSACTION</span></span>
<span class="line"><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> EndSave</span></span>
<span class="line"><span style="color:#E1E4E8;">QuitWithRollback:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@TRANCOUNT </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">ROLLBACK</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRANSACTION</span></span>
<span class="line"><span style="color:#E1E4E8;">EndSave:</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [msdb]</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  Job [定时统计[ElapsedHigh]表数据]    脚本日期: 07/29/2014 15:44:57 ******/</span></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRANSACTION</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">INT</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  JobCategory [[Uncategorized (Local)]]]    脚本日期: 07/29/2014 15:44:57 ******/</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">EXISTS</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.syscategories </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name=</span><span style="color:#032F62;">N&#39;[Uncategorized (Local)]&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> category_class</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_category @class</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;JOB&#39;</span><span style="color:#24292E;">, @type</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;LOCAL&#39;</span><span style="color:#24292E;">, @name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;[Uncategorized (Local)]&#39;</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @jobId </span><span style="color:#D73A49;">BINARY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_job @job_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;StatisticsforElapsedHigh&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @enabled</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @notify_level_eventlog</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @notify_level_email</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @notify_level_netsend</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @notify_level_page</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @delete_level</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @description</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;统计[MonitorElapsedHighSQL]库里的[ElapsedHigh]表各项数据&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @category_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;[Uncategorized (Local)]&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @owner_login_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;sa&#39;</span><span style="color:#24292E;">, @job_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @jobId </span><span style="color:#D73A49;">OUTPUT</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  Step [execute usp_checkElapsedHighSQL script]    脚本日期: 07/29/2014 15:44:58 ******/</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_jobstep  @job_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;StatisticsforElapsedHigh&#39;</span><span style="color:#24292E;">, @step_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;execute usp_StatisticsTask script&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @step_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @cmdexec_success_code</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @on_success_action</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @on_success_step_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @on_fail_action</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @on_fail_step_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @retry_attempts</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @retry_interval</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @os_run_priority</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, @subsystem</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;TSQL&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @command</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;exec [dbo].[usp_StatisticsTask] &#39;</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;">--调用存储过程</span></span>
<span class="line"><span style="color:#24292E;">        @database_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;MonitorElapsedHighSQL&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @flags</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_update_job @job_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @jobId, @start_step_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_jobschedule @job_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;StatisticsforElapsedHigh&#39;</span><span style="color:#24292E;">, @name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;Scheduleusp_StatisticsTask&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">    @enabled</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_type</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_interval</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_subday_type</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_subday_interval</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_relative_interval</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_recurrence_factor</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @active_start_date</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">20110224</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @active_end_date</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">99991231</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @active_start_time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">235000</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @active_end_time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">235959</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_jobserver @job_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;StatisticsforElapsedHigh&#39;</span><span style="color:#24292E;">, @server_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;(local)&#39;</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#D73A49;">COMMIT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRANSACTION</span></span>
<span class="line"><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> EndSave</span></span>
<span class="line"><span style="color:#24292E;">QuitWithRollback:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@TRANCOUNT </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">ROLLBACK</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRANSACTION</span></span>
<span class="line"><span style="color:#24292E;">EndSave:</span></span></code></pre></div><h3 id="_1-4-0-创建schedulesendstatisticsmail作业" tabindex="-1">1.4.0 创建ScheduleSendStatisticsMail作业 <a class="header-anchor" href="#_1-4-0-创建schedulesendstatisticsmail作业" aria-label="Permalink to &quot;1.4.0 创建ScheduleSendStatisticsMail作业&quot;">​</a></h3><p><code>注意修改时间,active_start_date</code></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">USE</span><span style="color:#E1E4E8;"> [msdb]</span></span>
<span class="line"><span style="color:#F97583;">GO</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  Job [定时发统计邮件]    脚本日期: 07/29/2014 15:44:57 ******/</span></span>
<span class="line"><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRANSACTION</span></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">INT</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  JobCategory [[Uncategorized (Local)]]]    脚本日期: 07/29/2014 15:44:57 ******/</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">EXISTS</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.syscategories </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">name=</span><span style="color:#9ECBFF;">N&#39;[Uncategorized (Local)]&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AND</span><span style="color:#E1E4E8;"> category_class</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_category @class</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;JOB&#39;</span><span style="color:#E1E4E8;">, @type</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;LOCAL&#39;</span><span style="color:#E1E4E8;">, @name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;[Uncategorized (Local)]&#39;</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">DECLARE</span><span style="color:#E1E4E8;"> @jobId </span><span style="color:#F97583;">BINARY</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_job @job_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;ScheduleSendStatisticsMail&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @enabled</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @notify_level_eventlog</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @notify_level_email</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @notify_level_netsend</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @notify_level_page</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @delete_level</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @description</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;定时发统计邮件&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @category_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;[Uncategorized (Local)]&#39;</span><span style="color:#E1E4E8;">,  </span></span>
<span class="line"><span style="color:#E1E4E8;">        @owner_login_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;sa&#39;</span><span style="color:#E1E4E8;">, @job_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @jobId </span><span style="color:#F97583;">OUTPUT</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  Step [execute usp_checkElapsedHighSQL script]    脚本日期: 07/29/2014 15:44:58 ******/</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_jobstep  @job_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;ScheduleSendStatisticsMail&#39;</span><span style="color:#E1E4E8;">, @step_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;execute usp_SendStatisticsMail script&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @step_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @cmdexec_success_code</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @on_success_action</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @on_success_step_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @on_fail_action</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @on_fail_step_id</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @retry_attempts</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @retry_interval</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @os_run_priority</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, @subsystem</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;TSQL&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @command</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;exec  [dbo].[usp_SendStatisticsMail]&#39;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">--调用存储过程</span></span>
<span class="line"><span style="color:#E1E4E8;">        @database_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;MonitorElapsedHighSQL&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @flags</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_update_job @job_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> @jobId, @start_step_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_jobschedule @job_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;ScheduleSendStatisticsMail&#39;</span><span style="color:#E1E4E8;">, @name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;Scheduleusp_SendStatisticsMail&#39;</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">    @enabled</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_type</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_interval</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_subday_type</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_subday_interval</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_relative_interval</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @freq_recurrence_factor</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @active_start_date</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">20240224</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">--开始时间 </span></span>
<span class="line"><span style="color:#E1E4E8;">        @active_end_date</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">99991231</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @active_start_time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">235500</span><span style="color:#E1E4E8;">, </span></span>
<span class="line"><span style="color:#E1E4E8;">        @active_end_time</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">235959</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#F97583;">EXEC</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">msdb</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">dbo</span><span style="color:#E1E4E8;">.sp_add_jobserver @job_name</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">N&#39;ScheduleSendStatisticsMail&#39;</span><span style="color:#E1E4E8;">, @server_name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">N&#39;(local)&#39;</span></span>
<span class="line"><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@ERROR </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">OR</span><span style="color:#E1E4E8;"> @ReturnCode </span><span style="color:#F97583;">&lt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#F97583;">COMMIT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRANSACTION</span></span>
<span class="line"><span style="color:#F97583;">GOTO</span><span style="color:#E1E4E8;"> EndSave</span></span>
<span class="line"><span style="color:#E1E4E8;">QuitWithRollback:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> (@@TRANCOUNT </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">ROLLBACK</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TRANSACTION</span></span>
<span class="line"><span style="color:#E1E4E8;">EndSave:</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">USE</span><span style="color:#24292E;"> [msdb]</span></span>
<span class="line"><span style="color:#D73A49;">GO</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  Job [定时发统计邮件]    脚本日期: 07/29/2014 15:44:57 ******/</span></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRANSACTION</span></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">INT</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  JobCategory [[Uncategorized (Local)]]]    脚本日期: 07/29/2014 15:44:57 ******/</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">EXISTS</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.syscategories </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">name=</span><span style="color:#032F62;">N&#39;[Uncategorized (Local)]&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AND</span><span style="color:#24292E;"> category_class</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_category @class</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;JOB&#39;</span><span style="color:#24292E;">, @type</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;LOCAL&#39;</span><span style="color:#24292E;">, @name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;[Uncategorized (Local)]&#39;</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">END</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">DECLARE</span><span style="color:#24292E;"> @jobId </span><span style="color:#D73A49;">BINARY</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_job @job_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;ScheduleSendStatisticsMail&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @enabled</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @notify_level_eventlog</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @notify_level_email</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @notify_level_netsend</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @notify_level_page</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @delete_level</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @description</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;定时发统计邮件&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @category_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;[Uncategorized (Local)]&#39;</span><span style="color:#24292E;">,  </span></span>
<span class="line"><span style="color:#24292E;">        @owner_login_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;sa&#39;</span><span style="color:#24292E;">, @job_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @jobId </span><span style="color:#D73A49;">OUTPUT</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#6A737D;">/****** 对象:  Step [execute usp_checkElapsedHighSQL script]    脚本日期: 07/29/2014 15:44:58 ******/</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_jobstep  @job_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;ScheduleSendStatisticsMail&#39;</span><span style="color:#24292E;">, @step_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;execute usp_SendStatisticsMail script&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @step_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @cmdexec_success_code</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @on_success_action</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @on_success_step_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @on_fail_action</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @on_fail_step_id</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @retry_attempts</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @retry_interval</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @os_run_priority</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, @subsystem</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;TSQL&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @command</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;exec  [dbo].[usp_SendStatisticsMail]&#39;</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;">--调用存储过程</span></span>
<span class="line"><span style="color:#24292E;">        @database_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;MonitorElapsedHighSQL&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @flags</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_update_job @job_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> @jobId, @start_step_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_jobschedule @job_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;ScheduleSendStatisticsMail&#39;</span><span style="color:#24292E;">, @name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;Scheduleusp_SendStatisticsMail&#39;</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">    @enabled</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_type</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">4</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_interval</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_subday_type</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_subday_interval</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_relative_interval</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @freq_recurrence_factor</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @active_start_date</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">20240224</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">--开始时间 </span></span>
<span class="line"><span style="color:#24292E;">        @active_end_date</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">99991231</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @active_start_time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">235500</span><span style="color:#24292E;">, </span></span>
<span class="line"><span style="color:#24292E;">        @active_end_time</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">235959</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#D73A49;">EXEC</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">msdb</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">dbo</span><span style="color:#24292E;">.sp_add_jobserver @job_name</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">N&#39;ScheduleSendStatisticsMail&#39;</span><span style="color:#24292E;">, @server_name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">N&#39;(local)&#39;</span></span>
<span class="line"><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@ERROR </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">OR</span><span style="color:#24292E;"> @ReturnCode </span><span style="color:#D73A49;">&lt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> QuitWithRollback</span></span>
<span class="line"><span style="color:#D73A49;">COMMIT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRANSACTION</span></span>
<span class="line"><span style="color:#D73A49;">GOTO</span><span style="color:#24292E;"> EndSave</span></span>
<span class="line"><span style="color:#24292E;">QuitWithRollback:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> (@@TRANCOUNT </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">ROLLBACK</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TRANSACTION</span></span>
<span class="line"><span style="color:#24292E;">EndSave:</span></span></code></pre></div><h1 id="_2-gmail邮箱-废弃" tabindex="-1">2. Gmail邮箱-废弃 <a class="header-anchor" href="#_2-gmail邮箱-废弃" aria-label="Permalink to &quot;2. Gmail邮箱-废弃&quot;">​</a></h1><h2 id="_2-1-登录gmail邮箱" tabindex="-1">2.1 登录gmail邮箱 <a class="header-anchor" href="#_2-1-登录gmail邮箱" aria-label="Permalink to &quot;2.1 登录gmail邮箱&quot;">​</a></h2><h2 id="_2-2-配置" tabindex="-1">2.2 配置 <a class="header-anchor" href="#_2-2-配置" aria-label="Permalink to &quot;2.2 配置&quot;">​</a></h2><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410111456500.png" alt="image-20241011145624617"></p><h3 id="开启imap" tabindex="-1">开启imap <a class="header-anchor" href="#开启imap" aria-label="Permalink to &quot;开启imap&quot;">​</a></h3><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410111457353.png" alt="image-20241011145732561"></p><h3 id="创建-app-密码" tabindex="-1">创建 app 密码 <a class="header-anchor" href="#创建-app-密码" aria-label="Permalink to &quot;创建 app 密码&quot;">​</a></h3><p>记录好这个密码到时候用于<code>登录邮箱使用</code></p><h2 id="_2-3-配置ssm" tabindex="-1">2.3 配置ssm <a class="header-anchor" href="#_2-3-配置ssm" aria-label="Permalink to &quot;2.3 配置ssm&quot;">​</a></h2><p>管理--&gt;数据库邮件</p><h3 id="管理" tabindex="-1">管理 <a class="header-anchor" href="#管理" aria-label="Permalink to &quot;管理&quot;">​</a></h3><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410111531071.png" alt="image-20241011153143722"></p><h3 id="数据库邮件" tabindex="-1">数据库邮件 <a class="header-anchor" href="#数据库邮件" aria-label="Permalink to &quot;数据库邮件&quot;">​</a></h3><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410111533769.png" alt="image-20241011153304241"></p><h3 id="配置邮件" tabindex="-1">配置邮件 <a class="header-anchor" href="#配置邮件" aria-label="Permalink to &quot;配置邮件&quot;">​</a></h3><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410111535692.png" alt="image-20241011153523038"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410111537227.png" alt="image-20241011153730977"></p><ul><li>添加</li></ul><p><a href="https://support.google.com/mail/answer/7104828?hl=zh-Hans&amp;visit_id=638642294209646399-256523825&amp;rd=1" target="_blank" rel="noreferrer">https://support.google.com/mail/answer/7104828?hl=zh-Hans&amp;visit_id=638642294209646399-256523825&amp;rd=1</a></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410111548949.png" alt="image-20241011154851164"></p><p><code>填写独立密码</code></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410111545102.png" alt="image-20241011154518217"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410111549662.png" alt="image-20241011154938224"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410111550204.png" alt="image-20241011155002433"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410111550998.png" alt="image-20241011155022242"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410111550684.png" alt="image-20241011155042481"></p><h3 id="测试发送" tabindex="-1">测试发送 <a class="header-anchor" href="#测试发送" aria-label="Permalink to &quot;测试发送&quot;">​</a></h3><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410111551802.png" alt="image-20241011155145104"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410111552529.png" alt="image-20241011155222490"></p><p><img src="https://nnaigos.oss-cn-hangzhou.aliyuncs.com/imgs/202410111552751.png" alt="image-20241011155239483"></p><p><code>此时会发送失败,google不在允许使用不安全密码登录了</code></p><p><a href="https://developer.aliyun.com/article/1331376" target="_blank" rel="noreferrer">https://developer.aliyun.com/article/1331376</a></p>`,89),e=[o];function t(c,E,r,y,i,F){return n(),a("div",null,e)}const C=s(p,[["render",t]]);export{D as __pageData,C as default};
