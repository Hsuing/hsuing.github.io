import{_ as e,o as s,c as a,R as n}from"./chunks/framework.zUbWieqp.js";const m=JSON.parse('{"title":"1.数据库通用学习路线","description":"","frontmatter":{},"headers":[],"relativePath":"guide/Database/pgSql/index.md","filePath":"guide/Database/pgSql/index.md","lastUpdated":1732012163000}'),p={name:"guide/Database/pgSql/index.md"},l=n(`<p>pg源码：<a href="https://www.postgresql.org/ftp/source/" target="_blank" rel="noreferrer">https://www.postgresql.org/ftp/source/</a></p><ul><li>blog</li></ul><p><a href="https://www.interdb.jp/pg/" target="_blank" rel="noreferrer">https://www.interdb.jp/pg/</a></p><ul><li>视频</li></ul><p><a href="https://www.youtube.com/watch?v=qWJ1X5b1iQM&amp;list=PLAakLuCYPs3jOMHkZ1jlw9COKQLANcbYa" target="_blank" rel="noreferrer">https://www.youtube.com/watch?v=qWJ1X5b1iQM&amp;list=PLAakLuCYPs3jOMHkZ1jlw9COKQLANcbYa</a></p><h1 id="_1-数据库通用学习路线" tabindex="-1">1.数据库通用学习路线 <a class="header-anchor" href="#_1-数据库通用学习路线" aria-label="Permalink to &quot;1.数据库通用学习路线&quot;">​</a></h1><h2 id="_1-1安装部署" tabindex="-1">1.1安装部署 <a class="header-anchor" href="#_1-1安装部署" aria-label="Permalink to &quot;1.1安装部署&quot;">​</a></h2><ul><li>单机部署：rpm,二进制、yum 安装、docker、源码编译</li><li>环境变量配置</li><li>配置远程登录</li><li>连接数据库命令工具</li><li>db和实例关系</li><li>升级(大版本升级、小版本升级)</li><li>高可用搭建</li></ul><h1 id="_2-体系结构" tabindex="-1">2.体系结构 <a class="header-anchor" href="#_2-体系结构" aria-label="Permalink to &quot;2.体系结构&quot;">​</a></h1><p>1.物理结构：物理文件</p><p>2.逻辑结构：逻辑组件</p><p>3.内存结构：</p><p>4.进程结构：</p><p>5.存储结构：</p><h1 id="_3-备份恢复-客户端和服务端" tabindex="-1">3.备份恢复(客户端和服务端) <a class="header-anchor" href="#_3-备份恢复-客户端和服务端" aria-label="Permalink to &quot;3.备份恢复(客户端和服务端)&quot;">​</a></h1><p>1.逻辑备份</p><p>2.物理备份：（全量-增量）</p><p>3.文本导出导入</p><p>4.闪回</p><p>5.基于时间点恢复</p><h1 id="_4-高可用" tabindex="-1">4.高可用 <a class="header-anchor" href="#_4-高可用" aria-label="Permalink to &quot;4.高可用&quot;">​</a></h1><p>1.物理复制（DG、流复制）</p><p>2.逻辑复制（逻辑DG、逻辑订阅、主从）</p><p>3.故障转移</p><h1 id="_5-监控" tabindex="-1">5.监控 <a class="header-anchor" href="#_5-监控" aria-label="Permalink to &quot;5.监控&quot;">​</a></h1><p>1.zabbix</p><p>2.普罗米修斯</p><h1 id="_6-sql基础" tabindex="-1">6.sql基础 <a class="header-anchor" href="#_6-sql基础" aria-label="Permalink to &quot;6.sql基础&quot;">​</a></h1><p>1.sql基础</p><p>2.数据类型</p><h1 id="_7-优化" tabindex="-1">7.优化 <a class="header-anchor" href="#_7-优化" aria-label="Permalink to &quot;7.优化&quot;">​</a></h1><p>1.os优化，参数，网络，存储</p><p>2.pg参数优化</p><p>3.pg架构优化（分库表表，读写分离）</p><p>4.sql语句优化</p><p>日常管理</p><p><a href="https://www.cnblogs.com/helon/category/1500929.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/helon/category/1500929.html</a></p><ul><li>结构图</li></ul><p><a href="https://pgstats.dev/?version=13" target="_blank" rel="noreferrer">https://pgstats.dev/?version=13</a></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">vi /etc/security/limits.conf  </span></span>
<span class="line"><span style="color:#e1e4e8;">  </span></span>
<span class="line"><span style="color:#e1e4e8;">* soft    nofile  10240000  </span></span>
<span class="line"><span style="color:#e1e4e8;">* hard    nofile  10240000</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">vi /etc/sysctl.conf  </span></span>
<span class="line"><span style="color:#e1e4e8;">  </span></span>
<span class="line"><span style="color:#e1e4e8;">fs.nr_open=10240000  </span></span>
<span class="line"><span style="color:#e1e4e8;">  </span></span>
<span class="line"><span style="color:#e1e4e8;">sysctl -p </span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">内核参数</span></span>
<span class="line"><span style="color:#e1e4e8;">具体的内核参数的解释可以查看http://man7.org/linux/man-pages/man5/proc.5.html</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">/proc/sys/fs/file-max</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">操作系统级别的限制，所有进程打开的文件数之和不能超过这个值</span></span>
<span class="line"><span style="color:#e1e4e8;">/proc/sys/fs/file-nr</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">操作系统级别的参数，查看当前已经打开的文件数以及操作系统允许的最大值</span></span>
<span class="line"><span style="color:#e1e4e8;">/proc/sys/fs/nr_open</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">进程级别的参数，限制每个进程能打开的最大文件数</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">vi /etc/security/limits.conf  </span></span>
<span class="line"><span style="color:#24292e;">  </span></span>
<span class="line"><span style="color:#24292e;">* soft    nofile  10240000  </span></span>
<span class="line"><span style="color:#24292e;">* hard    nofile  10240000</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">vi /etc/sysctl.conf  </span></span>
<span class="line"><span style="color:#24292e;">  </span></span>
<span class="line"><span style="color:#24292e;">fs.nr_open=10240000  </span></span>
<span class="line"><span style="color:#24292e;">  </span></span>
<span class="line"><span style="color:#24292e;">sysctl -p </span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">内核参数</span></span>
<span class="line"><span style="color:#24292e;">具体的内核参数的解释可以查看http://man7.org/linux/man-pages/man5/proc.5.html</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">/proc/sys/fs/file-max</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">操作系统级别的限制，所有进程打开的文件数之和不能超过这个值</span></span>
<span class="line"><span style="color:#24292e;">/proc/sys/fs/file-nr</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">操作系统级别的参数，查看当前已经打开的文件数以及操作系统允许的最大值</span></span>
<span class="line"><span style="color:#24292e;">/proc/sys/fs/nr_open</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">进程级别的参数，限制每个进程能打开的最大文件数</span></span></code></pre></div><p><a href="https://blog.csdn.net/qq_29914837/article/details/103762121" target="_blank" rel="noreferrer">https://blog.csdn.net/qq_29914837/article/details/103762121</a></p><p>lua</p><p><a href="https://segmentfault.com/a/1190000012233483" target="_blank" rel="noreferrer">https://segmentfault.com/a/1190000012233483</a></p><p><a href="http://blog.itpub.net/30126024/viewspace-2661690/" target="_blank" rel="noreferrer">http://blog.itpub.net/30126024/viewspace-2661690/</a></p><p><a href="https://www.cnblogs.com/zhoujinyi/p/10939715.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/zhoujinyi/p/10939715.html</a></p><p>主备</p><p><a href="https://www.percona.com/blog/2019/10/11/how-to-set-up-streaming-replication-in-postgresql-12/" target="_blank" rel="noreferrer">https://www.percona.com/blog/2019/10/11/how-to-set-up-streaming-replication-in-postgresql-12/</a></p><p><a href="http://blog.itpub.net/6906/viewspace-2663742/" target="_blank" rel="noreferrer">http://blog.itpub.net/6906/viewspace-2663742/</a></p><p><a href="https://blog.csdn.net/hoofire/article/details/102663324" target="_blank" rel="noreferrer">https://blog.csdn.net/hoofire/article/details/102663324</a></p><p>备份</p><p><a href="https://www.iteye.com/blog/toplchx-2093821" target="_blank" rel="noreferrer">https://www.iteye.com/blog/toplchx-2093821</a></p><p>密码</p><p><a href="https://www.cnblogs.com/xibuhaohao/p/11471344.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/xibuhaohao/p/11471344.html</a></p><p><a href="https://qiita.com/tmiki/items/00d22edc6a554f61bd04" target="_blank" rel="noreferrer">https://qiita.com/tmiki/items/00d22edc6a554f61bd04</a></p><p>ss</p><p>Prometheus</p><p><a href="https://www.cnblogs.com/guoxiangyue/p/11772717.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/guoxiangyue/p/11772717.html</a></p><p><a href="https://cloud.tencent.com/developer/article/1492514" target="_blank" rel="noreferrer">https://cloud.tencent.com/developer/article/1492514</a></p><p>在线生成配置</p><p><a href="https://pgtune.leopard.in.ua/#/" target="_blank" rel="noreferrer">https://pgtune.leopard.in.ua/#/</a></p><p><strong>postgres 自带的 psql 可以tab键自动补全，可以方向键移动光标，上下键查找过去的命令</strong></p><p><strong>字符串用单引号扩起来，结尾使用分号结束</strong>，没打分号就回车其实是换行</p><p>数据结构</p><p><a href="https://blog.csdn.net/ningyuanhuo/article/details/7644678?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-18.nonecase&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-18.nonecase" target="_blank" rel="noreferrer">https://blog.csdn.net/ningyuanhuo/article/details/7644678?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-18.nonecase&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-18.nonecase</a></p><p>pg 运维</p><p><a href="https://www.modb.pro/db/28233" target="_blank" rel="noreferrer">https://www.modb.pro/db/28233</a></p><p>doc</p><p><a href="http://www.postgres.cn/index.php/v2/home" target="_blank" rel="noreferrer">http://www.postgres.cn/index.php/v2/home</a></p><p><a href="https://momjian.us/main/blogs/pgblog/2021.html" target="_blank" rel="noreferrer">https://momjian.us/main/blogs/pgblog/2021.html</a></p><p><a href="https://www.depesz.com/" target="_blank" rel="noreferrer">https://www.depesz.com/</a></p><p><a href="https://paquier.xyz/" target="_blank" rel="noreferrer">https://paquier.xyz/</a></p><p>blog</p><p><a href="https://github.com/digoal/blog/tree/master/201911" target="_blank" rel="noreferrer">https://github.com/digoal/blog/tree/master/201911</a></p><p><a href="http://www.doc88.com/p-6951964523866.html" target="_blank" rel="noreferrer">http://www.doc88.com/p-6951964523866.html</a></p><p><a href="https://github.com/digoal/blog/blob/master/README.md" target="_blank" rel="noreferrer">https://github.com/digoal/blog/blob/master/README.md</a></p><p>slave</p><p><a href="https://github.com/digoal/blog/blob/master/201012/20101230_01.md" target="_blank" rel="noreferrer">https://github.com/digoal/blog/blob/master/201012/20101230_01.md</a></p><p>主从延迟</p><p><a href="https://github.com/digoal/blog/blob/master/201105/20110511_01.md" target="_blank" rel="noreferrer">https://github.com/digoal/blog/blob/master/201105/20110511_01.md</a></p><p>归档</p><p><a href="https://github.com/digoal/blog/blob/master/201106/20110623_01.md" target="_blank" rel="noreferrer">https://github.com/digoal/blog/blob/master/201106/20110623_01.md</a></p><p><a href="https://github.com/digoal/blog/blob/master/201107/20110701_01.md" target="_blank" rel="noreferrer">https://github.com/digoal/blog/blob/master/201107/20110701_01.md</a></p><p>ssh压缩</p><p><a href="https://github.com/digoal/blog/blob/master/201106/20110629_01.md" target="_blank" rel="noreferrer">https://github.com/digoal/blog/blob/master/201106/20110629_01.md</a></p><p>分布式</p><p><a href="https://github.com/digoal/blog/blob/master/201110/20111025_01.md" target="_blank" rel="noreferrer">https://github.com/digoal/blog/blob/master/201110/20111025_01.md</a></p><p>监控</p><p><a href="https://github.com/digoal/blog/blob/master/201202/20120214_01.md" target="_blank" rel="noreferrer">https://github.com/digoal/blog/blob/master/201202/20120214_01.md</a></p><p>安装优化</p><p><a href="https://github.com/digoal/blog/blob/master/201611/20161121_01.md" target="_blank" rel="noreferrer">https://github.com/digoal/blog/blob/master/201611/20161121_01.md</a></p><p>调优</p><p><a href="https://github.com/digoal/blog/blob/master/201203/20120313_01.md" target="_blank" rel="noreferrer">https://github.com/digoal/blog/blob/master/201203/20120313_01.md</a></p><p>9.5</p><p><a href="http://blog.itpub.net/column/95" target="_blank" rel="noreferrer">http://blog.itpub.net/column/95</a></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">--with-blocksize=BLOCKSIZE</span></span>
<span class="line"><span style="color:#e1e4e8;">                          set table block size in kB [8]</span></span>
<span class="line"><span style="color:#e1e4e8;">  --with-segsize=SEGSIZE  set table segment size in GB [1]</span></span>
<span class="line"><span style="color:#e1e4e8;">  --with-wal-blocksize=BLOCKSIZE</span></span>
<span class="line"><span style="color:#e1e4e8;">                          set WAL block size in kB [8]</span></span>
<span class="line"><span style="color:#e1e4e8;">  --with-wal-segsize=SEGSIZE</span></span>
<span class="line"><span style="color:#e1e4e8;">                          set WAL segment size in MB [16]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">--with-blocksize=BLOCKSIZE</span></span>
<span class="line"><span style="color:#24292e;">                          set table block size in kB [8]</span></span>
<span class="line"><span style="color:#24292e;">  --with-segsize=SEGSIZE  set table segment size in GB [1]</span></span>
<span class="line"><span style="color:#24292e;">  --with-wal-blocksize=BLOCKSIZE</span></span>
<span class="line"><span style="color:#24292e;">                          set WAL block size in kB [8]</span></span>
<span class="line"><span style="color:#24292e;">  --with-wal-segsize=SEGSIZE</span></span>
<span class="line"><span style="color:#24292e;">                          set WAL segment size in MB [16]</span></span></code></pre></div><p>发现下面几个对应关系：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">XLOG_SEG_SIZE  ----  --with-wal-segsize</span></span>
<span class="line"><span style="color:#e1e4e8;">RELSEG_SIZE    ----  --with-segsize</span></span>
<span class="line"><span style="color:#e1e4e8;">XLOG_BLCKSZ    ----  --with-wal-blocksize</span></span>
<span class="line"><span style="color:#e1e4e8;">BLCKSZ         ----  --with-blocksize</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">XLOG_SEG_SIZE  ----  --with-wal-segsize</span></span>
<span class="line"><span style="color:#24292e;">RELSEG_SIZE    ----  --with-segsize</span></span>
<span class="line"><span style="color:#24292e;">XLOG_BLCKSZ    ----  --with-wal-blocksize</span></span>
<span class="line"><span style="color:#24292e;">BLCKSZ         ----  --with-blocksize</span></span></code></pre></div><p>select name,setting from pg_settings where category = &#39;Preset Options&#39; order by name;</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">#由select (131072 * 8192)/1024/1024/1024;计算得到RELSEG_SIZE为1，单位GB</span></span>
<span class="line"><span style="color:#e1e4e8;">#可以看到wal_block_size对应--with-wal-blocksize应该是16，segment_size对应----RELSEG_SIZE应该为1</span></span>
<span class="line"><span style="color:#e1e4e8;">#需要删除重新编译，报错消失</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">#由select (131072 * 8192)/1024/1024/1024;计算得到RELSEG_SIZE为1，单位GB</span></span>
<span class="line"><span style="color:#24292e;">#可以看到wal_block_size对应--with-wal-blocksize应该是16，segment_size对应----RELSEG_SIZE应该为1</span></span>
<span class="line"><span style="color:#24292e;">#需要删除重新编译，报错消失</span></span></code></pre></div><p>utf8</p><p><a href="https://www.modb.pro/db/70780" target="_blank" rel="noreferrer">https://www.modb.pro/db/70780</a></p><h1 id="如何控制客户端连接超时" tabindex="-1">如何控制客户端连接超时 <a class="header-anchor" href="#如何控制客户端连接超时" aria-label="Permalink to &quot;如何控制客户端连接超时&quot;">​</a></h1><h2 id="_1-空闲长事务连接" tabindex="-1">1.空闲长事务连接 <a class="header-anchor" href="#_1-空闲长事务连接" aria-label="Permalink to &quot;1.空闲长事务连接&quot;">​</a></h2><p>使用idle_in_transaction_session_timeout参数，默认值是0，不开启，例如配置为5分钟。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">idle_in_transaction_session_timeout = 5min</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#查看</span></span>
<span class="line"><span style="color:#e1e4e8;">select * from pg_settings ps where 1=1 and ps.name like &#39;%timeout%&#39; ;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">idle_in_transaction_session_timeout = 5min</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#查看</span></span>
<span class="line"><span style="color:#24292e;">select * from pg_settings ps where 1=1 and ps.name like &#39;%timeout%&#39; ;</span></span></code></pre></div><p>注意：该参数对idle正常连接无影响。</p><h2 id="_2-空闲连接" tabindex="-1">2.空闲连接 <a class="header-anchor" href="#_2-空闲连接" aria-label="Permalink to &quot;2.空闲连接&quot;">​</a></h2><p>可使用扩展插件pg_timeout插件，配置postgresql.conf</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">shared_preload_libraries = &#39;pg_timeout&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">pg_timeout.naptime=60 #单位为秒</span></span>
<span class="line"><span style="color:#e1e4e8;">pg_timeout.idle_session_timeout=60 #单位为秒</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">shared_preload_libraries = &#39;pg_timeout&#39;</span></span>
<span class="line"><span style="color:#24292e;">pg_timeout.naptime=60 #单位为秒</span></span>
<span class="line"><span style="color:#24292e;">pg_timeout.idle_session_timeout=60 #单位为秒</span></span></code></pre></div><h2 id="_3-异常连接" tabindex="-1">3.异常连接 <a class="header-anchor" href="#_3-异常连接" aria-label="Permalink to &quot;3.异常连接&quot;">​</a></h2><p>客户端异常断开的连接，可配置postgresql.conf</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">tcp_keepalives_idle = 60</span></span>
<span class="line"><span style="color:#e1e4e8;">tcp_keepalives_interval = 20 </span></span>
<span class="line"><span style="color:#e1e4e8;">tcp_keepalives_count = 3</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">tcp_keepalives_idle = 60</span></span>
<span class="line"><span style="color:#24292e;">tcp_keepalives_interval = 20 </span></span>
<span class="line"><span style="color:#24292e;">tcp_keepalives_count = 3</span></span></code></pre></div><p>注意：不配置会使用操作系统默认值</p><p>vamlue</p><p><a href="https://www.modb.pro/db/29547" target="_blank" rel="noreferrer">https://www.modb.pro/db/29547</a></p>`,115),t=[l];function o(r,i,c,h,b,g){return s(),a("div",null,t)}const _=e(p,[["render",o]]);export{m as __pageData,_ as default};
