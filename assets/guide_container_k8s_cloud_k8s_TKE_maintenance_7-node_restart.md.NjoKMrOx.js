import{_ as s,o as n,c as a,R as o}from"./chunks/framework.zUbWieqp.js";const u=JSON.parse('{"title":"1.èŠ‚ç‚¹é©±é€pod","description":"","frontmatter":{},"headers":[],"relativePath":"guide/container/k8s/cloud_k8s/TKE/maintenance/7-node_restart.md","filePath":"guide/container/k8s/cloud_k8s/TKE/maintenance/7-node_restart.md","lastUpdated":1745762072000}'),l={name:"guide/container/k8s/cloud_k8s/TKE/maintenance/7-node_restart.md"},p=o(`<p><strong>ä¸€ä¸ªé¡¹ç›®ç”¨çš„ k8s é›†ç¾¤å‘ç°äº†ä¸ª bug ï¼Œå¤„ç†å®Œæˆåéœ€è¦é‡å¯èŠ‚ç‚¹æ‰èƒ½å½»åº•ä¿®å¤ã€‚ä¸ºäº†é¿å…ä¸šåŠ¡å—åˆ°å½±å“ï¼Œåœ¨æ“ä½œèŠ‚ç‚¹é‡å¯å‰æˆ‘ä»¬éœ€è¦å°†å½“å‰èŠ‚ç‚¹ä¸Šè¿è¡Œçš„æ‰€æœ‰ä¸šåŠ¡ pod éƒ½é©±é€åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šä»¥ç»§ç»­æä¾›æœåŠ¡</strong></p><h1 id="_1-èŠ‚ç‚¹é©±é€pod" tabindex="-1">1.èŠ‚ç‚¹é©±é€pod <a class="header-anchor" href="#_1-èŠ‚ç‚¹é©±é€pod" aria-label="Permalink to &quot;1.èŠ‚ç‚¹é©±é€pod&quot;">â€‹</a></h1><p>å°† pod é©±é€åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚ä¸€èˆ¬æƒ…å†µä¸‹è¦å°†æŸèŠ‚ç‚¹ä¸Š pod éƒ½é©±é€å‡ºå»æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ kubectl drain å‘½ä»¤æ¥å®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># è·å–é›†ç¾¤ä¸­èŠ‚ç‚¹åˆ—è¡¨</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@im </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl get nodes</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">           </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">ROLES</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">VERSION</span></span>
<span class="line"><span style="color:#B392F0;">192.168.2.41</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">543</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.5-tke.6</span></span>
<span class="line"><span style="color:#B392F0;">192.168.2.15</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">436</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.5-tke.12</span></span>
<span class="line"><span style="color:#B392F0;">192.168.2.8</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">Ready</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">540</span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">v1.22.5-tke.6</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;">#ä½¿ç”¨ kubectl drain å‘½ä»¤æ¥é©±é€æŒ‡å®šèŠ‚ç‚¹ä¸Š pod</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@im </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl drain --ignore-daemonsets 192.168.2.41</span></span>
<span class="line"><span style="color:#B392F0;">node/192.168.2.41</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cordoned</span></span>
<span class="line"><span style="color:#B392F0;">WARNING:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ignoring</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">DaemonSet-managed</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Pods:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-monitor/node-exporter-knxrq,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-system/csi-nodeplugin-cfsplugin-xz66b</span></span>
<span class="line"><span style="color:#B392F0;">evicting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">uat/zcy-test-0418-6688fbff7b-kmrj4</span></span>
<span class="line"><span style="color:#B392F0;">pod/zcy-test-0418-6688fbff7b-kmrj4</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">evicted</span></span>
<span class="line"><span style="color:#B392F0;">node/192.168.2.41</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">evicted</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># è·å–é›†ç¾¤ä¸­èŠ‚ç‚¹åˆ—è¡¨</span></span>
<span class="line"><span style="color:#24292E;">[root@im </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl get nodes</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">           </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ROLES</span><span style="color:#24292E;">    </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">    </span><span style="color:#032F62;">VERSION</span></span>
<span class="line"><span style="color:#6F42C1;">192.168.2.41</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">543</span><span style="color:#032F62;">d</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.5-tke.6</span></span>
<span class="line"><span style="color:#6F42C1;">192.168.2.15</span><span style="color:#24292E;">   </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">436</span><span style="color:#032F62;">d</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.5-tke.12</span></span>
<span class="line"><span style="color:#6F42C1;">192.168.2.8</span><span style="color:#24292E;">    </span><span style="color:#032F62;">Ready</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">540</span><span style="color:#032F62;">d</span><span style="color:#24292E;">   </span><span style="color:#032F62;">v1.22.5-tke.6</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;">#ä½¿ç”¨ kubectl drain å‘½ä»¤æ¥é©±é€æŒ‡å®šèŠ‚ç‚¹ä¸Š pod</span></span>
<span class="line"><span style="color:#24292E;">[root@im </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl drain --ignore-daemonsets 192.168.2.41</span></span>
<span class="line"><span style="color:#6F42C1;">node/192.168.2.41</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cordoned</span></span>
<span class="line"><span style="color:#6F42C1;">WARNING:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ignoring</span><span style="color:#24292E;"> </span><span style="color:#032F62;">DaemonSet-managed</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Pods:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-monitor/node-exporter-knxrq,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-system/csi-nodeplugin-cfsplugin-xz66b</span></span>
<span class="line"><span style="color:#6F42C1;">evicting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">uat/zcy-test-0418-6688fbff7b-kmrj4</span></span>
<span class="line"><span style="color:#6F42C1;">pod/zcy-test-0418-6688fbff7b-kmrj4</span><span style="color:#24292E;"> </span><span style="color:#032F62;">evicted</span></span>
<span class="line"><span style="color:#6F42C1;">node/192.168.2.41</span><span style="color:#24292E;"> </span><span style="color:#032F62;">evicted</span></span></code></pre></div><blockquote><p>drain å­å‘½ä»¤çš„æ•ˆæœç›¸å½“äºï¼š</p><ol><li><p>ç»™æŒ‡å®šèŠ‚ç‚¹æ·»åŠ  node.kubernetes.io/unschedulable:NoSchedule æ±¡ç‚¹ã€‚</p></li><li><p>å°†èŠ‚ç‚¹çŠ¶æ€æ ‡è®°ä¸ºä¸å¯è°ƒåº¦ã€‚</p></li><li><p>ç»™æŒ‡å®šèŠ‚ç‚¹ä¸Šæ‰€æœ‰è¿è¡Œä¸­çš„ Pod å‘é€ SIGTERM ä¿¡å·ä»¥ä¼˜é›…ç»ˆæ­¢ podã€‚</p></li></ol></blockquote><h1 id="_2-èŠ‚ç‚¹é‡æ–°è°ƒåº¦" tabindex="-1">2.èŠ‚ç‚¹é‡æ–°è°ƒåº¦ <a class="header-anchor" href="#_2-èŠ‚ç‚¹é‡æ–°è°ƒåº¦" aria-label="Permalink to &quot;2.èŠ‚ç‚¹é‡æ–°è°ƒåº¦&quot;">â€‹</a></h1><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># é‡æ–°ç»´æŠ¤å¥½èŠ‚ç‚¹åï¼Œéœ€è¦ä½¿ç”¨ kubectl uncordonï¼Œè¿™å°†ä½¿èŠ‚ç‚¹é‡æ–°å˜ä¸ºå¯è°ƒåº¦ã€‚</span></span>
<span class="line"><span style="color:#E1E4E8;">[root@im </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">]# kubectl uncordon 192.168.2.41</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># é‡æ–°ç»´æŠ¤å¥½èŠ‚ç‚¹åï¼Œéœ€è¦ä½¿ç”¨ kubectl uncordonï¼Œè¿™å°†ä½¿èŠ‚ç‚¹é‡æ–°å˜ä¸ºå¯è°ƒåº¦ã€‚</span></span>
<span class="line"><span style="color:#24292E;">[root@im </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">]# kubectl uncordon 192.168.2.41</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">ğŸ’¡ è¯´æ˜</p><p><strong>1 ç»™èŠ‚ç‚¹æ–°å¢ä¸€ä¸ªä¸èƒ½è¢«ç°æœ‰ pod å®¹å¿çš„æ±¡ç‚¹ï¼Œå¹¶å°† effect å­—æ®µå€¼è®¾ç½®ä¸º NoScheduleï¼ˆæ–°çš„ Pod ä¸ä¼šè¢«è°ƒåº¦åˆ°æ­¤èŠ‚ç‚¹ä¸Šï¼Œå½“å‰æ­£åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Pod ä¸ä¼šè¢«é©±é€ï¼‰ã€‚</strong></p><p><strong>2 æ‰‹åŠ¨å°†å½“å‰èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ pod delete æ‰ï¼Œç”±äºè®¾ç½®äº†æ±¡ç‚¹æ‰€ä»¥ delete æ‰çš„ pod ä¸ä¼šè¢«é‡æ–°è°ƒåº¦åˆ°å½“å‰èŠ‚ç‚¹ã€‚</strong></p><p><strong>3 æŒ‡å®š pod è¢« delete æ‰åï¼Œå¯ä»¥è§‚å¯Ÿä¸‹æ˜¯å¦åœ¨å…¶ä»–èŠ‚ç‚¹é‡æ–°è°ƒåº¦å¹¶æ­£å¸¸è¿è¡Œï¼Œæ–° pod è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹åèµ„æºè´Ÿè½½æƒ…å†µæ˜¯å¦åœ¨æ­£å¸¸ä½¿ç”¨é˜ˆå€¼å†…ï¼Œ å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œå†ç»§ç»­ delete ä¸‹ä¸€ä¸ª pod ä¸€ç›´åˆ°å…¨éƒ¨å®Œæˆã€‚</strong></p><p><strong>4 ç¡®è®¤æ²¡æœ‰ä¸šåŠ¡ pod åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œäº†ï¼Œå†é‡å¯èŠ‚ç‚¹è¿›è¡Œç»´æŠ¤ã€‚</strong></p><p><strong>5 é‡å¯å®Œæˆç¡®è®¤é—®é¢˜ä¿®å¤åï¼Œåˆ é™¤èŠ‚ç‚¹ä¸Šä¹‹å‰å®šä¹‰å¥½çš„æ±¡ç‚¹ã€‚</strong></p></div><p>ä½¿ç”¨ drain å‘½ä»¤ç­‰æ¸…ç©ºèŠ‚ç‚¹æ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„</p><div class="danger custom-block"><p class="custom-block-title">âŒ æ³¨æ„</p><ol><li><p>å¦‚æœå­˜åœ¨æ–°çš„ã€èƒ½å¤Ÿå®¹å¿ node.kubernetes.io/unschedulable ç­‰æ±¡ç‚¹çš„ Podï¼Œ é‚£ä¹ˆè¿™äº› Pod å¯èƒ½ä¼šè¢«è°ƒåº¦åˆ°ä½ å·²ç»æ¸…ç©ºçš„èŠ‚ç‚¹ä¸Šã€‚æ‰€ä»¥é™¤äº† DaemonSet ä¹‹å¤–ï¼Œè¯·é¿å…å®¹å¿æ­¤æ±¡ç‚¹ï¼ˆé¿å…å®¹å¿æ‰€æœ‰æ±¡ç‚¹ï¼‰ã€‚ å¦‚æœä½ æˆ–å¦ä¸€ä¸ª API ç”¨æˆ·ï¼ˆç»•è¿‡è°ƒåº¦å™¨ï¼‰ç›´æ¥ä¸º Pod è®¾ç½®äº† nodeName å­—æ®µï¼Œ åˆ™å³ä½¿ä½ å·²å°†è¯¥èŠ‚ç‚¹æ¸…ç©ºå¹¶æ ‡è®°ä¸ºä¸å¯è°ƒåº¦ï¼ŒPod ä»å°†è¢«ç»‘å®šåˆ°è¿™ä¸ªæŒ‡å®šçš„èŠ‚ç‚¹å¹¶åœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚</p></li><li><p>å¦‚æœèŠ‚ç‚¹ä¸Šå­˜åœ¨ä¸å—æ§åˆ¶å™¨ç®¡ç†çš„ podï¼ˆreplication controller, replica set, daemon set, stateful set, æˆ– jobï¼‰ï¼Œåˆ™å¿…é¡»æ·»åŠ ä½¿ç”¨ --force é€‰é¡¹ï¼Œå¦åˆ™ drain ä¸ä¼šåˆ é™¤ä»»ä½•Podã€‚</p></li><li><p>ç”±äºæ‰§è¡Œ drain å‘½ä»¤ä¼šå°†èŠ‚ç‚¹æ‰€æœ‰ pod é©±é€åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œæ‰€ä»¥å¦‚æœèŠ‚ç‚¹æœ¬èº«æ‰¿è½½å¤§é‡çš„ pod ï¼Œéœ€è¦æ³¨æ„è¯„ä¼°è¯¥èŠ‚ç‚¹ä¸Šæ‰€æœ‰ pod è¢«é‡æ–°è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šè¿è¡Œæ—¶æ˜¯å¦ä¼šå¯¹é›†ç¾¤èµ„æºé€ æˆå‹åŠ›ã€‚</p></li><li><p>ç¡®ä¿æ²¡æœ‰å¤–éƒ¨æ²¡æœ‰ç›´æ¥è°ƒç”¨æ­¤èŠ‚ç‚¹çš„ IP è¿›è¡Œä¸šåŠ¡è¯·æ±‚çš„ï¼ˆNodePortï¼‰ï¼Œå¦åˆ™ä¼šå¯¼è‡´é‡å¯æœŸé—´æ— æ³•æ­£å¸¸è®¿é—®ã€‚</p></li></ol></div>`,10),e=[p];function t(c,r,y,E,d,i){return n(),a("div",null,e)}const g=s(l,[["render",t]]);export{u as __pageData,g as default};
